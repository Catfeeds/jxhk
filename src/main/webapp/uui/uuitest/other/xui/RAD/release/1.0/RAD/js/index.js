Class("xui.UIProfile", "xui.Profile", {
    Instance: {
        renderId: null,
        _render: function () {
            var ns = this,
                ins = ns.boxing(),
                t, map = xui.$cache.profileMap;
            if (!ns.renderId) {
                var ele = xui.Dom.byId(ns.$domId);
                if (!ele) {
                    return
                }
                if (ns.domId != ns.$domId) {
                    ele.id = ns.domId
                }
                map[ns.domId] = map[ns.$domId] = ns;
                if (!ele.$xid) {
                    xui.UI.$addEventsHanlder(ele, true)
                }
                ns.rendered = ns.renderId = ele.$xid;
                ele = null
            }
            if (ns.CS) {
                ins.setCustomStyle(ns.CS)
            }
            if (xui.browser.isTouch) {
                if ((t = ns.box.$Behaviors.DroppableKeys) && t.length) {
                    _.arr.each(t, function (o) {
                        ins.getSubNode(o, true).each(function (node) {
                            var key = ns.box.getDropKeys(ns, node.$xid);
                            if (key) {
                                var c = xui.$cache.droppable,
                                    a = key.split(/[^\w-]+/);
                                for (var i = 0, l = a.length; i < l; i++) {
                                    c[a[i]] = c[a[i]] || [];
                                    c[a[i]].push(node.$xid)
                                }
                            }
                        })
                    })
                }
            }
            if (xui.browser.isTouch && (xui.browser.isAndroid || xui.browser.isBB)) {
                var check = {
                    auto: 1,
                    scroll: 1
                };
                _.each(ns.box.$Appearances, function (o, i) {
                    if (check[o.overflow]) {
                        ns.getSubNode(i, true).$touchscroll("xy")
                    } else {
                        if (check[o["overflow-x"]]) {
                            ns.getSubNode(i, true).$touchscroll("x")
                        } else {
                            if (check[o["overflow-y"]]) {
                                ns.getSubNode(i, true).$touchscroll("y")
                            }
                        }
                    }
                });
                if (check[ns.properties.overflow]) {
                    ins.setOverflow(ns.properties.overflow, true)
                }
            }
            if (t = ns.RenderTrigger) {
                for (var i = 0, l = t.length; i < l; i++) {
                    t[i].call(ns)
                }
                delete ns.RenderTrigger;
                if (ns.onRender) {
                    ns.boxing().onRender(ns)
                }
                _.tryF(ns.$onrender, [], ns)
            }
            if (arguments[0] === true && (t = ns.LayoutTrigger)) {
                for (var i = 0, l = t.length; i < l; i++) {
                    t[i].call(ns)
                }
                if (ns.onLayout) {
                    ns.boxing().onLayout(ns)
                }
            }
            if (!ns.properties.lazyAppend) {
                if (ns.children) {
                    for (var i = 0, v; v = ns.children[i++];) {
                        if (v[0]._render) {
                            v[0]._render(true)
                        }
                    }
                }
                if (ns.$attached) {
                    for (var i = 0, v; v = ns.$attached[i++];) {
                        if (v._render) {
                            v._render(true)
                        }
                    }
                    delete ns.$attached
                }
                if (ns.exchildren) {
                    var arr = [];
                    for (var i = 0, v; v = ns.exchildren[i++];) {
                        ns.boxing().append(v[0], v[1])
                    }
                    delete ns.exchildren
                }
                if (ns.excoms) {
                    var arr = [];
                    for (var i = 0, v; v = ns.excoms[i++];) {
                        v[0].show(null, ns.boxing(), v[1], false)
                    }
                    delete ns.excoms
                }
            }
        },
        __gc: function () {
            var ns = this,
                t;
            if (ns.destroyed) {
                return
            }
            if (ns.$beforeDestroy) {
                _.each(ns.$beforeDestroy, function (f) {
                    _.tryF(f, [], ns)
                });
                delete ns.$beforeDestroy
            }
            _.tryF(ns.$ondestory, [], ns);
            if (ns.onDestroy) {
                ns.boxing().onDestroy()
            }
            if (ns.destroyTrigger) {
                ns.destroyTrigger()
            }
            if (!ns.serialId) {
                return
            }
            if (t = ns._$composed) {
                _.each(t, function (v) {
                    v.__gc()
                })
            }
            ns.clearCache();
            if (!ns.$noReclaim) {
                t = xui.$cache.reclaimId;
                (t[ns.key] || (t[ns.key] = [])).push(ns.serialId)
            } else {
                delete ns.$noReclaim
            }
            delete xui.$cache.profileMap[ns.domId];
            delete xui.$cache.profileMap[ns.$domId];
            if (ns.box) {
                delete ns.box._namePool[ns.alias]
            }
            ns.unLinkAll();
            if (ns.LayoutTrigger) {
                ns.LayoutTrigger.length = 0
            }
            if (ns.RenderTrigger) {
                ns.RenderTrigger.length = 0
            }
            if ((t = ns.children).length) {
                t = _.copy(t);
                for (var i = 0; i < t.length; i++) {
                    t[i][0].__gc();
                    t[i].length = 0
                }
                t.length = 0
            }
            ns.destroyed = true;
            if (ns.$afterDestroy) {
                _.each(ns.$afterDestroy, function (f) {
                    _.tryF(f, [], ns)
                });
                delete ns.$afterDestroy
            }
            if (ns.afterDestroy) {
                ns.boxing().afterDestroy(ns)
            }
            _.breakO([ns.properties, ns.events, ns.CF, ns.CB, ns.CC, ns.CS, ns], 2);
            ns.destroyed = true
        },
        unlinkParent: function () {
            var profile = this;
            delete profile.parent;
            delete profile.childrenId;
            profile.unLink("$parent");
            return profile
        },
        getRootNode: function () {
            return xui.getNodeData(this.renderId, "element")
        },
        getRoot: function () {
            return xui(this.renderId ? [this.renderId] : [], false)
        },
        getContainer: function (subId) {
            if (subId = typeof subId == "string" ? subId : null) {
                subId = this.getSubIdByItemId(subId)
            }
            return this.box._CONTAINERKEY ? this.getSubNode(this.box._CONTAINERKEY, subId) : this.keys.PANEL ? this.getSubNode(this.keys.PANEL, subId) : this.getRoot()
        },
        linkParent: function (parentProfile, linkId) {
            var profile = this;
            profile.unlinkParent();
            profile.parent = parentProfile;
            profile.childrenId = linkId;
            profile.link(parentProfile.children, "$parent", [profile, linkId]);
            return profile
        },
        _cacheR1: /^\w[\w_-]*$/,
        setDomId: function (id) {
            var t = this,
                c = xui.$cache.profileMap;
            if (typeof id == "string" && (t._cacheR1.test(id) || id == t.$domId) && !xui.Dom.byId(id)) {
                if (t.domId != t.$domId) {
                    delete c[t.domId]
                }
                t.domId = id;
                if (t.renderId) {
                    t.getRootNode().id = id
                }
                if (c[t.$domId]) {
                    c[id] = t
                }
            }
            return t
        },
        getDomId: function () {
            return this.domId
        },
        clearCache: function () {
            var ns = this,
                t = ns.$_egetter;
            for (var i in t) {
                t[i].length = 0;
                delete t[i]
            }
            t = ns.$_domid;
            for (var i in t) {
                t[i].__gc();
                delete t[i]
            }
            return ns
        },
        _getEV: function (funs, id, name) {
            var self = this,
                $k = id + "+" + name,
                g = self.$_egetter || (self.$_egetter = {}),
                cache;
            if (g[$k]) {
                Array.prototype.push.apply(funs, g[$k]);
                return
            } else {
                cache = g[$k] = []
            }
            var dom = xui.$cache.profileMap,
                t, key;
            if ((t = dom[id]) && (t = t.events) && (t = t[name])) {
                for (var i = 0, l = t.length; i < l; i++) {
                    if (typeof t[t[i]] == "function") {
                        cache.push(funs[funs.length] = t[t[i]])
                    }
                }
            }
            key = id.split(":")[0].split("-")[1];
            if (typeof (((t = self._CB) && (key ? (t = t[key]) : 1)) && (t = t[name])) == "function") {
                cache.push(funs[funs.length] = t)
            } else {
                if (typeof (((t = self.CB) && (key ? (t = t[key]) : 1)) && (t = t[name])) == "function") {
                    cache.push(funs[funs.length] = t)
                } else {
                    if (typeof (((t = self.behavior) && (key ? (t = t[key]) : 1)) && (t = t[name])) == "function") {
                        cache.push(funs[funs.length] = t)
                    }
                }
            }
        },
        _cacheR2: /<!--\x03([^>^\s]*)\x04-->/g,
        toHtml: function (force) {
            var self = this,
                c = self.box,
                h = {},
                str, k1 = "xui.UIProfile",
                k2 = "xui.Profile",
                id, i, o, m, a, b, data;
            data = c._prepareData(self);
            if (c._dynamicTemplate) {
                c._dynamicTemplate(self)
            }
            str = c._build(self, data);
            if ((!self.properties.lazyAppend || force) && (m = self.children)) {
                for (i = 0; o = m[i++];) {
                    if (o[0][k1]) {
                        id = o[1] || "";
                        a = h[id] || (h[id] = []);
                        a[a.length] = o[0].toHtml(force)
                    } else {
                        if (!o[0][k2]) {
                            b.ini.call(b, o[0]);
                            o[0] = b.get(0)
                        }
                    }
                }
            }
            return str.replace(self._cacheR2, function (a, b) {
                return h[b] ? h[b].join("") : ""
            })
        },
        _buildItems: function (key, items, addEventHandler) {
            var ns = this,
                box = ns.box,
                str = box._rpt(ns, xui.UI.$doTemplate(ns, _.get(xui.$cache.template, [box.KEY, ns._hash]), items, key)),
                nodes = xui.UI.$toDom(str.replace(ns._cacheR2, ""), addEventHandler);
            if (ns.CS) {
                ns.boxing().setCustomStyle(ns.CS, undefined, nodes)
            }
            return nodes
        },
        serialize: function (rtnString, keepHost) {
            var t, m, self = this,
                o = (t = self.box._beforeSerialized) ? t(self) : self,
                r = {
                    alias: o.alias,
                    key: o.key,
                    host: o.host
                };
            if (r.host === self) {
                delete r.host
            } else {
                if (o.host && !keepHost) {
                    if (rtnString !== false) {
                        r.host = "@this"
                    } else {
                        delete r.host
                    }
                }
            }
            if (typeof o.theme == "string") {
                r.theme = o.theme
            }
            if (o.$domId != o.domId) {
                r.domId = o.domId
            }
            var c = {},
                p = o.box.$DataStruct,
                map = xui.absObj.$specialChars;
            _.merge(c, o.properties, function (o, i) {
                return (i in p) && p[i] !== o && !map[i.charAt(0)]
            });
            if (!_.isEmpty(c)) {
                r.properties = c
            }
            if (!_.isEmpty(t = this.getEvents())) {
                r.events = t
            }
            var eh = o.box.$EventHandlers;
            _.filter(r.events, function (o, i) {
                return o != eh[i]
            });
            if (_.isEmpty(r.events)) {
                delete r.events
            }
            if (!_.isEmpty(o.CB)) {
                r.CB = _.copy(o.CB)
            }
            if (!_.isEmpty(o.CC)) {
                r.CC = _.copy(o.CC)
            }
            if (!_.isEmpty(o.CF)) {
                r.CF = _.copy(o.CF)
            }
            if (!_.isEmpty(o.CS)) {
                r.CS = _.copy(o.CS)
            }
            if (typeof o.theme == "string") {
                r.theme = o.theme
            }
            if (o.children && o.children.length) {
                o.children.sort(function (x, y) {
                    x = parseInt(x[0].properties.tabindex, 10);
                    y = parseInt(y[0].properties.tabindex, 10);
                    return x > y ? 1 : x == y ? 0 : -1
                });
                t = r.children = [];
                _.arr.each(o.children, function (v) {
                    m = [v[0].serialize(false, keepHost)];
                    if (v[1]) {
                        m[1] = v[1]
                    }
                    t[t.length] = m
                })
            }
            if (o.exchildren && o.exchildren.length) {
                r.exchildren = o.exchildren
            }
            return rtnString === false ? r : _.serialize(r)
        },
        _applySetAction: function (fun, value, ovalue) {
            if (this.renderId) {
                return fun.call(this, value, ovalue)
            }
        },
        getKey: function (id) {
            var t;
            if (id.charAt(0) == "!") {
                id = xui.use(id).id()
            }
            if (id.indexOf(":") == -1) {
                id = (t = xui.$cache.profileMap[id]) && (t.$domId)
            }
            return id ? id.split(":")[0] : ""
        },
        getSubId: function (id) {
            var t;
            if (id.charAt(0) == "!") {
                id = xui.use(id).id()
            }
            if (id.indexOf(":") == -1) {
                id = (t = xui.$cache.profileMap[id]) && (t.$domId)
            }
            return id ? id.split(":")[2] : ""
        },
        pickSubId: function (key) {
            var self = this,
                r, o = self.cache_subid || (self.cache_subid = {});
            if ((o[key] || (o[key] = []))[0]) {
                return o[key].shift()
            }
            o = self.subId || (self.subId = {});
            r = (o[key] || (o[key] = new _.id)).next();
            return r
        },
        reclaimSubId: function (id, key) {
            var o = this.cache_subid || (this.cache_subid = {});
            (o[key] || (o[key] = [])).push(id)
        },
        _cacheR3: /\./g,
        _cacheH1: {},
        getClass: function (key, tag) {
            key = this.keys[key] || key;
            var self = this,
                hash = key + ":" + (tag || "");
            return self._cacheH1[hash] || (self._cacheH1[hash] = key.replace(self._cacheR3, "-").toLowerCase().replace("xui-ui", "xui") + (tag || ""))
        },
        _getSubNodeId: function (key, subId) {
            var arr = this.$domId.split(":");
            arr[0] = key;
            arr[2] = _.isSet(subId) ? (subId + "") : "";
            key = arr.join(":");
            return key == this.$domId ? xui.$cache.profileMap[key].domId : key
        },
        getSubNode: function (key, subId) {
            var self = this;
            if (!self.renderId) {
                return xui()
            }
            var key = self.keys[key] || key,
                r, t, s, h = self.$_domid || (self.$_domid = {});
            if (subId === true) {
                r = xui([self.renderId]).query("*", "id", key == self.keys.KEY ? self.domId : new RegExp("^" + key + ":" + self.serialId))
            } else {
                if (!_.isSet(subId) && h[key] && h[key]._nodes.length == 1) {
                    return h[key]
                }
                r = (t = xui.Dom.byId(s = self._getSubNodeId(key, subId))) ? xui([t]) : ((t = self.renderId) && xui.use(t).query("*", "id", s));
                if (!_.isSet(subId)) {
                    h[key] = r
                }
            }
            return r
        },
        getSubNodes: function (arr, subId) {
            if (!subId) {
                subId = true
            }
            var a = [],
                s1 = typeof arr == "string",
                s2 = typeof subId == "string" || subId === true,
                o, v;
            if (s1) {
                if (s2) {
                    Array.prototype.push.apply(a, this.getSubNode(arr, subId).get())
                } else {
                    for (var j = 0; v = subId[j++];) {
                        Array.prototype.push.apply(a, this.getSubNode(arr, v).get())
                    }
                }
            } else {
                for (var i = 0; o = arr[i++];) {
                    if (s2) {
                        Array.prototype.push.apply(a, this.getSubNode(o, subId).get())
                    } else {
                        for (var j = 0; v = subId[j++];) {
                            Array.prototype.push.apply(a, this.getSubNode(o, v).get())
                        }
                    }
                }
            }
            return xui(a)
        },
        getSubNodeByItemId: function (key, itemId) {
            return (itemId = this.getSubIdByItemId(itemId)) ? this.getSubNode(key, itemId) : xui()
        },
        getItemByItemId: function (itemId) {
            var t;
            if ((t = this.ItemIdMapSubSerialId) && (t = t[itemId])) {
                return this.SubSerialIdMapItem[t]
            }
        },
        getItemByDom: function (src) {
            return this.SubSerialIdMapItem && this.SubSerialIdMapItem[this.getSubId(typeof src == "string" ? src.charAt(0) == "!" ? ((src = xui.use(src).get(0)) && src.id) : src : src.id)]
        },
        getItemIdByDom: function (src) {
            var t;
            return (t = this.getItemByDom(src)) && t.id
        },
        getSubIdByItemId: function (itemId) {
            var t;
            return (t = this.ItemIdMapSubSerialId) && t[itemId]
        },
        queryItems: function (items, fun, deep, single, flag) {
            var r = [],
                me = arguments.callee,
                f = me.f || (me.f = function (items, fun, deep, single, flag, r) {
                    _.arr.each(items, function (o, i) {
                        if (fun === true || fun.call(null, o, i, items)) {
                            r.push(flag ? [o, i, items] : o);
                            if (single) {
                                return false
                            }
                        }
                        if (deep && o.sub && o.sub.length) {
                            f(o.sub, fun, deep, single, flag, r)
                        }
                    })
                });
            f(items, fun, deep, single, flag, r);
            return r
        }
    },
    Static: {
        getFromDom: function (id) {
            if ((id = typeof id == "string" ? id.charAt(0) == "!" ? ((id = xui.use(id).get(0)) && id.id) : id : (id && id.id)) && (id = xui.Event._getProfile(id)) && id["xui.UIProfile"]) {
                return id
            }
        }
    }
});
Class("xui.UI", "xui.absObj", {
    Before: function (key, parent_key, o) {
        xui.absBox.$type[key.replace("xui.UI.", "").replace("xui.", "")] = xui.absBox.$type[key] = key;
        return true
    },
    After: function () {
        xui.absObj.After.apply(this, arguments);
        var self = this,
            me = arguments.callee,
            temp, t, k, u, c, i, j, e, w, v, b, d;
        self._ctrlId = new _.id();
        self._idCache = [];
        self.$cssKeys = {};
        t = self.$Keys;
        t.KEY = t.$key = self.KEY;
        self.addTemplateKeys(_.toArr(t, true));
        v = "$Behaviors";
        k = {};
        if ((t = self.$parent) && (e = t.length)) {
            while (e--) {
                b = t[e][v];
                for (i in b) {
                    if (typeof b[i] == "object") {
                        if (_.isArr(b[i])) {
                            u = k[i] || (k[i] = []);
                            u.push.apply(u, b[i])
                        } else {
                            u = k[i] || (k[i] = {});
                            _.merge(u, b[i])
                        }
                    } else {
                        k[i] = b[i]
                    }
                }
            }
        }
        self[v] = k;
        v = "$Templates";
        k = {};
        if ((t = self.$parent) && (e = t[0])) {
            for (i in e[v]) {
                if (i.charAt(0) != "$") {
                    k[i] = e[v][i]
                }
            }
        }
        self[v] = _.clone(k);
        v = "$Appearances";
        k = {};
        if ((t = self.$parent) && (e = t.length)) {
            while (e--) {
                b = t[e];
                for (i in b[v]) {
                    t = b[v][i];
                    u = k[i] || (k[i] = {});
                    _.merge(u, t)
                }
            }
        }
        self[v] = k;
        self.setTemplate(self.Templates);
        delete self.Templates;
        self.setBehavior(self.Behaviors || {});
        delete self.Behaviors;
        self.setAppearance(self.Appearances);
        delete self.Appearances;
        if (t = self.PublicAppearance) {
            xui.UI.$cache_css += self.buildCSSText(t);
            delete self.PublicAppearance
        }
    },
    Instance: {
        setTheme: function (key) {
            if (typeof key != "string" || !key) {
                key = null
            }
            var k, arr = [];
            this.each(function (o) {
                if (key != o.theme) {
                    if (key === null) {
                        delete o.theme
                    } else {
                        o.theme = key
                    }
                    arr.push(o)
                }
            });
            xui.UI.pack(arr, false).refresh();
            return this
        },
        getTheme: function () {
            return this.get(0) && this.get(0).theme
        },
        destroy: function () {
            this.each(function (o) {
                if (o.destroyed) {
                    return
                }
                if (o.$beforeDestroy) {
                    _.each(o.$beforeDestroy, function (f) {
                        _.tryF(f, [], o)
                    });
                    delete o.$beforeDestroy
                }
                if (o.beforeDestroy && false === o.boxing().beforeDestroy()) {
                    return
                }
                if (o.$afterDestroy) {
                    _.each(o.$afterDestroy, function (f) {
                        _.tryF(f, [], o)
                    });
                    delete o.$afterDestroy
                }
                if (o.renderId) {
                    o.getRoot().remove()
                } else {
                    o.__gc()
                }
            });
            this._nodes.length = 0
        },
        isDestroyed: function () {
            return !!(this.get(0) ? this.get(0).destroyed : 1)
        },
        _toDomElems: function () {
            var arr = [];
            _.arr.each(this._nodes, function (o) {
                if (!o.renderId) {
                    arr.push(o)
                }
            });
            if (arr.length) {
                xui.UI.pack(arr, false).render()
            }
            arr.length = 0;
            _.arr.each(this._nodes, function (o) {
                arr.push(o.renderId)
            });
            return arr
        },
        _ini: function (properties, events, host, theme, CS, CC, CB, CF) {
            var self = this,
                c = self.constructor,
                profile, t = "default",
                options, np = c._namePool,
                alias, temp;
            if (properties && properties["xui.Profile"]) {
                profile = properties;
                alias = profile.alias || c.pickAlias();
                xui.UIProfile.apply(profile, [host, self.$key, alias, c, null, events])
            } else {
                if (properties && properties.key && xui.absBox.$type[properties.key]) {
                    options = properties;
                    properties = null;
                    alias = options.alias;
                    alias = (alias && !np[alias]) ? alias : c.pickAlias()
                } else {
                    alias = c.pickAlias()
                }
                profile = new xui.UIProfile(host, self.$key, alias, c, properties, events, options)
            }
            np[alias] = 1;
            for (var i in (temp = c.$DataStruct)) {
                if (!(i in profile.properties)) {
                    profile.properties[i] = typeof temp[i] == "object" ? _.copy(temp[i]) : temp[i]
                }
            }
            profile.keys = c.$Keys;
            profile.CS = CS ? _.copy(CS) : (profile.CS || {});
            profile.CB = CB ? _.copy(CB) : (profile.CB || {});
            profile.CC = CC ? _.copy(CC) : (profile.CC || {});
            profile.CF = CF ? _.copy(CF) : (profile.CF || {});
            if (typeof theme == "string") {
                profile.theme = theme
            }
            profile.template = c.getTemplate();
            profile.behavior = c.$Behaviors;
            if (!profile.serialId) {
                profile.serialId = c._pickSerialId()
            }
            profile.$domId = profile.key + ":" + profile.serialId + ":";
            profile.domId = profile.domId || profile.$domId;
            profile.RenderTrigger = _.copy(c.$RenderTrigger);
            profile.LayoutTrigger = _.copy(c.$LayoutTrigger);
            profile.link(xui.UI._cache, "UI").link(c._cache, "self").link(xui._pool, "xui");
            temp = profile.children;
            profile.children = [];
            if (temp && temp.length) {
                for (var i = 0, v; v = temp[i++];) {
                    if (!v[0]["xui.UIProfile"]) {
                        v[0] = new(xui.SC(v[0].key))(v[0]).get(0)
                    }
                    v[0].linkParent(profile, v[1])
                }
            }
            self._nodes.push(profile);
            profile._cacheInstance = self;
            return self
        },
        busy: function (message, html, key, subId) {
            message = typeof message == "string" ? message : "Loading...";
            html = typeof html == "string" ? html : '<span style="background:url(' + xui.ini.img_busy + ') no-repeat left center;padding-left:16px;">' + message + "</span>";
            return this.each(function (profile) {
                _.resetRun(profile.$xid + ":busy", function (profile, key, subId) {
                    if (!profile.box) {
                        return
                    }
                    var keys = profile.keys,
                        node;
                    key = keys[key] || keys.BORDER || keys.PANEL || keys.KEY;
                    var parentNode = profile.getSubNode(key, subId);
                    if (parentNode.isEmpty()) {
                        return
                    }
                    if (!profile.$busy || profile.$busy.isEmpty()) {
                        node = profile.$busy = xui.create('<div style="left:0;top:0;z-index:10;position:absolute;background-color:#DDD;width:100%;height:100%"></div><div style="left:0;top:0;z-index:20;text-align:center;position:absolute;width:100%;height:100%;font-size:11px;line-height:24px;cursor:wait;"><div>' + html + "</div></div>");
                        xui([node.get(0)]).css({
                            opacity: 0.5
                        })
                    }
                    node = profile.$busy;
                    xui([node.get(1).firstChild]).html(html, false).css("paddingTop", (parentNode.offsetHeight() || 0) / 2 + "px");
                    parentNode.append(node)
                }, 50, [profile, key, subId])
            })
        },
        free: function () {
            return this.each(function (profile) {
                _.resetRun(profile.$xid + ":busy");
                if (profile.$busy) {
                    profile.$busy.remove();
                    delete profile.$busy
                }
            })
        },
        reLayout: function (force) {
            return this.each(function (o) {
                if (!o.renderId) {
                    return
                }
                var p = o.properties;
                if ((!o.$noB) && p.border && o.boxing()._border) {
                    o.boxing()._border(null, false)
                }
                if (p.dock && p.dock != "none") {
                    o.boxing().adjustDock(force)
                } else {
                    if (force) {
                        o._resize_h = -1;
                        o._resize_w = -1
                    }
                    xui.UI.$tryResize(o, p.width, p.height, force)
                }
            })
        },
        toHtml: function (force) {
            var a = [];
            _.arr.each(this._nodes, function (o) {
                a[a.length] = o.toHtml(force)
            });
            return a.join("")
        },
        render: function (triggerLayOut) {
            var ns = this,
                arr = [],
                i, l, o, n = ns._nodes,
                matrix, a = [],
                byId = xui.Dom.byId;
            xui.UI.$applyCSS();
            for (i = 0; o = n[i++];) {
                if (!o.renderId && !xui.Dom.byId(o.domId) && !xui.Dom.byId(o.$domId)) {
                    arr[arr.length] = o
                }
            }
            if (l = arr.length) {
                for (i = 0; i < l; i++) {
                    a[a.length] = arr[i].toHtml()
                }
                xui.UI.$toDom(a.join(""))
            }
            for (i = 0; o = n[i++];) {
                o._render(triggerLayOut)
            }
            a.length = arr.length = 0;
            return ns
        },
        renderOnto: function (node, host) {
            node = xui(node);
            if (node.isEmpty()) {
                return this
            }
            var self = this,
                pro = self.get(0),
                me = arguments.callee,
                paras = me.paras || (me.paras = function (node) {
                    var r = node.cssRegion();
                    r.tabindex = node.attr("tabIndex");
                    if (r.tabindex <= 0) {
                        delete r.tabindex
                    }
                    r.zIndex = node.css("zIndex");
                    r.position = node.css("position");
                    return r
                }),
                id = node.id();
            _.merge(pro.properties, paras(node), "all");
            pro.properties.dock = "none";
            if (!pro.alias && id) {
                pro.alias = id
            }
            if (pro.alias) {
                self.setHost(host || window, pro.alias)
            }
            self.render(true);
            node.replace(self.getRoot());
            if (id) {
                self.setDomId(id)
            }
            return self
        },
        setDomId: function (id) {
            this.get(0).setDomId(id);
            return this
        },
        hide: function () {
            return this.each(function (o) {
                if (o.renderId) {
                    o.getRoot().hide();
                    o.properties.top = o.properties.left = -10000;
                    o.properties.dockIgnore = true
                }
            })
        },
        show: function (parent, subId, left, top) {
            return this.each(function (o) {
                var t = o.properties,
                    b;
                left = (left || left === 0) ? (parseInt(left, 10) || 0) : null;
                top = (top || top === 0) ? (parseInt(top, 10) || 0) : null;
                if (left !== null) {
                    t.left = left
                }
                if (top !== null) {
                    t.top = top
                }
                if (xui.getNodeData(o.renderId, "_xuihide")) {
                    b = 1;
                    t.dockIgnore = false;
                    o.getRoot().show(left && (left + "px"), top && (top + "px"));
                    if (t.dock && t.dock != "none") {
                        xui.UI.$dock(o, false, true)
                    }
                } else {
                    if (!parent && (!o.renderId || (o.getRootNode().id || "").indexOf(xui.Dom._emptyDivId) === 0)) {
                        parent = xui("body")
                    }
                }
                var p = parent,
                    n;
                if (p) {
                    if (p["xui.UIProfile"]) {
                        n = p.renderId;
                        p = p.boxing()
                    } else {
                        if (p["xui.UI"]) {
                            n = (n = p.get(0)) && n.renderId
                        } else {
                            n = (p = xui(p)) && p._nodes[0]
                        }
                    }
                    if (n) {
                        p.append(o.boxing(), subId);
                        if (!b) {
                            o.getRoot().show(left && (left + "px"), top && (top + "px"))
                        }
                    }
                }
            })
        },
        clone: function () {
            return arguments.callee.upper.apply(this, ["domId"])
        },
        refresh: function (remedy) {
            var paras, node, b, p, s, $xid, serialId, fun, box, children, uiv;
            return this.each(function (o) {
                if (!o.renderId) {
                    return
                }
                box = o.box;
                var autoDestroy;
                if (o.host && o.host["xui.Com"] && o.host.autoDestroy) {
                    o.host.autoDestroy = false
                }
                $xid = o.$xid;
                serialId = o.serialId;
                var ar = o.$afterRefresh;
                if (typeof o.boxing().getUIValue == "function") {
                    uiv = o.boxing().getUIValue();
                    if ((o.boxing().getValue() + " ") == (uiv + " ")) {
                        uiv = null
                    }
                }
                if (b = !! o.parent) {
                    p = o.parent.boxing();
                    paras = o.childrenId
                } else {
                    p = o.getRoot().parent()
                }
                node = remedy ? xui.Dom.getEmptyDiv() : xui.$getGhostDiv();
                o.boxing().getChildren().reBoxing().each(function (v) {
                    node.appendChild(v)
                });
                node = null;
                children = _.copy(o.children);
                o.boxing().removeChildren();
                s = o.serialize(false, true);
                fun = o.$refreshTrigger;
                var replace = xui.create("span");
                o.getRoot().replace(replace);
                o.$noReclaim = 1;
                var _c = o._cacheInstance;
                o.boxing().destroy();
                _.merge(o, s, "all");
                delete o.destroyed;
                o.$xid = $xid;
                o.serialId = serialId;
                o = new box(o).render();
                if (_c) {
                    _.merge(_c, o, "all");
                    o.get(0)._cacheInstance = _c
                }
                if (fun) {
                    fun.call(fun.target, o.get(0))
                }
                if (b) {
                    p.append(o, paras)
                } else {
                    p.append(o)
                }
                _.arr.each(children, function (v) {
                    delete v[0].$dockParent;
                    o.append.apply(o, v)
                });
                replace.replace(o.get(0).getRoot());
                replace.remove();
                replace = null;
                if (uiv) {
                    o.setUIValue(uiv, true)
                }
                if (ar) {
                    o.get(0).$afterRefresh = ar;
                    ar(o.get(0))
                }
                if (_.isSet(autoDestroy && o.host && o.host["xui.Com"])) {
                    o.host.autoDestroy = autoDestroy
                }
            })
        },
        append: function (target, subId) {
            if (_.isHash(target) || _.isStr(target)) {
                target = xui.create(target)
            }
            if (target["xui.UIProfile"]) {
                target = target.boxing()
            }
            var pro = this.get(0),
                prop = pro.properties,
                parentNode;
            if (pro.beforeAppend && false === this.beforeAppend(pro, target)) {
                return
            }
            if (target["xui.Com"]) {
                if (subId !== false) {
                    target.getUIComponents().each(function (profile) {
                        profile.linkParent(pro, subId)
                    })
                }
                if (pro.renderId) {
                    if (subId = typeof subId == "string" ? subId : null) {
                        subId = pro.getSubIdByItemId(subId)
                    }
                    parentNode = pro.keys.PANEL ? pro.getSubNode(pro.keys.PANEL, subId) : pro.getRoot();
                    if ((!parentNode.isEmpty()) && (!prop.lazyAppend || parentNode.css("display") != "none")) {
                        parentNode.append(target)
                    }
                } else {
                    (pro.excoms || (pro.excoms = [])).push([target, subId])
                }
            } else {
                if (subId !== false) {
                    if (target["xui.UI"]) {
                        target.each(function (profile) {
                            profile.linkParent(pro, subId)
                        })
                    }
                }
                if (pro.renderId) {
                    if (subId = typeof subId == "string" ? subId : null) {
                        subId = pro.getSubIdByItemId(subId)
                    }
                    parentNode = pro.keys.PANEL ? pro.getSubNode(pro.keys.PANEL, subId) : pro.getRoot();
                    if ((!parentNode.isEmpty()) && (!prop.lazyAppend || parentNode.css("display") != "none")) {
                        parentNode.append(target)
                    }
                } else {
                    if (!target["xui.UI"]) {
                        if (!pro.exchildren) {
                            pro.exchildren = []
                        }
                        pro.exchildren.push([target, subId])
                    }
                }
            }
            if (pro.afterAppend) {
                this.afterAppend(pro, target)
            }
            return this
        },
        getParent: function () {
            var prf = this.get(0);
            if (prf) {
                return prf.parent && prf.parent.boxing()
            }
        },
        getChildrenId: function () {
            var prf = this.get(0);
            if (prf) {
                return prf.childrenId
            }
        },
        getChildren: function (subId, all) {
            var a = [],
                f = function (prf) {
                    _.arr.each(prf.children, function (v) {
                        a.push(v[0]);
                        if (v[0].children && v[0].children.length) {
                            f(v[0])
                        }
                    })
                };
            _.arr.each(this.get(0).children, function (v) {
                if ((subId && typeof (subId) == "string") ? v[1] === subId : 1) {
                    if (all) {
                        f(v[0])
                    } else {
                        a.push(v[0])
                    }
                }
            });
            return xui.UI.pack(a)
        },
        removeChildren: function (subId, bDestroy) {
            return this.each(function (o) {
                var c = _.copy(o.children);
                _.arr.each(c, function (v) {
                    if (subId === true ? 1 : subId ? typeof subId == "string" ? (v[1] == subId) : (v[0] == (subId["xui.UI"] ? subId.get(0) : subId)) : 1) {
                        if (o.beforeRemove && false === o.boxing().beforeRemove(o, v[0], v[1], bDestroy)) {
                            return
                        }
                        v[0].unlinkParent();
                        if (o.afterRemove) {
                            o.boxing().afterRemove(o, v[0], v[1], bDestroy)
                        }
                        if (bDestroy) {
                            v[0].boxing().destroy()
                        }
                    }
                })
            })
        },
        draggable: function (dragKey, dragData, key, options) {
            return this.each(function (o) {
                o.getSubNode(o.keys[key] || "KEY", true).beforeMousedown(dragKey ?
                function (pro, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    if (pro.properties.disabled) {
                        return
                    }
                    options = options || {};
                    options.dragKey = dragKey;
                    options.dragData = typeof dragData == "function" ? dragData() : dragData;
                    _.merge(options, {
                        dragCursor: "pointer",
                        dragType: "icon",
                        dragDefer: 1
                    });
                    xui.use(src).startDrag(e, options)
                } : null, "_d", -1).beforeDragbegin(dragKey ?
                function (profile, e, src) {
                    xui.use(src).onMouseout(true, {
                        $force: true
                    }).onMouseup(true)
                } : null, "_d", -1);
                if (!dragKey) {
                    o.clearCache()
                }
            })
        },
        setCustomFunction: function (key, value) {
            return this.each(function (o) {
                if (typeof key == "string") {
                    if (value) {
                        o.CF[key] = value
                    } else {
                        delete o.CF[key]
                    }
                } else {
                    o.CF = key || {}
                }
            })
        },
        setCustomClass: function (key, value) {
            var me = arguments.callee,
                fun = (me.fun || (me.fun = function (pro, i, h, flag) {
                    if (!h[i]) {
                        return
                    }
                    var node = pro.getSubNode(i, true),
                        b;
                    if (!node.isEmpty()) {
                        _.arr.each(h[i].split(/\s+/), function (o) {
                            node[flag ? "removeClass" : "addClass"](o)
                        })
                    }
                }));
            return this.each(function (o) {
                var bak = _.copy(o.CC);
                if (typeof key == "string") {
                    if (o.renderId) {
                        if (key in bak) {
                            fun(o, key, bak, true)
                        }
                    }
                    if (!value) {
                        delete o.CC[key]
                    } else {
                        o.CC[key] = value;
                        if (o.renderId) {
                            fun(o, key, o.CC)
                        }
                    }
                } else {
                    if ( !! key && typeof key == "object") {
                        if (o.renderId) {
                            for (var i in key) {
                                fun(o, i, bak, true)
                            }
                            for (var i in key) {
                                fun(o, i, key)
                            }
                        }
                        o.CC = key
                    } else {
                        if (o.renderId) {
                            for (var i in bak) {
                                fun(o, i, bak, true)
                            }
                        }
                        o.CC = {}
                    }
                }
            })
        },
        setCustomStyle: function (key, value, nodes) {
            var me = arguments.callee,
                fun = (me.fun || (me.fun = function (pro, key, CSObj, clear, nodes) {
                    if (!CSObj[key]) {
                        return
                    }
                    var hkey = pro.keys[key] || key,
                        tnodes, b;
                    if (nodes) {
                        tnodes = nodes.query("*", "id", hkey == pro.keys.KEY ? pro.domId : new RegExp("^" + hkey + ":" + pro.serialId))
                    } else {
                        tnodes = pro.getSubNode(key, true)
                    }
                    if (!tnodes.isEmpty()) {
                        if (_.isStr(CSObj[key])) {
                            _.arr.each(CSObj[key].split(";"), function (o, i) {
                                if ((b = o.split(":")).length >= 2) {
                                    i = b.shift();
                                    o = b.join(":");
                                    i = i.replace(/\-(\w)/g, function (a, b) {
                                        return b.toUpperCase()
                                    });
                                    tnodes.css(i, clear ? "" : xui.adjustRes(o, 0, 1))
                                }
                            })
                        } else {
                            if (_.isHash(CSObj[key])) {
                                _.each(CSObj[key], function (o, i) {
                                    i = i.replace(/\-(\w)/g, function (a, b) {
                                        return b.toUpperCase()
                                    });
                                    tnodes.css(i, clear ? "" : xui.adjustRes(o, 0, 1))
                                })
                            }
                        }
                    }
                }));
            return this.each(function (o) {
                var bak = _.copy(o.CS);
                if (typeof key == "string") {
                    if (o.renderId) {
                        if (key in bak) {
                            fun(o, key, bak, true, nodes)
                        }
                    }
                    if (!value) {
                        delete o.CS[key]
                    } else {
                        o.CS[key] = value;
                        if (o.renderId) {
                            fun(o, key, o.CS, false, nodes)
                        }
                    }
                } else {
                    if ( !! key && typeof key == "object") {
                        if (o.renderId) {
                            for (var i in key) {
                                fun(o, i, bak, true, nodes)
                            }
                            for (var i in key) {
                                fun(o, i, key, false, nodes)
                            }
                        }
                        o.CS = key
                    } else {
                        if (o.renderId) {
                            for (var i in bak) {
                                fun(o, i, bak, true, nodes)
                            }
                        }
                        o.CS = {}
                    }
                }
            })
        },
        setCustomBehavior: function (key, value) {
            return this.each(function (o) {
                if (typeof key == "string") {
                    if (o.keys[key]) {
                        o.CB[key] = value || {}
                    }
                } else {
                    o.CB = key || {}
                }
                if (o.CB.KEY) {
                    _.merge(o.CB, o.CB.KEY, "all");
                    delete o.CB.KEY
                }
                o.clearCache()
            })
        },
        adjustDock: function (force) {
            return this.each(function (o) {
                if (o.properties.dock && o.properties.dock != "none" && o.renderId) {
                    var n = o.getRootNode();
                    if (n.clientHeight) {
                        if (force) {
                            n.style.width = 0;
                            n.style.height = 0;
                            o._resize_h = -1;
                            o._resize_w = -1
                        }
                        xui.UI.$dock(o, true, true)
                    }
                }
            })
        }
    },
    Initialize: function () {
        var ns = this.prototype;
        _.arr.each("getSubNode,getDomId,getRootNode,getRoot,getContainer".split(","), function (o) {
            if (!ns[o]) {
                ns[o] = function () {
                    var p = this.get(0);
                    return p ? p[o].apply(p, arguments) : null
                }
            }
            ns[o].$original$ = "xui.UI";
            ns[o].$type$ = "instance";
            ns[o].$name$ = o
        });
        var self = this,
            hash = {};
        _.each(xui.UI.$ps, function (i, o) {
            hash[o] = {
                ini: "auto",
                action: function (value) {
                    var self = this,
                        p = self.properties,
                        b = false,
                        args;
                    self.getRoot()[o] ? self.getRoot()[o](value) : xui.Dom._setPxStyle(self.getRootNode(), o, value);
                    if (o == "width" || o == "height") {
                        if (!self.box._onresize && self.onResize) {
                            self.boxing().onResize(self, o == "width" ? value : null, o == "height" ? value : null)
                        }
                    } else {
                        if (self.onMove) {
                            self.boxing().onMove(self, o == "left" ? value : null, o == "top" ? value : null, o == "right" ? value : null, o == "bottom" ? value : null)
                        }
                    }
                    if (p.dock != "none") {
                        args = {
                            $type: p.dock,
                            $dockid: _.arr.indexOf(["width", "height", "fill", "cover"], p.dock) != -1 ? self.$xid : null
                        };
                        switch (p.dock) {
                        case "middle":
                            if (o != "height" && o != "top") {
                                return
                            }
                            args.top = args.height = 1;
                            break;
                        case "center":
                            if (o != "width" && o != "left") {
                                return
                            }
                            args.left = args.width = 1;
                            break;
                        case "top":
                            if (o != "height" && o != "top") {
                                return
                            }
                            args.width = args.height = 1;
                            break;
                        case "bottom":
                            if (o != "height" && o != "bottom") {
                                return
                            }
                            args.width = args.height = 1;
                            break;
                        case "left":
                            if (o != "width" && o != "left") {
                                return
                            }
                            args.width = args.height = 1;
                            break;
                        case "right":
                            if (o != "width" && o != "right") {
                                return
                            }
                            args.width = args.height = 1;
                            break;
                        case "width":
                            if ("width" == o) {
                                return
                            }
                            args.width = 1;
                            break;
                        case "height":
                            if ("height" == o) {
                                return
                            }
                            args.height = 1;
                            break;
                        case "fill":
                        case "cover":
                            if (o == "width" && o == "height") {
                                return
                            }
                            args.width = args.height = 1;
                            break
                        }
                        _.tryF(self.$dockFun, [args], self)
                    }
                }
            }
        });
        _.merge(hash, {
            renderer: {
                ini: null
            },
            zIndex: {
                ini: 1,
                action: function (value) {
                    this.getRoot().css("zIndex", value)
                }
            },
            tabindex: {
                ini: 1,
                action: function (value) {
                    var ns = this,
                        reg = new RegExp("^" + ns.key + "[-\\w]*:" + ns.serialId + ":");
                    ns.getRoot().query("*", function (n) {
                        return n.id && reg.test(n.id) && n.getAttribute("tabIndex")
                    }).attr("tabIndex", value)
                }
            },
            position: {
                ini: "absolute",
                listbox: ["", "static", "relative", "absolute"],
                action: function (value) {
                    this.getRoot().css("position", value)
                }
            },
            visibility: {
                listbox: ["", "visible", "hidden"],
                action: function (value) {
                    this.getRoot().css("visibility", value);
                    if (this.$resizer) {
                        if (value == "hidden") {
                            this.$resizer.hide()
                        } else {
                            this.$resizer.show()
                        }
                    }
                    xui.setNodeData(this.getRootNode(), "_setVisibility", 1)
                }
            },
            display: {
                listbox: ["", "none", "block", "inline", "inline-block"],
                action: function (value) {
                    if (value == "inline-block") {
                        this.getRoot().setInlineBlock()
                    } else {
                        this.getRoot().css("display", value)
                    }
                }
            },
            selectable: {
                ini: false,
                action: function (value) {
                    this.getRoot().setSelectable( !! value)
                }
            }
        });
        self.setDataModel(hash);
        xui.UI.$cache_css += xui.UI.buildCSSText({
            ".xui-css-noscroll, .xui-css-noscroll body, .xui-css-viewport, .xui-css-viewport body": {
                overflow: "hidden",
                height: "100%",
                border: "0 none",
                margin: "0",
                padding: "0"
            },
            ".xui-ui-draggable": {},
            ".xui-ui-btn, .xui-ui-btni, .xui-ui-btnc": {
                height: "22px",
                "line-height": "22px",
                background: xui.UI.$bg("button.gif", "no-repeat", true)
            },
            ".xui-ui-btn": {
                $order: 1,
                "white-space": "nowrap",
                "vertical-align": "top",
                overflow: "hidden",
                "background-position": "right top",
                "padding-right": "4px",
                "font-size": "12px"
            },
            ".xui-ui-btn *": {
                cursor: "pointer"
            },
            ".xui-ui-btnc button, .xui-ui-btnc a": {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie ? 1 : null,
                background: "transparent",
                border: 0,
                margin: 0,
                padding: 0
            },
            ".xui-ui-btnc a": {
                padding: "0 4px"
            },
            ".xui-ui-btnc a, .xui-ui-btnc span, .xui-ui-btnc button": {
                "line-height": "22px"
            },
            ".xui-ui-btni": {
                $order: 1,
                "background-position": "left -60px",
                "padding-left": "4px",
                "vertical-align": "top",
                overflow: "hidden"
            },
            ".xui-ui-btnc": {
                $order: 1,
                "background-position": "left -30px",
                "background-repeat": "repeat-x",
                "vertical-align": "top"
            },
            ".xui-ui-btn-mouseover, .xui-ui-btn-focus": {
                $order: 2,
                "background-position": "right -90px"
            },
            ".xui-ui-btn-mouseover .xui-ui-btni, .xui-ui-btn-focus .xui-ui-btni": {
                $order: 2,
                "background-position": "left -150px"
            },
            ".xui-ui-btn-mouseover .xui-ui-btnc, .xui-ui-btn-focus .xui-ui-btnc": {
                $order: 2,
                "background-position": "left -120px"
            },
            ".xui-ui-btn-mousedown, .xui-ui-btn-checked": {
                $order: 3,
                "background-position": "right -180px"
            },
            ".xui-ui-btn-mousedown .xui-ui-btni, .xui-ui-btn-checked .xui-ui-btni": {
                $order: 3,
                "background-position": "left -240px"
            },
            ".xui-ui-btn-mousedown .xui-ui-btnc, .xui-ui-btn-checked .xui-ui-btnc": {
                $order: 3,
                "background-position": "left -210px"
            },
            ".xui-ui-image": {
                "vertical-align": "middle",
                width: "16px",
                height: "16px",
                "background-repeat": "no-repeat"
            },
            ".xui-ui-icon": {
                "vertical-align": "middle",
                width: "16px",
                height: "16px",
                "background-repeat": "no-repeat",
                "background-position": "center",
                margin: "0 2px"
            },
            ".xui-ui-busy": {
                background: "url(" + xui.ini.img_busy + ") no-repeat center center",
                "background-position": "center"
            },
            ".xui-uicmd-close, .xui-uicmd-info, .xui-uicmd-opt, .xui-uicmd-pop, .xui-uicmd-land, .xui-uicmd-refresh, .xui-uicmd-toggle, .xui-uicmd-toggle2, .xui-uicmd-min, .xui-uicmd-max,.xui-uicmd-restore,.xui-uicmd-pin, .xui-uicmd-check, .xui-uicmd-radio, .xui-uicmd-add, .xui-uicmd-remove": {
                background: xui.UI.$bg("icons.gif", "no-repeat 0 0", true),
                width: "16px",
                height: "16px",
                "margin-right": "2px",
                cursor: "default",
                "vertical-align": "middle"
            },
            ".xui-uicmd-info": {
                $order: 1,
                "background-position": "-320px 0"
            },
            ".xui-uicmd-info-mouseover": {
                $order: 2,
                "background-position": "-320px  -20px"
            },
            ".xui-uicmd-info-mousedown": {
                $order: 3,
                "background-position": "-320px  -40px"
            },
            ".xui-uicmd-opt": {
                $order: 1,
                "background-position": "0 0"
            },
            ".xui-uicmd-opt-mouseover": {
                $order: 2,
                "background-position": "0 -20px"
            },
            ".xui-uicmd-opt-mousedown": {
                $order: 3,
                "background-position": "0 -40px"
            },
            ".xui-uicmd-pop, .xui-uicmd-land": {
                $order: 1,
                "background-position": "-40px 0"
            },
            ".xui-uicmd-pop-mouseover, .xui-uicmd-land-mouseover": {
                $order: 2,
                "background-position": "-40px -20px"
            },
            ".xui-uicmd-pop-mousedown, .xui-uicmd-land-mousedown": {
                $order: 3,
                "background-position": "-40px -40px"
            },
            ".xui-uicmd-refresh": {
                $order: 1,
                "background-position": "-280px 0"
            },
            ".xui-uicmd-refresh-mouseover": {
                $order: 2,
                "background-position": "-280px -20px"
            },
            ".xui-uicmd-refresh-mousedown": {
                $order: 3,
                "background-position": "-280px -40px"
            },
            ".xui-uicmd-pin": {
                $order: 1,
                "background-position": "-80px 0"
            },
            ".xui-uicmd-pin-mouseover": {
                $order: 2,
                "background-position": "-80px -20px"
            },
            ".xui-uicmd-pin-mousedown": {
                $order: 3,
                "background-position": "-80px -40px"
            },
            ".xui-uicmd-pin-checked, .xui-uicmd-pin-checked-mouseover, .xui-uicmd-pin-checked-mousedown": {
                $order: 4,
                "background-position": "-80px -40px"
            },
            ".xui-uicmd-min": {
                $order: 1,
                "background-position": "-120px 0"
            },
            ".xui-uicmd-min-mouseover": {
                $order: 2,
                "background-position": " -120px -20px"
            },
            ".xui-uicmd-min-mousedown": {
                $order: 3,
                "background-position": "-120px -40px"
            },
            ".xui-uicmd-restore": {
                $order: 1,
                "background-position": "-160px 0"
            },
            ".xui-uicmd-restore-mouseover": {
                $order: 2,
                "background-position": "-160px -20px"
            },
            ".xui-uicmd-restore-mousedown": {
                $order: 3,
                "background-position": "-160px -40px"
            },
            ".xui-uicmd-max": {
                $order: 1,
                "background-position": "-200px 0"
            },
            ".xui-uicmd-max-mouseover": {
                $order: 2,
                "background-position": "-200px -20px"
            },
            ".xui-uicmd-max-mousedown": {
                $order: 3,
                "background-position": "-200px -40px"
            },
            ".xui-uicmd-close": {
                $order: 1,
                "background-position": "-240px 0"
            },
            ".xui-uicmd-close-mouseover": {
                $order: 2,
                "background-position": "-240px -20px"
            },
            ".xui-uicmd-close-mousedown": {
                $order: 3,
                "background-position": "-240px -40px"
            },
            ".xui-uicmd-check": {
                $order: 1,
                margin: "0 4px 0 2px",
                "background-position": "-20px -70px"
            },
            ".xui-uicmd-check-mouseover": {
                $order: 2,
                "background-position": "-20px -90px"
            },
            ".xui-uicmd-check-mousedown": {
                $order: 3,
                "background-position": "-20px -110px"
            },
            ".xui-uicmd-check-checked": {
                $order: 4,
                "background-position": "0 -70px"
            },
            ".xui-uicmd-check-checked-mouseover": {
                $order: 5,
                "background-position": "0 -90px"
            },
            ".xui-uicmd-check-checked-mousedown": {
                $order: 6,
                "background-position": "0 -110px"
            },
            ".xui-uicmd-radio": {
                $order: 1,
                margin: "0 4px 0 2px",
                "background-position": "-60px -70px"
            },
            ".xui-uicmd-radio-mouseover": {
                $order: 2,
                "background-position": "-60px -90px"
            },
            ".xui-uicmd-radio-mousedown": {
                $order: 3,
                "background-position": "-60px -110px"
            },
            ".xui-uicmd-radio-checked": {
                $order: 4,
                "background-position": "-40px -70px"
            },
            ".xui-uicmd-radio-checked-mouseover": {
                $order: 5,
                "background-position": "-40px -90px"
            },
            ".xui-uicmd-radio-checked-mousedown": {
                $order: 6,
                "background-position": "-40px -110px"
            },
            ".xui-uicmd-add": {
                $order: 1,
                "background-position": "-56px -222px"
            },
            ".xui-uicmd-add-mouseover": {
                $order: 2,
                "background-position": "-56px -222px"
            },
            ".xui-uicmd-add-mousedown": {
                $order: 3,
                "background-position": "-56px -222px"
            },
            ".xui-uicmd-remove": {
                $order: 1,
                "background-position": "-72px -222px"
            },
            ".xui-uicmd-remove-mouseover": {
                $order: 1,
                "background-position": "-72px -222px"
            },
            ".xui-uicmd-remove-mousedown": {
                $order: 1,
                "background-position": "-72px -222px"
            },
            ".xui-uicmd-toggle": {
                $order: 1,
                "background-position": "-160px -70px"
            },
            ".xui-uicmd-toggle-mouseover": {
                $order: 2,
                "background-position": "-160px -90px"
            },
            ".xui-uicmd-toggle-mousedown": {
                $order: 3,
                "background-position": "-160px -110px"
            },
            ".xui-uicmd-toggle-checked": {
                $order: 4,
                "background-position": "-180px -70px"
            },
            ".xui-uicmd-toggle-checked-mouseover": {
                $order: 5,
                "background-position": "-180px -90px"
            },
            ".xui-uicmd-toggle-checked-mousedown": {
                $order: 6,
                "background-position": "-180px -110px"
            },
            ".xui-uicmd-toggle2": {
                $order: 1,
                "background-position": "-200px -70px"
            },
            ".xui-uicmd-toggle2-mouseover": {
                $order: 2,
                "background-position": "-200px -90px"
            },
            ".xui-uicmd-toggle2-mousedown": {
                $order: 3,
                "background-position": "-200px -110px"
            },
            ".xui-uicmd-toggle2-checked": {
                $order: 4,
                "background-position": "-220px -70px"
            },
            ".xui-uicmd-toggle2-checked-mouseover": {
                $order: 5,
                "background-position": "-220px -90px"
            },
            ".xui-uicmd-toggle2-checked-mousedown": {
                $order: 6,
                "background-position": "-220px -110px"
            },
            ".xui-uicmd-none": {
                display: "none"
            },
            ".xui-uicmd-empty": {
                $order: 1000,
                width: "16px",
                height: "16px",
                "margin-right": "2px",
                cursor: "default",
                "vertical-align": "middle",
                background: "none"
            },
            ".xui-uibar-top, .xui-uibar-bottom, .xui-uibar-top-s, .xui-uibar-bottom-s": {
                position: "relative",
                "vertical-align": "baseline",
                "font-size": 0,
                "line-height": 0
            },
            ".xui-uibar-top td, .xui-uibar-top-s td, .xui-uibar-bottom td, .xui-uibar-bottom-s td": {
                $order: 1,
                background: xui.UI.$bg("bar_vertical.gif", "no-repeat 0 0", true)
            },
            ".xui-uibar-top, .xui-uibar-top .xui-uibar-t": {
                height: "29px"
            },
            ".xui-uibar-top .xui-uibar-tdl": {
                $order: 1,
                "padding-left": "4px",
                height: "100%",
                "background-position": "0 0"
            },
            ".xui-uibar-top .xui-uibar-tdm": {
                $order: 1,
                "background-position": "0 -30px",
                "background-repeat": "repeat-x"
            },
            ".xui-uibar-top .xui-uibar-tdr": {
                $order: 1,
                "padding-left": "4px",
                "background-position": "right -60px"
            },
            ".xui-uibar-top-focus .xui-uibar-tdl": {
                $order: 2,
                "padding-left": "4px",
                height: "100%",
                "background-position": "left -90px"
            },
            ".xui-uibar-top-focus .xui-uibar-tdm": {
                $order: 2,
                "background-position": "left -120px",
                "background-repeat": "repeat-x"
            },
            ".xui-uibar-top-focus .xui-uibar-tdr": {
                $order: 2,
                "padding-left": "4px",
                "background-position": "right -150px"
            },
            ".xui-uibar-top .xui-uibar-cmdl": {
                overflow: "hidden",
                position: "absolute",
                left: 0,
                top: "6px",
                width: "92%",
                height: "22px",
                "padding-left": "8px",
                "white-space": "nowrap"
            },
            ".xui-uibar-top .xui-uibar-cmdr": {
                position: "absolute",
                top: "6px",
                right: "8px",
                "text-align": "right"
            },
            ".xui-uicon-main": {
                position: "relative",
                "padding-left": "4px",
                "font-size": 0,
                "line-height": 0,
                "z-index": 1,
                overflow: "visible",
                background: xui.UI.$bg("bar_horizontal.gif", "repeat-y -595px top", true)
            },
            ".xui-uicon-maini": {
                "padding-right": "4px",
                "font-size": 0,
                "line-height": 0,
                background: xui.UI.$bg("container_right.gif", "#AAD2FA repeat-y right top", true)
            },
            ".xui-uibar-bottom, .xui-uibar-bottom .xui-uibar-t": {
                height: "12px"
            },
            ".xui-uibar-bottom .xui-uibar-tdl": {
                $order: 1,
                "padding-left": "4px",
                height: "100%",
                "background-position": "left -189px"
            },
            ".xui-uibar-bottom .xui-uibar-tdm": {
                $order: 1,
                "background-position": "left -211px",
                "background-repeat": "repeat-x"
            },
            ".xui-uibar-bottom .xui-uibar-tdr": {
                $order: 1,
                "padding-left": "4px",
                "background-position": "right -233px"
            },
            ".xui-uibar-top-s, .xui-uibar-top-s .xui-uibar-t": {
                $order: 3,
                height: "7px"
            },
            ".xui-uibar-top-s .xui-uibar-tdl": {
                $order: 3,
                height: "100%",
                "padding-left": "4px",
                "background-position": "left -261px"
            },
            ".xui-uibar-top-s .xui-uibar-tdm": {
                $order: 3,
                "background-position": "left -283px",
                "background-repeat": "repeat-x"
            },
            ".xui-uibar-top-s .xui-uibar-tdr": {
                $order: 3,
                "padding-left": "4px",
                "background-position": "right -305px"
            },
            ".xui-uibar-top-s .xui-uibar-cmdl": {
                $order: 3,
                display: "none"
            },
            ".xui-uibar-top-s .xui-uibar-cmdr": {
                $order: 3,
                display: "none"
            },
            ".xui-uibar-bottom-s, .xui-uibar-bottom-s .xui-uibar-t": {
                $order: 3,
                height: "6px"
            },
            ".xui-uibar-bottom-s .xui-uibar-tdl": {
                $order: 3,
                height: "100%",
                "padding-left": "4px",
                "background-position": "left -327px"
            },
            ".xui-uibar-bottom-s .xui-uibar-tdm": {
                $order: 3,
                "background-position": "left -349px",
                "background-repeat": "repeat-x"
            },
            ".xui-uibar-bottom-s .xui-uibar-tdr": {
                $order: 3,
                "padding-left": "4px",
                "background-position": "right -371px"
            }
        }) + xui.UI.buildCSSText({
            ".xui-ui-unselectable": {
                $order: 0,
                "-moz-user-select": xui.browser.gek ? "-moz-none" : null,
                "-khtml-user-select": xui.browser.kde ? "none" : null,
                "-webkit-user-select": xui.browser.kde ? "none" : null,
                "-o-user-select": xui.browser.opr ? "none" : null,
                "user-select": "none"
            },
            ".xui-ui-selectable": {
                $order: 1,
                "-moz-user-select": xui.browser.gek ? "text" : null,
                "-khtml-user-select": xui.browser.kde ? "text" : null,
                "-webkit-user-select": xui.browser.kde ? "text" : null,
                "-o-user-select": xui.browser.opr ? "text" : null,
                "user-select": "text"
            },
            ".xui-ui-ctrl": {
                cursor: "default",
                "font-family": "arial,helvetica,clean,sans-serif",
                "font-style": "normal",
                "font-weight": "normal",
                "font-size": "12px",
                "vertical-align": "middle"
            },
            ".xui-uiw-shell": {
                background: "transparent",
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                border: 0,
                padding: 0,
                margin: 0
            },
            ".xui-uiw-frame": {
                $order: 1,
                display: "block",
                position: "relative",
                border: 0,
                padding: 0,
                margin: 0,
                width: "100%",
                height: "100%",
                "-moz-box-flex": "1"
            },
            ".xui-uiw-border": {
                $order: 2,
                display: "block",
                position: "absolute",
                border: 0,
                padding: 0,
                margin: 0,
                left: 0,
                top: 0,
                width: "100%",
                height: "100%"
            }
        }) + xui.UI.buildCSSText({
            ".xui-uibg-base": {
                "background-color": "#fff"
            },
            ".xui-uibg-bar": {
                "background-color": "#aad2fa"
            },
            ".xui-uiborder-flat": {
                border: "solid 1px #648cb4"
            },
            ".xui-uiborder-inset": {
                border: "solid 1px",
                "border-color": "#648cb4 #c8e1fa #c8e1fa #648cb4"
            },
            ".xui-uiborder-outset": {
                border: "solid 1px",
                "border-color": "#c8e1fa #648cb4 #648cb4 #c8e1fa"
            }
        });
        xui.UI.$cache_css2 += xui.UI.buildCSSText({
            ".xui-css-dockparent": {
                overflow: "hidden"
            },
            ".xui-ui-dirty": {
                $order: 1,
                "background-image": xui.UI.$bg("icons.gif", "", true),
                "background-repeat": "no-repeat",
                "background-position": "-390px -290px"
            },
            ".xui-ui-inputdisabled": {
                color: "#808080"
            },
            ".xui-ui-itemreadonly": {
                $order: 2,
                color: "#808080"
            },
            ".xui-ui-readonly, .xui-ui-readonly *": {
                $order: 2,
                color: "#808080"
            },
            ".xui-ui-itemdisabled": {
                $order: 2,
                cursor: "not-allowed",
                color: "#808080"
            },
            ".xui-ui-disabled, .xui-ui-disabled *": {
                $order: 2,
                color: "#808080"
            },
            ".xui-ui-invalid, .xui-ui-invalid *": {
                $order: 1,
                "background-color": "#FFEBCD"
            }
        })
    },
    $End: function () {
        xui.UI.$cache_css += this.buildCSSText(this.$Appearances)
    },
    Static: {
        $cache_css: "",
        $cache_css2: "",
        $css_tag_dirty: "xui-ui-dirty",
        $css_tag_invalid: "xui-ui-invalid",
        $tag_left: "{",
        $tag_right: "}",
        $tag_subId: "_serialId",
        $x01: /\x01/img,
        $x01r: / \x01 /img,
        $tag_special: "\x01",
        $ID: "\x01id\x01",
        $DOMID: "\x01domid\x01",
        $CLS: "\x01cls\x01",
        $childTag: "<!--\x03{id}\x04-->",
        $onSize: function (profile, e) {
            var style = profile.getRootNode().style;
            if (e.width || e.height) {
                xui.UI.$tryResize(profile, style.width, style.height)
            }
            style = null
        },
        $ps: {
            left: 1,
            top: 1,
            width: 1,
            height: 1,
            right: 1,
            bottom: 1
        },
        _objectProp: {
            tagVar: 1
        },
        $toDom: function (str, addEventHandler) {
            if (addEventHandler === false) {
                return _.str.toDom(str)
            }
            var matrix = xui.Dom.getEmptyDiv().get(0),
                r = [];
            matrix.innerHTML = str;
            this.$addEventsHanlder(matrix);
            for (var i = 0, t = matrix.childNodes, l = t.length; i < l; i++) {
                xui.$registerNode(t[i]);
                r[r.length] = t[i].$xid
            }
            matrix = null;
            return xui(r, false)
        },
        $addEventsHanlder: function (node, includeSelf) {
            var ch = xui.$cache.UIKeyMapEvents,
                eh = xui.Event._eventHandler,
                children = _.toArr(node.getElementsByTagName("*")),
                i, l, j, k, id, t, v;
            if (includeSelf) {
                children.push(node)
            }
            if (l = children.length) {
                for (i = 0; i < l; i++) {
                    if ((node = children[i]).nodeType != 1) {
                        continue
                    }
                    if (id = node.id) {
                        if (t = ch[id] || ch[id.substr(0, id.indexOf(":"))]) {
                            v = xui.$registerNode(node);
                            v = v.eHandlers || (v.eHandlers = {});
                            for (j in t) {
                                v[j] = t[j];
                                if (k = eh[j]) {
                                    v[k] = node[k] = t[j]
                                }
                            }
                        }
                    }
                }
            }
            children.length = 0;
            node = null
        },
        getFromDom: function (id) {
            if (id = xui.UIProfile.getFromDom(id)) {
                return id.boxing()
            }
        },
        _ensureValues: function (arr) {
            var a = [],
                i = 0,
                k = 0,
                o, key = this.KEY,
                cache = xui.$cache.profileMap,
                getData = xui.getNodeData;
            if (arr["xui.absBox"]) {
                arr = arr._nodes
            }
            for (; o = arr[i++];) {
                if ((o.box && o.box[key]) || ((o = cache[getData(o.renderId ? o.renderId : o, ["element", "id"])]) && o.box && o.box[key])) {
                    a[k++] = o
                }
            }
            return a.length <= 1 ? a : this._unique(a)
        },
        __gc: function () {
            var self = this,
                k = self.$key,
                cache = xui.$cache;
            _.breakO([cache.template[k], cache.reclaimId[k], self._cache, self._idCache, self.$DataModel, self.$Templates, self.$Behaviors, self], 2);
            delete xui.absBox.$type[k.replace("xui.UI.", "")];
            delete xui.absBox.$type[k];
            _.filter(xui.$cache.UIKeyMapEvents, function (o, i) {
                return !(i == k || i.indexOf(k + "-") == 0)
            });
            Class.__gc(k)
        },
        _pickSerialId: function () {
            var arr = xui.$cache.reclaimId[this.$key];
            if (arr && arr[0]) {
                return arr.pop()
            }
            return this._ctrlId.next()
        },
        $bg: function (path, paras, forceKey) {
            return function (key) {
                var p = xui.ini.path + "appearance/default/" + (typeof forceKey == "string" ? forceKey : forceKey ? "Public" : (p = key.split("."))[p.length - 1]) + "/" + path;
                return "url(" + p + ") " + (paras || "")
            }
        },
        $ieBg: function (path, forceKey) {
            return function (key) {
                var p = xui.ini.path + "appearance/default/" + (typeof forceKey == "string" ? forceKey : forceKey ? "Public" : (p = key.split("."))[p.length - 1]) + "/" + path;
                return 'progid:DXImageTransform.Microsoft.AlphaImageLoader(src="' + p + '",sizingMethod="crop")'
            }
        },
        $doTemplate: function (profile, template, properties, tag, result) {
            var self = arguments.callee,
                s, t, n, x01 = xui.UI.$x01,
                x01r = " \x01 ",
                str = "",
                isA = properties.constructor == Array,
                temp = template[tag || ""],
                r = !result,
                result = result || [];
            if (isA) {
                if (typeof temp != "function") {
                    temp = self
                }
                for (var i = 0; t = properties[i++];) {
                    temp(profile, template, t, tag, result)
                }
            } else {
                if (t = properties.object) {
                    result[result.length] = t.toHtml()
                } else {
                    if (typeof temp == "function") {
                        temp(profile, template, properties, tag, result)
                    } else {
                        tag = tag ? tag + "." : "";
                        var a0 = temp[0],
                            a1 = temp[1];
                        for (var i = 0, l = a0.length; i < l; i++) {
                            if (n = a1[i]) {
                                if (n in properties) {
                                    t = properties[n];
                                    if (template[s = tag + n] && t) {
                                        self(profile, template, t, s, result)
                                    } else {
                                        result[result.length] = (t === undefined || t === null || t === NaN) ? str : typeof t == "string" ? t.replace(x01, x01r) : t
                                    }
                                }
                            } else {
                                result[result.length] = (a0[i] === undefined || a0[i] === null || a0[i] === NaN) ? str : a0[i]
                            }
                        }
                    }
                }
            }
            if (r) {
                return result.join("")
            }
        },
        $buildTemplate: function (profile, template, key, obj, arr) {
            if (template && String(template.tagName).toLowerCase() == "text") {
                arr[arr.length] = template.text;
                return
            }
            var self = arguments.callee,
                behavior = profile.behavior ? key ? profile.behavior[key] : profile.behavior : null,
                prop = profile.properties,
                map1 = self.map1 || (self.map1 = {
                    tagName: 1,
                    text: 1
                }),
                map2 = self.map2 || (self.map2 = {
                    image: 1,
                    input: 1,
                    br: 1,
                    meta: 1,
                    hr: 1,
                    abbr: 1,
                    embed: 1
                }),
                map3 = self.map3 || (self.map3 = {
                    input: 1,
                    textarea: 1,
                    pre: 1,
                    code: 1
                }),
                r2 = self.r2 || (self.r2 = /[a-z]/),
                r3 = self.r3 || (self.r3 = /^(on|before|after)/),
                r7 = self.r7 || (self.r7 = /([^{}]*)\{([\w]+)\}([^{}]*)/g),
                first = false,
                u = xui.UI,
                t, o, bak, tagN, lkey;
            if (!template) {
                template = profile.template
            }
            lkey = key ? profile.keys[key] : profile.key;
            if (!template.tagName) {
                template.tagName = "span"
            }
            if (template.id !== null) {
                template.id = key ? lkey + ":" + u.$ID + ":" + u.$tag_left + u.$tag_subId + u.$tag_right : u.$DOMID
            } else {
                delete template.id
            }
            if (template.className !== null) {
                t = u.$CLS + (key ? "-" + key.toLowerCase() : "");
                bak = template.className || "";
                tagN = template.tagName.charAt(0) != "{" ? template.tagName.toLowerCase() : template.tagName;
                template["class"] = "xui-node xui-node-" + tagN + " " + t + " " + bak + " " + (lkey == profile.key ? ("xui-ui-ctrl " + (xui.browser.ie ? "" : "{_selectable} ")) : "") + u.$tag_special + (key || "KEY") + "_CT" + u.$tag_special + " " + u.$tag_special + (key || "KEY") + "_CC" + u.$tag_special
            }
            delete template.className;
            template.style = (template.style ? (template.style + ";") : "") + u.$tag_special + (key || "KEY") + "_CS" + u.$tag_special;
            var a = [],
                b = {},
                tagName = template.tagName.charAt(0) != "{" ? template.tagName.toLowerCase() : template.tagName,
                text = template.text,
                sc = xui.absObj.$specialChars;
            for (var i in template) {
                if (!template[i]) {
                    continue
                }
                if (!sc[i.charAt(0)] && !map1[i]) {
                    o = template[i];
                    if (!r2.test(i)) {
                        if (typeof o == "object") {
                            if (!o.$order) {
                                o.$order = 0
                            }
                            o.$key = i;
                            a[a.length] = o
                        }
                    } else {
                        b[i] = o
                    }
                }
            }
            a.sort(function (x, y) {
                x = x.$order;
                y = y.$order;
                return x > y ? 1 : x == y ? 0 : -1
            });
            if (!arr) {
                first = true;
                arr = []
            }
            arr[arr.length] = "<" + tagName + " ";
            if (lkey == profile.key) {
                if (xui.browser.ie) {
                    b._onxuisel = "{_selectable}"
                }
            }
            for (var i in b) {
                if (b[i]) {
                    arr[arr.length] = i + '="' + b[i] + '" '
                }
            }
            if (template.className !== null) {
                template.className = bak
            }
            delete template["class"];
            arr[arr.length] = " {_attributes}>";
            if (!map2[tagName] && text) {
                arr[arr.length] = text
            }
            for (var i = 0, l = a.length; i < l;) {
                o = a[i++];
                self(profile, o, o.$key, obj, arr)
            }
            if (!map2[tagName]) {
                arr[arr.length] = "</" + tagName + ">"
            }
            if (first) {
                var a0 = obj[0],
                    a1 = obj[1];
                arr.join("").replace(r7, function (a, b, c, d) {
                    if (b) {
                        a0[a0.length] = b
                    }
                    a1[a0.length] = a0[a0.length] = c;
                    if (d) {
                        a0[a0.length] = d
                    }
                    return ""
                })
            }
        },
        _rpt: function (profile, temp) {
            var me = arguments.callee,
                ui = xui.UI,
                tag = ui.$tag_special,
                r = me._r || (me._r = new RegExp(tag + "([0-9A-Z_]+)_C([CT])" + tag + "|" + tag + "([\\w_\\-\\.]*)" + tag, "img")),
                h1 = {
                    id: profile.serialId,
                    cls: profile.getClass("KEY"),
                    domid: profile.$domId
                },
                h2 = {
                    C: profile.CC,
                    T: profile._CT
                };
            return temp.replace(r, function (a, b, c, d) {
                return h1[d] || (h2[c] ? (h2[c][b] || "") : "")
            }).replace(ui.$x01r, "\x01")
        },
        _build: function (profile, data) {
            var template, t, m, u = xui.UI,
                temp = [
                    [],
                    []
                ],
                self = this,
                key = self.KEY,
                cache = xui.$cache.template,
                hash = profile._hash = "b:" + (profile.template._subid || "") + ";!" + (profile._exhash || "");
            if (typeof profile.theme == "string") {
                var h = profile._CT = {},
                    pre = profile.key.replace(/\./g, "-").toLowerCase().replace("xui-ui", "xui") + "-";
                _.each(profile.keys, function (o, i) {
                    if (i.charAt(0) != "$") {
                        h[i] = pre + profile.theme + "-" + i.toLowerCase()
                    }
                })
            }
            if (!(template = _.get(cache, [key, hash]))) {
                u.$buildTemplate(profile, null, null, temp);
                _.set(cache, [key, hash, ""], temp);
                if (t = profile.template.$submap) {
                    for (var i in t) {
                        if (typeof (m = t[i]) != "function") {
                            var temp = [
                                [],
                                []
                            ];
                            for (var j in m) {
                                if (typeof m[j] == "object") {
                                    u.$buildTemplate(profile, m[j], j, temp)
                                }
                            }
                            m = temp
                        }
                        _.set(cache, [key, hash, i], m)
                    }
                }
                template = _.get(cache, [key, hash])
            }
            if (!template) {
                return ""
            }
            return self._rpt(profile, u.$doTemplate(profile, template, data))
        },
        _setDefaultBehavior: function (hash) {
            var self = this,
                me = arguments.callee,
                map = me._m || (me._m = {
                    "": 1,
                    KEY: 1,
                    $key: 1
                }),
                f = me._f1 || (me._f1 = function (arr, type, mode) {
                    var fun = function (profile, e, src) {
                            var t, id = xui.use(src).id(),
                                item, cid = profile.getSubId(id),
                                prop = profile.properties,
                                nodes, funs, box;
                            if (prop.disabled || prop.readonly) {
                                return
                            }
                            item = profile.SubSerialIdMapItem && profile.SubSerialIdMapItem[cid];
                            if (item && item.disabled) {
                                return
                            }
                            if (item && item.readonly) {
                                return
                            }
                            switch (typeof arr) {
                            case "string":
                                nodes = profile.getSubNode(arr, cid)._get();
                                break;
                            case "function":
                                funs = [arr];
                                break;
                            case "object":
                                nodes = [];
                                funs = [];
                                for (var o, i = 0, l = arr.length; i < l; i++) {
                                    o = arr[i];
                                    if (typeof o == "string") {
                                        nodes.push.apply(nodes, profile.getSubNode(o, cid)._get())
                                    } else {
                                        funs.push(o)
                                    }
                                }
                            }
                            if (nodes && nodes.length) {
                                nodes = xui(nodes);
                                box = profile.boxing();
                                if (mode == 1) {
                                    if (type == "mouseover") {
                                        if (prop.disableHoverEffect) {
                                            return
                                        }
                                        if (profile.beforeHoverEffect && false === box.beforeHoverEffect(profile, item, e, src, "mouseover")) {
                                            return
                                        }
                                    }
                                    if (type == "mousedown") {
                                        if (prop.disableClickEffect) {
                                            return
                                        }
                                        if (profile.beforeClickEffect && false === box.beforeClickEffect(profile, item, e, src, "mousedown")) {
                                            return
                                        }
                                    }
                                    nodes.tagClass("-" + type)
                                } else {
                                    if (type == "mouseup") {
                                        if (prop.disableClickEffect) {
                                            return
                                        }
                                        if (profile.beforeClickEffect && false === box.beforeClickEffect(profile, item, e, src, "mouseup")) {
                                            return
                                        }
                                        nodes.tagClass("-mousedown", false)
                                    } else {
                                        if (prop.disableHoverEffect) {
                                            return
                                        }
                                        if (profile.beforeHoverEffect && false === box.beforeHoverEffect(profile, item, e, src, "mouseout")) {
                                            return
                                        }
                                        nodes.tagClass("(-mouseover|-mousedown)", false)
                                    }
                                }
                            }
                            if (funs && funs.length) {
                                _.arr.each(funs, function (o) {
                                    _.tryF(o, [profile], profile)
                                });
                                funs.length = 0
                            }
                        };
                    return fun
                }),
                hls = {},
                t;
            if (!xui.SC.get("xui.absComposed")) {
                Class("xui.absComposed", "xui.absObj", {
                    Instance: {
                        addPanel: function (paras, children, item) {
                            var pro = _.copy(xui.UI.Panel.$DataStruct);
                            _.merge(pro, paras, "with");
                            _.merge(pro, {
                                dock: "fill",
                                tag: paras.tag || paras.id
                            }, "all");
                            var pb = new xui.UI.Panel(pro),
                                arr = [];
                            this.append(pb, item && item.id);
                            _.arr.each(children, function (o) {
                                arr.push(o[0])
                            });
                            pb.append(xui.UI.pack(arr, false));
                            return this
                        },
                        removePanel: function () {
                            this.destroy()
                        },
                        getPanelPara: function () {
                            return _.copy(this.get(0).properties)
                        },
                        getPanelChildren: function () {
                            return this.get(0).children
                        },
                        _e1: function (profile, item, e, src, type) {},
                        _e2: function (profile, keyboard, e, src) {},
                        _e3: function (profile, e, shiftKey, src) {},
                        _e4: function (profile, e, src, dragKey, dragData, item) {},
                        _e5: function (profile, e, src) {}
                    },
                    Static: {
                        DataModel: {
                            dragKey: "",
                            dropKeys: ""
                        },
                        $abstract: true
                    }
                })
            }
            var src = xui.absComposed.prototype;
            if (hash.HoverEffected) {
                _.each(hash.HoverEffected, function (o, i) {
                    t = map[i] ? hash : (hash[i] || (hash[i] = {}));
                    if (!o) {
                        t.afterMouseover = t.afterMouseout = null
                    } else {
                        t.afterMouseover = f(o, "mouseover", 1);
                        t.afterMouseout = f(o, "mouseout", 2)
                    }
                });
                hls.beforeHoverEffect = src._e1
            }
            if (hash.ClickEffected) {
                _.each(hash.ClickEffected, function (o, i) {
                    t = map[i] ? hash : (hash[i] || (hash[i] = {}));
                    if (!o) {
                        t.afterMousedown = t.afterMouseup = null
                    } else {
                        t.afterMousedown = f(o, "mousedown", 1);
                        t.afterMouseup = f(o, "mouseup", 2)
                    }
                });
                hls.beforeClickEffect = src._e1
            }
            _.merge(hash, {
                beforeKeydown: function (profile, e, src) {
                    if (profile.onHotKeydown) {
                        return false !== profile.boxing().onHotKeydown(profile, xui.Event.getKey(e), e, src)
                    }
                },
                beforeKeypress: function (profile, e, src) {
                    if (profile.onHotKeypress) {
                        return false !== profile.boxing().onHotKeypress(profile, xui.Event.getKey(e), e, src)
                    }
                },
                beforeKeyup: function (profile, e, src) {
                    if (profile.onHotKeyup) {
                        return false !== profile.boxing().onHotKeyup(profile, xui.Event.getKey(e), e, src)
                    }
                }
            });
            hls.onHotKeydown = hls.onHotKeypress = hls.onHotKeyup = src._e2;
            if (hash.NavKeys) {
                _.each(hash.NavKeys, function (o, i) {
                    var map = arguments.callee,
                        k, m1 = map.m1 || (map.m1 = {
                            KEY: 1,
                            $key: 1
                        });
                    if (m1[i]) {
                        return
                    }
                    var m2 = map.m2 || (map.m2 = {
                        input: 1,
                        textarea: 1
                    }),
                        m3 = map.m3 || (map.m3 = {
                            tab: 1,
                            enter: 1,
                            up: 1,
                            down: 1,
                            left: 1,
                            right: 1
                        }),
                        m4 = map.m4 || (map.m4 = {
                            tab: 1,
                            up: 1,
                            down: 1,
                            left: 1,
                            right: 1
                        }),
                        t = hash[i] || (hash[i] = {});
                    var t = hash[i] || (hash[i] = {});
                    if (null === o) {
                        t.afterKeydown = null
                    } else {
                        t.afterKeydown = function (profile, e, src) {
                            var k = xui.Event.getKey(e),
                                key = k.key,
                                ctrl = k.ctrlKey,
                                shift = k.shiftKey,
                                alt = k.altKey,
                                b = false,
                                smartnav = profile._smartnav;
                            if (smartnav) {
                                var node = xui.use(src).get(0);
                                if (m2[k = node.tagName.toLowerCase()]) {
                                    if (key && k == "input" && node.type.toLowerCase() != "text" && node.type.toLowerCase() != "password") {
                                        b = true
                                    } else {
                                        if (m3[key]) {
                                            var reg = xui.use(src).caret(),
                                                txt = xui.use(src).get(0).value;
                                            switch (key) {
                                            case "up":
                                                if (!/[\n\r]/.test(txt.substr(0, reg[0]))) {
                                                    b = true
                                                }
                                                break;
                                            case "left":
                                                if ((ctrl && !shift) || (reg[0] === 0 && (reg[1] !== txt.length || reg[1] === 0))) {
                                                    b = true
                                                }
                                                break;
                                            case "down":
                                                if (!/[\n\r]/.test(txt.substr(reg[1], txt.length))) {
                                                    b = true
                                                }
                                                break;
                                            case "right":
                                                if ((ctrl && !shift) || (reg[1] === txt.length && (reg[0] !== 0 || reg[1] === 0))) {
                                                    b = true
                                                }
                                                break;
                                            case "enter":
                                                if (k == "input" || alt) {
                                                    b = true
                                                }
                                                break;
                                            case "tab":
                                                b = true;
                                                break
                                            }
                                        }
                                    }
                                } else {
                                    if (m4[key]) {
                                        b = true
                                    }
                                }
                                node = null
                            } else {
                                b = key === "tab"
                            }
                            if (b) {
                                if (profile.beforeNextFocus && false === profile.boxing().beforeNextFocus(profile, e, k.shiftKey, src)) {
                                    return false
                                }
                                if (smartnav) {
                                    if (key != "tab") {
                                        xui.use(src).nextFocus(("up" == key || "left" == key) ? false : true)
                                    }
                                }
                            }
                        }
                    }
                });
                hls.beforeNextFocus = src._e3
            }
            if ((t = hash.DroppableKeys) && t.length) {
                _.arr.each(t, function (o) {
                    self._droppable(o)
                });
                t = self.prototype;
                _.arr.each("addPanel,removePanel,getPanelPara,getPanelChildren,getDropKeys,setDropKeys".split(","), function (o) {
                    if (!t[o]) {
                        t[o] = src[o]
                    }
                });
                self.$DataModel.dropKeys = self.$DataStruct.dropKeys = "";
                hls.onDragEnter = hls.onDragLeave = hls.beforeDrop = hls.onDrop = hls.afterDrop = hls.onDropTest = hls.onDropMarkShow = hls.onDropMarkClear = src._e4
            }
            if ((t = hash.DraggableKeys) && t.length) {
                _.arr.each(t, function (o) {
                    self._draggable(o)
                });
                t = self.prototype;
                _.arr.each("getDragKey,setDragKey".split(","), function (o) {
                    if (!t[o]) {
                        t[o] = src[o]
                    }
                });
                self.$DataModel.dragKey = self.$DataStruct.dragKey = "";
                hls.onGetDragData = hls.onStartDrag = hls.onDragStop = src._e5
            }
            if ((t = hash.NoDraggableKeys) && t.length) {
                self.NoDraggableKeys = t
            }
            if ((t = hash.NoDroppableKeys) && t.length) {
                self.NoDroppableKeys = t
            }
            self.setEventHandlers(hls)
        },
        addTemplateKeys: function (arr) {
            var self = this,
                key = self.KEY,
                me = arguments.callee,
                reg = me._reg || (me._reg = /\./g);
            _.arr.each(arr, function (i) {
                self.$cssKeys[i] = (self.$Keys[i] = i == "KEY" ? key : key + "-" + i).replace(reg, "-").toLowerCase().replace("xui-ui", "xui")
            });
            return self
        },
        $getCSSValue: function (cls, key) {
            var cache = xui.$CSSCACHE,
                ck = cls + "->" + key;
            if (ck in cache) {
                return cache[ck]
            }
            var c = xui.Dom.getEmptyDiv().get(0),
                r;
            c.className = cls;
            r = cache[ck] = parseInt(xui.Dom.getStyle(c, key), 10) || 0;
            c.className = "";
            return r
        },
        setAppearance: function (hash) {
            _.merge(this.$Appearances, hash, "all");
            return this
        },
        getAppearance: function () {
            return this.$Appearances
        },
        setTemplate: function (hash, cacheId) {
            if (hash) {
                var self = this,
                    me = arguments.callee,
                    r2 = me.r2 || (me.r2 = /[a-z]/),
                    sc = xui.absObj.$specialChars,
                    _ks = ["KEY"],
                    fun = me._fun || (me._fun = function (hash, arr) {
                        var o, i;
                        for (i in hash) {
                            if (!sc[i.charAt(0)]) {
                                if (!r2.test(i)) {
                                    arr[arr.length] = i;
                                    o = hash[i];
                                    if (typeof o == "object") {
                                        arguments.callee(o, arr)
                                    }
                                }
                            }
                        }
                    }),
                    t;
                fun(hash, _ks);
                self.addTemplateKeys(_ks);
                t = self.$Templates;
                if (typeof cacheId == "string") {
                    hash._subid = cacheId;
                    t[cacheId] = hash
                } else {
                    t._ = hash
                }
                if (t = hash.$submap) {
                    for (var i in t) {
                        for (var j in t[i]) {
                            me.call(self, t[i], j)
                        }
                    }
                }
            }
            return this
        },
        getTemplate: function (cacheId) {
            return this.$Templates[cacheId || "_"]
        },
        setBehavior: function (hash) {
            if (hash) {
                var self = this,
                    ch = xui.$cache.UIKeyMapEvents,
                    skey = self.$key,
                    check = xui.absObj.$specialChars,
                    handler = xui.Event.$eventhandler,
                    eventType = xui.Event._eventMap,
                    me = arguments.callee,
                    r1 = me.r1 || (me.r1 = /[a-z]/),
                    r2 = me.r2 || (me.r2 = /^(on|before|after)/),
                    t = self.$Behaviors,
                    m, i, j, k, o, v, type;
                self._setDefaultBehavior(hash);
                if (hash.KEY) {
                    _.merge(hash, hash.KEY, "all");
                    delete hash.KEY
                }
                for (i in hash) {
                    o = hash[i];
                    if (!check[i.charAt(0)]) {
                        if (!r1.test(i)) {
                            m = t[i] || (t[i] = {});
                            for (j in o) {
                                v = o[j];
                                if (!check[j.charAt(0)]) {
                                    if (v) {
                                        m[j] = v
                                    } else {
                                        delete m[j]
                                    }
                                }
                            }
                        } else {
                            if (r2.test(i)) {
                                if (o) {
                                    t[i] = o
                                } else {
                                    delete t[i]
                                }
                            } else {
                                t[i] = o
                            }
                        }
                    }
                }
                _.filter(ch, function (o, i) {
                    return !(i == skey || i.indexOf(skey + "-") == 0)
                });
                for (i in t) {
                    o = t[i];
                    if (!check[i.charAt(0)]) {
                        if (!r1.test(i)) {
                            for (j in o) {
                                if (!check[j.charAt(0)] && o[j]) {
                                    k = skey + "-" + i;
                                    (ch[k] || (ch[k] = {}))["on" + eventType[j]] = handler
                                }
                            }
                        } else {
                            if (r2.test(i) && o) {
                                k = skey;
                                (ch[k] || (ch[k] = {}))["on" + eventType[i]] = handler
                            }
                        }
                    }
                }
            }
            return self
        },
        getBehavior: function () {
            return this.$Behaviors
        },
        $applyCSS: function () {
            var self = xui.UI,
                cache1 = self.$cache_css,
                cache2 = self.$cache_css2;
            if (!self.$cssNo) {
                self.$cssNo = 1;
                var b = xui.browser;
                xui("body").addClass((b.ie ? ("xui-css-ie xui-css-ie" + b.ver + " ") : b.gek ? ("xui-css-gek xui-css-gek" + b.ver + " ") : b.kde ? ("xui-css-kde xui-css-kde" + b.ver + " ") : b.opr ? ("xui-css-opr xui-css-opr" + b.ver + " ") : "") + (b.isSafari ? "xui-css-safari " : b.isChrome ? "xui-css-chrome " : "") + (b.isMac ? "xui-css-mac" : b.isLinux ? "xui-css-linux " : ""));
                xui("html").addClass(b.isStrict ? "xui-css-base xui-css-strict" : "xui-css-base ")
            }
            if (cache1) {
                xui.CSS.addStyleSheet(cache1, "xui.UI-CSS" + (self.$cssNo++));
                xui.UI.$cache_css = ""
            }
            if (cache2) {
                xui.CSS.addStyleSheet(cache2, "xui.UI-CSS" + (self.$cssNo++), true);
                xui.UI.$cache_css2 = ""
            }
        },
        buildCSSText: function (hash) {
            var self = this,
                me = arguments.callee,
                r1 = me._r1 || (me._r1 = /(^|\s|,)([0-9A-Z_]+)/g),
                h = [],
                r = [],
                browser = xui.browser,
                ie6 = browser.ie6,
                ie = browser.ie,
                gek = browser.gek,
                ks = self.$cssKeys,
                t, v, o;
            for (var i in hash) {
                o = hash[i];
                t = i.replace(r1, function (a, b, c) {
                    return b + "." + (ks[c] || c)
                }).toLowerCase();
                o.$order = parseInt(o.$order, 10) || 0;
                o.$ = t;
                h[h.length] = o
            }
            h.sort(function (x, y) {
                x = x.$order;
                y = y.$order;
                return x > y ? 1 : x == y ? 0 : -1
            });
            for (var i = 0, l = h.length; i < l;) {
                o = h[i++];
                r[r.length] = o.$ + "{";
                if (t = o.$before) {
                    r[r.length] = t
                }
                if (t = o.$text) {
                    r[r.length] = t
                }
                for (var j in o) {
                    if (j.charAt(0) == "$") {
                        continue
                    }
                    if ((v = o[j]) || o[j] === 0) {
                        switch (typeof v) {
                        case "string":
                        case "number":
                            r[r.length] = j + ":" + v + ";";
                            break;
                        case "function":
                            r[r.length] = j + ":" + v(self.KEY) + ";";
                            break;
                        default:
                            _.arr.each(v, function (k) {
                                if (k) {
                                    r[r.length] = j + ":" + k + ";"
                                }
                            })
                        }
                    }
                }
                if (v = o.$after) {
                    r[r.length] = v
                }
                r[r.length] = "}"
            }
            return r.join("")
        },
        _droppable: function (key) {
            var self = this,
                h2 = xui.Event.$eventhandler2,
                o = self.$Behaviors,
                v = key == "KEY" ? o : (o[key] || (o[key] = {})),
                handler = xui.$cache.UIKeyMapEvents,
                k2 = key == "KEY" ? self.KEY : (self.KEY + "-" + key),
                ch = handler[k2] || (handler[k2] = {});
            _.merge(v, {
                beforeMouseover: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    if (profile.behavior.NoDroppableKeys) {
                        var sk = profile.getKey(xui.Event.getSrc(e).id || "").split("-")[1];
                        if (sk && _.arr.indexOf(profile.behavior.NoDroppableKeys, sk) != -1) {
                            return
                        }
                    }
                    var ns = src,
                        dd = xui.DragDrop,
                        pp = dd.getProfile(),
                        key = pp.dragKey,
                        data = pp.dragData,
                        item, box, t, args;
                    if (!key || !data || !(new RegExp("\\b" + key + "\\b")).test(profile.box.getDropKeys(profile, ns))) {
                        return
                    }
                    box = profile.boxing();
                    if (box.getItemByDom) {
                        item = box.getItemByDom(src)
                    }
                    args = [profile, e, ns, key, data, item];
                    if ((t = profile.onDropTest) && (false === box.onDropTest.apply(box, args))) {
                        return
                    }
                    if ((t = profile.box._onDropTest) && (false === t.apply(profile.host || profile, args))) {
                        return
                    }
                    dd.setDropElement(src);
                    if (profile.onDropMarkShow && (false === box.onDropMarkShow.apply(box, args))) {} else {
                        if ((t = profile.box._onDropMarkShow) && (false === t.apply(profile.host || profile, args))) {} else {
                            _.resetRun("setDropFace", dd.setDropFace, 0, [ns], dd)
                        }
                    }
                    if (t = profile.box._onDragEnter) {
                        t.apply(profile.host || profile, args)
                    }
                    if (profile.onDragEnter) {
                        box.onDragEnter.apply(box, args)
                    }
                },
                beforeMouseout: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    var dd = xui.DragDrop,
                        pp = dd.getProfile(),
                        key = pp.dragKey,
                        data = pp.dragData,
                        item, box, args;
                    if (pp.dropElement == src) {
                        box = profile.boxing();
                        if (box.getItemByDom) {
                            item = box.getItemByDom(src)
                        }
                        args = [profile, e, src, key, data, item];
                        if (profile.onDropMarkClear && (false === box.onDropMarkClear.apply(box, args))) {} else {
                            if ((t = profile.box._onDropMarkClear) && (false === t.apply(profile.host || profile, args))) {} else {
                                _.resetRun("setDropFace", dd.setDropFace, 0, [null], xui.DragDrop)
                            }
                        }
                        if (t = profile.box._onDragLeave) {
                            t.apply(profile.host || profile, args)
                        }
                        if (profile.onDragLeave) {
                            box.onDragLeave.apply(box, args)
                        }
                        dd.setDropElement(null)
                    }
                },
                beforeDrop: function (profile, e, src) {
                    var dd = xui.DragDrop,
                        pp = dd.getProfile(),
                        key = pp.dragKey,
                        data = pp.dragData,
                        item, t, args, box = profile.boxing();
                    if (box.getItemByDom) {
                        item = box.getItemByDom(src)
                    }
                    args = [profile, e, src, key, data, item];
                    if (profile.onDropMarkClear && (false === box.onDropMarkClear.apply(box, args))) {} else {
                        if ((t = profile.box._onDropMarkClear) && (false === t.apply(profile.host || profile, args))) {}
                    }
                    if (profile.beforeDrop && (false === box.beforeDrop.apply(box, args))) {
                        return
                    }
                    if (profile.onDrop && (false === box.onDrop.apply(box, args))) {} else {
                        if (profile.box._onDrop) {
                            profile.box._onDrop.apply(profile.host || profile, args)
                        }
                    }
                    if (profile.afterDrop) {
                        box.afterDrop.apply(box, args)
                    }
                }
            }, "all");
            _.merge(ch, {
                onmouseover: h2,
                onmouseout: h2,
                ondrop: h2,
                afterDrop: h2,
                beforeDrop: h2
            });
            return self
        },
        _draggable: function (key) {
            var self = this,
                h2 = xui.Event.$eventhandler2,
                o = self.$Behaviors,
                v = key == "KEY" ? o : (o[key] || (o[key] = {})),
                handler = xui.$cache.UIKeyMapEvents,
                k2 = key == "KEY" ? self.KEY : (self.KEY + "-" + key),
                ch = handler[k2] || (handler[k2] = {});
            _.merge(v, {
                beforeMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    if (profile.properties.disabled) {
                        return
                    }
                    if (!profile.properties.dragKey) {
                        return
                    }
                    if (profile.behavior.NoDraggableKeys) {
                        var sk = profile.getKey(xui.Event.getSrc(e).id || "").split("-")[1];
                        if (sk && _.arr.indexOf(profile.behavior.NoDraggableKeys, sk) != -1) {
                            return
                        }
                    }
                    var pos = xui.Event.getPos(e),
                        box = profile.boxing(),
                        args = [profile, e, src],
                        t;
                    if (profile.onStartDrag && (false === box.onStartDrag.apply(box, args))) {} else {
                        if ((t = profile.box._onStartDrag) && (false === t.apply(profile.host || profile, args))) {} else {
                            var con = profile.box;
                            xui.use(src).startDrag(e, {
                                dragType: "icon",
                                targetLeft: pos.left + 12,
                                targetTop: pos.top + 12,
                                dragCursor: "pointer",
                                dragDefer: 1,
                                dragKey: con.getDragKey(profile, src),
                                dragData: con.getDragData(profile, e, src)
                            })
                        }
                    }
                },
                beforeDragbegin: function (profile, e, src) {
                    xui.use(src).onMouseout(true, {
                        $force: true
                    }).onMouseup(true)
                },
                beforeDragstop: function (profile, e, src) {
                    var t;
                    if (profile.onDragStop) {
                        profile.boxing().onDragStop(profile.e, src)
                    }
                    if (t = profile.box._onDragStop) {
                        t.apply(profile.host || profile, arguments)
                    }
                }
            }, "all");
            _.merge(ch, {
                onmousedown: h2,
                ondragbegin: h2
            });
            return self
        },
        adjustData: function (profile, hashIn, hashOut) {
            if (!hashOut) {
                hashOut = {}
            }
            var dm = profile.box.$DataModel,
                i, o;
            for (i in hashIn) {
                if (i.charAt(0) == "$") {
                    continue
                }
                if (hashIn.hasOwnProperty(i) && !hashOut.hasOwnProperty(i)) {
                    hashOut[i] = typeof (o = hashIn[i]) == "string" ? i == "html" ? xui.adjustRes(o, 0, 1) : xui.adjustRes(o, true) : o
                }
            }
            if ("disabled" in dm) {
                hashOut.disabled = (_.isSet(hashOut.disabled) && hashOut.disabled) ? "xui-ui-itemdisabled" : ""
            }
            if ("readonly" in dm) {
                hashOut.readonly = (_.isSet(hashOut.readonly) && hashOut.readonly) ? "xui-ui-itemreadonly" : ""
            }
            hashOut.imageDisplay = (hashOut.imageClass || hashOut.image) ? "" : "display:none";
            if (hashOut.image) {
                hashOut.backgroundImage = "background-image:url(" + hashOut.image + ");"
            }
            if (hashOut.imagePos) {
                hashOut.backgroundPosition = "background-position:" + hashOut.imagePos + ";"
            } else {
                if (hashOut.image) {
                    hashOut.backgroundPosition = "background-position:center;"
                }
            }
            if (hashOut.imageRepeat) {
                hashOut.backgroundRepeat = "background-repeat:" + hashOut.imageRepeat + ";"
            } else {
                if (hashOut.image) {
                    hashOut.backgroundRepeat = "background-repeat:no-repeat;"
                }
            }
            if (!hashOut.image) {
                hashOut.image = xui.ini.img_bg
            }
            if ((typeof (o = hashOut.renderer) == "function") || (typeof (o = hashIn.renderer) == "function")) {
                hashOut.caption = o.call(profile, hashIn, hashOut)
            }
            return hashOut
        },
        cacheData: function (key, obj) {
            _.set(xui.$cache, ["UIDATA", key], obj);
            return this
        },
        getCachedData: function (key) {
            var r = _.get(xui.$cache, ["UIDATA", key]);
            if (typeof r == "function") {
                r = r()
            }
            return r
        },
        Behaviors: {
            onContextmenu: function (profile, e, src) {
                if (profile.onContextmenu) {
                    return profile.boxing().onContextmenu(profile, e, src) !== false
                }
            }
        },
        DataModel: {
            tag: "",
            tagVar: {
                ini: {}
            },
            className: {
                ini: "",
                action: function (v, ov) {
                    if (ov) {
                        this.getRoot().removeClass(ov)
                    }
                    this.getRoot().addClass(v)
                }
            },
            disableClickEffect: false,
            disableHoverEffect: false,
            disableTips: false,
            disabled: {
                ini: false,
                action: function (v) {
                    var i = this.getRoot();
                    if (v) {
                        i.addClass("xui-ui-disabled")
                    } else {
                        i.removeClass("xui-ui-disabled")
                    }
                }
            },
            dock: {
                ini: "none",
                listbox: ["none", "top", "bottom", "left", "right", "center", "middle", "origin", "width", "height", "fill", "cover"],
                action: function (v) {
                    xui.UI.$dock(this, true, true)
                }
            },
            dockIgnore: {
                ini: false,
                action: function (v) {
                    var self = this;
                    if (self.properties.dock != "none") {
                        xui.UI.$dock(self, true, true)
                    }
                }
            },
            dockOrder: {
                ini: 1,
                action: function (v) {
                    var self = this;
                    if (self.properties.dock != "none") {
                        xui.UI.$dock(self, true, true)
                    }
                }
            },
            dockMargin: {
                ini: {
                    left: 0,
                    top: 0,
                    right: 0,
                    bottom: 0
                },
                action: function (v) {
                    var self = this;
                    if (self.properties.dock != "none") {
                        xui.UI.$dock(self, true, true)
                    }
                }
            },
            dockFloat: {
                ini: false,
                action: function (v) {
                    var self = this;
                    if (self.properties.dock != "none") {
                        xui.UI.$dock(self, true, true)
                    }
                }
            },
            dockMinW: 0,
            dockMinH: 0,
            tips: ""
        },
        EventHandlers: {
            onRender: function (profile) {},
            onLayout: function (profile) {},
            onResize: function (profile, width, height) {},
            onMove: function (profile, left, top, right, bottom) {},
            onDock: function (profile, region) {},
            beforePropertyChanged: function (profile, name, value, ovalue) {},
            afterPropertyChanged: function (profile, name, value, ovalue) {},
            beforeAppend: function (profile, child) {},
            afterAppend: function (profile, child) {},
            beforeRemove: function (profile, child, subId, bdestroy) {},
            afterRemove: function (profile, child, subId, bdestroy) {},
            onDestroy: function (profile) {},
            beforeDestroy: function (profile) {},
            afterDestroy: function (profile) {},
            onShowTips: function (profile, node, pos) {},
            onContextmenu: function (profile, e, src, item) {}
        },
        RenderTrigger: function () {
            var self = this,
                b = self.boxing(),
                p = self.properties;
            if (self.box._onresize) {
                var style = self.getRootNode().style,
                    t;
                if ((t = style.visibility) != "hidden") {
                    self._$visibility = t;
                    style.visibility = "hidden"
                }
                xui.UI.$tryResize(self, p.width, p.height);
                style = null
            }
            if (p.disabled) {
                b.setDisabled(true, true)
            }
            self._inValid = 1
        },
        $doResize: function (profile, w, h, force, key) {
            if (force || ((w || h) && (profile._resize_w != w || profile._resize_h != h))) {
                if (!profile.getRootNode()) {
                    return false
                }
                profile._resize_w = w;
                profile._resize_h = h;
                _.tryF(profile.box._onresize, [profile, w, h, force, key], profile.box);
                if (profile.onResize) {
                    profile.boxing().onResize(profile, w, h)
                }
            }
            if ("_$visibility" in profile) {
                var node = profile.getRootNode(),
                    style = node.style;
                if (style.visibility != "visible" && !xui.getNodeData(node, "_setVisibility")) {
                    style.visibility = profile._$visibility
                }
                node = style = null;
                clearTimeout(profile._$rs_timer);
                delete profile._$rs_timer;
                delete profile._$rs_args;
                delete profile._$visibility
            }
        },
        $tryResize: function (profile, w, h, force, key) {
            var s = profile.box,
                t = s._onresize;
            if (t && (force || w || h)) {
                w = ((w === "" || w == "auto") ? "auto" : parseInt(w, 10)) || null;
                h = ((h === "" || h == "auto") ? "auto" : parseInt(h, 10)) || null;
                if ("_$visibility" in profile) {
                    var args = profile._$rs_args;
                    if (!args) {
                        args = profile._$rs_args = [profile, null, null];
                        profile._$rs_timer = _.asyRun(function () {
                            if (!profile.box) {
                                return
                            }
                            if (profile && profile._$rs_args) {
                                xui.UI.$doResize.apply(null, profile._$rs_args)
                            }
                        })
                    }
                    args[1] = w;
                    args[2] = h;
                    args[3] = force;
                    args[4] = key
                } else {
                    xui.UI.$doResize(profile, w, h, force, key)
                }
            }
        },
        LayoutTrigger: function () {
            var self = this,
                b = self.boxing(),
                p = self.properties;
            if (p.dock && p.dock != "none") {
                if (!self.$laidout) {
                    self.$laidout = 1;
                    var stl = self.getRootNode().style;
                    switch (p.dock) {
                    case "top":
                    case "bottom":
                    case "width":
                        stl.width = 0;
                        break;
                    case "left":
                    case "right":
                    case "height":
                        stl.height = 0;
                        break;
                    default:
                        stl.width = stl.height = 0
                    }
                }
                xui.UI.$dock(this, false, true)
            }
        },
        $dock_args: ["top", "bottom", "left", "right", "center", "middle", "width", "height"],
        $dock_map: {
            middle: 1,
            center: 1
        },
        $dock: function (profile, force, trigger) {
            var node = profile.getRoot(),
                p = xui((node.get(0) && node.get(0).parentNode) || profile.$dockParent);
            if (!p.get(0)) {
                return
            }
            var prop = profile.properties,
                margin = prop.dockMargin,
                auto = "auto",
                value = prop.dock || "none",
                pid = xui.Event.getId(p.get(0)),
                order = function (x, y) {
                    x = parseInt(x.properties.dockOrder, 10) || 0;
                    y = parseInt(y.properties.dockOrder, 10) || 0;
                    return x > y ? 1 : x == y ? 0 : -1
                },
                region, inMatrix = "$inMatrix",
                f, t, isWin, _adjust = function (v) {
                    return xui.browser.ie6 ? v - v % 2 : v
                };
            if (p.get(0) === document.body || p.get(0) === document || p.get(0) === window) {
                pid = "!document";
                isWin = true
            }
            if (pid && (pid == xui.Dom._ghostDivId || _.str.startWith(pid, xui.Dom._emptyDivId))) {
                return
            }
            if (profile.$dockParent != pid || profile.$dockType != value || force) {
                profile.$dockParent = pid;
                profile.$dockType = value;
                profile.unLink("$dockall");
                profile.unLink("$dock");
                profile.unLink("$dock1");
                profile.unLink("$dock2");
                switch (value) {
                case "middle":
                    region = {
                        right: prop.right == "auto" ? auto : (prop.right || ""),
                        bottom: auto,
                        left: prop.left == "auto" ? auto : (prop.left || ""),
                        width: prop.width || "",
                        height: prop.height || ""
                    };
                    break;
                case "center":
                    region = {
                        right: auto,
                        bottom: prop.bottom == "auto" ? auto : (prop.bottom || ""),
                        top: prop.top == "auto" ? auto : (prop.top || ""),
                        width: prop.width || "",
                        height: prop.height || ""
                    };
                    break;
                case "origin":
                    region = {
                        right: auto,
                        bottom: auto,
                        width: prop.width || "",
                        height: prop.height || ""
                    };
                    break;
                case "top":
                    region = {
                        left: margin.left,
                        right: margin.right,
                        bottom: auto,
                        height: prop.height || ""
                    };
                    break;
                case "bottom":
                    region = {
                        left: margin.left,
                        right: margin.right,
                        top: auto,
                        height: prop.height || ""
                    };
                    break;
                case "left":
                    region = {
                        right: auto,
                        width: prop.width || ""
                    };
                    break;
                case "right":
                    region = {
                        left: auto,
                        width: prop.width || ""
                    };
                    break;
                case "width":
                    region = {
                        bottom: auto,
                        height: prop.height || "",
                        top: prop.top || ""
                    };
                    break;
                case "height":
                    region = {
                        right: auto,
                        width: prop.width || "",
                        left: prop.left || ""
                    };
                    break;
                case "fill":
                case "cover":
                    region = {
                        right: auto,
                        bottom: auto
                    };
                    break;
                case "none":
                    region = {
                        left: prop.left,
                        top: prop.top,
                        width: prop.width || "",
                        height: prop.height || ""
                    };
                    break
                }
                if (node.get(0)) {
                    node.cssRegion(region, true)
                }
                if (isWin) {
                    p = xui.win;
                    if (!xui.$cache._resizeTime) {
                        xui.$cache._resizeTime = 1
                    }
                }
                if (value != "none") {
                    f = p.$getEvent("onSize", "dock");
                    if (!f) {
                        f = function (arg) {
                            var me = arguments.callee,
                                map = xui.UI.$dock_map,
                                arr = xui.UI.$dock_args,
                                rePos = me.rePos,
                                win = me.pid == "!window" || me.pid == "!document",
                                node = win ? xui.win : xui(me.pid);
                            if (!node.get(0)) {
                                return
                            }
                            var style = node.get(0).style,
                                obj, i, k, o, key, target;
                            if (arg.$dockid || !win || (_() - xui.$cache._resizeTime > 100)) {
                                obj = {
                                    left: 0,
                                    top: 0,
                                    right: 0,
                                    bottom: 0,
                                    width: parseInt(style && style.width, 10) || node.width(),
                                    height: parseInt(style && style.height, 10) || node.height()
                                };
                                for (k = 0; key = arr[k++];) {
                                    target = me[key];
                                    if (target.length) {
                                        if (!map[key]) {
                                            arg.width = arg.height = 1
                                        }
                                        for (i = 0; o = target[i++];) {
                                            if (!o.properties.dockIgnore) {
                                                rePos(o, obj, key, arg.$dockid, win || arg.width, win || arg.height)
                                            }
                                        }
                                    }
                                }
                                if (obj.later) {
                                    _.each(obj.later, function (o) {
                                        var profile;
                                        try {
                                            o.node.cssRegion(o, true);
                                            if (profile = xui.UIProfile.getFromDom(o.node.get(0))) {
                                                delete o.node;
                                                if (!profile.box._onresize && profile.onResize && (o.width !== null || o.height !== null)) {
                                                    profile.boxing().onResize(profile, o.width, o.height)
                                                }
                                                if (profile.onDock) {
                                                    profile.boxing().onDock(profile, o)
                                                }
                                                if (profile.$onDock) {
                                                    profile.$onDock(profile, o)
                                                }
                                            }
                                        } catch (e) {
                                            _.asyRun(function () {
                                                if (!o.node) {
                                                    return
                                                }
                                                o.width += 1;
                                                o.height += 1;
                                                o.node.cssRegion(o);
                                                o.width -= 1;
                                                o.height -= 1;
                                                o.node.cssRegion(o, true);
                                                if (profile = xui.UIProfile.getFromDom(o.node.get(0))) {
                                                    delete o.node;
                                                    if (!profile.box._onresize && profile.onResize && (o.width !== null || o.height !== null)) {
                                                        profile.boxing().onResize(profile, o.width, o.height)
                                                    }
                                                    if (profile.onDock) {
                                                        profile.boxing().onDock(profile, o)
                                                    }
                                                    if (profile.$onDock) {
                                                        profile.$onDock(profile, o)
                                                    }
                                                }
                                            })
                                        }
                                    })
                                }
                                for (k = 0; key = arr[k++];) {
                                    target = me[key];
                                    if (target.length) {
                                        for (i = 0; o = target[i++];) {
                                            if (!o.properties.dockIgnore) {
                                                if (!obj.later || !obj.later[o.$xid]) {
                                                    if (o.onDock) {
                                                        o.boxing().onDock(o)
                                                    }
                                                    if (o.$onDock) {
                                                        o.$onDock(o)
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                if (win) {
                                    xui.$cache._resizeTime = _()
                                }
                            }
                            me = node = style = null
                        };
                        f.pid = pid;
                        _.arr.each(xui.UI.$dock_args, function (key) {
                            f[key] = []
                        });
                        f.dockall = [];
                        f.rePos = function (profile, obj, value, id, w, h) {
                            var flag = false;
                            if (id && profile.$xid != id) {
                                flag = true
                            }
                            var prop = profile.properties,
                                flt = prop.dockFloat,
                                margin = prop.dockMargin,
                                node = profile.getRoot(),
                                style = profile.getRootNode().style,
                                left, top, right, bottom, temp, other, x = parseInt(prop._dockBorderWidth, 10) || 0,
                                y = parseInt(prop._dockBorderHeight, 10) || 0,
                                region = {};
                            if (style.display == "none") {
                                return
                            }
                            switch (value) {
                            case "middle":
                                node.top((obj.height - node.height()) / 2);
                                break;
                            case "center":
                                node.left((obj.width - node.width()) / 2);
                                break;
                            case "top":
                                if (!flag) {
                                    left = margin.left;
                                    right = margin.right;
                                    top = (flt ? 0 : obj.top) + margin.top;
                                    if (parseFloat(style.top) != top) {
                                        region.top = top
                                    }
                                    temp = obj.width - left - right - x;
                                    temp = _adjust(prop.dockMinW ? Math.max(prop.dockMinW, temp) : temp);
                                    if (parseFloat(style.width) != temp) {
                                        region.width = _adjust(temp)
                                    }
                                    if (!_.isEmpty(region)) {
                                        node.cssRegion(region, true)
                                    }
                                }
                                if (!flt) {
                                    obj.top += (node.offsetHeight() + margin.top + margin.bottom)
                                }
                                break;
                            case "bottom":
                                if (!flag) {
                                    left = margin.left;
                                    right = margin.right;
                                    bottom = (flt ? 0 : obj.bottom) + margin.bottom;
                                    if (parseFloat(style.bottom) != bottom) {
                                        region.bottom = bottom
                                    }
                                    temp = obj.width - left - right - x;
                                    temp = _adjust(prop.dockMinW ? Math.max(prop.dockMinW, temp) : temp);
                                    if (parseFloat(style.width) != temp) {
                                        region.width = _adjust(temp)
                                    }
                                    if (!_.isEmpty(region)) {
                                        node.cssRegion(region, true)
                                    }
                                }
                                if (!flt) {
                                    obj.bottom += (node.offsetHeight() + margin.top + margin.bottom)
                                }
                                break;
                            case "left":
                                if (!flag) {
                                    left = (flt ? 0 : obj.left) + margin.left;
                                    top = (flt ? 0 : obj.top) + margin.top;
                                    bottom = (flt ? 0 : obj.bottom) + margin.bottom;
                                    if (parseFloat(style.left) != left) {
                                        region.left = left
                                    }
                                    if (parseFloat(style.top) != top) {
                                        region.top = top
                                    }
                                    temp = obj.height - top - bottom - y;
                                    temp = _adjust(prop.dockMinH ? Math.max(prop.dockMinH, temp) : temp);
                                    if (parseFloat(style.height) != temp) {
                                        region.height = _adjust(temp)
                                    }
                                    if (!_.isEmpty(region)) {
                                        node.cssRegion(region, true)
                                    }
                                }
                                if (!flt) {
                                    obj.left += (node.offsetWidth() + margin.left + margin.right)
                                }
                                break;
                            case "right":
                                if (!flag) {
                                    right = (flt ? 0 : obj.right) + margin.right;
                                    top = (flt ? 0 : obj.top) + margin.top;
                                    bottom = (flt ? 0 : obj.bottom) + margin.bottom;
                                    if (parseFloat(style.right) != right) {
                                        region.right = right
                                    }
                                    if (parseFloat(style.top) != top) {
                                        region.top = top
                                    }
                                    temp = obj.height - top - bottom - y;
                                    temp = _adjust(prop.dockMinH ? Math.max(prop.dockMinH, temp) : temp);
                                    if (parseFloat(style.height) != temp) {
                                        region.height = _adjust(temp)
                                    }
                                    if (!_.isEmpty(region)) {
                                        node.cssRegion(region, true)
                                    }
                                }
                                if (!flt) {
                                    obj.right += (node.offsetWidth() + margin.left + margin.right)
                                }
                                break;
                            case "width":
                                if (!w) {
                                    return
                                }
                                left = (prop.dock == "cover" ? 0 : (flt ? 0 : obj.left)) + margin.left;
                                right = (prop.dock == "cover" ? 0 : (flt ? 0 : obj.right)) + margin.right;
                                top = prop.dock == "width" ? (parseInt(prop.top, 10) || 0) : ((prop.dock == "cover" ? 0 : (flt ? 0 : obj.top)) + margin.top);
                                temp = obj.width - left - right - x;
                                obj.later = obj.later || {};
                                obj.later[profile.$xid] = obj.later[profile.$xid] || {};
                                _.merge(obj.later[profile.$xid], {
                                    node: node,
                                    width: _adjust(prop.dockMinW ? Math.max(prop.dockMinW, temp) : temp),
                                    left: left,
                                    top: top
                                }, "all");
                                break;
                            case "height":
                                if (!h) {
                                    return
                                }
                                top = (prop.dock == "cover" ? 0 : (flt ? 0 : obj.top)) + margin.top;
                                bottom = (prop.dock == "cover" ? 0 : (flt ? 0 : obj.bottom)) + margin.bottom;
                                left = prop.dock == "height" ? (parseInt(prop.left, 10) || 0) : ((prop.dock == "cover" ? 0 : (flt ? 0 : obj.left)) + margin.left);
                                temp = obj.height - top - bottom - y;
                                obj.later = obj.later || {};
                                obj.later[profile.$xid] = obj.later[profile.$xid] || {};
                                _.merge(obj.later[profile.$xid], {
                                    node: node,
                                    height: _adjust(prop.dockMinH ? Math.max(prop.dockMinH, temp) : temp),
                                    left: left,
                                    top: top
                                }, "all");
                                break
                            }
                        };
                        p.onSize(f, "dock")
                    }
                    if (value == "fill" || value == "cover") {
                        profile.link(f.height, "$dock1");
                        profile.link(f.width, "$dock2");
                        f.height.sort(order);
                        f.width.sort(order)
                    } else {
                        if (value == "origin") {
                            profile.link(f.center, "$dock1");
                            profile.link(f.middle, "$dock2")
                        } else {
                            profile.link(f[value], "$dock");
                            f[value].sort(order)
                        }
                    }
                    profile.link(f.dockall, "$dockall");
                    xui.$cache._resizeTime = 1;
                    profile.$dockFun = f
                }
                var fun = function (p, isWin) {
                        var f, t;
                        if (isWin) {
                            f = xui.win.$getEvent("onSize", "dock");
                            if (f && f.dockall && f.dockall.length) {
                                xui("html").addClass("xui-css-viewport");
                                if (t = xui("body").get(0)) {
                                    t.scroll = "no"
                                }
                            } else {
                                xui("html").removeClass("xui-css-viewport");
                                if (t = xui("body").get(0)) {
                                    t.scroll = ""
                                }
                            }
                        } else {
                            if (p && p.get(0)) {
                                f = p.$getEvent("onSize", "dock");
                                if (f && f.dockall && f.dockall.length) {
                                    p.addClass("xui-css-dockparent")
                                } else {
                                    p.removeClass("xui-css-dockparent")
                                }
                            }
                        }
                    };
                fun(p, isWin);
                if (value != "none") {
                    (profile.$beforeDestroy = (profile.$beforeDestroy || {}))["releaseDock"] = function () {
                        profile.unLink("$dockall");
                        profile.unLink("$dock");
                        profile.unLink("$dock1");
                        profile.unLink("$dock2");
                        fun(p, isWin);
                        if (p && p.get(0) && (p = xui.UIProfile.getFromDom(p.id()))) {
                            _.tryF(p.clearCache, [], p)
                        }
                    }
                } else {
                    if (profile.$beforeDestroy) {
                        delete profile.$beforeDestroy.releaseDock
                    }
                }
            }
            if (value != "none" && trigger) {
                profile.$dockFun({
                    width: 1,
                    height: 1,
                    $dockid: _.arr.indexOf(["width", "height", "fill", "cover"], value) != -1 ? profile.$xid : null,
                    $type: value
                })
            }
        },
        _beforeSerialized: function (profile) {
            var b, t, o = {};
            _.merge(o, profile, "all");
            var p = o.properties = _.copy(profile.properties);
            switch (p.dock) {
            case "top":
            case "bottom":
                delete p.width;
                delete p.left;
                delete p.top;
                delete p.right;
                delete p.bottom;
                break;
            case "left":
            case "right":
                delete p.height;
                delete p.left;
                delete p.top;
                delete p.right;
                delete p.bottom;
                break;
            case "width":
                delete p.width;
                delete p.left;
                delete p.right;
                break;
            case "height":
                delete p.height;
                delete p.top;
                delete p.bottom;
                break;
            case "fill":
            case "cover":
                delete p.width;
                delete p.height;
                delete p.left;
                delete p.top;
                delete p.right;
                delete p.bottom;
                break
            }
            for (var i in xui.UI.$ps) {
                if ((i in p) && typeof p[i] != "number" && p[i] != "" && p[i] != "auto") {
                    p[i] = isNaN(p[i] = parseFloat(p[i])) ? "auto" : p[i]
                }
            }
            for (var i in profile.box._objectProp) {
                if ((i in p) && p[i] && _.isEmpty(p[i])) {
                    delete p[i]
                }
            }
            if (p.items && p.items.length) {
                t = xui.absObj.$specialChars;
                p.items = _.clone(p.items, function (o, i, d) {
                    return !t[((d === 1 ? o.id : i) + "").charAt(0)] && o != undefined
                })
            }
            if ((t = p.dockMargin) && !t.left && !t.top && !t.right && !t.bottom) {
                delete p.dockMargin
            }
            if (p.items && (p.items.length == 0 || p.listKey)) {
                delete p.items
            }
            return o
        },
        getDropKeys: function (profile, node) {
            return profile.properties.dropKeys
        },
        getDragKey: function (profile, node) {
            return profile.properties.dragKey
        },
        getDragData: function (profile, event, node) {
            return {
                profile: profile,
                domId: xui.use(node).id(),
                data: profile.onGetDragData ? profile.boxing().onGetDragData(profile, event, node) : null
            }
        },
        _prepareData: function (profile, data) {
            var prop = profile.properties,
                dm = this.$DataModel,
                me = arguments.callee,
                map = me.map || (me.map = _.toArr("left,top,bottom,right,width,height")),
                a = [],
                ajd = profile.box.adjustData,
                t;
            data = data || {};
            if (prop.id) {
                delete prop.id
            }
            if ("caption" in dm && prop.caption !== null) {
                prop.caption = prop.caption === undefined ? profile.alias : prop.caption
            }
            if ("html" in dm && prop.html) {
                data.html = xui.adjustRes(prop.html, 0, 1)
            }
            if ("src" in dm && prop.src) {
                data.src = xui.adjustRes(prop.src, 0, 1)
            }
            if ("$hborder" in dm) {
                data.bWidth = prop.width - (prop.$hborder || 0) * 2
            }
            if ("$vborder" in dm) {
                data.bHeight = prop.height - (prop.$vborder || 0) * 2
            }
            for (var j = 0, i; i = map[j]; j++) {
                if (prop[i] || prop[i] === 0) {
                    if (String(parseFloat(prop[i])) == String(prop[i])) {
                        a[a.length] = i + ":" + (parseInt(prop[i], 10) || 0) + "px"
                    } else {
                        if (prop[i] != "auto" && prop[i]) {
                            a[a.length] = i + ":" + prop[i]
                        }
                    }
                }
            }
            if (prop.position) {
                a[a.length] = "position:" + prop.position
            }
            if (prop.visibility) {
                a[a.length] = "visibility:" + prop.visibility
            }
            if (prop.zIndex) {
                a[a.length] = "z-index:" + prop.zIndex
            }
            if (prop.display) {
                a[a.length] = "display:" + (prop.display == "inline-block" ? xui.browser.gek ? "-moz-inline-block;display:-moz-inline-box;display:inline-block;" : "inline-block" : prop.display)
            }
            data._style = a.join(";");
            if ("className" in dm) {
                data._className = prop.className || ""
            }
            if ("readonly" in dm) {
                data.readonly = prop.readonly ? "xui-ui-readonly" : ""
            }
            if ("href" in dm) {
                data.href = prop.href || xui.$DEFAULTHREF
            }
            if ("tabindex" in dm) {
                data.tabindex = prop.tabindex || "-1"
            }
            if ("items" in dm) {
                profile.ItemIdMapSubSerialId = {};
                profile.SubSerialIdMapItem = {};
                prop.items = profile.box._adjustItems(prop.items);
                data.items = this._prepareItems(profile, prop.items)
            }
            if ("selectable" in dm) {
                data._selectable = xui.browser.ie ? (prop.selectable ? "true" : "false") : (prop.selectable ? "xui-ui-selectable" : "xui-ui-unselectable")
            }
            data = ajd(profile, prop, data);
            profile.prepared = true;
            return data
        },
        _prepareItems: function (profile, items, pid, mapCache, serialId) {
            var result = [],
                item, dataItem, t, SubID = xui.UI.$tag_subId,
                id, tabindex = profile.properties.tabindex,
                ajd = profile.box.adjustData;
            for (var i = 0, l = items.length; i < l; i++) {
                if (typeof items[i] != "object") {
                    items[i] = {
                        id: items[i]
                    }
                }
                item = items[i];
                if (!item.hasOwnProperty("caption")) {
                    item.caption = item.id
                }
                dataItem = {
                    id: item.id
                };
                if (pid) {
                    dataItem._pid = pid
                }
                id = dataItem[SubID] = typeof serialId == "string" ? serialId : profile.pickSubId("items");
                if (false !== mapCache) {
                    profile.ItemIdMapSubSerialId[item.id] = id;
                    profile.SubSerialIdMapItem[id] = item
                }
                if (t = item.object) {
                    t = dataItem.object = t["xui.absBox"] ? t.get(0) : t;
                    if (t["xui.UIProfile"]) {
                        t.properties.position = "relative"
                    }
                    item.$xid = t.$xid;
                    t.$item = item;
                    t.$holder = profile;
                    if (!t.host || t.host === t) {
                        t.boxing().setHost(profile.host, t.alias)
                    }
                    if (!profile.$attached) {
                        profile.$attached = []
                    }
                    profile.$attached.push(t)
                } else {
                    dataItem._tabindex = tabindex;
                    if (item.hidden) {
                        item.itemDisplay = "display:none;"
                    }
                    ajd(profile, item, dataItem);
                    if (this._prepareItem) {
                        this._prepareItem(profile, dataItem, item, pid, i, l, mapCache, serialId)
                    }
                }
                result.push(dataItem)
            }
            return result
        },
        _showTips: function (profile, node, pos) {
            if (profile.properties.disableTips) {
                return
            }
            if (profile.onShowTips) {
                return profile.boxing().onShowTips(profile, node, pos)
            }
        }
    }
});
Class("xui.absList", "xui.absObj", {
    Instance: {
        activate: function () {
            var profile = this.get(0),
                items = profile.getSubNode("ITEM", true);
            if (!items.isEmpty()) {
                items.focus()
            }
            return this
        },
        insertItems: function (arr, base, before) {
            var node, arr2, items, index, r, data, box, b = this._afterInsertItems;
            return this.each(function (profile) {
                box = profile.box;
                arr2 = box._adjustItems(arr);
                items = profile.properties.items;
                index = _.arr.subIndexOf(items, "id", base);
                if (profile.renderId) {
                    data = box._prepareItems(profile, arr2, base);
                    r = profile._buildItems("items", data);
                    if (profile.$attached) {
                        for (var i = 0, v; v = profile.$attached[i++];) {
                            if (v._render) {
                                v._render(true)
                            }
                        }
                        delete profile.$attached
                    }
                    if (index == -1) {
                        node = profile.getSubNode(box._ITEMSKEY || profile.keys.ITEMS || profile.keys.KEY);
                        if (before) {
                            node.prepend(r)
                        } else {
                            node.append(r)
                        }
                    } else {
                        node = profile.getSubNodeByItemId(box._ITEMKEY || "ITEM", base);
                        if (before) {
                            node.addPrev(r)
                        } else {
                            node.addNext(r)
                        }
                    }
                }
                if (index == -1) {
                    _.arr.insertAny(items, arr2, before ? 0 : -1)
                } else {
                    _.arr.insertAny(items, arr2, before ? index : index + 1)
                }
                if (b) {
                    profile.boxing()._afterInsertItems(profile, data, base, before)
                }
            })
        },
        removeItems: function (arr, key) {
            if (!(arr instanceof Array)) {
                arr = [arr]
            }
            var obj, v, b = this._afterRemoveItems;
            remove = function (profile, arr, target, data, ns, force) {
                var self = arguments.callee;
                if (!ns) {
                    ns = xui()
                }
                _.filter(arr, function (o) {
                    var serialId, b;
                    if (force || (b = (_.arr.indexOf(target, o.id) != -1))) {
                        if (profile.renderId) {
                            if (serialId = profile.ItemIdMapSubSerialId[o.id]) {
                                data.push(_.copy(profile.SubSerialIdMapItem[serialId]));
                                delete profile.SubSerialIdMapItem[serialId];
                                delete profile.ItemIdMapSubSerialId[o.id];
                                profile.reclaimSubId(serialId, "items");
                                if (!force) {
                                    if (!(obj = profile.getSubNode(profile.keys[key] ? key : (profile.box._ITEMKEY || "ITEM"), serialId)).isEmpty()) {
                                        ns.merge(obj)
                                    }
                                    if (o.$xid) {
                                        ns.get().push(xui.getObject(o.$xid).getRootNode())
                                    }
                                }
                            }
                        }
                    }
                    if (o.sub) {
                        self(profile, o.sub, target, data, ns, force || b)
                    }
                    if (b) {
                        for (var i in o) {
                            o[i] = null
                        }
                        return false
                    }
                });
                ns.remove()
            };
            return this.each(function (profile) {
                var p = profile.properties,
                    data = [];
                remove(profile, p.items, arr, data);
                if (v = p.$UIvalue) {
                    if ((v = ("" + v).split(p.valueSeparator)).length > 1) {
                        _.filter(v, function (o) {
                            return _.arr.indexOf(arr, o) == -1
                        });
                        p.$UIvalue = v.join(p.valueSeparator)
                    } else {
                        if (_.arr.indexOf(arr, p.$UIvalue) != -1) {
                            p.$UIvalue = null
                        }
                    }
                }
                if (b && profile.renderId) {
                    profile.boxing()._afterRemoveItems(profile, data)
                }
            })
        },
        clearItems: function (key) {
            return this.each(function (profile) {
                if (!profile.SubSerialIdMapItem) {
                    return
                }
                profile.getSubNode(profile.keys[profile.box._ITEMKEY || "ITEM"], true).remove();
                _.each(profile.SubSerialIdMapItem, function (o, serialId) {
                    profile.reclaimSubId(serialId, "items")
                });
                profile.properties.items.length = 0;
                profile.SubSerialIdMapItem = {};
                profile.ItemIdMapSubSerialId = {};
                profile.properties.$UIvalue = null
            })
        },
        updateItem: function (subId, options) {
            var self = this,
                profile = self.get(0),
                box = profile.box,
                items = profile.properties.items,
                rst = profile.queryItems(items, function (o) {
                    return typeof o == "object" ? o.id === subId : o == subId
                }, true, true, true),
                nid, item, serialId, arr, node, sub, t;
            if (!_.isHash(options)) {
                options = {
                    caption: options + ""
                }
            }
            if (rst && rst.length) {
                rst = rst[0];
                if (typeof rst[0] != "object") {
                    item = rst[2][rst[1]] = {
                        id: rst[0]
                    }
                } else {
                    item = rst[0]
                }
                if (_.isSet(options.id)) {
                    options.id += ""
                }
                if (options.id && subId !== options.id) {
                    nid = options.id;
                    var m2 = profile.ItemIdMapSubSerialId,
                        v;
                    if (!m2[nid]) {
                        if (v = m2[subId]) {
                            m2[nid] = v;
                            delete m2[subId];
                            profile.SubSerialIdMapItem[v].id = nid
                        } else {
                            item.id = nid
                        }
                    }
                }
                delete options.id;
                if (_.isEmpty(options)) {
                    return self
                }
                _.merge(item, options, "all");
                node = profile.getSubNodeByItemId("ITEM", nid || subId);
                if (!node.isEmpty()) {
                    serialId = _.get(profile, ["ItemIdMapSubSerialId", nid || subId]);
                    arr = box._prepareItems(profile, [item], item._pid, false, serialId);
                    if (options.sub) {
                        delete item._created;
                        delete item._checked
                    } else {
                        if (item.sub) {
                            sub = profile.getSubNodeByItemId("SUB", nid || subId)
                        }
                    }
                    node.replace(profile._buildItems(arguments[2] || "items", arr), false);
                    if (sub && !sub.isEmpty()) {
                        if (!(t = profile.getSubNodeByItemId("SUB", nid || subId)).isEmpty()) {
                            t.replace(sub)
                        }
                    }
                    if (typeof self.setUIValue == "function") {
                        var uiv = profile.properties.$UIvalue || "",
                            arr = ("" + uiv).split(profile.properties.valueSeparator);
                        if (arr.length && _.arr.indexOf(arr, subId) != -1) {
                            if (nid) {
                                _.arr.removeValue(arr, subId)
                            }
                            self.setUIValue(arr.join(profile.properties.valueSeparator), true)
                        }
                    }
                }
            }
            return self
        },
        getItems: function (type) {
            var v = this.get(0).properties.items;
            if (type == "data") {
                return _.clone(v, true)
            } else {
                if (type == "min") {
                    var a = _.clone(v, true),
                        b;
                    _.arr.each(a, function (o, i) {
                        a[i] = o.id
                    });
                    return a
                } else {
                    return v
                }
            }
        },
        fireItemClickEvent: function (subId) {
            this.getSubNodeByItemId(this.constructor._focusNodeKey, subId).onClick();
            return this
        }
    },
    Initialize: function () {
        var o = this.prototype;
        _.arr.each(_.toArr("getItemByItemId,getItemByDom,getSubIdByItemId,getSubNodeByItemId"), function (s) {
            o[s] = function () {
                var t = this.get(0);
                return t[s].apply(t, arguments)
            };
            Class._fun(o[s], s, o.KEY, null, "instance")
        })
    },
    Static: {
        _focusNodeKey: "ITEM",
        $abstract: true,
        DataModel: {
            listKey: {
                set: function (value) {
                    var o = this,
                        t = o.box.getCachedData(value);
                    if (t) {
                        o.boxing().setItems(_.clone(t))
                    } else {
                        o.boxing().setItems(o.properties.items)
                    }
                    o.properties.listKey = value
                }
            },
            items: {
                ini: [],
                set: function (value) {
                    var o = this,
                        ins = o.boxing(),
                        items = o.properties.items,
                        children, ia, bv;
                    if (typeof ins.setValue == "function") {
                        bv = o.properties.value;
                        if (bv && value && value.length) {
                            var i = _.arr.indexOf(value, bv);
                            if (i === -1) {
                                i = _.arr.subIndexOf(value, "id", o.properties.value)
                            }
                            if (i === -1) {
                                bv = value ? value[0] ? value[0].id ? value[0].id : value[0] : "" : ""
                            }
                        }
                    }
                    if (items && items.length) {
                        if (o.children && o.children.length) {
                            children = [];
                            _.arr.each(o.children, function (arr) {
                                children.push(ia = [arr[0].serialize(false, true), null, null]);
                                if (ia[1] = arr[1]) {
                                    var i = _.arr.indexOf(items, arr[1]);
                                    if (i === -1) {
                                        i = _.arr.subIndexOf(items, "id", arr[1])
                                    }
                                    if (i !== -1) {
                                        ia[2] = i
                                    }
                                }
                            });
                            ins.removeChildren(true, true)
                        }
                        ins.clearItems()
                    }
                    ins.insertItems(value ? _.copy(value) : null);
                    if (value && value.length && children) {
                        var hash = {},
                            rhash = {},
                            len = value.length;
                        _.arr.each(value, function (item, i) {
                            hash[item.id || item] = i;
                            rhash[i] = item.id || item
                        });
                        _.arr.each(children, function (arr) {
                            var added;
                            if (_.isSet(arr[1])) {
                                if (hash[arr[1]]) {
                                    ins.append(arr[0], arr[1]);
                                    added = 1
                                } else {
                                    if (rhash[arr[2]]) {
                                        ins.append(arr[0], rhash[arr[2]]);
                                        added = 1
                                    }
                                }
                            }
                            if (!added) {
                                ins.append(arr[0], bv)
                            }
                        })
                    }
                    if (_.isSet(bv)) {
                        ins.setValue(bv, true)
                    }
                    if (o.renderId) {
                        var t = o.getRootNode().style;
                        xui.UI.$tryResize(o, t.width, t.height, true);
                        t = null
                    }
                }
            },
            valueSeparator: ";"
        },
        RenderTrigger: function () {
            this.destroyTrigger = function () {
                _.each(this.SubSerialIdMapItem, function (o) {
                    _.breakO(o)
                });
                this.properties.items.length = 0
            }
        },
        _adjustItems: function (arr) {
            if (!arr) {
                arr = []
            }
            if (_.isStr(arr)) {
                arr = [arr]
            }
            var a = _.copy(arr),
                m;
            _.arr.each(a, function (o, i) {
                if (typeof o != "object") {
                    a[i] = {
                        id: o + ""
                    }
                } else {
                    a[i] = _.copy(o);
                    a[i].id = _.isSet(a[i].id) ? (a[i].id + "") : _.id()
                }
            });
            return a
        },
        _showTips: function (profile, node, pos) {
            if (profile.properties.disableTips) {
                return
            }
            if (profile.onShowTips) {
                return profile.boxing().onShowTips(profile, node, pos)
            }
            if (!xui.Tips) {
                return
            }
            var t = profile.properties,
                id = node.id,
                sid = profile.getSubId(id),
                map = profile.SubSerialIdMapItem,
                item = map && map[sid];
            if (item && item.tips) {
                xui.Tips.show(pos, item);
                return true
            } else {
                return false
            }
        }
    }
});
Class("xui.absValue", "xui.absObj", {
    Instance: {
        _getCtrlValue: function () {
            return this.get(0).properties.$UIvalue
        },
        _setCtrlValue: function (value) {
            return this
        },
        _setDirtyMark: function (key) {
            return this.each(function (profile) {
                if (!profile.renderId) {
                    return
                }
                var properties = profile.properties,
                    flag = properties.value !== properties.$UIvalue,
                    o = profile.getSubNode(key || "KEY"),
                    d = xui.UI.$css_tag_dirty;
                if (profile._dirtyFlag !== flag) {
                    if (properties.dirtyMark && properties.showDirtyMark) {
                        if (profile.beforeDirtyMark && false === profile.boxing().beforeDirtyMark(profile, flag)) {} else {
                            if (flag) {
                                o.addClass(d)
                            } else {
                                o.removeClass(d)
                            }
                        }
                    }
                    profile._dirtyFlag = flag
                }
            })
        },
        getValue: function (returnArr) {
            var prf = this.get(0),
                prop = prf.properties,
                v = prop.value;
            if (prf.box.$valuemode == "multi") {
                if (returnArr) {
                    if (_.isStr(v)) {
                        v = v.split(prop.valueSeparator)
                    }
                }
            }
            if (prf.box.$DataModel.selMode && (prop.selMode == "multi" || prop.selMode == "multibycheckbox") && returnArr) {
                if (_.isStr(v)) {
                    v = v.split(prop.valueSeparator)
                }
                if (v && _.isArr(v) && v.length > 1) {
                    v.sort()
                }
            }
            return v
        },
        getUIValue: function (returnArr) {
            var prf = this.get(0),
                prop = prf.properties;
            if (!prf.renderId) {
                return prop && prop.value
            }
            var cv = this._getCtrlValue(),
                v;
            if (!prf.box._checkValid || false !== prf.box._checkValid(prf, cv)) {
                prop.$UIvalue = cv
            }
            v = prop.$UIvalue;
            if (prf.box.$valuemode == "multi") {
                if (returnArr) {
                    if (_.isStr(v)) {
                        v = v.split(prop.valueSeparator)
                    }
                }
            }
            if (prf.box.$DataModel.selMode && (prop.selMode == "multi" || prop.selMode == "multibycheckbox") && returnArr) {
                if (_.isStr(v)) {
                    v = v.split(prop.valueSeparator)
                }
                if (v && _.isArr(v) && v.length > 1) {
                    v.sort()
                }
            }
            return v
        },
        resetValue: function (value) {
            var self = this;
            self.each(function (profile) {
                var r, pro = profile.properties;
                if (typeof (r = profile.box._ensureValue) == "function") {
                    value = r.call(profile.box, profile, value)
                }
                if (pro.value !== value || pro.$UIvalue !== value) {
                    if (profile.box._beforeResetValue) {
                        profile.box._beforeResetValue(profile)
                    }
                    if (typeof (r = profile.$onValueSet) == "function") {
                        r = r.call(profile, value);
                        if (_.isSet(r)) {
                            value = r
                        }
                    }
                    profile.boxing()._setCtrlValue(pro.value = value);
                    pro.$UIvalue = value
                }
                profile._inValid = 1
            });
            self._setDirtyMark();
            return self
        },
        setUIValue: function (value, force) {
            var self = this;
            this.each(function (profile) {
                var prop = profile.properties,
                    r, ovalue = prop.$UIvalue,
                    box = profile.boxing();
                if (ovalue !== value || force) {
                    if ((profile.box._checkValid && false === profile.box._checkValid(profile, value)) || (profile.beforeUIValueSet && false === (r = box.beforeUIValueSet(profile, ovalue, value)))) {
                        return
                    }
                    if (r !== undefined && typeof r !== "boolean") {
                        value = r
                    }
                    if (typeof (r = profile.box._ensureValue) == "function") {
                        value = r.call(profile.box, profile, value)
                    }
                    if (typeof (r = profile.$onUIValueSet) == "function") {
                        r = r.call(profile, value);
                        if (_.isSet(r)) {
                            value = r
                        }
                    }
                    if (profile.renderId) {
                        box._setCtrlValue(value)
                    }
                    prop.$UIvalue = value;
                    if (profile.renderId) {
                        box._setDirtyMark()
                    }
                    if (profile.afterUIValueSet) {
                        box.afterUIValueSet(profile, ovalue, value)
                    }
                    if (profile.onChange) {
                        box.onChange(profile, ovalue, value)
                    }
                    if (!prop.dirtyMark) {
                        box.setValue(value)
                    }
                }
            });
            return this
        },
        updateValue: function () {
            return this.each(function (profile) {
                var prop = profile.properties;
                if (prop.value !== prop.$UIvalue) {
                    var ins = profile.boxing();
                    if (ins.checkValid()) {
                        ins.setValue(ins.getUIValue(), true);
                        ins._setDirtyMark()
                    }
                }
            })
        },
        isDirtied: function () {
            var dirtied = false;
            this.each(function (profile) {
                var p = profile.properties;
                dirtied = (p.value + " ") !== (p.$UIvalue + " ");
                if (dirtied) {
                    return false
                }
            });
            return dirtied
        },
        checkValid: function (value) {
            var prop, tr, r = true,
                outv = _.isSet(value);
            this.each(function (profile) {
                prop = profile.properties;
                tr = true;
                if (profile.box._checkValid2) {
                    r = (tr = profile.box._checkValid2(profile)) && r
                }
                if (tr && profile.box._checkValid) {
                    r = profile.box._checkValid(profile, outv ? value : prop.$UIvalue) && r
                }
                if (!outv && profile.renderId) {
                    profile.boxing()._setDirtyMark()
                }
            });
            return r
        }
    },
    Static: {
        $abstract: true,
        DataModel: {
            dataBinder: {
                ini: "",
                set: function (value, ovalue) {
                    var profile = this,
                        p = profile.properties;
                    if (ovalue) {
                        xui.DataBinder._unBind(ovalue, profile)
                    }
                    p.dataBinder = value;
                    xui.DataBinder._bind(value, profile)
                }
            },
            dataField: {
                ini: "",
                set: function (value, ovalue) {
                    var profile = this,
                        t, p = profile.properties;
                    p.dataField = value;
                    if (!p.dataBinder) {
                        return
                    }
                    var db = xui.DataBinder.getFromName(p.dataBinder);
                    if (db && (t = db.get(0)) && (t = t.properties.data) && _.isSet(t = t[value])) {
                        profile.boxing().setValue(t, true)
                    }
                }
            },
            readonly: {
                ini: false,
                action: function (v) {
                    var i = this.getRoot();
                    if (v) {
                        i.addClass("xui-ui-readonly")
                    } else {
                        i.removeClass("xui-ui-readonly")
                    }
                }
            },
            value: {
                ini: null,
                set: function (value) {
                    var profile = this,
                        p = profile.properties,
                        r, ovalue = p.value,
                        box = profile.boxing(),
                        nv = value;
                    if (profile.box._checkValid && profile.box._checkValid(profile, nv) === false) {
                        return
                    }
                    if (profile.beforeValueSet && false === (r = box.beforeValueSet(profile, ovalue, nv))) {
                        return
                    }
                    if (r !== undefined) {
                        nv = r
                    }
                    if (typeof (r = profile.box._ensureValue) == "function") {
                        nv = r.call(profile.box, profile, nv)
                    }
                    if (typeof (r = profile.$onValueSet) == "function") {
                        r = r.call(profile, nv);
                        if (_.isSet(r)) {
                            nv = r
                        }
                    }
                    if (profile.renderId) {
                        box._setCtrlValue(nv)
                    }
                    p.value = p.$UIvalue = nv;
                    if (!profile._inValid) {
                        profile._inValid = 1
                    }
                    if (profile.renderId) {
                        box._setDirtyMark()
                    }
                    if (profile.afterValueSet) {
                        box.afterValueSet(profile, ovalue, nv)
                    }
                }
            },
            dirtyMark: true,
            showDirtyMark: true
        },
        _ensureValue: function (profile, value) {
            if (profile.box.$DataModel.selMode && (profile.properties.selMode == "multi" || profile.properties.selMode == "multibycheckbox")) {
                if (!_.isArr(value)) {
                    value = (value ? ("" + value) : "").split(profile.properties.valueSeparator)
                }
                value.sort();
                return value.join(profile.properties.valueSeparator)
            } else {
                return _.isArr(value) ? value[0] : value
            }
        },
        EventHandlers: {
            beforeValueSet: function (profile, oldValue, newValue) {},
            afterValueSet: function (profile, oldValue, newValue) {},
            beforeUIValueSet: function (profile, oldValue, newValue) {},
            afterUIValueSet: function (profile, oldValue, newValue) {},
            onChange: function (profile, oldValue, newValue) {},
            beforeDirtyMark: function (profile, dirty) {}
        },
        RenderTrigger: function () {
            var self = this,
                b = self.boxing(),
                p = self.properties,
                t;
            if (t = p.dataBinder) {
                b.setDataBinder(t, true)
            }
            if (t = p.dataField) {
                b.setDataField(t)
            }
            if (p.value !== undefined) {
                if (typeof (t = self.box._ensureValue) == "function") {
                    p.value = t.call(self.box, self, p.value);
                    if (p.$UIvalue) {
                        p.$UIvalue = t.call(self.box, self, p.$UIvalue)
                    }
                }
                if (!p.$UIvalue) {
                    p.$UIvalue = p.value
                }
                b._setCtrlValue(p.$UIvalue, true)
            }
        }
    }
});
new function () {
    var u = "xui.UI";
    Class(u + ".Widget", u, {
        Static: {
            Appearances: {
                KEY: {
                    "font-size": xui.browser.ie ? 0 : null,
                    "line-height": xui.browser.ie ? 0 : null
                }
            },
            Templates: {
                className: "xui-uiw-shell {_className}",
                style: "{_style}",
                FRAME: {
                    className: "xui-uiw-frame ",
                    BORDER: {
                        style: "width:{bWidth}px;height:{bHeight}px;",
                        className: "xui-uiw-border"
                    }
                }
            },
            Behaviors: {
                onSize: xui.UI.$onSize
            },
            DataModel: {
                width: 100,
                height: 100,
                $hborder: 0,
                $vborder: 0
            },
            RenderTrigger: function () {
                var self = this,
                    p = self.properties,
                    o = self.boxing();
                if (self.renderId) {
                    if ((!self.$noB) && p.border && o._border) {
                        o._border()
                    }
                }
                if ((!self.$noR) && p.resizer && o.setResizer) {
                    o.setResizer(p.resizer, true)
                }
                if ((!self.$noS) && p.shadow && o._shadow) {
                    o._shadow()
                }
            },
            _onresize: function (profile, width, height) {
                var t = profile.properties,
                    o = profile.getSubNode("BORDER"),
                    region, ww = width,
                    hh = height,
                    left = Math.max(0, (t.$b_lw || 0) - (t.$hborder || 0)),
                    top = Math.max(0, (t.$b_tw || 0) - (t.$vborder || 0));
                if (ww && "auto" !== ww) {
                    ww -= Math.max((t.$hborder || 0) * 2, (t.$b_lw || 0) + (t.$b_rw || 0));
                    if (xui.browser.ie6) {
                        ww = (parseInt(ww / 2, 10)) * 2
                    }
                }
                if (hh && "auto" !== hh) {
                    hh -= Math.max((t.$vborder || 0) * 2, (t.$b_lw || 0) + (t.$b_rw || 0));
                    if (xui.browser.ie6) {
                        hh = (parseInt(hh / 2, 10)) * 2
                    }
                    if (xui.browser.ie6 && null === width) {
                        o.ieRemedy()
                    }
                }
                region = {
                    left: left,
                    top: top,
                    width: ww,
                    height: hh
                };
                o.cssRegion(region);
                if ((profile.$border || profile.$shadow || profile.$resizer) && xui.browser.ie) {
                    o.ieRemedy()
                }
                return region
            }
        }
    });
    Class(u + ".Link", u, {
        Static: {
            Appearances: {
                KEY: {
                    "font-size": xui.browser.ie ? "12px" : null,
                    "line-height": xui.browser.ie ? "14px" : null,
                    cursor: "pointer"
                }
            },
            Templates: {
                tagName: "a",
                className: "{_className}",
                style: "{_style}",
                href: "{href}",
                target: "{target}",
                tabindex: "{tabindex}",
                text: "{caption}"
            },
            Behaviors: {
                HoverEffected: {
                    KEY: "KEY"
                },
                ClickEffected: {
                    KEY: "KEY"
                },
                onClick: function (profile, e, src) {
                    var r;
                    if (!profile.properties.disabled && profile.onClick) {
                        r = profile.boxing().onClick(profile, e, src)
                    }
                    var href = xui.use(src).attr("href");
                    return typeof r == "boolean" ? r : (href.indexOf("javascript:") === 0 || href.indexOf("#") === 0) ? false : true
                }
            },
            DataModel: {
                caption: {
                    ini: undefined,
                    action: function (v) {
                        v = (_.isSet(v) ? v : "") + "";
                        this.getRoot().html(xui.adjustRes(v, true))
                    }
                },
                href: {
                    ini: xui.$DEFAULTHREF,
                    action: function (v) {
                        this.getRoot().attr("href", v)
                    }
                },
                target: {
                    action: function (v) {
                        this.getRoot().attr("target", v)
                    }
                }
            },
            EventHandlers: {
                onClick: function (profile, e) {}
            }
        }
    });
    Class(u + ".SLabel", u, {
        Static: {
            Templates: {
                className: "{_className}",
                style: "{_style};text-align:{hAlign}",
                text: "{caption}"
            },
            Appearances: {
                KEY: {
                    "padding-right": "6px"
                }
            },
            DataModel: {
                selectable: true,
                caption: {
                    ini: undefined,
                    action: function (v) {
                        v = (_.isSet(v) ? v : "") + "";
                        this.getRoot().html(xui.adjustRes(v, true))
                    }
                },
                hAlign: {
                    ini: "right",
                    listbox: ["left", "center", "right"],
                    action: function (v) {
                        this.getRoot().css("textAlign", v)
                    }
                }
            }
        }
    });
    Class(u + ".SButton", u, {
        Instance: {
            activate: function () {
                this.getSubNode("FOCUS").focus();
                return this
            }
        },
        Static: {
            Templates: {
                className: "{_clsName} {_className}",
                style: "{_style}",
                BTN: {
                    className: "xui-ui-btn",
                    BTNI: {
                        className: "xui-ui-btni",
                        BTNC: {
                            className: "xui-ui-btnc",
                            FOCUS: {
                                tabindex: "{tabindex}",
                                style: "{_align}",
                                ICON: {
                                    $order: 1,
                                    className: "xui-ui-icon {imageClass}",
                                    style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                                },
                                CAPTION: {
                                    $order: 2,
                                    text: "{caption}"
                                }
                            }
                        }
                    }
                }
            },
            Appearances: {
                BTN: {
                    overflow: "hidden"
                },
                "KEY-auto BTN, KEY-auto BTNI, KEY-auto BTNC, KEY-auto FOCUS": {
                    $order: 1,
                    display: xui.$inlineBlock
                },
                "BTN,BTNI,BTNC": {
                    display: "block"
                },
                "KEY FOCUS": {
                    cursor: "pointer",
                    "font-size": "12px",
                    "text-align": "center",
                    display: "block"
                },
                CAPTION: {
                    "vertical-align": xui.browser.ie6 ? "baseline" : "middle",
                    display: "inline"
                }
            },
            Behaviors: {
                HoverEffected: {
                    BTN: ["BTN"]
                },
                ClickEffected: {
                    BTN: ["BTN"]
                },
                NavKeys: {
                    FOCUS: 1
                },
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled) {
                        return false
                    }
                    profile.getSubNode("FOCUS").focus();
                    if (profile.onClick) {
                        profile.boxing().onClick(profile, e, src)
                    }
                },
                onKeydown: function (profile, e, src) {
                    var keys = xui.Event.getKey(e),
                        key = keys.key;
                    if (key == " " || key == "enter") {
                        profile.getSubNode("BTN").afterMousedown();
                        profile.__fakeclick = 1
                    }
                },
                onKeyup: function (profile, e, src) {
                    var keys = xui.Event.getKey(e),
                        key = keys.key;
                    if (key == " " || key == "enter") {
                        profile.getSubNode("BTN").afterMouseup();
                        if (profile.__fakeclick) {
                            xui.use(src).onClick()
                        }
                    }
                    delete profile.__fakeclick
                }
            },
            DataModel: {
                image: {
                    format: "image",
                    action: function (value) {
                        this.getSubNode("ICON").css("display", value ? "" : "none").css("backgroundImage", "url(" + xui.adjustRes(value || "") + ")")
                    }
                },
                imagePos: {
                    action: function (value) {
                        this.getSubNode("ICON").css("backgroundPosition", value)
                    }
                },
                caption: {
                    ini: undefined,
                    action: function (v) {
                        v = (_.isSet(v) ? v : "") + "";
                        this.getSubNode("CAPTION").html(xui.adjustRes(v, true))
                    }
                },
                hAlign: {
                    ini: "center",
                    listbox: ["left", "center", "right"],
                    action: function (v) {
                        this.getSubNode("FOCUS").css("textAlign", v)
                    }
                },
                width: {
                    ini: "auto",
                    action: function (value) {
                        if (value == "auto") {
                            this.getRoot().width("auto").tagClass("-auto")
                        } else {
                            this.getRoot().width(value).tagClass("-auto", false)
                        }
                    }
                },
                height: {
                    readonly: true
                }
            },
            EventHandlers: {
                onClick: function (profile, e, src, value) {}
            },
            _prepareData: function (profile) {
                var data = arguments.callee.upper.call(this, profile);
                data._align = "text-align:" + data.hAlign + ";";
                data._clsName = parseInt(data.width, 10) ? "" : profile.getClass("KEY", "-auto");
                return data
            }
        }
    });
    Class(u + ".SCheckBox", [u, "xui.absValue"], {
        Instance: {
            activate: function () {
                this.getSubNode("FOCUS").focus();
                return this
            },
            _setCtrlValue: function (value) {
                return this.each(function (profile) {
                    profile.getSubNode("MARK").tagClass("-checked", !! value)
                })
            },
            _setDirtyMark: function () {
                return arguments.callee.upper.apply(this, ["CAPTION"])
            }
        },
        Static: {
            Templates: {
                className: "{_clsName} {_className}",
                style: "{_style}",
                FOCUS: {
                    tabindex: "{tabindex}",
                    MARK: {
                        $order: 0,
                        className: "xui-uicmd-check"
                    },
                    ICON: {
                        $order: 1,
                        className: "xui-ui-icon {imageClass}",
                        style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                    },
                    CAPTION: {
                        $order: 2,
                        text: "{caption}"
                    }
                }
            },
            Appearances: {
                KEY: {
                    overflow: "visible"
                },
                FOCUS: {
                    cursor: "default",
                    "vertical-align": "middle",
                    padding: "2px 0",
                    "font-size": "12px",
                    "line-height": "22px"
                },
                CAPTION: {
                    "vertical-align": xui.browser.ie6 ? "baseline" : "middle"
                }
            },
            Behaviors: {
                HoverEffected: {
                    KEY: "MARK"
                },
                ClickEffected: {
                    KEY: "MARK"
                },
                NavKeys: {
                    FOCUS: 1
                },
                onClick: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.boxing();
                    if (p.disabled) {
                        return false
                    }
                    if (p.readonly) {
                        return false
                    }
                    b.setUIValue(!p.$UIvalue);
                    if (profile.onChecked) {
                        b.onChecked(profile, e, p.$UIvalue)
                    }
                    profile.getSubNode("FOCUS").focus()
                },
                FOCUS: {
                    onKeydown: function (profile, e, src) {
                        var key = xui.Event.getKey(e).key;
                        if (key == " " || key == "enter") {
                            profile.getRoot().onClick(true);
                            return false
                        }
                    }
                }
            },
            DataModel: {
                value: false,
                image: {
                    format: "image",
                    action: function (value) {
                        this.getSubNode("ICON").css("display", value ? "" : "none").css("backgroundImage", "url(" + xui.adjustRes(value || "") + ")")
                    }
                },
                imagePos: {
                    action: function (value) {
                        this.getSubNode("ICON").css("backgroundPosition", value)
                    }
                },
                caption: {
                    ini: undefined,
                    action: function (v) {
                        v = (_.isSet(v) ? v : "") + "";
                        this.getSubNode("CAPTION").html(xui.adjustRes(v, true))
                    }
                }
            },
            EventHandlers: {
                onChecked: function (profile, e, value) {}
            },
            _ensureValue: function (profile, value) {
                return !!value
            }
        }
    });
    Class(u + ".Element", u, {
        Static: {
            Templates: {
                tagName: "{nodeName}",
                className: "{_className}",
                style: "{_style};",
                tabindex: "-1",
                text: "{html}" + xui.UI.$childTag
            },
            DataModel: {
                width: "100",
                height: "30",
                selectable: false,
                nodeName: {
                    ini: "xui",
                    action: function (v) {
                        this.boxing().refresh()
                    }
                },
                selectable: true,
                html: {
                    html: 1,
                    action: function (v) {
                        this.getRoot().html(xui.adjustRes(v, 0, 1))
                    }
                },
                attributes: {
                    ini: {},
                    action: function (v, ov) {
                        var root = this.getRoot();
                        if (!_.isEmpty(ov)) {
                            _.each(ov, function (o, i) {
                                root.attr(i, null)
                            })
                        }
                        if (!_.isEmpty(v)) {
                            _.each(v, function (o, i) {
                                root.attr(i, o)
                            })
                        }
                    }
                }
            },
            Appearances: {
                KEY: {
                    "line-height": "1"
                }
            },
            RenderTrigger: function () {
                var v = this.properties.attributes;
                if (!_.isEmpty(v)) {
                    var root = this.getRoot();
                    _.each(v, function (o, i) {
                        root.attr(i, o)
                    })
                }
            }
        }
    });
    Class(u + ".Span", u, {
        Static: {
            Templates: {
                className: "{_className}",
                style: "{_style};{_overflow};",
                tabindex: "-1",
                text: "{html}" + xui.UI.$childTag
            },
            DataModel: {
                width: "16",
                height: "16",
                selectable: true,
                html: {
                    html: 1,
                    action: function (v) {
                        this.getRoot().html(xui.adjustRes(v, 0, 1))
                    }
                },
                overflow: {
                    ini: xui.browser.isTouch ? "auto" : undefined,
                    listbox: ["", "visible", "hidden", "scroll", "auto"],
                    action: function (v) {
                        this.getContainer().css("overflow", v || "")
                    }
                }
            },
            Appearances: {
                KEY: {
                    "line-height": "1"
                }
            },
            _prepareData: function (profile) {
                var data = arguments.callee.upper.call(this, profile);
                if (_.isStr(data.overflow)) {
                    data._overflow = data.overflow.indexOf(":") != -1 ? (data.overflow) : ("overflow:" + data.overflow)
                }
                return data
            }
        }
    });
    Class(u + ".Div", u, {
        Static: {
            Appearances: {
                KEY: {
                    outline: xui.browser.gek ? "none" : null,
                    zoom: (xui.browser.ie && xui.browser.ver < 9) ? "1" : null,
                    "line-height": "1",
                    background: xui.browser.ie ? "url(" + xui.ini.img_bg + ") no-repeat left top" : null
                }
            },
            Templates: {
                tagName: "div",
                className: "xui-nooutline {_className}",
                style: "{_style};{_overflow};",
                tabindex: "-1",
                text: "{html}" + xui.UI.$childTag
            },
            DataModel: {
                iframeAutoLoad: "",
                ajaxAutoLoad: "",
                width: "100",
                height: "100",
                selectable: true,
                html: {
                    html: 1,
                    action: function (v) {
                        this.getRoot().html(xui.adjustRes(v, 0, 1))
                    }
                },
                overflow: {
                    ini: xui.browser.isTouch ? "auto" : undefined,
                    listbox: ["", "visible", "hidden", "scroll", "auto", "inherited"],
                    action: function (v) {
                        this.getContainer().css("overflow", v || "")
                    }
                }
            },
            RenderTrigger: function () {
                var ns = this;
                if (ns.box.KEY == "xui.UI.Div") {
                    if (ns.properties.iframeAutoLoad || ns.properties.ajaxAutoLoad) {
                        ns.box._applyAutoLoad(this)
                    }
                }
            },
            _prepareData: function (profile) {
                var data = arguments.callee.upper.call(this, profile);
                if (_.isStr(data.overflow)) {
                    data._overflow = data.overflow.indexOf(":") != -1 ? (data.overflow) : ("overflow:" + data.overflow)
                }
                return data
            },
            _applyAutoLoad: function (prf) {
                var prop = prf.properties,
                    ins = prf.boxing();
                if (prop.iframeAutoLoad) {
                    ins.getContainer().css("overflow", "hidden");
                    if (typeof prop.iframeAutoLoad == "string") {
                        prop.iframeAutoLoad = {
                            url: prop.iframeAutoLoad
                        }
                    }
                    var hash = prop.iframeAutoLoad,
                        id = "biframe_" + _(),
                        e = xui.browser.ie && xui.browser.ver < 9,
                        ifr = document.createElement(e ? "<iframe name='" + id + "'>" : "iframe");
                    if (!hash.query) {
                        hash.query = {}
                    }
                    hash.query._rand = _();
                    prop.iframeAutoLoad.frameName = ifr.id = ifr.name = id;
                    ifr.src = hash.url;
                    ifr.frameBorder = "0";
                    ifr.marginWidth = "0";
                    ifr.marginHeight = "0";
                    ifr.vspace = "0";
                    ifr.hspace = "0";
                    ifr.allowTransparency = "true";
                    ifr.width = "100%";
                    ifr.height = "100%";
                    ins.append(ifr);
                    xui.Dom.submit(hash.url, hash.query, hash.method, id, hash.enctype)
                } else {
                    if (prop.ajaxAutoLoad) {
                        if (typeof prop.ajaxAutoLoad == "string") {
                            prop.ajaxAutoLoad = {
                                url: prop.ajaxAutoLoad
                            }
                        }
                        var hash = prop.ajaxAutoLoad,
                            options = {
                                rspType: "text"
                            };
                        if (!hash.query) {
                            hash.query = {}
                        }
                        hash.query._rand = _();
                        _.merge(options, hash.options);
                        ins.busy();
                        xui.Ajax(hash.url, hash.query, function (rsp) {
                            var n = xui.create("div");
                            n.html(rsp, false, true);
                            ins.append(n.children());
                            ins.free()
                        }, function (err) {
                            ins.append("<div>" + err + "</div>");
                            ins.free()
                        }, null, options).start()
                    }
                }
            }
        }
    });
    Class(u + ".Tag", u + ".Div", {
        Static: {
            Templates: {
                tagName: "div",
                className: "{_className}",
                style: "overflow:auto;border:dashed blue 1px;text-align:center;background:#EBEADB;{_style}",
                text: "{tagKey}" + xui.UI.$childTag
            },
            DataModel: {
                html: null,
                tagKey: {
                    action: function (v) {
                        this.getRoot().html(v)
                    }
                }
            },
            _l: _.toArr("left,top,bottom,right,width,height,zIndex,tabindex,position,dock,dockFloat,dockMinW,dockMinH,dockOrder,dockMargin"),
            replace: function (tagProfile, profile, com) {
                _.arr.each(this._l, function (s) {
                    if (s in tagProfile.properties) {
                        profile.properties[s] = tagProfile.properties[s]
                    }
                });
                _.merge(profile.CS, tagProfile.CS, "all");
                _.merge(profile.CC, tagProfile.CC, "all");
                if (typeof tagProfile.theme == "string") {
                    profile.theme = tagProfile.theme
                }
                if (tagProfile.parent) {
                    var clink = tagProfile.parent.children,
                        linkObj = clink["$" + tagProfile.$xid],
                        index = _.arr.indexOf(clink, linkObj);
                    tagProfile.parent.boxing().append(profile, linkObj[1]);
                    clink[index] = clink.pop();
                    tagProfile.unLink("$parent");
                    delete tagProfile.parent
                } else {
                    if (com) {
                        _.arr.each(com._nodes, function (o, i) {
                            if (o === tagProfile) {
                                com._nodes[i] = profile;
                                return false
                            }
                        })
                    }
                }
                if (tagProfile.renderId) {
                    profile.boxing().renderOnto(tagProfile.getRootNode())
                }
            }
        }
    });
    Class(u + ".Pane", u + ".Div", {
        Static: {
            Behaviors: {
                DroppableKeys: ["KEY"],
                PanelKeys: ["KEY"]
            },
            Appearances: {
                KEY: {
                    "line-height": "1"
                }
            },
            RenderTrigger: function () {
                var ns = this;
                if (ns.box.KEY == "xui.UI.Pane") {
                    if (ns.properties.iframeAutoLoad || ns.properties.ajaxAutoLoad) {
                        ns.box._applyAutoLoad(this)
                    }
                }
            }
        }
    })
};
Class("xui.Coder", null, {
    Initialize: function () {
        xui.CSS.addStyleSheet('.sh {font-family: "Courier New" , Courier, mono;font-size: 12px;border: 1px solid #92D1E4;background:#fff;}.sh .sh-con{padding-bottom:3px;background-color: #fff;}.sh .sh-cmd{padding: 3px 8px 3px 8px;font: 9px Verdana, Geneva, Arial, Helvetica, sans-serif;color: silver;border-bottom: 1px solid #EBEADB;}.sh .sh-cmd a{font-size: 12px;color: blue;text-decoration: none;margin-right: 10px;}.sh .sh-cmd a:hover{color: red;}.sh .cmd-ruler{width:25px;}.sh .sh-toggle{width:16px;cursor:pointer;font-size:14px;color:blue;vertical-align:baseline;}.sh ol{color: #FF97A9; margin: 0px 0px 0px 45px; padding: 0; border-bottom: 1px solid #EBEADB; }.sh ol li{color: #000157;border-left: 3px solid #6CE26C;padding-left: 10px;line-height: 14px;list-style: decimal none;margin:0;border-bottom: 1px dashed #E2E2E2;}.sh-con span{vertical-align:inherit;' + (xui.browser.ie ? "zoom:0;" : "") + "}.sh .js .comment, .sh .php .comment{ color: green; }.sh .js .string, .sh .php .string{ color: #ff1493; }.sh .js .reg, .sh .php .reg{ color: #ff1493; }.sh .js .number,.sh .php .number { color: darkred; }.sh .js .keyword, .sh .php .keyword{ color: blue; }.sh .js .keyword2, .sh .php .keyword2 { font-weight: bold; color: red; }.sh .js .special, .sh .php .special{ font-weight: bold; color: navy; }.sh .php .vars{color:#079BFA}.sh .css .comment { color: green; }.sh .css .string { color: red; }.sh .css .colors { color: darkred; }.sh .css .vars { color: #d00; }.sh .css .number { color: blue; }.sh .css .keyword {color:teal;}.sh .css .selector {font-weight: bold; color: navy;}.sh .html .comment { color: green; }.sh .html .string{ color: #ff1493; }.sh .html .script{ color: #ff1493; }.sh .html .attr { color: blue; }.sh .html .speical{color:#079BFA}.sh .html .tag { font-weight: bold; color: navy; }", this.KEY);
        this._profiles = {
            js: {
                multicomment: this.$COM_REG.BLOCK_COMMENT,
                comment: this.$COM_REG.LINE_COMMENT,
                reg: this.$COM_REG.REG,
                string1: this.$COM_REG.DQ_STRING,
                string2: this.$COM_REG.SQ_STRING,
                number: this.$COM_REG.NUMBER,
                keyword: "try|throw|catch|finally|arguments|break|case|continue|default|delete|do|else|false|for|function|if|in|instanceof|new|null|return|switch|this|true|typeof|var|void|while|with|toString|valueOf|window|prototype|document|escape|unescape|parseInt|parseFloat|setTimeout|clearTimeout|setInterval|clearInterval|NaN|isNaN|Infinity|Error",
                keyword2: "exists|isNull|isObj|isEmpty|isArr|isBool|isDate|isFun|isHash|isNumb|isStr|_.arr|_.bool|_.cls|_.date|_.fun|_.hash|_.numb|_.str|_.id|_|alias|host|append|toArr|breakO|tryF|each|copy|clone|filter|asyRun|resetRun|merge|each|swap|removeFrom|filter|indexOf|clean|insertAny|serialize|unserialize|Class|Instance|Initialize|Before|After|Static|Constructor|reBoxing|copy|clone|left|top|right|bottom|startWith|endWith|initial|trim|ltrim|rtrim|blen|toDom|create",
                special: /xui[\w\.]*|(\bon|before|after|set|get)[A-Z]\w*/
            },
            css: {
                multicomment: this.$COM_REG.BLOCK_COMMENT,
                string: [this.$COM_REG.DQ_STRING, this.$COM_REG.SQ_STRING],
                IGNORE: /\([^'")]*\)/,
                keyword: [/@\w[\w.\s]*/, /attr|rect|rgb|url/],
                selector: /[\w-:\[.#][^{};]*\{/,
                colors: /\#[a-zA-Z0-9]{3,6}/,
                number: [/(\d*\.?\d+|\d+\.?\d*)(cm|em|ex|pt|px|%|\:)?/],
                vars: [/(-[\w-]+)\s*[ ]*:/, /([\w-]+)\s*[ ]*:/]
            },
            php: {
                multicomment: this.$COM_REG.BLOCK_COMMENT,
                comment: this.$COM_REG.LINE_COMMENT,
                reg: this.$COM_REG.REG,
                string: [this.$COM_REG.DQ_STRING, this.$COM_REG.SQ_STRING],
                number: this.$COM_REG.NUMBER,
                keyword: "abs|acos|acosh|addcslashes|addslashes|array_change_key_case|array_chunk|array_combine|array_count_values|array_diff|array_diff_assoc|array_diff_key|array_diff_uassoc|array_diff_ukey|array_fill|array_filter|array_flip|array_intersect|array_intersect_assoc|array_intersect_key|array_intersect_uassoc|array_intersect_ukey|array_key_exists|array_keys|array_map|array_merge|array_merge_recursive|array_multisort|array_pad|array_pop|array_product|array_push|array_rand|array_reduce|array_reverse|array_search|array_shift|array_slice|array_splice|array_sum|array_udiff|array_udiff_assoc|array_udiff_uassoc|array_uintersect|array_uintersect_assoc|array_uintersect_uassoc|array_unique|array_unshift|array_values|array_walk|array_walk_recursive|atan|atan2|atanh|base64_decode|base64_encode|base_convert|basename|bcadd|bccomp|bcdiv|bcmod|bcmul|bindec|bindtextdomain|bzclose|bzcompress|bzdecompress|bzerrno|bzerror|bzerrstr|bzflush|bzopen|bzread|bzwrite|ceil|chdir|checkdate|checkdnsrr|chgrp|chmod|chop|chown|chr|chroot|chunk_split|class_exists|closedir|closelog|copy|cos|cosh|count|count_chars|date|decbin|dechex|decoct|deg2rad|delete|ebcdic2ascii|echo|empty|end|ereg|ereg_replace|eregi|eregi_replace|error_log|error_reporting|escapeshellarg|escapeshellcmd|eval|exec|exit|exp|explode|extension_loaded|feof|fflush|fgetc|fgetcsv|fgets|fgetss|file_exists|file_get_contents|file_put_contents|fileatime|filectime|filegroup|fileinode|filemtime|fileowner|fileperms|filesize|filetype|floatval|flock|floor|flush|fmod|fnmatch|fopen|fpassthru|fprintf|fputcsv|fputs|fread|fscanf|fseek|fsockopen|fstat|ftell|ftok|getallheaders|getcwd|getdate|getenv|gethostbyaddr|gethostbyname|gethostbynamel|getimagesize|getlastmod|getmxrr|getmygid|getmyinode|getmypid|getmyuid|getopt|getprotobyname|getprotobynumber|getrandmax|getrusage|getservbyname|getservbyport|gettext|gettimeofday|gettype|glob|gmdate|gmmktime|ini_alter|ini_get|ini_get_all|ini_restore|ini_set|interface_exists|intval|ip2long|is_a|is_array|is_bool|is_callable|is_dir|is_double|is_executable|is_file|is_finite|is_float|is_infinite|is_int|is_integer|is_link|is_long|is_nan|is_null|is_numeric|is_object|is_readable|is_real|is_resource|is_scalar|is_soap_fault|is_string|is_subclass_of|is_uploaded_file|is_writable|is_writeable|mkdir|mktime|nl2br|parse_ini_file|parse_str|parse_url|passthru|pathinfo|readlink|realpath|rewind|rewinddir|rmdir|round|str_ireplace|str_pad|str_repeat|str_replace|str_rot13|str_shuffle|str_split|str_word_count|strcasecmp|strchr|strcmp|strcoll|strcspn|strftime|strip_tags|stripcslashes|stripos|stripslashes|stristr|strlen|strnatcasecmp|strnatcmp|strncasecmp|strncmp|strpbrk|strpos|strptime|strrchr|strrev|strripos|strrpos|strspn|strstr|strtok|strtolower|strtotime|strtoupper|strtr|strval|substr|substr_compare",
                keyword2: "and|or|xor|__FILE__|__LINE__|array|as|break|case|cfunction|class|const|continue|declare|default|die|do|else|elseif|empty|enddeclare|endfor|endforeach|endif|endswitch|endwhile|extends|for|foreach|function|include|include_once|global|if|new|old_function|return|static|switch|use|require|require_once|var|while|__FUNCTION__|__CLASS__|__METHOD__|abstract|interface|public|implements|extends|private|protected|throw",
                vars: /\$\w+/
            },
            html: {
                multicomment: this.$COM_REG.HTML_COMMENT,
                tag: /\x02\/?\w+/,
                attr: /\w+=/,
                script: /(>([^<][^\/]*<+)*\/)(script|style)>/,
                special: /<!DOCTYPE[^>]+>/,
                string: [this.$COM_REG.DQ_STRING, this.$COM_REG.SQ_STRING]
            }
        }
    },
    Static: {
        $COM_REG: {
            HTML_COMMENT: /<!\s*(--([^-]|[\r\n]|-[^-])*--\s*)>/,
            BLOCK_COMMENT: /\/\*[^*]*\*+([^\/][^*]*\*+)*\//,
            LINE_COMMENT: /\/\/[^\n]*/,
            REG: /\/(\\[\/\\]|[^*\/])(\\.|[^\/\n\\])*\/[gim]*/,
            DQ_STRING: /"(\\.|[^"\\])*"/,
            SQ_STRING: /'(\\.|[^'\\])*'/,
            NUMBER: /-?(\d*\.?\d+|\d+\.?\d*)([eE][+-]?\d+|%)?\b/
        },
        isSafeJSON: function (s) {
            return "" === this.replace(s, [
                [this.$COM_REG.BLOCK_COMMENT, ""],
                [/\\["\\\/bfnrtu]/, ""],
                [this.$COM_REG.LINE_COMMENT, ""],
                [this.$COM_REG.DQ_STRING, ""],
                [this.$COM_REG.SQ_STRING, ""],
                [this.$COM_REG.REG, ""],
                [this.$COM_REG.NUMBER, ""],
                [/true|false|null|undefined/, ""],
                [/[\s\u2028\u2029]/, ""],
                [/[^{,]+:/, ""],
                [/[\[\]\{\}\,]/, ""]
            ])
        },
        replace: function (str, reg, replace, ignore_case) {
            var i, len, _t, m, n, flag, a1 = [],
                a2 = [],
                me = arguments.callee,
                reg1 = me.reg1 || (me.reg1 = /\\./g),
                reg2 = me.reg2 || (me.reg2 = /\(/g),
                reg3 = me.reg3 || (me.reg3 = /\$\d/),
                reg4 = me.reg4 || (me.reg4 = /^\$\d+$/),
                reg5 = me.reg5 || (me.reg5 = /'/),
                reg6 = me.reg6 || (me.reg6 = /\\./g),
                reg11 = me.reg11 || (me.reg11 = /(['"])\1\+(.*)\+\1\1$/);
            if (!_.isArr(reg)) {
                reg = [reg, replace]
            } else {
                ignore_case = replace
            }
            if (!_.isArr(reg[0])) {
                reg = [reg]
            }
            _.arr.each(reg, function (o) {
                m = typeof o[0] == "string" ? o[0] : o[0].source;
                n = o[1] || "";
                len = ((m).replace(reg1, "").match(reg2) || "").length;
                if (typeof n != "function") {
                    if (reg3.test(n)) {
                        if (reg4.test(n)) {
                            _t = parseInt(n.slice(1), 10);
                            if (_t <= len) {
                                n = _t
                            }
                        } else {
                            flag = reg5.test(n.replace(reg6, "")) ? '"' : "'";
                            i = len;
                            while (i + 1) {
                                n = n.split("$" + i).join(flag + "+a[o+" + i--+"]+" + flag)
                            }
                            n = new Function("a,o", "return" + flag + n.replace(reg11, "$1") + flag)
                        }
                    }
                }
                a1.push(m || "^$");
                a2.push([n, len, typeof n])
            });
            return str.replace(new RegExp("(" + a1.join(")|(") + ")", ignore_case ? "gim" : "gm"), function () {
                var i = 1,
                    j = 0,
                    args = arguments,
                    p, t;
                if (!args[0]) {
                    return ""
                }
                while (p = a2[j++]) {
                    if (t = args[i]) {
                        switch (p[2]) {
                        case "function":
                            return p[0](args, i, j - 1);
                        case "number":
                            return args[p[0] + i];
                        default:
                            return p[0]
                        }
                    } else {
                        i += p[1] + 1
                    }
                }
            })
        },
        formatText: function (code, type, reverse) {
            var reg, pre_arr, add_arr, arr = [];
            var deep = 0,
                i, l = 20,
                sf = function (i) {
                    var r = "";
                    while (i--) {
                        r += " "
                    }
                    return r
                },
                space = [""];
            for (i = 1; i < l; i++) {
                space.push(sf(i * 4))
            }
            code = code.replace(/(\r\n|\r)/g, "\n");
            if (type == "html") {
                arr.push([/[\s]*(<[\w]+[^>]+>)[\s]*/, "$1"]);
                arr.push([/[\s]*(<\/[\w]+>)[\s]*/, "$1"]);
                code = this.replace(code, arr);
                arr.length = 0;
                arr.push([this.$COM_REG.HTML_COMMENT, "$0\\n"]);
                arr.push([/<!\[CDATA\[(([^\]])|(\][^\]])|(\]\][^>]))*\]\]>/, function (a, i) {
                    return space[deep] + a[i] + "\n"
                }]);
                arr.push([/<input[^>]+>/, function (a, i) {
                    return space[deep] + a[i] + "\n"
                }]);
                arr.push([/<img[^>]+>/, function (a, i) {
                    return space[deep] + a[i] + "\n"
                }]);
                arr.push([/<[\w]+[^>]*\/>/, function (a, i) {
                    return space[deep] + a[i] + "\n"
                }]);
                arr.push([/[^<]+/, function (a, i) {
                    return space[deep] + a[i] + "\n"
                }]);
                arr.push([/<[\w]+[^>]*>/, function (a, i) {
                    return space[deep++] + a[i] + "\n"
                }]);
                arr.push([/<\/[\w]+>/, function (a, i) {
                    return space[--deep] + a[i] + "\n"
                }]);
                code = this.replace(code, arr, true)
            } else {
                var arr = [],
                    index1 = 1,
                    index2 = 1,
                    index3 = 1,
                    index4 = 1,
                    index5 = 1,
                    index6 = 1,
                    index7 = 1,
                    cache = {
                        a: {},
                        b: {},
                        c: {},
                        d: {},
                        e: {},
                        f: {},
                        g: {}
                    };
                reg = this.$COM_REG;
                code = code.replace(/\\\r?\n/g, "");
                code = code.replace(/([\x01\x02\x03\x04])/g, "$1-");
                code = xui.Coder.replace(code, [
                    [reg.BLOCK_COMMENT.source, reverse ? "" : function (s, i) {
                        var ret = "\x01d" + index4+++"\x02";
                        cache.d[ret] = s[i];
                        return ret
                    }],
                    [reg.LINE_COMMENT.source, reverse ? "" : function (s, i) {
                        var ret = "\x01e" + index5+++"\x02";
                        cache.e[ret] = s[i];
                        return ret
                    }],
                    [/\/\*@|@\*\/|\/\/@[^\n]*\n/.source, function (s, i) {
                        var ret = "\x01c" + index3+++"\x02";
                        cache.c[ret] = s[i];
                        return ret
                    }],
                    [reg.SQ_STRING.source, function (s, i) {
                        var ret = "\x03a" + index1+++"\x04";
                        cache.a[ret] = s[i];
                        return ret
                    }],
                    [reg.DQ_STRING.source, function (s, i) {
                        var ret = "\x03b" + index2+++"\x04";
                        cache.b[ret] = s[i];
                        return ret
                    }],
                    [reg.REG.source, function (s, i) {
                        var ret = "\x03f" + index6+++"\x04";
                        cache.f[ret] = s[i];
                        return ret
                    }],
                    [/function\s*\([^)]*\)/.source, function (s, i) {
                        var ret = "\x03g" + index7+++"\x04";
                        cache.g[ret] = s[i];
                        return ret
                    }]
                ]);
                arr = [
                    ["([+-])\\s+([+-])", "$1 $2"],
                    ["\\b[\\s]+\\b", " "],
                    ["[\\s]+", ""]
                ];
                if (type == "css") {
                    _.arr.insertAny(arr, [/\s+(\.)/.source, " $1"], 2, true);
                    _.arr.insertAny(arr, [/(\d*\.?\d+|\d+\.?\d*)(cm|em|ex|pt|px|%|\:)?/, " $0 "], -1, true)
                }
                code = xui.Coder.replace(code, arr);
                if (!reverse) {
                    arr = [
                        [/[\{]/.source, function (a, i) {
                            return a[i] + "\n" + space[++deep]
                        }],
                        [/[\x02\;]/.source, function (a, i) {
                            return a[i] + "\n" + space[deep]
                        }],
                        [/(\,)([\x03\x04\w_\-]+\:)/.source, function (a, i) {
                            return a[i + 1] + "\n" + space[deep] + a[i + 2]
                        }],
                        [/\x01/.source, function (a, i) {
                            return "\n" + space[deep] + a[i]
                        }],
                        [/[\}]\s*[\,\;]*/.source, function (a, i) {
                            return "\n" + space[--deep] + a[i] + "\n" + space[deep]
                        }]
                    ];
                    if (type != "css") {
                        arr.push([/for\s*\([\w ]+\sin\s/.source, "$0"], [/for\s*\(([^;]*);([^;]*);([^)]*)\)/.source, "for($1; $2; $3)"], [/(,)(("[^"\n\r]*"|'[^'\n\r]*'|\w+)?(:|=>))/.source, function (a, i) {
                            return a[i + 1] + "\n" + space[deep] + a[i + 2]
                        }], [/\b(case|default)\b[^:]+:/.source, function (a, i) {
                            return a[i] + "\n" + space[deep]
                        }])
                    }
                    code = xui.Coder.replace(code, arr);
                    code = xui.Coder.replace(code, [
                        [/ *[\n\r]/.source, "\n"],
                        [/\{\s+\}/.source, "{}"],
                        [/\}\n *(else|catch|finnally)/.source, "}$1"],
                        [reg.NUMBER, "$0"],
                        [/(\/\/)|(\/\*)|(\*\/)/.source, "$0"],
                        [/\s*((\+\+|\-\-|\&\&|\|\||!!)|([=!]==)|((<<|>>>|>>)=?)|([\+\-\*\/\%\&|^<>!=~]=?)|([?:]))\s*/.source, " $1 "]
                    ])
                }
                code = xui.Coder.replace(code, [
                    [/[\n\r]+/.source, "\n"],
                    [/( *)(\x01[d]\d+\x02)/.source, function (s, i) {
                        s[i + 1] = s[i + 1] || "";
                        return s[i + 1] + cache.d[s[i + 2]].replace(/(\n)(\s*)/g, "$1" + s[i + 1])
                    }],
                    [/\x03[g]\d+\x04/.source, function (s, i) {
                        return cache.g[s[i]].replace(/\s*,\s*/g, "," + (reverse ? "" : " "))
                    }],
                    [/[\x01\x03]([\w])\d+[\x02\x04]/.source, function (s, i) {
                        return cache[s[i + 1]][s[i]]
                    }],
                    [/\}\s*([\)\]])/.source, "}$1"]
                ]);
                code = code.replace(/([\x01\x02\x03\x04])-/g, "$1")
            }
            return code
        },
        $xid: 1,
        formatHTML: function (code, type, arrActions, fold, id, height) {
            if (!id) {
                id = "" + this.$xid++
            }
            var _key = this.$key,
                _str = code,
                _this = this,
                _encode = function (str) {
                    return str.replace(/\x02|\x03/g, function (a) {
                        return a == "\x02" ? "&lt;" : "&amp;"
                    })
                },
                _decode = function (str) {
                    return str.replace(/<|\&/g, function (a) {
                        return a == "<" ? "\x02" : "\x03"
                    })
                };
            code = code.replace(/^\s*(.*)\s*$/g, "$1");
            code = _decode(code);
            var a, _t;
            if (!this._profiles[type]) {
                type = "js"
            }
            a = _.copy(this._profiles[type]);
            code = this.replace(code, [
                [/(\r\n|\r)/g, "\n"],
                [/( +)(\n)/g, "$2"],
                [/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;"],
                [/ /g, "&nbsp;"]
            ]);
            var arr = [];
            var f = function (o, s, r) {
                    if (o) {
                        if (!_.isArr(o)) {
                            o = [o]
                        }
                        _.arr.each(o, function (o) {
                            if (typeof o == "string") {
                                o = "\\b(" + o + ")\\b"
                            }
                            arr.push([o, r ? r : "<span class='" + s + "'>$0</span>"])
                        })
                    }
                };
            if (_t = a.multicomment) {
                f(_t, "multicomment", function (a, i) {
                    return "<span class='comment'>" + a[i].split("\n").join("</span>\n<span class='comment'>") + "</span>"
                });
                delete a.multicomment
            }
            if (_t = a.comment) {
                f(_t, "comment", function (a, i) {
                    return "<span class='comment'>" + a[i].replace("\n", "") + "</span>"
                });
                delete a.comment
            }
            if (_t = a.IGNORE) {
                f(_t, "IGNORE", "$0");
                delete a.IGNORE
            }
            if (a.reg) {
                (function (o, s) {
                    if (o) {
                        if (!_.isArr(o)) {
                            o = [o]
                        }
                        _.arr.each(o, function (o) {
                            if (typeof o == "string") {
                                o = "\\b(" + o + ")\\b"
                            }
                            arr.push([o, "<span class='" + s + "'>$0</span>"])
                        })
                    }
                })(a.reg, "reg");
                delete a.reg
            }
            _.arr.each(["string1", "string2", "number"], function (s) {
                if (a[s]) {
                    f(a[s], s);
                    delete a[s]
                }
            });
            _.each(a, function (o, i) {
                f(o, i)
            });
            code = this.replace(code, arr);
            code = _encode(code);
            var strR = "";
            var alist = code.split("\n");
            if (alist[0] == "") {
                alist.shift()
            }
            if (alist[alist.length - 1] == "") {
                alist.pop()
            }
            var aa = [];
            aa.push("<div id='" + _key + ":" + id + ":' class='sh'>");
            if (arrActions && arrActions[0]) {
                aa.push("<div id='" + _key + "-sh-cmd:" + id + ":' class='sh-cmd'>");
                aa.push("<span class='sh-toggle' href='javascript:;' onclick='xui.Coder._toggle(this);'>" + (fold ? " + " : " - ") + "</span> <span class='cmd-ruler'></span>");
                _.arr.each(arrActions, function (s) {
                    aa.push("<a id='" + _key + "-" + s + ":" + id + ":' href='javascript:;' onclick='xui.Coder._action(this,\"" + s + "\",arguments[0]);'>" + s + "</a>")
                });
                aa.push("<span>" + type + " source code viewer, powered by <a href='http://www.crossui.com' target='_blank' style='font-size:9px;color:#000157;'>CrossUI</a></span>");
                aa.push("</div>")
            }
            aa.push("<pre style='display:none'>");
            aa.push(_str.replace(/<([\w\/])/g, "&lt;$1"));
            aa.push("</pre>");
            aa.push("<div id='" + _key + "-sh-con:" + id + ":'class='sh-con' style='" + (height ? "overflow:auto;height:" + height + "px;'" : "") + (fold ? "display:none;" : "") + ";'><ol id='" + _key + "-ol:" + id + ":' start='1' class='" + type + "'><li>");
            aa.push(alist.join("&nbsp;</li><li>"));
            aa.push("</li></ol></div>");
            aa.push("</div>");
            _encode = _decode = null;
            _.asyRun(function () {
                xui.Coder._remedy(id)
            });
            return aa.join("")
        },
        formatAll: function (code, type, arrActions, fold, id, height) {
            var arr = _.toArr(arguments);
            arr[0] = this.formatText.call(this, code, type);
            return this.formatHTML.apply(this, arr)
        },
        applyById: function (id, formatAll) {
            var i = 0,
                self = this,
                fun = function () {
                    if (xui.Dom.byId(id)) {
                        var _t, o, cls;
                        i++;
                        _t = xui(id);
                        cls = (_t.get(0).className || "").split(/\s+/g);
                        o = _.str.toDom(xui.Coder[formatAll ? "formatAll" : "formatHTML"](_t.text(), cls[0], cls[1] && cls[1].split("-"), cls[2], id + ":" + i));
                        o.setSelectable(true);
                        _t.replace(o)
                    } else {
                        return false
                    }
                };
            xui.Thread.repeat(fun)
        },
        _remedy: function (id) {
            var _t = this.$key + ":" + id + ":";
            if (!(_t = xui(_t)).isEmpty()) {
                var p = _t.parent(),
                    w = p.scrollWidth(),
                    w2 = p.width();
                p.css("positoin", "relative");
                if (w > w2) {
                    _t.width(w)
                }
            }
        },
        $action: {
            run: function (o, e) {
                var code = xui(o).parent().next().text(),
                    fun = new Function([], code);
                fun.call(xui(o).parent(2), e)
            },
            plain: function (o) {
                var code = xui(o).parent().next().text();
                var code = code.replace(/</g, "&lt;");
                var wnd = window.open("", "_blank", "width=750, height=400, location=0, resizable=1, menubar=0, scrollbars=1");
                wnd.document.write('<pre style="width:100%;height:100%;border:none;">' + code + "</pre>");
                wnd.document.close();
                wnd = null
            }
        },
        _action: function (o, key, e) {
            if (this.$action[key]) {
                this.$action[key](o, e || window.event)
            }
        },
        _toggle: function (node) {
            var s = node.parentNode.nextSibling.nextSibling.style;
            if (s.display == "none") {
                s.display = "";
                node.innerHTML = "-"
            } else {
                s.display = "none";
                node.innerHTML = "+"
            }
            s = node = null
        }
    }
});
Class("xui.Tips", null, {
    Constructor: function () {
        return null
    },
    Initialize: function () {
        var dd = xui.DragDrop,
            tips = this;
        if (dd) {
            dd.$reset = function () {
                tips._pos = {
                    left: dd._profile.x,
                    top: dd._profile.y
                }
            }
        }
        xui.CSS.addStyleSheet(".xui-tips{font-size:0;line-height:0;position:absolute;overflow:visible;visibility:hidden;left:-10000px;} .xui-tips-i{font-size:12px;overflow:hidden;position:relative;}.xui-tips-i span{display:inline;}.xui-tips-c {border:solid gray 1px;background-color:#FFF8DC;padding:1px 2px 2px 2px;}", this.KEY);
        xui.doc.afterMousedown(function () {
            tips._cancel()
        }, "$Tips", -1).afterMousemove(function (obj, e) {
            if (dd.isWorking) {
                return
            }
            var event = xui.Event,
                p, n;
            if ((p = _.resetRun.$cache) && p["$Tips3"]) {
                tips._pos = event.getPos(e)
            }
            if (tips._from) {
                _.resetRun("$Tips3", null);
                tips._showF()
            } else {
                if (tips._showed && tips.MOVABLE) {
                    p = event.getPos(e);
                    n = tips._Node.style;
                    n.left = (parseInt(n.left, 10) || 0) + (p.left - tips._pos.left) + "px";
                    n.top = (parseInt(n.top, 10) || 0) + (p.top - tips._pos.top) + "px";
                    tips._pos = p;
                    n = null
                }
            }
        }, "$Tips", -1).afterMouseover(function (obj, e) {
            var event = xui.Event,
                rt = event.$FALSE,
                node = event.getSrc(e),
                id, _from, tempid, evid, index = 0,
                pass;
            if (!node) {
                return rt
            }
            try {
                while ((!node.id || node.id == xui.$localeDomId) && node.parentNode !== document && index++ < 10) {
                    node = node.parentNode
                }
                if (!(id = (typeof node.id == "string" ? node.id : null))) {
                    node = null;
                    return rt
                }
            } catch (e) {}
            if ((_from = event._getProfile(id)) && _from.box && _from.KEY == "xui.UIProfile") {
                if (_from.properties.disableTips) {
                    node = null;
                    return false
                }
                tempid = _from.onShowTips ? id : id.replace(tips._reg, ":");
                if (tips._markId && tempid == tips._markId) {
                    return rt
                }
                tips._markId = tempid;
                tips._pos = event.getPos(e);
                if (tips._showed) {
                    tips._from = _from;
                    tips._enode = id;
                    tips._showF()
                } else {
                    _.resetRun("$Tips", function () {
                        tips._from = _from;
                        tips._enode = id;
                        _.resetRun("$Tips3", function () {
                            if (tips._from) {
                                tips._showF()
                            }
                        }, 100)
                    }, tips.DELAYTIME)
                }
            } else {
                tips._cancel()
            }
            node = null;
            return rt
        }, "$Tips", -1).afterMouseout(function (obj, e) {
            if (tips._markId) {
                var event = xui.Event,
                    id, tempid, evid, _from = tips._from,
                    clear, index = 0,
                    node = e.toElement || e.relatedTarget;
                if (!node) {
                    clear = 1
                } else {
                    try {
                        while ((!node.id || node.id == xui.$localeDomId) && node.parentNode !== document && index++ < 10) {
                            node = node.parentNode
                        }
                        if (!(id = (typeof node.id == "string" ? node.id : null))) {
                            node = null;
                            clear = 1
                        }
                    } catch (e) {
                        clear = 1
                    }
                }
                if (clear) {
                    tips._cancel()
                } else {
                    tempid = (_from && _from.onShowTips) ? id : id.replace(tips._reg, ":")
                }
                node = null;
                return event.$FALSE
            }
        }, "$Tips", -1);
        this._Types = {
            "default": new function () {
                this._r = /(\$)([\w\.]+)/g;
                this.show = function (item, pos, key) {
                    if (!pos) {
                        return
                    }
                    var self = this,
                        node, _ruler, s, w, h;
                    if (!(node = self.node) || !node.get(0)) {
                        node = self.node = xui.create('<div class="xui-node xui-node-div xui-tips"><div class="xui-node xui-wrapper xui-node-div xui-tips-i"></div></div>');
                        _ruler = self._ruler = xui.create('<div class="xui-node xui-wrapper xui-node-div xui-tips"><div class="xui-node xui-node-div xui-tips-i"></div></div>');
                        self.n = node.first();
                        self._n = _ruler.first();
                        if (xui.Dom.css3Support("boxShadow")) {
                            node.css("boxShadow", "4px 4px 4px #888");
                            _ruler.css("boxShadow", "4px 4px 4px #888")
                        } else {
                            if (typeof node.addShadow == "function") {
                                node.addShadow();
                                _ruler.addShadow()
                            }
                        }
                        xui("body").append(_ruler)
                    }
                    _ruler = self._ruler;
                    if (document.body.lastChild != node.get(0)) {
                        xui("body").append(node, false, true)
                    }
                    s = typeof item == "object" ? item[key || xui.Tips.TIPSKEY] : item;
                    if (typeof s == "function") {
                        s = s()
                    }
                    if (s += "") {
                        var html = /^\s*\</.test(s);
                        s = s.replace(self._r, function (a, b, c) {
                            return xui.getRes(c)
                        });
                        xui.Tips._curTips = s;
                        if (!item.transTips || !html) {
                            s = '<div class="xui-node xui-node-div xui-tips-c">' + s + "</div>"
                        }
                        self._n.get(0).innerHTML = s;
                        w = _ruler.get(0).offsetWidth;
                        if (!html) {
                            w = Math.min(tips.MAXWIDTH, w)
                        }
                        var style = node.get(0).style,
                            t1 = self.n.get(0),
                            styleI = t1.style;
                        style.visibility = "hidden";
                        t1.innerHTML = s;
                        if (xui.browser.ie) {
                            style.width = styleI.width = w + (w % 2) + "px";
                            h = t1.offsetHeight;
                            style.height = h - (h % 2) + "px"
                        } else {
                            styleI.width = w + "px"
                        }
                        if (pos === true) {
                            style.visibility = "visible"
                        } else {
                            node.popToTop({
                                left: pos.left,
                                top: pos.top,
                                region: {
                                    left: pos.left,
                                    top: pos.top - 12,
                                    width: 24,
                                    height: 32
                                }
                            }, 1)
                        }
                        style = styleI = t1 = null
                    } else {
                        node.css("zIndex", 0).hide()
                    }
                };
                this.hide = function () {
                    this.node.css("zIndex", 0).hide()
                }
            }
        }
    },
    Static: {
        _reg: /-[\w]+:/,
        TIPSKEY: "tips",
        MAXWIDTH: 300,
        MOVABLE: true,
        DELAYTIME: 200,
        AUTOHIDETIME: 5000,
        _showF: function () {
            var self = this,
                _from = self._from,
                node = xui.Dom.byId(self._enode),
                pos = self._pos,
                id, o, t, b = false;
            self._from = self._enode = null;
            if (!node || !_from || !pos || !(o = _from.box)) {
                return
            }
            self._pos = pos;
            b = ((t = _from.CF) && (t = t.showTips) && t(_from, node, pos));
            if (!b) {
                b = (o._showTips && o._showTips(_from, node, pos))
            }
            if (!b && ((t = _from) && t.tips) || (t && (t = t.properties) && (t.tips))) {
                self.show(pos, t);
                b = true
            }
            if (!b) {
                self.hide()
            } else {
                if (!self.MOVABLE) {
                    _.resetRun("$Tips2", self.hide, self.AUTOHIDETIME, null, self)
                }
            }
            node = pos = _from = null
        },
        getTips: function () {
            return this._curTips
        },
        setTips: function (s) {
            if (this._curTips && this._tpl && this._Node) {
                this._tpl.show(s, true)
            }
        },
        setPos: function (left, top) {
            var n = this;
            if ((n = n._Node) && (n = n.style)) {
                if (left || left === 0) {
                    n.left = parseFloat(left) + "px"
                }
                if (top || top === 0) {
                    n.top = parseFloat(top) + "px"
                }
            }
        },
        show: function (pos, item, key) {
            var self = this,
                t;
            self._pos = pos;
            if (self._item === item) {
                return
            }
            if (typeof item == "string" || (item && (item[key || xui.Tips.TIPSKEY]))) {
                t = self._tpl = self._Types[item.tipsTemplate] || self._Types["default"];
                t.show(item, pos, key);
                self._Node = t.node.get(0);
                self._item = item;
                self._showed = true
            } else {
                self._cancel()
            }
        },
        hide: function () {
            var self = this;
            if (self._showed) {
                if (self._tpl) {
                    self._tpl.hide()
                }
                self._clear()
            }
        },
        _cancel: function () {
            var self = this;
            if (self._markId) {
                if (self._showed) {
                    self.hide()
                } else {
                    _.resetRun("$Tips", null);
                    _.resetRun("$Tips3", null);
                    self._clear()
                }
            }
        },
        _clear: function () {
            var self = this;
            self._Node = self._curTips = self._markId = self._from = self._tpl = self._item = self._showed = null
        }
    }
});
Class("xui.UI.Border", "xui.UI", {
    Instance: {
        _attachTo: function (target, eventTrigger) {
            var self = this,
                v = self.get(0),
                t;
            target.append(self);
            v.$edgeId = xui(target).id();
            v.$tieId = eventTrigger;
            v.$attached = true;
            if (t = v.properties) {
                if (v.properties.borderActive) {
                    var tag = "tag",
                        n = v.domId;
                    if (xui(eventTrigger).get(0)) {
                        xui(eventTrigger).afterMouseover(function (p, e) {
                            if (p.properties.disabled) {
                                return
                            }
                            var profile = xui.$cache.profileMap[n];
                            _.tryF(profile.behavior.TAG.afterMouseover, [profile, e, profile.getRootNode()], this)
                        }, tag).afterMouseout(function (p, e) {
                            if (p.properties.disabled) {
                                return
                            }
                            var profile = xui.$cache.profileMap[n];
                            _.tryF(profile.behavior.TAG.afterMouseout, [profile, e, profile.getRootNode()], this)
                        }, tag).afterMousedown(function (p, e) {
                            if (p.properties.disabled) {
                                return
                            }
                            var profile = xui.$cache.profileMap[n];
                            _.tryF(profile.behavior.TAG.afterMousedown, [profile, e, profile.getRootNode()], this)
                        }, tag).afterMouseup(function (p, e) {
                            if (p.properties.disabled) {
                                return
                            }
                            var profile = xui.$cache.profileMap[n];
                            _.tryF(profile.behavior.TAG.afterMouseup, [profile, e, profile.getRootNode()], this)
                        }, tag)
                    }
                }
            }
            return target
        },
        _detach: function () {
            var self = this,
                v = self.get(0),
                n, t, nl = null,
                tag = "tag";
            delete v.$attached;
            if (n = v.$tieId) {
                if (n = xui.Dom.byId(n)) {
                    xui(n).afterMouseover(nl, tag).afterMouseout(nl, tag).afterMousedown(nl, tag).afterMouseup(nl, tag)
                }
            }
            return self
        }
    },
    Initialize: function () {
        _.each({
            addBorder: function (properties) {
                var target = xui([this.get(0)]),
                    eventTrigger = arguments[1] || target.id();
                return new xui.UI.Border(properties)._attachTo(target, eventTrigger)
            },
            $getBorder: function () {
                var s = this.id(),
                    b;
                _.arr.each(xui.UI.Border._cache, function (o) {
                    if (o.$edgeId == s) {
                        b = o;
                        return false
                    }
                });
                return b && b.boxing()
            },
            removeBorder: function () {
                var s = this.id();
                _.arr.each(xui.UI.Border._cache, function (o) {
                    if (o.$edgeId == s) {
                        o.boxing()._detach().destroy()
                    }
                });
                return this
            }
        }, function (o, i) {
            xui.Dom.plugIn(i, o)
        });
        _.each({
            _border: function (properties, flag) {
                return this.each(function (o) {
                    var t = o.properties,
                        target = o.getSubNode(t._customBorder || "BORDER"),
                        k;
                    if (!properties) {
                        properties = {}
                    }
                    if (t._customBorder) {
                        k = (properties._bkey = o.getClass("KEY"))
                    } else {
                        k = "xui-border"
                    }
                    var key = "setting-" + k,
                        sk;
                    sk = "borderLeftWidth";
                    t.$b_lw = xui.UI.$getCSSValue(key, sk);
                    sk = "borderRightWidth";
                    t.$b_rw = xui.UI.$getCSSValue(key, sk);
                    sk = "borderTopWidth";
                    t.$b_tw = xui.UI.$getCSSValue(key, sk);
                    sk = "borderBottomWidth";
                    t.$b_bw = xui.UI.$getCSSValue(key, sk);
                    if (flag !== false) {
                        if (target.$getBorder()) {
                            return
                        }
                        o.$border = target.addBorder(properties);
                        o.clearCache().boxing().reLayout()
                    }
                })
            },
            _unBorder: function () {
                return this.each(function (o) {
                    var target = o.getSubNode("BORDER"),
                        t = o.properties;
                    if (!target.$getBorder()) {
                        return
                    }
                    target.removeBorder();
                    delete o.$border;
                    delete t.$b_lw;
                    delete t.$b_rw;
                    delete t.$b_tw;
                    delete t.$b_bw;
                    o.clearCache().boxing().reLayout()
                })
            }
        }, function (o, i) {
            xui.UI.Widget.plugIn(i, o)
        });
        xui.UI.Widget.setDataModel({
            border: {
                ini: false,
                action: function (v) {
                    var b = this.boxing();
                    if (v) {
                        b._border()
                    } else {
                        b._unBorder()
                    }
                }
            }
        })
    },
    Static: {
        Templates: {
            tagName: "div",
            TAG: {},
            T: {
                className: "{cls_t}"
            },
            RT: {
                className: "{cls_rt}",
                $order: 1
            },
            R: {
                className: "{cls_r}"
            },
            RB: {
                className: "{cls_rb}",
                $order: 1
            },
            B: {
                className: "{cls_b}"
            },
            LB: {
                className: "{cls_lb}",
                $order: 1
            },
            L: {
                className: "{cls_l}"
            },
            LT: {
                className: "{cls_lt}",
                $order: 1
            }
        },
        Appearances: {
            KEY: {
                width: 0,
                height: 0,
                display: xui.browser.ie6 ? "inline" : null,
                "font-size": 0,
                "line-height": 0
            },
            "TAG,T, RT, R, RB, B, LB, L, LT": {
                position: "absolute",
                display: "block",
                "font-size": 0,
                "line-height": 0
            },
            ".setting-xui-border": {
                "border-style": "solid",
                "border-top-width": "1px",
                "border-bottom-width": "1px",
                "border-left-width": "1px",
                "border-right-width": "1px"
            },
            T: {
                width: "100%",
                left: 0,
                top: "-1px",
                height: "3px",
                background: xui.UI.$bg("vertical.gif", "repeat-x left top")
            },
            B: {
                width: "100%",
                left: 0,
                bottom: "-1px",
                height: "3px",
                background: xui.UI.$bg("vertical.gif", "repeat-x left bottom")
            },
            L: {
                height: "100%",
                top: 0,
                left: "-1px",
                width: "3px",
                background: xui.UI.$bg("horizontal.gif", "repeat-y left top")
            },
            R: {
                height: "100%",
                top: 0,
                right: "-1px",
                width: "3px",
                background: xui.UI.$bg("horizontal.gif", "repeat-y right top")
            },
            LT: {
                top: "-1px",
                left: "-1px",
                width: "3px",
                height: "3px",
                background: xui.UI.$bg("corner.gif", "no-repeat left top")
            },
            RT: {
                top: "-1px",
                right: "-1px",
                width: "3px",
                height: "3px",
                background: xui.UI.$bg("corner.gif", "no-repeat right top")
            },
            RB: {
                right: "-1px",
                bottom: "-1px",
                width: "3px",
                height: "3px",
                background: xui.UI.$bg("corner.gif", "no-repeat right bottom")
            },
            LB: {
                left: "-1px",
                bottom: "-1px",
                width: "3px",
                height: "3px",
                background: xui.UI.$bg("corner.gif", "no-repeat left bottom")
            }
        },
        Behaviors: {
            HoverEffected: {
                TAG: "KEY"
            },
            ClickEffected: {
                TAG: "KEY"
            }
        },
        DataModel: {
            _bkey: "",
            borderActive: false
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile),
                pk = profile.properties._bkey;
            data.cls_t = pk ? pk + "-b-t" : "";
            data.cls_rt = pk ? pk + "-b-rt" : "";
            data.cls_r = pk ? pk + "-b-r" : "";
            data.cls_rb = pk ? pk + "-b-rb" : "";
            data.cls_b = pk ? pk + "-b-b" : "";
            data.cls_lb = pk ? pk + "-b-lb" : "";
            data.cls_l = pk ? pk + "-b-l" : "";
            data.cls_lt = pk ? pk + "-b-lt" : "";
            return data
        }
    }
});
Class("xui.UI.Shadow", "xui.UI", {
    Instance: {
        _attachTo: function (obj) {
            obj = obj.reBoxing();
            var self = this;
            self.get(0)._target = obj.get(0);
            obj.append(self);
            return obj
        }
    },
    Initialize: function () {
        _.each({
            addShadow: function (properties) {
                return new xui.UI.Shadow(properties)._attachTo(xui([this.get(0)]))
            },
            $getShadow: function () {
                var s = this.get(0),
                    b;
                _.arr.each(xui.UI.Shadow._cache, function (o) {
                    if (o._target == s) {
                        b = o;
                        return false
                    }
                });
                return b && b.boxing()
            },
            removeShadow: function () {
                var s = this.get();
                _.arr.each(xui.UI.Shadow._cache, function (o) {
                    if (o && o.renderId && o._target) {
                        if (_.arr.indexOf(s, xui(o._target).get(0)) != -1) {
                            o.boxing().destroy()
                        }
                    }
                });
                return this
            }
        }, function (o, i) {
            xui.Dom.plugIn(i, o)
        });
        _.each({
            _shadow: function (key) {
                return this.each(function (o) {
                    var target = o.getSubNode("BORDER");
                    if (target.$getShadow()) {
                        return
                    }
                    var d = o.properties;
                    o.$shadow = target.addShadow({
                        shadowSize: d._shadowSize
                    })
                })
            },
            _unShadow: function () {
                return this.each(function (o) {
                    var target = o.getSubNode("BORDER");
                    if (!target.$getShadow()) {
                        return
                    }
                    target.removeShadow();
                    delete o.$shadow
                })
            }
        }, function (o, i) {
            xui.UI.Widget.plugIn(i, o)
        });
        xui.UI.Widget.setDataModel({
            shadow: {
                ini: false,
                action: function (v) {
                    var b = this.boxing();
                    if (v) {
                        b._shadow()
                    } else {
                        b._unShadow()
                    }
                }
            },
            _shadowSize: this.SIZE
        })
    },
    Static: {
        SIZE: 8,
        Templates: {
            tagName: "div",
            R: {
                tagName: "div",
                style: "top:{shadowOffset}px;width:{shadowSize}px;right:-{pos}px;"
            },
            RB: {
                tagName: "div",
                style: "height:{rbsize}px;width:{rbsize}px;right:-{pos}px;bottom:-{pos}px;"
            },
            B: {
                tagName: "div",
                style: "left:{shadowOffset}px;height:{shadowSize}px;bottom:-{pos}px;"
            }
        },
        Appearances: {
            KEY: {
                width: 0,
                height: 0,
                display: xui.browser.ie6 ? "inline" : null,
                "font-size": xui.browser.ie6 ? 0 : null,
                "line-height": xui.browser.ie6 ? 0 : null
            },
            "B, RB, R": {
                position: "absolute",
                display: "block",
                "font-size": xui.browser.ie ? 0 : null,
                "line-height": xui.browser.ie ? 0 : null,
                "z-index": "-1"
            },
            B: {
                left: 0,
                width: "100%",
                background: xui.browser.ie6 ? "" : xui.UI.$bg("bottom.png", "repeat-x left bottom"),
                _filter: xui.UI.$ieBg("bottom.png")
            },
            RB: {
                background: xui.browser.ie6 ? "" : xui.UI.$bg("right_bottom.png", "left top"),
                _filter: xui.UI.$ieBg("right_bottom.png")
            },
            R: {
                top: 0,
                height: "100%",
                background: xui.browser.ie6 ? "" : xui.UI.$bg("right.png", "repeat-y right top"),
                _filter: xui.UI.$ieBg("right.png")
            }
        },
        DataModel: {
            shadowSize: {
                ini: 8,
                action: function (value) {
                    var self = this,
                        shadowOffset = self.properties.shadowOffset;
                    self.getSubNode("R").cssRegion({
                        width: value,
                        top: shadowOffset,
                        right: -value - shadowOffset
                    });
                    self.getSubNode("RB").cssRegion({
                        width: value,
                        height: value,
                        right: -value - shadowOffset + 1,
                        bottom: -value - shadowOffset + 1
                    });
                    self.getSubNode("B").cssRegion({
                        height: value,
                        left: shadowOffset,
                        bottom: -value - shadowOffset
                    })
                }
            },
            shadowOffset: {
                ini: 0,
                action: function (value) {
                    this.boxing().setShadowSize(this.properties.shadowSize, true)
                }
            }
        },
        _prepareData: function (profile) {
            var t = arguments.callee.upper.call(this, profile);
            t.pos = (parseInt(t.shadowSize, 10) || 0) + (parseInt(t.shadowOffset, 10) || 0);
            t.rbsize = t.shadowSize + 4;
            return t
        },
        LayoutTrigger: function () {
            if (xui.browser.ie) {
                this.getRoot().ieRemedy()
            }
        }
    }
});
Class("xui.UI.Resizer", "xui.UI", {
    Instance: {
        _attachTo: function (target, parent) {
            var self = this,
                v = self.get(0);
            v._target = xui(target);
            v._parent = parent || xui("body");
            v._parent.append(self);
            v.$resizeId = xui(target).id();
            return self
        },
        show: function () {
            var self = this;
            self.each(function (o) {
                o.getRoot().css("display", "")
            });
            if (xui.browser.ie) {
                self.reBoxing().ieRemedy()
            }
            return self
        },
        hide: function () {
            var self = this;
            self.reBoxing().css("display", "none");
            return self
        }
    },
    Initialize: function () {
        this.addTemplateKeys(["HANDLER", "HIDDEN", "MOVE", "CONF", "L", "R", "T", "B", "LT", "RT", "LB", "RB"]);
        _.each({
            addResizer: function (properties, onUpdate, onChange) {
                var target = xui([this.get(0)]);
                properties = properties || {};
                _.merge(properties, {
                    _attached: true
                });
                var r = new xui.UI.Resizer(properties)._attachTo(target, target);
                if (onUpdate) {
                    r.onUpdate(onUpdate)
                }
                if (onChange) {
                    r.onChange(onChange)
                }
                return r
            },
            removeResizer: function () {
                var s = this.id();
                _.arr.each(xui.UI.Resizer._cache, function (o) {
                    if (o.$resizeId == s) {
                        o.boxing().destroy()
                    }
                });
                return this
            },
            $getResizer: function () {
                var s = this.id(),
                    b;
                _.arr.each(xui.UI.Resizer._cache, function (o) {
                    if (o.$resizeId == s) {
                        b = o;
                        return false
                    }
                });
                return b && b.boxing()
            }
        }, function (o, i) {
            xui.Dom.plugIn(i, o)
        });
        _.each({
            _resizer: function (key, args) {
                return this.each(function (o) {
                    var target = o.getSubNode("BORDER"),
                        d = o.properties;
                    if (target.$getResizer()) {
                        return
                    }
                    args = args || {};
                    var update = function (pro, target, size, cssPos) {
                            var profile = arguments.callee.profile,
                                node = profile.getRoot(),
                                instance = profile.boxing(),
                                prop = profile.properties,
                                t;
                            if (size) {
                                var w = null,
                                    h = null,
                                    l = null,
                                    t = null;
                                if (t = size.width) {
                                    node.widthBy(t);
                                    prop.width = w = node.width()
                                }
                                if (t = size.height) {
                                    node.heightBy(t);
                                    prop.height = h = node.height()
                                }
                                xui.UI.$tryResize(profile, w, h, true);
                                if (!profile.box._onresize && profile.onResize && (w !== null || h !== null)) {
                                    instance.onResize(profile, w, h)
                                }
                            }
                            if (cssPos) {
                                if ((t = cssPos.left) && !(prop.left == "auto" && parseInt(prop.right, 10) >= 0)) {
                                    node.leftBy(t);
                                    prop.left = node.left()
                                }
                                if ((t = cssPos.top) && !(prop.top == "auto" && parseInt(prop.bottom, 10) >= 0)) {
                                    node.topBy(t);
                                    prop.top = node.top()
                                }
                                if (profile.onMove && (l !== null || t !== null)) {
                                    instance.onMove(profile, l, t, null, null)
                                }
                            }
                            return false
                        };
                    update.profile = o;
                    o.$resizer = target.addResizer(args, update);
                    o.$resizer.get(0).$parentUIProfile = o;
                    if (d.visibility == "hidden") {
                        o.$resizer.hide()
                    }
                })
            },
            _unResizer: function () {
                return this.each(function (o) {
                    var target = o.getSubNode("BORDER");
                    if (!target.$getResizer()) {
                        return
                    }
                    target.removeResizer();
                    delete o.$resizer
                })
            }
        }, function (o, i) {
            xui.UI.Widget.plugIn(i, o)
        });
        xui.UI.Widget.setDataModel({
            resizer: {
                ini: false,
                action: function (v) {
                    var b = this.boxing();
                    if (v) {
                        var t = this.properties,
                            arg = {};
                        _.each("minHeight,minWidth,maxHeight,maxWidth".split(","), function (i) {
                            if (i in t) {
                                arg[i] = t[i]
                            }
                        });
                        if (t.tagVar.resizerProp) {
                            _.merge(arg, t.tagVar.resizerProp, "all")
                        }
                        b._resizer(v, arg)
                    } else {
                        b._unResizer()
                    }
                }
            }
        })
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style};"
        },
        Appearances: {
            KEY: {
                position: "absolute",
                margin: "0 -1px -1px 0",
                visibility: "visible",
                "font-size": 0,
                "line-height": 0,
                "*background": "url(" + xui.ini.path + "bg.gif)",
                "z-index": 60,
                cursor: "move"
            },
            MOVE: {
                position: "absolute",
                display: "block",
                "z-index": 100,
                visibility: "visible",
                background: xui.UI.$bg("icons.gif", "no-repeat -17px -244px", true),
                "font-size": 0,
                "line-height": 0
            },
            CONF: {
                position: "absolute",
                display: "block",
                "z-index": 100,
                visibility: "visible",
                background: xui.UI.$bg("icons.gif", "no-repeat -90px -272px", true),
                "font-size": 0,
                "line-height": 0,
                cursor: "pointer"
            },
            HANDLER: {
                $order: 0,
                position: "absolute",
                display: "block",
                border: "solid 1px",
                "background-color": "#fff",
                "z-index": 100,
                visibility: "visible",
                "font-size": 0,
                "line-height": 0
            },
            T: {
                $order: 1,
                left: "50%",
                cursor: "n-resize"
            },
            RT: {
                $order: 1,
                cursor: "ne-resize",
                "z-index": 110
            },
            R: {
                $order: 1,
                top: "50%",
                cursor: "e-resize"
            },
            RB: {
                $order: 1,
                cursor: "se-resize",
                "z-index": 110
            },
            B: {
                $order: 1,
                left: "50%",
                cursor: "s-resize"
            },
            LB: {
                $order: 1,
                cursor: "sw-resize",
                "z-index": 110
            },
            L: {
                $order: 1,
                top: "50%",
                cursor: "w-resize"
            },
            LT: {
                $order: 1,
                cursor: "nw-resize",
                "z-index": 110
            },
            HIDDEN: {
                $order: 10,
                "background-color": "transparent",
                "border-width": 0
            }
        },
        Behaviors: {
            onMousedown: function (profile, e, src) {
                profile.box._onMousedown(profile, e, src, {
                    move: true
                })
            },
            onDragbegin: function (profile, e, src) {
                profile.box._onDragbegin(profile, e, src)
            },
            onDrag: function (profile, e, src) {
                profile.box._onDrag(profile, e, src, {
                    move: true
                })
            },
            onDragstop: function (profile, e, src) {
                profile.box._onDragstop(profile, e, src, {
                    move: true
                })
            },
            onDblclick: function (profile, e, src) {
                if (profile.onDblclick) {
                    profile.boxing().onDblclick(profile, e, src)
                }
            },
            CONF: {
                onMousedown: function (profile, e, src) {
                    return false
                },
                onClick: function (profile, e, src) {
                    if (profile.onConfig) {
                        profile.boxing().onConfig(profile, e, src)
                    }
                }
            },
            LT: {
                onMousedown: function (profile, e, src) {
                    profile.box._onMousedown(profile, e, src, {
                        left: true,
                        top: true
                    });
                    return false
                },
                onDragbegin: function (profile, e, src) {
                    profile.box._onDragbegin(profile, e, src)
                },
                onDrag: function (profile, e, src) {
                    profile.box._onDrag(profile, e, src, {
                        left: true,
                        top: true
                    })
                },
                onDragstop: function (profile, e, src) {
                    profile.box._onDragstop(profile, e, src, {
                        left: true,
                        top: true
                    })
                }
            },
            RT: {
                onMousedown: function (profile, e, src) {
                    profile.box._onMousedown(profile, e, src, {
                        right: true,
                        top: true
                    });
                    return false
                },
                onDragbegin: function (profile, e, src) {
                    profile.box._onDragbegin(profile, e, src)
                },
                onDrag: function (profile, e, src) {
                    profile.box._onDrag(profile, e, src, {
                        right: true,
                        top: true
                    })
                },
                onDragstop: function (profile, e, src) {
                    profile.box._onDragstop(profile, e, src, {
                        right: true,
                        top: true
                    })
                }
            },
            LB: {
                onMousedown: function (profile, e, src) {
                    profile.box._onMousedown(profile, e, src, {
                        left: true,
                        bottom: true
                    });
                    return false
                },
                onDragbegin: function (profile, e, src) {
                    profile.box._onDragbegin(profile, e, src)
                },
                onDrag: function (profile, e, src) {
                    profile.box._onDrag(profile, e, src, {
                        left: true,
                        bottom: true
                    })
                },
                onDragstop: function (profile, e, src) {
                    profile.box._onDragstop(profile, e, src, {
                        left: true,
                        bottom: true
                    })
                }
            },
            RB: {
                onMousedown: function (profile, e, src) {
                    profile.box._onMousedown(profile, e, src, {
                        right: true,
                        bottom: true
                    });
                    return false
                },
                onDragbegin: function (profile, e, src) {
                    profile.box._onDragbegin(profile, e, src)
                },
                onDrag: function (profile, e, src) {
                    profile.box._onDrag(profile, e, src, {
                        right: true,
                        bottom: true
                    })
                },
                onDragstop: function (profile, e, src) {
                    profile.box._onDragstop(profile, e, src, {
                        right: true,
                        bottom: true
                    })
                }
            },
            L: {
                onMousedown: function (profile, e, src) {
                    profile.box._onMousedown(profile, e, src, {
                        left: true
                    });
                    return false
                },
                onDragbegin: function (profile, e, src) {
                    profile.box._onDragbegin(profile, e, src)
                },
                onDrag: function (profile, e, src) {
                    profile.box._onDrag(profile, e, src, {
                        left: true
                    })
                },
                onDragstop: function (profile, e, src) {
                    profile.box._onDragstop(profile, e, src, {
                        left: true
                    })
                }
            },
            T: {
                onMousedown: function (profile, e, src) {
                    profile.box._onMousedown(profile, e, src, {
                        top: true
                    });
                    return false
                },
                onDragbegin: function (profile, e, src) {
                    profile.box._onDragbegin(profile, e, src)
                },
                onDrag: function (profile, e, src) {
                    profile.box._onDrag(profile, e, src, {
                        top: true
                    })
                },
                onDragstop: function (profile, e, src) {
                    profile.box._onDragstop(profile, e, src, {
                        top: true
                    })
                }
            },
            R: {
                onMousedown: function (profile, e, src) {
                    profile.box._onMousedown(profile, e, src, {
                        right: true
                    });
                    return false
                },
                onDragbegin: function (profile, e, src) {
                    profile.box._onDragbegin(profile, e, src)
                },
                onDrag: function (profile, e, src) {
                    profile.box._onDrag(profile, e, src, {
                        right: true
                    })
                },
                onDragstop: function (profile, e, src) {
                    profile.box._onDragstop(profile, e, src, {
                        right: true
                    })
                }
            },
            B: {
                onMousedown: function (profile, e, src) {
                    profile.box._onMousedown(profile, e, src, {
                        bottom: true
                    });
                    return false
                },
                onDragbegin: function (profile, e, src) {
                    profile.box._onDragbegin(profile, e, src)
                },
                onDrag: function (profile, e, src) {
                    profile.box._onDrag(profile, e, src, {
                        bottom: true
                    })
                },
                onDragstop: function (profile, e, src) {
                    profile.box._onDragstop(profile, e, src, {
                        bottom: true
                    })
                }
            }
        },
        DataModel: {
            _attached: false,
            forceVisible: false,
            forceMovable: "",
            singleDir: false,
            vertical: true,
            horizontal: true,
            minHeight: 12,
            minWidth: 12,
            maxHeight: 5000,
            maxWidth: 5000,
            handlerSize: 4,
            handlerOffset: 0,
            configBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("CONF").css("display", v ? "" : "none")
                }
            },
            left: 100,
            top: 100,
            height: 100,
            width: 100,
            position: "absolute",
            display: "block"
        },
        EventHandlers: {
            onDblclick: function (profile, e, src) {},
            onUpdate: function (profile, target, size, cssPos) {},
            onChange: function (profile, proxy) {},
            onConfig: function (profile, e, src) {}
        },
        _dynamicTemplate: function (profile) {
            var pro = profile.properties,
                size, pos, temp, hash = profile._exhash = "$_attached:" + pro._attached + ";forceVisible:" + pro.forceVisible + ";singleDir:" + pro.singleDir + ";vertical:" + pro.vertical + ";horizontal:" + pro.horizontal + ";forceMovable:" + pro.forceMovable + ";";
            var map = arguments.callee.map || (arguments.callee.map = {
                MOVE: {
                    tagName: "div",
                    style: "top:50%;left:50%;margin-left:-6px;margin-top:-6px;width:13px;height:13px;"
                },
                CONF: {
                    tagName: "div",
                    style: "top:2px;left:2px;width:12px;height:12px;{_showCofigBtn};"
                },
                T: {
                    tagName: "div",
                    style: "top:-{extend}px;margin-left:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                },
                RT: {
                    tagName: "div",
                    style: "top:-{extend}px;right:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                },
                R: {
                    tagName: "div",
                    style: "right:-{extend}px;margin-top:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                },
                RB: {
                    tagName: "div",
                    style: "bottom:-{extend}px;right:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                },
                B: {
                    tagName: "div",
                    style: "bottom:-{extend}px;margin-left:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                },
                LB: {
                    tagName: "div",
                    style: "bottom:-{extend}px;left:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                },
                L: {
                    tagName: "div",
                    style: "left:-{extend}px;margin-top:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                },
                LT: {
                    tagName: "div",
                    style: "left:-{extend}px;top:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                },
                cover: {
                    T: {
                        tagName: "div",
                        style: "width:100%;left:0;top:-{extend}px;height:{handlerSize}px;"
                    },
                    RT: {
                        tagName: "div",
                        style: "top:-{extend}px;right:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                    },
                    R: {
                        tagName: "div",
                        style: "height:100%;top:0;right:-{extend}px;width:{handlerSize}px;"
                    },
                    RB: {
                        tagName: "div",
                        style: "right:-{extend}px;bottom:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                    },
                    B: {
                        tagName: "div",
                        style: "width:100%;left:0;bottom:-{extend}px;height:{handlerSize}px;"
                    },
                    LB: {
                        tagName: "div",
                        style: "left:-{extend}px;bottom:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                    },
                    L: {
                        tagName: "div",
                        style: "height:100%;top:0;left:-{extend}px;width:{handlerSize}px;"
                    },
                    LT: {
                        tagName: "div",
                        style: "top:-{extend}px;left:-{extend}px;width:{handlerSize}px;height:{handlerSize}px;"
                    }
                }
            });
            var template = profile.box.getTemplate(hash);
            if (!template) {
                var t, n;
                template = _.clone(profile.box.getTemplate());
                t = pro._cover ? map.cover : map;
                if (pro._move) {
                    template.MOVE = map.MOVE
                }
                template.CONF = map.CONF;
                if (pro.vertical) {
                    if (!pro.singleDir) {
                        template.T = t.T
                    }
                    template.B = t.B
                }
                if (pro.horizontal) {
                    if (!pro.singleDir) {
                        template.L = t.L
                    }
                    template.R = t.R;
                    if (pro.vertical) {
                        if (!pro.singleDir) {
                            template.LB = t.LB;
                            template.RT = t.RT;
                            template.LT = t.LT
                        }
                        template.RB = t.RB
                    }
                }
                n = profile.getClass("KEY", "-handler") + " ";
                if (t = template.T) {
                    t.className = n
                }
                if (t = template.RT) {
                    t.className = n
                }
                if (t = template.R) {
                    t.className = n
                }
                if (t = template.RB) {
                    t.className = n
                }
                if (t = template.B) {
                    t.className = n
                }
                if (t = template.LB) {
                    t.className = n
                }
                if (t = template.L) {
                    t.className = n
                }
                if (t = template.LT) {
                    t.className = n
                }
                if (!pro._visible) {
                    n = profile.getClass("KEY", "-hidden") + " ";
                    if (t = template.T) {
                        t.className += n
                    }
                    if (t = template.RT) {
                        t.className += n
                    }
                    if (t = template.R) {
                        t.className += n
                    }
                    if (t = template.RB) {
                        t.className += n
                    }
                    if (t = template.B) {
                        t.className += n
                    }
                    if (t = template.LB) {
                        t.className += n
                    }
                    if (t = template.L) {
                        t.className += n
                    }
                    if (t = template.LT) {
                        t.className += n
                    }
                }
                profile.box.setTemplate(template, hash)
            }
            profile.template = template
        },
        _prepareData: function (profile) {
            var t = profile.properties;
            t._visible = true;
            t._cover = false;
            t._move = true;
            if (t._attached) {
                t._visible = false;
                t._cover = true;
                t._move = false;
                t.position = "static";
                t.display = "inline";
                t.left = t.top = t.width = t.height = 0
            }
            if (t.forceVisible) {
                t._visible = true;
                t._cover = false
            }
            if (typeof t.forceMovable == "boolean") {
                t._move = t.forceMovable
            }
            t.extend = (parseInt(t.handlerSize, 10) || 0) / 2 + (parseInt(t.handlerOffset, 10) || 0);
            t._showCofigBtn = t.configBtn ? "" : "display:none";
            return arguments.callee.upper.call(this, profile)
        },
        RenderTrigger: function () {
            var self = this;
            xui.setNodeData(self.renderId, "zIndexIgnore", 1)
        },
        _onUpdate: function (profile, target, size, cssPos) {
            if (target) {
                if (size) {
                    target.widthBy(size.width, true).heightBy(size.height, true)
                }
                if (cssPos) {
                    var t = target.get(0).style;
                    if (t.left == "auto" && (parseInt(t.right, 10) >= 0)) {} else {
                        target.leftBy(cssPos.left)
                    }
                    if (t.top == "auto" && (parseInt(t.bottom, 10) >= 0)) {} else {
                        target.topBy(cssPos.top)
                    }
                }
            }
        },
        _onMousedown: function (profile, e, src, ddparas) {
            if (xui.Event.getBtn(e) != "left") {
                return
            }
            var puip = profile.$parentUIProfile;
            if (puip && puip["xui.UIProfile"] && puip.beforeResizerDrag && false === _.tryF(puip.beforeResizerDrag, [puip, profile, ddparas], puip.boxing())) {
                return
            }
            var pos = xui.Event.getPos(e);
            xui.use(src).startDrag(e, {
                dragDefer: 2,
                targetReposition: false,
                dragType: "blank",
                dragCursor: true,
                targetLeft: pos.left,
                targetTop: pos.top
            })
        },
        _onDragbegin: function (profile, e) {
            var o = profile.properties._attached ? profile._target : xui([profile.renderId]),
                w = o.width(),
                h = o.height();
            if (profile.properties._attached) {
                var pos = o.offset();
                profile.proxy = xui.Dom.getEmptyDiv();
                profile.proxy.html(" ", false).css({
                    border: "1px dashed",
                    visibility: "visible"
                }).offset(pos).width(w).height(h).css("zIndex", xui.Dom.TOP_ZINDEX + 20)
            } else {
                profile.proxy = o
            }
            profile.o_pos = profile.proxy.cssPos();
            profile.o_w2 = profile.o_w = w;
            profile.o_h2 = profile.o_h = h;
            profile.$onDrag = true
        },
        _onDrag: function (profile, e, src, ddparas) {
            var o = ddparas;
            profile.oos = profile.oos || {};
            var os = xui.DragDrop.getProfile().offset;
            if (os.x == profile.oos.width && os.y == profile.oos.height) {
                return
            }
            profile.oos = os;
            var x, y, w, h, t = profile.properties;
            if (o.left) {
                w = profile.o_w - os.x;
                x = profile.o_pos.left + os.x;
                if (w < t.minWidth) {
                    w = t.minWidth;
                    x = profile.o_w + profile.o_pos.left - w
                } else {
                    if (w > t.maxWidth) {
                        w = t.maxWidth;
                        x = profile.o_w + profile.o_pos.left - w
                    }
                }
                profile.proxy.width(w).left(x);
                if (profile.onChange) {
                    profile.boxing().onChange(profile, profile.proxy)
                }
            } else {
                if (o.right) {
                    w = profile.o_w + os.x;
                    if (w < t.minWidth) {
                        w = t.minWidth
                    } else {
                        if (w > t.maxWidth) {
                            w = t.maxWidth
                        }
                    }
                    profile.proxy.width(w);
                    if (profile.onChange) {
                        profile.boxing().onChange(profile, profile.proxy)
                    }
                }
            }
            if (o.left || o.right) {
                var byw = w - profile.o_w2;
                if (profile.regions && byw !== 0) {
                    profile.regions.widthBy(byw);
                    profile.o_w2 = w
                }
            }
            if (o.top) {
                h = profile.o_h - os.y;
                y = profile.o_pos.top + os.y;
                if (h < t.minHeight) {
                    h = t.minHeight;
                    y = profile.o_h + profile.o_pos.top - h
                } else {
                    if (h > t.maxHeight) {
                        h = t.maxHeight;
                        y = profile.o_h + profile.o_pos.top - h
                    }
                }
                profile.proxy.height(h).top(y);
                if (profile.onChange) {
                    profile.boxing().onChange(profile, profile.proxy)
                }
            } else {
                if (o.bottom) {
                    h = profile.o_h + os.y;
                    if (h < t.minHeight) {
                        h = t.minHeight
                    } else {
                        if (h > t.maxHeight) {
                            h = t.maxHeight
                        }
                    }
                    profile.proxy.height(h);
                    if (profile.onChange) {
                        profile.boxing().onChange(profile, profile.proxy)
                    }
                }
            }
            if (o.top || o.bottom) {
                var byh = h - profile.o_h2;
                if (profile.regions && byh !== 0) {
                    profile.regions.heightBy(byh);
                    profile.o_h2 = h
                }
            }
            if (o.move) {
                x = profile.o_pos.left + os.x;
                y = profile.o_pos.top + os.y;
                profile.proxy.top(y).left(x);
                if (profile.onChange) {
                    profile.boxing().onChange(profile, profile.proxy)
                }
            }
        },
        _onDragstop: function (profile, e, src, args) {
            var cssPos, size, pos, o = profile.proxy;
            if (!args.move) {
                size = {
                    width: o.width() - profile.o_w,
                    height: o.height() - profile.o_h
                }
            }
            if (args.left || args.top || args.move) {
                cssPos = o.cssPos();
                pos = {
                    left: cssPos.left - profile.o_pos.left,
                    top: cssPos.top - profile.o_pos.top
                }
            }
            if (profile.onUpdate && false === profile.boxing().onUpdate(profile, profile._target, size, pos)) {} else {
                profile.box._onUpdate(profile, profile._target, size, pos)
            }
            if (profile.properties._attached) {
                if (xui.browser.ie6) {
                    profile._target.ieRemedy()
                }
                profile.proxy.html("", false).css({
                    visibility: "hidden",
                    border: "none",
                    zIndex: "0",
                    width: "0",
                    height: "0"
                })
            }
            profile.$onDrag = false
        }
    }
});
Class("xui.UI.Image", "xui.UI", {
    Instance: {
        getRate: function () {
            return parseFloat(this.get(0)._rate) || 1
        }
    },
    Static: {
        Templates: {
            tagName: "image",
            style: "cursor:{cursor};{_style}",
            className: "{_className}",
            border: "0",
            src: xui.ini.img_bg,
            alt: "{alt}"
        },
        Behaviors: {
            HoverEffected: {
                KEY: "KEY"
            },
            ClickEffected: {
                KEY: "KEY"
            },
            DraggableKeys: ["KEY"],
            onError: function (profile, e, src) {
                profile.boxing().onError(profile)
            },
            onLoad: function (profile, e, src) {
                var i = new Image(),
                    path = i.src = xui.use(src).get(0).src,
                    prop = profile.properties;
                size = profile.box._adjust(profile, _.isFinite(prop.width) ? prop.width : i.width, _.isFinite(prop.height) ? prop.height : i.height);
                profile.boxing().afterLoad(profile, path, size[0], size[1]);
                if (prop.dock != "none") {
                    profile.boxing().adjustDock()
                }
            },
            onClick: function (profile, e, src) {
                var p = profile.properties;
                if (p.disabled) {
                    return false
                }
                if (profile.onClick) {
                    profile.boxing().onClick(profile, e, src)
                }
            },
            onDblclick: function (profile, e, src) {
                var p = profile.properties;
                if (p.disabled) {
                    return false
                }
                if (profile.onDblclick) {
                    profile.boxing().onDblclick(profile, e, src)
                }
            }
        },
        RenderTrigger: function () {
            var self = this,
                pro = self.properties,
                v = pro.src;
            if (v) {
                pro.value = pro.$UIvalue = "";
                self.boxing().setSrc(v, v != xui.ini.img_bg)
            }
        },
        EventHandlers: {
            onClick: function (profile, e, src) {},
            onDblclick: function (profile, e, src) {},
            onError: function (profile) {},
            beforeLoad: function (profile) {},
            afterLoad: function (profile, path, width, height) {}
        },
        _adjust: function (profile, width, height) {
            var pro = profile.properties,
                src = profile.getRootNode();
            width = parseInt(width, 10) || 0;
            height = parseInt(height, 10) || 0;
            src.style.width = src.style.height = "";
            if (width > 0 && height > 0) {
                var r1 = pro.maxWidth / width,
                    r2 = pro.maxHeight / height,
                    r = r1 < r2 ? r1 : r2;
                if (r >= 1) {
                    r = 1
                }
                profile._rate = r;
                return [src.width = width * r, src.height = height * r]
            }
            return [0, 0]
        },
        DataModel: {
            maxWidth: {
                ini: 800,
                action: function (v) {
                    var src = this.getRootNode(),
                        prop = this.properties;
                    this.box._adjust(this, _.isFinite(prop.width) ? prop.width : src.width, _.isFinite(prop.height) ? prop.height : src.height)
                }
            },
            maxHeight: {
                ini: 600,
                action: function (v) {
                    var src = this.getRootNode(),
                        prop = this.properties;
                    this.box._adjust(this, _.isFinite(prop.width) ? prop.width : src.width, _.isFinite(prop.height) ? prop.height : src.height)
                }
            },
            width: {
                ini: "auto",
                action: function (v) {
                    var src = this.getRootNode(),
                        prop = this.properties,
                        i = new Image();
                    i.src = src.src;
                    this.box._adjust(this, _.isFinite(v) ? parseInt(v, 10) : i.width, _.isFinite(prop.height) ? prop.height : i.height)
                }
            },
            height: {
                ini: "auto",
                action: function (v) {
                    var src = this.getRootNode(),
                        prop = this.properties,
                        i = new Image();
                    i.src = src.src;
                    this.box._adjust(this, _.isFinite(prop.width) ? prop.width : i.width, _.isFinite(v) ? parseInt(v, 10) : i.height)
                }
            },
            src: {
                format: "image",
                ini: xui.ini.img_bg,
                action: function (v) {
                    var self = this;
                    if (false !== self.boxing().beforeLoad(this)) {
                        _.asyRun(function () {
                            self.getRoot().attr({
                                width: "0",
                                height: "0",
                                src: xui.adjustRes(v)
                            })
                        })
                    }
                }
            },
            alt: {
                ini: "",
                action: function (v) {
                    this.getRoot().attr("alt", v)
                }
            },
            cursor: {
                ini: "auto",
                action: function (v) {
                    this.getRoot().css("cursor", v)
                }
            }
        }
    }
});
Class("xui.UI.Flash", "xui.UI", {
    Instance: {
        refreshFlash: function () {
            var html = "",
                cls = this.constructor;
            return this.each(function (profile) {
                _.resetRun(profile.domId, function () {
                    cls._clearMemory(profile);
                    if (profile.properties.src) {
                        cls._drawSWF(profile)
                    }
                })
            })
        },
        getFlash: function () {
            return this.constructor._getSWF(this.get(0))
        }
    },
    Static: {
        Appearances: {
            KEY: {
                "font-size": xui.browser.ie ? 0 : null,
                "line-height": xui.browser.ie ? 0 : null,
                overflow: "hidden"
            },
            BOX: {
                position: "absolute",
                left: 0,
                top: 0,
                "z-index": 1
            },
            COVER: {
                position: "absolute",
                left: "-1px",
                top: "-1px",
                width: 0,
                height: 0,
                "z-index": 4
            }
        },
        Templates: {
            tagName: "div",
            className: "{_className}",
            style: "{_style}",
            BOX: {
                tagName: "div"
            },
            COVER: {
                tagName: "div"
            }
        },
        Behaviors: {
            onSize: xui.UI.$onSize
        },
        DataModel: {
            selectable: true,
            width: 500,
            height: 300,
            cover: false,
            src: {
                format: "flash",
                ini: "",
                action: function (v, o) {
                    this.boxing().refreshFlash()
                }
            },
            parameters: {
                ini: {},
                action: function (v, o) {
                    this.boxing().refreshFlash()
                }
            },
            flashvars: {
                ini: {},
                action: function (v, o) {
                    this.boxing().refreshFlash()
                }
            }
        },
        RenderTrigger: function () {
            (this.$beforeDestroy = (this.$beforeDestroy || {}))["flashClearMem"] = function () {
                if (this.box) {
                    this.box._clearMemory(this)
                }
            };
            this.boxing().refreshFlash()
        },
        getFlashVersion: function () {
            if (xui.browser.ie) {
                try {
                    var axo = new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");
                    try {
                        axo.AllowScriptAccess = "always"
                    } catch (e) {
                        return "6,0,0"
                    }
                } catch (e) {} finally {
                    try {
                        return new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version").replace(/\D+/g, ",").match(/^,?(.+),?$/)[1]
                    } catch (e) {}
                }
            } else {
                try {
                    if (navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin) {
                        return (navigator.plugins["Shockwave Flash 2.0"] || navigator.plugins["Shockwave Flash"]).description.replace(/\D+/g, ",").match(/^,?(.+),?$/)[1]
                    }
                } catch (e) {}
            }
            return "0,0,0"
        },
        _getSWF: function (profile) {
            var id = _.isStr(profile) ? profile : (this._idtag + profile.serialId);
            return (xui.browser.ie ? window[id] : ((document.embeds && document.embeds[id]) || window.document[id])) || document.getElementById(id)
        },
        _clearMemory: function (profile) {
            var id = this._idtag + profile.serialId;
            var _e = _.fun(),
                chart = profile.box._getSWF(profile);
            if (chart) {
                chart.style.display = "none";
                if (xui.browser.ie) {
                    for (var x in chart) {
                        if (typeof chart[x] == "function") {
                            chart[x] = _e
                        }
                    }
                    if (window[id]) {
                        window[id] = undefined
                    }
                } else {
                    if (document.embeds && document.embeds[id]) {
                        document.embeds[id] = undefined
                    }
                    if (window.document[id]) {
                        window.document[id] = undefined
                    }
                }
                chart = _e = null
            }
        },
        _drawSWF: function (profile) {
            var ns = this;
            var prop = profile.properties,
                serialId = profile.serialId,
                src = xui.adjustRes(prop.src),
                parameters = prop.parameters,
                options = _.copy(prop.flashvars),
                xml = "";
            options.DOMId = profile.box._idtag + profile.serialId;
            options.chartWidth = prop.width;
            options.chartHeight = prop.height;
            if (navigator.plugins && navigator.mimeTypes && navigator.mimeTypes.length) {
                xml += '<embed type="application/x-shockwave-flash" src="' + src + "?" + _.urlEncode(parameters) + '" ';
                xml += 'width="' + prop.width + '" height="' + prop.height + '" ';
                xml += 'id="' + options.DOMId + '" name="' + options.DOMId + '" ';
                xml += 'wmode="opaque" ';
                xml += 'flashvars="' + _.urlEncode(options) + '" ';
                xml += "/>"
            } else {
                xml += '<object id="' + options.DOMId + '" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" ';
                xml += 'width="' + prop.width + '" height="' + prop.height + '">';
                xml += '<param name="movie" value="' + src + "?" + _.urlEncode(parameters) + '" />';
                xml += '<param name="wmode" value="opaque" />';
                xml += '<param name="flashvars" value="' + _.urlEncode(options) + '" />';
                xml += "</object>"
            }
            profile.getSubNode("BOX").html(xml, false)
        },
        _onresize: function (profile, width, height) {
            var size = profile.getSubNode("BOX").cssSize(),
                prop = profile.properties;
            if ((width && size.width != width) || (height && size.height != height)) {
                if (width) {
                    prop.width = width
                }
                if (height) {
                    prop.height = height
                }
                size = {
                    width: width,
                    height: height
                };
                profile.getSubNode("BOX").cssSize(size, true);
                if (profile.$inDesign || prop.cover) {
                    profile.getSubNode("COVER").cssSize(size, true)
                }
                profile.boxing().refreshFlash()
            }
        }
    }
});
Class("xui.UI.Block", "xui.UI.Widget", {
    Initialize: function () {
        var self = this,
            t = self.getTemplate();
        _.merge(t.FRAME.BORDER, {
            className: "xui-uiw-border {clsBorderType1}",
            PANEL: {
                tagName: "div",
                className: "{clsBorderType2} xui-uibg-bar",
                style: "{background};{_overflow};",
                text: "{html}" + xui.UI.$childTag
            }
        }, "all");
        self.setTemplate(t);
        t = self.getAppearance();
        _.merge(t, {
            PANEL: {
                position: "relative",
                overflow: "hidden"
            }
        });
        self.setAppearance(t)
    },
    Static: {
        Behaviors: {
            DroppableKeys: ["PANEL"],
            PanelKeys: ["PANEL"]
        },
        DataModel: {
            disabled: null,
            tips: null,
            iframeAutoLoad: "",
            ajaxAutoLoad: "",
            selectable: true,
            html: {
                html: 1,
                action: function (v) {
                    this.getSubNode("PANEL").html(xui.adjustRes(v, 0, 1))
                }
            },
            overflow: {
                ini: xui.browser.isTouch ? "auto" : undefined,
                listbox: ["", "visible", "hidden", "scroll", "auto"],
                action: function (v) {
                    this.getSubNode("PANEL").css("overflow", v || "")
                }
            },
            borderType: {
                ini: "outset",
                listbox: ["none", "flat", "inset", "outset", "groove", "ridge"],
                action: function (v) {
                    var ns = this,
                        p = ns.properties,
                        n1 = ns.getSubNode("BORDER"),
                        n2 = ns.getSubNode("PANEL"),
                        reg = /^xui-uiborder-/,
                        flat = "xui-uiborder-flat",
                        ins = "xui-uiborder-inset",
                        outs = "xui-uiborder-outset",
                        root = ns.getRoot();
                    n1.removeClass(reg);
                    n2.removeClass(reg);
                    switch (v) {
                    case "flat":
                        n1.addClass(flat);
                        break;
                    case "inset":
                        n1.addClass(ins);
                        break;
                    case "outset":
                        n1.addClass(outs);
                        break;
                    case "groove":
                        n1.addClass(ins);
                        n2.addClass(outs);
                        break;
                    case "ridge":
                        n1.addClass(outs);
                        n2.addClass(ins);
                        break
                    }
                    ns.box._setB(ns);
                    xui.UI.$tryResize(ns, root.get(0).style.width, root.get(0).style.height, true)
                }
            },
            background: {
                format: "color",
                ini: "",
                action: function (v) {
                    this.getSubNode("PANEL").css("background", v)
                }
            },
            width: 100,
            height: 100
        },
        Appearances: {
            KEY: {
                "line-height": "1"
            }
        },
        RenderTrigger: function () {
            var ns = this;
            if (ns.box.KEY == "xui.UI.Block") {
                if (ns.properties.iframeAutoLoad || ns.properties.ajaxAutoLoad) {
                    xui.UI.Div._applyAutoLoad(this)
                }
            }
        },
        _setB: function (profile) {
            var p = profile.properties,
                type = p.borderType;
            p.$hborder = p.$vborder = p.$iborder = 0;
            if (type == "flat" || type == "inset" || type == "outset") {
                p.$hborder = p.$vborder = 1;
                p.$iborder = 0
            } else {
                if (type == "groove" || type == "ridge") {
                    p.$hborder = p.$vborder = p.$iborder = 1
                }
            }
        },
        LayoutTrigger: function () {
            var v = this.properties.borderType;
            if (v != "none") {
                this.boxing().setBorderType(v, true)
            }
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            data.background = data.background ? "background:" + data.background : "";
            if (_.isStr(data.overflow)) {
                data._overflow = data.overflow.indexOf(":") != -1 ? (data.overflow) : ("overflow:" + data.overflow)
            }
            return data
        },
        _onresize: function (profile, width, height) {
            var size = arguments.callee.upper.apply(this, arguments),
                p = profile.properties,
                b = (p.$iborder || 0) * 2;
            if (size.width) {
                size.width -= b
            }
            if (size.height && "auto" !== size.height) {
                size.height -= b
            }
            profile.getSubNode("PANEL").cssSize(size, true)
        }
    }
});
Class("xui.UI.Label", "xui.UI.Widget", {
    Instance: {
        _shadowText: function (key) {
            return this.each(function (o) {
                o.getSubNode("SHADOW").css("display", "block")
            })
        },
        _unShadowText: function (key) {
            return this.each(function (o) {
                o.getSubNode("SHADOW").css("display", "none")
            })
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        _.merge(t.FRAME.BORDER, {
            SHADOW: {
                $order: 1,
                style: "display:none;",
                SICON: {
                    $order: 0,
                    className: "xui-ui-icon {imageClass}",
                    style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                },
                SCAPTION: {
                    text: "{caption}",
                    style: "color:#cdcdcd;",
                    $order: 1
                }
            },
            BOX: {
                $order: 2,
                ICON: {
                    $order: 0,
                    className: "xui-ui-icon {imageClass}",
                    style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                },
                CAPTION: {
                    text: "{caption}",
                    $order: 1
                }
            }
        }, "all");
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            KEY: {
                "font-size": "12px",
                "line-height": "14px"
            },
            BOX: {
                position: "absolute"
            },
            SHADOW: {
                position: "absolute",
                top: "4px"
            }
        },
        DataModel: {
            selectable: true,
            caption: {
                ini: undefined,
                action: function (v) {
                    var self = this,
                        p = self.properties,
                        b = self.boxing(),
                        k = self.keys;
                    v = (_.isSet(v) ? v : "") + "";
                    self.getSubNodes(["CAPTION", "SCAPTION"]).html(xui.adjustRes(v, true));
                    if (p.hAlign != "left") {
                        b.setHAlign(p.hAlign, true)
                    }
                    if (p.vAlign != "top") {
                        b.setVAlign(p.vAlign, true)
                    }
                }
            },
            image: {
                format: "image",
                action: function (value) {
                    var self = this,
                        k = self.keys;
                    self.getSubNodes(["ICON", "SICON"]).css("display", value ? "" : "none").css("backgroundImage", "url(" + xui.adjustRes(value || "") + ")")
                }
            },
            imagePos: {
                action: function (value) {
                    var self = this,
                        k = self.keys;
                    self.getSubNodes(["ICON", "SICON"]).css("backgroundPosition", value)
                }
            },
            shadowText: {
                ini: false,
                action: function (v) {
                    var b = this.boxing();
                    v = String(v).toLowerCase() != "false";
                    if (v) {
                        b._shadowText(v)
                    } else {
                        b._unShadowText()
                    }
                }
            },
            hAlign: {
                ini: "right",
                listbox: ["left", "center", "right"],
                action: function (v) {
                    var self = this,
                        c = self.getSubNode("BOX"),
                        d = self.getSubNode("SHADOW"),
                        t = self.properties,
                        fun = function () {
                            switch (v) {
                            case "left":
                                c.css({
                                    left: 0,
                                    right: "auto",
                                    marginLeft: "auto"
                                });
                                d.css({
                                    left: t._textSshadowSize + "px",
                                    right: "auto",
                                    marginLeft: "auto"
                                });
                                break;
                            case "right":
                                c.css({
                                    left: "auto",
                                    right: t._textSshadowSize + "px",
                                    marginLeft: "auto"
                                });
                                d.css({
                                    left: "auto",
                                    right: 0,
                                    marginLeft: "auto"
                                });
                                break;
                            case "center":
                                c.css({
                                    left: "50%",
                                    right: "auto",
                                    marginLeft: -1 * c.get(0).offsetWidth / 2 + "px"
                                });
                                d.css({
                                    left: "50%",
                                    right: "auto",
                                    marginLeft: -1 * c.get(0).offsetWidth / 2 + t._textSshadowSize + "px"
                                });
                                break
                            }
                        };
                    if (c.get(0).offsetWidth) {
                        fun()
                    } else {
                        _.asyRun(fun)
                    }
                }
            },
            vAlign: {
                ini: "top",
                listbox: ["top", "middle", "bottom"],
                action: function (v) {
                    var self = this,
                        c = self.getSubNode("BOX"),
                        d = self.getSubNode("SHADOW"),
                        t = self.properties,
                        fun = function () {
                            switch (v) {
                            case "top":
                                c.css({
                                    top: 0,
                                    bottom: "auto",
                                    marginTop: "auto"
                                });
                                d.css({
                                    top: t._textSshadowSize + "px",
                                    bottom: "auto",
                                    marginTop: "auto"
                                });
                                break;
                            case "bottom":
                                c.css({
                                    top: "auto",
                                    bottom: t._textSshadowSize + "px",
                                    marginTop: "auto"
                                });
                                d.css({
                                    top: "auto",
                                    bottom: 0,
                                    marginTop: "auto"
                                });
                                break;
                            case "middle":
                                c.css({
                                    top: "50%",
                                    bottom: "auto",
                                    marginTop: -1 * c.get(0).offsetHeight / 2 + "px"
                                });
                                d.css({
                                    top: "50%",
                                    bottom: "auto",
                                    marginTop: -1 * c.get(0).offsetHeight / 2 + t._textSshadowSize + "px"
                                });
                                break
                            }
                        };
                    if (c.get(0).offsetHeight) {
                        fun()
                    } else {
                        _.asyRun(fun)
                    }
                }
            },
            fontSize: {
                action: function (value) {
                    var self = this;
                    self.getSubNodes(["CAPTION", "SCAPTION"]).css("fontSize", value)
                }
            },
            fontWeight: {
                action: function (value) {
                    var self = this;
                    self.getSubNodes(["CAPTION", "SCAPTION"]).css("fontWeight", value)
                }
            },
            width: 120,
            height: 20,
            _textSshadowSize: 4
        },
        RenderTrigger: function () {
            var p = this.properties,
                o = this.boxing();
            if (p.fontSize) {
                o.setFontSize(p.fontSize, true)
            }
            if (p.fontWeight) {
                o.setFontWeight(p.fontWeight, true)
            }
            if (p.shadowText) {
                o.setShadowText(true, true)
            }
        },
        LayoutTrigger: function () {
            var p = this.properties,
                o = this.boxing(),
                s = p.shadowText;
            if (p.hAlign != "left" || s) {
                o.setHAlign(p.hAlign, true)
            }
            if (p.vAlign != "top" || s) {
                o.setVAlign(p.vAlign, true)
            }
        }
    }
});
Class("xui.UI.ProgressBar", ["xui.UI.Widget", "xui.absValue"], {
    Instance: {
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                profile.getSubNode("FILL").width(value + "%");
                profile.getSubNode("CAP").text(profile.properties.captionTpl.replace(/\{value\}/g, value))
            })
        }
    },
    Initialize: function () {
        var self = this,
            t = self.getTemplate();
        _.merge(t.FRAME.BORDER, {
            FILL: {
                tagName: "div",
                style: "width:{value}%;{fillBG}",
                text: "{html}" + xui.UI.$childTag
            },
            INN: {
                $order: 2,
                tagName: "div",
                CAP: {
                    tagName: "div"
                }
            }
        }, "all");
        self.setTemplate(t);
        t = self.getAppearance();
        _.merge(t, {
            BORDER: {
                border: "1px solid #95B611",
                "font-size": 0,
                "line-height": 0
            },
            INN: {
                display: "table",
                position: "absolute",
                left: 0,
                top: 0,
                width: "100%",
                height: "100%"
            },
            CAP: {
                "text-align": "center"
            },
            FILL: {
                position: "absolute",
                width: "1px",
                left: 0,
                top: 0,
                height: "100%",
                background: xui.UI.$bg("bar.gif", "#96E115 repeat-x left top"),
                width: 0
            }
        });
        self.setAppearance(t)
    },
    Static: {
        DataModel: {
            value: 0,
            width: 300,
            height: 22,
            captionTpl: {
                ini: "{value}%",
                action: function () {
                    this.boxing()._setCtrlValue(this.properties.$UIvalue)
                }
            },
            fillBG: {
                ini: "",
                action: function (v) {
                    this.getSubNode("FILL").css("background", v)
                }
            },
            $hborder: 1,
            $vborder: 1
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            data.fillBG = data.fillBG ? "background:" + data.fillBG : "";
            return data
        },
        _ensureValue: function (profile, value) {
            return parseInt(value, 10) || 0
        },
        _onresize: function (profile, width, height) {
            var size = arguments.callee.upper.apply(this, arguments),
                h;
            if (size.height) {
                h = size.height + "px";
                profile.getSubNodes(["INN", "CAP", "FILL"]).css({
                    height: h,
                    "line-height": h
                })
            }
        }
    }
});
Class("xui.UI.Button", ["xui.UI.Widget", "xui.absValue"], {
    Instance: {
        activate: function () {
            this.getSubNode("FOCUS").focus();
            return this
        },
        _setCtrlValue: function (value) {
            if (_.isNull(value) || !_.isDefined(value)) {
                value = false
            }
            return this.each(function (profile) {
                var pp = profile.properties;
                if (pp.type != "status") {
                    return
                }
                profile.getSubNode("BORDER").tagClass("-checked", value);
                if (pp.border) {
                    var b = profile.getSubNode("BORDER").$getBorder();
                    if (b) {
                        b.get(0).getRoot().tagClass("-checked", value)
                    }
                }
            })
        },
        _setDirtyMark: function () {
            return arguments.callee.upper.apply(this, ["FOCUS"])
        },
        resetValue: function (value) {
            this.each(function (p) {
                if (p.properties.type == "drop") {
                    p.boxing().setCaption("", true)
                }
            });
            return arguments.callee.upper.apply(this, arguments)
        },
        setUIValue: function (value, force) {
            this.each(function (profile) {
                var p = profile.properties;
                if (p.$UIvalue !== value && p.type == "drop") {
                    profile.boxing().setCaption("", true)
                }
            });
            return arguments.callee.upper.apply(this, arguments)
        }
    },
    Initialize: function () {
        this.addTemplateKeys(["DROP"]);
        var t = this.getTemplate();
        _.merge(t.FRAME, {
            FOCUS: {
                $order: 2,
                tabindex: "{tabindex}",
                TB: {
                    cellpadding: "0",
                    cellspacing: "0",
                    width: "100%",
                    height: "100%",
                    border: "0",
                    tagName: "table",
                    TR: {
                        tagName: "tr",
                        TDL: {
                            tagName: "td"
                        },
                        TD: {
                            $order: 1,
                            align: "{hAlign}",
                            valign: "{vAlign}",
                            tagName: "td",
                            width: "100%",
                            height: "100%",
                            BOX: {
                                ICON: {
                                    $order: 1,
                                    className: "xui-ui-icon {imageClass}",
                                    style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                                },
                                CAPTION: {
                                    $order: 2,
                                    text: "{caption}"
                                }
                            }
                        },
                        TDR: {
                            $order: 2,
                            tagName: "td",
                            className: "{dropCls}",
                            TDRI: {}
                        }
                    }
                }
            }
        }, "all");
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            KEY: {
                "font-size": "12px",
                "line-height": "14px"
            },
            BORDER: {
                "font-size": 0,
                "line-height": 0,
                "background-color": "#D2D7DF"
            },
            "BORDER-mouseover": {
                $order: 2,
                "background-color": "#F7D928"
            },
            "BORDER-mousedown, BORDER-checked": {
                $order: 2,
                "background-color": "#F9E56A"
            },
            DROP: {
                $order: 10,
                background: xui.UI.$bg("drop.gif", "no-repeat left bottom", "Button"),
                "padding-left": "16px"
            },
            "DROP-mouseover": {
                $order: 11,
                "background-position": "-16px bottom"
            },
            "DROP-mousedown": {
                $order: 12,
                "background-position": "right bottom"
            },
            "TDR,TDL": {
                "padding-left": "6px"
            },
            ".setting-xui-button": {
                "border-top-width": "1px",
                "border-bottom-width": "1px",
                "border-left-width": "1px",
                "border-right-width": "1px"
            },
            "KEY-b-t": {
                top: "-1px",
                height: "10px",
                background: xui.UI.$bg("vertical.gif", "repeat-x left top", "Button")
            },
            "KEY-b-b": {
                bottom: "-1px",
                height: "10px",
                background: xui.UI.$bg("vertical.gif", "repeat-x left bottom", "Button")
            },
            "BORDER-mouseover KEY-b-t, BORDER-mouseover KEY-b-b": {
                $order: 1,
                "background-image": xui.UI.$bg("vertical_mouseover.gif", "", "Button")
            },
            "BORDER-checked KEY-b-t, BORDER-checked KEY-b-b, BORDER-mousedown KEY-b-t, BORDER-mousedown KEY-b-b": {
                $order: 2,
                "background-image": xui.UI.$bg("vertical_mousedown.gif", "", "Button")
            },
            "KEY-b-l": {
                left: "-1px",
                width: "4px",
                background: xui.UI.$bg("horizontal.gif", "repeat-y left top", "Button")
            },
            "KEY-b-r": {
                right: "-1px",
                width: "4px",
                background: xui.UI.$bg("horizontal.gif", "repeat-y right top", "Button")
            },
            "BORDER-mouseover KEY-b-l, BORDER-mouseover KEY-b-r": {
                $order: 1,
                "background-image": xui.UI.$bg("horizontal_mouseover.gif", "", "Button")
            },
            "BORDER-checked KEY-b-l, BORDER-checked KEY-b-r, BORDER-mousedown KEY-b-l, BORDER-mousedown KEY-b-r": {
                $order: 2,
                "background-image": xui.UI.$bg("horizontal_mousedown.gif", "", "Button")
            },
            "KEY-b-lt": {
                top: "-1px",
                left: "-1px",
                width: "4px",
                height: "10px",
                background: xui.UI.$bg("corner.gif", "no-repeat left top", "Button")
            },
            "KEY-b-rt": {
                top: "-1px",
                right: "-1px",
                width: "4px",
                height: "10px",
                background: xui.UI.$bg("corner.gif", "no-repeat right top", "Button")
            },
            "KEY-b-rb": {
                right: "-1px",
                bottom: "-1px",
                width: "4px",
                height: "10px",
                background: xui.UI.$bg("corner.gif", "no-repeat right bottom", "Button")
            },
            "KEY-b-lb": {
                left: "-1px",
                bottom: "-1px",
                width: "4px",
                height: "10px",
                background: xui.UI.$bg("corner.gif", "no-repeat left bottom", "Button")
            },
            "BORDER-mouseover KEY-b-lt, BORDER-mouseover KEY-b-rt, BORDER-mouseover KEY-b-rb, BORDER-mouseover KEY-b-lb": {
                $order: 1,
                "background-image": xui.UI.$bg("corner_mouseover.gif", "", "Button")
            },
            "BORDER-checked KEY-b-lt, BORDER-checked KEY-b-rt, BORDER-checked KEY-b-rb, BORDER-checked KEY-b-lb, BORDER-mousedown KEY-b-lt, BORDER-mousedown KEY-b-rt, BORDER-mousedown KEY-b-rb, BORDER-mousedown KEY-b-lb": {
                $order: 2,
                "background-image": xui.UI.$bg("corner_mousedown.gif", "", "Button")
            },
            FOCUS: {
                overflow: "hidden",
                display: "block",
                left: 0,
                top: 0,
                "z-index": "20",
                width: "100%",
                height: "100%",
                position: "absolute",
                "outline-offset": "-1px",
                "-moz-outline-offset": (xui.browser.gek && xui.browser.ver < 3) ? "-1px !important" : null
            },
            BOX: {
                display: "inline",
                "white-space": "nowrap"
            },
            CAPTION: {
                cursor: "pointer",
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle",
                display: "inline",
                "font-size": "12px",
                "line-height": "14px"
            }
        },
        Behaviors: {
            HoverEffected: {
                KEY: ["BORDER"]
            },
            ClickEffected: {
                KEY: ["BORDER"]
            },
            NavKeys: {
                FOCUS: 1
            },
            onClick: function (profile, e, src) {
                var p = profile.properties;
                if (p.disabled) {
                    return false
                }
                profile.getSubNode("FOCUS").focus();
                var b = profile.boxing();
                if (p.type == "status") {
                    if (p.readonly) {
                        return false
                    }
                    b.setUIValue(!p.$UIvalue);
                    if (profile.onChecked) {
                        b.onChecked(profile, e, p.$UIvalue)
                    }
                }
                if (profile.onClick) {
                    b.onClick(profile, e, src, p.$UIvalue)
                }
            },
            onKeydown: function (profile, e, src) {
                var keys = xui.Event.getKey(e),
                    key = keys.key;
                if (key == " " || key == "enter") {
                    profile.getSubNode("KEY").afterMousedown();
                    profile.__fakeclick = 1
                }
            },
            onKeyup: function (profile, e, src) {
                var keys = xui.Event.getKey(e),
                    key = keys.key;
                if (key == " " || key == "enter") {
                    profile.getSubNode("KEY").afterMouseup();
                    if (profile.__fakeclick) {
                        xui.use(src).onClick()
                    }
                }
                delete profile.__fakeclick
            },
            TDR: {
                onMousedown: function (profile, e, src) {
                    if (profile.properties.type != "drop") {
                        return
                    }
                    xui.use(src).addClass(profile.getClass("DROP", "-mousedown"));
                    return false
                },
                onMouseup: function (profile, e, src) {
                    if (profile.properties.type != "drop") {
                        return
                    }
                    xui.use(src).removeClass(profile.getClass("DROP", "-mousedown"));
                    return false
                },
                onMouseover: function (profile, e, src) {
                    if (profile.properties.type != "drop") {
                        return
                    }
                    xui.use(src).addClass(profile.getClass("DROP", "-mouseover"))
                },
                onMouseout: function (profile, e, src) {
                    if (profile.properties.type != "drop") {
                        return
                    }
                    xui.use(src).removeClass(profile.getClass("DROP", "-mouseover")).removeClass(profile.getClass("DROP", "-mousedown"))
                },
                onClick: function (profile, e, src) {
                    if (profile.properties.type != "drop") {
                        return
                    }
                    profile.boxing().onClickDrop(profile, e, src);
                    return false
                }
            }
        },
        DataModel: {
            caption: {
                ini: undefined,
                action: function (v) {
                    v = (_.isSet(v) ? v : "") + "";
                    this.getSubNode("CAPTION").html(xui.adjustRes(v, true))
                }
            },
            image: {
                format: "image",
                action: function (value) {
                    this.getSubNode("ICON").css("display", value ? "" : "none").css("backgroundImage", "url(" + xui.adjustRes(value || "") + ")")
                }
            },
            imagePos: {
                action: function (value) {
                    this.getSubNode("ICON").css("backgroundPosition", value)
                }
            },
            hAlign: {
                ini: "center",
                listbox: ["left", "center", "right"],
                action: function (v) {
                    this.getSubNode("TD").attr("align", v)
                }
            },
            vAlign: {
                ini: "middle",
                listbox: ["top", "middle", "bottom"],
                action: function (v) {
                    this.getSubNode("TD").attr("valign", v)
                }
            },
            value: false,
            type: {
                ini: "normal",
                listbox: ["normal", "status", "drop"],
                action: function (value) {
                    var self = this,
                        root = self.getRoot(),
                        tdr = self.getSubNode("TDR"),
                        drop = self.getClass("DROP");
                    if (value == "drop") {
                        tdr.addClass(drop)
                    } else {
                        tdr.removeClass(drop)
                    }
                    self.box._onresize(self)
                }
            },
            width: 120,
            height: 22,
            _customBorder: "BORDER",
            border: true
        },
        _ensureValue: function (profile, value) {
            if (profile.properties.type == "status") {
                return !!value
            } else {
                return value
            }
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            data.dropCls = data.type == "drop" ? profile.getClass("DROP") : "";
            return data
        },
        RenderTrigger: function () {
            var self = this,
                p = self.properties,
                o = self.boxing();
            if (p.type == "status" && p.value) {
                o.setValue(true, true)
            }
        },
        EventHandlers: {
            onClick: function (profile, e, src, value) {},
            onClickDrop: function (profile, e, src) {},
            onChecked: function (profile, e, value) {}
        }
    }
});
Class("xui.UI.CheckBox", "xui.UI.Button", {
    Instance: {
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                profile.getSubNode("MARK").tagClass("-checked", !! value)
            })
        },
        _setDirtyMark: function () {
            return arguments.callee.upper.apply(this, ["CAPTION"])
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        _.merge(t.FRAME.FOCUS.TB.TR.TD.BOX, {
            MARK: {
                $order: 0,
                className: "xui-uicmd-check"
            }
        }, "all");
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            KEY: {
                "font-size": "12px",
                "line-height": "14px",
                border: 0,
                cursor: "pointer"
            },
            BORDER: {},
            FOCUS: {
                overflow: "hidden",
                display: "block",
                position: "absolute",
                left: 0,
                top: 0,
                "z-index": "200",
                width: "100%",
                height: "100%",
                "outline-offset": "-1px",
                "-moz-outline-offset": (xui.browser.gek && xui.browser.ver < 3) ? "-1px !important" : null
            },
            BOX: {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                "font-size": "12px",
                "line-height": "14px",
                overflow: "hidden",
                "vertical-align": "middle",
                "white-space": "nowrap"
            },
            TD: {
                background: "transparent"
            },
            TDR: {
                background: "transparent"
            },
            TDL: {
                background: "transparent"
            },
            CAPTION: {
                display: "inline",
                "white-space": "normal",
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle",
                cursor: "pointer",
                zoom: xui.browser.ie ? 0 : null
            }
        },
        Behaviors: {
            HoverEffected: {
                KEY: "MARK"
            },
            ClickEffected: {
                KEY: "MARK"
            },
            onClick: function (profile, e, src) {
                var p = profile.properties,
                    b = profile.boxing();
                if (p.disabled || p.readonly) {
                    return false
                }
                b.setUIValue(!p.$UIvalue);
                if (profile.onChecked) {
                    b.onChecked(profile, p.$UIvalue)
                }
                profile.getSubNode("FOCUS").focus()
            },
            FOCUS: {
                onKeydown: function (profile, e, src) {
                    var key = xui.Event.getKey(e).key;
                    if (key == " " || key == "enter") {
                        profile.getRoot().onClick(true);
                        return false
                    }
                }
            }
        },
        DataModel: {
            type: null,
            value: false,
            hAlign: "left",
            _customBorder: false,
            border: false
        },
        EventHandlers: {
            onClick: null
        },
        _ensureValue: function (profile, value) {
            return !!value
        }
    }
});
Class("xui.UI.Input", ["xui.UI.Widget", "xui.absValue"], {
    Instance: {
        _setTB: function (type) {
            var profile = this.get(0),
                p = profile.properties,
                o, t;
            if (!profile.host || !p.tipsBinder) {
                return
            }
            var ot = profile.tips;
            t = profile.tips = profile.tips || p.tips || "";
            o = xui.getObject(p.tipsBinder) || ((o = profile.host[p.tipsBinder]) && o.get(0));
            if (o && (o.key == "xui.UI.Span" || o.key == "xui.UI.Div" || o.key == "xui.UI.SLabel")) {
                if (o.renderId) {
                    o.getRootNode().innerHTML = t.charAt(0) == "$" ? xui.wrapRes(t) : t;
                    o.getRoot().css("color", type == 1 ? "gray" : type == 2 ? "red" : "#000")
                }
            }
            if (ot !== profile.tips && xui.Tips && xui.Tips.getTips()) {
                xui.Tips.setTips(profile.tips)
            }
        },
        activate: function () {
            var profile = this.get(0);
            if (profile && profile.renderId) {
                var node = profile.getSubNode("INPUT").get(0);
                if (node) {
                    try {
                        node.focus()
                    } catch (e) {}
                }
            }
            return this
        },
        _setCtrlValue: function (value) {
            if (_.isNull(value) || !_.isDefined(value)) {
                value = ""
            }
            return this.each(function (profile) {
                profile.getSubNode("INPUT").attr("value", value + "")
            })
        },
        _getCtrlValue: function () {
            var node = this.getSubNode("INPUT");
            return (node && !node.isEmpty()) ? this.getSubNode("INPUT").attr("value") : null
        },
        _setDirtyMark: function () {
            return this.each(function (profile) {
                var properties = profile.properties,
                    o = profile.getSubNode("INPUT"),
                    cls = profile.box,
                    box = profile.boxing(),
                    d = xui.UI.$css_tag_dirty,
                    v = xui.UI.$css_tag_invalid,
                    flag = properties.value !== properties.$UIvalue;
                var ot = profile.tips;
                if (profile._inValid == 2) {
                    profile.tips = properties.tipsErr || properties.tips
                } else {
                    if (profile._inValid == 1) {
                        profile.tips = properties.tips
                    } else {
                        profile.tips = properties.tipsOK || properties.tips
                    }
                }
                if (ot !== profile.tips && xui.Tips && xui.Tips.getTips()) {
                    xui.Tips.setTips(profile.tips)
                }
                if (profile._dirtyFlag !== flag) {
                    if (properties.dirtyMark && properties.showDirtyMark) {
                        if (profile.beforeDirtyMark && false === box.beforeDirtyMark(profile, flag)) {} else {
                            if (profile._dirtyFlag = flag) {
                                o.addClass(d)
                            } else {
                                o.removeClass(d)
                            }
                        }
                    }
                    profile._dirtyFlag = flag
                }
                if (profile.beforeFormatMark && false === box.beforeFormatMark(profile, profile._inValid == 2)) {} else {
                    var err = profile.getSubNode("ERROR");
                    if (profile._inValid == 2) {
                        o.addClass(v);
                        err.css("display", "block")
                    } else {
                        o.removeClass(v);
                        err.css("display", "none")
                    }
                }
                box._setTB(profile._inValid)
            })
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        _.merge(t.FRAME.BORDER, {
            style: "",
            LABEL: {
                style: "{labelShow};width:{labelSize}px;{labelHAlign}",
                text: "{labelCaption}"
            },
            BOX: {
                WRAP: {
                    tagName: "div",
                    INPUT: {
                        tagName: "input",
                        type: "{_type}",
                        maxlength: "{maxlength}",
                        tabindex: "{tabindex}",
                        style: "{_css};{hAlign};"
                    }
                }
            }
        }, "all");
        t.FRAME.ERROR = {};
        this.setTemplate(t)
    },
    Static: {
        _maskMap: {
            "~": "[+-]",
            "1": "[0-9]",
            a: "[A-Za-z]",
            u: "[A-Z]",
            l: "[a-z]",
            "*": "[A-Za-z0-9]"
        },
        _maskSpace: "_",
        Appearances: {
            KEY: {
                "font-family": '"Verdana", "Helvetica", "sans-serif"',
                position: "relative"
            },
            BORDER: {
                "line-height": "0px",
                "font-size": "0px"
            },
            LABEL: {
                "z-index": 1,
                top: 0,
                left: 0,
                position: "absolute",
                "padding-top": "4px",
                "font-size": "12px"
            },
            WRAP: {
                left: 0,
                position: "absolute",
                overflow: (xui.browser.gek && xui.browser.ver < 3) ? "auto" : "hidden"
            },
            BOX: {
                left: 0,
                top: 0,
                position: "absolute",
                background: xui.UI.$bg("inputbg.gif", "#fff repeat-x", "Input"),
                border: "solid 1px #B5B8C8",
                "z-index": 10
            },
            "KEY-readonly input": {
                $order: 2,
                color: "#909090",
                cursor: "pointer"
            },
            "KEY-readonly BOX, KEY-inputreadonly BOX": {
                $order: 2,
                background: "#eee"
            },
            "BOX-focus, BOX-mouseover": {
                "border-color": "#7EADD9"
            },
            INPUT: {
                "padding-top": "2px",
                "padding-left": "2px",
                "padding-right": "2px",
                "background-color": "transparent",
                "background-image": xui.browser.ie ? "url(.)" : null,
                border: 0,
                margin: 0,
                "margin-top": xui.browser.ie ? "-1px" : null,
                "font-size": "12px",
                position: "relative",
                width: "102px",
                overflow: "auto",
                "overflow-y": "auto",
                "overflow-x": "hidden",
                resize: "none"
            },
            ERROR: {
                width: "9px",
                height: "9px",
                position: "absolute",
                right: "2px",
                top: "2px",
                display: "none",
                "font-size": 0,
                background: xui.UI.$bg("icons.gif", "no-repeat left -244px", true),
                "z-index": "50"
            },
            ".setting-xui-input": {
                "border-style": "solid",
                "border-top-width": "1px",
                "border-bottom-width": "1px",
                "border-left-width": "1px",
                "border-right-width": "1px"
            },
            "KEY-b-t": {
                height: "2px",
                top: "-1px",
                background: xui.UI.$bg("vertical.gif", "repeat-x left top", "Input")
            },
            "KEY-b-b": {
                height: "2px",
                bottom: "-1px",
                background: xui.UI.$bg("vertical.gif", "repeat-x left bottom", "Input")
            },
            "BOX-focus KEY-b-t, BOX-focus KEY-b-b, BOX-mouseover KEY-b-t, BOX-mouseover KEY-b-b": {
                $order: 1,
                "background-image": xui.UI.$bg("vertical_mouseover.gif", "", "Input")
            },
            "KEY-b-l": {
                width: "2px",
                left: "-1px",
                background: xui.UI.$bg("horizontal.gif", "repeat-y left top", "Input")
            },
            "KEY-b-r": {
                width: "2px",
                right: "-1px",
                background: xui.UI.$bg("horizontal.gif", "repeat-y right top", "Input")
            },
            "BOX-focus KEY-b-l, BOX-focus KEY-b-r, BOX-mouseover KEY-b-l, BOX-mouseover KEY-b-r": {
                $order: 1,
                "background-image": xui.UI.$bg("horizontal_mouseover.gif", "", "Input")
            },
            "KEY-b-lt": {
                width: "2px",
                height: "2px",
                left: "-1px",
                top: "-1px",
                background: xui.UI.$bg("corner.gif", "no-repeat left top", "Input")
            },
            "KEY-b-rt": {
                width: "2px",
                height: "2px",
                right: "-1px",
                top: "-1px",
                background: xui.UI.$bg("corner.gif", "no-repeat right top", "Input")
            },
            "KEY-b-rb": {
                width: "2px",
                height: "2px",
                right: "-1px",
                bottom: "-1px",
                background: xui.UI.$bg("corner.gif", "no-repeat right bottom", "Input")
            },
            "KEY-b-lb": {
                width: "2px",
                height: "2px",
                left: "-1px",
                bottom: "-1px",
                background: xui.UI.$bg("corner.gif", "no-repeat left bottom", "Input")
            },
            "BOX-focus KEY-b-lt, BOX-focus KEY-b-rt, BOX-focus KEY-b-rb, BOX-focus KEY-b-lb, BOX-mouseover KEY-b-lt, BOX-mouseover KEY-b-rt, BOX-mouseover KEY-b-rb, BOX-mouseover KEY-b-lb": {
                $order: 1,
                "background-image": xui.UI.$bg("corner_mouseover.gif", "", "Input")
            }
        },
        Behaviors: {
            HoverEffected: {
                BOX: ["BOX"]
            },
            NavKeys: {
                INPUT: 1
            },
            LABEL: {
                onClick: function (profile, e, src) {
                    if (profile.properties.disabled) {
                        return false
                    }
                    if (profile.onLabelClick) {
                        profile.boxing().onLabelClick(profile, e, src)
                    }
                },
                onDblClick: function (profile, e, src) {
                    if (profile.properties.disabled) {
                        return false
                    }
                    if (profile.onLabelDblClick) {
                        profile.boxing().onLabelDblClick(profile, e, src)
                    }
                },
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    if (profile.properties.disabled) {
                        return false
                    }
                    if (profile.onLabelActive) {
                        profile.boxing().onLabelActive(profile, e, src)
                    }
                }
            },
            INPUT: {
                onChange: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.box,
                        o = profile._inValid,
                        value = xui.use(src).get(0).value;
                    profile.boxing().setUIValue(value);
                    p.$UIvalue = value;
                    if (o !== profile._inValid) {
                        if (profile.renderId) {
                            profile.boxing()._setDirtyMark()
                        }
                    }
                    b._asyCheck(profile)
                },
                onKeydown: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.box,
                        m = p.multiLines,
                        evt = xui.Event,
                        k = evt.getKey(e);
                    if (p.disabled || p.readonly) {
                        return
                    }
                    if (k.key == "enter" && (!m || k.altKey)) {
                        xui.use(src).onChange()
                    }
                    b._asyCheck(profile);
                    if (p.mask) {
                        if (k.key.length > 1) {
                            profile.$ignore = true
                        } else {
                            delete profile.$ignore
                        }
                        switch (k.key) {
                        case "backspace":
                            b._changeMask(profile, xui.use(src).get(0), "", false);
                            return false;
                        case "delete":
                            b._changeMask(profile, xui.use(src).get(0), "");
                            return false
                        }
                    }
                },
                onKeypress: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.box,
                        cls = profile.box,
                        map = cls._maskMap,
                        k = xui.Event.getKey(e),
                        t, caret = xui.use(src).caret();
                    if (profile.beforeKeypress && false === profile.boxing().beforeKeypress(profile, caret, k, e, src)) {
                        return false
                    }
                    t = profile.CF.beforeKeypress || profile.$beforeKeypress;
                    if (t && false === t(profile, caret, k, e, src)) {
                        return false
                    }
                    b._asyCheck(profile);
                    if (p.mask) {
                        if (profile.$ignore) {
                            delete profile.$ignore;
                            return true
                        }
                        if (k.ctrlKey || k.altKey) {
                            return true
                        }
                        cls._changeMask(profile, xui.use(src).get(0), k.key, true);
                        return false
                    }
                },
                onKeyup: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.box;
                    if (xui.Event.getKey(e).key == "esc") {
                        profile.boxing().setUIValue(p.value, true);
                        if (profile.onCancel) {
                            profile.boxing().onCancel(profile)
                        }
                    }
                    if (p.dynCheck) {
                        var value = xui.use(src).get(0).value;
                        profile.box._checkValid(profile, value);
                        profile.boxing()._setDirtyMark()
                    }
                    b._asyCheck(profile)
                },
                onMouseup: function (profile, e, src) {
                    if (profile.properties.selectOnFocus && profile._justFocus) {
                        var node = xui.use(src).get(0);
                        if (!node.readOnly && node.select) {
                            _.asyRun(function () {
                                try {
                                    node.select()
                                } catch (e) {}
                            })
                        }
                        delete profile._justFocus
                    }
                },
                onFocus: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.box;
                    if (p.disabled) {
                        return false
                    }
                    if (profile.onFocus) {
                        profile.boxing().onFocus(profile)
                    }
                    profile.getSubNode("BORDER").tagClass("-focus");
                    var node = xui.use(src).get(0);
                    if (p.mask) {
                        var value = node.value;
                        if (!value) {
                            _.asyRun(function () {
                                profile.boxing().setUIValue(value = profile.$Mask);
                                b._setCaret(profile, node)
                            })
                        }
                    }
                    if (p.selectOnFocus && !node.readOnly && node.select) {
                        profile._justFocus = 1;
                        if (xui.browser.kde) {
                            _.asyRun(function () {
                                try {
                                    node.select()
                                } catch (e) {}
                            })
                        } else {
                            try {
                                node.select()
                            } catch (e) {}
                        }
                    }
                    profile.boxing()._setTB(3);
                    b._asyCheck(profile)
                },
                onBlur: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.box;
                    if (p.disabled || p.readonly) {
                        return false
                    }
                    if (profile.onBlur) {
                        profile.boxing().onBlur(profile)
                    }
                    profile.getSubNode("BORDER").tagClass("-focus", false);
                    var value = xui.use(src).get(0).value;
                    if (p.$UIvalue == value) {
                        profile.box._checkValid(profile, value)
                    }
                    profile.boxing()._setDirtyMark();
                    b._asyCheck(profile)
                }
            }
        },
        DataModel: {
            selectable: true,
            _customBorder: "BOX",
            border: false,
            tipsErr: "",
            tipsOK: "",
            dynCheck: false,
            selectOnFocus: true,
            labelSize: {
                ini: 0,
                action: function (v) {
                    this.getSubNode("LABEL").css({
                        display: v ? "" : "none",
                        width: (v || 0) + "px"
                    });
                    xui.UI.$doResize(this, this.properties.width, this.properties.height, true)
                }
            },
            labelPos: {
                ini: "left",
                listbox: ["left", "top", "right", "bottom"],
                action: function (v) {
                    xui.UI.$doResize(this, this.properties.width, this.properties.height, true)
                }
            },
            labelGap: {
                ini: 4,
                action: function (v) {
                    xui.UI.$doResize(this, this.properties.width, this.properties.height, true)
                }
            },
            labelCaption: {
                ini: "",
                action: function (v) {
                    v = (_.isSet(v) ? v : "") + "";
                    this.getSubNode("LABEL").html(xui.adjustRes(v, true))
                }
            },
            labelHAlign: {
                ini: "right",
                listbox: ["", "left", "center", "right"],
                action: function (v) {
                    this.getSubNode("LABEL").css("textAlign", v)
                }
            },
            valueFormat: {
                helpinput: [{
                    caption: "required",
                    id: "[^.*]"
                }, {
                    caption: "email",
                    id: "^[\\w\\.=-]+@[\\w\\.-]+\\.[\\w\\.-]{2,4}$"
                }, {
                    caption: "charOnly",
                    id: "^[a-zA-Z]*$"
                }, {
                    caption: "words",
                    id: "^[\\w ]*$"
                }, {
                    caption: "integer",
                    id: "^-?\\d\\d*$"
                }, {
                    caption: "positiveInteger",
                    id: "^\\d\\d*$"
                }, {
                    caption: "number",
                    id: "^-?(\\d\\d*\\.\\d*$)|(^-?\\d\\d*$)|(^-?\\.\\d\\d*$)"
                }, {
                    caption: "filepath",
                    id: "([\\/]?[\\w_]+)+\\.\\w{1,9}$"
                }, {
                    caption: "URL",
                    id: "^(http|https|ftp)\\:\\/\\/[\\w\\-\\_\\.]+[\\w\\-\\_](:[\\w]*)?\\/?([\\w\\-\\._\\?\\,\\'\\/\\\\\\+&amp;%\\$#\\=~])*$"
                }, {
                    caption: "color",
                    id: "^\\#[0-9A-Fa-f]{6}$"
                }, {
                    caption: "HH:MM",
                    id: "^(([0-1][0-9])|([2][0-3])):([0-5][0-9])$"
                }, {
                    caption: "HH:MM:SS",
                    id: "^(([0-1][0-9])|([2][0-3])):([0-5][0-9])\\:([0-5][0-9])$"
                }, {
                    caption: "YYYY-MM-DD",
                    id: "^([0-9]{4})\\-(([0][0-9])|([1][0-2]))\\-([0-3][0-9])$"
                }, {
                    caption: "DD/MM/YYYY",
                    id: "^(([0-2][0-9])|([3][0-1]))/(([0][0-9])|([1][0-2]))/([0-9]{4})$"
                }]
            },
            mask: {
                action: function (value) {
                    var ns = this,
                        b = ns.box;
                    if (value) {
                        ns.$MaskFormat = function (ns, v) {
                            var m = ns._maskMap,
                                a = [],
                                r = /[A-Za-z0-9]/;
                            _.arr.each(v.split(""), function (o, i) {
                                a.push(m[o] || (r.test(o) ? "" : "\\") + o)
                            });
                            return "^" + a.join("") + "$"
                        }(b, value);
                        ns.$Mask = function (ns, v) {
                            var m = ns._maskMap,
                                a = [],
                                s = ns._maskSpace;
                            _.arr.each(v.split(""), function (o, i) {
                                a.push(m[o] ? s : o)
                            });
                            return a.join("")
                        }(b, value);
                        var uiv = ns.properties.$UIvalue;
                        uiv = _.isSet(uiv) ? (uiv + "") : "";
                        ns.boxing()._setCtrlValue(uiv + ns.$Mask.slice(uiv.length))
                    } else {
                        delete ns.$MaskFormat;
                        delete ns.$Mask
                    }
                }
            },
            value: "",
            width: 120,
            height: 22,
            disabled: {
                ini: false,
                action: function (v) {
                    var i = this.getSubNode("INPUT");
                    if (v) {
                        i.addClass("xui-ui-inputdisabled")
                    } else {
                        i.removeClass("xui-ui-inputdisabled")
                    }
                    if (("" + i.get(0).type).toLowerCase() != "button") {
                        if (!v && this.properties.readonly) {
                            v = true
                        }
                        i.attr("readonly", v)
                    }
                }
            },
            hAlign: {
                ini: "",
                listbox: ["", "left", "center", "right"],
                action: function (v) {
                    this.getSubNode("INPUT").css("textAlign", v)
                }
            },
            readonly: {
                ini: false,
                action: function (v) {
                    var i = this.getSubNode("INPUT"),
                        cls = this.getClass("KEY", "-readonly");
                    if (v) {
                        this.getRoot().addClass(cls)
                    } else {
                        this.getRoot().removeClass(cls)
                    }
                    if (("" + i.get(0).type).toLowerCase() != "button") {
                        if (!v && this.properties.disabled) {
                            v = true
                        }
                        i.attr("readonly", v)
                    }
                }
            },
            type: {
                ini: "text",
                listbox: ["text", "password"],
                set: function (value) {
                    var pro = this;
                    pro.properties.type = value;
                    if (pro.renderId) {
                        pro.boxing().refresh(true)
                    }
                }
            },
            maxlength: {
                ini: "",
                action: function (value) {
                    this.getSubNode("INPUT").attr("maxlength", value)
                }
            },
            multiLines: {
                ini: false,
                action: function (value) {
                    this.boxing().refresh()
                }
            },
            tipsBinder: {
                ini: "",
                set: function (value) {
                    if (value["xui.UIProfile"]) {
                        value = value.$xid
                    }
                    if (value["xui.UI"] && (value = value.get(0))) {
                        value = value.$xid
                    }
                    this.properties.tipsBinder = value + ""
                }
            }
        },
        EventHandlers: {
            onFocus: function (profile) {},
            onBlur: function (profile) {},
            onCancel: function (profile) {},
            beforeFormatCheck: function (profile, value) {},
            beforeFormatMark: function (profile, formatErr) {},
            beforeKeypress: function (profile, caret, keyboard, e, src) {},
            onLabelClick: function (profile, e, src) {},
            onLabelDblClick: function (profile, e, src) {},
            onLabelActive: function (profile, e, src) {}
        },
        _prepareData: function (profile) {
            var d = arguments.callee.upper.call(this, profile);
            d._type = d.type || "";
            if (xui.browser.kde) {
                d._css = "resize:none;"
            }
            d.hAlign = d.hAlign ? ("text-align:" + d.hAlign) : "";
            d.labelHAlign = d.labelHAlign ? ("text-align:" + d.labelHAlign) : "";
            d.labelShow = d.labelSize ? "" : ("display:none");
            if (d.labelCaption) {
                d.labelCaption = xui.adjustRes(d.labelCaption, true)
            }
            return d
        },
        _dynamicTemplate: function (profile) {
            var properties = profile.properties,
                t, hash = profile._exhash = "$multiLines:" + properties.multiLines,
                template = profile.box.getTemplate(hash);
            properties.$UIvalue = properties.value;
            if (!template) {
                template = _.clone(profile.box.getTemplate());
                if (properties.multiLines) {
                    t = template.FRAME.BORDER.BOX.WRAP.INPUT;
                    t.tagName = "textarea";
                    delete t.type
                }
                profile.box.setTemplate(template, hash)
            }
            profile.template = template
        },
        _ensureValue: function (profile, value) {
            return "" + (_.isSet(value) ? value : "")
        },
        RenderTrigger: function () {
            var ns = this,
                p = ns.properties;
            _.asyRun(function () {
                if (ns.box) {
                    ns.boxing()._setTB(1)
                }
            });
            ns.getSubNode("WRAP").$firfox2();
            if (p.readonly) {
                ns.boxing().setReadonly(true, true)
            }
            if (p.tipsBinder) {
                ns.boxing().setTipsBinder(p.tipsBinder, true)
            }
            var ie = xui.browser.ie,
                src = ns.getSubNode("INPUT").get(0),
                b = ns.box,
                f = function (o) {
                    if (ie && ("propertyName" in o) && o.propertyName != "value") {
                        return
                    }
                    b._asyCheck(ns)
                };
            if (ie) {
                src.attachEvent("onpropertychange", f);
                src.attachEvent("ondrop", f);
                ns.$ondestory = function () {
                    var ns = this,
                        src = ns.getSubNode("INPUT").get(0);
                    if (src) {
                        src.detachEvent("onpropertychange", f);
                        src.detachEvent("ondrop", f);
                        src = null
                    }
                }
            } else {
                src.addEventListener("input", f, false);
                src.addEventListener("drop", f, false);
                if (xui.browser.gek) {
                    src.addEventListener("dragdrop", f, false)
                }
                ns.$ondestory = function () {
                    var ns = this,
                        src = ns.getSubNode("INPUT").get(0);
                    if (src) {
                        src.removeEventListener("input", f, false);
                        src.removeEventListener("drop", f, false);
                        if (xui.browser.gek) {
                            src.removeEventListener("dragdrop", f, false)
                        }
                        src = null
                    }
                }
            }
            src = null
        },
        LayoutTrigger: function () {
            var p = this.properties;
            if (p.mask) {
                this.boxing().setMask(p.mask, true)
            }
        },
        _changeMask: function (profile, src, v, dir) {
            var ns = this,
                p = profile.properties,
                map = ns._maskMap,
                ms = ns._maskSpace,
                maskTxt = p.mask,
                maskStr = profile.$Mask,
                input = xui(src),
                caret = input.caret();
            if (dir === false && caret[0] == caret[1] && caret[0] > 0) {
                input.caret(caret[0] - 1, caret[0])
            }
            if (dir === undefined && caret[0] == caret[1]) {
                input.caret(caret[0], caret[0] + 1)
            }
            if (dir === true) {
                if (maskStr.charAt(caret[0]) != ms) {
                    var from = caret[0] + maskStr.substr(caret[0], maskStr.length).indexOf(ms);
                    input.caret(from, Math.max(caret[1], from))
                }
            }
            var caret = input.caret(),
                value = src.value,
                cc = p.mask.charAt(caret[0]),
                reg = ns._maskMap[cc],
                i, t;
            if (reg && v && v.length == 1) {
                if (cc == "l") {
                    v = v.toLowerCase()
                } else {
                    if (cc == "u") {
                        v = v.toUpperCase()
                    }
                }
            }
            if (reg && new RegExp("^" + reg + "$").test(v) || v == "") {
                t = value;
                if (caret[0] != caret[1]) {
                    t = t.substr(0, caret[0]) + maskStr.substr(caret[0], caret[1] - caret[0]) + t.substr(caret[1], t.length - caret[1])
                }
                if (v) {
                    t = t.substr(0, caret[0]) + v + t.substr(caret[0] + 1, t.length - caret[0] - 1)
                }
                var a = [];
                _.arr.each(maskTxt.split(""), function (o, i) {
                    a.push((new RegExp("^" + (map[o] ? map[o] : "\\" + o) + "$").test(t.charAt(i))) ? t.charAt(i) : maskStr.charAt(i))
                });
                if (dir === true) {
                    v = maskStr.substr(caret[0] + 1, value.length - caret[0] - 1);
                    i = v.indexOf(ms);
                    i = caret[0] + (i == -1 ? 0 : i) + 1
                } else {
                    i = caret[0]
                }
                if (xui.browser.opr) {
                    if (dir === undefined) {
                        _.arr.insertAny(a, ms, i)
                    }
                    if (dir === false) {
                        _.arr.insertAny(a, ms, i++)
                    }
                }
                profile.boxing().setUIValue(src.value = a.join(""));
                ns._setCaret(profile, src, i)
            }
        },
        _setCaret: function (profile, src, pos) {
            if (profile.properties.mask) {
                if (typeof pos != "number") {
                    pos = src.value.indexOf(this._maskSpace)
                }
                xui(src).caret(pos, pos)
            }
        },
        _checkValid2: function (profile) {
            if (!profile.renderId) {
                return true
            }
            return this._checkValid(profile, profile.getSubNode("INPUT").get(0).value)
        },
        _checkValid: function (profile, value) {
            var p = profile.properties,
                vf1 = (p.mask && profile.$MaskFormat),
                vf2 = p.valueFormat || profile.$valueFormat;
            if ((profile.beforeFormatCheck && (profile.boxing().beforeFormatCheck(profile, value) === false)) || (((value && value.length) && profile.$Mask !== value) && (vf1 && typeof vf1 == "string" && !(new RegExp(vf1)).test((value === 0 ? "0" : value) || ""))) || (vf2 && typeof vf2 == "string" && !(new RegExp(vf2)).test((value === 0 ? "0" : value) || ""))) {
                profile._inValid = 2;
                return false
            }
            profile._inValid = 3;
            return true
        },
        _asyCheck: function (profile) {
            _.resetRun(profile.$xid + ":asycheck", function () {
                if (!profile.renderId) {
                    return
                }
                var input = profile.getSubNode("INPUT"),
                    src = input.get(0);
                if (!src) {
                    return
                }
                if (profile.properties.dynCheck) {
                    profile.boxing().setUIValue(src.value)
                }
                if (profile.properties.mask) {
                    if (src.value.length != profile.$Mask.length) {
                        profile.box._changeMask(profile, src, "", true)
                    }
                }
            })
        },
        _onresize: function (profile, width, height) {
            var $hborder = 1,
                $vborder = 1,
                toff = xui.UI.$getCSSValue("xui-input-input", "paddingTop"),
                loff = xui.UI.$getCSSValue("xui-input-input", "paddingLeft"),
                roff = xui.UI.$getCSSValue("xui-input-input", "paddingRight");
            var t = profile.properties,
                o = profile.getSubNode("BOX"),
                label = profile.getSubNode("LABEL"),
                labelSize = t.labelSize || 0,
                labelGap = t.labelGap || 0,
                labelPos = t.labelPos || "left",
                v1 = profile.getSubNode("INPUT"),
                ww = width,
                hh = height,
                left = Math.max(0, (t.$b_lw || 0) - $hborder),
                top = Math.max(0, (t.$b_tw || 0) - $vborder);
            if (null !== ww) {
                ww -= Math.max($hborder * 2, (t.$b_lw || 0) + (t.$b_rw || 0));
                if (xui.browser.ie6) {
                    ww = (parseInt(ww / 2, 10)) * 2
                }
            }
            if (null !== hh) {
                hh -= Math.max($vborder * 2, (t.$b_lw || 0) + (t.$b_rw || 0));
                if (xui.browser.ie6) {
                    hh = (parseInt(hh / 2, 10)) * 2
                }
                if (xui.browser.ie6 && null === width) {
                    o.ieRemedy()
                }
            }
            o.cssRegion({
                left: left + (labelPos == "left" ? labelSize : 0),
                top: top + (labelPos == "top" ? labelSize : 0),
                width: ww === null ? null : Math.max(0, (ww - ((labelPos == "left" || labelPos == "right") ? labelSize : 0))),
                height: hh === null ? null : Math.max(0, (hh - ((labelPos == "top" || labelPos == "bottom") ? labelSize : 0)))
            });
            if (labelSize) {
                label.cssRegion({
                    left: ww === null ? null : Math.max(0, labelPos == "right" ? (ww - labelSize + labelGap) : 0),
                    top: height === null ? null : Math.max(0, labelPos == "bottom" ? (height - labelSize + labelGap) : 0),
                    width: ww === null ? null : Math.max(0, ((labelPos == "left" || labelPos == "right") ? (labelSize - labelGap) : ww)),
                    height: height === null ? null : Math.max(0, ((labelPos == "top" || labelPos == "bottom") ? (labelSize - labelGap) : height))
                })
            }
            if (ww || hh) {
                v1.cssSize({
                    width: ww ? Math.max(0, (ww - loff - roff - ((labelPos == "left" || labelPos == "right") ? labelSize : 0))) : null,
                    height: hh ? Math.max(0, (hh - toff - ((labelPos == "top" || labelPos == "bottom") ? labelSize : 0))) : null
                })
            }
            if ((profile.$border || profile.$shadow || profile.$resizer) && xui.browser.ie) {
                o.ieRemedy()
            }
        }
    }
});
Class("xui.UI.ComboInput", "xui.UI.Input", {
    Instance: {
        _adjustV: function (v) {
            var profile = this.get(0),
                p = profile.properties;
            if (profile.$isNumber) {
                v = ("" + v).replace(/[^\d.-]/g, "");
                v = _.isNumb(parseFloat(v)) ? _.toFixedNumber(v, p.precision) : null
            } else {
                if (profile.properties.type == "datepicker" || profile.properties.type == "date" || profile.properties.type == "datetime") {
                    v = _.isDate(v) ? v : _.isFinite(v) ? new Date(parseInt(v, 10)) : null
                }
            }
            return v
        },
        getValue: function () {
            var v = arguments.callee.upper.apply(this, arguments);
            return this._adjustV(v)
        },
        getUIValue: function () {
            var v = arguments.callee.upper.apply(this, arguments);
            return this._adjustV(v)
        },
        _getCtrlValue: function () {
            return this.get(0).properties.$UIvalue
        },
        _setCtrlValue: function (value) {
            var ns = this,
                me = arguments.callee,
                r1 = me._r1 || (me._r1 = /\</),
                r2 = me._r2 || (me._r2 = /\<\/?[^>]+\>/g);
            return this.each(function (profile) {
                if (!profile.$typeOK) {
                    profile.box._iniType(profile)
                }
                var o = profile.getSubNode("INPUT"),
                    type = profile.properties.type;
                value = profile.$_onedit ? ns._toEditor(value) : ns.getShowValue(value);
                if (type !== "none" && type !== "input" && type !== "password" && !profile.properties.multiLines && typeof value == "string" && r1.test(value)) {
                    value = value.replace(r2, "")
                }
                o.attr("value", value || "");
                if (type == "colorpicker" || type == "color") {
                    o.css({
                        backgroundColor: value,
                        color: xui.UI.ColorPicker.getTextColor(value)
                    })
                }
            })
        },
        _compareValue: function (v1, v2) {
            var profile = this.get(0),
                t;
            if (t = profile.CF.compareValue || profile.$compareValue) {
                return t(profile, v1, v2)
            }
            return v1 === v2
        },
        getShowValue: function (value) {
            var profile = this.get(0),
                pro = profile.properties,
                v, t;
            if (!_.isDefined(value)) {
                value = pro.$UIvalue
            }
            if (t = profile.CF.getShowValue || profile.$getShowValue) {
                v = t(profile, value)
            } else {
                if ("listbox" == pro.type) {
                    var list = (pro.listKey) ? xui.UI.getCachedData(pro.listKey) : pro.items;
                    if (list && (t = _.arr.subIndexOf(list, "id", value)) != -1) {
                        v = list[t].caption;
                        if (v.length > 0) {
                            v = v.charAt(0) == "$" ? xui.getRes(v.slice(1)) : v
                        }
                    } else {
                        v = null
                    }
                } else {
                    v = profile.$showValue
                }
            }
            if (!_.isSet(v) && (profile.$inputReadonly || pro.inputReadonly)) {
                v = _.isSet(pro.caption) ? pro.caption : null
            }
            return "" + (_.isSet(v) ? v : _.isSet(value) ? value : "")
        },
        _toEditor: function (value) {
            var profile = this.get(0),
                pro = profile.properties,
                t;
            if (t = profile.CF.toEditor || profile.$toEditor) {
                return t(profile, value)
            }
            return value
        },
        _fromEditor: function (value) {
            var profile = this.get(0),
                pro = profile.properties,
                t;
            if (t = profile.CF.fromEditor || profile.$fromEditor) {
                return t(profile, value)
            }
            return value
        },
        _cache: function (focus) {
            if (this.isDestroyed()) {
                return
            }
            var profile = this.get(0);
            var drop = profile.$drop,
                cached = profile.properties.cachePopWnd;
            if (drop) {
                if (!cached) {
                    drop.boxing().destroy();
                    delete profile.$drop;
                    if (focus) {
                        profile.boxing().activate()
                    }
                } else {
                    if (!profile.__tryToHide) {
                        profile.__tryToHide = _.asyRun(function () {
                            if (!profile.box) {
                                return
                            }
                            delete profile.__tryToHide;
                            if (xui.browser.opr) {
                                drop.getRoot().css("display", "none")
                            }
                            if (drop.boxing()._clearMouseOver) {
                                drop.boxing()._clearMouseOver()
                            }
                            profile.getSubNode("POOL").append(drop.getRoot());
                            if (focus) {
                                profile.boxing().activate()
                            }
                        })
                    }
                }
            }
            delete profile.$poplink;
            return cached
        },
        clearPopCache: function () {
            var profile = this.get(0);
            if (profile.renderId) {
                profile.getSubNode("POOL").empty()
            }
            delete profile.$drop;
            return this
        },
        setUploadObj: function (input) {
            var profile = this.get(0),
                prop = profile.properties,
                c = xui(input).get(0);
            if (c.tagName && c.tagName.toLowerCase() == "input" && c.type == "file") {
                if (profile.renderId && (prop.type == "upload" || prop.type == "file")) {
                    var o = profile.getSubNode("FILE").get(0);
                    xui.setNodeData(c.$xid = o.$xid, "element", c);
                    c.id = o.id;
                    c.onclick = o.onclick;
                    c.onchange = o.onchange;
                    o.$xid = null;
                    o.id = o.onclick = o.onchange = null;
                    delete profile.$_domid[profile.keys.FILE];
                    xui([o]).addPrev(c).remove(false);
                    this.setUIValue(c.value || "")
                }
            }
            return this
        },
        getUploadObj: function () {
            var profile = this.get(0),
                prop = profile.properties;
            if (profile.renderId && (prop.type == "upload" || prop.type == "file")) {
                var o = profile.getSubNode("FILE").get(0);
                if (!o.value) {
                    return null
                }
                var c = o.cloneNode(false);
                c.value = "";
                xui.setNodeData(c.$xid = o.$xid, "element", c);
                c.onclick = o.onclick;
                c.onchange = o.onchange;
                o.$xid = null;
                o.id = o.onclick = o.onchange = null;
                delete profile.$_domid[profile.keys.FILE];
                xui([o]).addPrev(c).remove(false);
                c = null;
                this.setUIValue(this.getValue());
                return o
            }
        },
        resetValue: function (value) {
            this.each(function (p) {
                if (p.properties.type == "upload" || p.properties.type == "file") {
                    p.getSubNode("FILE").attr("value", "")
                }
            });
            return arguments.callee.upper.apply(this, arguments)
        },
        _drop: function (e, src) {
            return this.each(function (profile) {
                var pro = profile.properties,
                    type = pro.type,
                    cacheDrop = pro.cachePopWnd;
                if (pro.disabled || pro.readonly) {
                    return
                }
                if (type == "upload" || type == "file" || type == "none" || type == "input" || type == "password" || type == "spin" || type == "currency" || type == "number") {
                    return
                }
                if (profile.$poplink) {
                    return
                }
                var o, v, box = profile.boxing(),
                    main = profile.getRoot(),
                    pos = main.offset(),
                    size = main.cssSize();
                size.width += 2;
                pos.top += main.offsetHeight();
                if ((profile.beforeComboPop && false === box.beforeComboPop(profile, pos, e, src)) || type == "getter" || type == "cmdbox" || type == "popbox") {
                    return
                }
                if (profile.__tryToHide) {
                    clearTimeout(profile.__tryToHide);
                    delete profile.__tryToHide
                }
                var cachekey;
                if (cacheDrop) {
                    switch (type) {
                    case "timepicker":
                    case "time":
                    case "datepicker":
                    case "date":
                    case "datetime":
                    case "colorpicker":
                    case "color":
                        cachekey = type;
                        break;
                    default:
                        if (pro.listKey) {
                            if (typeof _.get(xui.$cache, ["UIDATA", pro.listKey]) == "function") {
                                profile.$drop = cachekey = null
                            } else {
                                cachekey = "!" + pro.listKey
                            }
                        } else {
                            cachekey = "$" + profile.$xid
                        }
                    }
                    if (cachekey) {
                        _.filter(profile.box.$drop, function (o) {
                            return !!o.renderId
                        });
                        profile.$drop = profile.box.$drop[cachekey]
                    }
                }
                if (!profile.$drop) {
                    switch (type) {
                    case "combobox":
                    case "listbox":
                    case "helpinput":
                        o = xui.create("List").render();
                        o.setHost(profile).setDirtyMark(false).setItems(_.copy(pro.items)).setListKey(pro.listKey || "");
                        o.setWidth(pro.dropListWidth || (pro.width - (pro.labelSize || 0)));
                        if (pro.dropListHeight) {
                            o.setHeight(pro.dropListHeight)
                        } else {
                            o.setHeight("auto")
                        }
                        o.afterClick(function () {
                            if (!this.destroyed) {
                                this.boxing()._cache(true)
                            } else {
                                o.destroy()
                            }
                            return false
                        });
                        o.beforeUIValueSet(function (p, ovalue, value) {
                            var b2 = this.boxing();
                            if (type == "combobox") {
                                var item = p.queryItems(p.properties.items, function (o) {
                                    return o.id == value
                                }, false, true);
                                if (item.length) {
                                    value = item[0].caption
                                }
                            }
                            b2.setUIValue(value);
                            return b2._cache(true)
                        });
                        break;
                    case "time":
                    case "timepicker":
                        o = xui.create("TimePicker").render();
                        o.setHost(profile);
                        o.beforeClose(function () {
                            if (!this.destroyed) {
                                this.boxing()._cache(true)
                            }
                            return false
                        });
                        o.beforeUIValueSet(function (p, o, v) {
                            var b2 = this.boxing();
                            b2.setUIValue(v);
                            return b2._cache(true)
                        });
                        break;
                    case "date":
                    case "datepicker":
                    case "datetime":
                        o = xui.create("DatePicker").render();
                        if (type == "datetime") {
                            o.setTimeInput(true)
                        }
                        o.setHost(profile);
                        o.beforeClose(function () {
                            if (!this.destroyed) {
                                this.boxing()._cache(true)
                            } else {
                                o.destroy()
                            }
                            return false
                        });
                        o.beforeUIValueSet(function (p, o, v) {
                            var b2 = this.boxing();
                            b2.setUIValue(String(v.getTime()));
                            return b2._cache(true)
                        });
                        break;
                    case "color":
                    case "colorpicker":
                        o = xui.create("ColorPicker").render();
                        o.setHost(profile);
                        o.beforeClose(function () {
                            if (!this.destroyed) {
                                this.boxing()._cache(true)
                            } else {
                                o.destroy()
                            }
                            return false
                        });
                        o.beforeUIValueSet(function (p, o, v) {
                            var b2 = this.boxing();
                            b2.setUIValue("#" + v);
                            return b2._cache(true)
                        });
                        break
                    }
                    if (_.isHash(pro.popCtrlProp) && !_.isEmpty(pro.popCtrlProp)) {
                        o.setProperties(pro.popCtrlProp)
                    }
                    if (_.isHash(pro.popCtrlEvents) && !_.isEmpty(pro.popCtrlEvents)) {
                        o.setEvents(pro.popCtrlEvents)
                    }
                    profile.$drop = o.get(0);
                    if (cachekey) {
                        profile.box.$drop[cachekey] = profile.$drop
                    }
                }
                o = profile.$drop.boxing();
                o.setHost(profile);
                switch (type) {
                case "combobox":
                case "listbox":
                case "helpinput":
                case "time":
                case "timepicker":
                    o.setValue(profile.properties.$UIvalue, true);
                    break;
                case "date":
                case "datepicker":
                case "datetime":
                    var t = profile.$drop.properties;
                    if (t = profile.properties.$UIvalue) {
                        o.setValue(new Date(parseInt(t, 10)), true)
                    }
                    break;
                case "color":
                case "colorpicker":
                    o.setValue(profile.properties.$UIvalue.replace("#", ""), true);
                    break
                }
                profile.$poplink = o.get(0);
                if (profile.beforePopShow && false === box.beforePopShow(profile, profile.$drop)) {
                    return
                }
                var node = o.reBoxing();
                node.popToTop(profile.getSubNode("BOX"));
                _.tryF(o.activate, [], o);
                node.setBlurTrigger(profile.key + ":" + profile.$xid, function () {
                    box._cache()
                });
                xui.Event.keyboardHookUp("esc", 0, 0, 0, function () {
                    profile.$escclosedrop = 1;
                    _.asyRun(function () {
                        delete profile.$escclosedrop
                    });
                    box.activate();
                    xui.Event.keyboardHook("esc");
                    box._cache(true)
                });
                if (profile.afterPopShow) {
                    box.afterPopShow(profile, profile.$drop)
                }
            })
        },
        expand: function () {
            var profile = this.get(0);
            if (profile.renderId) {
                profile.boxing()._drop()
            }
        },
        collapse: function () {
            var profile = this.get(0);
            if (profile.renderId && profile.$poplink) {
                profile.boxing()._cache()
            }
        },
        getPopWnd: function (force) {
            var profile = this.get(0);
            if (profile.$drop && (force || profile.$poplink)) {
                return profile.$drop.boxing()
            }
        }
    },
    Initialize: function () {
        this.addTemplateKeys(["FILE", "BTN", "TOP", "MID", "RBTN", "R1", "R1T", "R1B", "R2", "R2T", "R2B"]);
        var t = this.getTemplate();
        _.merge(t.FRAME.BORDER, {
            SBTN: {
                $order: 10,
                style: "{_saveDisplay}",
                STOP: {},
                SMID: {
                    className: "{_commandCls}"
                }
            }
        }, "all");
        t.FRAME.POOL = {};
        t.className += " {typecls}";
        this.setTemplate(t);
        this._adjustItems = xui.absList._adjustItems
    },
    Static: {
        _beforeResetValue: function (profile) {
            profile.properties.caption = undefined
        },
        _iniType: function (profile) {
            var pro = profile.properties,
                type = pro.type,
                c = profile.box;
            delete profile.$beforeKeypress;
            delete profile.$inputReadonly;
            delete profile.$isNumber;
            delete profile.$compareValue;
            delete profile.$getShowValue;
            delete profile.$toEditor;
            delete profile.$fromEditor;
            delete profile.$typeOK;
            if (type == "listbox" || type == "upload" || type == "file" || type == "cmdbox") {
                profile.$inputReadonly = true
            }
            if (type != "listbox" && type != "combobox" && type != "helpinput") {
                pro.items = []
            }
            if (type == "timepicker" || type == "time") {
                var keymap = {
                    a: 1,
                    c: 1,
                    v: 1,
                    x: 1
                };
                _.merge(profile, {
                    $beforeKeypress: function (p, c, k) {
                        return k.key.length != 1 || /[-0-9:]/.test(k.key) || (k.ctrlKey && !! keymap[k.key])
                    },
                    $getShowValue: function (p, v) {
                        return v ? xui.UI.TimePicker._ensureValue(p, v) : ""
                    },
                    $fromEditor: function (p, v) {
                        if (v) {
                            v = xui.UI.TimePicker._ensureValue(p, v);
                            if (v == "00:00") {
                                v = p.properties.$UIvalue
                            }
                        }
                        return v
                    }
                }, "all")
            } else {
                if (type == "datepicker" || type == "date" || type == "datetime") {
                    var date = xui.Date;
                    var keymap = {
                        a: 1,
                        c: 1,
                        v: 1,
                        x: 1
                    };
                    _.merge(profile, {
                        $beforeKeypress: function (p, c, k) {
                            return k.key.length != 1 || /[0-9:/\-_ ]/.test(k.key) || (k.ctrlKey && !! keymap[k.key])
                        },
                        $compareValue: function (p, a, b) {
                            return (!a && !b) || (String(a) == String(b))
                        },
                        $getShowValue: function (p, v) {
                            if (p.properties.dateEditorTpl) {
                                return v ? date.format(v, p.properties.dateEditorTpl) : ""
                            } else {
                                return v ? date.getText(new Date(parseInt(v, 10)), p.properties.type == "datetime" ? "ymdhn" : "ymd") : ""
                            }
                        },
                        $toEditor: function (p, v) {
                            if (!v) {
                                return ""
                            }
                            v = new Date(parseInt(v, 10) || 0);
                            if (p.properties.dateEditorTpl) {
                                return date.format(v, p.properties.dateEditorTpl)
                            } else {
                                var m = (date.get(v, "m") + 1) + "",
                                    d = date.get(v, "d") + "",
                                    h = date.get(v, "h") + "",
                                    n = date.get(v, "n") + "";
                                return date.get(v, "y") + "-" + (m.length == 1 ? "0" : "") + m + "-" + (d.length == 1 ? "0" : "") + d + (p.properties.type == "datetime" ? (" " + (h.length == 1 ? "0" : "") + h + ":" + (n.length == 1 ? "0" : "") + n) : "")
                            }
                        },
                        $fromEditor: function (p, v) {
                            if (v) {
                                if (p.properties.dateEditorTpl) {
                                    v = date.parse(v, p.properties.dateEditorTpl)
                                } else {
                                    v = xui.Date.parse(v)
                                }
                                if (!v) {
                                    v = p.properties.$UIvalue;
                                    if (_.isFinite(v)) {
                                        v = new Date(parseInt(v, 10))
                                    }
                                }
                                if (v) {
                                    if (p.properties.type != "datetime") {
                                        v = date.getTimSpanStart(v, "d", 1)
                                    }
                                    if (v.getFullYear() < p.properties.min) {
                                        v.setTime(p.properties.min)
                                    }
                                    if (v.getFullYear() > p.properties.max) {
                                        v.setTime(p.properties.max)
                                    }
                                }
                            }
                            return v ? String(v.getTime()) : ""
                        }
                    }, "all")
                } else {
                    if (type == "currency") {
                        profile.$isNumber = 1;
                        var keymap = {
                            a: 1,
                            c: 1,
                            v: 1,
                            x: 1
                        };
                        _.merge(profile, {
                            $beforeKeypress: function (p, c, k) {
                                return k.key.length != 1 || /[-0-9,. ]/.test(k.key) || (k.ctrlKey && !! keymap[k.key])
                            },
                            $compareValue: function (p, a, b) {
                                return ((a === "" && b !== "") || (b === "" && a !== "")) ? false : p.box._number(p, a) == p.box._number(p, b)
                            },
                            $getShowValue: function (p, v) {
                                var pp = p.properties;
                                if (_.isSet(v) && v !== "") {
                                    v = _.formatNumeric(p.box._number(p, v), pp.precision, pp.groupingSeparator, pp.decimalSeparator, pp.forceFillZero);
                                    if (p.properties.currencyTpl) {
                                        v = p.properties.currencyTpl.replace("*", v)
                                    }
                                } else {
                                    v = ""
                                }
                                return v
                            },
                            $toEditor: function (p, v) {
                                var pp = p.properties;
                                return (_.isSet(v) && v !== "") ? _.formatNumeric(p.box._number(p, v), pp.precision, pp.groupingSeparator, pp.decimalSeparator, pp.forceFillZero) : ""
                            },
                            $fromEditor: function (p, v) {
                                return (_.isSet(v) && v !== "") ? p.box._number(p, v) : ""
                            }
                        }, "all")
                    } else {
                        if (type == "number" || type == "spin") {
                            profile.$isNumber = 1;
                            var keymap = {
                                a: 1,
                                c: 1,
                                v: 1,
                                x: 1
                            };
                            _.merge(profile, {
                                $beforeKeypress: function (p, c, k) {
                                    return k.key.length != 1 || /[-0-9. ]/.test(k.key) || (k.ctrlKey && !! keymap[k.key])
                                },
                                $compareValue: function (p, a, b) {
                                    return ((a === "" && b !== "") || (b === "" && a !== "")) ? false : p.box._number(p, a) == p.box._number(p, b)
                                },
                                $getShowValue: function (p, v) {
                                    var pp = p.properties;
                                    v = (_.isSet(v) && v !== "") ? _.formatNumeric(p.box._number(p, v), pp.precision, pp.groupingSeparator, pp.decimalSeparator, pp.forceFillZero) : "";
                                    if (p.properties.numberTpl) {
                                        v = p.properties.numberTpl.replace("*", v)
                                    }
                                    return v
                                },
                                $toEditor: function (p, v) {
                                    var pp = p.properties;
                                    return (_.isSet(v) && v !== "") ? _.formatNumeric(p.box._number(p, v), pp.precision, pp.groupingSeparator, pp.decimalSeparator, pp.forceFillZero) : ""
                                },
                                $fromEditor: function (p, v) {
                                    return (_.isSet(v) && v !== "") ? p.box._number(p, v) : ""
                                }
                            }, "all")
                        }
                    }
                }
            }
            if (pro.value) {
                pro.$UIvalue = pro.value = c._ensureValue(profile, pro.value)
            }
            profile.$typeOK = true
        },
        $drop: {},
        Appearances: {
            POOL: {
                position: "absolute",
                left: 0,
                top: 0,
                width: 0,
                height: 0,
                display: "none",
                visibility: "hidden"
            },
            FILE: {
                opacity: 0,
                "*filter": "alpha(opacity=0)",
                "z-index": "3",
                border: 0,
                height: "100%",
                width: "100%",
                position: "absolute",
                top: 0,
                right: 0,
                cursor: "pointer",
                "font-size": "12px",
                overflow: "hidden"
            },
            "KEY-type-number INPUT, KEY-type-spin INPUT, KEY-type-currency INPUT": {
                $order: 4,
                "text-align": "right"
            },
            "KEY-type-file INPUT, KEY-type-cmdbox INPUT, KEY-type-listbox INPUT": {
                $order: 4,
                cursor: "pointer",
                "text-align": "left",
                overflow: "hidden"
            },
            "KEY-type-file BOX, KEY-type-cmdbox BOX, KEY-type-listbox BOX": {
                $order: 4,
                background: xui.UI.$bg("inputbgb.gif", "#fff left bottom repeat-x", "Input")
            },
            "RBTN,SBTN,BTN": {
                display: "block",
                "z-index": "1",
                cursor: "pointer",
                width: "16px",
                height: "20px",
                "font-size": 0,
                "line-height": 0,
                position: "absolute"
            },
            SBTN: {
                $order: 2,
                "z-index": "6"
            },
            "SBTN,BTN,R1,R2": {
                "margin-top": "2px"
            },
            "R1, R2, BTN, SBTN, STOP, TOP, R1T, R2T, R1B, R2B, SMID,MID": {
                background: xui.UI.$bg("bg.gif")
            },
            "SBTN, BTN": {
                $order: 1,
                "background-position": "left bottom"
            },
            "R1,R2": {
                $order: 1,
                display: "block",
                "font-size": 0,
                "line-height": 0,
                cursor: "pointer",
                width: "16px",
                position: "absolute",
                height: "50%",
                "background-position": "left bottom",
                "margin-top": "2px"
            },
            R1: {
                top: 0
            },
            R2: {
                bottom: "-2px"
            },
            "BTN-mouseover, SBTN-mouseover, R1-mouseover, R2-mouseover": {
                $order: 2,
                "background-position": "-16px bottom"
            },
            "BTN-mousedown, SBTN-mousedown, R1-mousedown, R2-mousedown": {
                $order: 3,
                "background-position": "-32px bottom"
            },
            "STOP, TOP, R1T, R2T": {
                $order: 1,
                cursor: "pointer",
                width: "16px",
                "font-size": 0,
                "line-height": 0,
                position: "absolute",
                top: "-2px",
                left: 0,
                height: "4px",
                "background-position": "left -104px"
            },
            "BTN-mouseover TOP,SBTN-mouseover STOP, R1-mouseover R1T, R2-mouseover R2T": {
                $order: 2,
                "background-position": "-16px -104px"
            },
            "BTN-mousedown TOP,SBTN-mousedown STOP, R1-mousedown R1T, R2-mousedown R2T": {
                $order: 3,
                "background-position": "-32px -104px"
            },
            "R1B,R2B": {
                cursor: "pointer",
                width: "16px",
                "font-size": 0,
                "line-height": 0,
                position: "absolute",
                left: 0,
                top: "50%",
                "margin-top": "-4px",
                height: "6px",
                "z-index": 2
            },
            R1B: {
                $order: 1,
                "background-position": "-14px -36px"
            },
            R2B: {
                $order: 1,
                "background-position": "left -5px"
            },
            "SMID,MID": {
                $order: 2,
                cursor: "pointer",
                width: "16px",
                "font-size": 0,
                "line-height": 0,
                position: "absolute",
                bottom: "0",
                left: 0,
                height: "16px"
            },
            SMID: {
                $order: 3,
                "background-position": "-16px -16px"
            },
            "SMID-save": {
                $order: 8,
                "background-position": "-32px 0"
            },
            "SMID-delete": {
                $order: 8,
                "background-position": "-32px -16px"
            },
            "SMID-add": {
                $order: 8,
                "background-position": "-32px -32px"
            },
            "SMID-remove": {
                $order: 8,
                "background-position": "-32px -48px"
            },
            "SMID-select": {
                $order: 8,
                "background-position": "left -16px"
            },
            "SMID-pop": {
                $order: 8,
                "background-position": "-32px -64px"
            },
            ".setting-xui-comboinput": {
                "border-style": "solid",
                "border-top-width": "1px",
                "border-bottom-width": "1px",
                "border-left-width": "1px",
                "border-right-width": "1px"
            }
        },
        _objectProp: {
            tagVar: 1,
            popCtrlProp: 1,
            popCtrlEvents: 1
        },
        Behaviors: {
            HoverEffected: {
                BOX: "BOX",
                BTN: "BTN",
                SBTN: "SBTN",
                R1: "R1",
                R2: "R2"
            },
            ClickEffected: {
                BTN: "BTN",
                SBTN: "SBTN",
                R1: "R1",
                R2: "R2"
            },
            FILE: {
                onClick: function (profile, e, src) {
                    var prop = profile.properties;
                    if (prop.disabled || prop.readonly) {
                        return
                    }
                    if (profile.onFileDlgOpen) {
                        profile.boxing().onFileDlgOpen(profile, src)
                    }
                },
                onChange: function (profile, e, src) {
                    profile.boxing().setUIValue(xui.use(src).get(0).value + "")
                }
            },
            BTN: {
                onClick: function (profile, e, src) {
                    var prop = profile.properties;
                    if (prop.type == "popbox" || prop.type == "getter") {
                        if (profile.onClick && false === profile.boxing().onClick(profile, e, src, prop.$UIvalue)) {
                            return
                        }
                    }
                    if (prop.disabled || prop.readonly) {
                        return
                    }
                    profile.boxing()._drop(e, src);
                    return false
                }
            },
            SBTN: {
                onClick: function (profile, e, src) {
                    var prop = profile.properties;
                    if (prop.disabled || prop.readonly) {
                        return
                    }
                    if (profile.onCommand) {
                        profile.boxing().onCommand(profile, src)
                    }
                }
            },
            BOX: {
                onClick: function (profile, e, src) {
                    var prop = profile.properties;
                    if (prop.type == "cmdbox") {
                        if (profile.onClick) {
                            profile.boxing().onClick(profile, e, src, prop.$UIvalue)
                        }
                    } else {
                        if (prop.inputReadonly || profile.$inputReadonly) {
                            if (prop.disabled || prop.readonly) {
                                return
                            }
                            profile.boxing()._drop(e, src)
                        }
                    }
                }
            },
            INPUT: {
                onChange: function (profile, e, src) {
                    if (profile.$_onedit || profile.$_inner) {
                        return
                    }
                    var o = profile._inValid,
                        b = profile.box,
                        instance = profile.boxing(),
                        v = instance._fromEditor(xui.use(src).get(0).value),
                        uiv = profile.properties.$UIvalue;
                    if (!instance._compareValue(uiv, v)) {
                        profile.$_inner = 1;
                        delete profile.$_inner;
                        if (v === null) {
                            instance._setCtrlValue(uiv)
                        } else {
                            instance.setUIValue(v);
                            profile.properties.$UIvalue = v;
                            if (o !== profile._inValid) {
                                if (profile.renderId) {
                                    instance._setDirtyMark()
                                }
                            }
                        }
                    }
                    b._asyCheck(profile)
                },
                onKeyup: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.box,
                        key = xui.Event.getKey(e);
                    if (p.disabled || p.readonly) {
                        return false
                    }
                    if (profile.$inputReadonly || p.inputReadonly) {
                        return
                    }
                    if (key.key == "esc") {
                        if (profile.$escclosedrop) {
                            return
                        }
                        profile.$_onedit = true;
                        profile.boxing().setUIValue(p.value, true);
                        profile.$_onedit = false;
                        if (profile.onCancel) {
                            profile.boxing().onCancel(profile)
                        }
                    }
                    if (p.dynCheck) {
                        var value = xui.use(src).get(0).value;
                        profile.box._checkValid(profile, value);
                        profile.boxing()._setDirtyMark()
                    }
                    b._asyCheck(profile);
                    if (key.key == "down" || key.key == "up") {
                        if (p.type == "spin") {
                            xui.Thread.abort(profile.$xid + ":spin");
                            return false
                        }
                    }
                },
                onMouseup: function (profile, e, src) {
                    if (profile.properties.selectOnFocus && profile._justFocus) {
                        var node = xui.use(src).get(0);
                        if (!node.readOnly && node.select) {
                            _.asyRun(function () {
                                try {
                                    node.select()
                                } catch (e) {}
                            })
                        }
                        delete profile._justFocus
                    }
                },
                onFocus: function (profile, e, src) {
                    var p = profile.properties,
                        b = profile.box;
                    if (p.disabled || p.readonly) {
                        return false
                    }
                    if (profile.onFocus) {
                        profile.boxing().onFocus(profile)
                    }
                    if (profile.$inputReadonly || p.inputReadonly) {
                        return
                    }
                    profile.getSubNode("BORDER").tagClass("-focus");
                    var instance = profile.boxing(),
                        uiv = p.$UIvalue,
                        v = instance._toEditor(uiv),
                        node = xui.use(src).get(0);
                    if (node.value !== v) {
                        profile.$_onedit = true;
                        node.value = v;
                        delete profile.$_onedit
                    }
                    if (p.mask) {
                        var value = node.value;
                        if (!value) {
                            _.asyRun(function () {
                                if (!profile.box) {
                                    return
                                }
                                profile.boxing().setUIValue(value = profile.$Mask);
                                b._setCaret(profile, node)
                            })
                        }
                    }
                    if (p.selectOnFocus && !node.readOnly && node.select) {
                        profile._justFocus = 1;
                        if (xui.browser.kde) {
                            _.asyRun(function () {
                                try {
                                    node.select()
                                } catch (e) {}
                            })
                        } else {
                            try {
                                node.select()
                            } catch (e) {}
                        }
                    }
                    profile.boxing()._setTB(3)
                },
                onBlur: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return false
                    }
                    if (profile.onBlur) {
                        profile.boxing().onBlur(profile)
                    }
                    if (profile.$inputReadonly || p.inputReadonly) {
                        return
                    }
                    var b = profile.box,
                        instance = profile.boxing(),
                        uiv = p.$UIvalue,
                        v = instance._fromEditor(xui.use(src).get(0).value);
                    profile.getSubNode("BORDER").tagClass("-focus", false);
                    if (instance._compareValue(p.$UIvalue, v)) {
                        profile.box._checkValid(profile, v);
                        instance._setCtrlValue(uiv)
                    }
                    instance._setDirtyMark();
                    b._asyCheck(profile)
                },
                onKeydown: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var b = profile.box,
                        m = p.multiLines,
                        evt = xui.Event,
                        k = evt.getKey(e);
                    if (k.key == "enter" && (!m || k.altKey) && !p.inputReadonly && !profile.$inputReadonly) {
                        profile.$_onedit = true;
                        profile.boxing().setUIValue(profile.boxing()._fromEditor(xui.use(src).get(0).value), true);
                        profile.$_onedit = false
                    }
                    b._asyCheck(profile);
                    if (p.mask) {
                        if (k.key.length > 1) {
                            profile.$ignore = true
                        } else {
                            delete profile.$ignore
                        }
                        switch (k.key) {
                        case "backspace":
                            b._changeMask(profile, xui.use(src).get(0), "", false);
                            return false;
                        case "delete":
                            b._changeMask(profile, xui.use(src).get(0), "");
                            return false
                        }
                    }
                    if (k.key == "down" || k.key == "up") {
                        if (p.type == "spin") {
                            if (!k.ctrlKey) {
                                profile.box._spin(profile, k.key == "up");
                                return false
                            }
                        } else {
                            if (k.ctrlKey && p.type != "none" && p.type != "input" && p.type != "password") {
                                profile.boxing()._drop(e, src);
                                return false
                            }
                        }
                    }
                }
            },
            R1: {
                onMousedown: function (profile) {
                    var prop = profile.properties;
                    if (prop.disabled || prop.readonly) {
                        return
                    }
                    profile.box._spin(profile, true)
                },
                onMouseout: function (profile) {
                    xui.Thread.abort(profile.$xid + ":spin")
                },
                onMouseup: function (profile) {
                    xui.Thread.abort(profile.$xid + ":spin")
                }
            },
            R2: {
                onMousedown: function (profile) {
                    var prop = profile.properties;
                    if (prop.disabled || prop.readonly) {
                        return
                    }
                    profile.box._spin(profile, false)
                },
                onMouseout: function (profile) {
                    xui.Thread.abort(profile.$xid + ":spin")
                },
                onMouseup: function (profile) {
                    xui.Thread.abort(profile.$xid + ":spin")
                }
            }
        },
        EventHandlers: {
            onFileDlgOpen: function (profile, src) {},
            onCommand: function (profile, src) {},
            beforeComboPop: function (profile, pos, e, src) {},
            beforePopShow: function (profile, popCtl) {},
            afterPopShow: function (profile, popCtl) {},
            onClick: function (profile, e, src, value) {}
        },
        _posMap: {
            none: "",
            currency: "",
            number: "",
            combobox: "left top",
            listbox: "left top",
            file: "-16px top",
            getter: "left -31px",
            helpinput: "-16px -46px",
            cmdbox: "left -16px",
            popbox: "left -46px",
            time: "left -60px",
            date: "left -75px",
            color: "-16px -60px",
            timepicker: "left -60px",
            datepicker: "left -75px",
            datetime: "left -75px",
            colorpicker: "-16px -60px"
        },
        DataModel: {
            cachePopWnd: true,
            dateEditorTpl: "",
            precision: 2,
            groupingSeparator: ",",
            decimalSeparator: ".",
            forceFillZero: true,
            popCtrlProp: {
                ini: {}
            },
            popCtrlEvents: {
                ini: {}
            },
            numberTpl: {
                ini: "",
                action: function () {
                    this.boxing().setUIValue(this.properties.$UIvalue, true)
                }
            },
            currencyTpl: {
                ini: "$ *",
                action: function () {
                    this.boxing().setUIValue(this.properties.$UIvalue, true)
                }
            },
            listKey: {
                set: function (value) {
                    var t = xui.UI.getCachedData(value),
                        o = this;
                    o.boxing().setItems(t ? _.clone(t) : o.properties.items);
                    o.properties.listKey = value
                }
            },
            dropListWidth: 0,
            dropListHeight: 0,
            items: {
                ini: [],
                set: function (value) {
                    var o = this;
                    value = o.properties.items = o.box._adjustItems(value);
                    if (o.renderId) {
                        o.SubSerialIdMapItem = {};
                        o.ItemIdMapSubSerialId = {};
                        o.box._prepareItems(o, value);
                        if (o.$poplink) {
                            o.$poplink.boxing().setItems(value)
                        } else {
                            o.boxing().clearPopCache()
                        }
                    }
                }
            },
            btnImage: {
                action: function (value) {
                    this.getSubNode("MID").css("backgroundImage", "url(" + (value || "") + ")")
                }
            },
            btnImagePos: {
                action: function (value) {
                    this.getSubNode("MID").css("backgroundPosition", value)
                }
            },
            type: {
                ini: "combobox",
                listbox: _.toArr("none,input,password,combobox,listbox,file,getter,helpinput,cmdbox,popbox,date,time,datetime,color,spin,currency,number"),
                set: function (value) {
                    var pro = this;
                    pro.properties.type = value;
                    if (pro.renderId) {
                        pro.boxing().refresh(true)
                    }
                }
            },
            increment: 0.01,
            min: -Math.pow(10, 15),
            max: Math.pow(10, 15),
            commandBtn: {
                ini: "none",
                listbox: _.toArr("none,save,delete,add,remove,pop,select,custom"),
                action: function (v) {
                    this.boxing().refresh()
                }
            },
            disabled: {
                ini: false,
                action: function (v) {
                    var i = this.getSubNode("INPUT");
                    if (v) {
                        i.addClass("xui-ui-inputdisabled")
                    } else {
                        i.removeClass("xui-ui-inputdisabled")
                    }
                    if (("" + i.get(0).type).toLowerCase() != "button") {
                        if (!v && (this.properties.readonly || this.$inputReadonly)) {
                            v = true
                        }
                        i.attr("readonly", v)
                    }
                }
            },
            inputReadonly: {
                ini: false,
                action: function (v) {
                    var n = this.getSubNode("INPUT"),
                        cls = this.getClass("KEY", "-inputreadonly");
                    if (v) {
                        this.getRoot().addClass(cls)
                    } else {
                        this.getRoot().removeClass(cls)
                    }
                    if (!v && (this.properties.disabled || this.properties.readonly || this.$inputReadonly)) {
                        v = true
                    }
                    n.attr("readonly", v).css("cursor", v ? "pointer" : "")
                }
            },
            readonly: {
                ini: false,
                action: function (v) {
                    var n = this.getSubNode("INPUT"),
                        cls = this.getClass("KEY", "-readonly");
                    if (v) {
                        this.getRoot().addClass(cls)
                    } else {
                        this.getRoot().removeClass(cls)
                    }
                    if (!v && (this.properties.disabled || this.properties.inputReadonly || this.$inputReadonly)) {
                        v = true
                    }
                    n.attr("readonly", v).css("cursor", v ? "pointer" : "")
                }
            },
            caption: {
                ini: null,
                set: function (v, force) {
                    var p = this.properties;
                    p.caption = v;
                    if (_.isSet(v)) {
                        v = v + "";
                        p.caption = xui.adjustRes(v, false)
                    }
                    if (this.renderId) {
                        if (this.$inputReadonly || p.inputReadonly) {
                            this.getSubNode("INPUT").attr("value", this.boxing().getShowValue())
                        }
                    }
                },
                get: function () {
                    return this.boxing().getShowValue()
                }
            }
        },
        RenderTrigger: function () {
            var self = this,
                instance = self.boxing(),
                p = self.properties;
            self.box._iniType(self);
            if (p.readonly) {
                instance.setReadonly(true, true)
            } else {
                if (p.inputReadonly) {
                    instance.setInputReadonly(true, true)
                }
            }
        },
        _spin: function (profile, flag) {
            var id = profile.$xid + ":spin";
            if (xui.Thread.isAlive(id)) {
                return
            }
            var prop = profile.properties,
                off = prop.increment * (flag ? 1 : -1),
                task = {
                    delay: 300
                },
                fun = function () {
                    var v = ((+prop.$UIvalue) || 0) + off;
                    v = (_.isSet(v) && v !== "") ? _.formatNumeric(profile.box._number(profile, v), prop.precision, prop.groupingSeparator, prop.decimalSeparator, prop.forceFillZero) : "";
                    profile.boxing().setUIValue(v);
                    task.delay *= 0.9
                };
            task.task = fun;
            xui.Thread(id, [task], 500, null, fun, null, true).start()
        },
        _dynamicTemplate: function (profile) {
            var properties = profile.properties,
                hash = profile._exhash = "$multiLines:" + properties.multiLines + ";type:" + properties.type + ";",
                template = profile.box.getTemplate(hash);
            properties.$UIvalue = properties.value;
            if (!template) {
                template = _.clone(profile.box.getTemplate());
                var t = template.FRAME.BORDER;
                switch (properties.type) {
                case "none":
                case "input":
                case "currency":
                case "number":
                    t.BOX.WRAP.INPUT.tagName = "input";
                    break;
                case "password":
                    t.BOX.WRAP.INPUT.tagName = "input";
                    t.BOX.WRAP.INPUT.type = "password";
                    break;
                case "spin":
                    t.RBTN = {
                        $order: 20,
                        style: "{rDisplay}",
                        R1: {
                            R1T: {},
                            R1B: {}
                        },
                        R2: {
                            R2T: {},
                            R2B: {}
                        }
                    };
                    break;
                case "upload":
                case "file":
                    t.FILE = {
                        $order: 20,
                        tagName: "input",
                        type: "file",
                        hidefocus: xui.browser.ie ? "hidefocus" : null,
                        size: "1"
                    };
                case "listbox":
                case "cmdbox":
                    t.BOX.WRAP.INPUT.tagName = "input";
                    t.BOX.WRAP.INPUT.type = "button";
                default:
                    t.BTN = {
                        $order: 20,
                        style: "{_popbtnDisplay}",
                        TOP: {},
                        MID: {
                            style: "{_btnStyle}"
                        }
                    }
                }
                if (properties.multiLines) {
                    switch (properties.type) {
                    case "none":
                    case "input":
                    case "getter":
                    case "helpinput":
                    case "popbox":
                    case "number":
                    case "combobox":
                        t.BOX.WRAP.INPUT.tagName = "textarea";
                        delete t.BOX.WRAP.INPUT.type
                    }
                }
                profile.box.setTemplate(template, hash)
            }
            profile.template = template
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile),
                map = profile.box._posMap;
            if (map[data.type]) {
                data._btnStyle = data.btnImage ? ("background: url(" + data.btnImage + ")" + (data.btnImagePos || "")) : ("background-position:" + map[data.type])
            }
            data._type = "text";
            data._saveDisplay = data.commandBtn != "none" ? "" : "display:none";
            data._commandCls = profile.getClass("SMID", "-" + data.commandBtn);
            data._popbtnDisplay = (data.type != "none" && data.type != "input" && data.type != "password") ? "" : "display:none";
            data.typecls = profile.getClass("KEY", "-type-" + (data.type == "colorpicker" ? "color" : data.type == "datepicker" ? "date" : data.type == "timepicker" ? "time" : data.type == "upload" ? "file" : data.type));
            return data
        },
        _ensureValue: function (profile, value) {
            var me = arguments.callee,
                reg = me._reg || (me._reg = /^#[\w]{6}$/),
                prop = profile.properties;
            if (!_.isSet(value) || value === "") {
                return ""
            }
            switch (profile.properties.type) {
            case "date":
            case "datepicker":
            case "datetime":
                var d;
                if (value) {
                    if (_.isDate(value)) {
                        d = value
                    } else {
                        if (_.isFinite(value)) {
                            d = new Date(parseInt(value, 10))
                        } else {
                            d = xui.Date.parse(value + "")
                        }
                    }
                }
                return d ? String(profile.properties.type == "datetime" ? d.getTime() : xui.Date.getTimSpanStart(d, "d", 1).getTime()) : "";
            case "color":
            case "colorpicker":
                var c = xui.UI.ColorPicker._ensureValue(null, value);
                return (c !== "transparent" ? "#" : "") + c;
            case "time":
            case "timepicker":
                return xui.UI.TimePicker._ensureValue(null, value);
            case "currency":
            case "number":
            case "spin":
                return this._number(profile, value);
            default:
                return typeof value == "string" ? value : (value || value === 0) ? String(value) : ""
            }
        },
        _number: function (profile, value) {
            var prop = profile.properties;
            value = _.toNumeric(value, prop.precision, prop.groupingSeparator, prop.decimalSeparator, prop.forceFillZero);
            if (_.isSet(prop.max)) {
                value = value > prop.max ? prop.max : value
            }
            if (_.isSet(prop.min)) {
                value = value < prop.min ? prop.min : value
            }
            return value
        },
        _onresize: function (profile, width, height) {
            var f = function (k) {
                    return k ? profile.getSubNode(k).get(0) : null
                },
                v1 = f("INPUT"),
                isB = v1.type.toLowerCase() == "button",
                $hborder = 1,
                $vborder = 1,
                toff = isB ? 0 : xui.UI.$getCSSValue("xui-comboinput-input", "paddingTop"),
                loff = isB ? 0 : xui.UI.$getCSSValue("xui-comboinput-input", "paddingLeft"),
                roff = isB ? 0 : xui.UI.$getCSSValue("xui-comboinput-input", "paddingRight");
            var t = profile.properties,
                o = profile.getSubNode("BOX"),
                label = profile.getSubNode("LABEL"),
                labelSize = t.labelSize || 0,
                labelGap = t.labelGap || 0,
                labelPos = t.labelPos || "left",
                px = "px",
                commandbtn = f(t.commandBtn != "none" ? "SBTN" : null),
                functionbtn = f(t.type == "spin" ? "RBTN" : (t.type == "none" || t.type == "input" || t.type == "password") ? null : "BTN"),
                ww = width,
                hh = height,
                bw1 = 0,
                bw2 = 0,
                left = Math.max(0, (t.$b_lw || 0) - $hborder),
                top = Math.max(0, (t.$b_tw || 0) - $vborder);
            if (null !== ww) {
                ww -= Math.max($hborder * 2, (t.$b_lw || 0) + (t.$b_rw || 0));
                bw1 = (commandbtn ? commandbtn.offsetWidth : 0);
                bw2 = (functionbtn ? functionbtn.offsetWidth : 0);
                ww -= (bw1 + bw2);
                if (xui.browser.ie6) {
                    ww = (parseInt(ww / 2, 10)) * 2
                }
            }
            if (null !== hh) {
                hh -= Math.max($vborder * 2, (t.$b_lw || 0) + (t.$b_rw || 0));
                if (xui.browser.ie6) {
                    hh = (parseInt(hh / 2, 10)) * 2
                }
                if (xui.browser.ie6 && null === width) {
                    o.ieRemedy()
                }
            }
            var iL = left + (labelPos == "left" ? labelSize : 0),
                iT = top + (labelPos == "top" ? labelSize : 0),
                iW = ww === null ? null : Math.max(0, ww - ((labelPos == "left" || labelPos == "right") ? labelSize : 0)),
                iH = hh === null ? null : Math.max(0, hh - ((labelPos == "top" || labelPos == "bottom") ? labelSize : 0)),
                iH2 = hh === null ? null : Math.max(0, height - ((labelPos == "top" || labelPos == "bottom") ? labelSize : 0));
            if (null !== iW && iW - loff - roff > 0) {
                v1.style.width = Math.max(0, iW - loff - roff) + px
            }
            if (null !== iH && iH - toff > 0) {
                v1.style.height = Math.max(0, iH - toff) + px
            }
            o.cssRegion({
                left: iL,
                top: iT,
                width: iW,
                height: iH
            });
            if (labelSize) {
                label.cssRegion({
                    left: ww === null ? null : labelPos == "right" ? (ww - labelSize + labelGap + bw1 + bw2 + $hborder * 2) : 0,
                    top: height === null ? null : labelPos == "bottom" ? (height - labelSize + labelGap) : 0,
                    width: ww === null ? null : Math.max(0, ((labelPos == "left" || labelPos == "right") ? (labelSize - labelGap) : ww)),
                    height: height === null ? null : Math.max(0, ((labelPos == "top" || labelPos == "bottom") ? (labelSize - labelGap) : height))
                })
            }
            iL += (iW || 0) + $hborder * 2;
            if (commandbtn) {
                if (iH2 !== null) {
                    commandbtn.style.height = Math.max(0, iH2 - 2) + px
                }
                if (iW !== null) {
                    commandbtn.style.left = iL + px
                }
                commandbtn.style.top = iT + px
            }
            iL += bw1;
            if (functionbtn) {
                if (iH2 !== null) {
                    functionbtn.style.height = Math.max(0, iH2 - 2) + px
                }
                if (iW !== null) {
                    functionbtn.style.left = iL + px
                }
                functionbtn.style.top = iT + px;
                if (iH2 !== null && t.type == "spin") {
                    if (iH2 / 2 - 2 > 0) {
                        f("R1").style.height = (iH2 / 2 - 2) + px;
                        f("R2").style.height = (iH2 / 2 - 2) + px
                    }
                }
            }
            if ((profile.$border || profile.$shadow || profile.$resizer) && xui.browser.ie) {
                o.ieRemedy()
            }
        }
    }
});
Class("xui.UI.RichEditor", ["xui.UI", "xui.absValue"], {
    Initialize: function () {
        this.addTemplateKeys(["TOOLBARBTN"])
    },
    Instance: {
        _setCtrlValue: function (value) {
            if (!_.isSet(value)) {
                value = ""
            }
            return this.each(function (profile) {
                var doc = profile.$doc,
                    body = doc && (doc.body || doc.documentElement);
                if (body) {
                    var sp = window["/"];
                    if (sp && sp.indexOf(":/") != -1) {
                        value = value.replace(/{\/}/g, sp)
                    }
                    body.innerHTML = xui.adjustRes(value, 0, 1)
                }
            })
        },
        _getCtrlValue: function () {
            var profile = this.get(0),
                doc = profile.$doc,
                body = doc && (doc.body || doc.documentElement);
            if (body) {
                var v = body.innerHTML,
                    sp = window["/"];
                if (sp && sp.indexOf(":/") != -1) {
                    v = v.replace(new RegExp(sp, "g"), "{/}")
                }
                return v
            }
            return ""
        }
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            EDITOR: {
                tagName: "div"
            },
            POOL: {}
        },
        DataModel: {
            selectable: true,
            value: "",
            width: 400,
            height: 300,
            cmdList: {
                ini: "font1;font2;align;list;font4;font3;insert;clear;html",
                action: function (v) {
                    var ns = this;
                    if (!ns.properties.disabled && !ns.properties.readonly) {
                        ns.box._iniToolBar(ns)
                    }
                }
            },
            disabled: {
                ini: false,
                action: function (disabled) {
                    var disabled = this.properties.disabled || this.properties.readonly,
                        doc = this.$doc;
                    if (doc) {
                        if (doc.body.contentEditable != undefined && xui.browser.ie) {
                            doc.body.contentEditable = disabled ? "false" : "true"
                        } else {
                            doc.designMode = disabled ? "off" : "on"
                        }
                        this.box._iniToolBar(this, !disabled)
                    }
                }
            },
            readonly: {
                ini: false,
                action: function (v) {
                    this.boxing().setDisabled(v)
                }
            }
        },
        Appearances: {
            POOL: {
                position: "absolute",
                display: "none"
            },
            TOOLBARBTN: {
                background: xui.UI.$bg("toolbar.gif", "no-repeat")
            },
            EDITOR: {
                position: "absolute",
                display: "block",
                left: 0,
                top: 0,
                width: "100%",
                height: "100%",
                padding: 0,
                margin: 0,
                border: "1px solid #648CB4",
                "background-color": "#fff",
                "z-index": "0"
            }
        },
        Behaviors: {
            onSize: xui.UI.$onSize
        },
        $cmds: {
            font1: [{
                id: "bold",
                command: "Bold",
                statusButton: true,
                imagePos: "-36px 0"
            }, {
                id: "italic",
                command: "Italic",
                statusButton: true,
                imagePos: "-108px 0"
            }, {
                id: "underline",
                command: "Underline",
                statusButton: true,
                imagePos: "-324px 0"
            }, {
                id: "strikethrough",
                command: "strikeThrough",
                statusButton: true,
                imagePos: "-252px 0"
            }],
            font2: [{
                id: "subscript",
                command: "subscript",
                statusButton: true,
                imagePos: "-270px 0"
            }, {
                id: "superscript",
                command: "superscript",
                statusButton: true,
                imagePos: "-288px 0"
            }],
            font3: [{
                id: "forecolor",
                command: "custom",
                imagePos: "0 0"
            }, {
                id: "bgcolor",
                command: "custom",
                imagePos: "-18px 0"
            }],
            font4: [{
                id: "fontsize",
                command: "custom",
                caption: "$editor.fontsize",
                dropButton: true
            }, {
                id: "fontname",
                command: "custom",
                caption: "$editor.fontname",
                dropButton: true
            }, {
                id: "formatblock",
                command: "custom",
                caption: "$editor.formatblock",
                dropButton: true
            }],
            align: [{
                id: "left",
                command: "justifyleft",
                imagePos: "-144px 0"
            }, {
                id: "center",
                command: "justifycenter",
                imagePos: "-54px 0"
            }, {
                id: "right",
                command: "justifyright",
                imagePos: "-216px 0"
            }, {
                id: "justify",
                command: "justifyfull",
                imagePos: "-126px 0"
            }],
            list: [{
                id: "indent",
                command: "indent",
                imagePos: "-90px 0"
            }, {
                id: "outdent",
                command: "outdent",
                imagePos: "-180px 0"
            }, {
                id: "ol",
                command: "insertorderedlist",
                imagePos: "-162px 0"
            }, {
                id: "ul",
                command: "insertunorderedlist",
                imagePos: "-306px 0"
            }],
            insert: [{
                id: "hr",
                command: "insertHorizontalRule",
                imagePos: "-72px 0"
            }, {
                id: "insertimage",
                command: "custom",
                imagePos: "-342px 0"
            }, {
                id: "createlink",
                command: "custom",
                imagePos: "-360px 0"
            }, {
                id: "unlink",
                command: "unlink",
                imagePos: "-378px 0"
            }],
            clear: [{
                id: "removeformat",
                command: "removeformat",
                imagePos: "-198px 0"
            }],
            html: [{
                id: "html",
                command: "custom",
                imagePos: "-234px 0"
            }]
        },
        _updateToolbar: function (domId, clear) {
            var profile = xui.$cache.profileMap[domId],
                toolbar;
            if (!profile) {
                return
            }
            if (profile.properties.disabled || profile.properties.readonly) {
                return
            }
            if (profile && (toolbar = profile.$toolbar)) {
                var doc = profile.$doc,
                    bold = clear ? false : doc.queryCommandState("bold"),
                    italic = clear ? false : doc.queryCommandState("italic"),
                    underline = clear ? false : doc.queryCommandState("underline"),
                    strikethrough = clear ? false : doc.queryCommandState("strikethrough"),
                    subscript = clear ? false : doc.queryCommandState("subscript"),
                    superscript = clear ? false : doc.queryCommandState("superscript"),
                    tb = toolbar.boxing();
                tb.updateItem("bold", {
                    value: bold
                });
                tb.updateItem("italic", {
                    value: italic
                });
                tb.updateItem("underline", {
                    value: underline
                });
                tb.updateItem("strikethrough", {
                    value: strikethrough
                });
                tb.updateItem("subscript", {
                    value: subscript
                });
                tb.updateItem("superscript", {
                    value: superscript
                });
                doc = null
            }
        },
        RenderTrigger: function () {
            var self = this;
            if (!self.properties.disabled && !self.properties.readonly) {
                self.box._iniToolBar(self)
            }
            if (!self.$inDesign) {
                var div = self.getSubNode("EDITOR").get(0),
                    domId = self.$domId,
                    id = div.id;
                if (!self.$once) {
                    self.$once = true;
                    try {
                        var iframe = self.$ifr = document.createElement("IFRAME")
                    } catch (e) {
                        var iframe = self.$ifr = document.createElement("<iframe name='" + id + "' id='" + id + "'></iframe>")
                    }
                    var kprf = this,
                        event = self._event = function (e) {
                            if (kprf && (kprf.properties.disabled || kprf.properties.readonly)) {
                                return
                            }
                            _.resetRun("RichEditor:" + domId, function () {
                                if (!kprf.box) {
                                    return
                                }
                                xui.UI.RichEditor._updateToolbar(domId)
                            }, 100);
                            if (e.type == "mousedown") {
                                xui.doc.onMousedown(true)
                            }
                        },
                        _focus = function (e) {
                            if (!kprf) {
                                return
                            }
                            if (kprf.properties.disabled || kprf.properties.readonly) {
                                return
                            }
                            kprf.box._onchange(kprf)
                        },
                        _blur = function (e) {
                            if (!kprf) {
                                return
                            }
                            if (kprf.properties.disabled || kprf.properties.readonly) {
                                return
                            }
                            _.resetRun("RichEditor:" + domId, function () {
                                if (!kprf.box) {
                                    return
                                }
                                xui.UI.RichEditor._updateToolbar(domId, true)
                            }, 100);
                            if (kprf._onchangethread) {
                                clearInterval(kprf._onchangethread);
                                kprf._onchangethread = null;
                                if (kprf && kprf.box) {
                                    kprf.box._checkc(kprf)
                                }
                            }
                        },
                        gekfix = function (e) {
                            if (kprf) {
                                var ins = kprf.boxing();
                                _.asyRun(function () {
                                    if (!kprf.box) {
                                        return
                                    }
                                    ins.refresh()
                                })
                            }
                        },
                        doc, win, checkF = function () {
                            setTimeout(function () {
                                if (!frames[id]) {
                                    return
                                }
                                if (!frames[id].document) {
                                    return
                                }
                                if (self.$win != frames[id].window) {
                                    win = self.$win = frames[id].window;
                                    doc = self.$doc = win.document;
                                    doc.open();
                                    doc.write('<html style="overflow: auto; -webkit-overflow-scrolling: touch;padding:0;margin:0;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"> <style type="text/css">body{height: 100%;overflow: auto; -webkit-overflow-scrolling: touch;border:0;margin:0;padding:0;margin:0;cursor:text;background:#fff;color:#000;font-size:12px;}p{margin:0;padding:0;} div{margin:0;padding:0;}</style></head><body scroll="auto" spellcheck="false"></body></html>');
                                    doc.close();
                                    try {
                                        doc.execCommand("styleWithCSS", 0, false)
                                    } catch (e) {
                                        try {
                                            doc.execCommand("useCSS", 0, true)
                                        } catch (e) {}
                                    }
                                    var disabled = self.properties.disabled || self.properties.readonly;
                                    if (doc.body.contentEditable != undefined && xui.browser.ie) {
                                        doc.body.contentEditable = disabled ? "false" : "true"
                                    } else {
                                        doc.designMode = disabled ? "off" : "on"
                                    }
                                    if (disabled) {
                                        self.box._iniToolBar(self, false)
                                    }
                                    win._gekfix = gekfix;
                                    if (xui.browser.ie) {
                                        doc.attachEvent("unload", gekfix);
                                        if (!disabled) {
                                            doc.attachEvent("onmousedown", event);
                                            doc.attachEvent("ondblclick", event);
                                            doc.attachEvent("onclick", event);
                                            doc.attachEvent("onkeyup", event);
                                            doc.attachEvent("onkeydown", event);
                                            win.attachEvent("onfocus", _focus);
                                            win.attachEvent("onblur", _blur);
                                            (self.$beforeDestroy = (self.$beforeDestroy || {}))["ifmClearMem"] = function () {
                                                var win = this.$win,
                                                    doc = this.$doc,
                                                    event = this._event;
                                                if (this._onchangethread) {
                                                    clearInterval(this._onchangethread);
                                                    this._onchangethread = null
                                                }
                                                try {
                                                    var status = doc.designMode;
                                                    doc.designMode = "off";
                                                    doc.designMode = "on";
                                                    doc.designMode = status
                                                } catch (e) {}
                                                win._gekfix = undefined;
                                                try {
                                                    doc.detachEvent("unload", win._gekfix)
                                                } catch (e) {}
                                                if (!this.properties.disabled && !this.properties.readonly) {
                                                    doc.detachEvent("onmousedown", event);
                                                    doc.detachEvent("ondblclick", event);
                                                    doc.detachEvent("onclick", event);
                                                    doc.detachEvent("onkeyup", event);
                                                    doc.detachEvent("onkeydown", event);
                                                    win.detachEvent("onfocus", _focus);
                                                    win.detachEvent("onblur", _blur)
                                                }
                                                win = doc = event = null
                                            }
                                        }
                                    } else {
                                        var prf = self;
                                        if (xui.browser.opr || !win.addEventListener) {
                                            prf.$repeatT = xui.Thread.repeat(function () {
                                                if (!frames[id]) {
                                                    return false
                                                } else {
                                                    if (!prf.$win.document || !prf.$win.document.defaultView) {
                                                        prf.boxing().refresh()
                                                    }
                                                }
                                            }, 99)
                                        } else {
                                            win.addEventListener("unload", gekfix, false)
                                        }
                                        if (!disabled) {
                                            doc.addEventListener("mousedown", event, false);
                                            doc.addEventListener("dblclick", event, false);
                                            doc.addEventListener("click", event, false);
                                            doc.addEventListener("keyup", event, false);
                                            if (xui.browser.gek || !win.addEventListener) {
                                                doc.addEventListener("focus", _focus, false);
                                                doc.addEventListener("blur", _blur, false);
                                                doc.addEventListener("keypress", event, false)
                                            } else {
                                                win.addEventListener("focus", _focus, false);
                                                win.addEventListener("blur", _blur, false);
                                                doc.addEventListener("keydown", event, false)
                                            }
                                        }(self.$beforeDestroy = (self.$beforeDestroy || {}))["ifmClearMem"] = function () {
                                            var win = this.$win,
                                                doc = this.$doc,
                                                ifr = this.$ifr,
                                                event = this._event;
                                            if (xui.browser.opr) {
                                                if (prf.$repeatT) {
                                                    prf.$repeatT.abort()
                                                }
                                            }
                                            if (ifr.detachEvent) {
                                                ifr.detachEvent("onload", checkF)
                                            } else {
                                                ifr.onload = null
                                            }
                                            try {
                                                win.removeEventListener("unload", win._gekfix, false)
                                            } catch (e) {}
                                            win._gekfix = undefined;
                                            delete frames[this.$frameId];
                                            if (!this.properties.disabled && !this.properties.readonly && doc.removeEventListener) {
                                                doc.removeEventListener("mousedown", event, false);
                                                doc.removeEventListener("dblclick", event, false);
                                                doc.removeEventListener("click", event, false);
                                                doc.removeEventListener("keyup", event, false);
                                                if (xui.browser.gek || !win.removeEventListener) {
                                                    doc.removeEventListener("focus", _focus, false);
                                                    doc.removeEventListener("blur", _blur, false);
                                                    doc.removeEventListener("keypress", event, false)
                                                } else {
                                                    win.removeEventListener("focus", _focus, false);
                                                    win.removeEventListener("blur", _blur, false);
                                                    doc.removeEventListener("keydown", event, false)
                                                }
                                            }
                                            prf = gekfix = event = win = doc = null
                                        }
                                    }
                                    self.boxing()._setCtrlValue(self.properties.$UIvalue || "");
                                    iframe.style.visibility = ""
                                }
                            })
                        };
                    self.$frameId = id;
                    iframe.id = iframe.name = id;
                    iframe.className = div.className;
                    iframe.src = "about:blank";
                    iframe.frameBorder = 0;
                    iframe.border = 0;
                    iframe.scrolling = "no";
                    iframe.marginWidth = 0;
                    iframe.marginHeight = 0;
                    iframe.tabIndex = -1;
                    iframe.allowTransparency = "allowtransparency";
                    iframe.style.visibility = "hidden";
                    xui.$cache.domPurgeData[iframe.$xid = div.$xid].element = iframe;
                    div.parentNode.replaceChild(iframe, div);
                    if (iframe.attachEvent) {
                        iframe.attachEvent("onload", checkF)
                    } else {
                        iframe.onload = checkF
                    }
                }
            }
        },
        _checkc: function (profile) {
            if (profile && profile.$doc) {
                var doc = profile.$doc,
                    body = doc && (doc.body || doc.documentElement);
                if (!profile.__oldv) {
                    profile.__oldv = body.innerHTML
                }
                if (body.innerHTML != profile.__oldv) {
                    profile.__oldv = body.innerHTML;
                    profile.boxing().onChange(profile)
                }
            }
        },
        _onchange: function (profile) {
            if (profile.onChange) {
                if (profile._onchangethread) {
                    clearInterval(profile._onchangethread);
                    profile._onchangethread = null
                }
                profile._onchangethread = setInterval(function () {
                    if (profile && profile.box) {
                        profile.box._checkc(profile)
                    }
                }, 500)
            }
        },
        _clearPool: function (profile) {
            profile.getSubNode("POOL").empty();
            profile.$colorPicker = profile.$fontsizeList = profile.$fontnameList = profile.$formatblockList = profile.$htmlEditor = null
        },
        _iniToolBar: function (profile, flag) {
            var self = profile,
                pro = self.properties,
                tbH;
            if (self.$toolbar) {
                self.$toolbar.boxing().destroy();
                delete self._$tb;
                delete self.$toolbar
            }
            if (flag !== false) {
                var t, v, o, items = [],
                    imageClass = self.getClass("TOOLBARBTN"),
                    arr = pro.cmdList.split(";"),
                    h = {};
                _.arr.each(arr, function (i) {
                    if ((o = self.box.$cmds[i]) && !h[i]) {
                        h[i] = 1;
                        items.push({
                            id: i,
                            sub: o
                        });
                        _.arr.each(o, function (v) {
                            if (v.imagePos) {
                                v.imageClass = imageClass
                            }
                            v.tips = xui.wrapRes("editor." + v.id)
                        })
                    }
                });
                self.getRoot().prepend(t = new xui.UI.ToolBar({
                    selectable: false,
                    handler: false,
                    items: items,
                    disabled: pro.disabled || pro.readonly
                }));
                t.render(true);
                profile.$_tbH = tbH = t.getRoot().height();
                if (xui.browser.ie) {
                    t.getRoot().query("*").attr("unselectable", "on")
                }
                t = self._$tb = t.get(0);
                t.onClick = self.box._toolbarclick;
                v = self._$composed = {};
                v[t.$xid] = t;
                self.$toolbar = t;
                t.$hostage = self
            }
            xui.UI.$tryResize(profile, pro.width, pro.height, true);
            return tbH
        },
        _toolbarclick: function (profile, item, group, e, src) {
            var editor = profile.$hostage;
            if (!editor.$doc) {
                return
            }
            var pro = editor.properties,
                first;
            editor.$win.focus();
            if (item.command == "custom") {
                var cmd = item.id,
                    o, _clear, node, items, items2;
                switch (cmd) {
                case "forecolor":
                case "bgcolor":
                    if (!editor.$colorPicker) {
                        first = true;
                        editor.$colorPicker = (new xui.UI.ColorPicker({
                            selectable: false,
                            barDisplay: false
                        })).render(true)
                    }
                    o = editor.$colorPicker;
                    break;
                case "fontsize":
                case "fontname":
                case "formatblock":
                    if (editor.$lang != xui.getLang()) {
                        editor.box._clearPool(editor)
                    }
                    editor.$lang = xui.getLang();
                    if (cmd == "fontsize") {
                        if (!editor.$fontsizeList) {
                            items = xui.getRes("editor.fontsizeList");
                            items = items.split(";");
                            items2 = [];
                            var t;
                            _.arr.each(items, function (o) {
                                o = o.split(",");
                                t = o[0] == "..." ? "1" : o[0];
                                items2.push({
                                    id: o[0],
                                    caption: '<font size="' + o[0] + '" ' + xui.$IEUNSELECTABLE() + ">" + o[1] + "</font>"
                                })
                            });
                            first = true;
                            editor.$fontsizeList = (new xui.UI.List({
                                selectable: false,
                                height: "auto",
                                items: items2,
                                width: 150
                            })).render(true)
                        }
                        o = editor.$fontsizeList
                    } else {
                        if (cmd == "fontname") {
                            if (!editor.$fontnameList) {
                                items = xui.getRes("editor.fontnameList");
                                items = items.split(";");
                                items2 = [];
                                var t;
                                _.arr.each(items, function (o) {
                                    t = o == "..." ? "" : o;
                                    items2.push({
                                        id: o,
                                        caption: '<span style="font-family:' + o + '" ' + xui.$IEUNSELECTABLE() + ">" + o + "</span>"
                                    })
                                });
                                first = true;
                                editor.$fontnameList = (new xui.UI.List({
                                    selectable: false,
                                    height: "auto",
                                    items: items2
                                })).render(true)
                            }
                            o = editor.$fontnameList
                        } else {
                            if (cmd == "formatblock") {
                                if (!editor.$formatblockList) {
                                    items = xui.getRes("editor.formatblockList");
                                    items = items.split(";");
                                    items2 = [];
                                    var t;
                                    _.arr.each(items, function (o) {
                                        o = o.split(",");
                                        t = o[0] == "..." ? "span" : o[0];
                                        items2.push({
                                            id: o[0],
                                            caption: "<" + t + ' style="display:inline;padding:0;margin:0" ' + xui.$IEUNSELECTABLE() + ">" + o[1] + "</" + t + ">"
                                        })
                                    });
                                    first = true;
                                    editor.$formatblockList = (new xui.UI.List({
                                        selectable: false,
                                        height: "auto",
                                        items: items2
                                    })).render(true)
                                }
                                o = editor.$formatblockList
                            }
                        }
                    }
                    break;
                case "html":
                    if (!editor.$htmlEditor) {
                        first = true;
                        editor.$htmlEditor = new xui.UI.Input({
                            multiLines: true,
                            width: 400,
                            height: 300,
                            resizer: true
                        })
                    }
                    o = editor.$htmlEditor;
                    break
                }
                if (o) {
                    _clear = function () {
                        o.beforeUIValueSet(null);
                        editor.getSubNode("POOL").append(o.getRoot());
                        node.setBlurTrigger(editor.$xid);
                        xui.Event.keyboardHook("esc");
                        _.asyRun(function () {
                            if (!editor || !editor.$win) {
                                return
                            }
                            editor.$win.focus()
                        })
                    };
                    o.setValue("", true);
                    node = o.reBoxing();
                    node.popToTop(src);
                    if (first && xui.browser.ie) {
                        o.getRoot().query("*").attr("unselectable", "on")
                    }
                    _.tryF(o.activate, [], o);
                    node.setBlurTrigger(editor.$xid, function () {
                        if (o == editor.$htmlEditor) {
                            o.setUIValue(o._getCtrlValue())
                        }
                        _clear()
                    });
                    xui.Event.keyboardHook("esc", 0, 0, 0, function () {
                        _clear()
                    }, null, null, prfile.domId)
                }
                switch (cmd) {
                case "forecolor":
                case "bgcolor":
                    o.beforeUIValueSet(function (p, o, v) {
                        _clear();
                        var doc = editor.$doc;
                        if (cmd == "bgcolor" && xui.browser.gek) {
                            doc.execCommand("useCSS", 0, false);
                            doc.execCommand("hilitecolor", false, "#" + v);
                            doc.execCommand("useCSS", 0, true)
                        } else {
                            if (cmd == "bgcolor") {
                                cmd = xui.browser.opr ? "hilitecolor" : "backcolor"
                            }
                            doc.execCommand(cmd, false, xui.browser.kde ? ("#" + v) : v)
                        }
                        doc = null;
                        return false
                    });
                    break;
                case "fontsize":
                case "fontname":
                case "formatblock":
                    o.beforeUIValueSet(function (p, o, v) {
                        _clear();
                        if (xui.browser.ie && (v == "..." || cmd == "formatblock")) {
                            var selection = editor.$doc.selection,
                                range = selection ? selection.createRange() : null;
                            if (range && range.parentElement().ownerDocument != editor.$doc) {
                                range = selection = null
                            }
                        }
                        var f = function (cmd, v) {
                                var doc = editor.$doc;
                                if (range) {
                                    editor.$win.focus();
                                    if (cmd == "formatblock" && v) {
                                        var p = range.parentElement(),
                                            html;
                                        if (p.ownerDocument == doc) {
                                            if (/^\s*</.test(range.htmlText)) {
                                                range.collapse(true);
                                                p = range.parentElement();
                                                if (p.tagName == "BODY") {
                                                    html = p.innerHTML;
                                                    p.innerHTML = "<" + v + ">" + html + "</" + v + ">"
                                                } else {
                                                    html = p.outerHTML;
                                                    html = html.replace(/\<[\w]+/, "<" + v).replace(/[\w]+\>$/, v + ">");
                                                    p.outerHTML = html
                                                }
                                            } else {
                                                range.pasteHTML("<" + v + ">" + range.htmlText + "</" + v + ">")
                                            }
                                        }
                                        p = null
                                    }
                                    range.select();
                                    selection = range = null
                                }
                                doc.execCommand(cmd, false, v);
                                doc = null
                            };
                        if (v == "...") {
                            var str = xui.getRes("editor." + cmd);
                            xui.UI.Dialog.prompt(str, str, "", function (v) {
                                if (v) {
                                    f(cmd, v)
                                }
                            }, function () {
                                if (xui.browser.ie) {
                                    if (range) {
                                        editor.$win.focus();
                                        range.select()
                                    }
                                    selection = range = null
                                }
                            })
                        } else {
                            f(cmd, v)
                        }
                    });
                    break;
                case "insertimage":
                case "createlink":
                    var str = xui.getRes("editor." + cmd),
                        str2 = xui.getRes("editor." + cmd + "2");
                    if (xui.browser.ie) {
                        var selection = editor.$doc.selection,
                            range = selection ? selection.createRange() : null;
                        if (range && range.parentElement().ownerDocument != editor.$doc) {
                            range = selection = null
                        }
                    }
                    xui.UI.Dialog.prompt(str, str2, "http://", function (v) {
                        if (xui.browser.ie) {
                            if (range) {
                                editor.$win.focus();
                                range.select()
                            }
                            selection = range = null
                        }
                        if (v) {
                            var doc = editor.$doc;
                            doc.execCommand(cmd, false, xui.adjustRes(v, 0, 1));
                            doc = null
                        }
                    }, function () {
                        if (xui.browser.ie) {
                            if (range) {
                                editor.$win.focus();
                                range.select()
                            }
                            selection = range = null
                        }
                    });
                    break;
                case "html":
                    o.setValue(editor.boxing().getUIValue(), true);
                    o.beforeUIValueSet(function (p, o, v) {
                        _clear();
                        editor.boxing().setUIValue(v)
                    });
                    break
                }
            } else {
                editor.$doc.execCommand(item.command, false, item.commandArgs);
                if (item.id == "removeformat") {
                    xui.UI.RichEditor._updateToolbar(editor.$domId, true)
                }
            }
        },
        _ensureValue: function (profile, value) {
            var p = xui.$getGhostDiv();
            p.innerHTML = (_.isSet(value) ? value : "") + "";
            value = p.innerHTML;
            p.innerHTML = "";
            return value
        },
        _onresize: function (profile, width, height) {
            var size = {},
                _top = 0;
            if (width || height) {
                var itb = profile._$tb,
                    tbh;
                if (itb) {
                    tbh = itb.getRoot().height();
                    if (tbh) {
                        profile.$_tbH = tbh
                    } else {
                        tbh = profile.$_tbH
                    }
                }
                _top = (itb ? (tbh - 1) : 0);
                if (!height) {
                    height = profile.properties.height
                }
                size.height = height - _top - 2;
                if (width) {
                    size.width = width - 2
                }
            }
            if (size.width < 0) {
                size.width = 0
            }
            if (size.height < 0) {
                size.height = 0
            }
            profile.getSubNode("EDITOR").top(_top).cssSize(size, true)
        }
    }
});
Class("xui.UI.Group", "xui.UI.Div", {
    Instance: {
        activate: function () {
            var profile = this.get(0);
            profile.getSubNode("HANDLE").focus();
            return this
        },
        resetPanelView: function (destroyChildren) {
            if (!_.isSet(destroyChildren)) {
                destroyChildren = true
            }
            var ins;
            return this.each(function (profile) {
                if (profile.renderId) {
                    delete profile.$ini;
                    ins = profile.boxing();
                    ins.removeChildren(true, destroyChildren);
                    if (profile.properties.toggle) {
                        ins.setToggle(false)
                    }
                }
            })
        }
    },
    Static: {
        Behaviors: {
            NavKeys: {
                CAPTION: 1
            },
            HoverEffected: {
                TOGGLE: "TOGGLE"
            },
            ClickEffected: {
                TOGGLE: "TOGGLE"
            },
            DroppableKeys: ["PANEL"],
            PanelKeys: ["PANEL"],
            DraggableKeys: ["HANDLE"],
            onSize: xui.UI.$onSize,
            HANDLE: {
                onClick: function (profile, e, src) {
                    if (profile.properties.toggleBtn) {
                        profile.box._toggle(profile, !profile.properties.toggle);
                        return false
                    }
                },
                onKeydown: function (profile, e, src) {
                    if (xui.Event.getKey(e).key == "enter") {
                        xui(src).onClick()
                    }
                }
            }
        },
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            FIELDSET: {
                tagName: "fieldset",
                className: " {toggleCls}",
                LEGEND: {
                    tagName: "legend",
                    HANDLE: {
                        tabindex: "{tabindex}",
                        TOGGLE: {
                            className: "xui-uicmd-toggle2 {toggleCls2}",
                            style: "{toggleDispplay}"
                        },
                        ICON: {
                            $order: 1,
                            className: "xui-ui-icon {imageClass}",
                            style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                        },
                        CAPTION: {
                            text: "{caption}",
                            $order: 2
                        }
                    }
                },
                PANEL: {
                    $order: 1,
                    tagName: "div",
                    style: "{panelDisplay};{_overflow};",
                    text: "{html}" + xui.UI.$childTag
                }
            }
        },
        Appearances: {
            KEY: {
                zoom: xui.browser.ie6 ? "1" : null
            },
            FIELDSET: {
                border: "1px solid #7ba3cb",
                position: "relative",
                overflow: "hidden",
                zoom: xui.browser.ie6 ? "1" : null
            },
            "FIELDSET-checked": {
                $order: 2,
                "padding-left": "2px",
                "border-left": "0",
                "border-right": "0",
                "border-bottom": "0"
            },
            LEGEND: {
                "margin-left": "3px"
            },
            HANDLE: {
                cursor: "default",
                padding: "0 3px 0 6px",
                display: xui.$inlineBlock
            },
            PANEL: {
                position: "relative",
                overflow: "auto",
                "line-height": "1",
                background: xui.browser.ie ? "url(" + xui.ini.img_bg + ") no-repeat left top" : null
            },
            "FIELDSET-checked PANEL": {
                $order: 4,
                display: "none"
            },
            CAPTION: {
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle",
                "font-family": '"Verdana", "Helvetica", "sans-serif"',
                "font-size": "12px",
                "line-height": "18px"
            }
        },
        DataModel: {
            selectable: true,
            caption: {
                ini: undefined,
                action: function (v) {
                    v = (_.isSet(v) ? v : "") + "";
                    this.getSubNode("CAPTION").html(xui.adjustRes(v, true))
                }
            },
            html: {
                action: function (v) {
                    this.getSubNode("PANEL").html(xui.adjustRes(v, 0, 1))
                }
            },
            toggleBtn: {
                ini: true,
                action: function (v) {
                    this.getSubNode("TOGGLE").css("display", v ? "" : "none")
                }
            },
            toggle: {
                ini: true,
                action: function (v) {
                    this.box._toggle(this, v)
                }
            },
            image: {
                format: "image",
                action: function (value) {
                    this.getSubNode("ICON").css("display", value ? "" : "none").css("backgroundImage", "url(" + xui.adjustRes(value || "") + ")")
                }
            },
            imagePos: {
                action: function (value) {
                    this.getSubNode("ICON").css("backgroundPosition", value)
                }
            }
        },
        LayoutTrigger: function () {
            var self = this,
                t = self.properties,
                b = self.box;
            if (t.toggle) {
                b._toggle(self, t.toggle)
            }
        },
        EventHandlers: {
            onIniPanelView: function (profile) {},
            beforeFold: function (profile) {},
            beforeExpand: function (profile) {},
            afterFold: function (profile) {},
            afterExpand: function (profile) {}
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile),
                nodisplay = "display:none";
            data.toggleDispplay = data.toggleBtn ? "" : nodisplay;
            data.panelDisplay = data.toggleBtn && !data.toggle ? nodisplay : "";
            data.toggleCls = data.toggleBtn && !data.toggle ? profile.getClass("FIELDSET", "-checked") : "";
            data.toggleCls2 = data.toggleBtn && data.toggle ? "xui-uicmd-toggle2-checked" : "";
            profile._toggle = !! data.toggle;
            return data
        },
        _onresize: function (profile, width, height) {
            if (height && height != "auto") {
                profile.getSubNode("FIELDSET").height(height);
                profile.getSubNode("PANEL").height(height - (profile.getSubNode("LEGEND").height() || 18))
            }
            if (width && width != "auto") {
                profile.getSubNode("PANEL").width(width - 2)
            }
        },
        _toggle: function (profile, value) {
            var p = profile.properties,
                ins = profile.boxing();
            if (value && !profile.$ini) {
                if (ins.onIniPanelView) {
                    if (ins.onIniPanelView(profile) !== false) {
                        profile.$ini = true
                    }
                    if (p.iframeAutoLoad || p.ajaxAutoLoad) {
                        xui.UI.Div._applyAutoLoad(profile)
                    }
                }
            }
            if (profile._toggle !== !! value) {
                profile._toggle = p.toggle = !! value;
                if (value) {
                    if (ins.beforeExpand && false === ins.beforeExpand(profile)) {
                        return
                    }
                } else {
                    if (ins.beforeFold && false === ins.beforeFold(profile)) {
                        return
                    }
                }
                profile.getSubNode("PANEL").css("display", value ? "" : "none");
                if (p.toggleBtn) {
                    profile.getSubNode("TOGGLE").tagClass("-checked", !! value)
                }
                profile.getSubNode("FIELDSET").tagClass("-checked", !value);
                profile.getRoot().height(p.toggle ? p.height : "auto");
                profile.getSubNode("FIELDSET").height(p.toggle ? p.height : "auto");
                if (value) {
                    if (ins.afterExpand) {
                        ins.afterExpand(profile)
                    }
                } else {
                    if (ins.afterFold) {
                        ins.afterFold(profile)
                    }
                }
            }
        }
    }
});
Class("xui.UI.ColorPicker", ["xui.UI", "xui.absValue"], {
    Instance: {
        activate: function () {
            this.getSubNode("TOGGLE").focus();
            return this
        },
        _setCtrlValue: function (value, inner) {
            return this.each(function (profile) {
                if (!profile.renderId) {
                    return
                }
                var cls = profile.box,
                    p = profile.properties,
                    hex = profile.$hex = cls._to3(value),
                    hexs = profile.$hex.join(""),
                    rgb = profile.$rgb = cls.hex2rgb(value),
                    hsv = profile.$hsv = cls.rgb2hsv(rgb),
                    f = function (s, v) {
                        profile.getSubNode(s).get(0).firstChild.nodeValue = String(v)
                    },
                    ff = function (v) {
                        return parseInt(v * 100, 10)
                    };
                f("R", rgb[0]);
                f("G", rgb[1]);
                f("B", rgb[2]);
                f("H", hex[0]);
                f("E", hex[1]);
                f("X", hex[2]);
                if (profile.$hexinhsv != hexs) {
                    f("HH", hsv[0]);
                    f("S", ff(hsv[1]));
                    f("V", ff(hsv[2]));
                    delete profile.$hexinhsv
                }
                cls._setClrName(profile, hexs);
                cls._updateDftTip(profile);
                if (p.advance && profile.$hexinadv != hexs) {
                    cls._updateMarks(profile, value, true, hsv[0]);
                    delete profile.$hexinadv
                }
                if (inner != false) {
                    profile.getSubNode("CAPTION").html("#" + value, false)
                }
            })
        },
        getColorName: function () {
            return this.get(0).$clrN || ""
        }
    },
    Initialize: function () {
        var ns = this,
            id = xui.UI.$ID,
            cls = xui.UI.$CLS,
            tag = xui.UI.$tag_special,
            key = ns.KEY,
            list = ns._slist,
            l = list.length,
            i, data, arr = [],
            evs = xui.$IEUNSELECTABLE();
        ns.addTemplateKeys(["TXT", "DD1", "DD2", "DD3", "R", "G", "B", "HH", "S", "V", "H", "E", "X"]);
        for (i = 0; i < l; i++) {
            arr.push('<span  id="' + key + "-SC:" + id + ":" + list[i] + '" style="background-color:#' + list[i] + '" ' + evs + ">" + list[i] + "</span>")
        }
        data = "<div " + evs + '><span class="' + cls + '-txt"' + evs + '>R: </span><span id="' + key + "-R:" + id + ':" class="' + cls + "-dd2 xui-ui-draggable " + tag + "DD2_CC" + tag + '" ' + evs + '>R</span><span style="width:8px;height:8px" ' + evs + ' ></span><span class="' + cls + '-txt"' + evs + '>H: </span><span id="' + key + "-HH:" + id + ':" class="' + cls + "-dd2 xui-ui-draggable " + tag + "DD2_CC" + tag + '" ' + evs + ">H</span><span " + evs + ">\xB0</span></div><div " + evs + '><span class="' + cls + '-txt"' + evs + '>G: </span><span id="' + key + "-G:" + id + ':" class="' + cls + "-dd2 xui-ui-draggable " + tag + "DD2_CC" + tag + '" ' + evs + '>G</span><span style="width:8px;height:8px" ' + evs + ' ></span><span class="' + cls + '-txt"' + evs + '>S: </span><span id="' + key + "-S:" + id + ':" class="' + cls + "-dd2 xui-ui-draggable " + tag + "DD2_CC" + tag + '"  ' + evs + ">S</span><span " + evs + ">%</span></div><div " + evs + '><span class="' + cls + '-txt"' + evs + '>B: </span><span id="' + key + "-B:" + id + ':" class="' + cls + "-dd2 xui-ui-draggable " + tag + "DD2_CC" + tag + '" ' + evs + '>B</span><span style="width:8px;height:8px" ' + evs + ' ></span><span class="' + cls + '-txt"' + evs + '>V: </span><span id="' + key + "-V:" + id + ':" class="' + cls + "-dd2 xui-ui-draggable " + tag + "DD2_CC" + tag + '" ' + evs + ">V</span><span " + evs + ">%</span></div><div " + evs + '><span style="width:38px"' + evs + '>HEX: </span><span id="' + key + "-H:" + id + ':" class="' + cls + "-dd3 xui-ui-draggable " + tag + "DD3_CC" + tag + '" ' + evs + '>H</span><span id="' + key + "-E:" + id + ':" class="' + cls + "-dd3 xui-ui-draggable " + tag + "DD3_CC" + tag + '" ' + evs + "" + evs + '>E</span><span id="' + key + "-X:" + id + ':" class="' + cls + "-dd1 xui-ui-draggable " + tag + "DD1_CC" + tag + '" ' + evs + ">X</span></div>";
        ns.setTemplate({
            style: "{_style};height:auto;width:{_width}px;",
            tagName: "div",
            onselectstart: "return false",
            BORDER: {
                tagName: "div",
                BAR: {
                    tagName: "div",
                    className: "{classBar}",
                    BART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        className: "xui-uibar-t",
                        tagName: "table",
                        BARTR: {
                            tagName: "tr",
                            BARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    },
                    BARCMDL: {
                        tagName: "div",
                        className: "xui-uibar-cmdl"
                    },
                    BARCMDR: {
                        tagName: "div",
                        className: "xui-uibar-cmdr",
                        CLOSE: {
                            className: "xui-uicmd-close ",
                            style: "{closeDisplay}"
                        }
                    }
                },
                MAIN: {
                    $order: 2,
                    tagName: "div",
                    className: "xui-uicon-main",
                    MAINI: {
                        tagName: "div",
                        className: "xui-uicon-maini",
                        CON: {
                            $order: 1,
                            tagName: "div",
                            SIMPLE: {
                                tagName: "div",
                                TOP: {
                                    $order: 1,
                                    tagName: "div",
                                    DATA: {
                                        $order: 0,
                                        tagName: "div",
                                        onselectstart: "return false",
                                        text: data
                                    },
                                    EXAM: {
                                        $order: 1,
                                        tagName: "div",
                                        EXAMI: {
                                            tagName: "div"
                                        }
                                    }
                                },
                                LIST: {
                                    $order: 2,
                                    tagName: "div",
                                    text: arr.join("")
                                }
                            },
                            ADV: {
                                $order: 2,
                                style: "{advDispay}",
                                tagName: "div",
                                ADVWHEEL: {
                                    $order: 0,
                                    tagName: "div"
                                },
                                ADVCLR: {
                                    $order: 1,
                                    tagName: "div"
                                },
                                ADVMARK1: {
                                    $order: 3,
                                    tagName: "div"
                                },
                                ADVMARK2: {
                                    $order: 4,
                                    tagName: "div"
                                }
                            }
                        }
                    }
                },
                TAIL: {
                    $order: 3,
                    tagName: "div",
                    className: "xui-uicon-main",
                    TAILI: {
                        tagName: "div",
                        className: "xui-uicon-maini",
                        CAPTION: {
                            text: "{caption}"
                        },
                        SET: {
                            className: "xui-ui-btn",
                            SETI: {
                                className: "xui-ui-btni",
                                SETC: {
                                    className: "xui-ui-btnc",
                                    SETA: {
                                        tabindex: "{tabindex}",
                                        text: xui.wrapRes("inline.set")
                                    }
                                }
                            }
                        },
                        TOGGLE: {
                            $order: 2,
                            tabindex: "{tabindex}"
                        }
                    }
                },
                BBAR: {
                    $order: 4,
                    tagName: "div",
                    className: "xui-uibar-bottom-s",
                    BBART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        tagName: "table",
                        className: "xui-uibar-t",
                        BBARTR: {
                            tagName: "tr",
                            BBARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BBARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BBARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    }
                }
            }
        })
    },
    Static: {
        _radius: 84,
        _square: 100,
        _bigRadius: 97,
        DataModel: {
            height: {
                ini: "auto",
                readonly: true
            },
            width: {
                ini: "auto",
                readonly: true
            },
            value: {
                ini: "FFFFFF",
                format: "color"
            },
            barDisplay: {
                ini: true,
                action: function (v) {
                    if (v) {
                        this.getSubNode("BAR").replaceClass("xui-uibar-top-s", "xui-uibar-top")
                    } else {
                        this.getSubNode("BAR").replaceClass("xui-uibar-top", "xui-uibar-top-s")
                    }
                }
            },
            closeBtn: {
                ini: true,
                action: function (v) {
                    this.getSubNode("CLOSE").css("display", v ? "" : "none")
                }
            },
            advance: {
                ini: false,
                action: function (v) {
                    var ns = this;
                    ns.getSubNode("ADV").css("display", v ? "" : "none");
                    ns.getSubNode("TOGGLE").tagClass("-adv", v);
                    ns.getRoot().width(v ? 410 : 210);
                    if (v) {
                        ns.box._updateMarks(ns, ns.properties.$UIvalue, true, ns.$hsv[0])
                    }
                }
            }
        },
        Appearances: {
            KEY: {},
            MAINI: {
                padding: "4px 5px 4px 0"
            },
            CON: {
                height: "198px",
                padding: "3px",
                position: "relative",
                border: "solid 1px #648CB4"
            },
            DATA: {
                "float": "left",
                width: "112px",
                height: "86px"
            },
            "DATA span": {
                "float": "left"
            },
            "DATA div": {
                "padding-top": "3px",
                clear: "both"
            },
            TXT: {
                width: "16px"
            },
            CAPTION: {
                "font-size": "12px",
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle"
            },
            EXAM: {
                "float": "left",
                "margin-top": "2px",
                padding: "3px",
                border: "solid 1px #648CB4",
                "background-color": "#E5EBFB"
            },
            EXAMI: {
                height: "70px",
                width: "70px",
                "white-space": "normal",
                "text-align": "center",
                border: "solid 1px #648CB4"
            },
            "DD1, DD2, DD3": {
                display: "block",
                height: "16px",
                border: "1px solid #779EBF",
                "padding-right": "2px",
                cursor: "e-resize",
                "text-align": "right",
                background: "#F8FBFF"
            },
            DD1: {
                width: "16px"
            },
            DD2: {
                width: "24px"
            },
            DD3: {
                $order: 2,
                width: "16px",
                "border-right": "none"
            },
            TOP: {
                height: "92px",
                position: "relative"
            },
            LIST: {
                height: "106px",
                position: "relative",
                overflow: "hidden",
                margin: "0 2px",
                "line-height": xui.browser.ie6 ? "0" : null,
                clear: "both"
            },
            TAILI: {
                position: "relative",
                "padding-top": "4px",
                height: "22px",
                "text-align": "center"
            },
            SIMPLE: {
                "float": "left",
                width: "192px",
                position: "relative"
            },
            ADV: {
                "float": "right",
                width: "195px",
                height: "195px",
                position: "relative"
            },
            "ADV div": {
                cursor: "crosshair",
                position: "absolute"
            },
            ADVCLR: {
                background: xui.browser.ie6 ? null : xui.UI.$bg("bg.png", "no-repeat left top"),
                _filter: xui.UI.$ieBg("bg.png"),
                height: "101px",
                left: "47px",
                top: "47px",
                width: "101px"
            },
            ADVWHEEL: {
                background: xui.browser.ie6 ? null : xui.UI.$bg("clr.png", "no-repeat left top"),
                _filter: xui.UI.$ieBg("clr.png"),
                height: "195px",
                width: "195px"
            },
            "ADVMARK1, ADVMARK2": {
                background: xui.browser.ie6 ? null : xui.UI.$bg("picker.png", "no-repeat left top"),
                _filter: xui.UI.$ieBg("picker.png"),
                height: "17px",
                margin: "-8px 0pt 0pt -8px",
                overflow: "hidden",
                width: "17px"
            },
            "LIST span": {
                height: "12px",
                width: "10px",
                "font-size": xui.browser.ie6 ? "0" : null,
                "float": "left",
                display: "block",
                overflow: "hidden",
                "text-indent": "100px",
                margin: "0",
                cursor: "pointer",
                border: "1px solid #000",
                margin: "0 -1px -1px 0"
            },
            SET: {
                position: "absolute",
                color: "#ff0000",
                display: "none",
                top: "0",
                right: "28px"
            },
            TOGGLE: {
                position: "absolute",
                right: "6px",
                top: "4px",
                display: xui.$inlineBlock,
                width: "15px",
                height: "15px",
                cursor: "default",
                background: xui.UI.$bg("icons.gif", "no-repeat -300px -70px", true),
                zoom: xui.browser.ie6 ? 1 : null
            },
            "TOGGLE-mouseover": {
                "background-position": "-300px -90px"
            },
            "TOGGLE-mousedown": {
                "background-position": "-300px -110px"
            },
            "TOGGLE-adv": {
                "background-position": "-240px -70px"
            },
            "TOGGLE-adv-mouseover": {
                "background-position": "-240px -90px"
            },
            "TOGGLE-adv-mousedown": {
                "background-position": "-240px -110px"
            }
        },
        Behaviors: {
            HoverEffected: {
                CLOSE: "CLOSE",
                SET: "SET",
                TOGGLE: "TOGGLE"
            },
            ClickEffected: {
                CLOSE: "CLOSE",
                SET: "SET",
                TOGGLE: "TOGGLE"
            },
            KEY: {
                onClick: function () {
                    return false
                }
            },
            SC: {
                onMouseover: function (p, e, s) {
                    p.box._setTempUI(p, p.getSubId(s))
                },
                onClick: function (p, e, s) {
                    var sid = p.getSubId(s);
                    p.boxing()._setCtrlValue(p.$tempValue = sid, false);
                    p.box._vC(p);
                    if (!p.properties.advance) {
                        p.boxing().setUIValue(sid, true)
                    }
                    return false
                },
                onDblclick: function (p, e, s) {
                    var sid = p.getSubId(s);
                    p.boxing()._setCtrlValue(p.$tempValue = sid, false);
                    p.box._vC(p);
                    p.boxing().setUIValue(sid, true);
                    return false
                }
            },
            LIST: {
                onMouseout: function (p, e, s) {
                    p.box._updateDftTip(p)
                }
            },
            SET: {
                onClick: function (p, e, src) {
                    p.box._vC(p);
                    p.boxing().setUIValue(p.$tempValue, true)
                }
            },
            CANCEL: {
                onClick: function (p, e, src) {
                    p.getSubNode("CLOSE").onClick(true)
                }
            },
            TOGGLE: {
                onClick: function (p, e, src) {
                    p.boxing().setAdvance(!p.properties.advance)
                }
            },
            R: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 0)
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 0)
                }
            },
            G: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 1)
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 1)
                }
            },
            B: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 2)
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 2)
                }
            },
            HH: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src, true)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 0, "hsv1")
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 0, true, "hsv1")
                }
            },
            S: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src, true)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 1, "hsv2")
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 1, true, "hsv2")
                }
            },
            V: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src, true)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 2, "hsv2")
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 2, true, "hsv2")
                }
            },
            H: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 0, "hex")
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 0)
                }
            },
            E: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 1, "hex")
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 1)
                }
            },
            X: {
                onMousedown: function (p, e, src) {
                    p.box._dd1(p, e, src)
                },
                onDrag: function (p, e, src) {
                    p.box._dd2(p, e, src, 2, "hex")
                },
                onDragstop: function (p, e, src) {
                    p.box._dd3(p, e, src, 2)
                }
            },
            CLOSE: {
                onClick: function (profile, e, src) {
                    var properties = profile.properties,
                        instance = profile.boxing();
                    if (properties.disabled || properties.readonly) {
                        return
                    }
                    if (false === instance.beforeClose(profile)) {
                        return
                    }
                    instance.destroy();
                    return false
                }
            },
            ADVWHEEL: {
                onMousedown: function (p, e, src) {
                    var cls = p.box;
                    cls._prepareAdv(p, e);
                    cls._updateClrByPos(p, e, true);
                    p.getSubNode("ADVMARK1").startDrag(e, {
                        dragType: "none"
                    })
                }
            },
            ADVMARK1: {
                onMousedown: function (p, e, src) {
                    var cls = p.box;
                    cls._prepareAdv(p, e);
                    cls._updateClrByPos(p, e, true);
                    p.getSubNode("ADVMARK1").startDrag(e, {
                        dragType: "none"
                    })
                },
                onDrag: function (p, e, src) {
                    var cls = p.box;
                    cls._updateClrByPos(p, e, true)
                },
                onDragstop: function (p, e, src) {
                    p.box._updateValueByPos(p, e)
                },
                onDblclick: function (p, e, src) {
                    p.box._updateValueByPos(p, e);
                    p.box._vC(p);
                    p.boxing().setUIValue(p.$tempValue, true)
                }
            },
            ADVCLR: {
                onMousedown: function (p, e, src) {
                    var cls = p.box;
                    cls._prepareAdv(p, e);
                    cls._updateClrByPos(p, e);
                    p.getSubNode("ADVMARK2").startDrag(e, {
                        dragType: "none"
                    });
                    return false
                }
            },
            ADVMARK2: {
                onMousedown: function (p, e, src) {
                    var cls = p.box;
                    cls._prepareAdv(p, e);
                    cls._updateClrByPos(p, e);
                    p.getSubNode("ADVMARK2").startDrag(e, {
                        dragType: "none"
                    });
                    return false
                },
                onDrag: function (p, e, src) {
                    var cls = p.box;
                    cls._updateClrByPos(p, e)
                },
                onDragstop: function (p, e, src) {
                    p.box._updateValueByPos(p, e)
                },
                onDblclick: function (p, e, src) {
                    p.box._updateValueByPos(p, e);
                    p.box._vC(p);
                    p.boxing().setUIValue(p.$tempValue, true)
                }
            }
        },
        _vC: function (profile) {
            var pro = profile.properties,
                v = pro.$UIvalue,
                d = v == profile.$tempValue;
            profile.getSubNode("SET").css("display", d ? "none" : "block");
            profile.getSubNode("CAPTION").css("color", d ? "#000" : "#ff0000")
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            var nodisplay = "display:none";
            data.classBar = data.barDisplay ? "xui-uibar-top" : "xui-uibar-top-s";
            data.closeDisplay = data.closeBtn ? "" : nodisplay;
            data._width = data.advance ? "410" : "210";
            data.advDispay = data.advance ? "" : "display:none;";
            return data
        },
        EventHandlers: {
            beforeClose: function (profile, src) {}
        },
        RenderTrigger: function () {
            this.$onValueSet = this.$onUIValueSet = function (v) {
                this.box._setClrName(this, v)
            }
        },
        _setClrName: function (profile, v) {
            var p = profile,
                k = "color.LIST.",
                vv = xui.getRes(k + v);
            if (vv == v) {
                p.$clrN2 = p.$clrN = "#" + v
            } else {
                p.$clrN = vv;
                p.$clrN2 = xui.wrapRes(k + v)
            }
        },
        _slist: "FFFFFF,FFFFF0,FFFFE0,FFFF00,FFFAFA,FFFAF0,FFFACD,FFF8DC,FFF5EE,FFF0F5,FFEFD5,FFEBCD,FFE4E1,FFE4C4,FFE4B5,FFDEAD,FFDAB9,FFD700,FFC0CB,FFB6C1,FFA500,FFA07A,FF8C00,FF7F50,FF69B4,FF6347,FF4500,FF1493,FF00FF,FF00FF,FF0000,FDF5E6,FAFAD2,FAF0E6,FAEBD7,FA8072,F8F8FF,F5FFFA,F5F5F5,F5DEB3,F4A460,F0FFFF,F0FFF0,F0F8FF,F0E68C,F08080,EEE8AA,EE82EE,E9967A,E6E6FA,E1FFFF,DEB887,DDA0DD,DCDCDC,DC143C,DB7093,DAA520,DA70D6,D8BFD8,D3D3D3,D2B48C,D2691E,CD853F,CD5C5C,C71585,C0C0C0,BDB76B,BC8F8F,BA55D3,B22222,B0E0E6,B0C4DE,AFEEEE,ADFF2F,ADD8E6,A9A9A9,A52A2A,A0522D,9932CC,98FB98,9400D3,9370DB,90EE90,8FBC8F,8B4513,8B008B,8B0000,8A2BE2,87CEFA,87CEEB,808080,808000,800080,800000,7FFFAA,7FFF00,7CFC00,7B68EE,778899,708090,6B8E23,6A5ACD,696969,6495ED,5F9EA0,556B2F,4B0082,48D1CC,483D8B,4682B4,4169E1,40E0D0,3CB371,32CD32,2F4F4F,2E8B57,228B22,20B2AA,1E90FF,191970,00FFFF,00FFFF,00FF7F,00FF00,00FA9A,00CED1,00BFFF,008B8B,008080,008000,006400,0000FF,0000CD,00008B,000080,000000".split(","),
        _C16: "0123456789ABCDEF",
        _dd1: function (profile, e, src, hsv) {
            if (xui.Event.getBtn(e) != "left") {
                return
            }
            var p = profile.properties,
                cls = profile.box,
                f = function () {
                    var rgb = cls.hex2rgb(profile.$tempValue || p.$UIvalue);
                    return hsv ? cls.rgb2hsv(rgb) : rgb
                };
            xui.use(src).css("backgroundColor", "red").startDrag(e, {
                dragType: "blank",
                targetReposition: false,
                widthIncrement: 2,
                dragCursor: true
            });
            profile.$temp = 0;
            profile.$start = f();
            profile.$temp2 = f()
        },
        _dd2: function (profile, e, src, i, type) {
            var count, off = xui.DragDrop.getProfile().offset,
                p = profile.properties,
                old = profile.$temp2,
                cls = profile.box,
                rate = type == "hsv1" ? 361 : type == "hsv2" ? 101 : 256,
                v;
            count = (type == "hsv2" ? parseInt(profile.$start[i] * 100, 10) : parseInt(profile.$start[i], 10)) + parseInt(off.x / 2, 10);
            count = (count % rate + rate) % rate;
            if (profile.$temp != count) {
                old[i] = profile.$temp = type == "hsv2" ? count / 100 : count;
                v = (type == "hsv1" || type == "hsv2") ? cls.hsv2rgb(old) : old;
                v = cls.rgb2hex(v);
                cls._setTempUI(profile, v);
                xui.use(src).text(type == "hex" ? cls._toFF(count) : count)
            }
        },
        _dd3: function (profile, e, src, i, hsv) {
            if (profile.$start[i] !== profile.$temp) {
                var p = profile.properties,
                    cls = profile.box,
                    old = profile.$start,
                    v;
                old[i] = profile.$temp;
                v = hsv ? cls.hsv2rgb(old) : old;
                v = cls.rgb2hex(v);
                if (hsv) {
                    profile.$hexinhsv = v
                }
                profile.boxing()._setCtrlValue(profile.$tempValue = v, false);
                delete profile.$hexinhsv;
                profile.box._vC(profile)
            }
            xui.use(src).css("backgroundColor", "");
            profile.$temp = profile.$start = 0
        },
        _setTempUI: function (p, v) {
            var cls = this,
                rgb = cls.hex2rgb(v),
                b = p.boxing(),
                ex = b.getSubNode("EXAMI"),
                hsv = cls.rgb2hsv(rgb),
                vv = xui.getRes("color.LIST." + v);
            ex.css({
                backgroundColor: "#" + v,
                color: hsv[2] > 0.6 ? "#000" : "#FFF"
            });
            ex.text(p.show_color = vv == v ? "#" + v : vv)
        },
        _updateDftTip: function (p) {
            var cls = p.box,
                ex = p.boxing().getSubNode("EXAMI");
            ex.css({
                backgroundColor: "#" + p.$hex.join(""),
                color: p.$hsv[2] > 0.6 ? "#000" : "#FFF"
            });
            ex.html(p.$clrN2 || "", false)
        },
        _to3: function (s) {
            if (!s) {
                s = "FFFFFF"
            }
            return [s.substr(0, 2), s.substr(2, 2), s.substr(4, 2)]
        },
        _toFF: function (n) {
            var C16 = this._C16;
            n = parseInt(n, 10) || 0;
            n = (n > 255 || n < 0) ? 0 : n;
            return C16.charAt((n - n % 16) / 16) + C16.charAt(n % 16)
        },
        _to255: function (str) {
            var C16 = this._C16,
                s = str.split("");
            return C16.indexOf(s[0].toUpperCase()) * 16 + C16.indexOf(s[1].toUpperCase())
        },
        _webSafe: function (r, g, b) {
            var me = arguments.callee,
                f = me.f || (me.f = function (n) {
                    return parseInt(n / 51, 10) * 51
                });
            if (typeof r == "object") {
                g = r[1];
                b = r[2];
                r = r[0]
            }
            return [f(r), f(g), f(b)]
        },
        _updateMarks: function (profile, hex, forcePos, hsv0) {
            var cls = this,
                rgb = cls.hex2rgb(hex),
                hsv = cls.rgb2hsv(rgb),
                angle = (hsv[0] / 360) * 6.28,
                clr = profile.getSubNode("ADVCLR");
            if (forcePos) {
                var m1 = profile.getSubNode("ADVMARK1"),
                    m2 = profile.getSubNode("ADVMARK2");
                m1.cssPos({
                    left: Math.round(Math.sin(angle) * cls._radius + cls._bigRadius),
                    top: Math.round(-Math.cos(angle) * cls._radius + cls._bigRadius)
                });
                m2.cssPos({
                    left: Math.round(cls._square * (hsv[1] - 0.5) + cls._bigRadius),
                    top: Math.round(cls._square * (0.5 - hsv[2]) + cls._bigRadius)
                })
            }
            if (hsv0 !== undefined) {
                clr.css("backgroundColor", "#" + cls.rgb2hex(cls.hsv2rgb([hsv0, 1, 1])))
            }
            cls._setTempUI(profile, hex)
        },
        _updateClrByPos: function (profile, e, flag) {
            var cls = this,
                mPos = xui.Event.getPos(e),
                pos = profile.$tpos,
                left = mPos.left - pos.left,
                top = mPos.top - pos.top,
                angle, m1, m2, h, s, v, hsv, rgb, hex;
            if (flag) {
                m1 = profile.getSubNode("ADVMARK1");
                angle = Math.atan2(left, -top);
                m1.cssPos({
                    left: Math.round(Math.sin(angle) * cls._radius + cls._bigRadius),
                    top: Math.round(-Math.cos(angle) * cls._radius + cls._bigRadius)
                });
                h = Math.floor((angle / 6.28) * 360);
                if (h < 0) {
                    h += 360
                }
                hsv = [h, profile.$hsv[1], profile.$hsv[2]];
                rgb = cls.hsv2rgb(hsv);
                hex = cls.rgb2hex(rgb);
                cls._updateMarks(profile, profile.$t_hex = hex, false, h)
            } else {
                m2 = profile.getSubNode("ADVMARK2");
                s = Math.max(0, Math.min(1, (left / cls._square) + 0.5));
                v = Math.max(0, Math.min(1, 0.5 - (top / cls._square)));
                m2.cssPos({
                    left: Math.round(cls._square * (s - 0.5) + cls._bigRadius),
                    top: Math.round(cls._square * (0.5 - v) + cls._bigRadius)
                });
                hsv = [profile.$hsv[0], s, v];
                rgb = cls.hsv2rgb(hsv);
                hex = cls.rgb2hex(rgb);
                cls._updateMarks(profile, profile.$t_hex = hex)
            }
        },
        _updateValueByPos: function (profile, e) {
            profile.$hexinadv = profile.$t_hex;
            profile.boxing()._setCtrlValue(profile.$tempValue = profile.$t_hex, false);
            delete profile.$hexinadv;
            profile.box._vC(profile)
        },
        _prepareAdv: function (profile, e) {
            var cls = this,
                pos = profile.getSubNode("ADVWHEEL").offset();
            profile.$tpos = {
                left: pos.left + cls._bigRadius,
                top: pos.top + cls._bigRadius
            }
        },
        _ensureValue: function (profile, v) {
            var ns = this,
                me = arguments.callee,
                map = me.map || (me.map = (function () {
                    var h = {};
                    _.arr.each(ns._C16.split(""), function (o, i) {
                        h[o] = 1
                    });
                    return h
                }())),
                reg = me._r || (me._r = /rgb\(([^)]*)\)/);
            if (!v || typeof v != "string") {
                return "transparent"
            }
            if (reg.test(v)) {
                v = v.replace(reg, "$1");
                v = v.split(",");
                v[0] = parseInt(v[0], 10) || 0;
                v[1] = parseInt(v[1], 10) || 0;
                v[2] = parseInt(v[2], 10) || 0;
                v = ns.rgb2hex(v)
            }
            if (v.charAt(0) == "#") {
                v = v.substr(1, v.length)
            }
            var a = "",
                k;
            for (var i = 0; i < 6; i++) {
                k = v.charAt(i).toUpperCase();
                a += (map[k] ? k : "F")
            }
            return a
        },
        hsv2rgb: function (h, s, v) {
            if (h instanceof Array) {
                s = h[1];
                v = h[2];
                h = h[0]
            }
            var me = arguments.callee,
                f = me.f || (me.f = function (n) {
                    return Math.min(255, Math.round(n * 256))
                }),
                r, g, b, i, k, p, q, t;
            if (s == 0) {
                return [v = f(v), v, v]
            } else {
                i = Math.floor((h / 60) % 6);
                k = (h / 60) - i;
                p = v * (1 - s);
                q = v * (1 - k * s);
                t = v * (1 - (1 - k) * s);
                switch (i) {
                case 0:
                    r = v;
                    g = t;
                    b = p;
                    break;
                case 1:
                    r = q;
                    g = v;
                    b = p;
                    break;
                case 2:
                    r = p;
                    g = v;
                    b = t;
                    break;
                case 3:
                    r = p;
                    g = q;
                    b = v;
                    break;
                case 4:
                    r = t;
                    g = p;
                    b = v;
                    break;
                case 5:
                    r = v;
                    g = p;
                    b = q;
                    break
                }
                return s == 0 ? [v = f(v), v, v] : [f(r), f(g), f(b)]
            }
        },
        rgb2hsv: function (r, g, b) {
            if (r instanceof Array) {
                g = r[1];
                b = r[2];
                r = r[0]
            }
            r = r / 255;
            g = g / 255;
            b = b / 255;
            var min = Math.min(r, g, b),
                max = Math.max(r, g, b),
                delta = max - min,
                s = (max === 0) ? 0 : 1 - (min / max),
                v = max,
                h;
            switch (max) {
            case min:
                h = 0;
                break;
            case r:
                h = 60 * (g - b) / delta;
                if (g < b) {
                    h += 360
                }
                break;
            case g:
                h = (60 * (b - r) / delta) + 120;
                break;
            case b:
                h = (60 * (r - g) / delta) + 240;
                break
            }
            return [Math.round(h), s, v]
        },
        rgb2hex: function (r, g, b) {
            var ns = this;
            if (r instanceof Array) {
                g = r[1];
                b = r[2];
                r = r[0]
            }
            return ns._toFF(r) + ns._toFF(g) + ns._toFF(b)
        },
        hex2rgb: function (hex) {
            var ns = this;
            if (!hex) {
                hex = "FFFFFF"
            }
            if (hex.charAt(0) == "#") {
                hex = hex.slice(1)
            }
            return [ns._to255(hex.substr(0, 2)), ns._to255(hex.substr(2, 2)), ns._to255(hex.substr(4, 2))]
        },
        getTextColor: function (value) {
            var ns = this;
            value = ns._ensureValue(0, value);
            value = ns.hex2rgb(value);
            value = ns.rgb2hsv(value);
            return (value && value[2]) > 0.6 ? "#000000" : "#FFFFFF"
        },
        _onresize: function () {}
    }
});
Class("xui.UI.DatePicker", ["xui.UI", "xui.absValue"], {
    Dependency: ["xui.Date"],
    Instance: {
        activate: function () {
            this.getSubNode("PRE").focus();
            return this
        },
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                if (!profile.renderId) {
                    return
                }
                var cls = profile.box,
                    p = profile.properties;
                cls._to(profile, value, true);
                if (profile.keys.CAPTION) {
                    profile.getSubNode("CAPTION").html(xui.Date.getText(value, "ymd", p.firstDayOfWeek), false)
                }
            })
        },
        getDateFrom: function () {
            return this.get(0)._realstart
        }
    },
    Initialize: function () {
        var self = this,
            id = xui.UI.$ID,
            tag = xui.UI.$tag_special,
            cls = xui.UI.$CLS,
            key = self.KEY;
        self.addTemplateKeys(["H", "COL", "W", "TBODY", "THEADER", "TD"]);
        var colgroup = '<colgroup id="' + key + "-COL:" + id + ':"  class="' + tag + "COL_CS" + tag + '"  style="' + tag + "COL_CS" + tag + '"><col width="2%"/><col width="14%"/><col width="14%"/><col width="14%"/><col width="14%"/><col width="14%"/><col width="14%"/><col width="14%"/></colgroup>',
            thead1 = '<thead ID="' + key + "-THEADER:" + id + ':" class="' + tag + "THEADER_CS" + tag + '"  style="' + tag + "THEADER_CS" + tag + '" ><tr height="1%"><th id="' + key + "-H:" + id + ':7" class="xui-node xui-node-th ' + cls + "-h " + cls + "-w " + tag + "H_CC" + tag + '" style="' + tag + "H_CS" + tag + '"></th>',
            thead2 = "</tr></thead>",
            th = '<th id="' + key + "-H:" + id + ':@" class="xui-node xui-node-th ' + cls + "-h " + tag + "H_CC" + tag + '"  style="' + tag + "H_CS" + tag + '">@</th>',
            tbody1 = '<tbody id="' + key + "-TBODY:" + id + ':"  class="' + tag + "TBODY_CS" + tag + '"  style="' + tag + "TBODY_CS" + tag + '" >',
            tbody2 = "</tbody>",
            tr1 = "<tr>",
            tr2 = "</tr>",
            td1 = '<th id="' + key + "-W:" + id + ':@"  class="xui-node xui-node-th ' + cls + "-w " + tag + "W_CC" + tag + '"  style="' + tag + "W_CS" + tag + '">@</th>',
            td2 = '<td id="' + key + "-TD:" + id + ':@" class="xui-node xui-node-td ' + cls + "-td " + tag + "TD_CC" + tag + '"  style="' + tag + "TD_CS" + tag + '" ' + xui.$IEUNSELECTABLE() + " ></td>",
            body, i, j, k, l, a = [],
            b = [];
        for (i = 0; i < 7; i++) {
            b[b.length] = th.replace(/@/g, i)
        }
        k = l = 0;
        for (i = 0; i < 48; i++) {
            j = i % 8;
            a[a.length] = (j == 0 ? tr1 : "") + (j == 0 ? td1 : td2).replace(/@/g, j == 0 ? l : k) + (j == 7 ? tr2 : "");
            if (j !== 0) {
                k++
            } else {
                l++
            }
        }
        body = colgroup + thead1 + b.join("") + thead2 + tbody1 + a.join("") + tbody2;
        self.setTemplate({
            tagName: "div",
            style: "{_style};height:auto;",
            onselectstart: "return false",
            BORDER: {
                tagName: "div",
                BAR: {
                    tagName: "div",
                    className: "xui-uibar-top",
                    style: "{barDisplay};",
                    BART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        className: "xui-uibar-t",
                        tagName: "table",
                        BARTR: {
                            tagName: "tr",
                            BARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    },
                    BARCMDL: {
                        tagName: "div",
                        className: "xui-uibar-cmdl",
                        PRE2: {
                            $order: 0,
                            tabindex: "{tabindex}"
                        },
                        PRE: {
                            $order: 1,
                            tabindex: "{tabindex}"
                        },
                        YEAR: {
                            $order: 2,
                            className: "xui-ui-draggable"
                        },
                        YTXT: {
                            $order: 3,
                            text: "-"
                        },
                        MONTH: {
                            $order: 4,
                            className: "xui-ui-draggable"
                        },
                        MTXT: {
                            $order: 5,
                            text: "-"
                        },
                        DAY: {
                            $order: 6
                        },
                        NEXT: {
                            $order: 7,
                            tabindex: "{tabindex}"
                        },
                        NEXT2: {
                            $order: 8,
                            tabindex: "{tabindex}"
                        }
                    },
                    BARCMDR: {
                        tagName: "div",
                        className: "xui-uibar-cmdr",
                        CLOSE: {
                            className: "xui-uicmd-close ",
                            style: "{closeDisplay}"
                        }
                    }
                },
                MAIN: {
                    $order: 2,
                    tagName: "div",
                    className: "xui-uicon-main",
                    MAINI: {
                        tagName: "div",
                        className: "xui-uicon-maini",
                        CON: {
                            tagName: "div",
                            BODY: {
                                tagName: "table",
                                cellpadding: "0",
                                cellspacing: "0",
                                width: "100%",
                                text: body
                            }
                        }
                    }
                },
                TAIL: {
                    $order: 3,
                    tagName: "div",
                    className: "xui-uicon-main",
                    TAILI: {
                        tagName: "div",
                        className: "xui-uicon-maini",
                        CAPTION: {
                            tagName: "div",
                            style: "{_nocap}",
                            text: "{caption}",
                            $order: 0
                        },
                        TIME: {
                            style: "{_timectrl}",
                            tagName: "div",
                            TPRE2: {
                                $order: 0,
                                tabindex: "{tabindex}"
                            },
                            TPRE: {
                                $order: 1,
                                tabindex: "{tabindex}"
                            },
                            HOUR: {
                                $order: 2,
                                className: "xui-ui-draggable"
                            },
                            MTXT: {
                                $order: 3,
                                text: ":"
                            },
                            MINUTE: {
                                $order: 4,
                                className: "xui-ui-draggable"
                            },
                            TNEXT: {
                                $order: 6,
                                tabindex: "{tabindex}"
                            },
                            TNEXT2: {
                                $order: 7,
                                tabindex: "{tabindex}"
                            }
                        },
                        TODAY: {
                            tabindex: "{tabindex}",
                            title: "{_todaytitle}"
                        },
                        SET: {
                            className: "xui-ui-btn",
                            SETI: {
                                className: "xui-ui-btni",
                                SETC: {
                                    className: "xui-ui-btnc",
                                    SETA: {
                                        tabindex: "{tabindex}",
                                        text: xui.wrapRes("inline.set")
                                    }
                                }
                            }
                        }
                    }
                },
                BBAR: {
                    $order: 4,
                    tagName: "div",
                    className: "xui-uibar-bottom-s",
                    BBART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        tagName: "table",
                        className: "xui-uibar-t",
                        BBARTR: {
                            tagName: "tr",
                            BBARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BBARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BBARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    }
                }
            }
        })
    },
    Static: {
        Appearances: {
            KEY: {
                overflow: "visible"
            },
            BORDER: {
                overflow: "visible",
                position: "relative"
            },
            BODY: {
                position: "relative"
            },
            BARCMDL: {
                top: "3px"
            },
            TAILI: {
                position: "relative",
                height: "24px"
            },
            TIME: {
                padding: "2px 18px"
            },
            SET: {
                position: "absolute",
                display: "none",
                color: "#ff0000",
                top: "0",
                right: "5px"
            },
            TODAY: {
                position: "absolute",
                top: "3px",
                left: "0",
                display: xui.$inlineBlock,
                width: "16px",
                height: "16px",
                cursor: "default",
                background: xui.UI.$bg("icons.gif", "no-repeat right top", true),
                _zoom: 1
            },
            "TODAY-mouseover": {
                "background-position": "right -20px"
            },
            "TODAY-mousedown": {
                "background-position": "right -40px"
            },
            "PRE,PRE2,NEXT,NEXT2,TPRE,TPRE2,TNEXT,TNEXT2": {
                $order: 0,
                display: xui.$inlineBlock,
                position: "relative",
                margin: "0 2px",
                width: "15px",
                height: "15px",
                "vertical-align": "middle",
                cursor: "default",
                background: xui.UI.$bg("icons.gif", "no-repeat", true),
                _zoom: 1
            },
            "PRE, TPRE": {
                $order: 1,
                "background-position": "-260px -70px"
            },
            "PRE-mouseover, TPRE-mouseover": {
                $order: 2,
                "background-position": "-260px -90px"
            },
            "PRE-mousedown, TPRE-mousedown": {
                $order: 3,
                "background-position": "-260px -110px"
            },
            "PRE2, TPRE2": {
                $order: 1,
                "background-position": "-240px -70px"
            },
            "PRE2-mouseover, TPRE2-mouseover": {
                $order: 2,
                "background-position": "-240px -90px"
            },
            "PRE2-mousedown, TPRE2-mousedown": {
                $order: 3,
                "background-position": "-240px -110px"
            },
            "NEXT, TNEXT": {
                $order: 1,
                "background-position": "-280px -70px"
            },
            "NEXT-mouseover, TNEXT-mouseover": {
                $order: 2,
                "background-position": "-280px -90px"
            },
            "NEXT-mousedown, TNEXT-mousedown": {
                $order: 3,
                "background-position": "-280px -110px"
            },
            "NEXT2, TNEXT2": {
                $order: 1,
                "background-position": "-300px -70px"
            },
            "NEXT2-mouseover, TNEXT2-mouseover": {
                $order: 2,
                "background-position": "-300px -90px"
            },
            "NEXT2-mousedown, TNEXT2-mousedown": {
                $order: 3,
                "background-position": "-300px -110px"
            },
            "YEAR,MONTH,DAY,HOUR,MINUTE": {
                $order: 4,
                height: "15px",
                "font-weight": "bold",
                "vertical-align": "middle",
                border: "1px solid #779EBF",
                "background-color": "#F8FBFF",
                "padding-left": "2px",
                cursor: "e-resize"
            },
            YEAR: {
                width: "32px"
            },
            "MONTH, DAY,HOUR, MINUTE": {
                width: "16px"
            },
            CAPTION: {
                padding: "4px 0 0 0",
                "text-align": "center",
                "font-size": "12px",
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle"
            },
            MAINI: {
                "padding-top": "4px",
                "padding-bottom": "4px"
            },
            CON: {
                "border-left": "solid 1px #648CB4",
                "border-top": "solid 1px #648CB4"
            },
            BODY: {
                overflow: "visible"
            },
            "BODY td,BODY th": {
                $order: 1,
                border: 0,
                "border-right": "solid 1px #648CB4",
                "border-bottom": "solid 1px #648CB4",
                "font-size": "12px"
            },
            "TD .exday": {
                color: "#C1C1C1"
            },
            TD: {
                "text-align": "center",
                "background-color": "#EFF8FF"
            },
            "TD-free": {
                $order: 1,
                "text-align": "center",
                "background-color": "#F9F7D1"
            },
            "TD-mouseover": {
                $order: 3,
                "background-color": "#d9e8fb"
            },
            "TD-checked": {
                $order: 4,
                "background-color": "#316AC5",
                "font-weight": "bold",
                color: "#fff"
            },
            "W,H": {
                $order: 3,
                color: "#333333",
                "background-color": "#E8EEF7",
                "vertical-align": "middle",
                "text-align": "center"
            }
        },
        Behaviors: {
            HoverEffected: {
                CLOSE: "CLOSE",
                TD: "TD",
                PRE: "PRE",
                PRE2: "PRE2",
                NEXT: "NEXT",
                NEXT2: "NEXT2",
                TPRE: "TPRE",
                TPRE2: "TPRE2",
                TNEXT: "TNEXT",
                TNEXT2: "TNEXT2",
                SET: "SET",
                TODAY: "TODAY"
            },
            ClickEffected: {
                CLOSE: "CLOSE",
                TD: "TD",
                PRE: "PRE",
                PRE2: "PRE2",
                NEXT: "NEXT",
                NEXT2: "NEXT2",
                TPRE: "TPRE",
                TPRE2: "TPRE2",
                TNEXT: "TNEXT",
                TNEXT2: "TNEXT2",
                SET: "SET",
                TODAY: "TODAY"
            },
            KEY: {
                onClick: function () {
                    return false
                }
            },
            TD: {
                onClick: function (profile, e, src) {
                    var p = profile.properties,
                        id = profile.getSubId(src),
                        map = profile.$daymap,
                        v = map[id];
                    if (p.disabled || p.readonly) {
                        return false
                    }
                    xui.use(src).onMouseout(true, {
                        $force: true
                    });
                    v = xui.Date.add(profile.$tempValue, "d", xui.Date.diff(profile.$tempValue, v, "d", p.firstDayOfWeek));
                    profile.box._to(profile, v);
                    if (!p.timeInput) {
                        profile.boxing().setUIValue(v)
                    }
                },
                onDblclick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.timeInput) {
                        xui.use(src).onMouseout(true, {
                            $force: true
                        });
                        profile.boxing().setUIValue(profile.$tempValue, true)
                    }
                }
            },
            TODAY: {
                onClick: function (profile, e, src) {
                    xui.use(src).onMouseout(true, {
                        $force: true
                    });
                    profile.boxing().setUIValue(profile.properties.timeInput ? new Date : xui.Date.getTimSpanStart(new Date, "d", 1), true)
                }
            },
            SET: {
                onClick: function (profile, e, src) {
                    xui.use(src).onMouseout(true, {
                        $force: true
                    });
                    profile.boxing().setUIValue(profile.$tempValue, true)
                }
            },
            CLOSE: {
                onClick: function (profile, e, src) {
                    var p = profile.properties,
                        instance = profile.boxing();
                    if (p.disabled || p.readonly) {
                        return
                    }
                    if (false === instance.beforeClose(profile, src)) {
                        return
                    }
                    instance.destroy();
                    return false
                }
            },
            PRE: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    profile.box._to(profile, xui.Date.add(profile.$tempValue, "m", -1))
                }
            },
            NEXT: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    profile.box._to(profile, xui.Date.add(profile.$tempValue, "m", 1))
                }
            },
            PRE2: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    profile.box._to(profile, xui.Date.add(profile.$tempValue, "y", -1))
                }
            },
            NEXT2: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    profile.box._to(profile, xui.Date.add(profile.$tempValue, "y", 1))
                }
            },
            TPRE: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    profile.box._to(profile, xui.Date.add(profile.$tempValue, "n", -1))
                }
            },
            TNEXT: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    profile.box._to(profile, xui.Date.add(profile.$tempValue, "n", 1))
                }
            },
            TPRE2: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    profile.box._to(profile, xui.Date.add(profile.$tempValue, "h", -1))
                }
            },
            TNEXT2: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    profile.box._to(profile, xui.Date.add(profile.$tempValue, "h", 1))
                }
            },
            YEAR: {
                onMousedown: function (profile, e, src) {
                    return profile.box._ondown(profile, e, src, 10)
                },
                onDrag: function (profile, e, src) {
                    var count, off = xui.DragDrop.getProfile().offset;
                    count = parseInt(profile.$year, 10) + parseInt(off.x / 10, 10);
                    if (profile.$temp != count) {
                        profile.$temp2 = parseInt(off.x / 10, 10);
                        profile.getSubNode("YEAR").html(count, false)
                    }
                },
                onDragstop: function (profile, e, src) {
                    return profile.box._onds(profile, e, src, "y")
                }
            },
            MONTH: {
                onMousedown: function (profile, e, src) {
                    return profile.box._ondown(profile, e, src, 20)
                },
                onDrag: function (profile, e, src) {
                    var count, off = xui.DragDrop.getProfile().offset;
                    count = parseInt(profile.$month, 10) + (parseInt(off.x / 20, 10) % 12);
                    count = (count % 12 + 12) % 12;
                    if (profile.$temp != count) {
                        profile.$temp = count;
                        profile.$temp2 = count - profile.$month + 1;
                        profile.getSubNode("MONTH").html(((count + 1) <= 9 ? "0" : "") + (count + 1), false)
                    }
                },
                onDragstop: function (profile, e, src) {
                    return profile.box._onds(profile, e, src, "m")
                }
            },
            DAY: {
                onMousedown: function (profile, e, src) {
                    return profile.box._ondown(profile, e, src, 10)
                },
                onDrag: function (profile, e, src) {
                    var date = new Date(profile.$year, profile.$month, 0),
                        days = date.getDate();
                    var p = profile.properties,
                        count, off = xui.DragDrop.getProfile().offset;
                    count = parseInt(profile.$day, 10) + (parseInt(off.x / 10, 10) % days);
                    count = (count % days + days) % days + 1;
                    if (profile.$temp != count) {
                        profile.$temp = count;
                        profile.$temp2 = count - profile.$day;
                        profile.getSubNode("DAY").html((count <= 9 ? "0" : "") + count, false)
                    }
                },
                onDragstop: function (profile, e, src) {
                    return profile.box._onds(profile, e, src, "d")
                }
            },
            HOUR: {
                onMousedown: function (profile, e, src) {
                    return profile.box._ondown(profile, e, src, 20)
                },
                onDrag: function (profile, e, src) {
                    return profile.box._ondrag(profile, 20, 24, "HOUR", profile.$hour)
                },
                onDragstop: function (profile, e, src) {
                    return profile.box._onds(profile, e, src, "h")
                }
            },
            MINUTE: {
                onMousedown: function (profile, e, src) {
                    return profile.box._ondown(profile, e, src, 10)
                },
                onDrag: function (profile, e, src) {
                    return profile.box._ondrag(profile, 10, 60, "MINUTE", profile.$minute)
                },
                onDragstop: function (profile, e, src) {
                    return profile.box._onds(profile, e, src, "n")
                }
            }
        },
        DataModel: {
            timeInput: {
                ini: false,
                action: function (v) {
                    this.getSubNode("CAPTION").css("display", v ? "none" : "block");
                    this.getSubNode("SET").css("display", v ? "block" : "none");
                    this.getSubNode("TIME").css("display", v ? "block" : "none");
                    this.getSubNode("TODAY").attr("title", xui.getRes(v ? "inline.now" : "inline.today"))
                }
            },
            height: {
                ini: "auto",
                readonly: true
            },
            width: {
                ini: 210,
                readonly: true
            },
            value: {
                ini: new Date,
                format: "date"
            },
            closeBtn: {
                ini: true,
                action: function (v) {
                    this.getSubNode("CLOSE").css("display", v ? "" : "none")
                }
            },
            firstDayOfWeek: {
                ini: 0,
                action: function () {
                    this.boxing().refresh()
                }
            },
            offDays: {
                ini: "60",
                action: function () {
                    this.boxing().refresh()
                }
            },
            hideWeekLabels: {
                ini: false,
                action: function () {
                    this.boxing().refresh()
                }
            },
            dateInputFormat: {
                ini: "yyyy-mm-dd",
                listbox: ["yyyy-mm-dd", "mm-dd-yyyy", "dd-mm-yyyy"],
                action: function () {
                    this.boxing().refresh()
                }
            }
        },
        EventHandlers: {
            beforeClose: function (profile, src) {}
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            var nodisplay = "display:none";
            data.closeDisplay = data.closeBtn ? "" : nodisplay;
            var none = "display:none;";
            if (profile.properties.timeInput) {
                data._todaytitle = xui.getRes("inline.now");
                data._nocap = none
            } else {
                data._todaytitle = xui.getRes("inline.today");
                data._timectrl = none
            }
            return data
        },
        _ensureValue: function (profile, value) {
            var d;
            if (value) {
                if (_.isDate(value)) {
                    d = value
                } else {
                    if (_.isFinite(value)) {
                        d = new Date(parseInt(value, 10))
                    }
                }
            }
            d = d || new Date;
            if (!profile.properties.timeInput) {
                d = xui.Date.getTimSpanStart(d, "d")
            }
            return d
        },
        RenderTrigger: function () {
            var self = this,
                p = self.properties,
                o = self.boxing(),
                b = self.box;
            b._setWeekLabel(self);
            var hash = {
                yyyy: "YEAR",
                mm: "MONTH",
                dd: "DAY"
            },
                arr = p.dateInputFormat.split("-");
            if (hash[arr[0]] && hash[arr[1]] && hash[arr[2]]) {
                self.getSubNode("YTXT").addPrev(self.getSubNode(hash[arr[0]]));
                self.getSubNode("MTXT").addPrev(self.getSubNode(hash[arr[1]]));
                self.getSubNode("MTXT").addNext(self.getSubNode(hash[arr[2]]))
            }
        },
        _getWeekNodes: function (profile) {
            return profile.$weeks || (profile.$weeks = profile.getSubNode("W", true))
        },
        _getTDNodes: function (profile) {
            return profile.$tds || (profile.$tds = profile.getSubNode("TD", true))
        },
        _getLabelNodes: function (profile) {
            return profile.$days || (profile.$days = profile.getSubNode("TD", true))
        },
        _getHeaderNodes: function (profile) {
            return profile.$header || (profile.$header = profile.getSubNode("H", true))
        },
        _setWeekLabel: function (profile) {
            var p = profile.properties;
            var fw = p.firstDayOfWeek,
                f = function (id) {
                    id = profile.getSubId(id);
                    if (id == "7") {
                        return id
                    }
                    id = (parseInt(id, 10) + fw);
                    return id < 7 ? id : (id - 7)
                };
            profile.box._getHeaderNodes(profile).each(function (node, i) {
                node.innerHTML = xui.wrapRes("date.WEEKS." + f(node.id))
            });
            if (p.hideWeekLabels) {
                profile.getSubNode("BODY").query("TR").first().remove();
                profile.getSubNode("COL").first().remove()
            }
            var cls2 = profile.getClass("TD", "-free"),
                fdmap = {};
            if (p.offDays) {
                _.arr.each(p.offDays.split(""), function (i) {
                    i = parseInt(i, 10);
                    if (i >= 0 && i <= 6) {
                        fdmap[i] = 1
                    }
                });
                profile.box._getTDNodes(profile).each(function (node, i) {
                    i = ((i + fw) - 7 * parseInt((i + fw) / 7, 10));
                    if (fdmap[i]) {
                        node.className = node.className + " " + cls2
                    }
                })
            }
        },
        _setBGV: function (profile, v, m) {
            var date = xui.Date,
                p = profile.properties,
                daymap = profile.$daymap || (profile.$daymap = []),
                t, n;
            profile.box._getLabelNodes(profile).each(function (node, i) {
                n = date.add(v, "d", i);
                daymap[i] = n;
                t = date.get(n, "m") == m ? "#" : '<p class="xui-node xui-node-p exday">#</p>';
                n = date.get(n, "d");
                node.innerHTML = t.replace("#", n)
            });
            if (!p.hideWeekLabels) {
                profile.box._getWeekNodes(profile).each(function (node, i) {
                    node.innerHTML = date.get(date.add(v, "ww", i), "ww", p.firstDayOfWeek)
                })
            }
        },
        _to: function (profile, time, force) {
            var p = profile.properties,
                fw = p.firstDayOfWeek,
                date = xui.Date,
                keys = profile.keys,
                uiv = p.$UIvalue,
                index = -1,
                node, temp, _realstart = date.getTimSpanStart(date.getTimSpanStart(time, "m"), "ww", 1, fw),
                m = date.get(time, "m", fw);
            profile.$tempValue = time;
            this._setBGV(profile, profile._realstart = _realstart, m);
            if (profile.$selnode) {
                profile.$selnode.tagClass("-checked", false)
            }
            _.arr.each(profile.$daymap, function (o, i) {
                if (date.get(o, "m", fw) + "-" + date.get(o, "d", fw) == date.get(time, "m", fw) + "-" + date.get(time, "d", fw)) {
                    index = i;
                    return false
                }
            });
            node = this._getTDNodes(profile).get()[index];
            (profile.$selnode = xui([node]).tagClass("-checked"));
            profile.getSubNode("SET").css("display", (force || uiv.getTime() == time.getTime()) ? "none" : "block");
            profile.getSubNode("CAPTION").css("color", (force || uiv.getTime() == time.getTime()) ? "" : "#ff0000");
            temp = date.get(time, "y", fw);
            if (profile.$year != temp) {
                profile.$year = temp;
                profile.getSubNode("YEAR").html(temp, false)
            }
            temp = date.get(time, "m", fw) + 1;
            if (profile.$month != temp) {
                profile.$month = temp;
                profile.getSubNode("MONTH").html((temp <= 9 ? "0" : "") + temp, false)
            }
            temp = date.get(time || time, "d", fw);
            if (profile.$day != temp) {
                profile.$day = temp;
                profile.getSubNode("DAY").html((temp <= 9 ? "0" : "") + temp, false)
            }
            temp = date.get(time, "h", fw);
            if (profile.$hour != temp) {
                profile.$hour = temp;
                profile.getSubNode("HOUR").html((temp <= 9 ? "0" : "") + temp, false)
            }
            temp = date.get(time, "n", fw);
            if (profile.$minute != temp) {
                profile.$minute = temp;
                profile.getSubNode("MINUTE").html((temp <= 9 ? "0" : "") + temp, false)
            }
        },
        _ondown: function (profile, e, src, increment) {
            if (xui.Event.getBtn(e) != "left") {
                return
            }
            xui.use(src).startDrag(e, {
                dragType: "blank",
                targetReposition: false,
                widthIncrement: increment,
                dragCursor: true
            });
            profile.$temp = profile.$temp2 = 0
        },
        _ondrag: function (profile, increment, max, key, data) {
            var p = profile.properties,
                count, off = xui.DragDrop.getProfile().offset;
            count = parseInt(data, 10) + (parseInt(off.x / increment, 10) % max);
            count = (count % max + max) % max;
            if (profile.$temp != count) {
                profile.$temp = count;
                profile.$temp2 = count - data;
                profile.getSubNode(key).html((count <= 9 ? "0" : "") + count, false)
            }
        },
        _onds: function (profile, e, src, type) {
            if (profile.$temp2) {
                var p = profile.properties,
                    v = xui.Date.add(profile.$tempValue, type, profile.$temp2);
                profile.box._to(profile, v)
            }
            profile.$temp = profile.$temp2 = 0
        },
        _onresize: function () {}
    }
});
Class("xui.UI.TimePicker", ["xui.UI", "xui.absValue"], {
    Dependency: ["xui.Date"],
    Instance: {
        activate: function () {
            this.getSubNode("PRE").focus();
            return this
        },
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                if (!profile.renderId) {
                    return
                }
                var cls = profile.box,
                    arr2 = cls._v2a(value);
                profile.$hour = arr2[0];
                profile.$minute = arr2[1];
                profile.getSubNode("HI", true).removeClass(cls._excls_c3).removeClass(cls._excls_mo3);
                profile.getSubNode("HI", arr2[0]).addClass(cls._excls_c3);
                profile.getSubNode("MI", true).removeClass(cls._excls_c).removeClass(cls._excls_mo);
                profile.getSubNode("MI", arr2[1]).addClass(cls._excls_c);
                profile.getSubNode("HOUR").html(arr2[0], false);
                profile.getSubNode("MINUTE").html(arr2[1], false);
                profile.getSubNode("CAPTION").html(profile.box._showV(profile, profile.box._v2a(arr2)), false)
            })
        }
    },
    Initialize: function () {
        this.addTemplateKeys(["HI", "MI"]);
        var a, i, h, m, cls, cls2, id, t;
        cls = this._excls3;
        cls2 = this._excls4;
        id = xui.UI.$ID;
        t = '<span id="' + this.KEY + "-HI:" + id + ':@" class="xui-node xui-node-span ' + cls + ' !" ' + xui.$IEUNSELECTABLE() + " >@</span>";
        a = [];
        for (i = 0; i < 24; i++) {
            a[a.length] = t.replace(/@/g, i < 10 ? ("0" + i) : i).replace("!", (i % 6 === 0) ? cls2 : "")
        }
        h = a.join("");
        a.length = 0;
        cls = this._excls;
        cls2 = this._excls2;
        id = xui.UI.$ID;
        t = '<span id="' + this.KEY + "-MI:" + id + ':@" class="xui-node xui-node-span ' + cls + ' !" ' + xui.$IEUNSELECTABLE() + " >@</span>";
        a = [];
        for (i = 0; i < 60; i++) {
            a[a.length] = t.replace(/@/g, i < 10 ? ("0" + i) : i).replace("!", (i % 5 === 0) ? cls2 : "")
        }
        m = a.join("");
        a.length = 0;
        this.setTemplate({
            tagName: "div",
            onselectstart: "return false",
            style: "{_style};height:auto;",
            BORDER: {
                tagName: "div",
                BAR: {
                    tagName: "div",
                    className: "xui-uibar-top",
                    style: "{barDisplay};",
                    BART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        tagName: "table",
                        className: "xui-uibar-t",
                        BARTR: {
                            tagName: "tr",
                            BARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    },
                    BARCMDL: {
                        tagName: "div",
                        className: "xui-uibar-cmdl",
                        PRE2: {
                            $order: 0,
                            tabindex: "{tabindex}"
                        },
                        PRE: {
                            $order: 1,
                            tabindex: "{tabindex}"
                        },
                        HOUR: {
                            $order: 2,
                            className: "xui-ui-draggable"
                        },
                        MTXT: {
                            $order: 3,
                            text: ":"
                        },
                        MINUTE: {
                            $order: 4,
                            className: "xui-ui-draggable"
                        },
                        NEXT: {
                            $order: 6,
                            tabindex: "{tabindex}"
                        },
                        NEXT2: {
                            $order: 7,
                            tabindex: "{tabindex}"
                        }
                    },
                    BARCMDR: {
                        tagName: "div",
                        className: "xui-uibar-cmdr",
                        CLOSE: {
                            className: "xui-uicmd-close ",
                            style: "{closeDisplay}"
                        }
                    }
                },
                MAIN: {
                    $order: 2,
                    tagName: "div",
                    className: "xui-uicon-main",
                    MAINI: {
                        tagName: "div",
                        className: "xui-uicon-maini",
                        CONH: {
                            tagName: "div",
                            className: "xui-uiborder-inset",
                            text: h
                        },
                        CONM: {
                            $order: 2,
                            tagName: "div",
                            className: "xui-uiborder-inset",
                            text: m
                        }
                    }
                },
                TAIL: {
                    $order: 3,
                    tagName: "div",
                    className: "xui-uicon-main",
                    TAILI: {
                        tagName: "div",
                        className: "xui-uicon-maini",
                        CAPTION: {
                            text: "{caption}"
                        },
                        SET: {
                            className: "xui-ui-btn",
                            SETI: {
                                className: "xui-ui-btni",
                                SETC: {
                                    className: "xui-ui-btnc",
                                    SETA: {
                                        tabindex: "{tabindex}",
                                        text: xui.wrapRes("inline.set")
                                    }
                                }
                            }
                        }
                    }
                },
                BBAR: {
                    $order: 4,
                    tagName: "div",
                    className: "xui-uibar-bottom-s",
                    BBART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        tagName: "table",
                        className: "xui-uibar-t",
                        BBARTR: {
                            tagName: "tr",
                            BBARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BBARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BBARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    }
                }
            }
        })
    },
    Static: {
        _excls: "xuiex-timepicker",
        _excls2: "xuiex-timepicker2",
        _excls3: "xuiex-timepicker3",
        _excls4: "xuiex-timepicker4",
        _excls_mo: "xuiex-timepicker-mouseover",
        _excls_c: "xuiex-timepicker-checked",
        _excls_mo3: "xuiex-timepicker3-mouseover",
        _excls_c3: "xuiex-timepicker3-checked",
        _mover: function (src, type) {
            var b = this,
                cn = src.className;
            if (type == 2) {
                if (cn.indexOf(b._excls_mo3) == -1) {
                    src.className = cn + " " + b._excls_mo3
                }
            } else {
                if (cn.indexOf(b._excls_mo) == -1) {
                    src.className = cn + " " + b._excls_mo
                }
            }
            src = null
        },
        _mout: function (src, type) {
            var b = this,
                cn = src.className;
            if (type == 2) {
                if (cn.indexOf(b._excls_mo3) != -1) {
                    src.className = cn.replace(b._excls_mo3, "")
                }
            } else {
                if (cn.indexOf(b._excls_mo) != -1) {
                    src.className = cn.replace(b._excls_mo, "")
                }
            }
            src = null
        },
        Appearances: {
            KEY: {},
            MAINI: {
                "padding-top": "4px"
            },
            CONH: {
                width: "240px"
            },
            CONM: {
                "margin-top": "4px",
                width: "240px"
            },
            BARCMDL: {
                top: "3px"
            },
            "PRE,PRE2,NEXT,NEXT2": {
                position: "relative",
                margin: "0 2px",
                width: "15px",
                height: "15px",
                "vertical-align": "middle",
                cursor: "default",
                background: xui.UI.$bg("icons.gif", "no-repeat", true),
                _zoom: 1
            },
            PRE: {
                $order: 1,
                "background-position": "-260px -70px"
            },
            "PRE-mouseover": {
                $order: 2,
                "background-position": "-260px -90px"
            },
            "PRE-mousedown": {
                $order: 3,
                "background-position": "-260px -110px"
            },
            NEXT: {
                $order: 1,
                "background-position": "-280px -70px"
            },
            "NEXT-mouseover": {
                $order: 2,
                "background-position": "-280px -90px"
            },
            "NEXT-mousedown": {
                $order: 3,
                "background-position": "-280px -110px"
            },
            PRE2: {
                $order: 1,
                "background-position": "-240px -70px"
            },
            "PRE2-mouseover": {
                $order: 2,
                "background-position": "-240px -90px"
            },
            "PRE2-mousedown": {
                $order: 3,
                "background-position": "-240px -110px"
            },
            NEXT2: {
                $order: 1,
                "background-position": "-300px -70px"
            },
            "NEXT2-mouseover": {
                $order: 2,
                "background-position": "-300px -90px"
            },
            "NEXT2-mousedown": {
                $order: 3,
                "background-position": "-300px -110px"
            },
            "HOUR, MINUTE": {
                $order: 3,
                margin: "0 2px",
                height: "15px",
                width: "16px",
                "font-weight": "bold",
                "vertical-align": "middle",
                border: "1px solid #779EBF",
                "background-color": "#F8FBFF",
                cursor: "e-resize",
                "padding-left": "2px"
            },
            SET: {
                position: "absolute",
                display: "none",
                color: "#ff0000",
                top: "1px",
                right: "5px"
            },
            TAILI: {
                position: "relative",
                "padding-top": "4px",
                height: "20px",
                "text-align": "center"
            },
            CAPTION: {
                "font-size": "12px",
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle"
            },
            ".xuiex-timepicker2, .xuiex-timepicker4": {
                $order: 1,
                "background-color": "#FDF8D2"
            },
            ".xuiex-timepicker": {
                "font-size": "12px",
                width: "24px",
                height: "16px",
                "text-align": "center",
                "background-color": "#F9F9FB"
            },
            ".xuiex-timepicker3": {
                "font-size": "12px",
                width: "20px",
                height: "16px",
                "text-align": "center",
                "background-color": "#F9F9FB",
                "font-weight": "bold"
            },
            ".xuiex-timepicker-mouseover, .xuiex-timepicker3-mouseover": {
                $order: 2,
                "background-color": "#d9e8fb"
            },
            ".xuiex-timepicker-checked, .xuiex-timepicker3-checked": {
                $order: 2,
                "background-color": "#316AC5",
                color: "#fff"
            }
        },
        Behaviors: {
            HoverEffected: {
                CLOSE: "CLOSE",
                PRE: "PRE",
                NEXT: "NEXT",
                PRE2: "PRE2",
                NEXT2: "NEXT2",
                SET: "SET"
            },
            ClickEffected: {
                CLOSE: "CLOSE",
                PRE: "PRE",
                NEXT: "NEXT",
                PRE2: "PRE2",
                NEXT2: "NEXT2",
                SET: "SET"
            },
            KEY: {
                onClick: function () {
                    return false
                }
            },
            HOUR: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    xui(src).startDrag(e, {
                        dragType: "blank",
                        targetReposition: false,
                        widthIncrement: 5,
                        dragCursor: true
                    });
                    profile.$temp2 = 0
                },
                onDrag: function (profile, e, src) {
                    var count, off = xui.DragDrop.getProfile().offset,
                        v = profile.properties.$UIvalue,
                        a = v.split(":");
                    a[0] = (parseFloat(a[0]) || 0) + parseInt(off.x / 10, 10);
                    a[0] = (a[0] % 24 + 24) % 24;
                    profile.$temp2 = (a[0] <= 9 ? "0" : "") + a[0];
                    if (v[0] != profile.$temp2) {
                        profile.getSubNode("HOUR").html(profile.$temp2, false)
                    }
                },
                onDragstop: function (profile, e, src) {
                    if (profile.$temp2) {
                        profile.$hour = profile.$temp2;
                        profile.boxing()._setCtrlValue(profile.$hour + ":" + profile.$minute)
                    }
                    profile.$temp2 = 0;
                    profile.box._hourC(profile)
                }
            },
            MINUTE: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    xui(src).startDrag(e, {
                        dragType: "blank",
                        targetReposition: false,
                        widthIncrement: 5,
                        dragCursor: true
                    });
                    profile.$temp2 = 0
                },
                onDrag: function (profile, e, src) {
                    var count, off = xui.DragDrop.getProfile().offset,
                        v = profile.properties.$UIvalue,
                        a = v.split(":");
                    a[0] = (parseFloat(a[0]) || 0) + parseInt(off.x / 20, 10);
                    a[0] = (a[0] % 60 + 60) % 60;
                    profile.$temp2 = (a[0] <= 9 ? "0" : "") + a[0];
                    if (v[0] != profile.$temp2) {
                        profile.getSubNode("MINUTE").html(profile.$temp2, false)
                    }
                },
                onDragstop: function (profile, e, src) {
                    if (profile.$temp2) {
                        profile.$minute = profile.$temp2;
                        profile.boxing()._setCtrlValue(profile.$hour + ":" + profile.$minute)
                    }
                    profile.$temp2 = 0;
                    profile.box._hourC(profile)
                }
            },
            SET: {
                onClick: function (profile) {
                    var pro = profile.properties,
                        v = pro.$UIvalue,
                        a = v.split(":");
                    a[0] = profile.$hour;
                    a[1] = profile.$minute;
                    profile.boxing().setUIValue(a.join(":"), true);
                    if (profile.box) {
                        profile.box._hourC(profile)
                    }
                }
            },
            HI: {
                onMouseover: function (profile, e, src) {
                    if (profile.properties.disableHoverEffect) {
                        return
                    }
                    profile.box._mover(xui.use(src).get(0), 2)
                },
                onMouseout: function (profile, e, src) {
                    if (profile.properties.disableHoverEffect) {
                        return
                    }
                    profile.box._mout(xui.use(src).get(0), 2)
                },
                onClick: function (profile, e, src) {
                    profile.$hour = profile.getSubId(src);
                    profile.boxing()._setCtrlValue(profile.$hour + ":" + profile.$minute);
                    if (profile.box) {
                        profile.box._hourC(profile)
                    }
                },
                onDblclick: function (profile, e, src) {
                    profile.$hour = profile.getSubId(src);
                    profile.boxing().setUIValue(profile.$hour + ":" + profile.$minute, true);
                    if (profile.box) {
                        profile.box._hourC(profile)
                    }
                }
            },
            MI: {
                onMouseover: function (profile, e, src) {
                    if (profile.properties.disableHoverEffect) {
                        return
                    }
                    profile.box._mover(xui.use(src).get(0))
                },
                onMouseout: function (profile, e, src) {
                    if (profile.properties.disableHoverEffect) {
                        return
                    }
                    profile.box._mout(xui.use(src).get(0))
                },
                onClick: function (profile, e, src) {
                    profile.$minute = profile.getSubId(src);
                    profile.boxing().setUIValue(profile.$hour + ":" + profile.$minute, true);
                    if (profile.box) {
                        profile.box._hourC(profile)
                    }
                }
            },
            PRE: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var v = profile.$minute;
                    v = (parseFloat(v) || 0) - 1;
                    v = (v % 60 + 60) % 60;
                    profile.$minute = v = (v <= 9 ? "0" : "") + v;
                    profile.boxing()._setCtrlValue(profile.$hour + ":" + profile.$minute);
                    if (profile.box) {
                        profile.box._hourC(profile)
                    }
                }
            },
            NEXT: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var v = profile.$minute;
                    v = (parseFloat(v) || 0) + 1;
                    v = (v % 60 + 60) % 60;
                    profile.$minute = v = (v <= 9 ? "0" : "") + v;
                    profile.boxing()._setCtrlValue(profile.$hour + ":" + profile.$minute);
                    if (profile.box) {
                        profile.box._hourC(profile)
                    }
                }
            },
            PRE2: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var v = profile.$hour;
                    v = (parseFloat(v) || 0) - 1;
                    v = (v % 24 + 24) % 24;
                    profile.$hour = v = (v <= 9 ? "0" : "") + v;
                    profile.boxing()._setCtrlValue(profile.$hour + ":" + profile.$minute);
                    if (profile.box) {
                        profile.box._hourC(profile)
                    }
                }
            },
            NEXT2: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var v = profile.$hour;
                    v = (parseFloat(v) || 0) + 1;
                    v = (v % 24 + 24) % 24;
                    profile.$hour = v = (v <= 9 ? "0" : "") + v;
                    profile.boxing()._setCtrlValue(profile.$hour + ":" + profile.$minute);
                    if (profile.box) {
                        profile.box._hourC(profile)
                    }
                }
            },
            CLOSE: {
                onClick: function (profile, e, src) {
                    var properties = profile.properties,
                        instance = profile.boxing();
                    if (properties.disabled || properties.readonly) {
                        return
                    }
                    if (false === instance.beforeClose(profile, src)) {
                        return
                    }
                    instance.destroy();
                    return false
                }
            }
        },
        DataModel: {
            height: {
                ini: "auto",
                readonly: true
            },
            width: {
                ini: 250,
                readonly: true
            },
            value: {
                ini: "00:00",
                format: "time"
            },
            closeBt: {
                ini: true,
                action: function (v) {
                    this.getSubNode("CLOSE").css("display", v ? "" : "none")
                }
            }
        },
        EventHandlers: {
            beforeClose: function (profile, src) {}
        },
        _hourC: function (profile) {
            var pro = profile.properties,
                v = pro.$UIvalue,
                a = v.split(":"),
                d = (a[0] + "") == (profile.$hour + "") && (a[1] + "") == (profile.$minute + "");
            profile.getSubNode("SET").css("display", d ? "none" : "block");
            profile.getSubNode("CAPTION").css("color", d ? "" : "#ff0000")
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            var nodisplay = "display:none";
            data.closeDisplay = data.closeBtn ? "" : nodisplay;
            return data
        },
        _ensureValue: function (profile, value) {
            var a, b = [];
            if (value && typeof value == "string") {
                a = value.split(":")
            } else {
                if (value && typeof value == "object" && _.isArr(value)) {
                    a = value
                } else {
                    a = []
                }
            }
            b[0] = parseFloat(a[0]) || 0;
            b[1] = parseFloat(a[1]) || 0;
            if (b[0] < 0) {
                b[0] = 0
            }
            if (b[0] > 23) {
                b[0] = 23
            }
            if (b[1] < 0) {
                b[1] = 0
            }
            if (b[1] > 59) {
                b[1] = 59
            }
            b[0] = (b[0] <= 9 ? "0" : "") + b[0];
            b[1] = (b[1] <= 9 ? "0" : "") + b[1];
            return b.join(":")
        },
        formatValue: function (value) {
            return value.join(":")
        },
        _v2a: function (v) {
            return typeof v == "string" ? v.split(":") : v
        },
        _showV: function (profile, a) {
            var f = profile.CF;
            if (typeof f.formatCaption == "function") {
                return f.formatCaption(a)
            } else {
                return a.join(":")
            }
        },
        _onresize: function () {}
    }
});
Class("xui.UI.TimeLine", ["xui.UI", "xui.absList", "xui.absValue"], {
    Dependency: ["xui.Date"],
    Instance: {
        _setCtrlValue: function (value) {
            if (!value) {
                return
            }
            if (value.indexOf(":") == -1) {
                return
            }
            var profile = this.get(0),
                p = profile.properties,
                box = this.constructor,
                a = value.split(":"),
                from = new Date(parseInt(a[0], 10)),
                to = new Date(parseInt(a[1], 10)),
                pxStart = box._getX(profile, from),
                pxEnd = box._getX(profile, to),
                task;
            if (p.items.length === 0) {
                this.insertItems([{
                    id: "$",
                    caption: p.dftTaskName,
                    from: parseInt(a[0], 10),
                    to: parseInt(a[1], 10)
                }], null, true)
            } else {
                box._resetItem(profile, {
                    left: pxStart,
                    width: pxEnd - pxStart
                }, profile.getSubNodeByItemId("ITEM", p.items[0].id)._get(0))
            }
        },
        visibleTask: function () {
            var profile = this.get(0),
                p = profile.properties,
                date = xui.Date,
                items = p.items,
                sv, target;
            if (!p.multiTasks) {
                sv = items.length ? items[0].from : p.$UIvalue ? p.$UIvalue.split(":")[0] : 0;
                if (sv) {
                    target = new Date(+sv);
                    if (profile.renderId) {
                        if (target < p.dateStart || target > date.add(p.dateStart, "ms", p.width * p._rate)) {
                            p.dateStart = target;
                            var k = p.$UIvalue;
                            this.refresh().setUIValue(k, true)
                        }
                    } else {
                        p.dateStart = target
                    }
                }
            }
            return this
        },
        _afterInsertItems: function (profile) {
            if (!profile.renderId) {
                return
            }
            profile.box._reArrage(profile)
        },
        _afterRemoveItems: function (profile) {
            profile.box._reArrage(profile)
        },
        _cache: function () {
            var profile = this.get(0),
                cls = this.constructor,
                picker = cls._picker;
            if (picker && picker.renderId) {
                profile.getSubNode("POOL").append(picker.getRoot().css("display", "none"))
            }
        },
        getTimeRange: function () {
            var profile = this.get(0),
                p = profile.properties;
            return [p._smallLabelStart, p._smallLabelEnd]
        },
        iniContent: function () {
            return this.each(function (profile) {
                var p = profile.properties;
                profile.boxing()._getContent(p._smallLabelStart, p._smallLabelEnd, p._rate, "ini");
                profile._iniOK = true
            })
        },
        addTasks: function (arr) {
            return this.insertItems(arr, null, true)
        },
        removeTasks: function (ids) {
            this.removeItems(ids);
            return this
        },
        _getContent: function (from, to, rate, type) {
            return this.each(function (profile) {
                if (profile.onGetContent) {
                    var ins = profile.boxing(),
                        callback = function (arr) {
                            if (type == "ini") {
                                ins.clearItems()
                            }
                            ins.addTasks(arr)
                        };
                    if (profile.onGetContent) {
                        var r = ins.onGetContent(profile, from, to, rate, type, callback);
                        if (r) {
                            callback(r)
                        }
                    }
                }
            })
        },
        scrollToLeft: function (callback) {
            var profile = this.get(0);
            if (profile.pauseA || profile.pause) {
                return
            }
            var t = profile.properties,
                date = xui.Date,
                rate = t._rate,
                o = profile.box._getMoveNodes(profile),
                x1 = t._band_left,
                x2 = 0;
            if (t.minDate && t._smallLabelStart < t.minDate) {
                x2 -= date.diff(t._smallLabelStart, t.minDate, "ms") / rate
            }
            profile.pause = true;
            o.animate({
                left: [x1, x2]
            }, null, function () {
                if (typeof callback == "function") {
                    callback()
                }
                profile.pause = false
            }, 200, Math.max(5, (x2 - x1) / 100), "sineInOut").start()
        },
        scrollToRight: function (callback) {
            var profile = this.get(0);
            if (profile.pauseA || profile.pause) {
                return
            }
            var t = profile.properties,
                date = xui.Date,
                rate = t._rate,
                o = profile.box._getMoveNodes(profile),
                x1 = t._band_left,
                x2 = t.width - t._band_width;
            if (t.maxDate && t._smallLabelEnd > t.maxDate) {
                x2 += date.diff(t.maxDate, t._smallLabelEnd, "ms") / rate
            }
            if (x1 > x2) {
                profile.pause = true;
                o.animate({
                    left: [x1, x2]
                }, null, function () {
                    if (typeof callback == "function") {
                        callback()
                    }
                    profile.pause = false
                }, 200, Math.max(5, (x1 - x2) / 100), "sineInOut").start()
            }
        }
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            BORDER: {
                tagName: "div",
                style: "height:{_bHeight}px;width:{_bWidth}px;",
                POOL: {
                    tagName: "div",
                    style: "position:absolute;left:0;top:0;width:0;height:0;display:none;"
                },
                TBAR: {
                    tagName: "div",
                    className: "xui-uibar-top",
                    style: "{_bardisplay};",
                    TBART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        tagName: "table",
                        className: "xui-uibar-t",
                        TBARTR: {
                            tagName: "tr",
                            TBARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            TBARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            TBARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    },
                    BARCMDL: {
                        tagName: "div",
                        className: "xui-uibar-cmdl",
                        DATE: {
                            $order: 0,
                            style: "{dateDisplay}"
                        },
                        PRE: {
                            $order: 2
                        },
                        ZOOMIN: {
                            $order: 3,
                            style: "{zoomDisplay}"
                        },
                        ZOOMOUT: {
                            $order: 4,
                            style: "{zoomDisplay}"
                        },
                        NEXT: {
                            $order: 5
                        }
                    },
                    BARCMDR: {
                        tagName: "div",
                        className: "xui-uibar-cmdr",
                        OPT: {
                            className: "xui-uicmd-opt",
                            style: "{optDisplay}",
                            $order: 0
                        },
                        CLOSE: {
                            $order: 4,
                            className: "xui-uicmd-close ",
                            style: "{closeDisplay}"
                        }
                    }
                },
                MAIN: {
                    $order: 2,
                    tagName: "div",
                    className: "xui-uicon-main",
                    MAINI: {
                        tagName: "div",
                        className: "xui-uicon-maini",
                        MAINC: {
                            tagName: "div",
                            MAINP: {
                                tagName: "div",
                                VIEW: {
                                    tagName: "div",
                                    style: "left:{_band_left}px;width:{_band_width}px;",
                                    BAND: {
                                        $order: 2,
                                        tagName: "div",
                                        tabindex: "{tabindex}",
                                        BIGLABEL: {
                                            tagName: "div",
                                            style: "{_showBigLabel}",
                                            text: "{_bigMarks}"
                                        },
                                        SMALLLABEL: {
                                            $order: 1,
                                            tagName: "div",
                                            text: "{_smallMarks}"
                                        }
                                    },
                                    CON: {
                                        $order: 3,
                                        tagName: "div",
                                        style: "height:{_viewHeight}px;",
                                        BG: {
                                            tagName: "div",
                                            style: "height:{_viewHeight}px;"
                                        },
                                        LINES: {
                                            $order: 1,
                                            tagName: "div"
                                        },
                                        ITEMS: {
                                            $order: 2,
                                            tagName: "div",
                                            style: "height:{_viewHeight}px;",
                                            text: "{items}"
                                        }
                                    },
                                    ACTIVE: {
                                        $order: 4,
                                        tagName: "div"
                                    }
                                },
                                SCROLL: {
                                    $order: 2,
                                    tagName: "div",
                                    SCROLLI: {
                                        tagName: "div"
                                    }
                                }
                            }
                        }
                    }
                },
                TAIL: {
                    $order: 4,
                    tagName: "div",
                    className: "xui-uicon-main",
                    TIPS: {
                        className: "xui-uicon-maini",
                        style: "z-index:2;{_tipsdisplay};",
                        tagName: "div"
                    }
                },
                BBAR: {
                    $order: 5,
                    tagName: "div",
                    style: "{_bardisplay};",
                    className: "xui-uibar-bottom-s",
                    BBART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        tagName: "table",
                        className: "xui-uibar-t",
                        BBARTR: {
                            tagName: "tr",
                            BBARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BBARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BBARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    }
                }
            },
            $submap: {
                _bigMarks: {
                    LABELT: {
                        id: null,
                        className: null,
                        tagName: "div",
                        style: "width:{width}px;left:{left}px;",
                        text: "{text}"
                    }
                },
                _smallMarks: {
                    LABELB: {
                        id: null,
                        className: null,
                        tagName: "div",
                        style: "width:{width}px;left:{left}px;",
                        text: "{text}"
                    }
                },
                bgitems: {
                    BGITEM: {
                        tagName: "div",
                        style: "left:{_left}px;width:{_width}px;"
                    }
                },
                items: {
                    ITEM: {
                        tagName: "div",
                        className: "{itemClass} {disabled} {readonly} {_excls}",
                        style: "left:{_left}px;width:{_width}px;{_top};{_zindex}{itemStyle}",
                        HEAD: {
                            tagName: "div",
                            TSKBAR: {
                                tagName: "div",
                                style: "width:{_perw}%;"
                            },
                            HANDLER: {
                                $order: 2,
                                tagName: "div",
                                LEFT: {
                                    tagName: "div"
                                },
                                RIGHT: {
                                    tagName: "div"
                                }
                            }
                        },
                        BODY: {
                            $order: 1,
                            tagName: "div",
                            style: "{_background}",
                            CON: {
                                $order: 3,
                                tagName: "div",
                                text: "{caption}"
                            }
                        }
                    }
                }
            }
        },
        Behaviors: {
            DroppableKeys: ["VIEW"],
            HoverEffected: {
                PRE: "PRE",
                NEXT: "NEXT",
                ZOOMIN: "ZOOMIN",
                ZOOMOUT: "ZOOMOUT",
                DATE: "DATE",
                OPT: "OPT",
                CLOSE: "CLOSE"
            },
            ClickEffected: {
                PRE: "PRE",
                NEXT: "NEXT",
                ZOOMIN: "ZOOMIN",
                ZOOMOUT: "ZOOMOUT",
                DATE: "DATE",
                OPT: "OPT",
                CLOSE: "CLOSE"
            },
            onSize: xui.UI.$onSize,
            CLOSE: {
                onClick: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    var instance = profile.boxing();
                    if (false === instance.beforeClose(profile, src)) {
                        return
                    }
                    instance.destroy();
                    return false
                }
            },
            OPT: {
                onClick: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    profile.boxing().onShowOptions(profile, e, src)
                }
            },
            BAND: {
                onKeydown: function (profile, e, src) {
                    if (profile.pauseA || profile.pause) {
                        return
                    }
                    profile.pause = true;
                    var t = profile.properties,
                        date = xui.Date,
                        rate = t._rate,
                        maxOffset = 30,
                        o = profile.box._getMoveNodes(profile),
                        x = o.left(),
                        xx = t._band_left,
                        off = t._scroll_offset;
                    off = t._scroll_offset = off > maxOffset ? off : off * 1.05;
                    switch (xui.Event.getKey(e).key) {
                    case "left":
                    case "up":
                        if (t.minDate && date.add(t.dateStart, "ms", (xx - x - off) * rate) < t.minDate) {
                            off = date.diff(t.minDate, t.dateStart, "ms") / rate + (xx - x)
                        }
                        if (off < 0) {
                            off = 0
                        }
                        o.left(x + off);
                        break;
                    case "right":
                    case "down":
                        if (t.maxDate && date.add(t.dateStart, "ms", (xx - x + off + t.width) * rate) > t.maxDate) {
                            off = date.diff(t.dateStart, t.maxDate, "ms") / rate - (xx - x + t.width)
                        }
                        if (off < 0) {
                            off = 0
                        }
                        o.left(x - off);
                        break
                    }
                    if ((x + maxOffset > 0) || (x + o.width() - t.width - maxOffset < 0)) {
                        profile.box._rePosition(profile)
                    }
                    profile.pause = false;
                    return false
                },
                onKeyup: function (profile, e) {
                    var p = profile.properties;
                    p._scroll_offset = p._scrollRate;
                    profile.box._rePosition(profile)
                },
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    if (profile.pauseA || profile.pause) {
                        return
                    }
                    var t = profile.properties,
                        r = -t._band_left,
                        date = xui.Date,
                        rate = t._rate,
                        ep = xui.Event.getPos(e),
                        l = t._band_width - r - t.width;
                    if (t.minDate && t._smallLabelStart < t.minDate) {
                        r -= date.diff(t._smallLabelStart, t.minDate, "ms") / rate
                    }
                    if (t.maxDate && t._smallLabelEnd > t.maxDate) {
                        l -= date.diff(t.maxDate, t._smallLabelEnd, "ms") / rate
                    }
                    if (r < 0) {
                        r = 0
                    }
                    if (l < 0) {
                        l = 0
                    }
                    xui.use(src).startDrag(e, {
                        targetReposition: false,
                        dragType: "blank",
                        dragDefer: 2,
                        horizontalOnly: true,
                        targetLeft: ep.left,
                        targetTop: ep.top,
                        maxLeftOffset: l,
                        maxRightOffset: r
                    });
                    xui.use(src).focus()
                },
                onDragstop: function (profile, e, src) {
                    profile.box._rePosition(profile)
                },
                onDrag: function (profile, e, src) {
                    var ns = profile.box._getMoveNodes(profile),
                        dd = xui.DragDrop.getProfile();
                    ns.left(profile.properties._band_left + dd.offset.x)
                },
                onContextmenu: function (profile, e, src) {
                    return profile.boxing().onContextmenu(profile, e, src) !== false
                }
            },
            SCROLL: {
                onScroll: function (profile, e, src) {
                    profile.getSubNodes(["ITEMS", "LINES"]).top(-xui.use(src).scrollTop())
                }
            },
            VIEW: {
                onMouseover: function (profile, e, src) {
                    if (xui.DragDrop.getProfile().isWorking) {
                        return
                    }
                    profile.$itemspos = xui.use(src).offset()
                },
                onMousemove: function (profile, e) {
                    var ddd = xui.DragDrop.getProfile();
                    if (ddd.isWorking) {
                        if (profile.$$ondrag) {
                            profile.box._moveActive(profile, profile.$active, ddd.x - profile.$dd_ox, profile.properties._unitPixs, "move")
                        }
                    } else {
                        var t = profile.properties,
                            date = xui.Date,
                            s = t._smallLabelStart,
                            r = t._rate,
                            u = t._timeFormat,
                            p2 = profile.$itemspos;
                        if (p2 && t.showTips) {
                            var p1 = xui.Event.getPos(e);
                            profile.box._setTips(profile, date.getText(date.add(s, "ms", (p1.left - p2.left) * r), u))
                        }
                    }
                },
                onMouseout: function (profile, e, src) {
                    if (xui.DragDrop.getProfile().isWorking) {
                        return
                    }
                    if (profile.properties.showTips) {
                        profile.box._setTips(profile, "")
                    }
                }
            },
            ITEMS: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var pro = profile.properties;
                    if (pro.disabled || pro.readonly) {
                        return
                    }
                    if (profile.pauseA || profile.pause) {
                        return
                    }
                    if (xui.Event.getSrc(e) != xui.use(src).get(0)) {
                        return
                    }
                    var o = profile.getSubNode("ACTIVE");
                    o.css({
                        width: 0,
                        visibility: "hidden"
                    }).offset({
                        left: xui.Event.getPos(e).left,
                        top: null
                    });
                    profile.__actives = 1;
                    o.startDrag(e, {
                        dragDefer: 1,
                        dragType: "none"
                    })
                },
                onMouseup: function (profile) {
                    if (profile.__actives) {
                        delete profile.__actives
                    }
                }
            },
            ACTIVE: {
                onDragbegin: function (profile, e, src) {
                    profile.$dd_ox = xui.DragDrop.getProfile().x;
                    profile.$dd_oleft = parseInt(xui.use(src).get(0).style.left, 10) || 0;
                    xui.use(src).css("cursor", "e-resize").parent().css("cursor", "e-resize")
                },
                onDrag: function (profile, e, src) {
                    var x = profile.$dd_oleft,
                        ddx = xui.DragDrop.getProfile().x,
                        w, offset;
                    if ((offset = ddx - profile.$dd_ox) >= 0) {
                        w = offset
                    } else {
                        x = x + offset;
                        w = -offset
                    }
                    profile.box._moveActive(profile, xui.use(src).get(0), x, w, "all")
                },
                onDragstop: function (profile, e, src) {
                    var r = profile.box._deActive(profile);
                    xui.use(src).css("cursor", "").parent().css("cursor", "");
                    var box = profile.box,
                        from = box._getTime(profile, r.left),
                        to = box._getTime(profile, r.left + r.width),
                        p = profile.properties,
                        task, t, b = profile.boxing();
                    if (profile.properties.multiTasks) {
                        task = {
                            id: _.id(),
                            caption: p.dftTaskName,
                            from: from,
                            to: to
                        };
                        if (profile.beforeNewTask && false === b.beforeNewTask(profile, task)) {} else {
                            b.addTasks([task])
                        }
                    } else {
                        b.setUIValue(from + ":" + to)
                    }
                    profile.$dd_ox = profile.$dd_oleft = null
                }
            },
            PRE: {
                onClick: function (profile, e) {
                    profile.boxing().scrollToLeft(function () {
                        profile.box._rePosition(profile)
                    })
                }
            },
            NEXT: {
                onClick: function (profile, e) {
                    profile.boxing().scrollToRight(function () {
                        profile.box._rePosition(profile)
                    })
                }
            },
            ZOOMIN: {
                onClick: function (profile, e) {
                    if (profile.pauseA || profile.pause) {
                        return
                    }
                    var p = profile.properties,
                        box = profile.box,
                        z = box.$zoom,
                        index = _.arr.indexOf(z, p._unitParas),
                        o;
                    if (index > 0) {
                        p.timeSpanKey = z[index - 1][0];
                        box._refresh(profile, true)
                    }
                }
            },
            ZOOMOUT: {
                onClick: function (profile, e) {
                    if (profile.pauseA || profile.pause) {
                        return
                    }
                    var p = profile.properties,
                        box = profile.box,
                        z = box.$zoom,
                        index = _.arr.indexOf(z, p._unitParas),
                        o;
                    if (index < z.length - 1) {
                        p.timeSpanKey = z[index + 1][0];
                        box._refresh(profile, true)
                    }
                }
            },
            DATE: {
                onClick: function (profile, e, src) {
                    if (profile.pauseA || profile.pause) {
                        return
                    }
                    var cls = profile.box,
                        box = profile.boxing(),
                        from = profile.properties.dateStart,
                        o, node;
                    if (cls._picker && cls._picker.renderId) {
                        o = cls._picker.boxing()
                    } else {
                        o = xui.create("DatePicker");
                        cls._picker = o.get(0);
                        o.beforeClose(function () {
                            this.boxing()._cache();
                            return false
                        }).beforeUIValueSet(function (p, ov, v) {
                            var profile = this,
                                box = profile.boxing(),
                                p = profile.properties;
                            p.dateStart = v;
                            box._cache()
                        })
                    }
                    o.setValue(from, true).setHost(profile);
                    node = o.reBoxing();
                    node.popToTop(src);
                    node.setBlurTrigger(profile.key + " - " + profile.$xid, function () {
                        box._cache()
                    });
                    xui.Event.keyboardHook("esc", 0, 0, 0, function () {
                        box._cache();
                        xui.Event.keyboardHook("esc")
                    })
                }
            },
            ITEM: {
                onClick: function (profile, e, src) {
                    if (profile.onClickTask) {
                        profile.boxing().onClickTask(profile, profile.getItemByDom(src), e, src)
                    }
                },
                onDblclick: function (profile, e, src) {
                    if (profile.onDblclickTask) {
                        profile.boxing().onDblclickTask(profile, profile.getItemByDom(src), e, src)
                    }
                },
                onDragbegin: function (profile, e, src) {
                    var t = profile.getItemByDom(src),
                        type = profile.$dd_type,
                        cursor = type ? "e-resize" : "move",
                        ac = profile.$active;
                    profile.$dd_ox = xui.DragDrop.getProfile().x;
                    profile.$dd_oleft = parseInt(xui.use(src).get(0).style.left, 10);
                    profile.$dd_owidth = Math.min(t._realwidth, parseInt(xui.use(src).get(0).style.width, 10));
                    xui([ac]).css("display", "block").cssPos({
                        left: profile.$dd_oleft,
                        top: null
                    }).width(profile.$dd_owidth - 2);
                    xui([ac, ac.parentNode]).css("cursor", cursor)
                },
                onDrag: function (profile, e, src) {
                    var x, w, offset = xui.DragDrop.getProfile().x - profile.$dd_ox,
                        ddl = profile.$dd_oleft,
                        ddw = profile.$dd_owidth,
                        type = profile.$dd_type,
                        mtype = type;
                    if (type == "left") {
                        if (offset < ddw) {
                            x = ddl + offset;
                            w = ddl + ddw - x
                        } else {
                            mtype = "right";
                            x = ddl + ddw;
                            w = offset - ddw
                        }
                    } else {
                        if (type == "right") {
                            if (-offset < ddw) {
                                x = ddl;
                                w = ddw + offset
                            } else {
                                mtype = "left";
                                x = ddl + offset + ddw;
                                w = -offset - ddw
                            }
                        } else {
                            mtype = "move";
                            x = ddl + offset;
                            w = ddw
                        }
                    }
                    profile.box._moveActive(profile, profile.$active, x, w, mtype)
                },
                onDragstop: function (profile, e, src) {
                    var box = profile.box,
                        r = profile.box._deActive(profile),
                        ac = profile.$active;
                    var from = box._getTime(profile, r.left),
                        to = box._getTime(profile, r.left + r.width);
                    if (profile.properties.multiTasks) {
                        if (profile.beforeTaskUpdated && false === profile.boxing().beforeTaskUpdated(profile, profile.getItemByDom(src), from, to)) {} else {
                            box._resetItem(profile, r, src)
                        }
                    } else {
                        profile.boxing().setUIValue(from + ":" + to)
                    }
                    profile.$dd_type = null;
                    xui([ac, ac.parentNode]).css("cursor", "")
                },
                onContextmenu: function (profile, e, src) {
                    return profile.boxing().onContextmenu(profile, e, src) !== false
                }
            },
            HEAD: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var ps = profile.properties,
                        item = profile.getItemByDom(src);
                    if (ps.disabled || item.disabled) {
                        return
                    }
                    if (ps.readonly || item.readonly) {
                        return
                    }
                    if (profile.beforeDragTask && false === profile.boxing().beforeDragTask(profile, item, e, src)) {
                        return
                    }
                    if (ps.readonly || item.readonly) {
                        return
                    }
                    xui.use(src).parent().startDrag(e, {
                        dragDefer: 1,
                        dragType: "none"
                    })
                },
                onClick: function () {
                    return false
                }
            },
            LEFT: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var ps = profile.properties,
                        item = profile.getItemByDom(src);
                    if (ps.disabled || ps.readonly || item.readonly || item.disabled) {
                        return
                    }
                    profile.$dd_type = "left";
                    xui.use(src).parent(3).startDrag(e, {
                        dragDefer: 1,
                        dragType: "none"
                    })
                }
            },
            RIGHT: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var ps = profile.properties,
                        item = profile.getItemByDom(src);
                    if (ps.disabled || ps.readonly || item.readonly || item.disabled) {
                        return
                    }
                    profile.$dd_type = "right";
                    xui.use(src).parent(3).startDrag(e, {
                        dragDefer: 1,
                        dragType: "none"
                    })
                }
            }
        },
        DataModel: {
            readonly: false,
            width: 400,
            height: 200,
            leftSpanCount: {
                ini: 0,
                inner: 1
            },
            rightSpanCount: {
                ini: 0,
                inner: 1
            },
            increment: 0,
            zoomable: {
                ini: true,
                action: function (v) {
                    if (this.properties.timeSpanKey) {
                        this.getSubNodes(["ZOOMIN", "ZOOMOUT"]).css("display", v ? "" : "none")
                    }
                }
            },
            dftTaskName: "task",
            taskHeight: {
                ini: 25,
                action: function (v) {
                    this.getSubNode("ITEM", true).height(v)
                }
            },
            timeSpanKey: {
                ini: "1 d",
                combobox: ["10 ms", "100 ms", "1 s", "10 s", "1 n", "5 n", "10 n", "30 n", "1 h", "2 h", "6 h", "1 d", "1 w", "15 d", "1 m", "1 q", "1 y", "1 de", "1 c"],
                action: function () {
                    this.box._refresh(this, true)
                }
            },
            unitPixs: 0,
            smallLabelCount: {
                inner: 1
            },
            smallLabelUnit: {
                inner: 1,
                listbox: _.toArr(xui.Date.$TIMEUNIT, true)
            },
            smallLabelFormat: {
                inner: 1,
                listbox: _.toArr(xui.Date.$TEXTFORMAT, true)
            },
            bigLabelCount: {
                inner: 1
            },
            bigLabelUnit: {
                inner: 1,
                listbox: _.toArr(xui.Date.$TIMEUNIT, true)
            },
            bigLabelFormat: {
                inner: 1,
                listbox: _.toArr(xui.Date.$TEXTFORMAT, true)
            },
            timeFormat: {
                inner: 1,
                listbox: _.toArr(xui.Date.$TEXTFORMAT, true)
            },
            showBar: {
                ini: true,
                action: function (v) {
                    this.getSubNode("TBAR").css("display", v ? "" : "none");
                    var p = this.properties,
                        w = p.width,
                        h = p.height;
                    p.width = p.height = 0;
                    xui.UI.$tryResize(this, w, h, true);
                    p.width = w, p.height = h
                }
            },
            showTips: {
                ini: true,
                action: function (v) {
                    this.getSubNode("TIPS").css("display", v ? "" : "none");
                    var p = this.properties,
                        w = p.width,
                        h = p.height;
                    p.width = p.height = 0;
                    xui.UI.$tryResize(this, w, h, true);
                    p.width = w, p.height = h
                }
            },
            showBigLabel: {
                ini: true,
                action: function (v) {
                    this.getSubNode("BIGLABEL").css("display", v ? "" : "none");
                    var p = this.properties,
                        w = p.width,
                        h = p.height;
                    p.width = p.height = 0;
                    xui.UI.$tryResize(this, w, h, true);
                    p.width = w, p.height = h
                }
            },
            _scrollRate: 5,
            multiTasks: {
                ini: false,
                action: function () {
                    this.box._refresh(this, true)
                }
            },
            taskMinSize: 60,
            minDate: {
                ini: null
            },
            maxDate: {
                ini: null
            },
            dateBtn: {
                ini: true,
                action: function (v) {
                    this.getSubNode("DATE").css("display", v ? "" : "none")
                }
            },
            closeBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("CLOSE").css("display", v ? "" : "none")
                }
            },
            optBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("OPT").css("display", v ? "" : "none")
                }
            },
            dateStart: {
                ini: new Date,
                action: function () {
                    this.box._refresh(this, true)
                }
            }
        },
        EventHandlers: {
            beforeClose: function (profile, src) {},
            onShowOptions: function (profile, e, src) {},
            onGetContent: function (profile, from, to, minMs, type, callback) {},
            onStartDateChanged: function (profile, odate, date) {},
            beforeTaskUpdated: function (profile, task, from, to) {},
            beforeNewTask: function (profile, task) {},
            beforeDragTask: function (profile, task, e, src) {},
            onClickTask: function (profile, task, e, src) {},
            onDblclickTask: function (profile, task, e, src) {}
        },
        Appearances: {
            MAINI: {
                "padding-top": "4px"
            },
            MAINC: {
                border: "solid 1px #648CB4",
                background: "#fff"
            },
            "BARCMDL span": {
                $order: 0,
                width: "15px",
                height: "15px",
                margin: "2px",
                "vertical-align": "middle",
                cursor: "default"
            },
            BAND: {
                "outline-offset": "-1px",
                "-moz-outline-offset": (xui.browser.gek && xui.browser.ver < 3) ? "-1px !important" : null,
                "font-size": "0",
                "line-height": "0"
            },
            "MAINP, VIEW, BAND, CON, BIGLABEL, SMALLLABEL": {
                position: "relative"
            },
            "MAINP, VIEW": {
                width: xui.browser.ie6 ? "100%" : null,
                overflow: "hidden"
            },
            SCROLL: {
                "z-index": 500,
                position: "absolute",
                "font-size": "0",
                "line-height": "0",
                right: 0,
                width: "18px",
                overflow: "auto",
                "overflow-x": "hidden"
            },
            SCROLLI: {
                height: "1000px",
                width: "1px"
            },
            BG: {
                "z-index": 2,
                position: "absolute",
                left: 0,
                top: 0,
                width: "100%"
            },
            LINES: {
                "z-index": 3,
                position: "absolute",
                left: 0,
                top: 0,
                width: "100%"
            },
            ITEMS: {
                "z-index": 4,
                position: "absolute",
                left: 0,
                top: 0,
                width: "100%",
                overflow: "hidden"
            },
            "LINES div": {
                position: "relative",
                "border-bottom": "solid 1px #7BA3CB"
            },
            "BIGLABEL, SMALLLABEL": {
                height: "16px",
                "background-color": "#C8E2FC",
                cursor: "move",
                "border-bottom": "solid 1px #7BA3CB"
            },
            "BIGLABEL div, SMALLLABEL div": {
                height: "16px",
                "border-left": "solid 1px #7BA3CB",
                "text-align": "center",
                position: "absolute",
                cursor: "move",
                top: 0,
                overflow: "visible"
            },
            "BIGLABEL div": {
                $order: 2,
                "text-align": "left",
                "padding-left": "4px"
            },
            TIPS: {
                position: "relative",
                height: "14px",
                "font-size": "12px",
                "line-height": "14px",
                "text-align": "center"
            },
            ACTIVE: {
                "z-index": 300,
                "border-left": "1px dashed",
                "border-right": "1px dashed",
                position: "absolute",
                top: 0,
                left: "-1000px",
                width: 0,
                background: 0,
                visibility: "hidden",
                height: "100%"
            },
            "ZOOMIN, ZOOMOUT, DATE, PRE, NEXT": {
                background: xui.UI.$bg("icons.gif", "no-repeat", true)
            },
            ZOOMIN: {
                $order: 1,
                "background-position": "-360px -70px"
            },
            "ZOOMIN-mouseover": {
                $order: 2,
                "background-position": "-360px -90px"
            },
            "ZOOMIN-mousedown": {
                $order: 3,
                "background-position": "-360px -110px"
            },
            ZOOMOUT: {
                $order: 1,
                "background-position": "-380px -70px"
            },
            "ZOOMOUT-mouseover": {
                $order: 2,
                "background-position": "-380px -90px"
            },
            "ZOOMOUT-mousedown": {
                $order: 3,
                "background-position": "-380px -110px"
            },
            DATE: {
                $order: 1,
                "background-position": "-340px -70px"
            },
            "DATE-mouseover": {
                $order: 2,
                "background-position": " -340px -90px"
            },
            "DATE-mousedown": {
                $order: 3,
                "background-position": " -340px -110px"
            },
            PRE: {
                $order: 1,
                "background-position": "-260px -70px",
                top: "0"
            },
            "PRE-mouseover": {
                $order: 2,
                "background-position": "-260px -90px"
            },
            "PRE-mousedown": {
                $order: 3,
                "background-position": "-260px -110px"
            },
            NEXT: {
                $order: 1,
                position: "absolute",
                "background-position": "-280px -70px",
                top: "0"
            },
            "NEXT-mouseover": {
                $order: 2,
                "background-position": "-280px -90px"
            },
            "NEXT-mousedown": {
                $order: 3,
                "background-position": "-280px -110px"
            },
            BGITEM: {
                position: "absolute",
                top: 0,
                height: "100%"
            },
            ITEM: {
                position: "absolute",
                overflow: "hidden"
            },
            "HEAD, BODY": {
                position: "relative",
                overflow: "hidden",
                "z-index": "1",
                border: "solid 1px #648CB4"
            },
            BODY: {
                $order: 2,
                cursor: "pointer",
                "background-color": "#F9F7D1",
                "border-top": "none"
            },
            "HEAD, HANDLER, TSKBAR, LEFT, RIGHT": {
                "font-size": "1px",
                "line-height": "1px"
            },
            HEAD: {
                cursor: "move",
                "background-color": "#FFF"
            },
            HANDLER: {
                position: "relative",
                height: "7px",
                background: xui.UI.$bg("handler.gif", "repeat #E8EEF7", true),
                "border-top": "solid 1px #648CB4"
            },
            TSKBAR: {
                position: "relative",
                height: "1px",
                "background-color": "#648CB4",
                width: "100%"
            },
            "LEFT, RIGHT": {
                position: "absolute",
                top: 0,
                height: "100%",
                width: "6px",
                "z-index": 10
            },
            LEFT: {
                cursor: "e-resize",
                left: "-1px"
            },
            RIGHT: {
                cursor: "w-resize",
                right: "-1px"
            },
            CON: {
                position: "relative",
                overflow: "hidden"
            },
            "ITEM-readonly HANDLER, ITEM-disabled HANDLER, ITEM-readonly LEFT, ITEM-disabled LEFT, ITEM-readonly RIGHT, ITEM-disabled RIGHT": {
                $order: 2,
                display: "none"
            },
            "ITEM-readonly HEAD, ITEM-disabled HEAD": {
                cursor: "default"
            },
            "ITEM-readonly CON, ITEM-disabled CON": {
                $order: 2,
                "background-color": "#E8EEF7"
            }
        },
        RenderTrigger: function () {
            var self = this,
                p = self.properties,
                cls = self.box;
            self.$active = self.getSubNode("ACTIVE").get(0);
            cls._ajustHeight(self)
        },
        _onDropMarkShow: function () {
            xui.DragDrop.setDragIcon("add");
            return false
        },
        _onDropMarkClear: function () {
            xui.DragDrop.setDragIcon("none");
            return false
        },
        _onDragEnter: function (profile, e, src) {
            var t = profile.properties,
                ep = xui.Event.getPos(e),
                _left = t._unitPixs / 2;
            xui(profile.$active).css("visibility", "visible");
            profile.$dd_ox = xui.use(src).offset().left + _left;
            profile.$$ondrag = true
        },
        _onDragLeave: function (profile) {
            profile.$$ondrag = profile.$dd_ox = null;
            profile.box._deActive(profile)
        },
        _onDrop: function (profile) {
            profile.$$ondrag = profile.$dd_ox = null;
            var r = profile.box._deActive(profile),
                task = {
                    id: _.id(),
                    caption: profile.properties.dftTaskName
                },
                box = profile.box,
                b = profile.boxing();
            task.from = box._getTime(profile, r.left);
            task.to = box._getTime(profile, r.left + r.width);
            task._dropData = xui.DragDrop.getProfile().dragData;
            if (profile.beforeNewTask && false === b.beforeNewTask(profile, task)) {} else {
                b.addTasks([task])
            }
        },
        _prepareData: function (profile) {
            var p = profile.properties,
                d = {},
                date = xui.Date,
                us = date.$TIMEUNIT,
                nodisplay = "display:none",
                zoom = profile.box.$zoom,
                m = 0,
                u, i, t, label, temp, _date, width, rate, _unitParas, _dateStart, _barCount, _leftBarCount, _rightBarCount, _barCountall, smallMarks, smallLabelStart, smallLabelEnd, smallLabelUnit, smallLabelCount, smallLabelFormat;
            d.dateDisplay = p.dateBtn ? "" : nodisplay;
            d.closeDisplay = p.closeBtn ? "" : nodisplay;
            d.optDisplay = p.optBtn ? "" : nodisplay;
            d._showBigLabel = p.showBigLabel ? "" : nodisplay;
            p._scroll_offset = p._scrollRate;
            p._lines = [{}];
            d._bWidth = p.width;
            d._bHeight = p.height;
            p._viewHeight = d._bHeight;
            d._tipsdisplay = p.showTips ? "" : nodisplay;
            d._bardisplay = p.showBar ? "" : nodisplay;
            if (p.timeSpanKey) {
                _.arr.each(zoom, function (o) {
                    if (o[0] === p.timeSpanKey) {
                        _unitParas = p._unitParas = o;
                        return false
                    }
                });
                if (!_unitParas) {
                    _unitParas = p._unitParas = zoom[p.timeSpanKey = "1 d"]
                }
            }
            d.zoomDisplay = (p.zoomable && _unitParas) ? "" : nodisplay;
            if (_unitParas) {
                p._unitPixs = p.unitPixs || _unitParas[1];
                p._smallLabelCount = p.smallLabelCount || _unitParas[2];
                p._smallLabelUnit = p.smallLabelUnit || _unitParas[3];
                p._smallLabelFormat = p.smallLabelFormat || _unitParas[4];
                p._bigLabelCount = p.bigLabelCount || _unitParas[5];
                p._bigLabelUnit = p.bigLabelUnit || _unitParas[6];
                p._bigLabelFormat = p.bigLabelFormat || _unitParas[7];
                p._timeFormat = p.timeFormat || _unitParas[8]
            }
            u = p._unitPixs;
            smallLabelCount = p._smallLabelCount;
            smallLabelUnit = p._smallLabelUnit;
            smallLabelFormat = p._smallLabelFormat;
            _barCount = (Math.ceil(p.width / u) || 0);
            _leftBarCount = p.leftSpanCount ? p.leftSpanCount : _barCount;
            _rightBarCount = p.rightSpanCount ? p.rightSpanCount : _barCount;
            _barCountall = _barCount + _leftBarCount + _rightBarCount;
            rate = p._rate = us[smallLabelUnit] * smallLabelCount / u;
            if (p.maxDate && date.add(p.dateStart, "ms", p.width * rate) > p.maxDate) {
                p.dateStart = date.add(p.maxDate, "ms", -p.width * rate)
            }
            if (p.minDate && p.dateStart < p.minDate) {
                p.dateStart = p.minDate
            }
            _dateStart = date.getTimSpanStart(p.dateStart, smallLabelUnit, smallLabelCount);
            smallLabelStart = p._smallLabelStart = date.add(_dateStart, smallLabelUnit, -_leftBarCount * smallLabelCount);
            smallLabelEnd = p._smallLabelEnd = date.add(smallLabelStart, smallLabelUnit, _barCountall * smallLabelCount);
            p._band_width = Math.ceil(date.diff(smallLabelStart, smallLabelEnd, "ms") / rate);
            p._band_left_fix = p._band_left = -Math.ceil(date.diff(smallLabelStart, p.dateStart, "ms") / rate);
            smallMarks = p._smallMarks = [];
            temp = 0;
            label = date.get(smallLabelStart, smallLabelFormat);
            for (i = 0; i < _barCountall; i++) {
                _date = date.add(smallLabelStart, smallLabelUnit, smallLabelCount * (i + 1));
                width = Math.ceil(date.diff(smallLabelStart, _date, "ms") / rate);
                smallMarks.push({
                    left: temp,
                    width: width - temp,
                    text: label
                });
                temp = width;
                label = date.getText(_date, smallLabelFormat)
            }
            if (p.showBigLabel) {
                var _barCount2, off, bigMarks, bigLabelStart, bigLabelEnd, bigLabelCount = p._bigLabelCount,
                    bigLabelUnit = p._bigLabelUnit,
                    bigLabelFormat = p._bigLabelFormat;
                bigMarks = p._bigMarks = [];
                bigLabelStart = p._bigLabelStart = date.getTimSpanStart(smallLabelStart, bigLabelUnit, bigLabelCount);
                bigLabelEnd = p._bigLabelEnd = date.getTimSpanEnd(smallLabelEnd, bigLabelUnit, bigLabelCount);
                _barCount2 = date.diff(bigLabelStart, bigLabelEnd, bigLabelUnit) / bigLabelCount;
                off = date.diff(smallLabelStart, bigLabelStart, "ms") / rate;
                label = date.getText(bigLabelStart, bigLabelFormat);
                temp = 0;
                for (i = 0; i < _barCount2; i++) {
                    _date = date.add(bigLabelStart, bigLabelUnit, bigLabelCount * (i + 1));
                    width = date.diff(bigLabelStart, _date, "ms") / rate;
                    bigMarks.push({
                        left: Math.ceil(temp + off),
                        width: Math.ceil(width - temp),
                        text: label
                    });
                    temp = width;
                    label = date.getText(_date, bigLabelFormat)
                }
            }
            return arguments.callee.upper.call(this, profile, d)
        },
        _prepareItem: function (profile, item, oitem, pid) {
            var self = this,
                t = profile.properties,
                index;
            if (!item.id) {
                item.id = _.id()
            }
            if (!item.caption) {
                item.caption = t.dftTaskName
            }
            item._realleft = item._left = self._getX(profile, item.from);
            item._realwidth = item._width = Math.max(self._getX(profile, item.to) - item._left, 0);
            if (item._width <= t.taskMinSize) {
                item._width = t.taskMinSize
            }
            if (item._left < 0) {
                item._left = 0
            }
            if (item._left + item._width > t._band_width) {
                item._width = t._band_width - item._left
            }
            item._perw = +(item._realwidth / item._width * 100).toFixed(2);
            if (item._perw >= 100) {
                item._perw = 100
            }
            index = self._getLinePos(profile, item);
            item._top = "top:" + (t.taskHeight + 1) * (index - 1) + "px";
            item._zindex = "z-index:" + index;
            item._background = item.background ? "background:" + item.background + ";" : "";
            item._excls = item.disabled ? profile.getClass("ITEM", "-disabled") : item.readonly ? profile.getClass("ITEM", "-readonly") : "";
            t._lines = t._lines || [{}];
            t._lines[index][item.id] = item;
            item._line = index;
            oitem._realleft = item._realleft;
            oitem._left = item._left;
            oitem._width = item._width;
            oitem._realwidth = item._realwidth;
            oitem._perw = item._perw;
            oitem._line = item._line
        },
        $zoom: [
            ["10 ms", 54, 10, "ms", "ms", 100, "ms", "hnsms", "hnsms"],
            ["100 ms", 54, 100, "ms", "ms", 1, "s", "hns", "hnsms"],
            ["1 s", 30, 1, "s", "s", 10, "s", "hns", "hnsms"],
            ["10 s", 30, 10, "s", "s", 60, "s", "hns", "hnsms"],
            ["1 n", 30, 1, "n", "n", 10, "n", "dhn", "hns"],
            ["5 n", 30, 5, "n", "n", 30, "n", "mdhn", "hns"],
            ["10 n", 30, 10, "n", "n", 60, "n", "mdhn", "hns"],
            ["30 n", 30, 30, "n", "n", 4, "h", "ymdh", "mdhn"],
            ["1 h", 30, 1, "h", "h", 6, "h", "ymdh", "mdhn"],
            ["2 h", 30, 2, "h", "h", 12, "h", "ymdh", "mdhn"],
            ["6 h", 30, 6, "h", "h", 24, "h", "ymd", "mdhn"],
            ["1 d", 24, 1, "d", "w", 1, "ww", "ymd", "ymdh"],
            ["1 w", 30, 1, "ww", "ww", 4, "ww", "ymd", "ymd"],
            ["15 d", 30, 15, "d", "d", 2, "m", "ymd", "ymd"],
            ["1 m", 30, 1, "m", "m", 1, "q", "yq", "ymd"],
            ["1 q", 30, 1, "q", "q", 1, "y", "y", "ymd"],
            ["1 y", 48, 1, "y", "y", 10, "y", "y", "ym"],
            ["1 de", 48, 1, "de", "de", 100, "y", "y", "ym"],
            ["1 c", 48, 1, "c", "c", 1000, "y", "y", "y"]
        ],
        _getTips: function (profile) {
            var t, s = "$dd_tooltip";
            if (t = profile[s] || (profile[s] = profile.getSubNode("TIPS").get(0).childNodes[0])) {
                return t.nodeValue
            } else {
                return profile.getSubNode("TIPS").get(0).innerHTML
            }
        },
        _rr: /\<[^>]*\>/g,
        _setTips: function (profile, text, force) {
            if (!force && profile.pauseA) {
                return
            }
            var t, s = "$dd_tooltip";
            text = text.replace(this._rr, "");
            if (t = profile[s] || (profile[s] = profile.getSubNode("TIPS").get(0).childNodes[0])) {
                if (t.nodeValue != text) {
                    t.nodeValue = text
                }
            } else {
                profile.getSubNode("TIPS").get(0).innerHTML = text
            }
        },
        _getX: function (profile, time) {
            var t = profile.properties,
                d = new Date;
            d.setTime(time);
            return (Math.ceil(xui.Date.diff(t._smallLabelStart, d, "ms") || 0) / t._rate)
        },
        _getTime: function (profile, x, flag) {
            var t = profile.properties;
            t = xui.Date.add(t._smallLabelStart, "ms", x * t._rate);
            return flag ? t : t.getTime()
        },
        _moveActive: function (profile, src, x, w, mtype) {
            var p = Math.ceil,
                t = profile.properties,
                d = xui.Date,
                s = t._smallLabelStart,
                r = t._rate,
                u = t._timeFormat,
                ms = "ms",
                y = src.style,
                z = "px",
                m, n, increment, xx = x;
            ww = w;
            if (!y.visibility || y.visibility == "hidden") {
                y.visibility = "visible"
            }
            if (increment = t.increment) {
                if (mtype == "move") {
                    x = Math.floor(xx / increment) * increment
                } else {
                    if (mtype == "left" || mtype == "all") {
                        x = Math.floor(xx / increment) * increment;
                        w = ww - (x - xx)
                    }
                    if (mtype == "right" || mtype == "all") {
                        m = Math.floor((w + increment - 1) / increment);
                        w = m * increment
                    }
                }
            }
            m = (p(x) || 0);
            n = ((p(w) || 0) - 2);
            if (n > 0) {
                y.left = m + z;
                y.width = n + z;
                if (t.showTips) {
                    profile.box._setTips(profile, d.getText(d.add(s, ms, x * r), u) + " - " + d.getText(d.add(s, ms, (x + w) * r), u))
                }
            }
            y = src = null
        },
        _deActive: function (profile) {
            var t = profile.$active.style,
                x = parseInt(t.left, 10) || 0,
                w = (parseInt(t.width, 10) || 0) + 2;
            t.visibility = "hidden";
            t.left = xui.Dom.HIDE_VALUE;
            t.width = 0;
            t = null;
            if (profile.properties.showTips) {
                profile.box._setTips(profile, "")
            }
            return {
                left: x,
                width: w
            }
        },
        _minusLeft: function (profile, marks, node, offsetCount) {
            var t = profile.properties;
            while ((offsetCount--) > 0) {
                node.first().remove();
                temp = marks.shift()
            }
        },
        _minusRight: function (profile, marks, node, offsetCount) {
            var t = profile.properties;
            while ((offsetCount--) > 0) {
                node.last().remove();
                temp = marks.pop()
            }
        },
        _addLeft: function (profile, tag, node, offsetCount, offset) {
            var t = profile.properties,
                date = xui.Date,
                key = tag + "Marks",
                marks = t[key],
                labelStart = t[tag + "LabelStart"],
                labelUnit = t[tag + "LabelUnit"],
                labelCount = t[tag + "LabelCount"],
                labelFormat = t[tag + "LabelFormat"],
                rate = t._rate,
                addLb = [],
                temp, label, _date, i;
            temp = 0;
            label = date.getText(labelStart, labelFormat);
            for (i = 0; i < offsetCount; i++) {
                _date = date.add(labelStart, labelUnit, labelCount * (i + 1));
                width = date.diff(labelStart, _date, "ms") / rate;
                addLb.push({
                    left: Math.ceil(temp + (offset || 0) - 3e-13),
                    width: Math.ceil(width - temp),
                    text: label
                });
                temp = width;
                label = date.getText(_date, labelFormat)
            }
            addLb.reverse();
            node.prepend(profile._buildItems(key, addLb, false));
            _.arr.insertAny(marks, addLb.reverse(), 0)
        },
        _addRight: function (profile, labelEnd, tag, node, offsetCount, offset) {
            var t = profile.properties,
                date = xui.Date,
                key = tag + "Marks",
                marks = t[key],
                labelStart = t[tag + "LabelStart"],
                labelUnit = t[tag + "LabelUnit"],
                labelCount = t[tag + "LabelCount"],
                labelFormat = t[tag + "LabelFormat"],
                rate = t._rate,
                addLb = [],
                _d1, _date, i;
            _d1 = labelEnd;
            for (i = 0; i < offsetCount; i++) {
                _date = date.add(labelEnd, labelUnit, labelCount * (i + 1));
                addLb.push({
                    left: Math.ceil(date.diff(labelStart, _d1, "ms") / rate + (offset || 0) - 3e-13),
                    width: Math.ceil(date.diff(_d1, _date, "ms") / rate),
                    text: date.getText(_d1, labelFormat)
                });
                _d1 = _date
            }
            node.append(profile._buildItems(key, addLb, false));
            _.arr.insertAny(marks, addLb, -1)
        },
        _getMoveNodes: function (profile) {
            return profile.$moveban = profile.$moveban || profile.getSubNode("VIEW")
        },
        _rePosition: function (profile, left) {
            profile.pause = true;
            var self = this,
                date = xui.Date,
                t = profile.properties,
                rate = t._rate,
                label, m, n, labelsBottom = profile.getSubNode("SMALLLABEL"),
                band = self._getMoveNodes(profile),
                x = left || band.left(),
                offset = x - t._band_left_fix;
            if (Math.abs(offset) / t._unitPixs >= 1 || left) {
                var offsetCount = parseInt(offset / t.unitPixs, 10),
                    bak_s = t._smallLabelStart,
                    bak_e = t._smallLabelEnd,
                    _c = -offsetCount * t._smallLabelCount,
                    offsetPxs, _smallLabelStart, _smallLabelEnd;
                _smallLabelStart = t._smallLabelStart = date.add(t._smallLabelStart, t._smallLabelUnit, _c);
                _smallLabelEnd = t._smallLabelEnd = date.add(t._smallLabelEnd, t._smallLabelUnit, _c);
                offsetPxs = Math.ceil(date.diff(_smallLabelStart, bak_s, "ms") / rate);
                band.left(x - offsetPxs);
                t._band_width = Math.ceil(date.diff(_smallLabelStart, _smallLabelEnd, "ms") / rate);
                _.arr.each(t.items, function (o) {
                    o._left += offsetPxs;
                    o._realleft += offsetPxs;
                    profile.box._trimTask(profile, o)
                });
                labelsBottom.children().each(function (o) {
                    o.style.left = (parseFloat(o.style.left) || 0) + offsetPxs + "px"
                });
                _.arr.each(t._smallMarks, function (o) {
                    o.left += offsetPxs
                });
                if (offsetCount > 0) {
                    self._minusRight(profile, t._smallMarks, labelsBottom, offsetCount);
                    self._addLeft(profile, "_small", labelsBottom, offsetCount)
                } else {
                    self._minusLeft(profile, t._smallMarks, labelsBottom, -offsetCount);
                    self._addRight(profile, bak_e, "_small", labelsBottom, -offsetCount)
                }
                if (t.multiTasks) {
                    var arr = [];
                    _.arr.each(t.items, function (o) {
                        if (o._left >= t._band_width || (o._left + o._width) <= 0) {
                            delete t._lines[o._line][o.id];
                            arr.push(o.id)
                        }
                    });
                    profile.boxing().removeItems(arr);
                    profile.boxing()._getContent(offsetCount > 0 ? _smallLabelStart : bak_e, offsetCount > 0 ? bak_s : _smallLabelEnd, t._rate, offsetCount > 0 ? "left" : "right");
                    self._reArrage(profile)
                }
                if (t.showBigLabel) {
                    var labelsTop = profile.getSubNode("BIGLABEL"),
                        bigLabelUnit = t._bigLabelUnit,
                        bigLabelCount = t._bigLabelCount,
                        off, offsetCount2, offsetCount3, bigLabelStart, bigLabelEnd;
                    bak_e = t._bigLabelEnd;
                    labelsTop.children().each(function (o) {
                        o.style.left = (parseFloat(o.style.left) || 0) + offsetPxs + "px"
                    });
                    _.arr.each(t._bigMarks, function (o) {
                        o.left += offsetPxs
                    });
                    bigLabelStart = date.getTimSpanStart(_smallLabelStart, bigLabelUnit, bigLabelCount);
                    offsetCount2 = Math.ceil(date.diff(_smallLabelStart, t._bigLabelStart, bigLabelUnit) / bigLabelCount);
                    offsetCount3 = Math.ceil(date.diff(t._bigLabelEnd, _smallLabelEnd, bigLabelUnit) / bigLabelCount);
                    if (offsetCount2) {
                        off = date.diff(_smallLabelStart, bigLabelStart, "ms") / rate;
                        t._bigLabelStart = bigLabelStart;
                        if (offsetCount2 > 0) {
                            self._addLeft(profile, "_big", labelsTop, offsetCount2, off)
                        } else {
                            self._minusLeft(profile, t._bigMarks, labelsTop, -offsetCount2)
                        }
                    }
                    if (offsetCount3) {
                        off = date.diff(_smallLabelStart, bigLabelStart, "ms") / rate;
                        t._bigLabelEnd = date.add(t._bigLabelEnd, bigLabelUnit, offsetCount3 * bigLabelCount);
                        if (offsetCount3 < 0) {
                            self._minusRight(profile, t._bigMarks, labelsTop, -offsetCount3)
                        } else {
                            self._addRight(profile, bak_e, "_big", labelsTop, offsetCount3, off)
                        }
                    }
                }
            }
            t._band_left = band.left();
            var od = t.dateStart;
            t.dateStart = self._getTime(profile, -t._band_left, 1);
            if (profile.onStartDateChanged) {
                profile.boxing().onStartDateChanged(profile, od, t.dateStart)
            }
            profile.pause = false
        },
        _trimTask: function (profile, o) {
            var x = o._realleft,
                w = o._realwidth,
                pro = profile.properties,
                bw = pro._band_width;
            if (w <= pro.taskMinSize) {
                w = pro.taskMinSize
            }
            if (x < 0) {
                if (x + w < 0) {
                    w = 0
                } else {
                    w = w + x
                }
                x = 0
            }
            if (x > bw) {
                x = bw
            }
            this._setItemNode(profile, o, "left", x + "px");
            o._left = x;
            if (x + w > bw) {
                w = bw - x
            }
            if (w >= 0) {
                if (o._width != w) {
                    o._width = w;
                    this._setItemNode(profile, o, "width", w + "px")
                }
            }
        },
        _setItemNode: function (profile, item, key, value) {
            var t = profile.getSubNodeByItemId("ITEM", item.id).get(0);
            t.style[key] = value
        },
        _getLinePos: function (profile, o) {
            var t = profile.properties,
                b = false,
                index = 0;
            _.arr.each(t._lines, function (v, i) {
                if (i === 0) {
                    return
                }
                b = true;
                _.each(v, function (v) {
                    if (o.id !== v.id) {
                        if (((o._left + o._width) >= v._left) && ((v._left + v._width) >= o._left)) {
                            return b = false
                        }
                    }
                });
                if (b) {
                    index = i;
                    return false
                }
            });
            if (!b) {
                index = t._lines.push({}) - 1
            }
            return index
        },
        _reArrage: function (profile) {
            var self = this,
                o, h, t = profile.properties;
            t._lines.length = 1;
            t.items.sort(function (x, y) {
                return x.from > y.from ? 1 : x.from == y.from ? 0 : -1
            });
            _.arr.each(t.items, function (v) {
                if (v._line === 0) {
                    return
                }
                index = self._getLinePos(profile, v);
                t._lines[index][v.id] = v;
                if (v._line !== index) {
                    v._line = index;
                    if (t.multiTasks) {
                        self._setItemNode(profile, v, "top", (t.taskHeight + 1) * (index - 1) + "px");
                        self._setItemNode(profile, v, "zIndex", index)
                    }
                }
            });
            h = t._linesHeight = t._lines.length * (t.taskHeight + 1);
            self._ajustHeight(profile)
        },
        _resetItem: function (profile, o, src) {
            var p = profile.properties,
                t = profile.getItemByDom(src),
                bandW = p._band_width,
                f = function (k, i) {
                    return profile.getSubNodeByItemId(k, i)
                },
                timeline = profile.box,
                max = Math.max,
                temp;
            if (o.left) {
                t._realleft = t._left = o.left;
                t.from = timeline._getTime(profile, o.left);
                xui.use(src).get(0).style.left = t._left + "px"
            }
            if (o.width) {
                t.to = timeline._getTime(profile, o.left + o.width);
                t._realwidth = t._width = o.width;
                if (t._width <= p.taskMinSize) {
                    t._width = p.taskMinSize
                } else {
                    if (o.left + o.width > bandW) {
                        t._width = bandW - o.left
                    }
                }
                xui.use(src).get(0).style.width = t._width + "px";
                temp = +(t._realwidth / t._width * 100).toFixed(2);
                if (temp >= 100) {
                    temp = 100
                }
                if (temp != t._perw) {
                    t._perw = temp;
                    xui.use(src).first(2).get(0).style.width = temp + "%"
                }
            }
            timeline._reArrage(profile)
        },
        _ajustHeight: function (profile) {
            var p = profile.properties,
                f = function (p) {
                    return profile.getSubNode(p)
                },
                view = f("CON"),
                items = f("ITEMS"),
                lines = f("LINES"),
                h, b, ih = p._linesHeight || 0,
                vh = view.height();
            h = Math.max(ih, vh);
            b = ih > vh;
            f("SCROLLI").height(h);
            f("SCROLL").css("display", b ? "block" : "none");
            items.height(h);
            lines.height(h);
            items.top(b ? -f("SCROLL").scrollTop() : 0);
            lines.top(b ? -f("SCROLL").scrollTop() : 0);
            var len = parseInt(h / p.taskHeight, 10) + 1,
                size = f("LINES").get(0).childNodes.length;
            if (size < len) {
                f("LINES").append(xui.create(_.str.repeat('<div style="height:' + p.taskHeight + 'px;"></div>', len - size)))
            }
        },
        _showTips: function (profile, node, pos) {
            if (profile.properties.disableTips) {
                return
            }
            if (profile.onShowTips) {
                return profile.boxing().onShowTips(profile, node, pos)
            }
            if (!xui.Tips) {
                return
            }
            var t = profile.properties,
                id = node.id,
                format = t._timeFormat,
                sid = profile.getSubId(id),
                map = profile.SubSerialIdMapItem,
                item = map && map[sid],
                date = xui.Date;
            if (t.disabled) {
                return
            }
            if (item && item.disabled) {
                return
            }
            if (item) {
                item.tips = '<p style="font-weight:bold">' + item.caption + "</p>" + date.getText(new Date(item.from), format) + " - " + date.getText(new Date(item.to), format);
                xui.Tips.show(pos, item);
                return true
            } else {
                return false
            }
        },
        _beforeSerialized: function (profile) {
            var w = profile.properties.width,
                o = arguments.callee.upper.call(this, profile);
            o.properties.width = w;
            return o
        },
        _onresize: function (profile, width, height) {
            var pro = profile.properties,
                f = function (k) {
                    return profile.getSubNode(k)
                },
                _bbarH = f("BBAR").height(),
                _tipsH = f("TAIL").height(),
                off2 = f("CON").offset(null, profile.getRoot()),
                off3 = 2,
                h2, t;
            if (height && profile._$h != height) {
                f("BORDER").height(profile._$h = t = height);
                f("CON").height(t = t - (pro.showTips ? _tipsH : 0) - off2.top - (pro.showBar ? _bbarH : 0) - off3);
                h2 = f("BAND").height();
                f("SCROLL").top(h2).height(t + h2);
                profile.getSubNodes(["BG", "ITEMS", "SCROLL"]).height(t);
                this._ajustHeight(profile);
                if (xui.browser.ie6) {
                    f("ACTIVE").height(f("VIEW").height() + 2)
                }
            }
            if (width && profile._$w != width) {
                f("BORDER").width(profile._$w = pro.width = width);
                var ins = profile.boxing(),
                    items = ins.getItems("data"),
                    bak_s = pro._smallLabelStart,
                    bak_e = pro._smallLabelEnd,
                    offset, uivalue;
                this._refresh(profile);
                offset = bak_s - pro._smallLabelStart;
                if (!pro.multiTasks) {
                    uivalue = pro.$UIvalue
                }
                ins.setItems(items);
                if (!pro.multiTasks) {
                    ins.setUIValue(uivalue, true)
                } else {
                    var arr = [];
                    _.arr.each(pro.items, function (o) {
                        if (o._left >= pro._band_width || (o._left + o._width) <= 0) {
                            delete pro._lines[o._line][o.id];
                            arr.push(o.id)
                        }
                    });
                    ins.removeItems(arr)
                }
                if (offset > 0) {
                    if (!profile._iniOK) {
                        ins.iniContent()
                    } else {
                        ins._getContent(pro._smallLabelStart, bak_s, pro._rate, "left");
                        ins._getContent(bak_e, pro._smallLabelEnd, pro._rate, "right")
                    }
                }
                this._reArrage(profile)
            }
        },
        _refresh: function (profile, force) {
            var pro = profile.properties,
                ins = profile.boxing(),
                nodes, uivalue;
            if (!pro.multiTasks) {
                uivalue = pro.$UIvalue
            }
            ins.clearItems();
            this._prepareData(profile);
            nodes = profile._buildItems("_smallMarks", pro._smallMarks, false);
            profile.getSubNode("SMALLLABEL").empty().append(nodes);
            if (pro.showBigLabel) {
                nodes = profile._buildItems("_bigMarks", pro._bigMarks, false);
                profile.getSubNode("BIGLABEL").empty().append(nodes)
            }
            profile.getSubNode("VIEW").left(pro._band_left).width(pro._band_width);
            if (!pro.multiTasks) {
                ins.setUIValue(uivalue, true)
            } else {
                if (force) {
                    ins.iniContent()
                }
            }
            return this
        }
    }
});
Class("xui.UI.List", ["xui.UI", "xui.absList", "xui.absValue"], {
    Instance: {
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                if (!profile.renderId) {
                    return
                }
                var box = profile.box,
                    uiv = profile.boxing().getUIValue(),
                    p = profile.properties,
                    item = box._ITEMKEY || "ITEM",
                    k = box._DIRTYKEY || "ITEM",
                    getN = function (k, i) {
                        return profile.getSubNode(k, i)
                    },
                    getI = function (i) {
                        return profile.getSubIdByItemId(i)
                    };
                if (p.selMode == "single") {
                    var itemId = getI(uiv);
                    if (uiv !== null && itemId) {
                        getN(k, itemId).tagClass("-checked", false).tagClass("-mouseover", false)
                    }
                    itemId = getI(value);
                    if (itemId) {
                        getN(k, itemId).tagClass("-checked")
                    }
                    if (itemId) {
                        var o = getN(item, itemId);
                        if (o) {
                            var items = profile.getSubNode("ITEMS"),
                                offset = o.offset(null, items),
                                top = offset ? offset.top : 0,
                                height = o.offsetHeight(),
                                sh = items.scrollHeight(),
                                st = items.scrollTop(),
                                hh = items.height();
                            if (sh > hh) {
                                if (top < st || (top + height) > (st + hh)) {
                                    items.scrollTop(top)
                                }
                            }
                        }
                    }
                } else {
                    if (p.selMode == "multi" || p.selMode == "multibycheckbox") {
                        uiv = uiv ? uiv.split(p.valueSeparator) : [];
                        value = value ? value.split(p.valueSeparator) : [];
                        _.arr.each(uiv, function (o) {
                            getN(k, getI(o)).tagClass("-checked", false).tagClass("-mouseover", false)
                        });
                        _.arr.each(value, function (o) {
                            getN(k, getI(o)).tagClass("-checked")
                        })
                    }
                }
            })
        },
        _clearMouseOver: function () {
            var box = this.constructor,
                item = box._ITEMKEY || "ITEM";
            this.getSubNode(item, true).tagClass("-mouseover", false)
        },
        adjustSize: function () {
            return this.each(function (profile) {
                if (profile.properties.height != "auto") {
                    var items = profile.getSubNode("ITEMS"),
                        pp = profile.properties;
                    items.height("auto");
                    var h = Math.min(pp.maxHeight, items.offsetHeight());
                    pp.height = h;
                    items.height(h);
                    profile.getRoot().height(h)
                } else {
                    items.height("auto");
                    profile.getRoot().height("auto")
                }
            })
        },
        activate: function () {
            return xui.absList.prototype.activate.call(this)
        },
        getShowValue: function (value) {
            var profile = this.get(0),
                pro = profile.properties,
                v, t;
            if (!_.isDefined(value)) {
                value = pro.$UIvalue
            }
            if ((v = _.arr.subIndexOf(pro.items, "id", value)) != -1) {
                v = pro.items[v].caption;
                v = v.charAt(0) == "$" ? xui.getRes(v.slice(1)) : v
            } else {
                v = ""
            }
            return v
        },
        _setDirtyMark: function () {
            return arguments.callee.upper.apply(this, ["ITEMS"])
        }
    },
    Static: {
        _DIRTYKEY: "ITEM",
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "xui-uibg-base {_className}",
            ITEMS: {
                $order: 10,
                tagName: "div",
                className: "{_bordertype}",
                text: "{items}"
            },
            $submap: {
                items: {
                    ITEM: {
                        className: "{itemClass} {disabled} {readonly}",
                        style: "{itemStyle}{itemDisplay}",
                        tabindex: "{_tabindex}",
                        MARK: {
                            $order: 5,
                            style: "{_cbDisplay}"
                        },
                        ICON: {
                            $order: 10,
                            className: "xui-ui-icon {imageClass}",
                            style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                        },
                        CAPTION: {
                            tagName: "text",
                            text: "&nbsp;{caption}",
                            $order: 20
                        },
                        EXTRA: {
                            text: "{ext}",
                            $order: 30
                        }
                    }
                }
            }
        },
        Appearances: {
            KEY: {
                "font-size": "12px"
            },
            EXTRA: {
                display: "none"
            },
            ITEMS: {
                position: "relative",
                overflow: "auto",
                "overflow-x": "hidden"
            },
            ITEM: {
                display: "block",
                zoom: xui.browser.ie ? 1 : null,
                "font-family": '"Verdana", "Helvetica", "sans-serif"',
                border: 0,
                cursor: "pointer",
                "font-size": "12px",
                padding: "4px 2px",
                position: "relative"
            },
            "ITEM-mouseover, ITEM-mousedown, ITEM-checked": {
                background: xui.UI.$bg("item.gif", "repeat-x")
            },
            "ITEM-mouseover": {
                $order: 1,
                "background-color": "#FAD200",
                "background-position": "left -51px"
            },
            "ITEM-mousedown": {
                $order: 2,
                "background-color": "#F5D22D",
                "background-position": "left -101px"
            },
            "ITEM-checked": {
                $order: 2,
                "background-color": "#AAD2FA",
                "background-position": "left top"
            },
            MARK: {
                $order: 1,
                cursor: "pointer",
                width: "16px",
                height: "16px",
                "vertical-align": "middle",
                background: xui.UI.$bg("icons.gif", "no-repeat -20px -70px", true)
            },
            "ITEM-checked MARK": {
                $order: 2,
                "background-position": "0 -70px"
            }
        },
        Behaviors: {
            HoverEffected: {
                ITEM: "ITEM"
            },
            ClickEffected: {
                ITEM: "ITEM"
            },
            DraggableKeys: ["ITEM"],
            DroppableKeys: ["ITEM", "ITEMS"],
            onSize: xui.UI.$onSize,
            ITEM: {
                onDblclick: function (profile, e, src) {
                    var properties = profile.properties,
                        item = profile.getItemByDom(src);
                    profile.boxing().onDblclick(profile, item, e, src)
                },
                onClick: function (profile, e, src) {
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId = profile.getSubId(src),
                        box = profile.boxing(),
                        ks = xui.Event.getKey(e),
                        rt, rt2;
                    if (profile.beforeClick && false === o.boxing().beforeClick(profile, item, e, src)) {
                        return
                    }
                    if (properties.disabled || item.disabled) {
                        return false
                    }
                    if (profile.onClick) {
                        box.onClick(profile, item, e, src)
                    }
                    xui.use(src).focus();
                    switch (properties.selMode) {
                    case "none":
                        rt = box.onItemSelected(profile, item, e, src, 0);
                        break;
                    case "multibycheckbox":
                        if (properties.readonly || item.readonly) {
                            return false
                        }
                        if (profile.keys.MARK) {
                            if (profile.getKey(xui.Event.getSrc(e).id || "") != profile.keys.MARK) {
                                rt = box.onItemSelected(profile, item, e, src, 0);
                                rt = false;
                                break
                            }
                        }
                    case "multi":
                        if (properties.readonly || item.readonly) {
                            return false
                        }
                        var value = box.getUIValue(),
                            arr = value ? value.split(properties.valueSeparator) : [],
                            checktype = 1;
                        if (arr.length && (ks.ctrlKey || ks.shiftKey || properties.noCtrlKey || properties.$checkbox)) {
                            rt2 = false;
                            if (ks.shiftKey) {
                                var items = properties.items,
                                    i1 = _.arr.subIndexOf(items, "id", profile.$firstV.id),
                                    i2 = _.arr.subIndexOf(items, "id", item.id),
                                    i;
                                arr.length = 0;
                                for (i = Math.min(i1, i2); i <= Math.max(i1, i2); i++) {
                                    arr.push(items[i].id)
                                }
                            } else {
                                if (_.arr.indexOf(arr, item.id) != -1) {
                                    _.arr.removeValue(arr, item.id);
                                    checktype = -1
                                } else {
                                    arr.push(item.id)
                                }
                            }
                            arr.sort();
                            value = arr.join(properties.valueSeparator);
                            if (box.getUIValue() == value) {
                                rt = false
                            } else {
                                box.setUIValue(value);
                                if (box.get(0) && box.getUIValue() == value) {
                                    rt = box.onItemSelected(profile, item, e, src, checktype) || rt2
                                }
                            }
                            break
                        }
                    case "single":
                        if (properties.readonly || item.readonly) {
                            return false
                        }
                        if (box.getUIValue() == item.id) {
                            rt = false
                        } else {
                            profile.$firstV = item;
                            box.setUIValue(item.id);
                            if (box.get(0) && box.getUIValue() == item.id) {
                                rt = box.onItemSelected(profile, item, e, src, 1)
                            }
                        }
                        break
                    }
                    var node = xui.use(src).get(0),
                        href = node && node.href;
                    node = null;
                    if (profile.afterClick) {
                        box.afterClick(profile, item, e, src)
                    }
                    return (!href || href.indexOf("javascript:") == 0) ? false : rt
                },
                onKeydown: function (profile, e, src) {
                    var keys = xui.Event.getKey(e),
                        key = keys[0],
                        shift = keys[2],
                        cur = xui(src),
                        first = profile.getRoot().nextFocus(true, true, false),
                        last = profile.getRoot().nextFocus(false, true, false);
                    switch (xui.Event.getKey(e)[0]) {
                    case "tab":
                        if (shift) {
                            if (cur.get(0) != first.get(0)) {
                                first.focus();
                                return false
                            }
                        } else {
                            if (cur.get(0) != last.get(0)) {
                                last.focus();
                                return false
                            }
                        }
                        break;
                    case "left":
                    case "up":
                        var next = cur.nextFocus(false, true, false);
                        if (cur.get(0) == first.get(0)) {
                            last.focus()
                        } else {
                            cur.nextFocus(false)
                        }
                        return false;
                        break;
                    case "right":
                    case "down":
                        var next = cur.nextFocus(true, false, false);
                        if (cur.get(0) == last.get(0)) {
                            first.focus()
                        } else {
                            cur.nextFocus()
                        }
                        return false;
                        break;
                    case "enter":
                        cur.onClick(true);
                        break
                    }
                },
                onContextmenu: function (profile, e, src) {
                    if (profile.onContextmenu) {
                        return profile.boxing().onContextmenu(profile, e, src, profile.getItemByDom(src)) !== false
                    }
                }
            }
        },
        DataModel: {
            selMode: {
                ini: "single",
                listbox: ["single", "none", "multi", "multibycheckbox"],
                action: function (value) {
                    if (!this.box._ITEMMARKED) {
                        this.getSubNode("MARK", true).css("display", (value == "multi" || value == "multibycheckbox") ? "" : "none")
                    }
                }
            },
            borderType: {
                ini: "flat",
                listbox: ["none", "flat", "inset", "outset"],
                action: function (v) {
                    var ns = this,
                        p = ns.properties,
                        node = ns.getSubNode("ITEMS"),
                        reg = /^xui-uiborder-/,
                        pretag = "xui-uiborder-",
                        root = ns.getRoot();
                    node.removeClass(reg);
                    node.addClass(pretag + v);
                    xui.UI.$tryResize(ns, root.get(0).style.width, root.get(0).style.height, true)
                }
            },
            noCtrlKey: true,
            width: 120,
            height: 150,
            maxHeight: 300
        },
        EventHandlers: {
            onClick: function (profile, item, e, src) {},
            beforeClick: function (profile, item, e, src) {},
            afterClick: function (profile, item, e, src) {},
            onDblclick: function (profile, item, e, src) {},
            onItemSelected: function (profile, item, e, src, type) {}
        },
        _onStartDrag: function (profile, e, src, pos) {
            var pos = xui.Event.getPos(e);
            xui.use(src).startDrag(e, {
                dragType: "icon",
                shadowFrom: src,
                targetLeft: pos.left + 12,
                targetTop: pos.top + 12,
                dragCursor: "pointer",
                dragDefer: 1,
                dragKey: profile.box.getDragKey(profile, src),
                dragData: profile.box.getDragData(profile, e, src)
            });
            return false
        },
        _onDropTest: function (profile, e, src, key, data, item) {
            var fid = data && data.domId,
                tid = xui.use(src).id();
            if (fid) {
                if (fid == tid) {
                    return false
                }
                if (_.get(xui.use(src).get(0), ["previousSibling", "id"]) == fid) {
                    return false
                }
            }
        },
        _onDrop: function (profile, e, src, key, data, item) {
            xui.DragDrop.setDragIcon("none");
            var k = profile.getKey(xui.use(src).id()),
                po = data.profile,
                ps = data.domId,
                oitem, t = xui.absObj.$specialChars;
            oitem = _.clone(po.getItemByDom(ps), function (o, i) {
                return !t[(i + "").charAt(0)]
            });
            po.boxing().removeItems([oitem.id]);
            if (k == profile.keys.ITEM) {
                profile.boxing().insertItems([oitem], item.id, true)
            } else {
                profile.boxing().insertItems([oitem])
            }
            return false
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            data._bordertype = "xui-uiborder-" + data.borderType;
            return data
        },
        _prepareItem: function (profile, item) {
            item._cbDisplay = (profile.properties.selMode == "multi" || profile.properties.selMode == "multibycheckbox") ? "" : "display:none;"
        },
        _onresize: function (profile, width, height) {
            var size = profile.properties.borderType != "none" ? 2 : 0;
            if (height) {
                profile.getSubNode("ITEMS").height(height == "auto" ? height : (height - size))
            }
            if (width) {
                profile.getSubNode("ITEMS").width(width == "auto" ? width : (width - size))
            }
        }
    }
});
Class("xui.UI.Gallery", "xui.UI.List", {
    Instance: {
        getStatus: function (id) {
            var item = this.get(0).getItemByItemId(id);
            return (item && item._status) || "ini"
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        t.$submap = {
            items: {
                ITEM: {
                    tabindex: "{_tabindex}",
                    className: "{itemClass} {disabled} {readonly}",
                    style: "padding:{itemPadding}px;margin:{itemMargin}px;{itemStyle}",
                    ITEMFRAME: {
                        style: "width:{itemWidth}px;height:{itemHeight}px;",
                        CAPTION: {
                            tagName: "div",
                            style: "{capDisplay}",
                            text: "{caption}",
                            $order: 0
                        },
                        CONTENT: {
                            tagName: "div",
                            $order: 1,
                            IBWRAP: {
                                tagName: "div",
                                IMAGE: {
                                    tagName: "img",
                                    src: "{image}",
                                    width: "{imgWidth}",
                                    height: "{imgHeight}",
                                    style: "{imgStyle}"
                                }
                            }
                        },
                        COMMENT: {
                            tagName: "div",
                            text: "{comment}",
                            $order: 2
                        }
                    }
                }
            }
        };
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            KEY: {
                overflow: "visible"
            },
            ITEMS: {
                position: "relative",
                overflow: "auto",
                "overflow-x": "hidden",
                zoom: xui.browser.ie6 ? 1 : null
            },
            ITEM: {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                position: "relative",
                cursor: "pointer",
                "vertical-align": "top",
                border: "solid 1px #C2E4FC",
                margin: 0
            },
            ITEMFRAME: {
                display: xui.browser.ie ? "inline-block" : "block",
                position: "relative",
                overflow: "hidden",
                border: 0,
                padding: 0,
                margin: 0,
                width: "100%",
                height: "100%",
                "-moz-box-flex": "1"
            },
            IBWRAP: {
                "font-size": 0,
                "line-height": 0
            },
            "ITEM-mouseover": {
                $order: 1,
                padding: 0,
                border: "solid 1px #a0c8f0",
                "background-color": "#e1f0ff"
            },
            "ITEM-mousedown": {
                $order: 2,
                padding: 0,
                border: "solid 1px #dcdcdc",
                "background-color": "#bbcef1"
            },
            "ITEM-checked": {
                $order: 2,
                padding: 0,
                border: "solid 1px #bbcef1",
                "background-color": "#bbcef1"
            },
            "ITEM-mouseover, ITEM-mousedown, ITEM-checked": {},
            IMAGE: {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                "vertical-align": "middle"
            },
            "CONTENT, CAPTION": {
                "text-align": "center",
                overflow: "hidden",
                "white-space": "nowrap"
            },
            CAPTION: {
                "font-weight": "bold"
            },
            COMMENT: {
                display: "block",
                "font-size": "12px",
                margin: "0 2px 0 2px",
                "text-align": "center"
            }
        },
        Behaviors: {
            IMAGE: {
                onLoad: function (profile, e, src) {
                    var item = profile.getItemByDom(src);
                    item._status = "loaded"
                },
                onError: function (profile, e, src) {
                    var item = profile.getItemByDom(src);
                    item._status = "error"
                }
            }
        },
        DataModel: ({
            itemMargin: {
                ini: 6,
                action: function (v) {
                    if (typeof v != "object") {
                        this.getSubNode("ITEM", true).css("margin", ("" + parseFloat(v)) == ("" + v) ? v + "px" : v)
                    } else {
                        this.getSubNode("ITEM", true).css(v)
                    }
                }
            },
            itemPadding: {
                ini: 2,
                action: function (v) {
                    if (typeof v != "object") {
                        this.getSubNode("ITEM", true).css("padding", ("" + parseFloat(v)) == ("" + v) ? v + "px" : v)
                    } else {
                        this.getSubNode("ITEM", true).css(v)
                    }
                }
            },
            itemWidth: {
                ini: 32,
                action: function (v) {
                    this.getSubNode("ITEMFRAME", true).width(v)
                }
            },
            itemHeight: {
                ini: 32,
                action: function (v) {
                    this.getSubNode("ITEMFRAME", true).height(v)
                }
            },
            imgWidth: {
                ini: 16,
                action: function (v) {
                    this.getSubNode("IMAGE", true).width(v)
                }
            },
            imgHeight: {
                ini: 16,
                action: function (v) {
                    this.getSubNode("IMAGE", true).height(v)
                }
            },
            width: 200,
            height: 200
        }),
        _prepareItem: function (profile, item) {
            var p = profile.properties;
            _.arr.each(_.toArr("itemWidth,itemHeight,imgWidth,imgHeight,itemPadding,itemMargin"), function (i) {
                item[i] = item[i] || p[i]
            });
            item.capition = item.capition || "";
            if (item.caption === null) {
                capDisplay = "display:none;"
            }
            item.comment = item.comment || "";
            item._tabindex = p.tabindex;
            if (!item.image) {
                item.image = xui.ini.img_bg
            }
        }
    }
});
Class("xui.UI.IconList", "xui.UI.List", {
    Instance: {
        getStatus: function (id) {
            var item = this.get(0).getItemByItemId(id);
            return (item && item._status) || "ini"
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        t.$submap = {
            items: {
                ITEM: {
                    tabindex: "{_tabindex}",
                    className: "{itemClass} {disabled}  {readonly}",
                    style: "padding:{itemPadding}px;margin:{itemMargin}px;{itemStyle};{itemDisplay}",
                    IBWRAP: {
                        tagName: "div",
                        IMAGE: {
                            tagName: "img",
                            src: "{image}",
                            width: "{itemWidth}",
                            height: "{itemHeight}",
                            style: "{imgStyle}"
                        }
                    }
                }
            }
        };
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            KEY: {
                overflow: "auto",
                "overflow-x": "hidden"
            },
            ITEMS: {
                overflow: "auto",
                "overflow-x": "hidden",
                position: "relative",
                "line-height": "14px",
                zoom: xui.browser.ie6 ? 1 : null
            },
            ITEM: {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                position: "relative",
                cursor: "pointer",
                border: "solid 1px #C2E4FC",
                "vertical-align": "top"
            },
            IBWRAP: {
                "font-size": 0,
                "line-height": 0
            },
            "ITEM-mouseover": {
                $order: 1,
                padding: 0,
                border: "solid 1px #a0c8f0",
                "background-color": "#e1f0ff"
            },
            "ITEM-mousedown": {
                $order: 2,
                padding: 0,
                border: "solid 1px #dcdcdc",
                "background-color": "#bbcef1"
            },
            "ITEM-checked": {
                $order: 2,
                padding: 0,
                border: "solid 1px #bbcef1",
                "background-color": "#bbcef1"
            },
            "ITEM-mouseover, ITEM-mousedown, ITEM-checked": {}
        },
        Behaviors: {
            IMAGE: {
                onLoad: function (profile, e, src) {
                    var item = profile.getItemByDom(src);
                    item._status = "loaded"
                },
                onError: function (profile, e, src) {
                    var item = profile.getItemByDom(src);
                    item._status = "error"
                }
            }
        },
        DataModel: ({
            itemMargin: {
                ini: 6,
                action: function (v) {
                    if (typeof v != "object") {
                        this.getSubNode("ITEM", true).css("margin", ("" + parseFloat(v)) == ("" + v) ? v + "px" : v)
                    } else {
                        this.getSubNode("ITEM", true).css(v)
                    }
                }
            },
            itemPadding: {
                ini: 2,
                action: function (v) {
                    if (typeof v != "object") {
                        this.getSubNode("ITEM", true).css("padding", ("" + parseFloat(v)) == ("" + v) ? v + "px" : v)
                    } else {
                        this.getSubNode("ITEM", true).css(v)
                    }
                }
            },
            itemWidth: {
                ini: 16,
                action: function (v) {
                    this.getSubNode("IMAGE", true).width(v)
                }
            },
            itemHeight: {
                ini: 16,
                action: function (v) {
                    this.getSubNode("IMAGE", true).height(v)
                }
            },
            width: 200,
            height: 200
        }),
        _prepareItem: function (profile, item) {
            var p = profile.properties;
            _.arr.each(_.toArr("itemWidth,itemHeight,itemPadding,itemMargin"), function (i) {
                item[i] = item[i] || p[i]
            });
            item._tabindex = p.tabindex;
            if (!item.image) {
                item.image = xui.ini.img_bg
            }
        }
    }
});
Class("xui.UI.Poll", "xui.UI.List", {
    Instance: {
        fillContent: function (id, obj) {
            var profile = this.get(0),
                t, item;
            if (profile.renderId) {
                if (item = profile.getItemByItemId(id)) {
                    t = profile.getSubNodeByItemId("BODY", id).html("");
                    if (obj) {
                        item._obj = obj;
                        item._fill = true;
                        if (typeof obj == "string") {
                            t.html(obj)
                        } else {
                            t.append(obj.render(true))
                        }
                    } else {
                        item._obj = item._fill = null
                    }
                }
            }
            return this
        },
        _setOptCap: function (item, value) {
            return this.each(function (pro) {
                var items = pro.properties.items,
                    i = pro.queryItems(pro.properties.items, function (o) {
                        return o.id == item.id
                    }, false, true);
                if (i && (i = i[0])) {
                    i.caption = value;
                    if (pro.renderId) {
                        pro.getSubNodeByItemId("CAPTION", i.id).html(value)
                    }
                }
            })
        },
        getBindEditor: function () {
            return this.get(0)._bind
        },
        _insertOpt: function (opt) {
            if (!opt.id) {
                opt.id = "$" + _()
            }
            this.insertItems([opt]);
            return this
        },
        _removeOpt: function (id) {
            this.removeItems([id], "OUTER");
            return this
        },
        _setDirtyMark: function () {
            return this
        }
    },
    Initialize: function () {
        var self = this;
        self.addTemplateKeys(["EDIT"]);
        var t = self.getTemplate();
        t.TITLE = {
            $order: 2,
            tagName: "DIV",
            style: "{titleDisplay}",
            text: "{title}",
            className: "xui-uibg-bar xui-uiborder-outset {disabled} {_cls}"
        };
        t.TAIL = {
            $order: 20,
            tagName: "DIV",
            className: "xui-uibg-bar xui-uiborder-outset {disabled}",
            text: "{cmds}"
        };
        t.$submap = {
            items: {
                OUTER: {
                    tagName: "div",
                    className: "xui-uibg-bar xui-uiborder-outset",
                    TOGGLE: {
                        className: "xui-uicmd-toggle",
                        style: "{_togdisplay}"
                    },
                    ITEM: {
                        tabindex: "{_tabindex}",
                        className: "{itemClass} {disabled}",
                        style: "{itemStyle}",
                        OPTION: {
                            $order: 0,
                            tagName: "DIV",
                            MARK2: {
                                $order: 1,
                                className: "{_optclass}"
                            }
                        },
                        CAPTION: {
                            $order: 1,
                            tagName: "DIV",
                            text: "{caption}",
                            className: "{disabled} {_itemcls}"
                        },
                        CHART: {
                            $order: 2,
                            tagName: "DIV",
                            style: "{_display}",
                            CAST: {
                                $order: 0,
                                text: "{message}"
                            },
                            PROGRESS: {
                                $order: 1,
                                style: "background-position: -{_per}px -200px;",
                                PROGRESSI: {}
                            },
                            DEL: {
                                $order: 2,
                                className: "xui-ui-btn",
                                style: "{_del}",
                                DELI: {
                                    className: "xui-ui-btni",
                                    DELC: {
                                        className: "xui-ui-btnc",
                                        DELA: {
                                            tagName: "button",
                                            text: "{removeText}"
                                        }
                                    }
                                }
                            }
                        },
                        CLEAR: {
                            $order: 3,
                            tagName: "DIV"
                        }
                    },
                    BODY: {
                        $order: 1,
                        tagName: "DIV",
                        text: "{_body}"
                    }
                }
            },
            cmds: {
                CMD: {
                    className: "xui-ui-btn",
                    CMDI: {
                        className: "xui-ui-btni",
                        CMDC: {
                            className: "xui-ui-btnc",
                            CMDA: {
                                tabindex: "{_tabindex}",
                                text: "{caption}"
                            }
                        }
                    }
                }
            }
        };
        t.ITEMS.className = "";
        self.setTemplate(t);
        var inlineEdit = function (profile, node, flag, value, item) {
                var o, useC, prop = profile.properties,
                    callback = function (v) {
                        var b = profile.boxing();
                        switch (flag) {
                        case "1":
                            if (b.beforeOptionChanged(profile, item, v) !== false) {
                                b._setOptCap(item, v)
                            }
                            break;
                        case "2":
                            if (b.beforeOptionAdded(profile, v) !== false) {
                                var id = "[" + v.replace(/[^\w_]*/g, "") + "]";
                                b._insertOpt({
                                    caption: v,
                                    id: id
                                });
                                if (!profile.properties.editable) {
                                    profile.boxing().fireItemClickEvent(id)
                                }
                            }
                            break;
                        default:
                            if (b.beforeTitleChanged(profile, v) !== false) {
                                b.setTitle(v)
                            }
                        }
                    };
                if (profile.onCustomEdit) {
                    if (o = profile._bind = profile.boxing().onCustomEdit(profile, node, flag, value, item, callback)) {
                        useC = true
                    }
                }
                if (!useC) {
                    o = profile._bind;
                    if (!o) {
                        var pp = {
                            type: prop.editorType,
                            commandBtn: "save",
                            left: -10000,
                            top: -10000
                        };
                        profile._bind = o = xui.create("ComboInput", pp);
                        o.onHotKeydown(function (p, key) {
                            if (key.key == "enter") {
                                p.boxing().onCommand(p);
                                return false
                            } else {
                                if (key.key == "esc") {
                                    o.hide();
                                    return false
                                }
                            }
                        });
                        profile.getRoot().append(o)
                    }
                    var r = node.cssRegion(true, profile.getRoot());
                    if (r.height > o.getHeight()) {
                        o.setHeight(r.height)
                    } else {
                        r.top -= 3
                    }
                    if (r.top < 0) {
                        r.top = 0
                    }
                    o.setValue(value || "", true).setWidth(r.width + (parseInt(node.css("paddingLeft"), 10) || 0) + (parseInt(node.css("paddingRight"), 10) || 0)).onCommand(function (p) {
                        var pro = p.properties,
                            v = pro.$UIvalue,
                            ov = pro.value;
                        if (v != ov) {
                            callback(v)
                        }
                        _.asyRun(function () {
                            o.hide()
                        })
                    }).reBoxing().setBlurTrigger(o.KEY + ":" + o.$xid, function () {
                        o.hide()
                    }).show(r.left + "px", r.top + "px");
                    _.asyRun(function () {
                        o.activate()
                    })
                }
            };
        t = self.getBehavior();
        var old = t.ITEM.onClick;
        t.ITEM.onClick = function (profile, e, src) {
            var p = profile.properties,
                item = profile.getItemByDom(src),
                editable = item.id == "$custom" || item.editable;
            if (p.disabled) {
                return
            }
            if (p.editable) {
                inlineEdit(profile, profile.getSubNodeByItemId("CAPTION", item.id), editable ? "2" : "1", editable ? "" : item.caption, item)
            } else {
                if (editable) {
                    inlineEdit(profile, profile.getSubNodeByItemId("CAPTION", item.id), "2")
                } else {
                    old.apply(this, arguments)
                }
            }
        };
        t.TITLE = {
            onClick: function (profile, e, src) {
                var p = profile.properties,
                    item = profile.getItemByDom(src);
                if (p.disabled) {
                    return
                }
                if (p.editable) {
                    inlineEdit(profile, profile.getSubNode("TITLE"), "3", p.title)
                }
            }
        };
        t.DEL = {
            onClick: function (profile, e, src) {
                var p = profile.properties,
                    b = profile.boxing(),
                    item = profile.getItemByDom(src);
                if (p.disabled) {
                    return
                }
                if (b.beforeOptionRemoved(profile, item) !== false) {
                    b._removeOpt(item.id)
                }
                return false
            }
        };
        t.CMD = {
            onClick: function (profile, e, src) {
                var p = profile.properties,
                    key = profile.getSubId(src);
                if (p.disabled) {
                    return
                }
                profile.boxing().onClickButton(profile, key, src)
            }
        };
        t.TOGGLE = {
            onClick: function (profile, e, src) {
                var properties = profile.properties,
                    items = properties.items,
                    item = profile.getItemByDom(src),
                    itemId = profile.getSubId(src),
                    node = xui.use(src),
                    body = profile.getSubNode("BODY", itemId),
                    t;
                if (item._show) {
                    node.tagClass("-checked", false);
                    body.css("display", "none")
                } else {
                    node.tagClass("-checked");
                    body.css("display", "block");
                    if (!item._fill) {
                        item._fill = true;
                        var callback = function (o) {
                                profile.boxing().fillContent(item.id, item._body = o)
                            };
                        if (profile.onGetContent) {
                            var r = profile.boxing().onGetContent(profile, item, callback);
                            if (r) {
                                callback(r)
                            }
                        } else {
                            callback(profile.box._buildBody(profile, item))
                        }
                    }
                }
                item._show = !item._show
            }
        };
        self.setBehavior(t)
    },
    Static: {
        _DIRTYKEY: "MARK2",
        _ITEMKEY: "OUTER",
        Appearances: {
            KEY: {
                "font-size": "12px",
                zoom: xui.browser.ie ? 1 : null
            },
            "TITLE, ITEMS, TAIL": {
                position: "relative",
                overflow: "auto",
                "line-height": "14px"
            },
            TAIL: {
                zoom: xui.browser.ie ? 1 : null,
                padding: "5px 0 5px 40px"
            },
            CMD: {
                margin: "3px",
                "white-space": "nowrap",
                "vertical-align": "middle"
            },
            TITLE: {
                "font-weight": "bold",
                padding: "4px"
            },
            ITEMS: {
                "overflow-x": "hidden",
                zoom: xui.browser.ie ? 1 : null
            },
            OUTER: {
                position: "relative",
                zoom: xui.browser.ie ? 1 : null,
                "padding-left": "15px"
            },
            TOGGLE: {
                position: "absolute",
                left: 0,
                top: "4px"
            },
            BODY: {
                display: "none",
                "padding-left": "27px"
            },
            ITEM: {
                display: "block",
                position: "relative",
                zoom: xui.browser.ie ? 1 : null,
                padding: "4px 2px 4px 2px"
            },
            OPTION: {
                position: "absolute",
                left: "2px",
                top: "4px"
            },
            CAPTION: {
                "float": "left",
                zoom: xui.browser.ie ? 1 : null,
                "margin-left": "24px",
                display: xui.browser.ie6 ? "inline" : null
            },
            "EDIT, EDITS": {
                $order: 2,
                "float": "none",
                "background-color": "#EBEADB",
                cursor: "pointer",
                display: xui.browser.ie6 ? "block" : null
            },
            CHART: {
                "float": "right"
            },
            CLEAR: {
                clear: "both",
                "text-align": "right"
            },
            "PROGRESS, PROGRESSI": {
                background: xui.UI.$bg("icons.gif", "no-repeat", true),
                width: "200px",
                height: "14px",
                border: 0,
                "vertical-align": "middle",
                "line-height": 0,
                "font-size": 0
            },
            PROGRESS: {
                $order: 1,
                "margin-left": "2px",
                "background-position": "-180px -200px"
            },
            PROGRESSI: {
                $order: 1,
                "background-position": "-200px -216px"
            },
            DEL: {
                margin: "0 0 0 4px"
            }
        },
        DataModel: {
            $checkbox: 1,
            selectable: true,
            noCtrlKey: null,
            title: {
                action: function (v) {
                    this.getSubNode("TITLE").html(v)
                }
            },
            selMode: {
                ini: "single",
                listbox: ["single", "multi"],
                action: function () {
                    this.boxing().refresh()
                }
            },
            cmds: {
                ini: []
            },
            noTitle: {
                ini: false,
                action: function (v) {
                    this.getSubNode("TITLE").css("display", v ? "none" : "")
                }
            },
            toggle: {
                ini: false,
                action: function (v) {
                    this.getSubNode("TOGGLE", true).css("display", v ? "" : "none")
                }
            },
            removeText: {
                ini: "remove",
                action: function (v) {
                    this.getSubNode("DEL", true).text(v)
                }
            },
            editable: {
                ini: false,
                action: function (v) {
                    var self = this,
                        t, cls;
                    self.getSubNode("DEL", true).css("display", v ? "" : "none");
                    t = self.getSubNode("CAPTION", true).merge(self.getSubNode("TITLE"));
                    cls = self.getClass("EDIT");
                    if (v) {
                        t.addClass(cls)
                    } else {
                        t.removeClass(cls)
                    }
                }
            },
            newOption: {
                ini: "",
                action: function (v) {
                    var self = this,
                        id = "$custom",
                        sid = "_special",
                        t, cs = self._cs;
                    if (!v) {
                        if (cs) {
                            cs.remove()
                        }
                    } else {
                        if (!cs) {
                            t = {
                                id: id,
                                caption: v
                            };
                            t[xui.UI.$tag_subId] = sid;
                            cs = self._buildItems("items", self.box._prepareItems(self, [t]));
                            self.getSubNode("ITEMS").addNext(self._cs = cs)
                        } else {
                            self.getSubNodeByItemId("CAPTION", sid).html(v)
                        }
                    }
                }
            },
            editorType: "none"
        },
        Behaviors: {
            HoverEffected: {
                DEL: "DEL",
                CMD: "CMD",
                ITEM: "MARK2"
            },
            ClickEffected: {
                DEL: "DEL",
                CMD: "CMD",
                ITEM: "MARK2"
            }
        },
        EventHandlers: {
            beforeTitleChanged: function (profile, value) {},
            beforeOptionAdded: function (profile, value) {},
            beforeOptionRemoved: function (profile, item) {},
            beforeOptionChanged: function (profile, item, value) {},
            onCustomEdit: function (profile, node, flag, value, item, callback) {},
            onClickButton: function (profile, key, src) {},
            onGetContent: function (profile, item, callback) {}
        },
        RenderTrigger: function () {
            var self = this,
                t = self.properties.newOption;
            if (t) {
                self.boxing().setNewOption(t, true)
            }
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile),
                p = profile.properties;
            if (p.editable) {
                data._cls = profile.getClass("EDIT")
            }
            data.titleDisplay = p.noTitle ? "display:none" : "";
            var cmds = p.cmds,
                o;
            if (cmds && cmds.length) {
                var sid = xui.UI.$tag_subId,
                    a;
                a = data.cmds = [];
                for (var i = 0, t = cmds, l = t.length; i < l; i++) {
                    if (typeof t[i] == "string") {
                        t[i] = {
                            id: t[i]
                        }
                    }
                    if (!t[i].caption) {
                        t[i].caption = t[i].id
                    }
                    t[i].id = t[i].id.replace(/[^\w]/g, "_");
                    o = xui.UI.adjustData(profile, t[i]);
                    a.push(o);
                    o._tabindex = p.tabindex;
                    o[sid] = o.id
                }
            }
            return data
        },
        _prepareItem: function (profile, item) {
            var p = profile.properties,
                f = profile.CF;
            item._tabindex = p.tabindex;
            if (typeof f.formatCaption == "function") {
                item.caption = f.formatCaption(item.caption)
            }
            item._body = item._body || "Loading...";
            if (item.id != "$custom") {
                item._togdisplay = ((p.toggle && item.toggle !== false) || item.toggle) ? "" : "display:none;";
                item._optclass = p.selMode == "multi" ? "xui-uicmd-check" : "xui-uicmd-radio";
                item._display = "";
                item.percent = parseFloat(item.percent) || 0;
                if (item.percent < 0) {
                    item.percent = 0
                }
                if (item.percent > 1) {
                    item.percent = 1
                }
                item._per = 200 * (1 - item.percent)
            } else {
                item._optclass = "xui-uicmd-add";
                item._togdisplay = item._display = "display:none;";
                item._per = 0;
                item._itemcls = profile.getClass("EDITS")
            }
            item.removeText = p.removeText;
            item._del = "display:none;";
            if ((("editable" in item) && item.editable) || p.editable) {
                item._itemcls = profile.getClass("EDIT");
                item._del = ""
            }
        },
        _buildBody: function (profile, item) {
            return item.text ? "<pre>" + item.text.replace(/</g, "&lt;") + "</pre>" : ""
        },
        _onresize: function () {}
    }
});
Class("xui.UI.Panel", "xui.UI.Div", {
    Instance: {
        activate: function (flag) {
            var profile, cls = this.constructor;
            if (profile = xui.UI._cache["$" + cls.activeWndId]) {
                profile.getSubNode("TBAR").tagClass("-focus", false)
            }
            delete cls.activeWndId;
            if (flag !== false) {
                profile = this.get(0);
                profile.getSubNode("TBAR").tagClass("-focus");
                profile.getSubNode("CAPTION").focus();
                cls.activeWndId = profile.$xid
            }
        },
        resetPanelView: function (destroyChildren) {
            if (!_.isSet(destroyChildren)) {
                destroyChildren = true
            }
            var ins;
            return this.each(function (profile) {
                if (profile.renderId) {
                    delete profile.$ini;
                    ins = profile.boxing();
                    ins.removeChildren(true, destroyChildren);
                    if (profile.properties.toggle) {
                        ins.setToggle(false)
                    }
                }
            })
        }
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            BORDER: {
                tagName: "div",
                TBAR: {
                    tagName: "div",
                    className: "xui-uibar-top",
                    BART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        height: "100%",
                        border: "0",
                        tagName: "table",
                        className: "xui-uibar-t",
                        BARTR: {
                            tagName: "tr",
                            BARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    },
                    BARCMDL: {
                        tagName: "div",
                        className: "xui-uibar-cmdl",
                        TOGGLE: {
                            className: "xui-uicmd-toggle {toggleCls}",
                            style: "{toggleDisplay}",
                            $order: 0
                        },
                        ICON: {
                            $order: 0,
                            className: "xui-ui-icon {imageClass}",
                            style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                        },
                        CAPTION: {
                            tabindex: "{tabindex}",
                            text: "{caption}",
                            $order: 1
                        }
                    },
                    BARCMDR: {
                        tagName: "div",
                        className: "xui-uibar-cmdr",
                        INFO: {
                            className: "xui-uicmd-info",
                            style: "{infoDisplay}",
                            $order: 1
                        },
                        OPT: {
                            className: "xui-uicmd-opt",
                            style: "{optDisplay}",
                            $order: 1
                        },
                        POP: {
                            className: "xui-uicmd-pop",
                            style: "{popDisplay}",
                            $order: 2
                        },
                        REFRESH: {
                            className: "xui-uicmd-refresh",
                            style: "{refreshDisplay}",
                            $order: 3
                        },
                        CLOSE: {
                            className: "xui-uicmd-close ",
                            style: "{closeDisplay}",
                            $order: 4
                        }
                    }
                },
                MAIN: {
                    $order: 2,
                    tagName: "div",
                    className: "xui-uicon-main",
                    MAINI: {
                        tagName: "div",
                        className: "xui-uicon-maini",
                        PANEL: {
                            tagName: "div",
                            className: "{_bordertype}",
                            style: "{panelDisplay};{_overflow};",
                            text: "{html}" + xui.UI.$childTag
                        }
                    }
                },
                BBAR: {
                    $order: 3,
                    tagName: "div",
                    className: "xui-uibar-bottom-s",
                    BBART: {
                        cellpadding: "0",
                        cellspacing: "0",
                        width: "100%",
                        border: "0",
                        tagName: "table",
                        className: "xui-uibar-t",
                        BBARTR: {
                            tagName: "tr",
                            BBARTDL: {
                                tagName: "td",
                                className: "xui-uibar-tdl"
                            },
                            BBARTDM: {
                                $order: 1,
                                width: "100%",
                                tagName: "td",
                                className: "xui-uibar-tdm"
                            },
                            BBARTDR: {
                                $order: 2,
                                tagName: "td",
                                className: "xui-uibar-tdr"
                            }
                        }
                    }
                }
            }
        },
        Appearances: {
            KEY: {
                overflow: "hidden",
                background: "transparent"
            },
            "KEY BORDER": {
                zoom: xui.browser.ie6 ? 1 : null
            },
            PANEL: {
                position: "relative",
                left: 0,
                top: 0,
                overflow: "hidden",
                "line-height": "1",
                zoom: xui.browser.ie6 ? 1 : null
            },
            CAPTION: {
                "font-size": "12px",
                cursor: "pointer",
                display: "inline",
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle"
            }
        },
        Behaviors: {
            DroppableKeys: ["PANEL"],
            PanelKeys: ["PANEL"],
            DraggableKeys: ["TBAR"],
            NoDraggableKeys: ["INFO", "OPT", "CLOSE", "POP", "REFRESH", "TOGGLE", "CAPTION"],
            HoverEffected: {
                INFO: "INFO",
                OPT: "OPT",
                CLOSE: "CLOSE",
                POP: "POP",
                REFRESH: "REFRESH",
                TOGGLE: "TOGGLE"
            },
            ClickEffected: {
                INFO: "INFO",
                OPT: "OPT",
                CLOSE: "CLOSE",
                POP: "POP",
                REFRESH: "REFRESH",
                TOGGLE: "TOGGLE"
            },
            onSize: xui.UI.$onSize,
            INFO: {
                onClick: function (profile, e, src) {
                    profile.boxing().onShowInfo(profile, e, src)
                }
            },
            OPT: {
                onClick: function (profile, e, src) {
                    profile.boxing().onShowOptions(profile, e, src)
                }
            },
            REFRESH: {
                onClick: function (profile, e, src) {
                    profile.boxing().onRefresh(profile)
                }
            },
            TOGGLE: {
                onClick: function (profile, e, src) {
                    profile.box._toggle(profile, !profile.properties.toggle);
                    return false
                }
            },
            CAPTION: {
                onClick: function (profile, e, src) {
                    if (!profile.onClickBar || false === profile.boxing().onClickBar(profile, src)) {
                        return xui.Event.getKey(e).shiftKey
                    }
                }
            },
            CLOSE: {
                onClick: function (profile, e, src) {
                    var properties = profile.properties;
                    if (properties.disabled) {
                        return
                    }
                    var instance = profile.boxing();
                    if (false === instance.beforeClose(profile)) {
                        return
                    }
                    instance.destroy();
                    return false
                }
            },
            POP: {
                onClick: function (profile, e, src) {
                    var properties = profile.properties;
                    if (properties.disabled) {
                        return
                    }
                    var pos = profile.getRoot().offset(),
                        size = profile.getRoot().cssSize(),
                        options = {
                            parent: null,
                            host: null,
                            properties: null,
                            events: null,
                            CS: null,
                            CC: null,
                            CB: null,
                            CF: null
                        };
                    if (profile.beforePop && false == profile.boxing().beforePop(profile, options)) {
                        return false
                    }
                    var pro = _.copy(xui.UI.Dialog.$DataStruct),
                        events = {};
                    _.merge(pro, properties, "with");
                    _.merge(pro, {
                        dock: "none",
                        width: Math.max(size.width, 200),
                        height: Math.max(size.height, 100),
                        left: pos.left,
                        top: pos.top,
                        landBtn: true
                    }, "all");
                    if (options.properties) {
                        _.merge(pro, options.properties, "with")
                    }
                    if (options.events) {
                        _.merge(events, options.events, "all")
                    }
                    if (!events.onRender) {
                        var arr = [];
                        _.arr.each(profile.children, function (o) {
                            arr.push(o[0])
                        });
                        if (arr.length) {
                            events.onRender = function () {
                                dialog.append(xui.UI.pack(arr, false))
                            }
                        }
                    }
                    var dialog = new xui.UI.Dialog(pro, events, options.host || profile.host, options.CS || null, options.CC || null, options.CB || null, options.CF || null);
                    (options.parent || xui("body")).append(dialog);
                    profile.boxing().removeChildren().destroy();
                    return false
                }
            }
        },
        DataModel: {
            selectable: true,
            position: "absolute",
            zIndex: 0,
            dock: "fill",
            caption: {
                ini: undefined,
                action: function (v) {
                    v = (_.isSet(v) ? v : "") + "";
                    this.getSubNode("CAPTION").html(xui.adjustRes(v, true))
                }
            },
            image: {
                format: "image",
                action: function (value) {
                    this.getSubNode("ICON").css("display", value ? "" : "none").css("backgroundImage", "url(" + xui.adjustRes(value || "") + ")")
                }
            },
            imagePos: {
                action: function (value) {
                    this.getSubNode("ICON").css("backgroundPosition", value)
                }
            },
            html: {
                action: function (v) {
                    this.getSubNode("PANEL").html(xui.adjustRes(v, 0, 1))
                }
            },
            toggle: {
                ini: true,
                action: function (v) {
                    this.box._toggle(this, v)
                }
            },
            infoBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("INFO").css("display", v ? "" : "none")
                }
            },
            optBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("OPT").css("display", v ? "" : "none")
                }
            },
            toggleBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("TOGGLE").css("display", v ? "" : "none")
                }
            },
            closeBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("CLOSE").css("display", v ? "" : "none")
                }
            },
            refreshBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("REFRESH").css("display", v ? "" : "none")
                }
            },
            popBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("POP").css("display", v ? "" : "none")
                }
            },
            borderType: {
                ini: "inset",
                listbox: ["none", "flat", "inset", "outset"],
                action: function (v) {
                    var ns = this,
                        p = ns.properties,
                        node = ns.getSubNode("PANEL"),
                        reg = /^xui-uiborder-/,
                        pretag = "xui-uiborder-",
                        root = ns.getRoot();
                    node.removeClass(reg);
                    node.addClass(pretag + v);
                    xui.UI.$tryResize(ns, root.get(0).style.width, root.get(0).style.height, true)
                }
            }
        },
        EventHandlers: {
            onRefresh: function (profile) {},
            beforePop: function (profile, options) {},
            beforeClose: function (profile) {},
            onIniPanelView: function (profile) {},
            beforeFold: function (profile) {},
            beforeExpand: function (profile) {},
            afterFold: function (profile) {},
            afterExpand: function (profile) {},
            onShowInfo: function (profile, e, src) {},
            onShowOptions: function (profile, e, src) {},
            onClickBar: function (profile, src) {}
        },
        LayoutTrigger: function () {
            var self = this,
                t = self.properties,
                b = self.box;
            if (t.toggle) {
                b._toggle(self, t.toggle)
            }
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            var nodisplay = "display:none";
            data.panelDisplay = data.toggle ? "" : nodisplay;
            data.toggleCls = data.toggle ? "xui-uicmd-toggle-checked" : "";
            data.toggleDisplay = data.toggleBtn ? "" : nodisplay;
            data.infoDisplay = data.infoBtn ? "" : nodisplay;
            data.optDisplay = data.optBtn ? "" : nodisplay;
            data.closeDisplay = data.closeBtn ? "" : nodisplay;
            data.popDisplay = data.popBtn ? "" : nodisplay;
            data.refreshDisplay = data.refreshBtn ? "" : nodisplay;
            data._bordertype = "xui-uiborder-" + data.borderType;
            profile._toggle = !! data.toggle;
            return data
        },
        _onresize: function (profile, width, height) {
            var isize = {},
                v1 = profile.getSubNode("TBAR"),
                v2 = profile.getSubNode("PANEL"),
                v4 = profile.getSubNode("BBAR"),
                v5 = profile.getSubNode("MAIN"),
                v6 = profile.getSubNode("MAINI"),
                size = profile.properties.borderType == "none" ? 0 : 2,
                h1, h4, t;
            if (height) {
                if (height == "auto") {
                    isize.height = height
                } else {
                    h1 = v1.height(), h4 = v4.height();
                    if ((t = height - h1 - h4) > 0) {
                        isize.height = t - size
                    }
                }
            }
            if (width) {
                isize.width = width - (parseInt(v6.css("paddingRight"), 10) || 0) - (parseInt(v5.css("paddingLeft"), 10) || 0) - v2._borderW()
            }
            v2.cssSize(isize, true)
        },
        _toggle: function (profile, value) {
            var p = profile.properties,
                ins = profile.boxing();
            if (value && !profile.$ini) {
                if (ins.onIniPanelView) {
                    if (ins.onIniPanelView(profile) !== false) {
                        profile.$ini = true
                    }
                    if (p.iframeAutoLoad || p.ajaxAutoLoad) {
                        xui.UI.Div._applyAutoLoad(profile)
                    }
                }
            }
            if (profile._toggle !== !! value) {
                profile._toggle = p.toggle = !! value;
                if (value) {
                    if (ins.beforeExpand && false === ins.beforeExpand(profile)) {
                        return
                    }
                } else {
                    if (ins.beforeFold && false === ins.beforeFold(profile)) {
                        return
                    }
                }
                profile.getSubNode("PANEL").css("display", value ? "" : "none");
                if (p.toggleBtn) {
                    profile.getSubNode("TOGGLE").tagClass("-checked", !! value)
                }
                var h = profile.getSubNode("BORDER").height();
                profile.getRoot().height(h ? h : p.toggle ? p.height : "auto");
                if (value) {
                    if (ins.afterExpand) {
                        ins.afterExpand(profile)
                    }
                } else {
                    if (ins.afterFold) {
                        ins.afterFold(profile)
                    }
                }
            }
        }
    }
});
Class("xui.UI.PageBar", ["xui.UI", "xui.absValue"], {
    Instance: {
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                if (!profile.renderId) {
                    return
                }
                var t, prop = profile.properties,
                    arr = profile.box._v2a(value),
                    min = arr[0],
                    cur = arr[1],
                    max = arr[2],
                    keys = profile.keys,
                    fun = function (p, k) {
                        return p.getSubNode(k)
                    },
                    first = fun(profile, "FIRST"),
                    prev = fun(profile, "PREV"),
                    prehide = fun(profile, "PREM"),
                    current = fun(profile, "CUR"),
                    next = fun(profile, "NEXT"),
                    nexthide = fun(profile, "NEXTM"),
                    last = fun(profile, "LAST"),
                    change = function (n, i, j, k) {
                        if (i) {
                            n.first(3).attr("href", prop.uriTpl.replace("*", i))
                        }
                        if (_.isSet(j)) {
                            n.first(3).html(prop.textTpl.replace("*", j), false)
                        }
                        if (_.isSet(k)) {
                            n.get(0)._real_page = k
                        }
                    },
                    display = function (n, f) {
                        n.css("display", f ? "" : "none")
                    };
                change(first, min, min);
                change(prehide, "", ".." + _.str.repeat(".", String(cur - 1 - min).length), 1);
                change(prev, cur - 1, prop.prevMark);
                change(current, cur, cur);
                change(next, cur + 1, prop.nextMark);
                change(nexthide, "", ".." + _.str.repeat(".", String(max - cur - 1).length), 1);
                change(last, max, max);
                if ((t = cur - min) <= 0) {
                    display(first, 0);
                    display(prehide, 0);
                    display(prev, 0)
                } else {
                    if (t == 1) {
                        display(first, 1);
                        display(prehide, 0);
                        display(prev, 0)
                    } else {
                        if (t == 2) {
                            display(first, 1);
                            display(prehide, 0);
                            display(prev, 1);
                            change(prev, cur - 1, cur - 1)
                        } else {
                            display(first, 1);
                            display(prehide, 1);
                            display(prev, 1);
                            if (t == 3) {
                                change(prev, cur - 1, cur - 1);
                                change(prehide, cur - 2, cur - 2, 0)
                            }
                        }
                    }
                }
                if ((t = max - cur) <= 0) {
                    display(last, 0);
                    display(nexthide, 0);
                    display(next, 0)
                } else {
                    if (t == 1) {
                        display(last, 1);
                        display(nexthide, 0);
                        display(next, 0)
                    } else {
                        if (t == 2) {
                            display(last, 1);
                            display(nexthide, 0);
                            display(next, 1);
                            change(next, cur + 1, cur + 1)
                        } else {
                            display(last, 1);
                            display(nexthide, 1);
                            display(next, 1);
                            if (t == 3) {
                                change(next, cur + 1, cur + 1);
                                change(nexthide, cur + 2, cur + 2, 0)
                            }
                        }
                    }
                }
            })
        },
        setPage: function (value) {
            return this.each(function (o) {
                var v = o.properties.value,
                    a = v.split(":");
                a[1] = parseInt(value, 10) || a[0];
                o.boxing().setValue(a.join(":"))
            })
        }
    },
    Static: {
        Templates: {
            style: "{_style}",
            className: "{_className}",
            POOL: {
                style: "position:absolute;display:none;",
                POP: {
                    tagName: "div",
                    className: "xui-uibg-base"
                }
            },
            LABEL: {
                text: "{caption}"
            },
            FIRST: {
                $order: 1,
                className: "xui-ui-btn",
                FIRSTI: {
                    className: "xui-ui-btni",
                    FIRSTC: {
                        className: "xui-ui-btnc",
                        FIRSTA: {
                            tagName: "a",
                            href: "#",
                            tabindex: "{tabindex}"
                        }
                    }
                }
            },
            PREM: {
                $order: 2,
                className: "xui-ui-btn",
                PREMI: {
                    className: "xui-ui-btni",
                    PREMC: {
                        className: "xui-ui-btnc",
                        PREMA: {
                            tagName: "a",
                            href: "#",
                            tabindex: "{tabindex}"
                        }
                    }
                }
            },
            PREV: {
                $order: 3,
                className: "xui-ui-btn",
                PREVI: {
                    className: "xui-ui-btni",
                    PREVC: {
                        className: "xui-ui-btnc",
                        PREVA: {
                            tagName: "a",
                            href: "#",
                            tabindex: "{tabindex}",
                            text: "{prevMark}"
                        }
                    }
                }
            },
            CUR: {
                $order: 4,
                className: "xui-ui-btn xui-ui-btn-focus",
                CURI: {
                    className: "xui-ui-btni",
                    CURC: {
                        className: "xui-ui-btnc",
                        CURA: {
                            tagName: "a",
                            href: "#",
                            tabindex: "{tabindex}"
                        }
                    }
                }
            },
            NEXT: {
                $order: 5,
                className: "xui-ui-btn",
                NEXTI: {
                    className: "xui-ui-btni",
                    NEXTC: {
                        className: "xui-ui-btnc",
                        NEXTA: {
                            tagName: "a",
                            href: "#",
                            tabindex: "{tabindex}",
                            text: "{nextMark}"
                        }
                    }
                }
            },
            NEXTM: {
                $order: 6,
                className: "xui-ui-btn",
                NEXTMI: {
                    className: "xui-ui-btni",
                    NEXTMC: {
                        className: "xui-ui-btnc",
                        NEXTMA: {
                            tagName: "a",
                            href: "#",
                            tabindex: "{tabindex}"
                        }
                    }
                }
            },
            LAST: {
                $order: 7,
                className: "xui-ui-btn",
                LASTI: {
                    className: "xui-ui-btni",
                    LASTC: {
                        className: "xui-ui-btnc",
                        LASTA: {
                            tagName: "a",
                            href: "#",
                            tabindex: "{tabindex}"
                        }
                    }
                }
            }
        },
        Appearances: {
            LABEL: {
                "font-size": "12px",
                padding: "3px 6px 0 6px",
                "vertical-align": "top",
                "white-space": "nowrap"
            },
            KEY: {
                display: "inline",
                overflow: "visible"
            },
            "KEY a:focus, POP a:focus": {
                "outline-offset": "",
                "-moz-outline-offset": (xui.browser.gek && xui.browser.ver < 3) ? "" : null
            },
            "KEY .xui-ui-btn, POP .xui-ui-btn": {
                "margin-right": "3px"
            },
            "KEY .xui-ui-btn a, POP .xui-ui-btn a": {
                padding: "0 3px 0 3px"
            },
            "PREV,CUR,NEXT": {
                "font-weight": "bold"
            },
            POP: {
                border: "dotted 1px gray",
                background: "#fff",
                position: "absolute",
                padding: "3px",
                "line-height": "26px"
            }
        },
        Behaviors: {
            HoverEffected: {
                FIRST: "FIRST",
                PREM: "PREM",
                PREV: "PREV",
                NEXT: "NEXT",
                NEXTM: "NEXTM",
                LAST: "LAST",
                POPI: "POPI",
                CUR: "CUR"
            },
            ClickEffected: {
                FIRST: "FIRST",
                PREM: "PREM",
                PREV: "PREV",
                NEXT: "NEXT",
                NEXTM: "NEXTM",
                LAST: "LAST",
                POPI: "POPI",
                CUR: "CUR"
            },
            POP: {
                onClick: function (profile, e, src) {
                    var o = xui(src),
                        r = xui.Event.getSrc(e);
                    o.setBlurTrigger(profile.key + ":" + profile.$xid, null);
                    profile.getSubNode("POOL").append(o);
                    if (r.tagName.toLowerCase() == "a" || ((r = r.firstChild) && (r.tagName.toLowerCase() == "a")) || ((r = r.firstChild) && (r.tagName.toLowerCase() == "a")) || ((r = r.firstChild) && (r.tagName.toLowerCase() == "a"))) {
                        return profile.box._click(profile, r.parentNode.parentNode.parentNode)
                    }
                }
            },
            FIRST: {
                onClick: function (profile, e, src) {
                    return profile.box._click(profile, src)
                }
            },
            PREM: {
                onClick: function (profile, e, src) {
                    if (xui.use(src).get(0)._real_page) {
                        profile.box._show(profile, e, src, 0);
                        return false
                    } else {
                        return profile.box._click(profile, src)
                    }
                }
            },
            PREV: {
                onClick: function (profile, e, src) {
                    return profile.box._click(profile, src)
                }
            },
            CUR: {
                onClick: function (profile, e, src) {
                    return profile.box._click(profile, src)
                }
            },
            NEXT: {
                onClick: function (profile, e, src) {
                    return profile.box._click(profile, src)
                }
            },
            NEXTM: {
                onClick: function (profile, e, src) {
                    if (xui.use(src).get(0)._real_page) {
                        profile.box._show(profile, e, src, 1);
                        return false
                    } else {
                        return profile.box._click(profile, src)
                    }
                }
            },
            LAST: {
                onClick: function (profile, e, src) {
                    return profile.box._click(profile, src)
                }
            }
        },
        DataModel: {
            dataField: null,
            dataBinder: null,
            readonly: null,
            caption: {
                ini: " Page: ",
                action: function (v) {
                    v = (_.isSet(v) ? v : "") + "";
                    this.getSubNode("LABEL").html(xui.adjustRes(v, true))
                }
            },
            value: "1:1:1",
            uriTpl: "#*",
            textTpl: "*",
            prevMark: "&lt;",
            nextMark: "&gt;",
            _moreStep: 100
        },
        EventHandlers: {
            onClick: function (profile, page) {}
        },
        _ensureValue: function (profile, value) {
            var a = value.split(":"),
                b = [],
                fun = function (a) {
                    return parseInt(a, 10) || 1
                };
            b[0] = fun(a[0]);
            b[1] = fun(a[1]);
            b[2] = fun(a[2]);
            b[0] = Math.max(b[0], 1);
            b[0] = Math.min(b[0], b[1]);
            b[2] = Math.max(b[1], b[2]);
            return b.join(":")
        },
        _v2a: function (v) {
            v = typeof v == "string" ? v.split(":") : v;
            v[0] = parseInt(v[0], 10);
            v[1] = parseInt(v[1], 10);
            v[2] = parseInt(v[2], 10);
            return v
        },
        _click: function (profile, src) {
            if (profile.properties.disabled) {
                return false
            }
            var b = profile.boxing(),
                v = b.getValue(),
                a = v.split(":");
            var r = b.onClick(profile, parseInt(xui(src).first(3).attr("href").split("#")[1], 10) || a[0]);
            return typeof r == "boolean" ? r : false
        },
        _show: function (profile, e, src, flag) {
            if (profile.properties.disabled) {
                return false
            }
            var prop = profile.properties,
                arr = profile.box._v2a(prop.value),
                min = arr[0],
                cur = arr[1],
                max = arr[2],
                keys = profile.keys,
                fun = function (p, k) {
                    return p.getSubNode(k)
                },
                pool = fun(profile, "POOL"),
                pop = fun(profile, "POP"),
                ceil = function (n) {
                    return Math.ceil((n + 1) / 10) * 10
                },
                a = [],
                t, m, n, i, l;
            if (flag) {
                if ((t = max - 1 - cur) <= 0) {
                    return
                }
                n = cur + 1;
                l = max
            } else {
                if ((t = cur - 1 - min) <= 0) {
                    return
                }
                n = 1;
                l = cur - 1
            }
            m = Math.ceil(t / prop._moreStep);
            if (m > 10) {
                n = ceil(n);
                l = ceil(l) - 1;
                m = ceil(m)
            } else {
                n = n + m
            }
            var _id = profile.keys.POPI + ":" + profile.serialId + ":";
            while (n < l) {
                a.push('<span style="margin-top:3px;" id="' + _id + n + '" class="xui-node xui-node-span xui-ui-btn"><span class="xui-node xui-node-span xui-ui-btni"><span class="xui-node xui-node-span xui-ui-btnc"><a class="xui-node xui-node-a" href="' + prop.uriTpl.replace("*", n) + '">' + prop.textTpl.replace("*", n) + "</a></span></span></span>");
                n = n + m
            }
            pop.width("auto");
            pop.html(a.join(" "));
            xui("body").append(pop);
            if (pop.width() > 300) {
                pop.width(300)
            }
            pop.popToTop(src);
            pop.setBlurTrigger(profile.key + ":" + profile.$xid, function () {
                pool.append(pop)
            })
        }
    },
    Initialize: function () {
        this.addTemplateKeys(["POPI"])
    }
});
Class("xui.UI.Tabs", ["xui.UI", "xui.absList", "xui.absValue"], {
    Instance: {
        _setCtrlValue: function (value) {
            this.each(function (profile) {
                var id = profile.domId,
                    box = profile.boxing(),
                    uiv = box.getUIValue(),
                    prop = profile.properties,
                    dm = profile.box.$DataModel,
                    fold = function (itemId, arr) {
                        var subId = profile.getSubIdByItemId(itemId),
                            item = profile.getItemByItemId(itemId);
                        if (subId) {
                            arr.push(subId);
                            if (!dm.hasOwnProperty("noPanel") || !prop.noPanel) {
                                var pn = box.getPanel(itemId).get(0);
                                if (pn && (item._scrollTop = pn.scrollTop || 0)) {
                                    pn.scrollTop = 0
                                }
                                box.getPanel(itemId).css("display", "none")
                            }
                        }
                    },
                    expand = function (itemId, arr) {
                        var subId = profile.getSubIdByItemId(itemId),
                            item = profile.getItemByItemId(itemId);
                        if (subId) {
                            arr.push(subId);
                            if (!dm.hasOwnProperty("noPanel") || !prop.noPanel) {
                                box.getPanel(itemId).css("display", "block");
                                if (item._scrollTop) {
                                    box.getPanel(itemId).get(0).scrollTop = item._scrollTop
                                }
                                var t = profile.getRootNode().style;
                                xui.UI.$tryResize(profile, t.width, t.height, true, value);
                                t = null;
                                profile.box._forLazyAppend(profile, item, value);
                                profile.box._forIniPanelView(profile, item, value)
                            }
                        }
                    };
                var arr1 = [],
                    arr2 = [];
                if (dm.hasOwnProperty("selMode") && dm.hasOwnProperty("noPanel") && prop.noPanel && prop.selMode == "multi") {
                    uiv = uiv ? uiv.split(prop.valueSeparator) : [];
                    _.arr.each(uiv, function (key) {
                        fold(key, arr1)
                    });
                    value = value ? value.split(prop.valueSeparator) : [];
                    var lastV = "";
                    _.arr.each(value, function (key) {
                        var l = arr2.length;
                        expand(key, arr2);
                        if (l < arr2.length) {
                            lastV = key
                        }
                    });
                    if (lastV) {
                        _.tryF(profile.box._adjustScroll, [profile, lastV], profile.box)
                    }
                } else {
                    fold(uiv, arr1);
                    expand(value, arr2);
                    if (arr2.length) {
                        _.tryF(profile.box._adjustScroll, [profile, value], profile.box)
                    }
                }
                if (arr1.length) {
                    profile.getSubNodes("ITEM", arr1).tagClass("-checked", false)
                }
                if (arr2.length) {
                    profile.getSubNodes("ITEM", arr2).tagClass("-checked")
                }
            })
        },
        append: function (target, subId) {
            var p = this.get(0).properties;
            if (subId = subId || p.$UIvalue || p.value) {
                arguments.callee.upper.call(this, target, subId)
            }
            return this
        },
        getCurPanel: function () {
            var profile = this.get(0),
                dm = profile.box.$DataModel,
                v = profile.properties.$UIvalue;
            if (dm.hasOwnProperty("noPanel") && dm.hasOwnProperty("selMode") && profile.properties.selMode == "multi") {
                v = v.split(prop.valueSeparator);
                v = v[0] || null
            }
            return v ? this.getPanel(v) : null
        },
        getPanel: function (subId) {
            var profile = this.get(0);
            return profile.getSubNodeByItemId("PANEL", subId)
        },
        addPanel: function (paras, children, item) {
            var i = {},
                id = item && item.id,
                items = this.getItems(),
                id2 = paras.id || paras.tag;
            if (items.length) {
                if (-1 != _.arr.subIndexOf(items, "id", id2)) {
                    return false
                }
                if (!id) {
                    id = items[items.length - 1].id
                }
            }
            _.merge(i, {
                caption: paras.caption,
                image: paras.image,
                closeBtn: paras.closeBtn || false,
                popBtn: paras.popBtn || false,
                optBtn: paras.optBtn || false,
                imagePos: paras.imagePos,
                dragKey: paras.dragKey,
                dropKeys: paras.dropKeys,
                id: paras.id || paras.tag || _.id()
            });
            this.insertItems([i], id);
            var arr = [];
            _.arr.each(children, function (o) {
                arr.push(o[0])
            });
            this.append(xui.UI.pack(arr, false), i.id);
            return this
        },
        removePanel: function (domId) {
            var self = this,
                item = self.getItemByDom(domId);
            return self.removeItems([item.id])
        },
        getPanelPara: function (domId) {
            var profile = this.get(0),
                pp = profile.properties,
                item = profile.getItemByDom(domId),
                paras = _.clone(item);
            if (!paras.dragKey) {
                paras.dragKey = pp.dragKey
            }
            if (!paras.dropKeys) {
                paras.dropKeys = pp.dropKeys
            }
            return paras
        },
        getPanelChildren: function (domId) {
            var profile = this.get(0),
                id = profile.getItemIdByDom(domId),
                arr = [];
            if (id) {
                _.arr.each(profile.children, function (o) {
                    if (o[1] == id) {
                        arr.push(o)
                    }
                })
            }
            return arr
        },
        fireItemClickEvent: function (subId) {
            this.getSubNodeByItemId("ITEM", subId).onMousedown();
            return this
        },
        _afterInsertItems: function (profile, data) {
            if (!profile.renderId) {
                return
            }
            var box = profile.box,
                obj, v, pp = profile.properties;
            if (obj = profile.getSubNode(profile.keys.BOX || profile.keys.KEY)) {
                obj.append(profile._buildItems("panels", data));
                if (!profile.box.$DataModel.hasOwnProperty("noPanel")) {
                    if (!(v = this.getUIValue())) {
                        this.fireItemClickEvent((v = pp.items[0]) && (v = v.id))
                    }
                    var t = profile.getRootNode().style;
                    xui.UI.$tryResize(profile, t.width, t.height, true, v);
                    t = null
                }
            }
        },
        removeItems: function (arr) {
            var self = this,
                obj, serialId;
            if (!_.isArr(arr)) {
                arr = [arr]
            }
            self.each(function (profile) {
                if (!profile.box.$DataModel.hasOwnProperty("noPanel") || !profile.properties.noPanel) {
                    _.arr.each(arr, function (o) {
                        serialId = profile.getSubIdByItemId(o);
                        if (serialId && !(obj = profile.getSubNode("PANEL", serialId)).isEmpty()) {
                            obj.remove()
                        }
                    })
                }
            });
            arguments.callee.upper.apply(self, arguments);
            self.each(function (profile) {
                if (!profile.boxing().getUIValue()) {
                    var i;
                    profile.boxing().fireItemClickEvent((i = profile.properties.items[0]) && i.id)
                }
                if (!profile.box.$DataModel.hasOwnProperty("noPanel") || !profile.properties.noPanel) {
                    var t = profile.getRootNode().style;
                    xui.UI.$tryResize(profile, t.width, t.height, true, profile.boxing().getUIValue());
                    t = null
                }
            });
            return self
        },
        clearItems: function () {
            var self = this;
            self.each(function (profile) {
                if (!profile.box.$DataModel.hasOwnProperty("noPanel") || !profile.properties.noPanel) {
                    profile.getSubNode("PANEL", true).remove()
                }
            });
            self.setValue(null, true);
            arguments.callee.upper.apply(self, arguments);
            return self
        },
        markItemCaption: function (subId, mark, force) {
            var profile = this.get(0);
            subId = profile.getItemByItemId(subId);
            if ((subId._dirty != mark) || force) {
                var id = subId.id,
                    caption = profile.getItemByItemId(id).caption;
                profile.getSubNodeByItemId("CAPTION", id).html(profile.getItemByItemId(id).caption = mark ? ("*" + caption) : caption.replace(/^\*/, "")).css("fontStyle", mark ? "italic" : "normal");
                subId._dirty = mark
            }
            return this
        },
        _scrollToBottom: function () {
            return this.each(function (profile) {
                var o = profile.getSubNode("ITEMS"),
                    border = profile.getSubNode("LIST"),
                    y = o.left(),
                    offset, h = o.width(),
                    b = false,
                    bh = border.width();
                if (bh < h + y) {
                    if (!profile.$scrollStep) {
                        profile.$scrollStep = 1
                    }
                    if (profile.$scrollStep < 5) {
                        profile.$scrollStep = profile.$scrollStep * 1.01
                    }
                    y -= profile.$scrollStep;
                    if (bh > h + y) {
                        y = bh - h;
                        b = true
                    }
                    o.left(y);
                    if (b) {
                        profile.getSubNode("RIGHT").css("display", "none");
                        profile.$scrollTobottom = false;
                        profile.$scrollStep = null
                    } else {
                        profile.getSubNode("LEFT").css("display", "block");
                        if (profile.$scrollTobottom) {
                            _.asyRun(arguments.callee, 0, [profile], this)
                        }
                    }
                }
            })
        },
        _scrollToTop: function () {
            return this.each(function (profile) {
                var o = profile.getSubNode("ITEMS"),
                    y = o.left(),
                    b = false;
                if (y < 0) {
                    if (!profile.$scrollStep) {
                        profile.$scrollStep = 1
                    }
                    if (profile.$scrollStep < 5) {
                        profile.$scrollStep = profile.$scrollStep * 1.01
                    }
                    y += profile.$scrollStep;
                    if (y >= -1) {
                        y = 0;
                        b = true
                    }
                    o.left(y);
                    if (b) {
                        profile.getSubNode("LEFT").css("display", "none");
                        profile.$scrollToTop = false;
                        profile.$scrollStep = null
                    } else {
                        profile.getSubNode("RIGHT").css("display", "block");
                        if (profile.$scrollToTop) {
                            _.asyRun(arguments.callee, 0, [profile], this)
                        }
                    }
                }
            })
        }
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style};",
            className: "{_className}",
            LIST: {
                $order: 0,
                tagName: "div",
                ITEMS: {
                    tagName: "div",
                    text: "{items}",
                    style: "{HAlign}"
                },
                LEFT: {},
                RIGHT: {}
            },
            PNAELS: {
                $order: 1,
                tagName: "text",
                text: "{panels}"
            },
            $submap: {
                items: {
                    ITEM: {
                        className: "{itemClass} {disabled} {readonly}",
                        style: "{itemDisplay} {itemStyle}",
                        ITEMI: {
                            ITEMC: {
                                HANDLE: {
                                    tabindex: "{_tabindex}",
                                    IBWRAP: {
                                        tagName: "div",
                                        style: "white-space:nowrap;",
                                        RULER: {},
                                        ICON: {
                                            $order: 0,
                                            className: "xui-ui-icon {imageClass}",
                                            style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                                        },
                                        CAPTION: {
                                            text: "{caption}",
                                            $order: 1
                                        },
                                        CMDS: {
                                            $order: 2,
                                            OPT: {
                                                $order: 1,
                                                className: "xui-uicmd-opt",
                                                style: "{_opt}"
                                            },
                                            POP: {
                                                className: "xui-uicmd-pop",
                                                style: "{popDisplay}",
                                                $order: 1
                                            },
                                            CLOSE: {
                                                className: "xui-uicmd-close ",
                                                style: "{closeDisplay}",
                                                $order: 2
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                panels: {
                    PANEL: {
                        tagName: "div",
                        className: "xui-uibg-base",
                        style: "{_overflow};",
                        text: "{html}" + xui.UI.$childTag
                    }
                }
            }
        },
        Appearances: {
            KEY: {
                position: "absolute",
                overflow: "hidden"
            },
            LIST: {
                position: "relative",
                overflow: "hidden",
                left: 0,
                width: "100%",
                background: xui.UI.$bg("line.gif", "repeat-x center bottom")
            },
            LEFT: {
                cursor: "pointer",
                display: "none",
                position: "absolute",
                top: 0,
                left: 0,
                height: "16px",
                width: "16px",
                "z-index": "10",
                background: xui.UI.$bg("icons.gif", "no-repeat -152px -244px", true)
            },
            RIGHT: {
                cursor: "pointer",
                display: "none",
                position: "absolute",
                top: 0,
                right: 0,
                height: "16px",
                width: "16px",
                "z-index": "10",
                background: xui.UI.$bg("icons.gif", "no-repeat -170px -244px", true)
            },
            ITEMS: {
                padding: "0 4px 2px 0",
                position: "relative",
                left: 0,
                top: 0,
                "white-space": "nowrap"
            },
            ITEM: {
                $order: 0,
                "font-family": '"Verdana", "Helvetica", "sans-serif"',
                cursor: "pointer",
                "padding-right": "6px",
                "vertical-align": "top",
                background: xui.UI.$bg("button.gif", "no-repeat right -540px", true)
            },
            "ITEM-mouseover": {
                $order: 1,
                "background-position": "right -690px"
            },
            "ITEM-mousedown, ITEM-checked": {
                $order: 2,
                "background-position": "right -840px",
                "border-bottom": "solid 1px #FAD600;"
            },
            ITEMI: {
                $order: 0,
                "padding-left": "6px",
                "vertical-align": "top",
                background: xui.UI.$bg("button.gif", "no-repeat left -640px", true)
            },
            "ITEM-mouseover ITEMI": {
                $order: 1,
                "background-position": "left -790px"
            },
            "ITEM-mousedown ITEMI, ITEM-checked ITEMI": {
                $order: 2,
                "background-position": "left -940px"
            },
            ITEMC: {
                $order: 0,
                padding: "5px 0 3px 0",
                "vertical-align": "top",
                "text-align": "center",
                background: xui.UI.$bg("button.gif", "repeat-x left -590px", true)
            },
            "ITEM-mouseover ITEMC": {
                $order: 1,
                "background-position": "left -740px"
            },
            "ITEM-mousedown ITEMC, ITEM-checked ITEMC": {
                $order: 2,
                "background-position": "left -890px"
            },
            HANDLE: {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                cursor: "pointer",
                "vertical-align": "middle",
                "font-size": "12px"
            },
            RULER: {
                height: "18px",
                width: "1px",
                "vertical-align": "middle"
            },
            PANEL: {
                position: "relative",
                display: "none",
                width: "100%",
                overflow: "auto"
            },
            CAPTION: {
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle",
                margin: "0 4px"
            },
            CMDS: {
                "vertical-align": "middle"
            }
        },
        Behaviors: {
            DroppableKeys: ["PANEL", "KEY", "ITEM"],
            PanelKeys: ["PANEL"],
            DraggableKeys: ["ITEM"],
            HoverEffected: {
                ITEM: "ITEM",
                OPT: "OPT",
                CLOSE: "CLOSE",
                POP: "POP"
            },
            ClickEffected: {
                ITEM: "ITEM",
                OPT: "OPT",
                CLOSE: "CLOSE",
                POP: "POP"
            },
            onSize: xui.UI.$onSize,
            OPT: {
                onMousedown: function () {
                    return false
                },
                onClick: function (profile, e, src) {
                    profile.boxing().onShowOptions(profile, profile.getItemByDom(src), e, src);
                    return false
                }
            },
            CAPTION: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        box = profile.boxing();
                    if (properties.disabled || item.disabled) {
                        return false
                    }
                    if (properties.readonly || item.readonly) {
                        return false
                    }
                    if (box.getUIValue() == item.id) {
                        if (profile.onCaptionActive) {
                            profile.boxing().onCaptionActive(profile, profile.getItemByDom(src), e, src)
                        }
                    }
                }
            },
            ITEM: {
                onClick: function (profile, e, src) {
                    return false
                },
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return false
                    }
                    if (profile.getKey(xui.Event.getSrc(e).parentNode.id) == profile.keys.CMDS) {
                        return false
                    }
                    var prop = profile.properties,
                        dm = profile.box.$DataModel,
                        itemId = profile.getSubId(src),
                        item = profile.getItemByDom(src),
                        box = profile.boxing();
                    if (prop.disabled || item.disabled) {
                        return false
                    }
                    if (prop.readonly || item.readonly) {
                        return false
                    }
                    profile.getSubNode("HANDLE", itemId).focus();
                    if (dm.hasOwnProperty("selMode") && dm.hasOwnProperty("noPanel") && prop.noPanel && prop.selMode == "multi") {
                        var value = box.getUIValue(),
                            arr = value ? value.split(prop.valueSeparator) : [],
                            checktype = 1,
                            rt = false,
                            rt2 = false;
                        if (arr.length) {
                            if (_.arr.indexOf(arr, item.id) != -1) {
                                _.arr.removeValue(arr, item.id);
                                checktype = -1
                            } else {
                                arr.push(item.id)
                            }
                            arr.sort();
                            value = arr.join(prop.valueSeparator);
                            if (box.getUIValue() == value) {
                                rt = false
                            } else {
                                box.setUIValue(value);
                                if (box.get(0) && box.getUIValue() == value) {
                                    rt = box.onItemSelected(profile, item, e, src, checktype) || rt2
                                }
                            }
                            return rt
                        }
                    }
                    if (box.getUIValue() != item.id) {
                        box.setUIValue(item.id);
                        if (box.getUIValue() == item.id) {
                            box.onItemSelected(profile, item, e, src);
                            return false
                        }
                    }
                }
            },
            HANDLE: {
                onClick: function (profile, e, src) {
                    return xui.Event.getKey(e).shiftKey
                },
                onKeydown: function (profile, e, src) {
                    var keys = xui.Event.getKey(e),
                        key = keys.key,
                        shift = keys.shiftKey;
                    if (key == " " || key == "enter") {
                        profile.getSubNode("ITEM", profile.getSubId(src)).onMousedown();
                        return false
                    }
                    var cur = xui(src),
                        target = profile.getSubNode("ITEMS"),
                        first = target.nextFocus(true, true, false),
                        last = target.nextFocus(false, true, false);
                    switch (key) {
                    case "tab":
                        if (shift) {
                            if (cur.get(0) != first.get(0)) {
                                first.focus();
                                return false
                            }
                        } else {
                            if (cur.get(0) != last.get(0)) {
                                last.focus();
                                return false
                            }
                        }
                        break;
                    case "left":
                    case "up":
                        var next = cur.nextFocus(false, true, false);
                        if (cur.get(0) == first.get(0)) {
                            last.focus()
                        } else {
                            cur.nextFocus(false)
                        }
                        return false;
                        break;
                    case "right":
                    case "down":
                        var next = cur.nextFocus(true, false, false);
                        if (cur.get(0) == last.get(0)) {
                            first.focus()
                        } else {
                            cur.nextFocus()
                        }
                        return false;
                        break
                    }
                }
            },
            CLOSE: {
                onMousedown: function () {
                    return false
                },
                onClick: function (profile, e, src) {
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        uiv = properties.$UIvalue,
                        bak;
                    if (properties.disabled || item.disabled) {
                        return
                    }
                    if (properties.readonly || item.readonly) {
                        return false
                    }
                    var instance = profile.boxing();
                    if (false === instance.beforePageClose(profile, item, src)) {
                        return
                    }
                    bak = _.copy(item);
                    if (uiv && uiv == item.id) {
                        var items = properties.items,
                            index = _.arr.subIndexOf(items, "id", item.id),
                            t, nuiv = (t = items[index + 1]) ? t.id : (t = items[index - 1]) ? t.id : (t = items[0]) ? t.id : null;
                        if (nuiv && nuiv != uiv) {
                            profile.boxing().fireItemClickEvent(nuiv)
                        }
                    }
                    instance.removeItems(item.id);
                    instance.afterPageClose(profile, bak);
                    var t = profile.getRootNode().style;
                    xui.UI.$tryResize(profile, t.width, t.height, true);
                    t = null;
                    return false
                }
            },
            POP: {
                onMousedown: function () {
                    return false
                },
                onClick: function (profile, e, src) {
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        options = {
                            parent: null,
                            host: null,
                            properties: null,
                            events: null,
                            CS: null,
                            CC: null,
                            CB: null,
                            CF: null
                        },
                        id = item.id;
                    if (properties.disabled || item.disabled) {
                        return
                    }
                    if (properties.readonly || item.readonly) {
                        return false
                    }
                    if (profile.beforePagePop && false == profile.boxing().beforePagePop(profile, item, options)) {
                        return false
                    }
                    var panel = profile.boxing().getPanel(id),
                        pos = profile.getRoot().offset(),
                        size = profile.getRoot().cssSize(),
                        pro = _.copy(xui.UI.Dialog.$DataStruct),
                        events = {};
                    _.merge(pro, item, "with");
                    _.merge(pro, {
                        dragKey: item.dragkey || properties.dragKey,
                        dock: "none",
                        tag: item.tag || item.id,
                        width: Math.max(size.width, 200),
                        height: Math.max(size.height, 100),
                        left: pos.left,
                        top: pos.top,
                        landBtn: true
                    }, "all");
                    if (options.properties) {
                        _.merge(pro, options.properties, "with")
                    }
                    if (options.events) {
                        _.merge(events, options.events, "all")
                    }
                    if (!events.onRender) {
                        var arr = [];
                        _.arr.each(profile.children, function (o) {
                            if (o[1] == id) {
                                delete o[0]["parent:" + profile.$xid];
                                arr.push(o[0])
                            }
                        });
                        if (arr.length) {
                            events.onRender = function () {
                                dialog.append(xui.UI.pack(arr, false))
                            }
                        }
                    }
                    var dialog = new xui.UI.Dialog(pro, events, options.host || profile.host, options.CS || null, options.CC || null, options.CB || null, options.CF || null);
                    (options.parent || xui("body")).append(dialog);
                    profile.boxing().removeChildren(id).removeItems(id);
                    return false
                }
            },
            ITEMS: {
                onMousedown: function (profile, e, src) {
                    var ep = xui.Event.getPos(e);
                    if (!profile._$scroll_l && !profile._$scroll_r) {
                        return
                    }
                    xui.use(src).startDrag(e, {
                        horizontalOnly: true,
                        dragType: "blank",
                        dragDefer: 2,
                        targetLeft: ep.left,
                        targetTop: ep.top,
                        targetReposition: false,
                        maxLeftOffset: profile._$scroll_l,
                        maxRightOffset: profile._$scroll_r
                    })
                },
                onDrag: function (profile, e, src) {
                    var dd = xui.DragDrop.getProfile();
                    xui.use(src).left(-profile._$scroll_r + dd.offset.x)
                },
                onDragstop: function (profile, e, src) {
                    profile.box._adjustScroll(profile)
                }
            },
            LEFT: {
                onMouseover: function (profile, e, src) {
                    profile.$scrollToTop = true;
                    profile.boxing()._scrollToTop()
                },
                onMouseout: function (profile, e, src) {
                    profile.$scrollToTop = false;
                    profile.$scrollStep = null
                },
                onClick: function (profile, e, src) {
                    profile.$scrollStep *= 2
                }
            },
            RIGHT: {
                onMouseover: function (profile, e, src) {
                    profile.$scrollTobottom = true;
                    profile.boxing()._scrollToBottom()
                },
                onMouseout: function (profile, e, src) {
                    profile.$scrollTobottom = false;
                    profile.$scrollStep = null
                },
                onClick: function (profile, e, src) {
                    profile.$scrollStep *= 2
                }
            }
        },
        DataModel: {
            selectable: true,
            dirtyMark: false,
            dataBinder: null,
            dataField: null,
            lazyAppend: true,
            dock: "fill",
            noPanel: false,
            width: 200,
            height: 200,
            position: "absolute",
            overflow: {
                ini: xui.browser.isTouch ? "auto" : undefined,
                listbox: ["", "visible", "hidden", "scroll", "auto"],
                action: function (v) {
                    this.getSubNode("PANEL", true).css("overflow", v || "")
                }
            },
            HAlign: {
                ini: "left",
                listbox: ["left", "center", "right"],
                action: function (value) {
                    this.getSubNode("ITEMS").css("textAlign", value)
                }
            },
            dropKeysPanel: "",
            value: {
                ini: ""
            },
            selMode: {
                ini: "single",
                listbox: ["single", "multi"]
            }
        },
        EventHandlers: {
            onIniPanelView: function (profile, item) {},
            beforePagePop: function (profile, item, options) {},
            beforePageClose: function (profile, item, src) {},
            afterPageClose: function (profile, item) {},
            onShowOptions: function (profile, item, e, src) {},
            onItemSelected: function (profile, item, e, src, type) {},
            onCaptionActive: function (profile, item, e, src) {}
        },
        RenderTrigger: function () {
            var self = this,
                v, i, ins;
            if (v = self.properties.value) {
                (ins = self.boxing()).setUIValue(v);
                if (i = self.getItemByItemId(v)) {
                    ins.onItemSelected(self, i)
                }
            }
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            data.panels = data.items;
            if (data.HAlign) {
                data.HAlign = "text-align:" + data.HAlign + ";"
            }
            return data
        },
        _prepareItem: function (profile, item) {
            var dpn = "display:none",
                prop = profile.properties;
            item.closeDisplay = item.closeBtn ? "" : dpn;
            item.popDisplay = item.popBtn ? "" : dpn;
            item._opt = item.optBtn ? "" : dpn;
            item.itemDisplay = item.hidden ? dpn : "";
            if (_.isStr(item.overflow)) {
                item._overflow = item.overflow.indexOf(":") != -1 ? (item.overflow) : ("overflow:" + item.overflow)
            } else {
                if (_.isStr(prop.overflow)) {
                    item._overflow = prop.overflow.indexOf(":") != -1 ? (prop.overflow) : ("overflow:" + prop.overflow)
                }
            }
        },
        getDropKeys: function (profile, node) {
            return profile.properties[profile.getKey(xui.use(node).id()) == profile.keys.PANEL ? "dropKeys" : "dropKeysPanel"]
        },
        _forLazyAppend: function (profile, item, value) {
            var prop = profile.properties,
                box = profile.boxing();
            if (prop.lazyAppend) {
                var arr = profile.children,
                    a = [];
                _.arr.each(arr, function (o) {
                    if (o[1] == value && !o[0]["parent:" + profile.$xid]) {
                        a.push(o[0]);
                        o[0]["parent:" + profile.$xid] = 1
                    }
                });
                if (a.length) {
                    box.append(xui.UI.pack(a), value)
                }
                if (profile.$attached) {
                    for (var i = 0, v; v = profile.$attached[i++];) {
                        if (v._render) {
                            v._render(true)
                        }
                    }
                    delete profile.$attached
                }
                arr = profile.exchildren;
                if (arr && arr.length) {
                    a = [];
                    _.filter(arr, function (o) {
                        if (o[1] == value) {
                            a.push(o[0]);
                            return false
                        }
                    });
                    if (a.length) {
                        _.arr.each(a, function (o) {
                            box.append(xui(o), value)
                        })
                    }
                }
                arr = profile.excoms;
                if (arr && arr.length) {
                    a = [];
                    _.filter(arr, function (o) {
                        if (o[1] == value) {
                            a.push(o[0]);
                            return false
                        }
                    });
                    if (a.length) {
                        _.arr.each(a, function (o) {
                            o.show(null, box, value, false)
                        })
                    }
                }
            }
        },
        _forIniPanelView: function (profile, item, value) {
            var prop = profile.properties,
                box = profile.boxing();
            if (!item._$ini) {
                if (box.onIniPanelView(profile, item) !== false) {
                    item._$ini = true
                }
                if (item.iframeAutoLoad) {
                    box.getPanel(item.id).css("overflow", "hidden");
                    if (typeof item.iframeAutoLoad == "string") {
                        item.iframeAutoLoad = {
                            url: item.iframeAutoLoad
                        }
                    }
                    var hash = item.iframeAutoLoad,
                        id = "diframe_" + _(),
                        e = xui.browser.ie && xui.browser.ver < 9,
                        ifr = document.createElement(e ? "<iframe name='" + id + "'>" : "iframe");
                    item.iframeAutoLoad.frameName = ifr.id = ifr.name = id;
                    if (!hash.query) {
                        hash.query = {}
                    }
                    hash.query._rand = _();
                    ifr.src = hash.url;
                    ifr.frameBorder = "0";
                    ifr.marginWidth = "0";
                    ifr.marginHeight = "0";
                    ifr.vspace = "0";
                    ifr.hspace = "0";
                    ifr.allowTransparency = "true";
                    ifr.width = "100%";
                    ifr.height = "100%";
                    box.getPanel(item.id).html("").append(ifr);
                    xui.Dom.submit(hash.url, hash.query, hash.method, id, hash.enctype)
                } else {
                    if (item.ajaxAutoLoad) {
                        if (typeof item.ajaxAutoLoad == "string") {
                            item.ajaxAutoLoad = {
                                url: item.ajaxAutoLoad
                            }
                        }
                        var hash = item.ajaxAutoLoad,
                            options = {
                                rspType: "text"
                            };
                        _.merge(options, hash.options);
                        if (!hash.query) {
                            hash.query = {}
                        }
                        hash.query._rand = _();
                        box.busy(null, null, "PANEL", profile.getSubIdByItemId(item.id));
                        xui.Ajax(hash.url, hash.query, function (rsp) {
                            var n = xui.create("div");
                            n.html(rsp, false, true);
                            box.getPanel(item.id).html("").append(n.children());
                            box.free()
                        }, function (err) {
                            box.getPanel(item.id).html("").append("<div>" + err + "</div>");
                            box.free()
                        }, null, options).start()
                    }
                }
            }
        },
        _showTips: function (profile, node, pos) {
            if (profile.properties.disableTips) {
                return
            }
            if (profile.onShowTips) {
                return profile.boxing().onShowTips(profile, node, pos)
            }
            if (!xui.Tips) {
                return
            }
            if (!node.id) {
                return false
            }
            return arguments.callee.upper.apply(this, arguments)
        },
        _onresize: function (profile, width, height, force, key) {
            var t = profile.properties,
                item = profile.getItemByItemId(key);
            if (!item) {
                key = t.$UIvalue
            }
            item = profile.getItemByItemId(key);
            var o = profile.boxing().getPanel(key),
                l = profile.getSubNode("LIST"),
                listH;
            if (!o || o.isEmpty()) {
                return
            }
            var hc = null,
                wc = null;
            if (force) {
                item._w = item._h = null
            }
            if (height && item._h != height) {
                item._h = height;
                if (height && height != "auto") {
                    listH = l.get(0).offsetHeight || l.offsetHeight();
                    height = height - listH;
                    if (height > 0) {
                        hc = height
                    }
                } else {
                    hc = height
                }
            }
            if (width && item._w != width) {
                l.width(item._w = width);
                this._adjustScroll(profile);
                wc = width
            }
            if (hc || wc) {
                o.height(hc).onSize()
            }
        },
        _adjustScroll: function (profile, itemid) {
            var list = profile.getSubNode("LIST"),
                w = list.offsetWidth(),
                items = profile.getSubNode("ITEMS"),
                l = items.left(),
                left = profile.getSubNode("LEFT"),
                right = profile.getSubNode("RIGHT"),
                wi = 0,
                sl = 0,
                sw = 0;
            items.children().each(function (item) {
                if (itemid && profile.getItemIdByDom(item.id) == itemid) {
                    sl = wi;
                    sw = item.offsetWidth
                }
                wi += item.offsetWidth
            });
            items.width(Math.max(wi, w));
            if (wi <= w) {
                items.left(0);
                profile._$scroll_r = profile._$scroll_l = 0;
                items.css("cursor", "")
            } else {
                if (sw) {
                    if ((sl + l < 0) || (sl + sw - l > w)) {
                        l = -sl
                    }
                }
                if (wi + l < w) {
                    items.left(w - wi);
                    profile._$scroll_r = wi - w;
                    profile._$scroll_l = 0
                } else {
                    items.left(l);
                    profile._$scroll_r = -l;
                    profile._$scroll_l = wi - w + l
                }
                items.css("cursor", "move")
            }
            left.css("display", profile._$scroll_r ? "block" : "none");
            right.css("display", profile._$scroll_l ? "block" : "none")
        }
    }
});
Class("xui.UI.Stacks", "xui.UI.Tabs", {
    Initialize: function () {
        var t = this.getTemplate();
        t.BOX = {
            tagName: "div",
            LIST: t.LIST,
            PNAELS: t.PNAELS
        };
        delete t.LIST;
        delete t.PNAELS;
        delete t.LEFT;
        delete t.TOP;
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            BOX: {
                border: "solid 1px #648CB4",
                position: "absolute",
                left: 0,
                top: 0
            },
            LIST: {
                position: "static"
            },
            ITEMS: {
                position: "static"
            },
            ITEM: {
                $order: 0,
                display: "block",
                position: "absolute",
                cursor: "pointer",
                background: xui.UI.$bg("bar_vertical.gif", "repeat-x left -380px", true),
                width: "100%",
                left: 0
            },
            ITEMC: {
                display: "block"
            },
            ITEMI: {
                display: "block"
            },
            "ITEM-mouseover": {
                $order: 1,
                "background-position": "right -410px"
            },
            "ITEM-mousedown, ITEM-checked": {
                $order: 2,
                "background-position": "right -440px"
            },
            HANDLE: {
                cursor: "pointer",
                display: "block",
                "font-size": "12px",
                height: "100%",
                height: "18px",
                padding: "5px 0 5px 8px",
                "white-space": "nowrap"
            },
            PANEL: {
                position: "absolute",
                display: "none",
                overflow: "auto"
            },
            CMDS: {
                position: "absolute",
                top: "6px",
                right: "8px",
                "text-align": "right",
                "vertical-align": "middle"
            }
        },
        DataModel: {
            $border: 1,
            noPanel: null,
            selMode: null
        },
        _onresize: function (profile, width, height, force, key) {
            var t = profile.properties,
                item = profile.getItemByItemId(key),
                bw = t.$border * 2;
            if (!item) {
                key = t.$UIvalue
            }
            var temp, t1, t2, obj, top, wc = null,
                hc = null,
                bx = profile.getSubNode("BOX"),
                o = profile.boxing().getPanel(key);
            if (!o || o.isEmpty()) {
                return
            }
            if (height) {
                height -= bw;
                t2 = t1 = 0;
                _.arr.each(t.items, function (o) {
                    obj = profile.getSubNodeByItemId("ITEM", o.id);
                    obj.cssRegion({
                        bottom: "auto",
                        top: t1
                    });
                    t1 += obj.height();
                    if (o.id == key) {
                        return false
                    }
                });
                _.arr.each(t.items, function (o) {
                    if (o.id == key) {
                        return false
                    }
                    obj = profile.getSubNodeByItemId("ITEM", o.id);
                    obj.cssRegion({
                        top: "auto",
                        bottom: t2
                    });
                    t2 += obj.height()
                }, null, true);
                temp = height - t1 - t2;
                if (temp > 0) {
                    top = t1;
                    hc = temp
                }
                bx.height(height)
            }
            if (width) {
                width -= bw;
                wc = width;
                bx.width(width)
            }
            o.cssRegion({
                width: wc ? wc : null,
                height: hc ? hc : null,
                top: top,
                left: 0
            }, true);
            if (wc) {
                profile.getSubNode("LIST").width(wc)
            }
        },
        _adjustScroll: null
    }
});
Class("xui.UI.ButtonViews", "xui.UI.Tabs", {
    Initialize: function () {
        var t = this.getTemplate();
        t.LIST.className = "xui-uibg-bar xui-uiborder-outset";
        delete t.LEFT;
        delete t.TOP;
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            LIST: {
                "z-index": "2",
                position: "absolute"
            },
            ITEMS: {
                "z-index": "2",
                position: "absolute",
                left: 0,
                top: 0
            },
            "ITEMS-left, ITEMS-left ITEMC": {
                $order: 1,
                "text-align": "left"
            },
            "ITEMS-center, ITEMS-center ITEMC": {
                $order: 1,
                "text-align": "center"
            },
            "ITEMS-right, ITEMS-right ITEMC": {
                $order: 1,
                "text-align": "right"
            },
            ITEM: {
                $order: 0,
                margin: "2px",
                position: "relative",
                "font-family": '"Verdana", "Helvetica", "sans-serif"',
                cursor: "pointer",
                "padding-right": "4px",
                "vertical-align": "top",
                background: xui.UI.$bg("button.gif", "no-repeat right -270px", true)
            },
            "ITEM-mouseover": {
                $order: 1,
                "background-position": "right -360px"
            },
            "ITEM-mousedown, ITEM-checked": {
                $order: 2,
                "background-position": "right -450px"
            },
            ITEMI: {
                $order: 0,
                "padding-left": "4px",
                "vertical-align": "top",
                background: xui.UI.$bg("button.gif", "no-repeat left -330px", true)
            },
            "ITEM-mouseover ITEMI": {
                $order: 1,
                "background-position": "left -420px"
            },
            "ITEM-mousedown ITEMI, ITEM-checked ITEMI": {
                $order: 2,
                "background-position": "left -510px"
            },
            ITEMC: {
                $order: 0,
                "vertical-align": "top",
                height: "20px",
                padding: "2px 0",
                background: xui.UI.$bg("button.gif", "repeat-x left -300px", true)
            },
            "ITEMS-block ITEM, ITEMS-block ITEMI, ITEMS-block ITEMC": {
                $order: 2,
                display: "block"
            },
            "ITEM-mouseover ITEMC": {
                $order: 1,
                "background-position": "left -390px"
            },
            "ITEM-mousedown ITEMC, ITEM-checked ITEMC": {
                $order: 2,
                "background-position": "left -480px"
            },
            HANDLE: {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                cursor: "pointer",
                "vertical-align": "middle",
                "font-size": "12px",
                margin: "1px"
            }
        },
        DataModel: {
            HAlign: null,
            barLocation: {
                ini: "top",
                listbox: ["top", "bottom", "left", "right"],
                action: function (v) {
                    var self = this,
                        hs = self.getSubNode("LIST"),
                        h = self.getSubNode("ITEMS");
                    switch (v) {
                    case "left":
                        hs.cssRegion({
                            left: 0,
                            top: 0,
                            right: "auto",
                            bottom: 0
                        });
                        break;
                    case "top":
                        hs.cssRegion({
                            left: 0,
                            top: 0,
                            right: 0,
                            bottom: "auto"
                        });
                        break;
                    case "right":
                        hs.cssRegion({
                            left: "auto",
                            top: 0,
                            right: 0,
                            bottom: 0
                        });
                        break;
                    case "bottom":
                        hs.cssRegion({
                            left: 0,
                            top: "auto",
                            right: 0,
                            bottom: 0
                        });
                        break
                    }
                    switch (v) {
                    case "left":
                    case "right":
                        h.tagClass("-block", true);
                        break;
                    case "top":
                    case "bottom":
                        h.tagClass("-block", false);
                        hs.height("auto");
                        break
                    }
                    self.boxing().setBarSize(self.properties.barSize, true)
                }
            },
            barHAlign: {
                ini: "left",
                listbox: ["left", "center", "right"],
                action: function (v) {
                    var hl = this.getSubNode("ITEMS");
                    hl.tagClass("(-left|-right|-center)", false).tagClass("-" + v, true)
                }
            },
            barVAlign: {
                ini: "top",
                listbox: ["top", "bottom"],
                action: function (v) {
                    var hl = this.getSubNode("ITEMS");
                    if (v == "top") {
                        hl.cssRegion({
                            top: 0,
                            bottom: "auto"
                        })
                    } else {
                        hl.cssRegion({
                            bottom: 0,
                            top: "auto"
                        })
                    }
                }
            },
            barSize: {
                ini: 50,
                action: function (v) {
                    var self = this,
                        t = self.properties,
                        noPanel = t.noPanel,
                        hs = self.getSubNode("LIST"),
                        hl = self.getSubNode("ITEMS");
                    if (t.barLocation == "left" || t.barLocation == "right") {
                        if (!noPanel) {
                            hs.merge(hl).width(v)
                        }
                    } else {
                        if (!noPanel) {
                            hs.height(v)
                        }
                    }
                    var t = self.getRootNode().style;
                    xui.UI.$tryResize(self, t.width, t.height, true)
                }
            },
            noPanel: {
                ini: false,
                action: function (v) {
                    this.boxing().setBarSize(this.properties.barSize, true)
                }
            }
        },
        LayoutTrigger: function () {
            var pro = this.properties;
            this.boxing().setBarLocation(pro.barLocation, true).setBarHAlign(pro.barHAlign, true).setBarVAlign(pro.barVAlign, true)
        },
        _onresize: function (profile, width, height, force, key) {
            var t = profile.properties,
                noPanel = t.noPanel,
                item = profile.getItemByItemId(key);
            if (!item) {
                key = t.$UIvalue
            }
            var o = profile.boxing().getPanel(key),
                top, left, hs = profile.getSubNode("LIST"),
                hl = profile.getSubNode("ITEMS"),
                wc = null,
                hc = null,
                itmsH;
            if (t.barLocation == "top" || t.barLocation == "bottom") {
                if (width) {
                    hs.width(width - 2);
                    hl.width(width - 2);
                    if (noPanel) {
                        hs.height(height - 2)
                    }
                    left = 0;
                    wc = width
                }
                hs.height(itmsH = hl.offsetHeight());
                if (height - itmsH > 0) {
                    hc = height - itmsH - 2
                }
                top = t.barLocation == "top" ? 2 - -itmsH : 0
            } else {
                if (height) {
                    if (noPanel) {
                        hs.width(width - 2);
                        hl.width(width - 2)
                    }
                    hs.height(height - 2);
                    top = 0;
                    hc = height
                }
                if (width) {
                    left = t.barLocation == "left" ? 2 - -t.barSize : 0;
                    wc = width - t.barSize - 2
                }
            }
            if (!noPanel) {
                if (o && !o.isEmpty()) {
                    o.cssRegion({
                        width: wc ? wc : null,
                        height: hc ? hc : null,
                        left: left,
                        top: top
                    }, true)
                }
            }
        },
        _adjustScroll: null
    }
});
Class("xui.UI.FoldingTabs", "xui.UI.Tabs", {
    Instance: {
        _setCtrlValue: function (value, init) {
            this.each(function (profile) {
                var id = profile.domId,
                    box = profile.boxing(),
                    uiv = init ? "" : box.getUIValue(),
                    prop = profile.properties,
                    fold = function (itemId, arr) {
                        var subId = profile.getSubIdByItemId(itemId),
                            item = profile.getItemByItemId(itemId);
                        if (subId) {
                            arr.push(subId);
                            var itemnode = profile.getSubNode("BODY", subId);
                            if (itemnode.css("display") != "none") {
                                item._scrollTop = itemnode.get(0).scrollTop || 0;
                                if (item._scrollTop) {
                                    itemnode.get(0).scrollTop = 0
                                }
                                itemnode.css("display", "none")
                            }
                        }
                    },
                    expand = function (itemId, arr) {
                        var subId = profile.getSubIdByItemId(itemId),
                            item = profile.getItemByItemId(itemId);
                        if (subId) {
                            arr.push(subId);
                            var itemnode = profile.getSubNode("BODY", subId);
                            if (itemnode.css("display") == "none") {
                                itemnode.css("display", "block");
                                if (item._scrollTop) {
                                    itemnode.get(0).scrollTop = item._scrollTop
                                }
                                profile.box._forLazyAppend(profile, item, itemId);
                                profile.box._forIniPanelView(profile, item, itemId)
                            }
                        }
                    };
                var arr1 = [],
                    arr2 = [];
                if (prop.selMode == "multi") {
                    uiv = uiv ? uiv.split(prop.valueSeparator) : [];
                    value = value ? value.split(prop.valueSeparator) : [];
                    _.arr.each(uiv, function (key) {
                        if (_.arr.indexOf(value, key) == -1) {
                            fold(key, arr1)
                        }
                    });
                    _.arr.each(value, function (key) {
                        if (_.arr.indexOf(uiv, key) == -1) {
                            expand(key, arr2)
                        }
                    })
                } else {
                    fold(uiv, arr1);
                    expand(value, arr2)
                }
                if (arr1.length) {
                    profile.getSubNodes(["ITEM", "TOGGLE"], arr1).tagClass("-checked", false);
                    profile.getSubNodes("ITEM", arr1).next().tagClass("-prechecked", false)
                }
                if (arr2.length) {
                    profile.getSubNodes(["ITEM", "TOGGLE"], arr2).tagClass("-checked");
                    profile.getSubNodes("ITEM", arr2).next().tagClass("-prechecked")
                }
                var t = profile.getRootNode().style;
                xui.UI.$tryResize(profile, t.width, t.height, true)
            })
        },
        _afterInsertItems: null
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style};",
            BOX: {
                $order: 0,
                tagName: "div",
                className: "xui-uibg-base",
                ITEMS: {
                    tagName: "div",
                    text: "{items}"
                }
            },
            $submap: {
                items: {
                    ITEM: {
                        tagName: "div",
                        className: "{_checked} {_precheked} {itemClass} {disabled} {readonly}",
                        style: "{itemDisplay} {itemStyle}",
                        HANDLE: {
                            tagName: "div",
                            HL: {
                                tagName: "div"
                            },
                            HR: {
                                tagName: "div"
                            },
                            TITLE: {
                                tabindex: "{_tabindex}",
                                TLEFT: {
                                    $order: 0,
                                    tagName: "div",
                                    TOGGLE: {
                                        $order: 0,
                                        className: "xui-uicmd-toggle {_tlgchecked}"
                                    },
                                    ICON: {
                                        $order: 2,
                                        className: "xui-ui-icon {imageClass}",
                                        style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                                    },
                                    CAPTION: {
                                        $order: 3,
                                        text: "{caption}"
                                    }
                                },
                                TRIGHT: {
                                    $order: 1,
                                    tagName: "div",
                                    style: "{_capDisplay}",
                                    MESSAGE: {
                                        $order: 0,
                                        text: "{message}"
                                    },
                                    CMDS: {
                                        $order: 2,
                                        OPT: {
                                            $order: 1,
                                            className: "xui-uicmd-opt",
                                            style: "{_opt}"
                                        },
                                        POP: {
                                            className: "xui-uicmd-pop",
                                            style: "{popDisplay}",
                                            $order: 1
                                        },
                                        CLOSE: {
                                            className: "xui-uicmd-close ",
                                            style: "{closeDisplay}",
                                            $order: 2
                                        }
                                    }
                                }
                            }
                        },
                        BODY: {
                            $order: 1,
                            tagName: "div",
                            BODYI: {
                                tagName: "div",
                                PANEL: {
                                    tagName: "div",
                                    style: "{_itemHeight}",
                                    className: "xui-uibg-base",
                                    text: xui.UI.$childTag
                                }
                            }
                        },
                        TAIL: {
                            $order: 4,
                            tagName: "div",
                            TL: {
                                tagName: "div"
                            },
                            TR: {
                                tagName: "div"
                            }
                        }
                    }
                }
            }
        },
        Appearances: {
            KEY: {},
            BOX: {},
            ITEMS: {
                border: 0,
                position: "relative",
                zoom: xui.browser.ie ? 1 : null,
                "padding-top": "8px"
            },
            ITEM: {
                border: 0,
                zoom: xui.browser.ie ? 1 : null,
                "margin-top": "-9px",
                padding: 0,
                "font-family": '"Verdana", "Helvetica", "sans-serif"',
                position: "relative",
                overflow: "hidden"
            },
            "HANDLE, BODY, BODYI, PANEL, TAIL": {
                position: "relative"
            },
            CMDS: {
                padding: "2px 0 0 4px",
                "vertical-align": "middle",
                position: "relative"
            },
            BODY: {
                display: "none",
                "border-right": "solid 1px #CCC",
                zoom: xui.browser.ie ? 1 : null,
                position: "relative",
                overflow: "auto",
                background: xui.UI.$bg("border_left.gif", "repeat-y left top", "FoldingList")
            },
            BODYI: {
                padding: "0 8px",
                background: xui.UI.$bg("border_left.gif", "repeat-y left top", "FoldingList")
            },
            PANEL: {
                overflow: "auto",
                padding: "2px"
            },
            "ITEM-mouseover": {},
            "ITEM-mousedown, ITEM-checked": {},
            "ITEM-checked": {
                $order: 2,
                "margin-bottom": "12px"
            },
            "ITEM-checked BODY": {
                $order: 2,
                display: "block"
            },
            "HL, HR, TL, TR": {
                position: "absolute",
                "font-size": 0,
                "line-height": 0,
                width: "8px",
                background: xui.UI.$bg("corner.gif", "no-repeat", "FoldingList")
            },
            "HL, HR": {
                height: "30px"
            },
            "ITEM-prechecked HL": {
                $order: 1,
                "background-position": "left top"
            },
            "ITEM-prechecked HR": {
                $order: 1,
                "background-position": "right top"
            },
            "TL, TR": {
                height: "20px"
            },
            HL: {
                $order: 1,
                top: 0,
                left: 0,
                "background-position": "left -37px"
            },
            HR: {
                $order: 1,
                top: 0,
                right: 0,
                "background-position": "right -37px"
            },
            TL: {
                $order: 1,
                bottom: 0,
                left: 0,
                "background-position": "left bottom"
            },
            TR: {
                $order: 1,
                bottom: 0,
                right: 0,
                "background-position": "right bottom"
            },
            HANDLE: {
                position: "relative",
                zoom: xui.browser.ie ? 1 : null,
                background: xui.UI.$bg("border_top.gif", "#fff repeat-x left top", "FoldingList"),
                overflow: "hidden"
            },
            TITLE: {
                $order: 1,
                height: "26px",
                display: "block",
                position: "relative",
                "white-space": "nowrap",
                overflow: "hidden"
            },
            "BODY, BODYI, PANEL": {
                "font-size": 0,
                "line-height": 0
            },
            TAIL: {
                "font-size": 0,
                "line-height": 0,
                height: "5px",
                background: xui.UI.$bg("border_bottom.gif", "repeat-x left bottom #EEE", "FoldingList")
            },
            "CAPTION, MESSAGE": {
                padding: "3px",
                "vertical-align": "middle"
            },
            CAPTION: {
                color: "#666",
                cursor: "pointer",
                "white-space": "nowrap",
                font: "12px arial,sans-serif",
                color: "#00681C"
            },
            "ITEM-checked CAPTION": {
                $order: 2,
                "font-weight": "bold"
            },
            TLEFT: {
                position: "absolute",
                left: "4px",
                top: "2px",
                "white-space": "nowrap",
                overflow: "hidden"
            },
            TRIGHT: {
                position: "absolute",
                right: "4px",
                top: "2px",
                "white-space": "nowrap",
                overflow: "hidden"
            }
        },
        Behaviors: {
            DraggableKeys: ["HANDLE"],
            HoverEffected: {
                OPT: "OPT",
                CLOSE: "CLOSE",
                POP: "POP"
            },
            ClickEffected: {
                OPT: "OPT",
                CLOSE: "CLOSE",
                POP: "POP"
            },
            ITEM: {
                onClick: null,
                onMousedown: null
            },
            ITEMS: {
                onMousedown: null,
                onDrag: null,
                onDragstop: null
            },
            HANDLE: {
                onClick: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return false
                    }
                    var prop = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId = profile.getSubId(src),
                        box = profile.boxing(),
                        rt, rt2;
                    if (prop.disabled || item.disabled) {
                        return false
                    }
                    if (prop.readonly || item.readonly) {
                        return false
                    }
                    profile.getSubNode("TITLE").focus();
                    switch (prop.selMode) {
                    case "multi":
                        var value = box.getUIValue(),
                            arr = value ? value.split(prop.valueSeparator) : [],
                            checktype = 1;
                        if (arr.length) {
                            rt2 = false;
                            if (_.arr.indexOf(arr, item.id) != -1) {
                                _.arr.removeValue(arr, item.id);
                                checktype = -1
                            } else {
                                arr.push(item.id)
                            }
                            arr.sort();
                            value = arr.join(prop.valueSeparator);
                            if (box.getUIValue() == value) {
                                rt = false
                            } else {
                                box.setUIValue(value);
                                if (box.get(0) && box.getUIValue() == value) {
                                    rt = box.onItemSelected(profile, item, e, src, checktype) || rt2
                                }
                            }
                            break
                        }
                    case "single":
                        if (box.getUIValue() == item.id) {
                            rt = false
                        } else {
                            box.setUIValue(item.id);
                            if (box.get(0) && box.getUIValue() == item.id) {
                                rt = box.onItemSelected(profile, item, e, src, 1)
                            }
                        }
                        break
                    }
                    return rt
                },
                onKeydown: function (profile, e, src) {
                    var keys = xui.Event.getKey(e),
                        key = keys.key,
                        shift = keys.shiftKey;
                    if (key == " " || key == "enter") {
                        profile.getSubNode("HANDLE", profile.getSubId(src)).onClick();
                        return false
                    }
                }
            }
        },
        DataModel: {
            $border: 0,
            noPanel: null,
            HAlign: null,
            selMode: {
                ini: "single",
                listbox: ["single", "multi"]
            }
        },
        _prepareItems: function (profile, arr, pid) {
            if (arr.length) {
                arr[0]._precheked = profile.getClass("ITEM", "-prechecked")
            }
            return arguments.callee.upper.apply(this, arguments)
        },
        _prepareItem: function (profile, item) {
            var dpn = "display:none";
            item.closeDisplay = item.closeBtn ? "" : dpn;
            item.popDisplay = item.popBtn ? "" : dpn;
            item._opt = item.optBtn ? "" : dpn;
            item.itemDisplay = item.hidden ? dpn : "";
            if (item.height && item.height != "auto") {
                item._itemHeight = "height:" + item.height + "px;"
            }
            var prop = profile.properties,
                o;
            item._tabindex = prop.tabindex;
            if (!item.caption) {
                item._capDisplay = dpn
            } else {
                item.caption = item.caption.replace(/</g, "&lt;")
            }
            if (item._show) {
                item._checked = profile.getClass("ITEM", "-checked");
                item._tlgchecked = profile.getClass("TOGGLE", "-checked")
            }
        },
        _onresize: function (profile, width, height, force, key) {
            if (force) {
                profile._w = profile._h = null
            }
            if (width && profile._w != width) {
                profile._w = width;
                profile.getSubNode("PANEL", true).each(function (panel) {
                    if (panel.offsetWidth) {
                        xui(panel).width("auto").width(xui(panel).width())
                    }
                })
            }
        },
        _adjustScroll: null
    }
});
Class("xui.UI.RadioBox", "xui.UI.List", {
    Initialize: function () {
        var t = this.getTemplate();
        t.className = "{_className}";
        t.$submap = {
            items: {
                ITEM: {
                    className: "{itemClass}  {disabled} {readonly}",
                    style: "{itemStyle}",
                    tabindex: "{_tabindex}",
                    MARK: {
                        $order: 0,
                        className: "{_markcls}"
                    },
                    ICON: {
                        $order: 1,
                        className: "xui-ui-icon {imageClass}",
                        style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                    },
                    CAPTION: {
                        text: "{caption}",
                        $order: 2
                    }
                }
            }
        };
        this.setTemplate(t)
    },
    Static: {
        _DIRTYKEY: "MARK",
        _ITEMMARKED: true,
        Appearances: {
            ITEM: {
                display: xui.$inlineBlock,
                "font-family": ' "Verdana", "Helvetica", "sans-serif"',
                border: 0,
                padding: "4px",
                position: "relative",
                zoom: xui.browser.ie ? 1 : null,
                cursor: "pointer",
                overflow: "hidden",
                "vertical-align": "middle",
                "font-size": "12px"
            },
            CAPTION: {
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle"
            },
            ITEMS: {
                overflow: "auto",
                "overflow-x": "hidden",
                position: "relative",
                "line-height": "14px"
            },
            MARK: {
                $order: 1,
                cursor: "pointer",
                width: "16px",
                height: "16px",
                "vertical-align": "middle"
            },
            "ITEM-checked MARK": {
                $order: 2
            }
        },
        DataModel: {
            borderType: {
                ini: "none"
            },
            checkBox: {
                ini: false,
                action: function (v) {
                    this.getSubNode("MARK", true).replaceClass(v ? /(uicmd-radio)|(\s+uicmd-radio)/g : /(^uicmd-check)|(\s+uicmd-check)/g, v ? " xui-uicmd-check" : " xui-uicmd-radio")
                }
            }
        },
        Behaviors: {
            HoverEffected: {
                ITEM: null,
                MARK: "MARK"
            },
            ClickEffected: {
                ITEM: null,
                MARK: "MARK"
            }
        },
        _prepareItem: function (profile, item) {
            item._markcls = profile.properties.checkBox ? "xui-uicmd-check" : "xui-uicmd-radio"
        }
    }
});
Class("xui.UI.StatusButtons", ["xui.UI.List"], {
    Initialize: function () {
        var t = this.getTemplate();
        t.className = "{_className}";
        t.$submap = {
            items: {
                ITEM: {
                    className: "{itemClass} {_endsClass} {disabled} {readonly}",
                    style: "{itemMargin};{itemWidth};{itemAlign};{itemStyle}",
                    tabindex: "{_tabindex}",
                    ICON: {
                        $order: 10,
                        className: "xui-ui-icon {imageClass}",
                        style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                    },
                    CAPTION: {
                        $order: 11,
                        text: "{caption}"
                    }
                }
            }
        };
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            ITEMS: {
                position: "relative",
                overflow: "auto",
                "overflow-x": "hidden"
            },
            ITEM: {
                "vertical-align": "middle",
                position: "relative",
                height: "16px",
                padding: "3px",
                cursor: "pointer",
                "font-size": 0,
                "line-height": 0,
                "white-space": "nowrap"
            },
            "ITEM-none": {
                background: xui.UI.$bg("icons.gif", "no-repeat -12px -130px", true),
                "border-left": "solid 1px #7C9CBC",
                "border-right": "solid 1px #7C9CBC"
            },
            "ITEM-left": {
                background: xui.UI.$bg("icons.gif", "no-repeat left -130px", true),
                "border-right": "solid 1px #7C9CBC"
            },
            "ITEM-right": {
                background: xui.UI.$bg("icons.gif", "no-repeat right -130px", true),
                "border-left": "solid 1px #7C9CBC"
            },
            "ITEM-mouseover, ITEM-mousedown, ITEM-checked": {},
            "ITEM-mouseover": {},
            "ITEM-mousedown": {},
            "ITEM-checked": {},
            "ITEM-left-mouseover": {
                $order: 1,
                "background-position": "left -153px"
            },
            "ITEM-left-mousedown": {
                $order: 2,
                "background-position": "left -176px"
            },
            "ITEM-left-checked": {
                $order: 3,
                "background-position": "left -176px"
            },
            "ITEM-none-mouseover": {
                $order: 1,
                "background-position": "-20px -153px"
            },
            "ITEM-none-mousedown": {
                $order: 2,
                "background-position": "-20px -176px"
            },
            "ITEM-none-checked": {
                $order: 3,
                "background-position": "-20px -176px"
            },
            "ITEM-right-mouseover": {
                $order: 1,
                "background-position": "right -153px"
            },
            "ITEM-right-mousedown": {
                $order: 2,
                "background-position": "right -176px"
            },
            "ITEM-right-checked": {
                $order: 3,
                "background-position": "right -176px"
            },
            CAPTION: {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                "vertical-align": "middle",
                "font-size": "12px",
                "line-height": "14px"
            },
            "ITEM-none CAPTION": {
                padding: "1px 4px"
            },
            "ITEM-left CAPTION": {
                padding: "1px 4px 1px 12px"
            },
            "ITEM-right CAPTION": {
                padding: "1px 12px 1px 1px"
            }
        },
        DataModel: ({
            maxHeight: null,
            itemMargin: {
                ini: "",
                action: function (value) {
                    this.getSubNode("ITEM", true).css("margin", value)
                }
            },
            itemWidth: {
                ini: 0,
                action: function (value) {
                    this.getSubNode("ITEM", true).width(value)
                }
            },
            itemAlign: {
                ini: "",
                listbox: ["", "left", "center", "right"],
                action: function (value) {
                    this.getSubNode("ITEM", true).css("text-align", value)
                }
            },
            itemLinker: {
                ini: "left",
                listbox: ["none", "left", "right"],
                action: function (value) {
                    this.getSubNode("ITEM", true).tagClass("-none", false).tagClass("-left", false).tagClass("-right", false).tagClass("-" + value, true)
                }
            }
        }),
        Behaviors: {
            DroppableKeys: ["ITEMS"]
        },
        EventHandlers: {},
        _prepareItem: function (profile, item) {
            var p = profile.properties,
                t;
            item._tabindex = p.tabindex;
            if (t = item.itemMargin || p.itemMargin) {
                item.itemMargin = "margin:" + t
            }
            if (t = item.itemWidth || p.itemWidth) {
                item.itemWidth = "width:" + (t == "auto" ? t : (t + "px"))
            }
            if (t = item.itemAlign || p.itemAlign) {
                item.itemAlign = "text-align:" + t
            }
            if (t = item.itemLinker || p.itemLinker) {
                item._endsClass = profile.getClass("ITEM", "-" + t)
            }
        }
    }
});
Class("xui.UI.FoldingList", ["xui.UI.List"], {
    Instance: {
        fillContent: function (id, obj) {
            var profile = this.get(0),
                t, item;
            if (profile.renderId) {
                if (item = profile.getItemByItemId(id)) {
                    t = profile.getSubNodeByItemId("BODYI", id).html("");
                    if (obj) {
                        item._obj = obj;
                        item._fill = true;
                        if (typeof obj == "string") {
                            t.html(obj)
                        } else {
                            t.append(obj.render(true))
                        }
                    } else {
                        item._obj = item._fill = null
                    }
                }
            }
            return this
        },
        toggle: function (id) {
            var profile = this.get(0);
            if (profile.renderId) {
                var properties = profile.properties,
                    items = properties.items,
                    item = profile.getItemByItemId(id),
                    subId = profile.getSubIdByItemId(id),
                    node = profile.getSubNode("ITEM", subId),
                    toggle = profile.getSubNode("TOGGLE", subId),
                    nodenext = node.next(),
                    t;
                if (item._show) {
                    if (properties.activeLast && items.length) {
                        if (items[items.length - 1].id == item.id) {
                            return false
                        }
                    }
                    node.tagClass("-checked", false);
                    toggle.tagClass("-checked", false);
                    if (nodenext) {
                        nodenext.tagClass("-prechecked", false)
                    }
                } else {
                    node.tagClass("-checked");
                    toggle.tagClass("-checked");
                    if (nodenext) {
                        nodenext.tagClass("-prechecked")
                    }
                    if (!item._fill) {
                        var callback = function (o) {
                                profile.boxing().fillContent(item.id, item._body = o)
                            };
                        if (profile.onGetContent) {
                            var r = profile.boxing().onGetContent(profile, item, callback);
                            if (r) {
                                callback(r)
                            }
                        } else {
                            callback(profile.box._buildBody(profile, item))
                        }
                    }
                }
                item._show = !item._show
            }
            return this
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        t.$submap = {
            items: {
                ITEM: {
                    tagName: "div",
                    className: "{_checked} {_precheked} {itemClass} {disabled} {readonly}",
                    style: "{itemStyle}",
                    HEAD: {
                        tagName: "div",
                        HL: {
                            tagName: "div"
                        },
                        HR: {
                            tagName: "div"
                        },
                        TITLE: {
                            tabindex: "{_tabindex}",
                            TLEFT: {
                                $order: 0,
                                tagName: "div",
                                TOGGLE: {
                                    $order: 0,
                                    className: "xui-uicmd-toggle {_tlgchecked}"
                                },
                                CAP1: {
                                    $order: 1,
                                    text: "{title}"
                                }
                            },
                            TRIGHT: {
                                $order: 1,
                                tagName: "div",
                                style: "{_capDisplay}",
                                CAP2: {
                                    $order: 0,
                                    text: "{caption}"
                                },
                                OPT: {
                                    $order: 1,
                                    className: "xui-uicmd-opt",
                                    style: "{_opt}"
                                }
                            }
                        }
                    },
                    BODY: {
                        $order: 1,
                        tagName: "div",
                        className: "xui-uibg-base",
                        BODYI: {
                            $order: 0,
                            tagName: "div",
                            text: "{_body}"
                        },
                        CMDS: {
                            $order: 1,
                            tagName: "div",
                            text: "{cmds}"
                        }
                    },
                    TAIL: {
                        $order: 4,
                        tagName: "div",
                        TL: {
                            tagName: "div"
                        },
                        TR: {
                            tagName: "div"
                        }
                    }
                }
            },
            "items.cmds": {
                $order: 2,
                CMD: {
                    className: "xui-ui-btn",
                    CMDI: {
                        className: "xui-ui-btni",
                        CMDC: {
                            className: "xui-ui-btnc",
                            CMDA: {
                                tabindex: "{_tabindex}",
                                text: "{caption}"
                            }
                        }
                    }
                }
            }
        };
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            KEY: {
                padding: "2px"
            },
            ITEMS: {
                border: 0,
                position: "relative",
                zoom: xui.browser.ie ? 1 : null,
                "padding-top": "8px"
            },
            ITEM: {
                border: 0,
                zoom: xui.browser.ie ? 1 : null,
                "margin-top": "-9px",
                padding: 0,
                "font-family": '"Verdana", "Helvetica", "sans-serif"',
                position: "relative",
                overflow: "hidden"
            },
            "HEAD, BODY, BODYI, TAIL": {
                position: "relative"
            },
            CMDS: {
                "font-size": 0,
                "line-height": 0,
                padding: "2px 0 0 4px",
                "text-align": "right",
                position: "relative",
                background: xui.UI.$bg("border_left.gif", "repeat-y left top #EEE"),
                zoom: xui.browser.ie ? 1 : null
            },
            CMD: {
                margin: "2px 4px 2px 4px"
            },
            BODY: {
                display: "none",
                "border-right": "solid 1px #CCC",
                zoom: xui.browser.ie ? 1 : null,
                position: "relative",
                overflow: "auto",
                background: xui.UI.$bg("border_left.gif", "repeat-y left top")
            },
            BODYI: {
                padding: "2px 8px 0 8px",
                background: xui.UI.$bg("border_left.gif", "repeat-y left top"),
                position: "relative"
            },
            "BODY, BODYI": {
                "font-size": 0,
                "line-height": 0
            },
            "ITEM-checked": {
                $order: 2,
                "margin-bottom": "12px"
            },
            "ITEM-checked BODY": {
                $order: 2,
                display: "block"
            },
            "HL, HR, TL, TR": {
                position: "absolute",
                "font-size": 0,
                "line-height": 0,
                width: "8px",
                background: xui.UI.$bg("corner.gif", "no-repeat")
            },
            "HL, HR": {
                height: "30px"
            },
            "ITEM-prechecked HL": {
                $order: 1,
                "background-position": "left top"
            },
            "ITEM-prechecked HR": {
                $order: 1,
                "background-position": "right top"
            },
            "TL, TR": {
                height: "20px"
            },
            HL: {
                $order: 1,
                top: 0,
                left: 0,
                "background-position": "left -37px"
            },
            HR: {
                $order: 1,
                top: 0,
                right: 0,
                "background-position": "right -37px"
            },
            TL: {
                $order: 1,
                bottom: 0,
                left: 0,
                "background-position": "left bottom"
            },
            TR: {
                $order: 1,
                bottom: 0,
                right: 0,
                "background-position": "right bottom"
            },
            HEAD: {
                position: "relative",
                zoom: xui.browser.ie ? 1 : null,
                background: xui.UI.$bg("border_top.gif", "#fff repeat-x left top"),
                overflow: "hidden"
            },
            TITLE: {
                $order: 1,
                height: "26px",
                display: "block",
                position: "relative",
                "white-space": "nowrap",
                overflow: "hidden"
            },
            TAIL: {
                "font-size": 0,
                "line-height": 0,
                position: "relative",
                height: "5px",
                background: xui.UI.$bg("border_bottom.gif", "repeat-x left bottom #EEE")
            },
            "CAP1, CAP2": {
                padding: "3px",
                "vertical-align": "middle"
            },
            CAP1: {
                color: "#666",
                cursor: "pointer",
                "white-space": "nowrap",
                font: "bold 12px arial,sans-serif",
                color: "#00681C"
            },
            "ITEM-checked CAP1": {
                $order: 2,
                "font-weight": "normal"
            },
            TLEFT: {
                position: "absolute",
                left: "4px",
                top: "2px",
                "white-space": "nowrap",
                overflow: "hidden"
            },
            TRIGHT: {
                position: "absolute",
                right: "4px",
                top: "2px",
                "white-space": "nowrap",
                overflow: "hidden"
            }
        },
        Behaviors: {
            HoverEffected: {
                ITEM: null,
                HEAD: "HEAD",
                OPT: "OPT",
                CMD: "CMD"
            },
            ClickEffected: {
                ITEM: null,
                HEAD: "HEAD",
                CMD: "CMD"
            },
            ITEM: {
                onClick: null,
                onKeydown: null
            },
            HEAD: {
                onClick: function (profile, e, src) {
                    profile.boxing().toggle(profile.getItemIdByDom(src));
                    return false
                }
            },
            CMD: {
                onClick: function (profile, e, src) {
                    if (profile.onClickButton) {
                        profile.boxing().onClickButton(profile, profile.getItemByDom(xui.use(src).parent().get(0)), xui.use(src).id().split("_")[1], src)
                    }
                    return false
                }
            },
            OPT: {
                onMousedown: function () {
                    return false
                },
                onClick: function (profile, e, src) {
                    profile.boxing().onShowOptions(profile, profile.getItemByDom(src), e, src);
                    return false
                }
            }
        },
        DataModel: ({
            value: null,
            borderType: null,
            cmds: {
                ini: []
            },
            activeLast: false
        }),
        EventHandlers: {
            onGetContent: function (profile, item, onEnd) {},
            onClickButton: function (profile, item, cmdkey, src) {},
            onShowOptions: function (profile, item, e, src) {}
        },
        RenderTrigger: function () {
            var self = this,
                pro = self.properties,
                items = pro.items,
                item;
            if (pro.activeLast && items.length > 0) {
                item = items[items.length - 1];
                self.boxing().fillContent(item.id, item._body)
            }
        },
        _prepareItems: function (profile, arr, pid) {
            if (arr.length) {
                arr[0]._precheked = profile.getClass("ITEM", "-prechecked");
                if (profile.properties.activeLast) {
                    var item = arr[arr.length - 1];
                    item._show = true;
                    item._fill = true;
                    item._body = profile.onGetContent ? profile.boxing().onGetContent(profile, item) : profile.box._buildBody(profile, item)
                }
            }
            return arguments.callee.upper.apply(this, arguments)
        },
        _prepareItem: function (profile, item) {
            var p = profile.properties,
                o, dpn = "display:none";
            item._tabindex = p.tabindex;
            if (!item.caption) {
                item._capDisplay = dpn
            } else {
                item.caption = item.caption.replace(/</g, "&lt;")
            }
            item._opt = item.optBtn ? "" : dpn;
            item._body = item._body || "Loading...";
            if (item._show) {
                item._checked = profile.getClass("ITEM", "-checked");
                item._tlgchecked = profile.getClass("TOGGLE", "-checked")
            }
            var cmds = item.cmds || p.cmds;
            if (cmds && cmds.length) {
                var sid = xui.UI.$tag_subId,
                    a;
                a = item.cmds = [];
                for (var i = 0, t = cmds, l = t.length; i < l; i++) {
                    if (typeof t[i] == "string") {
                        t[i] = {
                            id: t[i]
                        }
                    }
                    if (!t[i].caption) {
                        t[i].caption = t[i].id
                    }
                    t[i].id = t[i].id.replace(/[^\w]/g, "_");
                    o = xui.UI.adjustData(profile, t[i]);
                    a.push(o);
                    o[sid] = item[sid] + "_" + o.id
                }
            }
        },
        _buildBody: function (profile, item) {
            return item.text ? "<pre>" + item.text.replace(/</g, "&lt;") + "</pre>" : ""
        },
        _onresize: function () {}
    }
});
Class("xui.UI.TreeBar", ["xui.UI", "xui.absList", "xui.absValue"], {
    Instance: {
        _setCtrlValue: function (value, flag) {
            return this.each(function (profile) {
                if (!profile.renderId) {
                    return
                }
                var box = profile.boxing(),
                    uiv = box.getUIValue(),
                    properties = profile.properties,
                    fun = function (key, o, b) {
                        profile.getSubNodeByItemId(key, o).tagClass("-checked", b)
                    },
                    selmode = properties.selMode;
                if (selmode == "single") {
                    var itemId = profile.getSubIdByItemId(uiv);
                    if (uiv && itemId) {
                        profile.getSubNode("BAR", itemId).tagClass("-checked", false)
                    }
                    itemId = profile.getSubIdByItemId(value);
                    if (itemId) {
                        profile.getSubNode("BAR", itemId).tagClass("-checked");
                        var o = profile.getSubNode("ITEM", itemId);
                        if (o) {
                            var items = profile.getSubNode("BOX"),
                                offset = o.offset(null, items),
                                top = offset ? offset.top : 0,
                                height = o.offsetHeight(),
                                sh = items.scrollHeight(),
                                st = items.scrollTop(),
                                hh = items.height();
                            if (sh > hh) {
                                if (top < st || (top + height) > (st + hh)) {
                                    items.scrollTop(top)
                                }
                            }
                        }
                    }
                } else {
                    if (selmode == "multi" || selmode == "multibycheckbox") {
                        uiv = uiv ? uiv.split(properties.valueSeparator) : [];
                        value = value ? value.split(properties.valueSeparator) : [];
                        if (flag) {
                            _.arr.each(value, function (o) {
                                fun("BAR", o)
                            })
                        } else {
                            _.arr.each(uiv, function (o) {
                                fun("BAR", o, false)
                            });
                            _.arr.each(value, function (o) {
                                fun("BAR", o)
                            })
                        }
                    }
                }
            })
        },
        insertItems: function (arr, pid, base, before) {
            if (!arr || !_.isArr(arr) || arr.length < 1) {
                return this
            }
            var node, data, b = this._afterInsertItems;
            return this.each(function (profile) {
                var tar, r, k;
                data = profile.box._adjustItems(arr);
                if (!pid) {
                    k = profile.properties;
                    tar = k.items || (k.items = [])
                } else {
                    k = profile.getItemByItemId(pid);
                    tar = _.isArr(k.sub) ? k.sub : (k.sub = [])
                }
                if (profile.renderId) {
                    if (!base) {
                        if (!pid) {
                            node = profile.getSubNode("ITEMS")
                        } else {
                            if (pid && k._inited) {
                                node = profile.getSubNodeByItemId("SUB", pid)
                            }
                        }
                        if (node) {
                            r = profile._buildItems("items", profile.box._prepareItems(profile, data, pid));
                            if (before) {
                                node.prepend(r)
                            } else {
                                node.append(r)
                            }
                        }
                    } else {
                        node = profile.getSubNodeByItemId("ITEM", base);
                        if (node) {
                            r = profile._buildItems("items", profile.box._prepareItems(profile, data, pid));
                            if (before) {
                                node.addPrev(r)
                            } else {
                                node.addNext(r)
                            }
                        }
                    }
                }
                if (!base) {
                    _.arr.insertAny(tar, data, before ? 0 : -1)
                } else {
                    var index = _.arr.subIndexOf(tar, "id", base);
                    _.arr.insertAny(tar, data, before ? index : (index + 1))
                }
                if (profile.renderId) {
                    if (!(("iniFold" in k) ? k.iniFold : profile.properties.iniFold)) {
                        if (!pid || profile.getItemByItemId(pid)._inited) {
                            profile.boxing()._toggleNodes(data, true)
                        }
                    }
                }
                if (b && profile.renderId) {
                    profile.boxing()._afterInsertItems(profile, data, pid, base, before)
                }
                if (profile.renderId && pid) {
                    profile.box._tofold(profile, k, pid)
                }
            })
        },
        _toggleNodes: function (items, expand, recursive) {
            var self = this;
            if (_.isArr(items)) {
                _.arr.each(items, function (o) {
                    self.toggleNode(o.id, expand, recursive)
                })
            }
            return self
        },
        toggleNode: function (id, expand, recursive) {
            var profile = this.get(0),
                ns = this,
                self = arguments.callee;
            if (id) {
                var o = profile.getItemByItemId(id);
                if (o && o.sub) {
                    profile.box._setSub(profile, o, typeof expand == "boolean" ? expand : !o._checked, recursive)
                }
            } else {
                _.arr.each(profile.properties.items, function (item) {
                    self.call(ns, item.id, expand, recursive)
                })
            }
            return this
        },
        openToNode: function (id) {
            return this.each(function (profile) {
                var res = false,
                    a = [],
                    fun = function (arr, catId, layer) {
                        layer = layer || 0;
                        var me = arguments.callee;
                        _.arr.each(arr, function (o) {
                            if (o.id == catId) {
                                a.push(o);
                                res = true;
                                return false
                            }
                            if (o.sub && _.isArr(o.sub)) {
                                res = me.call(me, o.sub, catId, ++layer);
                                if (res) {
                                    a.push(o);
                                    return false
                                }
                            }
                        });
                        return res
                    };
                fun(profile.properties.items, id);
                if (res) {
                    a.reverse();
                    _.arr.each(a, function (o, i) {
                        if (o.sub) {
                            profile.boxing().toggleNode(o.id, true);
                            if (i == a.length - 1 && !(o.hasOwnProperty("group") ? o.group : profile.properties.group)) {
                                profile.boxing().fireItemClickEvent(o.id)
                            }
                        } else {
                            profile.boxing().fireItemClickEvent(o.id)
                        }
                    })
                }
            })
        }
    },
    Initialize: function () {
        this.addTemplateKeys(["DISABLED"])
    },
    Static: {
        _focusNodeKey: "BAR",
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            ondrag: "return false",
            onselectstart: "return false",
            BORDER: {
                tagName: "div",
                BOX: {
                    tagName: "div",
                    onselectstart: "return false",
                    ITEMS: {
                        tagName: "div",
                        text: "{items}"
                    }
                }
            },
            $submap: {
                items: {
                    ITEM: {
                        className: "{itemClass} {disabled}  {readonly}",
                        style: "{itemStyle}{itemDisplay}",
                        tagName: "div",
                        BAR: {
                            $order: 0,
                            tabindex: "{_tabindex}",
                            className: "{cls_group} {cls_fold}",
                            RULER: {
                                $order: 0,
                                style: "{rulerStyle}",
                                text: "{innerIcons}"
                            },
                            TOGGLE: {
                                $order: 1,
                                className: "{togglemark}"
                            },
                            MARK: {
                                $order: 2,
                                style: "{mark2Display}"
                            },
                            ITEMICON: {
                                $order: 3,
                                className: "xui-ui-icon {imageClass}",
                                style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                            },
                            ITEMCAPTION: {
                                text: "&nbsp;{caption}",
                                className: "{disabled}  {readonly}",
                                $order: 4
                            },
                            EXTRA: {
                                text: "{ext}",
                                $order: 5
                            }
                        },
                        SUB: {
                            $order: 1,
                            tagName: "div",
                            text: xui.UI.$childTag
                        }
                    }
                }
            }
        },
        Appearances: {
            KEY: {
                "font-family": "Verdana, Helvetica, sans-serif",
                border: 0
            },
            EXTRA: {
                display: "none"
            },
            BOX: {
                left: 0,
                overflow: "auto",
                "overflow-x": "hidden",
                position: "relative"
            },
            ITEMS: {
                overflow: "hidden"
            },
            ITEM: {
                "white-space": "nowrap",
                position: "relative",
                overflow: "hidden"
            },
            BAR: {
                cursor: "pointer",
                zoom: xui.browser.ie ? 1 : null,
                position: "relative",
                display: "block",
                overflow: "hidden",
                "font-size": "12px",
                padding: "2px 4px",
                border: "1px solid",
                "outline-offset": "-1px",
                "-moz-outline-offset": (xui.browser.gek && xui.browser.ver < 3) ? "-1px !important" : null,
                "border-color": "#EDF4FC #698AB3 #698AB3 #EDF4FC",
                "background-color": "#CCE4FC"
            },
            DISABLED: {
                color: "#808080"
            },
            "BAR-mouseover": {
                $order: 1,
                "background-color": "#fffa9f"
            },
            "BAR-checked": {
                $order: 2,
                "background-color": "#fffa9f"
            },
            "BAR-GROUP": {
                $order: 2,
                "border-top": "none",
                "border-bottom": "none",
                padding: "5px 4px",
                height: "18px",
                background: xui.UI.$bg("bar_vertical.gif", "repeat-x left -380px", true)
            },
            "BAR-GROUP-mouseover": {
                $order: 3,
                "background-position": "left -410px"
            },
            "BAR-GROUP-checked": {
                $order: 4,
                "background-position": "left -440px"
            },
            SUB: {
                overflow: "hidden",
                zoom: xui.browser.ie ? 1 : null,
                height: 0,
                "font-size": "1px",
                "line-height": "1px",
                position: "relative",
                "margin-left": "16px"
            },
            MARK: {
                cursor: "pointer",
                width: "16px",
                height: "16px",
                "vertical-align": "middle",
                background: xui.UI.$bg("icons.gif", "no-repeat -20px -70px", true)
            },
            "BAR-checked MARK": {
                $order: 3,
                "background-position": "0 -70px"
            },
            ITEMCAPTION: {
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle",
                padding: "2px"
            }
        },
        Behaviors: {
            HoverEffected: {
                TOGGLE: "TOGGLE",
                BAR: "BAR"
            },
            ClickEffected: {
                TOGGLE: "TOGGLE",
                BAR: "BAR"
            },
            DraggableKeys: ["BAR"],
            NoDraggableKeys: ["TOGGLE"],
            DroppableKeys: ["BAR", "TOGGLE", "BOX"],
            onSize: xui.UI.$onSize,
            TOGGLE: {
                onClick: function (profile, e, src) {
                    var properties = profile.properties,
                        domId = xui.use(src).id(),
                        item = profile.getItemByDom(domId);
                    if (properties.disabled || item.disabled) {
                        return false
                    }
                    if (!("sub" in item)) {
                        return false
                    }
                    profile.box._setSub(profile, item, !item._checked);
                    return false
                }
            },
            BAR: {
                onDblclick: function (profile, e, src) {
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        rtn = profile.onDblclick && profile.boxing().onDblclick(profile, item, e, src);
                    if (item.sub && rtn !== false) {
                        profile.getSubNode("TOGGLE", profile.getSubId(src)).onClick()
                    }
                },
                onClick: function (profile, e, src) {
                    return profile.box._onclickbar(profile, e, src)
                },
                onKeydown: function (profile, e, src) {
                    return profile.box._onkeydownbar(profile, e, src)
                },
                onContextmenu: function (profile, e, src) {
                    if (profile.onContextmenu) {
                        return profile.boxing().onContextmenu(profile, e, src, profile.getItemByDom(src)) !== false
                    }
                }
            },
            BOX: {
                onScroll: function (profile, e, src) {
                    if ((e = xui.use(src)).scrollLeft() !== 0) {
                        e.scrollLeft(0)
                    }
                }
            }
        },
        EventHandlers: {
            onDblclick: function (profile, item, e, src) {},
            onGetContent: function (profile, item, callback) {},
            onClick: function (profile, item, e, src) {},
            beforeClick: function (profile, item, e, src) {},
            afterClick: function (profile, item, e, src) {},
            onItemSelected: function (profile, item, e, src, type) {},
            beforeFold: function (profile, item) {},
            beforeExpand: function (profile, item) {},
            afterFold: function (profile, item) {},
            afterExpand: function (profile, item) {}
        },
        DataModel: {
            listKey: null,
            width: 200,
            height: 200,
            iniFold: true,
            animCollapse: false,
            dock: "fill",
            group: {
                ini: false,
                action: function (v) {
                    var self = this,
                        items = self.properties.items,
                        results = self.queryItems(items, function (o) {
                            return o.sub && o.group === undefined
                        }),
                        nodes = xui();
                    _.arr.each(results, function (o) {
                        nodes.merge(self.getSubNodeByItemId("BAR", o.id))
                    });
                    var cls1 = self.getClass("BAR"),
                        cls2 = self.getClass("BAR", "-group");
                    if (v) {
                        nodes.replaceClass(new RegExp("(\\b)" + cls1 + "([^b]*\\b)", "g"), "$1" + cls2 + "$2")
                    } else {
                        nodes.replaceClass(new RegExp("(\\b)" + cls2 + "([^b]*\\b)", "g"), "$1" + cls1 + "$2")
                    }
                }
            },
            selMode: {
                ini: "single",
                listbox: ["single", "none", "multi", "multibycheckbox"],
                action: function (value) {
                    var ns = this,
                        p = this.properties,
                        sels = [];
                    _.each(this.SubSerialIdMapItem, function (o) {
                        if (!(o.sub && (o.hasOwnProperty("group") ? o.group : p.group))) {
                            sels.push(ns.getSubNodeByItemId("MARK", o.id).get(0))
                        }
                    });
                    xui(sels).css("display", (value == "multi" || value == "multibycheckbox") ? "" : "none")
                }
            },
            noCtrlKey: true,
            singleOpen: false,
            dynDestory: false,
            position: "absolute"
        },
        RenderTrigger: function () {
            var self = this,
                pro = self.properties;
            if (!pro.iniFold) {
                self.boxing()._toggleNodes(pro.items, true)
            }
        },
        _onclickbar: function (profile, e, src) {
            var properties = profile.properties,
                domId = xui.use(src).id(),
                item = profile.getItemByDom(domId),
                itemId = profile.getSubId(domId),
                box = profile.boxing(),
                ks = xui.Event.getKey(e);
            if (profile.beforeClick && false === o.boxing().beforeClick(profile, item, e, src)) {
                return
            }
            if (properties.disabled || item.disabled) {
                return false
            }
            if (profile.onClick) {
                box.onClick(profile, item, e, src)
            }
            if (item.sub && (item.hasOwnProperty("group") ? item.group : properties.group)) {
                profile.getSubNode("TOGGLE", itemId).onClick();
                return false
            }
            profile.getSubNode(profile.box._focusNodeKey, itemId).focus();
            switch (properties.selMode) {
            case "none":
                box.onItemSelected(profile, item, e, src, 0);
                break;
            case "multibycheckbox":
                if (properties.readonly || item.readonly) {
                    return false
                }
                if (profile.keys.MARK) {
                    if (profile.getKey(xui.Event.getSrc(e).id || "") != profile.keys.MARK) {
                        box.onItemSelected(profile, item, e, src, 0);
                        break
                    }
                }
            case "multi":
                if (properties.readonly || item.readonly) {
                    return false
                }
                var value = box.getUIValue(),
                    arr = value ? value.split(properties.valueSeparator) : [],
                    checktype = 1;
                if (arr.length && (ks.ctrlKey || ks.shiftKey || properties.noCtrlKey)) {
                    if (ks.shiftKey) {
                        if (profile.$firstV._pid != item._pid) {
                            return false
                        }
                        var items = properties.items;
                        if (item._pid) {
                            var pitem = profile.getItemByItemId(item._pid);
                            if (pitem) {
                                items = pitem.sub
                            }
                        }
                        var i1 = _.arr.subIndexOf(items, "id", profile.$firstV.id),
                            i2 = _.arr.subIndexOf(items, "id", item.id),
                            i;
                        arr.length = 0;
                        for (i = Math.min(i1, i2); i <= Math.max(i1, i2); i++) {
                            arr.push(items[i].id)
                        }
                    } else {
                        if (_.arr.indexOf(arr, item.id) != -1) {
                            _.arr.removeValue(arr, item.id);
                            checktype = -1
                        } else {
                            arr.push(item.id)
                        }
                    }
                    arr.sort();
                    value = arr.join(properties.valueSeparator);
                    if (box.getUIValue() != value) {
                        box.setUIValue(value);
                        if (box.get(0) && box.getUIValue() == value) {
                            box.onItemSelected(profile, item, e, src, checktype)
                        }
                    }
                    break
                }
            case "single":
                if (box.getUIValue() != item.id) {
                    profile.$firstV = item;
                    box.setUIValue(item.id);
                    if (box.get(0) && box.getUIValue() == item.id) {
                        box.onItemSelected(profile, item, e, src, 1)
                    }
                }
                break
            }
            if (profile.afterClick) {
                box.afterClick(profile, item, e, src)
            }
        },
        _onkeydownbar: function (profile, e, src) {
            var keys = xui.Event.getKey(e),
                key = keys.key,
                shift = keys.shiftKey,
                ctrl = keys.ctrlKey,
                cur = profile.getSubNode(profile.box._focusNodeKey, profile.getSubId(src)),
                root = profile.getRoot(),
                first = root.nextFocus(true, true, false),
                last = root.nextFocus(false, true, false);
            switch (key) {
            case "enter":
                cur.onClick();
                break;
            case "tab":
                if (shift) {
                    if (cur.get(0) != first.get(0)) {
                        first.focus();
                        return false
                    }
                } else {
                    if (cur.get(0) != last.get(0)) {
                        last.focus();
                        return false
                    }
                }
                break;
            case "up":
                if (ctrl) {
                    profile.getSubNode("TOGGLE", profile.getSubId(src)).onClick();
                    return false
                }
                if (cur.get(0) == first.get(0)) {
                    last.focus()
                } else {
                    cur.nextFocus(false, true, false).focus()
                }
                return false;
                break;
            case "down":
                if (ctrl) {
                    profile.getSubNode("TOGGLE", profile.getSubId(src)).onClick();
                    return false
                }
                if (cur.get(0) == last.get(0)) {
                    first.focus()
                } else {
                    cur.nextFocus(true, false, false).focus()
                }
                return false;
                break;
            case "right":
            case "left":
                profile.getSubNode("TOGGLE", profile.getSubId(src)).onClick();
                return false
            }
        },
        _onStartDrag: function (profile, e, src, pos) {
            var pos = xui.Event.getPos(e);
            xui.use(src).startDrag(e, {
                dragType: "icon",
                shadowFrom: src,
                targetLeft: pos.left + 12,
                targetTop: pos.top + 12,
                dragCursor: "pointer",
                dragDefer: 1,
                dragKey: profile.box.getDragKey(profile, src),
                dragData: profile.box.getDragData(profile, e, src)
            });
            return false
        },
        _onDropTest: function (profile, e, src, key, data, item) {
            var fid = data && data.domId,
                tid = xui.use(src).id();
            if (fid) {
                if (fid == tid) {
                    return false
                }
                if (_.get(xui.use(src).get(0), ["parentNode", "previousSibling", "firstChild", "id"]) == fid) {
                    return false
                }
            }
        },
        _onDrop: function (profile, e, src, key, data, item) {
            xui.DragDrop.setDragIcon("none");
            var k = profile.getKey(xui.use(src).id()),
                po = data.profile,
                ps = data.domId,
                oitem, ks = profile.keys,
                t = xui.absObj.$specialChars,
                b = profile.boxing();
            oitem = _.clone(po.getItemByDom(ps), function (o, i) {
                return !t[(i + "").charAt(0)]
            });
            po.boxing().removeItems([oitem.id]);
            if (k == ks.BOX) {
                b.insertItems([oitem], null, null, false)
            } else {
                if (k == ks.BAR) {
                    b.insertItems([oitem], item._pid, item.id, true)
                } else {
                    if (k == ks.TOGGLE) {
                        b.insertItems([oitem], item.id, null, false)
                    }
                }
            }
            return false
        },
        _prepareItem: function (profile, item, oitem, pid, index, len) {
            var p = profile.properties,
                map1 = profile.ItemIdMapSubSerialId,
                map2 = profile.SubSerialIdMapItem,
                pitem;
            if (pid) {
                oitem._pid = pid
            }
            item.togglemark = item.sub ? "xui-uicmd-toggle" : "xui-uicmd-none";
            item.disabled = item.disabled ? profile.getClass("KEY", "-disabled") : "";
            item.itemDisplay = item.hidden ? "display:none;" : "";
            item.mark2Display = (p.selMode == "multi" || p.selMode == "multibycheckbox") ? "" : "display:none;";
            item._tabindex = p.tabindex;
            if (item.sub && (item.hasOwnProperty("group") ? item.group : p.group)) {
                item.cls_group = profile.getClass("BAR", "-group");
                item.mark2Display = "display:none"
            }
        },
        _setSub: function (profile, item, flag, recursive) {
            var id = profile.domId,
                ins = profile.boxing(),
                itemId = profile.getSubIdByItemId(item.id),
                properties = profile.properties,
                barNode = profile.getSubNode("BAR", itemId),
                markNode = profile.getSubNode("TOGGLE", itemId),
                subNs = profile.getSubNode("SUB", itemId);
            if (xui.Thread.isAlive(profile.key + profile.id)) {
                return
            }
            if (!flag) {
                if (item._checked) {
                    if (ins.beforeFold && false === ins.beforeFold(profile, item)) {
                        return
                    }
                    var h = subNs.height();
                    if (properties.animCollapse) {
                        subNs.animate({
                            height: [h, 0]
                        }, null, function () {
                            subNs.css({
                                display: "none"
                            })
                        }, 100, 5, "expoIn", profile.key + profile.id).start()
                    } else {
                        subNs.css({
                            display: "none",
                            height: 0
                        })
                    }
                    markNode.tagClass("-checked", false);
                    barNode.tagClass("-expand", false).tagClass("-fold");
                    item._checked = false;
                    if (item.group || properties.group) {
                        barNode.tagClass("-checked", false)
                    }
                    if (properties.dynDestory) {
                        var s = item.sub,
                            arr = [];
                        for (var i = 0, l = s.length; i < l; i++) {
                            arr.push(s[i].id)
                        }
                        profile.boxing().removeItems(arr);
                        item.sub = true;
                        delete item._inited
                    }
                    if (ins.afterFold) {
                        ins.afterFold(profile, item)
                    }
                }
                if (recursive && item.sub && !properties.dynDestory) {
                    _.arr.each(item.sub, function (o) {
                        if (o.sub && o.sub.length) {
                            profile.box._setSub(profile, o, flag, recursive)
                        }
                    })
                }
            } else {
                if (!item._checked) {
                    if (ins.beforeExpand && false === ins.beforeExpand(profile, item)) {
                        return
                    }
                    var openSub = function (profile, item, id, markNode, subNs, barNode, sub, recursive) {
                            var b = profile.boxing(),
                                p = profile.properties;
                            if (!item._inited) {
                                delete item.sub;
                                item._inited = true;
                                if (typeof sub == "string") {
                                    subNs.html(item.sub = sub, false)
                                } else {
                                    if (_.isArr(sub)) {
                                        b.insertItems(sub, item.id)
                                    } else {
                                        if (sub["xui.Template"] || sub["xui.UI"]) {
                                            subNs.append(item.sub = sub.render(true))
                                        }
                                    }
                                }
                                b.setUIValue(b.getUIValue(), true)
                            }
                            if (p.singleOpen) {
                                b._toggleNodes(item._pid ? profile.getItemByItemId(item._pid).sub : p.items, false)
                            }
                            if (!recursive) {
                                var h = subNs.height(true);
                                if (p.animCollapse) {
                                    subNs.animate({
                                        height: [0, h]
                                    }, function () {
                                        subNs.css({
                                            display: ""
                                        })
                                    }, function () {
                                        subNs.css({
                                            height: "auto"
                                        })
                                    }, 100, 5, "expoOut", profile.key + profile.id).start()
                                } else {
                                    subNs.css({
                                        display: "",
                                        height: "auto"
                                    })
                                }
                            } else {
                                subNs.css({
                                    display: "",
                                    height: "auto"
                                })
                            }
                            markNode.tagClass("-checked");
                            barNode.tagClass("-fold", false).tagClass("-expand");
                            if (item.group || properties.group) {
                                barNode.tagClass("-checked")
                            }
                            item._checked = true
                        },
                        sub = item.sub,
                        callback = function (sub) {
                            openSub(profile, item, id, markNode, subNs, barNode, sub, recursive)
                        },
                        t;
                    if ((t = typeof sub) == "string" || t == "object") {
                        callback(sub)
                    } else {
                        if (profile.onGetContent) {
                            var r = profile.boxing().onGetContent(profile, item, callback);
                            if (r) {
                                if (r === true) {
                                    item._inited = true
                                }
                                callback(r)
                            }
                        }
                    }
                    if (ins.afterExpand) {
                        ins.afterExpand(profile, item)
                    }
                }
                if (recursive && item.sub) {
                    _.arr.each(item.sub, function (o) {
                        if (o.sub && o.sub.length && !o._checked) {
                            profile.box._setSub(profile, o, flag, recursive)
                        }
                    })
                }
            }
        },
        _tofold: function (profile, item, pid) {
            profile.getSubNodeByItemId("BAR", pid).addClass(profile.getClass("BAR", "-fold"));
            profile.getSubNodeByItemId("TOGGLE", pid).replaceClass(new RegExp("\\buicmd-none\\b"), "xui-uicmd-toggle")
        },
        _onresize: function (profile, width, height) {
            profile.getSubNode("BORDER").cssSize({
                width: width ? width : null,
                height: height ? height : null
            });
            profile.getSubNode("BOX").cssSize({
                width: width ? width : null,
                height: height ? height : null
            })
        }
    }
});
Class("xui.UI.TreeView", "xui.UI.TreeBar", {
    Instance: {
        _afterInsertItems: function (profile, data, pid) {
            profile.box._reorderItems(profile, pid)
        },
        _afterRemoveItems: function (profile, data) {
            _.arr.each(data, function (item) {
                profile.box._reorderItems(profile, item._pid)
            })
        }
    },
    Initialize: function () {
        this.addTemplateKeys(["IMAGE"]);
        var t = this.getTemplate();
        delete t.$submap.items.ITEM.BAR.tabindex;
        t.$submap.items.ITEM.BAR.ITEMCAPTION.tabindex = "{_tabindex}";
        this.setTemplate(t)
    },
    Static: {
        _focusNodeKey: "ITEMCAPTION",
        Appearances: {
            ITEMS: {},
            ITEM: {
                "white-space": "nowrap",
                position: "relative"
            },
            BAR: {
                zoom: xui.browser.ie ? 1 : null,
                position: "relative",
                display: "block",
                "font-size": "12px",
                padding: "0",
                border: "0"
            },
            SUB: {
                zoom: xui.browser.ie ? 1 : null,
                height: 0,
                "font-size": "1px",
                "line-height": "1px",
                position: "relative"
            },
            BOX: {
                left: 0,
                overflow: "auto",
                position: "relative",
                "background-color": "#FFF"
            },
            "BAR ITEMICON": {
                background: xui.UI.$bg("icons.gif", "no-repeat 0 0", true),
                "background-position": "-244px -236px"
            },
            "BAR-fold ITEMICON": {
                $order: 1,
                "background-position": "-260px -236px"
            },
            "BAR-expand ITEMICON": {
                $order: 1,
                "background-position": "-276px -236px"
            },
            "IMAGE-vertical, IMAGE-path-1, IMAGE-path-2, IMAGE-path-3, IMAGE-fold-1, IMAGE-fold-2, IMAGE-fold-3": {
                $order: 1,
                background: xui.UI.$bg("icons.gif", "no-repeat 0 0", true),
                width: "16px",
                height: "18px",
                "vertical-align": "middle"
            },
            "IMAGE-none": {
                width: "16px",
                height: "18px",
                "vertical-align": "middle"
            },
            "IMAGE-path-1,IMAGE-path-2": {
                $order: 2,
                "background-position": "-196px -236px"
            },
            "IMAGE-path-3": {
                $order: 3,
                "background-position": "-212px -236px"
            },
            "IMAGE-fold-1": {
                $order: 4,
                "background-position": "-196px -254px"
            },
            "IMAGE-fold-2": {
                $order: 5,
                "background-position": "-212px -254px"
            },
            "IMAGE-fold-3": {
                $order: 6,
                "background-position": "-228px -254px"
            },
            "IMAGE-fold-1-checked": {
                $order: 7,
                "background-position": "-244px -254px"
            },
            "IMAGE-fold-2-checked": {
                $order: 8,
                "background-position": "-260px -254px"
            },
            "IMAGE-fold-3-checked": {
                $order: 9,
                "background-position": "-276px -254px"
            },
            "IMAGE-fold-1-mousedown": {
                $order: 10,
                "background-position": "-196px -272px"
            },
            "IMAGE-fold-2-mousedown": {
                $order: 11,
                "background-position": "-212px -272px"
            },
            "IMAGE-fold-3-mousedown": {
                $order: 12,
                "background-position": "-228px -272px"
            },
            "IMAGE-fold-1-checked-mousedown": {
                $order: 13,
                "background-position": "-244px -272px"
            },
            "IMAGE-fold-2-checked-mousedown": {
                $order: 14,
                "background-position": "-260px -272px"
            },
            "IMAGE-fold-3-checked-mousedown": {
                $order: 15,
                "background-position": "-276px -272px"
            },
            "IMAGE-vertical": {
                $order: 16,
                "background-position": "-228px -236px"
            },
            ITEMCAPTION: {
                cursor: "pointer",
                "outline-offset": "-1px",
                "-moz-outline-offset": (xui.browser.gek && xui.browser.ver < 3) ? "-1px !important" : null
            },
            "ITEMCAPTION-mouseover": {
                $order: 12,
                "background-color": "#eee"
            },
            "BAR-checked": {},
            "ITEMCAPTION-mousedown, BAR-checked ITEMCAPTION": {
                $order: 14,
                "background-color": "#4E8FDF",
                color: "#fff"
            }
        },
        Behaviors: {
            HoverEffected: {
                ITEMCAPTION: "ITEMCAPTION"
            },
            ClickEffected: {
                TOGGLE: "TOGGLE",
                ITEMCAPTION: "ITEMCAPTION"
            },
            DraggableKeys: ["ITEMCAPTION"],
            DroppableKeys: ["BAR", "TOGGLE", "BOX"],
            BAR: {
                onDblclick: null,
                onClick: null,
                onKeydown: null,
                onContextmenu: null,
                afterMouseover: null,
                afterMouseout: null,
                afterMousedown: null,
                afterMouseup: null,
                beforeDragbegin: null,
                beforeDragstop: null,
                beforeMousedown: null
            },
            ITEMCAPTION: {
                onDblclick: function (profile, e, src) {
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        rtn = profile.onDblclick && profile.boxing().onDblclick(profile, item, src);
                    if (item.sub && rtn !== false) {
                        profile.getSubNode("TOGGLE", profile.getSubId(src)).onClick()
                    }
                },
                onClick: function (profile, e, src) {
                    return profile.box._onclickbar(profile, e, xui.use(src).parent().xid())
                },
                onKeydown: function (profile, e, src) {
                    return profile.box._onkeydownbar(profile, e, xui.use(src).parent().xid())
                },
                onContextmenu: function (profile, e, src) {
                    if (profile.onContextmenu) {
                        return profile.boxing().onContextmenu(profile, e, src, profile.getItemByDom(src)) !== false
                    }
                }
            },
            MARK: {
                onClick: function (profile, e, src) {
                    return profile.box._onclickbar(profile, e, xui.use(src).parent().xid())
                }
            },
            ITEMICON: {
                onClick: function (profile, e, src) {
                    return profile.box._onclickbar(profile, e, xui.use(src).parent().xid())
                }
            },
            BOX: {
                onScroll: null
            }
        },
        DataModel: {
            group: null
        },
        _buildIcon: function (cls, type) {
            return "<span class='" + cls + type + "'></span>"
        },
        _getType: function (sub, type) {
            return sub ? type == "last" ? "-fold-3" : type == "first" ? "-fold-1" : "-fold-2" : type == "last" ? "-path-3" : type == "first" ? "-path-1" : "-path-2"
        },
        _prepareItem: function (profile, item, oitem, pid, index, len) {
            var p = profile.properties,
                map1 = profile.ItemIdMapSubSerialId,
                map2 = profile.SubSerialIdMapItem,
                pitem, arr, ll, html, cls = profile.getClass("IMAGE"),
                buildIcon = this._buildIcon,
                getType = this._getType;
            if (pid) {
                oitem._pid = pid;
                if (pitem = map2[map1[pid]]) {
                    oitem._deep = pitem._deep + 1;
                    arr = _.copy(pitem._icons);
                    arr.push(index == len - 1 ? "last" : index === 0 ? "first" : "middle");
                    oitem._icons = arr;
                    item.rulerStyle = "width:" + (oitem._deep * 16) + "px;";
                    html = "";
                    ll = arr.length - 1;
                    _.arr.each(arr, function (o, i) {
                        if (i !== ll) {
                            html += buildIcon(cls, o == "last" ? "-none" : "-vertical")
                        }
                    });
                    item.innerIcons = html;
                    item.togglemark = cls + getType(item.sub, arr[ll])
                }
            } else {
                oitem._deep = 0;
                oitem._icons = [index == len - 1 ? "last" : index === 0 ? "first" : "middle"];
                item.rulerStyle = "";
                item.innerIcons = "";
                item.togglemark = cls + getType(item.sub, oitem._icons[0])
            }
            item.imageDisplay = "";
            item.cls_fold = item.sub ? profile.getClass("BAR", "-fold") : "";
            item.disabled = item.disabled ? profile.getClass("KEY", "-disabled") : "";
            item.itemDisplay = item.hidden ? "display:none;" : "";
            item.mark2Display = (p.selMode == "multi" || p.selMode == "multibycheckbox") ? "" : "display:none;";
            item._tabindex = p.tabindex
        },
        _reorderItems: function (profile, pid) {
            var p = profile.properties,
                map1 = profile.ItemIdMapSubSerialId,
                map2 = profile.SubSerialIdMapItem,
                cls = profile.getClass("IMAGE"),
                getType = this._getType;
            var getAllSub = function (item, arr) {
                    if (item.sub && item.sub.length) {
                        var me = arguments.callee;
                        _.arr.each(item.sub, function (item) {
                            if (item._icons) {
                                arr.push(item)
                            }
                            me(item, arr)
                        })
                    }
                };
            if (pid && !map1[pid]) {
                return
            }
            var baseid = profile.box.KEY + "-RULER:" + profile.serialId + ":",
                arr = pid ? map2[map1[pid]].sub : p.items,
                len = arr.length,
                ov, nv, deep = 0,
                aitem, ns;
            _.arr.each(arr, function (item, i) {
                if (item._icons) {
                    ov = item._icons[item._icons.length - 1];
                    nv = i == len - 1 ? "last" : i === 0 ? "first" : "middle";
                    if (ov != nv) {
                        ns = [];
                        aitem = null;
                        item._icons[deep = item._icons.length - 1] = nv;
                        aitem = item;
                        var a = [];
                        getAllSub(item, a);
                        _.arr.each(a, function (o) {
                            o._icons[deep] = nv;
                            ns.push(o.id)
                        });
                        if (aitem) {
                            profile.getSubNodeByItemId("TOGGLE", aitem.id).replaceClass(new RegExp("\\b" + cls + "-[\\w]+-[\\w]+((-[\\w]+)*)\\b", "g"), cls + getType(aitem.sub, nv) + "$1")
                        }
                        if (ns.length) {
                            _.arr.each(ns, function (id, i) {
                                ns[i] = baseid + map1[id]
                            });
                            ns = xui(ns).first();
                            if (deep) {
                                ns = ns.next(deep)
                            }
                            ns.removeClass(new RegExp("\\b" + cls + "[-\\w]+\\b")).addClass(cls + (nv == "last" ? "-none" : "-vertical"))
                        }
                    }
                }
            })
        },
        _tofold: function (profile, item, pid) {
            var cls = profile.getClass("IMAGE");
            profile.getSubNodeByItemId("BAR", pid).addClass(profile.getClass("BAR", "-fold"));
            profile.getSubNodeByItemId("TOGGLE", pid).replaceClass(new RegExp("\\b" + cls + "-path([-\\w]+)\\b"), cls + "-fold$1")
        }
    }
});
Class("xui.UI.PopMenu", ["xui.UI.Widget", "xui.absList"], {
    Instance: {
        adjustSize: function () {
            this.each(function (profile) {
                if (profile.renderId) {
                    var border = profile.getSubNode("BORDER"),
                        items = profile.getSubNode("ITEMS").cssSize({
                            width: "auto",
                            height: "auto"
                        }),
                        itemNs = profile.getSubNode("ITEM", true),
                        pro = profile.properties,
                        ww = 0,
                        hh = 0;
                    hh = items.height();
                    if (hh % 2 == 0) {
                        hh += 2
                    } else {
                        hh += 1
                    }
                    items.addClass(profile.getClass("ITEMS", "-inline"));
                    itemNs.each(function (n) {
                        ww = Math.max(ww, n.offsetWidth)
                    });
                    if (ww % 2 == 0) {
                        ww += 2
                    } else {
                        ww += 1
                    }
                    items.removeClass(profile.getClass("ITEMS", "-inline"));
                    items.cssSize({
                        width: ww,
                        height: hh
                    });
                    var h = Math.min(pro._maxHeight, hh) + border._borderW(),
                        w = Math.min(pro._maxWidth, ww) + border._borderH();
                    pro.width = w;
                    pro.height = h;
                    profile.getRoot().cssSize({
                        width: w,
                        height: h
                    });
                    xui.UI.$doResize(profile, w, h, true)
                }
            });
            return this._setScroll()
        },
        _setScroll: function () {
            return this.each(function (profile) {
                if (profile.renderId) {
                    var o = profile.getSubNode("ITEMS"),
                        t = o.offsetTop(),
                        h = o.offsetHeight(),
                        b = profile.getRoot(),
                        hh = b.offsetHeight();
                    profile.getSubNode("TOP").css("display", t === 0 ? "none" : "block");
                    profile.getSubNode("BOTTOM").css("display", (hh >= h + t) ? "none" : "block")
                }
            })
        },
        _scrollToBottom: function () {
            return this.each(function (profile) {
                var o = profile.getSubNode("ITEMS"),
                    border = profile.getSubNode("BORDER"),
                    y = o.offsetTop(),
                    offset, h = o.offsetHeight(),
                    b = false,
                    bh = border.height();
                if (bh < h + y) {
                    if (!profile.$scrollStep) {
                        profile.$scrollStep = 1
                    }
                    if (profile.$scrollStep < 5) {
                        profile.$scrollStep = profile.$scrollStep * 1.01
                    }
                    y -= profile.$scrollStep;
                    if (bh > h + y) {
                        y = bh - h;
                        b = true
                    }
                    o.top(y);
                    if (b) {
                        profile.getSubNode("BOTTOM").css("display", "none");
                        profile.$scrollTobottom = false;
                        profile.$scrollStep = null
                    } else {
                        profile.getSubNode("TOP").css("display", "block");
                        if (profile.$scrollTobottom) {
                            _.asyRun(arguments.callee, 0, [profile], this)
                        }
                    }
                }
            })
        },
        _scrollToTop: function () {
            return this.each(function (profile) {
                var o = profile.getSubNode("ITEMS"),
                    y = o.offsetTop(),
                    b = false;
                if (y < 0) {
                    if (!profile.$scrollStep) {
                        profile.$scrollStep = 1
                    }
                    if (profile.$scrollStep < 5) {
                        profile.$scrollStep = profile.$scrollStep * 1.01
                    }
                    y += profile.$scrollStep;
                    if (y >= -1) {
                        y = 0;
                        b = true
                    }
                    o.top(y);
                    if (b) {
                        profile.getSubNode("TOP").css("display", "none");
                        profile.$scrollToTop = false;
                        profile.$scrollStep = null
                    } else {
                        profile.getSubNode("BOTTOM").css("display", "block");
                        if (profile.$scrollToTop) {
                            _.asyRun(arguments.callee, 0, [profile], this)
                        }
                    }
                }
            })
        },
        pop: function (obj, type, parent) {
            var profile = this.get(0),
                sms = "$subPopMenuShowed",
                hl = "$highLight",
                cm = "$childPopMenu";
            if (!profile.renderId) {
                var o = profile.boxing().render(true);
                xui.Dom.getEmptyDiv().append(o)
            }
            var root = profile.getRoot();
            if (profile.$highLight) {
                xui([profile.$highLight]).tagClass("-mouseover", false)
            }
            profile._conainer = parent;
            root.popToTop(obj, type, parent);
            var f = function () {
                    var p = arguments.callee.profile;
                    if (p.box) {
                        p.boxing().hide();
                        if (p.$popGrp) {
                            p.$popGrp.length = 0
                        }
                    }
                };
            f.profile = profile;
            if (!profile.$popGrp || !profile.$popGrp.length) {
                profile.$popGrp = [root._get(0)];
                root.setBlurTrigger(profile.$xid, null);
                root.setBlurTrigger(profile.$xid, f, profile.$popGrp)
            }
            profile[cm] = profile[sms] = profile[hl] = null;
            return this
        },
        hide: function (triggerEvent) {
            var t, profile = this.get(0),
                root = profile.getRoot(),
                sms = "$subPopMenuShowed",
                hl = "$highLight",
                cm = "$childPopMenu";
            if (false !== triggerEvent) {
                if (false === profile.boxing().beforeHide(profile)) {
                    return this
                }
            }
            if (!root || root.css("display") == "none") {
                return
            }
            root.setBlurTrigger(profile.$xid, null);
            if (profile.$hideMenuPool) {
                profile.$hideMenuPool.append(root)
            } else {
                root.css("display", "none")
            }
            if (t = profile[hl]) {
                xui([t]).tagClass("-mouseover", false)
            }
            var p = profile[cm],
                q;
            if (t = profile[sms]) {
                t.hide()
            }
            while (p) {
                p.boxing().hide();
                p = (q = p)[cm];
                q[cm] = q[sms] = q[hl] = null
            }
            profile[cm] = profile[sms] = profile[hl] = null;
            if (t = profile.$parentPopMenu) {
                t[sms] = null
            }
            if (profile.$popGrp) {
                _.arr.removeValue(profile.$popGrp, root._get(0))
            }
            if (false !== triggerEvent) {
                profile.boxing().onHide(profile)
            }
            return this
        },
        _afterInsertItems: function (profile) {
            if (!profile.renderId) {
                return
            }
            profile.boxing().adjustSize()
        },
        _afterRemoveItems: function (profile) {
            if (!profile.renderId) {
                return
            }
            profile.boxing().adjustSize()
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        _.merge(t.FRAME.BORDER, {
            TOP: {},
            BOTTOM: {},
            BOX: {
                tagName: "div",
                ITEMS: {
                    tagName: "div",
                    text: "{items}"
                }
            },
            POOL: {
                tagName: "div",
                style: "display:none;"
            }
        }, "all");
        t.$submap = {
            items: function (profile, template, v, tag, result) {
                var t;
                tag = tag + "." + v.type;
                if (t = v.object) {
                    result[result.length] = t.build(v)
                } else {
                    if (template[tag]) {
                        xui.UI.$doTemplate(profile, template, v, tag, result)
                    }
                }
            },
            "items.split": {
                ITEMSPLIT: {
                    style: "{itemDisplay}"
                }
            },
            "items.button": {
                ITEM: {
                    tabindex: -1,
                    className: "{itemClass} {disabled}",
                    style: "{itemStyle}{itemDisplay}",
                    ICON: {
                        $order: 0,
                        className: "xui-ui-icon {imageClass}",
                        style: "{backgroundImage} {backgroundPosition} {backgroundRepeat}"
                    },
                    CAPTION: {
                        text: "{caption}",
                        $order: 1
                    },
                    RULER: {
                        style: "{displayAdd}",
                        $order: 2
                    },
                    ADD: {
                        tagName: "div",
                        style: "{displayAdd}",
                        text: "{add}",
                        $order: 2
                    },
                    SUB: {
                        style: "{displaySub}"
                    }
                }
            },
            "items.checkbox": {
                ITEM: {
                    tabindex: -1,
                    className: "{itemClass} {disabled}",
                    style: "{itemStyle}{itemDisplay}",
                    CHECKBOX: {
                        $order: 0,
                        className: "xui-ui-icon {checkboxCls}"
                    },
                    CAPTION: {
                        text: "{caption}",
                        $order: 1
                    },
                    RULER: {
                        style: "{displayAdd}",
                        $order: 2
                    },
                    ADD: {
                        tagName: "div",
                        style: "{displayAdd}",
                        text: "{add}",
                        $order: 2
                    }
                }
            },
            "items.radiobox": {
                ITEM: {
                    tabindex: -1,
                    className: "{itemClass} {disabled}",
                    style: "{itemStyle}{itemDisplay}",
                    RADIOBOX: {
                        $order: 0,
                        className: "xui-ui-icon {radioboxCls}"
                    },
                    CAPTION: {
                        text: "{caption}",
                        $order: 1
                    },
                    RULER: {
                        style: "{displayAdd}",
                        $order: 2
                    },
                    ADD: {
                        tagName: "div",
                        style: "{displayAdd}",
                        text: "{add}",
                        $order: 2
                    }
                }
            }
        };
        this.setTemplate(t)
    },
    Static: {
        $noDomRoot: true,
        Appearances: {
            KEY: {
                "font-size": "12px",
                visibility: "hidden"
            },
            BORDER: {
                border: "1px solid",
                "border-color": "#FFF #ACA899 #ACA899 #FFF"
            },
            BOX: {
                "background-color": "#EEF7FF",
                overflow: "hidden",
                position: "absolute",
                left: 0,
                top: 0,
                "font-size": "12px",
                "z-index": "3"
            },
            ITEMS: {
                position: "absolute",
                top: 0,
                left: 0,
                overflow: "hidden",
                background: xui.UI.$bg("bg.gif", "repeat-y left top")
            },
            "ITEMS-inline ITEM": {
                $order: 5,
                display: xui.$inlineBlock
            },
            ITEM: {
                display: "block",
                position: "relative",
                overflow: "visible",
                "white-space": "nowrap",
                color: "#000",
                "font-family": '"Verdana", "Helvetica", "sans-serif"',
                cursor: "pointer",
                padding: "2px 20px 2px 2px"
            },
            ITEMSPLIT: {
                display: "block",
                position: "relative",
                overflow: "visible",
                "white-space": "nowrap",
                "font-size": "1px",
                "line-height": "1px",
                padding: "2px 0",
                margin: "2px 2px 2px 26px",
                background: xui.UI.$bg("split_horizontal.gif", "repeat-x left top", true)
            },
            "ITEM-mouseover": {
                $order: 1,
                "background-color": "#FFFA9F"
            },
            "ITEM-checked": {
                $order: 2,
                "background-color": "#FFFA9F"
            },
            ICON: {
                margin: 0
            },
            TOP: {
                cursor: "pointer",
                display: "none",
                position: "absolute",
                "margin-left": "-8px",
                right: 0,
                height: "16px",
                width: "16px",
                "z-index": "10",
                top: 0,
                background: xui.UI.$bg("icons.gif", "no-repeat -48px -244px", true)
            },
            BOTTOM: {
                cursor: "pointer",
                display: "none",
                position: "absolute",
                "margin-left": "-8px",
                right: 0,
                height: "16px",
                width: "16px",
                "z-index": "10",
                bottom: 0,
                background: xui.UI.$bg("icons.gif", "no-repeat -66px -244px", true)
            },
            "RADIOBOX, CHECKBOX, RADIOBOX-checked, CHECKBOX-checked": {
                cursor: "pointer",
                "vertical-align": "middle",
                width: "16px",
                height: "16px"
            },
            CHECKBOX: {
                background: xui.UI.$bg("icons.gif", "no-repeat -20px -70px", true),
                margin: 0
            },
            "CHECKBOX-checked": {
                $order: 1,
                background: xui.UI.$bg("icons.gif", "no-repeat -0px -70px", true)
            },
            RADIOBOX: {
                background: xui.UI.$bg("icons.gif", "no-repeat -60px -70px", true),
                margin: 0
            },
            "RADIOBOX-checked": {
                $order: 1,
                background: xui.UI.$bg("icons.gif", "no-repeat -40px -70px", true)
            },
            CAPTION: {
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle",
                "padding-left": "6px"
            },
            RULER: {
                width: "100px",
                "font-size": 0,
                "line-height": 0
            },
            ADD: {
                position: "absolute",
                top: "3px",
                right: 0,
                width: "80px",
                "padding-right": "20px",
                "text-align": "right",
                "z-index": "10",
                zoom: xui.browser.ie ? 1 : null
            },
            SUB: {
                position: "absolute",
                top: "2px",
                right: "2px",
                width: "8px",
                height: "16px",
                background: xui.UI.$bg("icons.gif", "no-repeat -200px -70px", true)
            }
        },
        Behaviors: {
            ITEM: {
                onMouseover: function (profile, e, src) {
                    var sms = "$subPopMenuShowed",
                        all = "$allPops",
                        hl = "$highLight",
                        showp = "$showpops",
                        popgrp = "$popGrp";
                    if (profile[hl] == src) {
                        return
                    }
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId = item.id,
                        Cancel = false,
                        pop, popp, t;
                    if (t = profile[sms]) {
                        if (t == _.get(profile, [all, itemId])) {
                            Cancel = true
                        } else {
                            t.hide();
                            profile[sms] = null
                        }
                    }
                    if (!Cancel) {
                        if (t = profile[hl]) {
                            xui([t]).tagClass("-mouseover", false)
                        }
                        profile[hl] = src;
                        xui.use(src).tagClass("-mouseover");
                        try {
                            xui.use(src).get(0).focus()
                        } catch (e) {}
                    }
                    if (!Cancel && item.sub) {
                        if (!(_.isArr(item.sub) && item.sub.length)) {
                            if (profile.onShowSubMenu) {
                                var r = profile["$sub:" + item.id];
                                if (r && r["xui.UI"] && !r.isEmpty()) {} else {
                                    r = profile.boxing().onShowSubMenu(profile, item, src)
                                }
                                if (r && r["xui.UI"] && !r.isEmpty()) {
                                    profile[sms] = r;
                                    r = r.reBoxing();
                                    r.onMouseout(function (p, e, src) {
                                        profile.box._mouseout(profile, e, src)
                                    }, null, -1);
                                    profile[popgrp].push(r._get(0));
                                    r.popToTop(src, 2, profile._conainer);
                                    return
                                } else {
                                    if (r && _.isArr(r) && r.length) {
                                        item.sub = r
                                    }
                                }
                            }
                        }
                        if (_.isArr(item.sub) && item.sub.length) {
                            profile[all] = profile[all] || {};
                            if (!(pop = profile[all][itemId])) {
                                pop = (new xui.UI.PopMenu({
                                    position: "absolute",
                                    items: item.sub,
                                    autoHide: profile.properties.autoHide
                                })).render(true);
                                pop.onShowSubMenu(function (pro, item, src) {
                                    return profile.boxing().onShowSubMenu(profile, item, src)
                                });
                                pop.onMenuSelected(function (pro, item, src) {
                                    return profile.boxing().onMenuSelected(profile, item, src)
                                });
                                popp = pop.get(0);
                                popp.$hideMenuPool = profile.$hideMenuPool || profile.getSubNode("POOL");
                                profile[all][itemId] = pop;
                                profile[showp] = profile[showp] || [profile];
                                popp[showp] = profile[showp];
                                profile[showp].push(popp)
                            } else {
                                popp = pop.get(0)
                            }
                            profile[popgrp].push(popp.getRoot()._get(0));
                            popp[popgrp] = profile[popgrp];
                            popp.$parentPopMenu = profile;
                            profile.$childPopMenu = popp;
                            pop.pop(src, 2);
                            profile[sms] = pop
                        }
                    }
                },
                onMouseout: function (profile, e, src) {
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId = item.id,
                        action = true,
                        hl = "$highLight",
                        t;
                    if (profile[hl] == src) {
                        return
                    }
                    if (t = profile.$subPopMenuShowed) {
                        var node = e.toElement || e.relatedTarget,
                            target = t.get(0).getRootNode();
                        try {
                            do {
                                if (node == target) {
                                    return
                                }
                            } while ((node && (node = node.parentNode)))
                        } catch (a) {}
                    }
                    xui.use(src).tagClass("-mouseover", false);
                    profile[hl] = null
                },
                onClick: function (profile, e, src) {
                    var prop = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId = item.id;
                    if (prop.disabled || item.disabled) {
                        return false
                    }
                    if (!item.group) {
                        if (item.type == "checkbox") {
                            profile.getSubNodeByItemId("CHECKBOX", item.id).tagClass("-checked", item.value = !item.value)
                        } else {
                            if (item.type == "radiobox") {
                                profile.getSubNode("RADIOBOX", true).tagClass("-checked", false);
                                _.arr.each(prop.items, function (o) {
                                    if (o.type == "radiobox") {
                                        o.value = false
                                    }
                                });
                                profile.getSubNodeByItemId("RADIOBOX", item.id).tagClass("-checked", item.value = true)
                            }
                        }
                        if (profile.onMenuSelected) {
                            profile.boxing().onMenuSelected(profile, item, src)
                        }
                        if (prop.hideAfterClick) {
                            xui.use(src).tagClass("-mouseover", false);
                            _.asyRun(function () {
                                var p = profile,
                                    q;
                                if (!p.renderId) {
                                    return
                                }
                                while (p) {
                                    p.boxing().hide();
                                    p = (q = p).$parentPopMenu;
                                    q.$parentPopMenu = q.$subPopMenuShowed = null
                                }
                                profile.$subPopMenuShowed = null;
                                if (profile.$popGrp) {
                                    profile.$popGrp.length = 0
                                }
                            }, 100)
                        }
                    }
                    return false
                },
                onFocus: function (profile, e, src) {
                    var box = profile.getSubNode("BOX"),
                        top = box.scrollTop(),
                        h = box.scrollHeight(),
                        n = xui.use(src).offsetTop();
                    if (n < top || n > top + h) {
                        xui.use(src).offsetTop(top)
                    }
                    xui.use(src).onMouseover()
                },
                onKeydown: function (profile, e, src) {
                    var item = profile.getItemByDom(src),
                        items = profile.properties.items,
                        key = xui.Event.getKey(e).key,
                        itemId = item.id,
                        flag, r, tid, node, t;
                    switch (key) {
                    case "enter":
                        xui(src).onClick();
                        break;
                    case "up":
                        r = true;
                        flag = false;
                        _.arr.each(items, function (o, i) {
                            if (o.type == "split") {
                                return
                            }
                            if (flag) {
                                tid = o.id;
                                return r = false
                            }
                            if (o.id == itemId) {
                                flag = true
                            }
                        }, null, true);
                        if (r) {
                            tid = items[items.length - 1].id
                        }
                        node = profile.getSubNodeByItemId("ITEM", tid).get(0);
                        break;
                    case "down":
                        r = true;
                        flag = false;
                        _.arr.each(items, function (o, i) {
                            if (o.type == "split") {
                                return
                            }
                            if (flag) {
                                tid = o.id;
                                return r = false
                            }
                            if (o.id == itemId) {
                                flag = true
                            }
                        });
                        if (r) {
                            tid = items[0].id
                        }
                        node = profile.getSubNodeByItemId("ITEM", tid).get(0);
                        break;
                    case "left":
                        if (t = profile.$parentPopMenu) {
                            if (t = profile.$parentPopMenu.$highLight) {
                                node = t
                            }
                        }
                        break;
                    case "right":
                        if ((t = profile.$subPopMenuShowed) && t == profile.$allPops[itemId]) {
                            t.activate()
                        }
                        break
                    }
                    if (node && node.tagName) {
                        try {
                            node.focus()
                        } catch (e) {}
                    }
                }
            },
            TOP: {
                onMouseover: function (profile) {
                    profile.$scrollToTop = true;
                    profile.boxing()._scrollToTop()
                },
                onMouseout: function (profile) {
                    profile.$scrollToTop = false;
                    profile.$scrollStep = null
                },
                onClick: function (profile) {
                    profile.$scrollStep *= 2
                }
            },
            BOTTOM: {
                onMouseover: function (profile) {
                    profile.$scrollTobottom = true;
                    profile.boxing()._scrollToBottom()
                },
                onMouseout: function (profile) {
                    profile.$scrollTobottom = false;
                    profile.$scrollStep = null
                },
                onClick: function (profile) {
                    profile.$scrollStep *= 2
                }
            },
            ITEMS: {
                afterKeydown: function (profile, e) {
                    var key = xui.Event.getKey(e).key;
                    if (key == "tab" || key == "enter") {
                        return true
                    } else {
                        if (key == "esc") {
                            do {
                                profile.boxing().hide()
                            } while (profile = profile.$parentPopMenu);
                            return false
                        } else {
                            return false
                        }
                    }
                }
            },
            BORDER: {
                onMouseout: function (profile, e, src) {
                    profile.box._mouseout(profile, e, src)
                }
            }
        },
        DataModel: ({
            dock: null,
            tabindex: null,
            tips: null,
            border: null,
            resizer: null,
            shadow: true,
            _maxHeight: 260,
            _maxWidth: 300,
            left: -10000,
            hideAfterClick: true,
            autoHide: false,
            height: 100,
            width: 300,
            position: "absolute",
            $hborder: 1,
            $vborder: 1
        }),
        EventHandlers: {
            onShowSubMenu: function (profile, item, src) {},
            beforeHide: function (profile) {},
            onHide: function (profile) {},
            onMenuSelected: function (profile, item, src) {}
        },
        RenderTrigger: function () {
            this.boxing().adjustSize()
        },
        _mouseout: function (profile, e) {
            if (profile.properties.autoHide) {
                var p1 = xui.Event.getPos(e),
                    size, p2, b;
                _.arr.each(profile.$popGrp, function (o) {
                    o = xui([o]);
                    p2 = o.offset();
                    size = o.cssSize();
                    if (p1.left > p2.left && p1.top > p2.top && p1.left < p2.left + size.width && p1.top < p2.top + size.height) {
                        return b = 1
                    }
                });
                if (!b) {
                    while (b = profile.$parentPopMenu) {
                        profile = b
                    }
                    profile.boxing().hide();
                    if (profile.$popGrp) {
                        profile.$popGrp.length = 0
                    }
                }
            }
        },
        _prepareItem: function (profile, item) {
            var none = "display:none;";
            item.add = item.add || "";
            item.displayAdd = item.add ? "" : none;
            item.displaySub = item.sub ? "" : none;
            item.itemDisplay = item.hidden ? none : "";
            item.type = item.type || "button";
            if (item.type == "checkbox") {
                item.checkboxCls = profile.getClass("CHECKBOX", item.value ? "-checked" : "")
            } else {
                if (item.type == "radiobox") {
                    item.radioboxCls = profile.getClass("RADIOBOX", item.value ? "-checked" : "")
                }
            }
        },
        _onresize: function (profile, width, height) {
            var size = arguments.callee.upper.apply(this, arguments);
            profile.getSubNode("BOX").cssSize(size)
        }
    }
});
Class("xui.UI.MenuBar", ["xui.UI", "xui.absList"], {
    Instance: {
        updateItem: function (subId, options) {
            var self = this,
                profile = self.get(0),
                items = profile.properties.items;
            if (_.arr.subIndexOf(items, "id", subId) != -1) {
                arguments.callee.upper.call(self, subId, options)
            } else {
                var ok = 0;
                _.each(profile.$allPops, function (o) {
                    o.updateItem(subId, options);
                    ok = 1
                });
                if (!ok) {
                    arguments.callee.upper.call(self, subId, options)
                }
            }
            return self
        },
        _pop: function (item, src) {
            var self = this,
                profile = self.get(0);
            if (profile.$curPop) {
                self.hide()
            }
            if (!item.sub) {
                return
            }
            if (profile.beforePopMenu && false == profile.boxing().beforePopMenu(profile, item, src)) {
                return
            } else {
                xui.use(src).tagClass("-mousedown");
                var menu, id = item.id,
                    pro = profile.properties,
                    all = "$allPops";
                profile.$curPop = id;
                profile.$curElem = src;
                profile.$menuPop = id;
                profile[all] = profile[all] || {};
                if (!profile[all][id]) {
                    var callback = function (sub) {
                            var menu = xui.create("PopMenu", {
                                position: "absolute",
                                items: sub,
                                autoHide: !! pro.autoShowTime
                            });
                            profile.getSubNode("POOL").append(menu);
                            menu.onHide(function (pro) {
                                self.hide(false)
                            }).onMenuSelected(function (pro, item, src) {
                                return profile.boxing().onMenuSelected(profile, pro, item, src)
                            }).onShowSubMenu(function (pro, item, src) {
                                return profile.boxing().onShowSubMenu(profile, pro, item, src)
                            });
                            menu.get(0).$hideMenuPool = profile.getSubNode("POOL");
                            menu.get(0)[all] = profile[all];
                            profile[all][id] = menu
                        };
                    if (_.isArr(item.sub) && item.sub.length) {
                        callback(item.sub)
                    } else {
                        if (profile.onGetPopMenu) {
                            var r = profile.boxing().onGetPopMenu(profile, item, callback);
                            if (_.isArr(r) && r.length) {
                                callback(item.sub = r)
                            }
                        }
                    }
                }
                if (profile[all][id]) {
                    profile[all][id].pop(xui(src), 1, xui(pro.parentID))
                }
                return false
            }
        },
        _afterInsertItems: function () {
            this.clearPopCache()
        },
        hide: function () {
            var profile = this.get(0),
                menu, id = profile.$curPop,
                node = profile.$curElem;
            if (menu = profile.$allPops[id]) {
                if (false !== arguments[0]) {
                    menu.hide(false)
                }
                profile.getSubNode("POOL").append(menu.reBoxing());
                xui([node]).tagClass("-mousedown", false)
            }
            profile.$menuPop = profile.$curPop = profile.$curElem = null
        },
        clearPopCache: function () {
            var profile = this.get(0);
            if (profile.renderId) {
                profile.getSubNode("POOL").empty();
                profile.$allPops = profile.$curPop = profile.$curElem = null
            }
        }
    },
    Initialize: function () {
        xui.SC("xui.UI.PopMenu")
    },
    Static: {
        Templates: {
            tagName: "div",
            className: "{_className}",
            style: "{_style}",
            POOL: {
                tagName: "div"
            },
            BORDER: {
                className: "xui-uibg-bar xui-uiborder-outset",
                tagName: "div",
                LIST: {
                    tagName: "div",
                    HANDLER: {
                        style: "{handler}"
                    },
                    ITEMS: {
                        $order: 1,
                        text: "{items}"
                    }
                }
            },
            $submap: {
                items: {
                    ITEM: {
                        ITEMI: {
                            ITEMC: {
                                ITEMA: {
                                    tabindex: "{_tabindex}",
                                    className: " {typeCls} {disabled}",
                                    ICON: {
                                        $order: 1,
                                        className: "xui-ui-icon {imageClass}",
                                        style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                                    },
                                    CAPTION: {
                                        $order: 2,
                                        text: "{caption}",
                                        style: "{captionDisplay}"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        Appearances: {
            KEY: {
                "font-size": 0,
                "line-height": 0,
                position: "absolute",
                left: 0,
                top: 0
            },
            POOL: {
                width: 0,
                height: 0,
                visibility: "hidden",
                position: "absolute",
                left: "-10000px",
                top: "-10000px"
            },
            BORDER: {
                left: 0,
                top: 0,
                "font-size": 0,
                "line-height": 0
            },
            HANDLER: {
                height: "22px",
                width: "7px",
                background: xui.UI.$bg("handler.gif", " left top", true),
                cursor: "move",
                "vertical-align": "middle"
            },
            LIST: {
                padding: "2px"
            },
            ITEMS: {
                "vertical-align": "middle"
            },
            "LIST-disabled": {
                "background-color": "#E4E4E4"
            },
            "ITEM-mouseover, ITEM-mouseover ITEMI, ITEM-mouseover ITEMC, ITEM-mousedown, ITEM-mousedown ITEMI, ITEM-mousedown ITEMC": {
                background: xui.UI.$bg("button.gif", "no-repeat", true)
            },
            ITEM: {
                height: "22px",
                "white-space": "nowrap",
                "vertical-align": "top",
                overflow: "hidden",
                margin: "0  3px 0 3px",
                "padding-right": "6px",
                "font-size": 0,
                "line-height": 0
            },
            "ITEM *": {
                cursor: "pointer"
            },
            ITEMI: {
                height: "22px",
                "padding-left": "6px",
                "vertical-align": "top"
            },
            ITEMC: {
                height: "22px",
                "padding-top": "3px",
                "vertical-align": "top"
            },
            ITEMA: {
                display: xui.$inlineBlock
            },
            "ITEM-mouseover": {
                $order: 2,
                "background-position": "right -90px"
            },
            "ITEM-mousedown": {
                $order: 3,
                "background-position": "right -180px"
            },
            "ITEM-mouseover ITEMI": {
                $order: 2,
                "background-position": "left -150px"
            },
            "ITEM-mousedown ITEMI": {
                $order: 3,
                "background-position": "left -240px"
            },
            "ITEM-mouseover ITEMC": {
                $order: 2,
                "background-position": "left -120px",
                "background-repeat": "repeat-x"
            },
            "ITEM-mousedown ITEMC": {
                $order: 3,
                "background-position": "left -210px",
                "background-repeat": "repeat-x"
            },
            CAPTION: {
                "font-size": "12px",
                "line-height": "14px",
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle"
            }
        },
        Behaviors: {
            ITEM: {
                onMouseover: function (profile, e, src) {
                    var p = profile.properties,
                        ns = src;
                    if (p.disabled) {
                        return
                    }
                    var item = profile.getItemByDom(src),
                        itemId = item.id;
                    if (item.disabled) {
                        return
                    }
                    xui.use(ns).tagClass("-mouseover");
                    if (profile.$menuPop) {
                        if (profile.$menuPop != itemId) {
                            profile.boxing()._pop(item, ns)
                        }
                    } else {
                        if (p.autoShowTime) {
                            _.resetRun(profile.$xid + ":autoShowTime", function () {
                                profile.boxing()._pop(item, ns)
                            }, p.autoShowTime)
                        }
                    }
                },
                onMouseout: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled) {
                        return
                    }
                    var item = profile.getItemByDom(src);
                    if (item.disabled) {
                        return
                    }
                    xui.use(src).tagClass("-mouseover", false);
                    if (p.autoShowTime) {
                        var pop = profile.$allPops;
                        if (pop = pop && pop[profile.$curPop]) {
                            var node = pop.get(0).getRoot(),
                                p1 = xui.Event.getPos(e),
                                size = node.cssSize(),
                                add = 3,
                                p2 = node.offset();
                            if (p1.left > p2.left && p1.top > p2.top - add && p1.left < p2.left + size.width && p1.top < p2.top + size.height) {} else {
                                pop.hide()
                            }
                        }
                        _.resetRun(profile.$xid + ":autoShowTime", null)
                    }
                },
                onMousedown: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled) {
                        return
                    }
                    var item = profile.getItemByDom(src),
                        itemId = item.id;
                    if (item.disabled) {
                        return
                    }
                    xui.use(src).tagClass("-mousedown");
                    return profile.boxing()._pop(item, src)
                },
                onMouseup: function (profile, e, src) {
                    var item = profile.getItemByDom(src);
                    if (profile.$menuPop != item.id) {
                        xui.use(src).tagClass("-mousedown", false)
                    }
                },
                onKeydown: function (profile, e, src) {
                    var keys = xui.Event.getKey(e),
                        key = keys.key,
                        shift = keys.shiftKey,
                        cur = xui(src),
                        first = profile.getRoot().nextFocus(true, true, false),
                        last = profile.getRoot().nextFocus(false, true, false);
                    switch (xui.Event.getKey(e).key) {
                    case "tab":
                        if (shift) {
                            if (cur.get(0) != first.get(0)) {
                                first.focus();
                                return false
                            }
                        } else {
                            if (cur.get(0) != last.get(0)) {
                                last.focus();
                                return false
                            }
                        }
                        break;
                    case "left":
                    case "up":
                        var next = cur.nextFocus(false, true, false);
                        if (cur.get(0) == first.get(0)) {
                            last.focus()
                        } else {
                            cur.nextFocus(false)
                        }
                        return false;
                        break;
                    case "right":
                    case "down":
                        var next = cur.nextFocus(true, false, false);
                        if (cur.get(0) == last.get(0)) {
                            first.focus()
                        } else {
                            cur.nextFocus()
                        }
                        return false;
                        break;
                    case "enter":
                        cur.onMousedown();
                        break
                    }
                },
                onClick: function (profile, e, src) {
                    var item = profile.getItemByDom(src);
                    if (profile.$menuPop != item.id) {
                        if (profile.onMenuBtnClick) {
                            profile.boxing().onMenuBtnClick(profile, item, src)
                        }
                    }
                }
            }
        },
        DataModel: {
            listKey: null,
            height: {
                ini: "auto",
                readonly: true
            },
            width: "auto",
            parentID: "",
            $hborder: 1,
            $vborder: 1,
            left: 0,
            top: 0,
            autoShowTime: 200,
            handler: {
                ini: true,
                action: function (v) {
                    this.getSubNode("HANDLER").css("display", v ? "" : "none")
                }
            },
            position: "absolute",
            dock: {
                ini: "top",
                listbox: ["top", "bottom"]
            }
        },
        EventHandlers: {
            onGetPopMenu: function (profile, item, callback) {},
            onMenuBtnClick: function (profile, item, src) {},
            beforePopMenu: function (profile, item, src) {},
            onShowSubMenu: function (profile, popProfile, item, src) {},
            onMenuSelected: function (profile, popProfile, item, src) {}
        },
        RenderTrigger: function () {
            if (this.properties.disabled) {
                this.boxing().setDisabled(true, true)
            }
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile);
            data.handler = data.handler ? "" : "display:none";
            return data
        }
    }
});
Class("xui.UI.ToolBar", ["xui.UI", "xui.absList"], {
    Instance: {
        updateItem: function (subId, options) {
            if (options.type) {
                return arguments.callee.upper.call(this, subId, options)
            } else {
                var self = this,
                    profile = self.get(0),
                    box = profile.box,
                    items = profile.properties.items,
                    rst = profile.queryItems(items, function (o) {
                        return typeof o == "object" ? o.id === subId : o == subId
                    }, true, true, true),
                    nid, item, n1, n2, n3, n4, t;
                if (_.isStr(options)) {
                    options = {
                        caption: options
                    }
                }
                if (rst.length) {
                    rst = rst[0];
                    if (item = rst[0]) {
                        if (_.isSet(options.id)) {
                            options.id += ""
                        }
                        if (options.id && subId !== options.id) {
                            nid = options.id;
                            var m2 = profile.ItemIdMapSubSerialId,
                                v;
                            if (!m2[nid]) {
                                if (v = m2[subId]) {
                                    m2[nid] = v;
                                    delete m2[subId];
                                    profile.SubSerialIdMapItem[v].id = nid
                                } else {
                                    item.id = nid
                                }
                            }
                        }
                        delete options.id;
                        if (_.isEmpty(options)) {
                            return self
                        }
                        n1 = profile.getSubNodeByItemId("ICON", nid || subId);
                        n2 = profile.getSubNodeByItemId("CAPTION", nid || subId);
                        n3 = profile.getSubNodeByItemId("ITEM", nid || subId);
                        n4 = profile.getSubNodeByItemId("LABEL", nid || subId);
                        if ("value" in options && options.value != item.value) {
                            profile.getSubNodeByItemId("BTN", nid || subId).tagClass("-checked", !! options.value)
                        }
                        if ("caption" in options && options.caption != item.caption) {
                            n2.html(options.caption);
                            if (options.caption && !item.caption) {
                                n2.css("display", "")
                            }
                            if (!options.caption && item.caption) {
                                n2.css("display", "none")
                            }
                        }
                        if ("label" in options && options.label != item.label) {
                            n4.html(options.label);
                            if (options.label && !item.label) {
                                n4.css("display", "")
                            }
                            if (!options.label && item.label) {
                                n4.css("display", "none")
                            }
                        }
                        if ("disabled" in options && options.disabled != item.disabled) {
                            if (options.disabled) {
                                n2.addClass("xui-ui-itemdisabled")
                            } else {
                                n2.removeClass("xui-ui-itemdisabled")
                            }
                        }
                        if ("image" in options && options.image != item.image) {
                            n1.css("background-image", options.image)
                        }
                        if ("imagePos" in options && options.imagePos != item.imagePos) {
                            n1.css("background-position", options.imagePos)
                        }
                        if ("imageClass" in options && options.imageClass != item.imageClass) {
                            if (item.imageClass) {
                                n1.removeClass(item.imageClass)
                            }
                            if (options.imageClass) {
                                n1.addClass(options.imageClass)
                            }
                        }
                        if ("hidden" in options) {
                            var b = !! options.hidden;
                            if (b) {
                                if (item.hidden !== true) {
                                    n3.css("display", "none")
                                }
                            } else {
                                if (item.hidden === true) {
                                    n3.css("display", "")
                                }
                            }
                        }
                        _.merge(item, options, "all")
                    }
                }
                return self
            }
        },
        showItem: function (itemId, value) {
            return this.each(function (profile) {
                var item = profile.getItemByItemId(itemId);
                if (item) {
                    item.hidden = value === false;
                    profile.getSubNodeByItemId("ITEM", itemId).css("display", value === false ? "none" : "")
                }
            })
        },
        showGroup: function (grpId, value) {
            return this.each(function (profile) {
                _.arr.each(profile.properties.items, function (o) {
                    if (o.id == grpId) {
                        o.hidden = value === false;
                        return false
                    }
                });
                var n = profile.getSubNodeByItemId("GROUP", grpId);
                n.css("display", value === false ? "none" : "");
                if (profile.renderId && profile.getRootNode().offsetWidth) {
                    xui.UI.$dock(profile, true, true)
                }
            })
        }
    },
    Static: {
        _focusNodeKey: "BTN",
        _ITEMKEY: "GROUP",
        Templates: {
            tagName: "div",
            className: "{_className}",
            style: "{_style}",
            ITEMS: {
                className: "xui-uibg-bar xui-uiborder-outset",
                tagName: "div",
                style: "{mode}",
                text: "{items}"
            },
            $submap: {
                items: {
                    GROUP: {
                        className: "{groupClass}",
                        style: "{grpDisplay} {groupStyle}",
                        HANDLER: {
                            style: "{mode2}"
                        },
                        LIST: {
                            $order: 1,
                            tagName: "text",
                            text: "{sub}"
                        }
                    }
                },
                "items.sub": {
                    ITEM: {
                        style: "{itemDisplay}",
                        IBWRAP: {
                            tagName: "div",
                            SPLIT: {
                                style: "{splitDisplay}"
                            },
                            LABEL: {
                                className: " {disabled}",
                                style: "{labelDisplay}",
                                text: "{label}"
                            },
                            BTN: {
                                className: "xui-ui-btn {itemcls} {itemClass}",
                                style: "{itemStyle} {boxDisplay}",
                                BTNI: {
                                    className: "xui-ui-btni",
                                    BTNC: {
                                        className: "xui-ui-btnc",
                                        BOX: {
                                            tabindex: "{_tabindex}",
                                            BOXWRAP: {
                                                tagName: "div",
                                                RULER: {},
                                                ICON: {
                                                    $order: 1,
                                                    className: "xui-ui-icon {imageClass}",
                                                    style: "{backgroundImage} {backgroundPosition} {backgroundRepeat}  {imageDisplay}"
                                                },
                                                CAPTION: {
                                                    $order: 2,
                                                    text: "{caption}",
                                                    className: " {disabled}",
                                                    style: "{captionDisplay}"
                                                },
                                                DROP: {
                                                    $order: 3,
                                                    style: "{dropDisplay}"
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        Appearances: {
            KEY: {
                "font-size": 0,
                "line-height": 0,
                position: "absolute",
                overflow: "hidden",
                left: 0,
                top: 0
            },
            "ITEM-object": {
                "vertical-align": "middle",
                "margin-left": "4px"
            },
            RULER: {
                padding: "0px",
                margin: "0px",
                width: "0px"
            },
            ICON: {
                margin: 0,
                "vertical-align": "middle"
            },
            ITEMS: {
                display: "block",
                "padding-bottom": "1px",
                "font-size": 0,
                "line-height": 0
            },
            HANDLER: {
                height: "22px",
                width: "7px",
                background: xui.UI.$bg("handler.gif", " left top", true),
                cursor: "move",
                "vertical-align": "middle"
            },
            GROUP: {
                "font-size": 0,
                "line-height": 0,
                position: "static",
                padding: "2px 4px 0px 2px",
                "vertical-align": "middle"
            },
            ITEM: {
                "vertical-align": "middle",
                padding: "1px"
            },
            "BTNC a": {
                padding: 0
            },
            SPLIT: {
                $order: 1,
                width: "6px",
                height: "15px",
                "vertical-align": "middle",
                background: xui.UI.$bg("split_vertical.gif", "repeat-y left top", true)
            },
            BTN: {
                "padding-right": "3px"
            },
            BTNI: {
                "padding-left": "3px"
            },
            DROP: {
                width: "14px",
                height: "16px",
                "vertical-align": "middle",
                background: xui.UI.$bg("drop.gif", "no-repeat left center", "Button")
            },
            "BTN-mouseover DROP": {
                $order: 2,
                "background-position": "-16px center"
            },
            "BTN-mousedown DROP, BTN-checked DROP": {
                $order: 2,
                "background-position": "-32px center"
            },
            BOX: {
                height: "22px"
            },
            "LABEL, CAPTION": {
                "vertical-align": "middle",
                "margin-left": "2px",
                "margin-right": "2px",
                cursor: "default",
                "font-size": "12px"
            },
            LABEL: {
                "padding-top": "3px"
            }
        },
        Behaviors: {
            HoverEffected: {
                BTN: ["BTN"]
            },
            ClickEffected: {
                BTN: ["BTN"]
            },
            BTN: {
                onClick: function (profile, e, src) {
                    if (profile.properties.disabled) {
                        return
                    }
                    var id2 = xui.use(src).parent(3).id(),
                        item2 = profile.getItemByDom(id2);
                    if (item2.disabled) {
                        return
                    }
                    var item = profile.getItemByDom(src);
                    if (item.disabled) {
                        return
                    }
                    xui.use(src).focus();
                    if (item.statusButton) {
                        xui.use(src).tagClass("-checked", item.value = !item.value)
                    }
                    profile.boxing().onClick(profile, item, item2, e, src);
                    return false
                }
            }
        },
        DataModel: {
            listKey: null,
            height: {
                ini: "auto",
                readonly: true
            },
            width: "auto",
            left: 0,
            top: 0,
            handler: {
                ini: true,
                action: function (v) {
                    this.getSubNode("HANDLER", true).css("display", v ? "" : "none")
                }
            },
            position: "absolute",
            hAlign: {
                ini: "left",
                listbox: ["left", "center", "right"],
                action: function (v) {
                    this.getSubNode("ITEMS", true).css("textAlign", v)
                }
            },
            dock: {
                ini: "top",
                listbox: ["top", "bottom"]
            }
        },
        EventHandlers: {
            onClick: function (profile, item, group, e, src) {}
        },
        _adjustItems: function (arr) {
            if (!arr) {
                arr = [_() + ""]
            }
            if (_.isStr(arr)) {
                arr = [arr]
            }
            var a = _.copy(arr),
                m;
            _.arr.each(a, function (o, i) {
                if (_.isArr(o)) {
                    o = {
                        id: _.id(),
                        sub: o
                    }
                }
                if (_.isHash(o)) {
                    a[i] = _.copy(o);
                    a[i].sub = [];
                    if (o.sub) {
                        _.arr.each(o.sub, function (v) {
                            a[i].sub.push(_.isHash(v) ? _.copy(v) : {
                                id: v + ""
                            })
                        })
                    }
                }
            });
            return a
        },
        _prepareData: function (profile) {
            var d = arguments.callee.upper.call(this, profile);
            var p = profile.properties;
            d.mode = p.hAlign == "right" ? "text-align:right;" : "";
            return d
        },
        _prepareItem: function (profile, oitem, sitem, pid, index, len, mapCache, serialId) {
            var dn = "display:none",
                tabindex = profile.properties.tabindex,
                fun = function (profile, dataItem, item, pid, index, len, mapCache, serialId) {
                    var id = dataItem[xui.UI.$tag_subId] = typeof serialId == "string" ? serialId : ("a_" + profile.pickSubId("aitem")),
                        t;
                    if (typeof item == "string") {
                        item = {
                            caption: item
                        }
                    }
                    if (false !== mapCache) {
                        profile.ItemIdMapSubSerialId[item.id] = id;
                        profile.SubSerialIdMapItem[id] = item
                    }
                    if (t = item.object) {
                        t = dataItem.object = t["xui.absBox"] ? t.get(0) : t;
                        if (t["xui.UIProfile"]) {
                            t.properties.position = "relative";
                            var addcls = profile.getClass("ITEM", "-object"),
                                cck = t.CC.KEY || (cck = t.CC.KEY = "");
                            if (cck.indexOf(addcls) === -1) {
                                t.CC.KEY = cck + " " + addcls
                            }
                        }
                        item.$xid = t.$xid;
                        t.$item = item;
                        t.$holder = profile;
                        if (!t.host || t.host === t) {
                            t.boxing().setHost(profile.host, t.alias)
                        }
                        if (!profile.$attached) {
                            profile.$attached = []
                        }
                        profile.$attached.push(t)
                    } else {
                        switch (item.type) {
                        case "split":
                            item.split = true;
                            break;
                        case "statusButton":
                            item.statusButton = true;
                            break;
                        case "dropButton":
                            item.dropButton = true;
                            break
                        }
                        if (item.split) {
                            item.split = true
                        } else {
                            if (!item.caption) {
                                item.caption = ""
                            }
                        }
                        xui.UI.adjustData(profile, item, dataItem);
                        if (item.statusButton && !! item.value) {
                            dataItem.itemcls = " xui-ui-btn-checked " + profile.getClass("BTN", "-checked", !! item.value)
                        }
                        dataItem._tabindex = tabindex;
                        dataItem.splitDisplay = dataItem.split ? "" : dn;
                        dataItem.labelDisplay = dataItem.label ? "" : dn;
                        dataItem.captionDisplay = dataItem.caption ? "" : dn;
                        dataItem.dropDisplay = item.dropButton ? "" : dn;
                        dataItem.boxDisplay = (!dataItem.split && (dataItem.caption || dataItem.image || dataItem.imageClass)) ? "" : dn
                    }
                    dataItem.itemDisplay = item.hidden ? dn : "";
                    item._pid = pid
                };
            if (pid) {
                fun(profile, oitem, sitem, pid, index, len, mapCache, serialId)
            } else {
                var arr = [],
                    dataItem, a = sitem.sub || [];
                pid = sitem.id;
                oitem.mode2 = ("handler" in sitem) ? (sitem.handler ? "" : dn) : (profile.properties.handler ? "" : dn);
                oitem.grpDisplay = sitem.hidden ? dn : "";
                oitem.sub = arr;
                _.arr.each(a, function (item) {
                    dataItem = {
                        id: item.id
                    };
                    fun(profile, dataItem, item, pid, index, len, mapCache, serialId);
                    arr.push(dataItem)
                })
            }
        }
    }
});
Class("xui.UI.Range", ["xui.UI", "xui.absValue"], {
    Instance: {
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                var p = profile.properties,
                    tpl = p.captionTpl,
                    fun = function (k) {
                        return profile.getSubNode(k)
                    },
                    fun1 = function (a, i) {
                        a.cssPos({
                            left: profile[i],
                            top: box._x2y(profile[i])
                        })
                    },
                    fun2 = function (o, v) {
                        o.get(0).style.width = v + "px"
                    },
                    title = fun("CAPTION"),
                    a = fun("IND1"),
                    b = fun("IND2"),
                    r1 = fun("RULER1"),
                    r3 = fun("RULER3"),
                    box = profile.box,
                    arr = box._v2a(value);
                profile._rate = 300 / (p.max - p.min);
                profile._v1 = Math.round((arr[0] - p.min) / (p.max - p.min) * 300);
                profile._v2 = Math.round((1 - (p.max - arr[1]) / (p.max - p.min)) * 300);
                title.html(box._buildTpl(p.singleValue, tpl, arr, p.unit), false);
                fun1(a, "_v1");
                fun1(b, "_v2");
                fun2(r1, profile._v1 + 8);
                fun2(r3, profile._v2 + 8)
            })
        },
        _setDirtyMark: function () {
            return arguments.callee.upper.apply(this, ["BOX"])
        }
    },
    Static: {
        Templates: {
            style: "{_style}",
            className: "{_className}",
            BOX: {
                tagName: "div",
                RULER: {
                    tagName: "div",
                    IND1: {
                        tabindex: "{tabindex}",
                        style: "{_single}"
                    },
                    IND2: {
                        tabindex: "{tabindex}"
                    },
                    RULER1: {
                        $order: 2,
                        style: "{_single}"
                    },
                    RULER3: {}
                },
                TAIL: {
                    tagName: "div",
                    CAPTION: {
                        tagName: "div"
                    },
                    MIN: {
                        text: "{min}"
                    },
                    MAX: {
                        text: "{max}"
                    }
                }
            }
        },
        Appearances: {
            "KEY, RULER, IND1, IND1": {
                "font-size": 0,
                "line-height": 0,
                position: "relative"
            },
            BOX: {
                position: "absolute",
                left: 0,
                top: 0,
                width: "316px"
            },
            "CAPTION, IND1, TAIL, MIN": {
                "font-size": "12px",
                "line-height": "14px"
            },
            RULER: {
                $order: 1,
                position: "relative",
                height: "30px",
                overflow: "visible",
                "margin-bottom": "3px",
                background: xui.UI.$bg("bg.png"),
                _background: "none",
                _filter: xui.UI.$ieBg("bg.png")
            },
            "RULER1, RULER3": {
                position: "absolute",
                left: 0,
                top: 0,
                height: "30px",
                width: "300px"
            },
            RULER1: {
                background: xui.UI.$bg("bg.png"),
                _background: "none",
                _filter: xui.UI.$ieBg("bg.png")
            },
            RULER3: {
                background: xui.UI.$bg("front.png"),
                _background: "none",
                _filter: xui.UI.$ieBg("front.png")
            },
            "IND1,IND2": {
                display: xui.$inlineBlock,
                zoom: xui.browser.ie6 ? 1 : null,
                "z-index": "2",
                width: "15px",
                height: "14px",
                position: "absolute"
            },
            IND1: {
                background: xui.UI.$bg("icons.gif", "no-repeat left -225px", true),
                left: "0px",
                top: "11px"
            },
            IND2: {
                background: xui.UI.$bg("icons.gif", "no-repeat -15px -225px", true),
                left: "300px",
                top: "1px"
            },
            TAIL: {
                $order: 2,
                width: "300px",
                position: "relative"
            },
            CAPTION: {
                position: "relative",
                "text-align": "center"
            },
            MIN: {
                position: "absolute",
                left: 0,
                top: 0
            },
            MAX: {
                position: "absolute",
                right: 0,
                top: 0
            }
        },
        Behaviors: {
            IND1: {
                onKeydown: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    profile.box._keydown.apply(profile.box, [profile, e, src, 0])
                },
                onMousedown: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var p = profile.properties,
                        box = profile.box,
                        arr = box._v2a(p.$UIvalue);
                    xui.use(src).startDrag(e, {
                        widthIncrement: p.steps ? p.width / p.steps : null,
                        dragType: "move",
                        targetReposition: true,
                        horizontalOnly: true,
                        maxLeftOffset: Math.floor(profile._v1),
                        maxRightOffset: Math.floor(profile._v2 - profile._v1),
                        dragCursor: "default"
                    });
                    xui.use(src).css("zIndex", 10).focus();
                    profile.getSubNode("IND2").css("zIndex", 5)
                },
                onDrag: function (profile, e, src) {
                    var d = xui.DragDrop.getProfile();
                    profile.box._ondrag.apply(profile.box, [profile, d.curPos.left, src, 0])
                },
                onDragstop: function (profile, e, src) {
                    var p = profile.properties,
                        box = profile.boxing(),
                        rate = profile._rate,
                        d = xui.DragDrop.getProfile(),
                        f, arr = p.$UIvalue.split(":");
                    profile._v1 = d.curPos.left;
                    arr[0] = Math.floor((profile._v1) / rate + p.min);
                    box.setUIValue(arr.join(":"));
                    if (profile._v1 == profile._v2) {
                        xui.use(src).css("zIndex", 10);
                        profile.getSubNode("IND2").css("zIndex", 5)
                    }
                }
            },
            IND2: {
                onKeydown: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    profile.box._keydown.apply(profile.box, [profile, e, src, 1])
                },
                onMousedown: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var p = profile.properties,
                        box = profile.box,
                        arr = box._v2a(p.$UIvalue);
                    xui.use(src).startDrag(e, {
                        widthIncrement: p.steps ? p.width / p.steps : null,
                        dragType: "move",
                        targetReposition: true,
                        horizontalOnly: true,
                        maxLeftOffset: Math.floor(profile._v2 - profile._v1),
                        maxRightOffset: Math.floor(300 - profile._v2),
                        dragCursor: "default"
                    });
                    xui.use(src).css("zIndex", 10).focus();
                    profile.getSubNode("IND1").css("zIndex", 5)
                },
                onDrag: function (profile, e, src) {
                    var d = xui.DragDrop.getProfile();
                    profile.box._ondrag.apply(profile.box, [profile, d.curPos.left, src, 1])
                },
                onDragstop: function (profile, e, src) {
                    var p = profile.properties,
                        box = profile.boxing(),
                        rate = profile._rate,
                        d = xui.DragDrop.getProfile(),
                        f, arr = p.$UIvalue.split(":");
                    profile._v2 = d.curPos.left;
                    arr[1] = Math.floor((profile._v2) / rate + p.min);
                    box.setUIValue(arr.join(":"))
                }
            }
        },
        DataModel: {
            position: "absolute",
            width: {
                ini: 300,
                readonly: true
            },
            height: {
                ini: 46,
                readonly: true
            },
            min: {
                ini: 0,
                action: function () {
                    var self = this,
                        t, pro = self.properties,
                        b = self.boxing();
                    b.refresh();
                    if (pro.$UIvalue != (t = this.box._ensureValue(self, pro.$UIvalue))) {
                        b.setValue(t)
                    }
                }
            },
            max: {
                ini: 100,
                action: function () {
                    var self = this,
                        t, pro = self.properties,
                        b = self.boxing();
                    b.refresh();
                    if (pro.$UIvalue != (t = this.box._ensureValue(self, pro.$UIvalue))) {
                        b.setValue(t)
                    }
                }
            },
            unit: {
                ini: "",
                action: function () {
                    this.boxing()._setCtrlValue(this.properties.$UIvalue)
                }
            },
            steps: 0,
            captionTpl: {
                ini: "{fromvalue}{unit} - {tovalue}{unit}",
                action: function () {
                    this.boxing()._setCtrlValue(this.properties.$UIvalue)
                }
            },
            value: "0:100",
            singleValue: {
                ini: false,
                action: function (v) {
                    this.boxing().refresh()
                }
            }
        },
        _prepareData: function (profile) {
            var d = arguments.callee.upper.call(this, profile);
            var p = profile.properties,
                arr = profile.box._v2a(p.value);
            d._single = p.singleValue ? "display:none" : "";
            p.min = parseFloat(p.min);
            p.max = parseFloat(p.max);
            d.min = d.min + p.unit;
            d.max = d.max + p.unit;
            return d
        },
        _ensureValue: function (profile, value) {
            if (!value) {
                value = ""
            }
            var p = profile.properties,
                a = value.split(":"),
                min = p.min,
                max = p.max,
                b = [],
                f1 = function (a) {
                    return parseFloat(a)
                },
                f2 = function (a) {
                    return Math.min(max, Math.max(min, a))
                };
            b[0] = f1(a[0]);
            b[1] = f1(a[1]);
            b[0] = Math.min(b[0], b[1]);
            if (!min) {
                min = b[0]
            }
            if (!max) {
                max = b[1]
            }
            b[0] = f2(b[0]);
            b[1] = f2(b[1]);
            return b.join(":")
        },
        _v2a: function (value) {
            return typeof value == "string" ? value.split(":") : value
        },
        _buildTpl: function (single, tpl, arr, unit) {
            return single ? arr[1] + unit : tpl.replace(/\{fromvalue\}/g, arr[0]).replace(/\{tovalue\}/g, arr[1]).replace(/\{unit\}/g, unit)
        },
        _x2y: function (x) {
            return Math.floor(15 + 1 - (x) * (15 / 300))
        },
        _keydown: function (profile, e, src, type) {
            var key = xui.Event.getKey(e);
            if (key.key == "left" || key.key == "right") {
                var s = xui.use(src).get(0).style,
                    left = parseInt(s.left, 10),
                    pro = profile.properties,
                    steps = pro.steps,
                    span = 300 / steps,
                    v, f = function (key) {
                        return parseInt(profile.getSubNode(key).get(0).style.left, 10)
                    };
                left += key.key == "left" ? -1 : 1;
                if (steps) {
                    left = left - left % span;
                    if (key.key == "right") {
                        left += span
                    }
                }
                if (!pro.singleValue) {
                    if (type === 0) {
                        v = f("IND2");
                        if (left > v) {
                            left = v
                        }
                    } else {
                        v = f("IND1");
                        if (left < v) {
                            left = v
                        }
                    }
                }
                if (left < 0) {
                    left = 0
                }
                if (left > 300) {
                    left = 300
                }
                s.left = left + "px";
                profile.box._ondrag.apply(profile.box, [profile, left, src, type]);
                var rate = profile._rate,
                    arr = pro.$UIvalue.split(":");
                if (type === 0) {
                    profile._v1 = left;
                    arr[0] = Math.floor((profile._v1) / rate + pro.min)
                } else {
                    profile._v2 = left;
                    arr[1] = Math.floor((profile._v2) / rate + pro.min)
                }
                profile.boxing().setUIValue(arr.join(":"))
            }
        },
        _ondrag: function (profile, left, src, tag) {
            var p = profile.properties,
                d = xui.DragDrop.getProfile(),
                box = profile.box,
                fun = function (k) {
                    return profile.getSubNode(k)
                },
                fun2 = function (o, v) {
                    o.get(0).style.width = v + "px"
                },
                cap = fun("CAPTION"),
                r1 = fun("RULER1"),
                r3 = fun("RULER3"),
                t, f, arr = this._v2a(p.$UIvalue);
            xui.use(src).get(0).style.top = this._x2y(left) + "px";
            t = Math.floor((left) / profile._rate + p.min);
            if (tag) {
                arr[1] = t;
                fun2(r3, left + 8)
            } else {
                arr[0] = t;
                fun2(r1, left + 8)
            }
            cap.html(box._buildTpl(p.singleValue, p.captionTpl, arr, p.unit), false)
        },
        _onresize: function () {}
    }
});
Class("xui.UI.Layout", ["xui.UI", "xui.absList"], {
    Instance: {
        getPanel: function (subId) {
            return this.get(0).getSubNodeByItemId("PANEL", subId)
        },
        append: function (target, subId) {
            var pro = this.get(0);
            return arguments.callee.upper.call(this, target, subId || "main")
        },
        insertItems: function (arr, base, before) {
            return this._insertItems(arr, base, before)
        },
        _insertItems: function (arr, base, before, all) {
            var node, arr2, items, index, r, data, box, pos = "before",
                b = this._afterInsertItems;
            return this.each(function (profile) {
                box = profile.box;
                items = profile.properties.items;
                if (!all) {
                    index = _.arr.subIndexOf(items, "id", base);
                    if (index == -1) {
                        pos = before ? "before" : "after"
                    } else {
                        if (items[index].id == "main") {
                            pos = before ? "before" : "after"
                        } else {
                            pos = items[index].pos
                        }
                    }
                    arr2 = box._adjustItems2(arr, pos)
                } else {
                    arr2 = arr
                }
                if (index == -1) {
                    _.arr.insertAny(items, arr2, before ? 0 : -1)
                } else {
                    _.arr.insertAny(items, arr2, before ? index : index + 1)
                }
                if (profile.renderId) {
                    data = box._prepareItems(profile, arr2, base);
                    r = profile._buildItems("items", data);
                    profile.getRoot().prepend(r);
                    var t = profile.getRootNode().style;
                    xui.UI.$tryResize(profile, t.width, t.height, true);
                    t = null
                }
                if (b) {
                    profile.boxing()._afterInsertItems(profile, data, base, before)
                }
            })
        },
        _afterRemoveItems: function (profile) {
            if (profile.renderId) {
                var t = profile.getRootNode().style;
                xui.UI.$tryResize(profile, t.width, t.height, true);
                t = null
            }
        },
        updateItem: function (subId, options) {
            var self = this,
                profile = self.get(0),
                vertical = profile.properties.type == "vertical",
                box = profile.box,
                items = profile.properties.items,
                rst = profile.queryItems(items, function (o) {
                    return typeof o == "object" ? o.id === subId : o == subId
                }, true, true, true),
                nid, item, serialId, node, sub, t;
            if (typeof options != "object") {
                return
            }
            if (rst.length) {
                rst = rst[0];
                if (typeof rst[0] != "object") {
                    item = rst[2][rst[1]] = {
                        id: rst[0]
                    }
                } else {
                    item = rst[0]
                }
                if (_.isSet(options.id)) {
                    options.id += ""
                }
                if (options.id && subId !== options.id) {
                    nid = options.id;
                    var m2 = profile.ItemIdMapSubSerialId,
                        v;
                    if (!m2[nid]) {
                        if (v = m2[subId]) {
                            m2[nid] = v;
                            delete m2[subId];
                            profile.SubSerialIdMapItem[v].id = nid
                        } else {
                            item.id = nid
                        }
                    }
                }
                delete options.id;
                if (_.isEmpty(options)) {
                    return self
                }
                var bResize = false;
                node = profile.getSubNodeByItemId("ITEM", subId);
                if (!node.isEmpty()) {
                    if (options.hasOwnProperty("size")) {
                        options.size = parseInt("" + options.size, 10);
                        if (options.size != item.size) {
                            item.size = options.size;
                            if (vertical) {
                                node.height(options.size)
                            } else {
                                node.width(options.size)
                            }
                            bResize = true
                        }
                    }
                    if (options.hasOwnProperty("hidden")) {
                        options.hidden = !! options.hidden;
                        if (options.hidden !== item.hidden) {
                            profile.getSubNodeByItemId("ITEM", subId).css("display", options.hidden ? "none" : "");
                            bResize = true
                        }
                    }
                    if (options.hasOwnProperty("locked")) {
                        options.locked = !! options.locked;
                        if (options.locked !== item.locked) {
                            profile.getSubNodeByItemId("MOVE", subId).css("display", options.locked ? "none" : "");
                            bResize = true
                        }
                    }
                    if (options.hasOwnProperty("folded")) {
                        options.folded = !! options.folded;
                        if (options.folded !== item.folded) {
                            profile.boxing().fireCmdClickEvent(subId)
                        }
                    }
                    if (options.hasOwnProperty("cmd")) {
                        options.cmd = !! options.cmd;
                        if (options.cmd !== item.cmd) {
                            profile.getSubNodeByItemId("CMD", subId).css("display", options.cmd ? "" : "none")
                        }
                    }
                }
                _.merge(item, options, "all");
                if (bResize) {
                    var t = profile.getRootNode().style;
                    xui.UI.$tryResize(profile, t.width, t.height, true);
                    t = null
                }
            }
            return self
        },
        fireCmdClickEvent: function (subId) {
            this.getSubNodeByItemId("CMD", subId).onMousedown();
            return this
        }
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            text: "{items}",
            $submap: {
                items: {
                    ITEM: {
                        tagName: "div",
                        className: "{cls1} {itemClass}",
                        style: "{size};{itemStyle};{display}",
                        MOVE: {
                            $order: 0,
                            tagName: "div",
                            className: "xui-uibg-bar {cls2} ",
                            style: "{moveDisplay}"
                        },
                        CMD: {
                            $order: 1,
                            tagName: "div",
                            style: "{cmdDisplay}",
                            className: "{cls3} "
                        },
                        PANEL: {
                            tagName: "div",
                            className: "xui-uibg-base",
                            style: "position:absolute;left:0;top:0;{_overflow};",
                            text: xui.UI.$childTag
                        }
                    }
                }
            }
        },
        Appearances: {
            ".setting-xui-layout": {
                width: "9px"
            },
            KEY: {
                position: "absolute",
                overflow: "hidden",
                left: 0,
                top: 0,
                "font-size": xui.browser.ie ? 0 : null,
                "line-height": xui.browser.ie ? 0 : null
            },
            MOVE: {
                $order: 0,
                position: "absolute",
                "z-index": "10",
                "font-size": xui.browser.ie ? 0 : null,
                "line-height": xui.browser.ie ? 0 : null
            },
            "MOVE-mouseover": {
                $order: 1,
                "background-color": "#C8E1FA"
            },
            CMD: {
                position: "absolute",
                cursor: "pointer",
                "z-index": "20",
                "font-size": xui.browser.ie ? 0 : null,
                "line-height": xui.browser.ie ? 0 : null
            },
            ITEM: {
                position: "absolute",
                "z-index": 1,
                overflow: "hidden",
                "border-width": xui.browser.opr ? "0px" : null,
                "font-size": xui.browser.ie ? 0 : null,
                "line-height": xui.browser.ie ? 0 : null
            },
            PANEL: {
                position: "absolute",
                overflow: "hidden",
                "border-width": xui.browser.opr ? "0px" : null,
                "font-size": xui.browser.ie ? 0 : null,
                "line-height": xui.browser.ie ? 0 : null
            },
            "ITEM-MAIN": {
                left: 0,
                right: 0,
                top: 0,
                bottom: 0
            },
            "ITEM-TOP, ITEM-BOTTOM": {
                left: 0,
                right: 0
            },
            "ITEM-LEFT, ITEM-RIGHT": {
                top: 0,
                bottom: 0
            },
            "MOVE-TOP, MOVE-BOTTOM": {
                width: "100%",
                height: "7px",
                cursor: "n-resize",
                "border-top": "solid 1px #c8e1fa",
                "border-bottom": "solid 1px #648cb4"
            },
            "MOVE-LEFT, MOVE-RIGHT": {
                height: "100%",
                width: "7px",
                cursor: "w-resize",
                "border-left": "solid 1px #c8e1fa",
                "border-right": "solid 1px #648cb4"
            },
            "MOVE-TOP": {
                bottom: 0
            },
            "MOVE-BOTTOM": {
                top: 0
            },
            "MOVE-LEFT": {
                right: "0px"
            },
            "MOVE-RIGHT": {
                left: 0
            },
            "CMD-TOP, CMD-BOTTOM, CMD-LEFT, CMD-RIGHT": {
                background: xui.UI.$bg("icons.gif", "no-repeat", true)
            },
            "CMD-TOP": {
                $order: 1,
                left: "50%",
                "margin-left": "-20px",
                bottom: 0,
                width: "40px",
                height: "9px",
                "background-position": "-360px -232px"
            },
            "CMD-BOTTOM": {
                $order: 1,
                left: "50%",
                "margin-left": "-20px",
                top: 0,
                width: "40px",
                height: "9px",
                "background-position": "-360px -258px"
            },
            "CMD-LEFT": {
                $order: 1,
                top: "50%",
                "margin-top": "-20px",
                right: 0,
                height: "40px",
                width: "9px",
                "background-position": "-310px -240px"
            },
            "CMD-RIGHT": {
                $order: 1,
                top: "50%",
                "margin-top": "-20px",
                left: 0,
                height: "40px",
                width: "9px",
                "background-position": "-336px -240px"
            },
            "CMD-TOP-mouseover": {
                $order: 2,
                "background-position": "-360px -245px"
            },
            "CMD-BOTTOM-mouseover": {
                $order: 2,
                "background-position": "-360px -271px"
            },
            "CMD-LEFT-mouseover": {
                $order: 2,
                "background-position": "-323px -240px"
            },
            "CMD-RIGHT-mouseover": {
                $order: 2,
                "background-position": "-349px -240px"
            },
            "MOVE-MAIN": {
                $order: 5,
                display: "none"
            },
            "CMD-MAIN": {
                $order: 5,
                display: "none"
            }
        },
        Behaviors: {
            DroppableKeys: ["PANEL"],
            PanelKeys: ["PANEL"],
            HoverEffected: {
                MOVE: "MOVE",
                CMD: "CMD"
            },
            onSize: xui.UI.$onSize,
            MOVE: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var itemId = profile.getSubId(src),
                        item = profile.getItemByDom(src);
                    if (item.folded) {
                        return
                    }
                    var main = profile.getItemByItemId("main"),
                        o = profile.getSubNode("ITEM", itemId),
                        m = profile.getSubNodeByItemId("ITEM", "main"),
                        cursor = xui.use(src).css("cursor"),
                        t = profile.properties,
                        h, w, mh, mw, offset1, offset2;
                    profile.pos = item.pos;
                    if (t.type == "vertical") {
                        h = profile._cur = o.height();
                        mh = m.height();
                        if (item.pos == "before") {
                            offset1 = h - item.min;
                            offset2 = item.max ? Math.min(parseInt(item.max, 10) - h, (mh - main.min)) : (mh - main.min)
                        } else {
                            offset1 = item.max ? Math.min(parseInt(item.max, 10) - h, (mh - main.min)) : (mh - main.min);
                            offset2 = h - item.min
                        }
                        xui.use(src).startDrag(e, {
                            dragType: "copy",
                            targetReposition: false,
                            verticalOnly: true,
                            maxTopOffset: offset1,
                            maxBottomOffset: offset2,
                            dragCursor: cursor,
                            targetWidth: xui.browser.ie ? xui.use(src).offsetWidth() : null,
                            targetHeight: xui.browser.ie ? xui.use(src).offsetHeight() : null,
                            targetCallback: xui.browser.ie ?
                            function (n) {
                                n.tagClass("-(top|bottom)", false)
                            } : null
                        })
                    } else {
                        w = profile._cur = o.width();
                        mw = m.width();
                        if (item.pos == "before") {
                            offset1 = w - item.min;
                            offset2 = item.max ? Math.min(parseInt(item.max, 10) - w, (mw - main.min)) : (mw - main.min)
                        } else {
                            offset1 = item.max ? Math.min(parseInt(item.max, 10) - w, (mw - main.min)) : (mw - main.min);
                            offset2 = w - item.min
                        }
                        xui.use(src).startDrag(e, {
                            dragType: "copy",
                            targetReposition: false,
                            horizontalOnly: true,
                            maxLeftOffset: offset1,
                            maxRightOffset: offset2,
                            dragCursor: cursor,
                            targetWidth: xui.browser.ie ? xui.use(src).offsetWidth() : null,
                            targetHeight: xui.browser.ie ? xui.use(src).offsetHeight() : null,
                            targetCallback: xui.browser.ie ?
                            function (n) {
                                n.tagClass("-(left|right)", false)
                            } : null
                        })
                    }
                    profile._limited = 0
                },
                onDrag: function (profile, e, src) {
                    var t = profile.properties,
                        d = xui.DragDrop,
                        p = xui.DragDrop._profile,
                        b = 0;
                    if (t.type == "vertical") {
                        if ((p.y <= p.restrictedTop) || (p.y >= p.restrictedBottom)) {
                            b = true
                        }
                    } else {
                        if (p.x <= p.restrictedLeft || p.x >= p.restrictedRight) {
                            b = true
                        }
                    }
                    if (b) {
                        if (!profile._limited) {
                            profile._bg = p.proxyNode.css("backgroundColor");
                            p.proxyNode.css("backgroundColor", "#ff6600");
                            profile._limited = true
                        }
                    } else {
                        if (profile._limited) {
                            p.proxyNode.css("backgroundColor", profile._bg);
                            profile._limited = 0
                        }
                    }
                },
                onDragstop: function (profile, e, src) {
                    var t = profile.properties,
                        o = xui.use(src).parent(),
                        r = profile.getRoot(),
                        item = profile.getItemByDom(src);
                    if (t.type == "vertical") {
                        o.height(item.size = profile._cur + (profile.pos == "before" ? 1 : -1) * xui.DragDrop.getProfile().offset.y);
                        xui.UI.$tryResize(profile, null, r.height(), true)
                    } else {
                        o.width(item.size = profile._cur + (profile.pos == "before" ? 1 : -1) * xui.DragDrop.getProfile().offset.x);
                        xui.UI.$tryResize(profile, r.width(), null, true)
                    }
                    profile._limited = 0
                }
            },
            CMD: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var t = profile.properties,
                        itemId = profile.getSubId(src),
                        item = profile.getItemByDom(src),
                        r = profile.getRoot(),
                        main = profile.getItemByItemId("main"),
                        m = profile.getSubNodeByItemId("ITEM", "main"),
                        o = profile.getSubNode("ITEM", itemId),
                        panel = profile.getSubNode("PANEL", itemId),
                        move = profile.getSubNode("MOVE", itemId),
                        _handlerSize = xui.UI.$getCSSValue("setting-xui-layout", "width");
                    if (t.type == "vertical") {
                        if (item.folded) {
                            if (item.size <= m.height() - main.min + _handlerSize) {
                                o.height(item.size);
                                panel.show();
                                item.folded = false;
                                if (item.pos == "before") {
                                    xui.use(src).replaceClass(/bottom/g, "top")
                                } else {
                                    xui.use(src).replaceClass(/top/g, "bottom")
                                }
                                if (!item.locked) {
                                    move.css("cursor", "n-resize")
                                }
                                profile.getSubNode("MOVE").tagClass("-checked", false)
                            } else {
                                xui.message("no enough space!")
                            }
                        } else {
                            o.height(_handlerSize);
                            panel.hide();
                            item.folded = true;
                            if (item.pos == "before") {
                                xui.use(src).replaceClass(/top/g, "bottom")
                            } else {
                                xui.use(src).replaceClass(/bottom/g, "top")
                            }
                            if (!item.locked) {
                                move.css("cursor", "default")
                            }
                            profile.getSubNode("MOVE").tagClass("-checked")
                        }
                        xui.UI.$tryResize(profile, null, r.height(), true)
                    } else {
                        if (item.folded) {
                            if (item.size <= m.width() - main.min + _handlerSize) {
                                o.width(item.size);
                                panel.show();
                                item.folded = false;
                                if (item.pos == "before") {
                                    xui.use(src).replaceClass(/right/g, "left")
                                } else {
                                    xui.use(src).replaceClass(/left/g, "right")
                                }
                                if (!item.locked) {
                                    move.css("cursor", "w-resize")
                                }
                                profile.getSubNode("MOVE").tagClass("-checked", false)
                            } else {
                                xui.message("no enough space!")
                            }
                        } else {
                            o.width(_handlerSize);
                            panel.hide();
                            item.folded = true;
                            if (item.pos == "before") {
                                xui.use(src).replaceClass(/left/g, "right")
                            } else {
                                xui.use(src).replaceClass(/right/g, "left")
                            }
                            if (!item.locked) {
                                move.css("cursor", "default")
                            }
                            profile.getSubNode("MOVE").tagClass("-checked")
                        }
                        xui.UI.$tryResize(profile, r.width(), null, true)
                    }
                    return false
                }
            }
        },
        DataModel: {
            selectable: true,
            disabled: null,
            position: "absolute",
            type: {
                listbox: ["vertical", "horizontal"],
                ini: "vertical",
                action: function (value, ovalue) {
                    if (value != ovalue) {
                        var self = this,
                            auto = "auto",
                            nodes2 = self.getSubNode("ITEM", true),
                            nodes1 = self.getSubNode("MOVE", true),
                            nodes3 = self.getSubNode("CMD", true);
                        nodes1.merge(nodes2).merge(nodes3);
                        if (value == "vertical") {
                            nodes1.replaceClass(/(-left)(\b)/ig, "-top$2");
                            nodes1.replaceClass(/(-right)(\b)/ig, "-bottom$2");
                            nodes2.each(function (o) {
                                xui(o).height(xui(o).width())
                            }).css({
                                left: 0,
                                top: auto,
                                right: auto,
                                bottom: auto
                            })
                        } else {
                            nodes1.replaceClass(/(-top)(\b)/ig, "-left$2");
                            nodes1.replaceClass(/(-bottom)(\b)/ig, "-right$2");
                            nodes2.each(function (o) {
                                xui(o).width(xui(o).height())
                            }).css({
                                left: auto,
                                top: 0,
                                right: auto,
                                bottom: auto
                            })
                        }
                        var size = self.getRoot().cssSize();
                        xui.UI.$tryResize(self, size.width, size.height, true)
                    }
                }
            },
            dock: "fill",
            listKey: null,
            width: 200,
            height: 200,
            overflow: {
                ini: xui.browser.isTouch ? "auto" : undefined,
                listbox: ["", "visible", "hidden", "scroll", "auto"],
                action: function (v) {
                    this.getSubNode("PANEL", true).css("overflow", v || "")
                }
            },
            items: {
                ini: [],
                set: function (value) {
                    var o = this;
                    if (o.renderId) {
                        var box = o.boxing(),
                            temp = xui.$getGhostDiv(),
                            children = _.copy(o.children),
                            p, vv;
                        o.children.length = 0;
                        _.arr.each(children, function (o) {
                            delete o[0].$dockParent;
                            temp.appendChild(o[0].getRootNode())
                        });
                        box.clearItems();
                        vv = o.box._adjustItems(value);
                        box._insertItems(vv, null, null, true);
                        _.arr.each(children, function (v) {
                            box.append.apply(box, v)
                        });
                        temp.innerHTML = "";
                        var size = o.getRoot().cssSize();
                        xui.UI.$tryResize(o, size.width, size.height, true)
                    } else {
                        o.properties.items = _.copy(value)
                    }
                }
            }
        },
        _adjustItems2: function (items, pos) {
            var arr = [];
            _.arr.each(items, function (o) {
                if (o.id != "main") {
                    arr.push(o = _.isHash(o) ? o : {
                        id: "" + o
                    });
                    o.pos = pos
                }
            });
            _.arr.each(arr, function (o) {
                o.id = _.isStr(o.id) ? o.id : _.id();
                o.min = o.min || 10;
                o.size = parseInt(o.size, 10) || 80;
                o.locked = typeof o.locked == "boolean" ? o.locked : false;
                o.folded = typeof o.folded == "boolean" ? o.folded : false;
                o.hidden = typeof o.hidden == "boolean" ? o.hidden : false;
                o.cmd = typeof o.cmd == "boolean" ? o.cmd : true
            });
            return arr
        },
        _adjustItems: function (items) {
            var main, before = [],
                after = [];
            _.arr.each(items, function (o) {
                if (o.id == "main") {
                    main = o
                } else {
                    if (o.pos == "before") {
                        before.push(o)
                    } else {
                        o.pos = "after";
                        after.push(o)
                    }
                }
            });
            main = main || {};
            main.id = "main";
            main.min = main.min || 10;
            items.length = 0;
            _.arr.insertAny(items, this._adjustItems2(before, "before"));
            _.arr.insertAny(items, main);
            _.arr.insertAny(items, this._adjustItems2(after, "after"));
            return items
        },
        _prepareData: function (profile) {
            var prop = profile.properties;
            if (!prop.items || prop.items.constructor != Array) {
                prop.items = _.clone([{
                    id: "before",
                    pos: "before",
                    locked: false,
                    size: 60,
                    min: 50,
                    max: 200
                }, {
                    id: "after",
                    pos: "after",
                    locked: false,
                    size: 60,
                    min: 50,
                    max: 200
                }])
            }
            prop.items = this._adjustItems(prop.items);
            return arguments.callee.upper.call(this, profile)
        },
        _prepareItems: function (profile, items) {
            var data = arguments.callee.upper.apply(this, arguments);
            _.arr.each(items, function (o) {
                delete o.caption
            });
            return data
        },
        _prepareItem: function (profile, item) {
            var prop = profile.properties;
            if (item.id == "main") {
                item.cls1 = profile.getClass("ITEM", "-main");
                item.cls2 = profile.getClass("MOVE", "-main");
                item.cls3 = profile.getClass("CMD", "-main");
                return
            }
            if (prop.type == "vertical") {
                item.size = "height:" + item.size + "px"
            } else {
                item.size = "width:" + item.size + "px"
            }
            var pos;
            if (prop.type == "vertical") {
                if (item.pos == "before") {
                    pos = "top"
                } else {
                    pos = "bottom"
                }
            } else {
                if (item.pos == "before") {
                    pos = "left"
                } else {
                    pos = "right"
                }
            }
            item.cls1 = profile.getClass("ITEM", "-" + pos);
            item.cls2 = profile.getClass("MOVE", "-" + pos);
            item.cls3 = profile.getClass("CMD", "-" + pos);
            item.display = item.hidden ? "display:none" : "";
            item.moveDisplay = item.locked ? "display:none" : "";
            item.cmdDisplay = item.cmd ? "" : "display:none";
            if (_.isStr(item.overflow)) {
                item._overflow = item.overflow.indexOf(":") != -1 ? (item.overflow) : ("overflow:" + item.overflow)
            } else {
                if (_.isStr(prop.overflow)) {
                    item._overflow = prop.overflow.indexOf(":") != -1 ? (prop.overflow) : ("overflow:" + prop.overflow)
                }
            }
        },
        RenderTrigger: function () {
            var t, profile = this;
            _.arr.each(profile.properties.items, function (item) {
                if (item.id != "main") {
                    if (item.folded && (t = profile.getSubIdByItemId(item.id))) {
                        item.folded = false;
                        profile.getSubNode("CMD", t).onMousedown()
                    }
                }
            })
        },
        _onresize: function (profile, width, height) {
            var _t, t = profile.properties,
                m, n, itemId, temp1, temp2, temp, key = profile.keys.ITEM,
                panel = profile.keys.PANEL,
                move = profile.getSubNode("MOVE", true),
                _handlerSize = xui.UI.$getCSSValue("setting-xui-layout", "width");
            var obj = {},
                obj2 = {};
            _.arr.each(t.items, function (o) {
                itemId = profile.getSubIdByItemId(o.id);
                obj[itemId] = {};
                obj2[itemId] = {}
            });
            if (t.type != "vertical") {
                if (!_.isNull(width)) {
                    temp = temp1 = temp2 = 0;
                    _.arr.each(t.items, function (o) {
                        if (o.id == "main") {
                            return
                        }
                        itemId = profile.getSubIdByItemId(o.id);
                        if (o.pos == "before") {
                            n = profile.getSubNode("ITEM", itemId);
                            if (o.hidden) {
                                m = 0;
                                obj2[itemId].width = o.size
                            } else {
                                if (o.folded) {
                                    m = obj2[itemId].width = _handlerSize
                                } else {
                                    m = n.width()
                                }
                            }
                            obj2[itemId].left = temp1;
                            temp1 += m;
                            obj2[itemId].right = "auto";
                            obj[itemId].right = "auto";
                            obj[itemId].left = 0;
                            obj[itemId].width = m - (o.locked ? 0 : _handlerSize)
                        }
                    });
                    _.arr.each(t.items, function (o) {
                        if (o.id == "main") {
                            return
                        }
                        itemId = profile.getSubIdByItemId(o.id);
                        if (o.pos == "after") {
                            n = profile.getSubNode("ITEM", itemId);
                            if (o.hidden) {
                                m = 0;
                                obj2[itemId].width = o.size
                            } else {
                                if (o.folded) {
                                    m = obj2[itemId].width = _handlerSize
                                } else {
                                    m = n.width()
                                }
                            }
                            obj2[itemId].right = temp2;
                            temp2 += m;
                            obj2[itemId].left = "auto";
                            obj[itemId].right = 0;
                            obj[itemId].left = "auto";
                            obj[itemId].width = m - (o.locked ? 0 : _handlerSize)
                        }
                    }, null, true);
                    temp = temp1 + temp2;
                    if (width - temp >= 0) {
                        _t = profile.getSubIdByItemId("main");
                        obj[_t].width = width - temp;
                        obj2[_t].width = width - temp;
                        obj2[_t].left = temp1
                    }
                }
                if (!_.isNull(height)) {
                    _.each(obj, function (o, id) {
                        o.height = height;
                        obj2[id].height = height
                    })
                }
            } else {
                if (!_.isNull(height)) {
                    temp = temp1 = temp2 = 0;
                    _.arr.each(t.items, function (o) {
                        if (o.id == "main") {
                            return
                        }
                        itemId = profile.getSubIdByItemId(o.id);
                        if (o.pos == "before") {
                            n = profile.getSubNode("ITEM", itemId);
                            if (o.hidden) {
                                m = 0;
                                obj2[itemId].height = o.size
                            } else {
                                if (o.folded) {
                                    m = obj2[itemId].height = _handlerSize
                                } else {
                                    m = n.height()
                                }
                            }
                            obj2[itemId].top = temp1;
                            temp1 += m;
                            obj2[itemId].bottom = "auto";
                            obj[itemId].top = 0;
                            obj[itemId].bottom = "auto";
                            obj[itemId].height = m - (o.locked ? 0 : _handlerSize)
                        }
                    });
                    _.arr.each(t.items, function (o) {
                        if (o.id == "main") {
                            return
                        }
                        itemId = profile.getSubIdByItemId(o.id);
                        if (o.pos == "after") {
                            n = profile.getSubNode("ITEM", itemId);
                            if (o.hidden) {
                                m = 0;
                                obj2[itemId].height = o.size
                            } else {
                                if (o.folded) {
                                    m = obj2[itemId].height = _handlerSize
                                } else {
                                    m = n.height()
                                }
                            }
                            obj2[itemId].bottom = temp2;
                            temp2 += m;
                            obj2[itemId].top = "auto";
                            obj[itemId].bottom = 0;
                            obj[itemId].top = "auto";
                            obj[itemId].height = m - (o.locked ? 0 : _handlerSize)
                        }
                    }, null, true);
                    temp = temp1 + temp2;
                    if (height - temp >= 0) {
                        _t = profile.getSubIdByItemId("main");
                        obj[_t].height = height - temp;
                        obj2[_t].height = height - temp;
                        obj2[_t].top = temp1
                    }
                }
                if (!_.isNull(width)) {
                    _.each(obj, function (o, id) {
                        o.width = width;
                        obj2[id].width = width
                    })
                }
            }
            _.each(obj2, function (o, id) {
                profile.getSubNode("PANEL", id).cssRegion(obj[id], true);
                profile.getSubNode("ITEM", id).cssRegion(obj2[id])
            })
        }
    }
});
Class("xui.UI.ColLayout", ["xui.UI", "xui.absList"], {
    Dependency: ["xui.UI.Panel"],
    Instance: {
        addPanel: function (args, col, basePrf, before) {
            var profile = this.get(0),
                items = profile.properties.items,
                prop = profile.properties;
            if (!col) {
                col = items[0].id
            }
            if (_.arr.subIndexOf(items, "id", col) == -1) {
                return this
            }
            if (!args.properties) {
                args.properties = {}
            }
            var ns = this,
                profile = ns.get(0);
            _.merge(args.properties, {
                dock: "none",
                position: "relative",
                left: 0,
                top: 0,
                width: "auto",
                height: "auto",
                toggle: true,
                toggleBtn: true,
                dragKey: prop.disabled ? null : profile.box.KEY + ":" + profile.$xid,
                closeBtn: !prop.disabled
            });
            var panel = new xui.UI.Panel(args.properties, args.events, args.host, args.theme, args.CS, args.CC, args.CB, args.CF);
            return this.movePanel(panel.get(0), col, basePrf, before)
        },
        movePanel: function (prf, col, basePrf, before) {
            var profile = this.get(0);
            if (prf["xui.UI"]) {
                prf = prf.get(0)
            }
            if (basePrf && basePrf["xui.UI"]) {
                basePrf = basePrf.get(0)
            }
            if (prf && prf != basePrf) {
                var flag, items = profile.children;
                if (prf.parent != profile || prf.childrenId != col) {
                    this.append(prf, col);
                    flag = 1
                }
                var node, tnode = prf.getRootNode();
                if (!basePrf) {
                    node = this.getSubNodeByItemId("PANEL", col);
                    if (node.last().isEmpty() || node.last().id() != tnode.id) {
                        node.append(tnode);
                        flag = 1
                    }
                } else {
                    if (before) {
                        node = basePrf.getRoot();
                        if (node.prev().isEmpty() || node.prev().id() != tnode.id) {
                            node.addPrev(tnode);
                            flag = 1;
                            var i1 = _.arr.subIndexOf(items, "0", basePrf),
                                i2 = _.arr.subIndexOf(items, "0", prf);
                            if (i1 != -1) {
                                var item = items[i2];
                                _.arr.removeFrom(items, i2);
                                _.arr.insertAny(items, item, i1, true)
                            }
                        }
                    } else {
                        node = basePrf.getRoot();
                        if (node.next().isEmpty() || node.next().id() != tnode.id) {
                            node.addNext(tnode);
                            flag = 1;
                            var i1 = _.arr.subIndexOf(items, "0", basePrf),
                                i2 = _.arr.subIndexOf(items, "0", prf);
                            if (i1 != -1 && i1 > items.length) {
                                var item = items[i2];
                                _.arr.removeFrom(items, i2);
                                _.arr.insertAny(items, item, i1 + 1, true)
                            }
                        }
                    }
                }
                if (flag && profile.onRelayout) {
                    this.onRelayout(profile)
                }
            }
            return this
        },
        append: function (target, subId) {
            var p = this.get(0).properties;
            if (subId = subId || (p.items && p.items[0] && p.items[0].id)) {
                arguments.callee.upper.call(this, target, subId)
            }
            return this
        }
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            ITEMS: {
                $order: 10,
                tagName: "div",
                text: "{items}"
            },
            COVER: {
                tagName: "div"
            },
            $submap: {
                items: {
                    ITEM: {
                        tagName: "div",
                        style: "width:{width}",
                        MOVE: {
                            $order: 1,
                            tagName: "div",
                            style: "{_display}"
                        },
                        PANEL: {
                            $order: 2,
                            tagName: "div",
                            text: xui.UI.$childTag
                        }
                    }
                }
            }
        },
        Appearances: {
            KEY: {
                position: "absolute",
                "overflow-x": "hidden",
                "overflow-y": "auto",
                border: "none",
                zoom: xui.browser.ie6 ? 1 : null
            },
            ITEMS: {
                position: "relative",
                overflow: "hidden",
                border: "none",
                zoom: xui.browser.ie6 ? 1 : null
            },
            COVER: {
                position: "absolute",
                left: 0,
                top: 0,
                width: "100%",
                height: "100%",
                display: "none",
                "z-index": 10,
                background: xui.browser.ie ? "url(" + xui.ini.img_bg + ")" : null
            },
            MOVE: {
                $order: 0,
                position: "relative",
                "float": "right",
                width: "4px",
                height: "200px",
                cursor: "e-resize",
                "background-color": "#f4f4f4",
                "border-width": xui.browser.opr ? "0" : null,
                "font-size": xui.browser.ie ? 0 : "",
                "line-height": xui.browser.ie ? 0 : ""
            },
            "MOVE-mouseover": {
                $order: 1,
                "background-color": "#f0f0f0"
            },
            ITEM: {
                position: "static",
                "float": "left",
                overflow: "hidden",
                "border-width": "0",
                "font-size": xui.browser.ie ? 0 : "",
                "line-height": xui.browser.ie ? 0 : ""
            },
            PANEL: {
                position: "static",
                overflow: "hidden",
                zoom: xui.browser.ie6 ? 1 : null,
                "border-width": xui.browser.opr ? "0" : null,
                "font-size": xui.browser.ie ? 0 : "",
                "line-height": xui.browser.ie ? 0 : ""
            }
        },
        Behaviors: {
            HoverEffected: {
                MOVE: "MOVE"
            },
            DroppableKeys: ["KEY"],
            MOVE: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var pro = profile.properties;
                    if (pro.disabled) {
                        return
                    }
                    var min = pro.minWidth,
                        cursor = xui.use(src).css("cursor"),
                        pre = profile._pre = xui.use(src).parent(),
                        preW = profile._preW = pre.offsetWidth(),
                        next = profile._next = pre.next(),
                        nextW = profile._nextW = next.offsetWidth(),
                        offset1 = preW - min,
                        offset2 = nextW - min;
                    if (offset1 < 0) {
                        offset1 = 0
                    }
                    if (offset2 < 0) {
                        offset2 = 0
                    }
                    profile._bg = null;
                    profile._limited = 0;
                    xui.use(src).startDrag(e, {
                        dragType: "copy",
                        targetReposition: false,
                        targetCSS: {
                            background: "none"
                        },
                        horizontalOnly: true,
                        widthIncrement: 10,
                        maxLeftOffset: offset1,
                        maxRightOffset: offset2,
                        dragCursor: cursor
                    })
                },
                onDrag: function (profile, e, src) {
                    var p = xui.DragDrop.getProfile();
                    if (p.x <= p.restrictedLeft || p.x >= p.restrictedRight) {
                        if (!profile._limited) {
                            profile._bg = xui.use(src).css("backgroundColor");
                            xui.use(src).css("backgroundColor", "#ff6600");
                            profile._limited = true
                        }
                    } else {
                        if (profile._limited) {
                            xui.use(src).css("backgroundColor", profile._bg);
                            profile._limited = 0
                        }
                    }
                    profile._pre.width(profile._preW + p.offset.x);
                    profile._next.width(profile._nextW - p.offset.x)
                },
                onDragstop: function (profile, e, src) {
                    var arr = profile.getSubNode("ITEM", true).get(),
                        n = xui.use(src),
                        l = profile.getSubNode("ITEMS").width(),
                        a = [],
                        t, k = 0;
                    _.arr.each(arr, function (o, i) {
                        if (i != arr.length - 1) {
                            a[i] = xui([o]).offsetWidth()
                        }
                    });
                    _.arr.each(arr, function (o, i) {
                        if (i != arr.length - 1) {
                            t = ((a[i] / l) * 100).toFixed(4);
                            k += +t;
                            a[i] = o.style.width = t + "%"
                        }
                    });
                    a[arr.length - 1] = arr[arr.length - 1].style.width = (99 - k).toFixed(4) + "%";
                    if (profile._limited) {
                        n.css("backgroundColor", profile._bg);
                        profile._limited = 0
                    }
                    if (profile.onColResize) {
                        profile.boxing().onColResize(profile, a)
                    }
                }
            },
            onMousemove: function (profile, e) {
                if (profile.$$ondrag) {
                    var prop = profile.properties;
                    if (prop.disabled) {
                        return
                    }
                    if (xui.DragDrop.getProfile().isWorking) {
                        var box = profile.box,
                            height = profile.$$height,
                            dragid = profile.$$dragitemid,
                            rst = box._checkpos(profile, xui.Event.getPos(e));
                        if (rst) {
                            var col = rst[0],
                                row = rst[1],
                                rowup = rst[2];
                            if (col) {
                                if (row) {
                                    profile.$$droppable = box._checkDroppable(profile, rowup ? 2 : 3, xui(row), height, dragid)
                                } else {
                                    profile.$$droppable = box._checkDroppable(profile, 1, xui(col), height, dragid)
                                }
                            } else {
                                box._setNoDroppable(profile);
                                delete profile.$$droppable
                            }
                        }
                    }
                }
            }
        },
        DataModel: {
            position: "absolute",
            dock: "fill",
            listKey: null,
            width: 200,
            height: 200,
            minWidth: 150,
            disabled: {
                ini: false,
                action: function (v) {}
            },
            items: [{
                id: "1",
                width: "30.4%"
            }, {
                id: "2",
                width: "30.4%"
            }, {
                id: "3",
                width: "38.2%",
                _display: "display:none"
            }]
        },
        EventHandlers: {
            onColResize: function (profile, sizes) {},
            onRelayout: function (profile) {}
        },
        _preparePosSizeEtc: function (profile) {
            var root = profile.getRoot(),
                items = profile.getSubNode("ITEM", true),
                w = 0,
                h = 0,
                ns, i, t, rootPos = root.offset(),
                rootSize = root.cssSize(),
                colsWidthData = [],
                rowsHeightData = [];
            items.each(function (o) {
                w = w + xui(o).offsetWidth();
                colsWidthData.push([w, o.lastChild.id]);
                ns = o.lastChild.childNodes;
                h = 0;
                rowsHeightData.push([]);
                for (i = 0; t = ns[i]; i++) {
                    if (!t.id || !xui.UIProfile.getFromDom(t) || !t.style || t.style.display == "none" || t.style.visibility == "hidden") {
                        continue
                    }
                    h = h + t.offsetHeight;
                    rowsHeightData[rowsHeightData.length - 1].push([h, t.id])
                }
            });
            profile._cachePosSizeData = [rootPos, rootSize, colsWidthData, rowsHeightData];
            profile._ddup = profile._ddid = profile._ddincol = profile._ddi == null
        },
        _checkpos: function (profile, pos, force) {
            var _data = profile._cachePosSizeData,
                rootPos = _data[0],
                rootSize = _data[1],
                colsWidthData = _data[2],
                rowsHeightData = _data[3],
                changed;
            var col, left = pos.left - rootPos.left,
                top = pos.top - rootPos.top,
                i = 0,
                temp, t, to = 0,
                arr;
            while (t = colsWidthData[i++]) {
                if (left < t[0]) {
                    if (profile._ddincol === t[1]) {
                        break
                    }
                    changed = true;
                    profile._ddi = i - 1;
                    profile._ddincol = t[1];
                    profile._ddid = profile._ddup = null;
                    break
                }
            }
            if (profile._ddi !== null) {
                col = profile._ddincol;
                arr = rowsHeightData[profile._ddi];
                i = 0;
                while (t = arr[i++]) {
                    if (top < t[0]) {
                        if (profile._ddid !== t[1]) {
                            profile._ddup = null
                        }
                        j = (top < (to + (t[0] - to) / 2));
                        if (profile._ddid === t[1] && profile._ddup === j) {
                            break
                        }
                        profile._ddid = t[1];
                        profile._ddup = j;
                        changed = true;
                        break
                    }
                    to = t[0]
                }
                if (changed || force) {
                    return [col, profile._ddid, profile._ddup]
                }
            } else {
                if (changed || force) {
                    return [null]
                } else {
                    return
                }
            }
        },
        _checkDroppable: function (profile, type, node, height, dragid) {
            var self = this,
                candrop = false,
                proxy = profile._proxy || (profile._proxy = xui.create('<div style="border:1px dashed #FF0000;">'));
            proxy.height(height || 20);
            if (node.isEmpty()) {
                return
            }
            if (type === 1) {
                if (node.last().isEmpty() || node.last().id() != dragid) {
                    node.append(proxy);
                    candrop = true
                }
            } else {
                if (type === 2) {
                    if (node.id() != dragid) {
                        if (node.prev().isEmpty() || node.prev().id() != dragid) {
                            node.addPrev(proxy);
                            candrop = true
                        }
                    }
                } else {
                    if (node.id() != dragid) {
                        if (node.next().isEmpty() || node.next().id() != dragid) {
                            node.addNext(proxy);
                            candrop = true
                        }
                    }
                }
            }
            if (candrop) {
                xui.DragDrop.setDragIcon("add");
                return true
            } else {
                self._setNoDroppable(profile);
                return false
            }
        },
        _setNoDroppable: function (profile) {
            if (profile._proxy) {
                profile._proxy.remove();
                delete profile._proxy
            }
            profile._ddup = profile._ddid = profile._ddincol = profile._ddi == null;
            xui.DragDrop.setDropFace()
        },
        _onDropMarkShow: function () {
            return false
        },
        _onDropMarkClear: function (profile) {
            profile.box._setNoDroppable(profile)
        },
        _onDragEnter: function (profile, e, src) {
            var ddId = xui.DragDrop.getProfile().$id;
            if (profile.$$ddfalg != ddId) {
                profile.$$ddfalg = ddId;
                profile.box._preparePosSizeEtc(profile)
            }
            var targetPrf = xui.DragDrop.getProfile().dragData.profile;
            if (targetPrf && targetPrf.parent == profile) {
                profile.$$dragitemid = xui.DragDrop.getProfile().dragData.profile.domId;
                profile.$$height = xui.DragDrop.getProfile().dragData.profile.getRoot().offsetHeight()
            }
            profile.getSubNode("COVER").css({
                display: "block"
            });
            profile.$$ondrag = true;
            delete profile.$$dropalbe
        },
        _onDragLeave: function (profile) {
            profile.getSubNode("COVER").css({
                display: "none"
            });
            delete profile.$$dragitemid;
            delete profile.$$height;
            delete profile.$$ondrag
        },
        _onDrop: function (profile, e) {
            if (profile.$$droppable) {
                var rst = profile.box._checkpos(profile, xui.Event.getPos(e), true),
                    ddd = xui.DragDrop.getProfile().dragData,
                    targetPrf = ddd.profile,
                    exists = targetPrf.parent == profile;
                if (rst && rst[0]) {
                    var col = profile.getItemIdByDom(rst[0]),
                        base = xui.UIProfile.getFromDom(rst[1]),
                        before = rst[2];
                    if (col) {
                        if (exists) {
                            profile.boxing().movePanel(targetPrf, col, base, before)
                        } else {
                            profile.boxing().addPanel(ddd.data.properties, ddd.data.events, col, base, before)
                        }
                    }
                }
            }
            profile.getSubNode("COVER").css({
                display: "none"
            });
            profile.box._setNoDroppable(profile);
            delete profile._cachePosSizeData;
            delete profile.$$height;
            delete profile.$$ondrag
        },
        _prepareData: function (profile) {
            profile.properties.dropKeys = profile.box.KEY + ":" + profile.$xid;
            return arguments.callee.upper.call(this, profile)
        },
        _onresize: function (profile, width, height) {}
    }
});
Class("xui.UI.TreeGrid", ["xui.UI", "xui.absValue"], {
    Instance: {
        activate: function () {
            var profile = this.get(0),
                t;
            if (!profile.renderId) {
                return
            }
            profile.getSubNode("BODY").nextFocus(true, true, true);
            return this
        },
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                if (!profile.renderId) {
                    return
                }
                if (profile.properties.activeMode == "none") {
                    return
                }
                var box = profile.boxing(),
                    uiv = box.getUIValue(),
                    p = profile.properties,
                    k = p.activeMode == "row" ? "CELLS" : "CELL",
                    getN = function (k, i) {
                        return profile.getSubNode(k, i)
                    },
                    getI = function (i) {
                        var map1 = profile.rowMap2;
                        if (p.activeMode == "row") {
                            return map1[i]
                        } else {
                            if (!i) {
                                return
                            }
                            var r = ("" + i).split("|");
                            return _.get(profile.rowMap, [map1[r[0]], "_cells", r[1]])
                        }
                    };
                if (p.selMode == "single") {
                    var itemId = getI(uiv);
                    if (uiv && itemId) {
                        getN(k, itemId).tagClass("-checked", false)
                    }
                    itemId = getI(value);
                    if (itemId) {
                        getN(k, itemId).tagClass("-checked")
                    }
                } else {
                    if (p.selMode == "multi" || p.selMode == "multibycheckbox") {
                        uiv = uiv ? ("" + uiv).split(p.valueSeparator) : [];
                        value = value ? ("" + value).split(p.valueSeparator) : [];
                        _.arr.each(uiv, function (o) {
                            getN(k, getI(o)).tagClass("-checked", false)
                        });
                        _.arr.each(value, function (o) {
                            getN(k, getI(o)).tagClass("-checked")
                        });
                        if (value.length === 0) {
                            getN("HFMARK").tagClass("-checked", false);
                            delete profile._$checkAll
                        }
                    }
                }
            })
        },
        _insertRowsToDom: function (profile, arr, pid, base, before) {
            if (pid) {
                var parent = profile.rowMap[pid];
                if (parent && !parent._inited) {
                    return
                }
            }
            if (!arr) {
                arr = []
            }
            var obj, hw, hw = profile.getSubNode("HFCELL").width();
            _.arr.each(arr, function (o) {
                o._row0DfW = hw ? ("width:" + hw + "px") : "";
                _.arr.each(o.cells, function (v, i) {
                    v.width = v._col.width
                })
            });
            var nodes = profile._buildItems("rows", arr);
            if (!base) {
                if (pid) {
                    obj = profile.getSubNode("SUB", pid)
                } else {
                    obj = profile.getSubNode("BODY")
                }
                if (before) {
                    obj.prepend(nodes)
                } else {
                    obj.append(nodes)
                }
            } else {
                obj = profile.getSubNode("ROW", base);
                if (before) {
                    obj.addPrev(nodes)
                } else {
                    obj.addNext(nodes)
                }
            }
            _.arr.each(arr, function (o) {
                o.open = false
            });
            delete profile.$allrowscache
        },
        _refreshHeader: function (header) {
            var profile = this.get(0),
                pro = profile.properties,
                oheader = this.getHeader("data");
            _.breakO(profile.colMap, 2);
            if (!header) {
                header = []
            }
            header = profile.box._adjustHeader(header);
            var arr = profile.box._prepareHeader(profile, header);
            pro.header = header;
            var keepRows = false;
            if (oheader.length == arr.length) {
                keepRows = true;
                _.arr.each(header, function (col, i) {
                    if (col.type != oheader[i].type) {
                        return keepRows = false
                    }
                })
            }
            if (keepRows) {
                var rows = this.getRows("data")
            }
            this.removeAllRows();
            profile.getSubNode("HCELL", true).remove();
            if (arr.length) {
                profile.getSubNode("HCELLS").append(profile._buildItems("header", arr))
            }
            if (keepRows) {
                this.setRows(rows)
            }
            profile.box._ajdustBody(profile);
            if (profile.$col_pop) {
                profile.$col_pop.destroy();
                delete profile.$col_pop
            }
        },
        _toggleRows: function (rows, expand) {
            var self = this;
            if (rows && rows.length) {
                _.arr.each(rows, function (o) {
                    self.toggleRow(o.id, expand)
                })
            }
        },
        autoRowHeight: function (rowId) {
            return this.each(function (prf) {
                if (prf.renderId) {
                    if (rowId && prf.rowMap2[rowId]) {
                        prf.getSubNode("FHANDLER", prf.rowMap2[rowId]).onDblclick(true)
                    } else {
                        _.each(prf.rowMap, function (o, i) {
                            prf.getSubNode("FHANDLER", i).onDblclick(true)
                        })
                    }
                }
            })
        },
        autoColWidth: function (colId) {
            return this.each(function (prf) {
                if (prf.renderId) {
                    if (colId && prf.colMap2[colId]) {
                        prf.getSubNode("HHANDLER", prf.colMap2[colId]).onDblclick(true)
                    } else {
                        _.each(prf.colMap, function (o, i) {
                            prf.getSubNode("HHANDLER", i).onDblclick(true)
                        })
                    }
                }
            })
        },
        autoColHeight: function () {
            return this.each(function (prf) {
                if (prf.renderId) {
                    prf.getSubNode("FHANDLER").onDblclick(true)
                }
            })
        },
        addHotRow: function (focusColId) {
            var prf = this.get(0);
            if (prf.renderId) {
                prf.box._addTempRow(prf, focusColId)
            }
            return this
        },
        removeHotRow: function () {
            var profile = this.get(0);
            profile.box._sethotrowoutterblur(profile, true);
            delete profile.__hastmpRow;
            this.removeRows([profile.box._temprowid], false);
            return this
        },
        isDirtied: function () {
            var dirty = false;
            _.each(this.get(0).cellMap, function (v) {
                if (v._oValue !== v.value) {
                    dirty = true;
                    return false
                }
            });
            return dirty
        },
        _getObjByDom: function (src, type) {
            var prf = this.get(0),
                subId = prf.getSubId(typeof src == "string" ? src.charAt(0) == "!" ? ((src = xui.use(src).get(0)) && src.id) : src : src.id);
            return prf[type == "row" ? "rowMap" : type == "col" ? "colMap" : "cellMap"][subId]
        },
        getRowByDom: function (src) {
            return this._getObjByDom(src, "row")
        },
        getHeaderByDom: function (src) {
            return this._getObjByDom(src, "col")
        },
        getCellByDom: function (src) {
            return this._getObjByDom(src, "cell")
        },
        getRows: function (type) {
            var v = this.get(0).properties.rows,
                a, b;
            if (type == "data" || type == "min") {
                a = _.clone(v, true);
                if (a && a.length && a[a.length - 1] && a[a.length - 1].id == this.constructor._temprowid) {
                    a.pop()
                }
                if (type == "min") {
                    _.arr.each(a, function (o, i) {
                        _.each(b = a[i] = a[i].cells, function (v, j) {
                            b[j] = v.value
                        })
                    })
                }
                return a
            } else {
                return v
            }
        },
        getRowbyRowId: function (rowId, type) {
            var profile = this.get(0),
                v = profile.rowMap2[rowId];
            v = v ? profile.rowMap[v] : null;
            if (v) {
                if (type == "data") {
                    return _.clone(v, true)
                } else {
                    if (type == "min") {
                        var a = _.clone(v, true),
                            b;
                        _.each(b = a = a.cells, function (v, j) {
                            b[j] = v.value
                        });
                        return a
                    } else {
                        return v
                    }
                }
            }
        },
        getRowbyCell: function (cell, type) {
            var v = cell._row;
            if (v) {
                if (type == "data") {
                    return _.clone(v, true)
                } else {
                    if (type == "min") {
                        var a = _.clone(v, true),
                            b;
                        _.each(b = a = a.cells, function (v, j) {
                            b[j] = v.value
                        });
                        return a
                    } else {
                        return v
                    }
                }
            }
        },
        toggleRow: function (id, expand) {
            var profile = this.get(0),
                row = profile.rowMap[profile.rowMap2[id]];
            if (row && row.sub) {
                profile.box._setSub(profile, row, typeof expand == "boolean" ? expand : !row._checked)
            }
            return this
        },
        updateRow: function (rowId, options) {
            var ns = this,
                profile = ns.get(0),
                orow = ns.getRowbyRowId(rowId),
                nid;
            if (orow) {
                var rid = orow._serialId,
                    t, tt;
                if (typeof options != "object") {
                    options = {
                        caption: options
                    }
                } else {
                    _.filter(options, true)
                }
                if (_.isSet(options.id)) {
                    options.id += ""
                }
                if (options.id && options.id !== rowId) {
                    nid = options.id;
                    var m2 = profile.rowMap2,
                        v;
                    if (!m2[nid]) {
                        if (v = m2[rowId]) {
                            m2[nid] = v;
                            delete m2[rowId];
                            profile.rowMap[v].id = nid;
                            _.each(profile.colMap, function (o) {
                                if (o = o._cells) {
                                    o[nid] = o[rowId];
                                    delete o[rowId]
                                }
                            })
                        }
                    }
                } else {
                    options.id = rowId
                }
                if (_.isEmpty(options)) {
                    return ns
                }
                if (("group" in options && options.group != orow.group) || "cells" in options || ("sub" in options && !((options.sub === true && !orow.sub) || (!options.sub && orow.sub === true)))) {
                    var id = "__special",
                        pid = orow._pid ? profile.rowMap[orow._pid].id : null;
                    orow.id = id;
                    profile.rowMap2[id] = profile.rowMap2[nid || rowId];
                    delete profile.rowMap2[nid || rowId];
                    _.each(profile.colMap, function (o) {
                        if (o = o._cells) {
                            delete o[nid || rowId]
                        }
                    });
                    orow = _.clone(orow, true);
                    _.merge(orow, options, "all");
                    if ("sub" in options && !options.sub) {
                        delete orow.sub
                    }
                    ns.insertRows([orow], pid, id, true);
                    ns.removeRows([id]);
                    if (profile.properties.activeMode == "row") {
                        var uiv = profile.properties.$UIvalue || "",
                            arr = ("" + uiv).split(profile.properties.valueSeparator);
                        if (arr.length && _.arr.indexOf(arr, rowId) != -1) {
                            if (nid) {
                                _.arr.removeValue(arr, rowId)
                            }
                            ns.setUIValue(arr.join(profile.properties.valueSeparator), true)
                        }
                    }
                } else {
                    if ("sub" in options) {
                        t = ns.getSubNode("ROWTOGGLE", rid);
                        if (options.sub) {
                            t.removeClass("xui-uicmd-empty").addClass("xui-uicmd-toggle2")
                        } else {
                            t.removeClass("xui-uicmd-toggle2").addClass("xui-uicmd-empty")
                        }
                    }
                    if (t = options.height) {
                        ns.getSubNode("CELLS", rid).height(t)
                    }
                    if (t = options.rowStyle) {
                        (tt = ns.getSubNode("CELLS", rid)).attr("style", tt.attr("style") + ";" + t)
                    }
                    if (t = options.rowClass) {
                        ns.getSubNode("CELLS", rid).addClass(t)
                    }
                    if (options.hasOwnProperty("disabled")) {
                        var cls = profile.getClass("CELLS", "-disabled");
                        if (options.disabled) {
                            ns.getSubNode("CELLS", rid).addClass(cls)
                        } else {
                            ns.getSubNode("CELLS", rid).removeClass(cls)
                        }
                    }
                    if (options.hasOwnProperty("readonly")) {
                        var cls = profile.getClass("CELLS", "-readonly");
                        if (options.readonly) {
                            ns.getSubNode("CELLS", rid).addClass(cls)
                        } else {
                            ns.getSubNode("CELLS", rid).removeClass(cls)
                        }
                    }
                    if (t = options.firstCellStyle) {
                        (tt = ns.getSubNode("FCELL", rid)).fisrt().attr("style", tt.attr("style") + ";" + t)
                    }
                    if (t = options.firstCellClass) {
                        ns.getSubNode("FCELL", rid).fisrt().addClass(t)
                    }
                    if (options.hasOwnProperty("caption")) {
                        ns.getSubNode("FCELLCAPTION", rid).get(0).innerHTML = options.caption
                    }
                    if (options.hasOwnProperty("preview")) {
                        if (options.preview) {
                            ns.getSubNode("PREVIEW", rid).css("display", "block").html(options.preview)
                        } else {
                            ns.getSubNode("PREVIEW", rid).css("display", "none")
                        }
                    }
                    if (options.hasOwnProperty("summary")) {
                        if (options.summary) {
                            ns.getSubNode("SUMMARY", rid).css("display", "block").html(options.summary)
                        } else {
                            ns.getSubNode("SUMMARY", rid).css("display", "none")
                        }
                    }
                    if (options.hasOwnProperty("rowResizer")) {
                        t = !! options.rowResizer;
                        ns.getSubNode("FHANDLER", rid).css("display", (options.rowResizer = t) ? "block" : "none")
                    }
                    if ("hidden" in options) {
                        var b = !! options.hidden;
                        if (b) {
                            if (orow.hidden !== true) {
                                ns.getSubNode("ROW", rid).css("display", "none")
                            }
                        } else {
                            if (orow.hidden === true) {
                                ns.getSubNode("ROW", rid).css("display", "")
                            }
                        }
                    }
                    _.merge(orow, options, "all")
                }
            } else {
                var rst = ns.get(0).queryItems(ns.getRows(), function (o) {
                    return typeof o == "object" ? o.id === rowId : o == rowId
                }, true, true, true);
                if (rst.length) {
                    _.merge(rst[0][0], options, "all")
                }
            }
            return ns
        },
        insertRows: function (arr, pid, base, before) {
            var affectUI = arguments[4],
                c = this.constructor,
                profile = this.get(0);
            if (arr && _.isArr(arr) && arr.length > 0) {
                var pro = profile.properties,
                    row_m = profile.rowMap2,
                    b = profile.rowMap,
                    tar, t, k;
                pid = row_m[pid];
                base = row_m[base];
                if (base) {
                    t = profile.rowMap[base];
                    if (t) {
                        pid = t._pid
                    }
                }
                arr = c._adjustRows(arr);
                if (!pid) {
                    tar = (pro.rows || (pro.rows = []))
                } else {
                    k = b[pid];
                    tar = _.isArr(k.sub) ? k.sub : (k.sub = [])
                }
                var rows;
                if (profile.renderId) {
                    if (!pid || k._inited) {
                        rows = c._prepareItems(profile, arr, pid);
                        this._insertRowsToDom(profile, rows, pid, base, before)
                    }
                }
                if (!base) {
                    _.arr.insertAny(tar, arr, before ? 0 : -1)
                } else {
                    var index = _.arr.subIndexOf(tar, "_serialId", base);
                    _.arr.insertAny(tar, arr, before ? index : (index + 1))
                }
                if (profile.renderId) {
                    if (!pro.iniFold) {
                        profile.boxing()._toggleRows(rows, true)
                    }
                    profile.box._asy(profile)
                }
            }
            if (affectUI !== false && profile.renderId && profile.__hastmpRow) {
                profile.box.__ensurehotrow(profile, null)
            }
            return this
        },
        removeRows: function (ids) {
            var affectUI = arguments[1],
                self = this,
                profile = self.get(0),
                p = profile.properties,
                cell = profile.cellMap,
                nodes = [],
                v, count = 0;
            ids = _.isArr(ids) ? ids : [ids];
            _.arr.each(ids, function (id) {
                if (!(id = profile.rowMap2[id])) {
                    return
                }
                count++;
                var row;
                if (row = profile.rowMap[id]) {
                    var tdids = row._cells,
                        rowid = row.id,
                        temp;
                    if (row.sub && _.isArr(row.sub)) {
                        var arr = [];
                        _.arr.each(row.sub, function (o) {
                            arr.push(o.id)
                        });
                        self.removeRows(arr)
                    }
                    _.each(tdids, function (o, i) {
                        delete cell[o]._col._cells[rowid];
                        _.breakO(cell[o]);
                        delete cell[o];
                        profile.reclaimSubId(o.slice(2), "cell")
                    });
                    if (temp = row._pid ? (temp = profile.rowMap[row._pid]) ? temp.sub : null : profile.properties.rows) {
                        if (_.isArr(temp)) {
                            _.filter(temp, function (o) {
                                return o._serialId != id
                            })
                        }
                    }
                    delete profile.rowMap2[rowid];
                    _.breakO(profile.rowMap[id]);
                    delete profile.rowMap[id];
                    nodes.push(profile.getSubNode("ROW", id).get(0))
                }
                profile.reclaimSubId(id.slice(2), "row")
            });
            if (count > 0) {
                if (v = p.$UIvalue) {
                    if ((v = ("" + v).split(p.valueSeparator)).length > 1) {
                        _.filter(v, function (o) {
                            return _.arr.indexOf(ids, o) == -1
                        });
                        p.$UIvalue = v.join(p.valueSeparator)
                    } else {
                        if (_.arr.indexOf(ids, p.$UIvalue) != -1) {
                            p.$UIvalue = null
                        }
                    }
                }
                xui(nodes).remove();
                if (profile.$activeCell && !xui.Dom.byId(profile.$activeCell)) {
                    delete profile.$activeCell
                }
                if (profile.$activeRow && !xui.Dom.byId(profile.$activeRow)) {
                    delete profile.$activeRow
                }
                delete profile.$allrowscache;
                profile.box._asy(profile)
            }
            if (affectUI !== false && profile.renderId && profile.__hastmpRow) {
                profile.box.__ensurehotrow(profile, null)
            }
            return self
        },
        removeAllRows: function () {
            var affectUI = arguments[0],
                profile = this.get(0),
                prop = profile.properties;
            if (!prop.rows || prop.rows.length < 0) {
                return this
            }
            for (var i in profile.cellMap) {
                profile.reclaimSubId(i.slice(2), "cell")
            }
            for (var i in profile.rowMap) {
                profile.reclaimSubId(i.slice(2), "row")
            }
            _.each(profile.colMap, function (o) {
                o._cells = {}
            });
            _.breakO([profile.rowMap, profile.cellMap], 3);
            profile.rowMap = {};
            profile.cellMap = {};
            profile.rowMap2 = {};
            delete profile.$activeCell;
            delete profile.$activeRow;
            profile.properties.rows.length = 0;
            if (profile.renderId) {
                profile.getSubNode("BODY").empty();
                profile.getSubNode("SCROLL").scrollTop(0).scrollLeft(0);
                if (profile.$sl != 0) {
                    profile.getSubNode("HEADER").get(0).scrollLeft = profile.$sl = 0
                }
            }
            delete profile.$allrowscache;
            profile.properties.$UIvalue = null;
            if (affectUI !== false && profile.renderId && profile.__hastmpRow) {
                profile.box.__ensurehotrow(profile, null)
            }
            return this
        },
        resetRowValue: function (rowId) {
            var profile = this.get(0),
                row = this.getRowbyRowId(rowId),
                arr = [],
                prop = profile.properties;
            _.arr.each(row.cells, function (o) {
                if (o._oValue !== o.value) {
                    o._oValue = o.value;
                    delete o.dirty;
                    if (prop.dirtyMark) {
                        arr.push(profile.getSubNode("CELLA", o._serialId).get(0))
                    }
                }
            });
            if (prop.dirtyMark && prop.showDirtyMark) {
                xui(arr).removeClass("xui-ui-dirty")
            }
        },
        resetColValue: function (colId) {
            var profile = this.get(0),
                col = this.getHeaderByColId(colId),
                arr = [],
                prop = profile.properties;
            _.arr.each(col.cells, function (o) {
                if (o._oValue !== o.value) {
                    o._oValue = o.value;
                    delete o.dirty;
                    if (prop.dirtyMark) {
                        arr.push(profile.getSubNode("CELLA", o._serialId).get(0))
                    }
                }
            });
            if (prop.dirtyMark && prop.showDirtyMark) {
                xui(arr).removeClass("xui-ui-dirty")
            }
        },
        getActiveRow: function () {
            var ar, profile = this.get(0);
            if (profile.properties.activeMode != "row") {
                return
            }
            if (!(ar = profile.$activeRow)) {
                return
            }
            ar = profile.rowMap[profile.getSubId(ar)];
            if (ar && ar.id && ar.id == profile.box._temprowid) {
                ar = null
            }
            return ar
        },
        setActiveRow: function (rowId) {
            var dr, row, profile = this.get(0);
            if (profile.properties.activeMode != "row") {
                return
            }
            profile.box._activeRow(profile, false);
            if (!(row = this.getRowbyRowId(rowId))) {
                return
            }
            if (!(dr = profile.getSubNode("CELLS", row._serialId)).isEmpty()) {
                profile.box._activeRow(profile, dr.get(0).id)
            }
            return this
        },
        getHeader: function (type) {
            var v = this.get(0).properties.header;
            if (type == "data") {
                return _.clone(v, true)
            } else {
                if (type == "min") {
                    var a = _.clone(v, true),
                        b;
                    _.arr.each(a, function (o, i) {
                        a[i] = o.id
                    });
                    return a
                } else {
                    return v
                }
            }
        },
        getHeaderByColId: function (colId, type) {
            var v = this.get(0).properties.header,
                i = _.arr.subIndexOf(v, "id", colId);
            return i == -1 ? null : type == "data" ? _.clone(v[i], true) : type == "min" ? v[i].id : v[i]
        },
        getHeaderByCell: function (cell, type) {
            var v = cell._col;
            return !v ? null : type == "data" ? _.clone(v, true) : type == "min" ? v.id : v
        },
        updateHeader: function (colId, options) {
            var ns = this,
                colh = ns.getHeaderByColId(colId);
            if (colh) {
                var hid = colh._serialId,
                    t, tt;
                if (typeof options != "object") {
                    options = {
                        caption: options + ""
                    }
                } else {
                    _.filter(options, true)
                }
                delete options.id;
                if (t = options.width) {
                    var n = [];
                    n.push(ns.getSubNode("HCELL", hid).get(0));
                    _.each(colh._cells, function (o) {
                        n.push(ns.getSubNode("CELL", o).get(0))
                    });
                    xui(n).width(t);
                    ns.constructor._ajdustBody(ns.get(0))
                }
                if (t = options.headerStyle) {
                    (tt = ns.getSubNode("HCELLA", hid)).attr("style", tt.attr("style") + ";" + t)
                }
                if (t = options.headerClass) {
                    ns.getSubNode("HCELLA", hid).addClass(t)
                }
                if (options.hasOwnProperty("caption")) {
                    ns.getSubNode("HCELLCAPTION", hid).get(0).innerHTML = options.caption
                }
                if ("colResizer" in options) {
                    t = !! options.colResizer;
                    ns.getSubNode("HHANDLER", hid).css("display", (options.colResizer = t) ? "block" : "none")
                }
                if (options.hasOwnProperty("visibility") && !options.hasOwnProperty("hidden")) {
                    options.hidden = !options.visibility
                }
                if ("hidden" in options) {
                    var b = !! options.hidden;
                    if (b) {
                        if (colh.hidden !== true) {
                            ns.showColumn(colId, false)
                        }
                    } else {
                        if (colh.hidden === true) {
                            ns.showColumn(colId, true)
                        }
                    }
                }
                _.merge(colh, options, "all")
            }
            return ns
        },
        showColumn: function (colId, flag) {
            var profile = this.get(0),
                map = profile.colMap2,
                cols = profile.colMap,
                col, sid, cells, n = [];
            if (col = cols[sid = map[colId]]) {
                if (profile.beforeColShowHide && false === profile.boxing().beforeColShowHide(profile, colId, flag)) {
                    return false
                }
                n.push(profile.getSubNode("HCELL", sid).get(0));
                _.each(col._cells, function (id) {
                    n.push(profile.getSubNode("CELL", id).get(0))
                });
                xui(n).css("display", (col.hidden = (flag === false ? true : false)) ? "none" : "");
                if (profile.afterColShowHide) {
                    profile.boxing().afterColShowHide(profile, colId, flag)
                }
            }
            profile.box._ajdustBody(profile);
            return true
        },
        sortColumn: function (colId, desc, sortby) {
            var prf = this.get(0),
                sId = prf.colMap2[colId],
                col = prf.colMap[sId];
            if (sId && col) {
                if (_.isBool(desc)) {
                    col._order = !desc
                }
                if (_.isFun(sortby)) {
                    col.sortby = sortby
                }
                prf.getSubNode("HCELLA", sId).onClick()
            }
            return this
        },
        getCell: function (cellId, type) {
            var self = this,
                profile = this.get(0),
                v;
            _.each(profile.cellMap, function (o) {
                if (o.id && o.id === cellId) {
                    cellId = o._serialId;
                    return false
                }
            });
            v = profile.cellMap[cellId];
            return !v ? null : type == "data" ? _.merge({
                rowId: v._row.id,
                colId: v._col.id
            }, _.clone(v, true)) : type == "min" ? v.value : v
        },
        getCellbyRowCol: function (rowId, colId, type) {
            var profile = this.get(0),
                v;
            v = _.get(profile.rowMap, [profile.rowMap2[rowId], "_cells", colId]);
            v = v && profile.cellMap[v];
            return !v ? null : type == "data" ? _.merge({
                rowId: v._row.id,
                colId: v._col.id
            }, _.clone(v, true)) : type == "min" ? v.value : v
        },
        getCells: function (rowId, colId, type) {
            var map = {};
            _.each(this.get(0).cellMap, function (v) {
                if ((rowId ? (rowId == v._row.id) : 1) && (colId ? (colId == v._col.id) : 1)) {
                    map[v.id] = type == "data" ? _.merge({
                        rowId: v._row.id,
                        colId: v._col.id
                    }, _.clone(v, true)) : type == "min" ? v.value : v
                }
            });
            return map
        },
        updateCellByRowCol: function (rowId, colId, options, dirtyMark, triggerEvent) {
            var t, self = this,
                con = self.constructor;
            if (t = con._getCellId(self.get(0), rowId, colId)) {
                con._updCell(self.get(0), t, options, dirtyMark, triggerEvent)
            }
            return self
        },
        updateCell: function (cellId, options, dirtyMark, triggerEvent) {
            var self = this,
                profile = this.get(0);
            _.each(profile.cellMap, function (o) {
                if (o.id && o.id === cellId) {
                    cellId = o._serialId;
                    return false
                }
            });
            self.constructor._updCell(profile, cellId, options, dirtyMark, triggerEvent);
            return self
        },
        editCellbyRowCol: function (rowId, colId) {
            var profile = this.get(0),
                con = profile.box;
            con._editCell(profile, con._getCellId(profile, rowId, colId));
            return this
        },
        editCell: function (cell) {
            this.constructor._editCell(this.get(0), cell);
            return this
        },
        focusCellbyRowCol: function (rowId, colId) {
            var profile = this.get(0),
                con = profile.box,
                cellId = con._getCellId(profile, rowId, colId);
            profile.getSubNode("CELLA", cellId).focus(true);
            return this
        },
        focusCell: function (cell) {
            var cellId = cell._serialId;
            this.get(0).getSubNode("CELLA", cellId).focus(true);
            return this
        },
        getActiveCell: function () {
            var ar, profile = this.get(0);
            if (profile.properties.activeMode != "cell") {
                return
            }
            if (!(ar = profile.$activeCell)) {
                return
            }
            return profile.cellMap[profile.getSubId(ar)]
        },
        setActiveCell: function (rowId, colId) {
            var dr, cell, profile = this.get(0);
            if (profile.properties.activeMode != "cell") {
                return
            }
            profile.box._activeCell(profile, false);
            if (typeof rowId == "object") {
                cell = rowId
            } else {
                cell = this.getCellbyRowCol(rowId, colId)
            }
            if (!cell) {
                return
            }
            if (!(dr = profile.getSubNode("CELL", cell._serialId)).isEmpty()) {
                profile.box._activeCell(profile, dr.get(0).id)
            }
            return this
        },
        resetGridValue: function () {
            return this.each(function (profile) {
                var prop = profile.properties;
                _.each(profile.cellMap, function (v) {
                    v._oValue = v.value;
                    delete v.dirty
                });
                if (prop.dirtyMark && prop.showDirtyMark) {
                    profile.getSubNode("CELLA", true).removeClass("xui-ui-dirty")
                }
            })
        },
        getDirtied: function (rowId, colId) {
            var map = {};
            _.each(this.get(0).cellMap, function (v) {
                if (v._oValue !== v.value && (rowId ? (rowId == v._row.id) : 1) && (colId ? (colId == v._col.id) : 1)) {
                    map[v.id] = {
                        rowId: v._row.id,
                        colId: v._col.id,
                        value: v.value,
                        _oValue: v._oValue
                    }
                }
            });
            return map
        },
        getSubNodeInGrid: function (key, rowId, colId) {
            var ns = this,
                t = (rowId && colId) ? ns.getCellbyRowCol(rowId, colId) : colId ? ns.getHeaderByColId(colId) : rowId ? ns.getRowbyRowId(rowId) : null;
            return ns.getSubNode(key, (t && t._serialId) || true)
        },
        offEditor: function () {
            var profile = this.get(0),
                editor;
            if (profile && profile.$curEditor) {
                editor = profile.$curEditor;
                _.tryF(editor.undo, [], editor)
            }
        },
        adjustEditor: function (adjustFun) {
            var ns = this,
                prf = this.get(0);
            if (prf && prf.$curEditor) {
                var editor = prf.$curEditor,
                    cell = prf.$cellInEditor;
                if (typeof adjustFun == "function") {
                    adjustFun.apply(ns, [editor, cell])
                } else {
                    if (editor.KEY == "xui.UI.ComboInput") {
                        var cellNode = prf.getSubNode("CELL", cell.id),
                            absPos = cellNode.offset(null, prf.getSubNode("SCROLL")),
                            size = cellNode.cssSize();
                        editor.setLeft(absPos.left - 1).setTop(absPos.top - 1).setWidth(size.width + 3).setHeight(size.height + 2).reLayout(true)
                    }
                }
            }
            return ns
        }
    },
    Initialize: function () {
        this.addTemplateKeys(["ALT", "PROGRESS"]);
        this.getCellPro = this.getCellOption
    },
    Static: {
        Templates: {
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            BORDER: {
                tagName: "div",
                BOX: {
                    tagName: "div",
                    HEADER: {
                        $order: 0,
                        tagName: "div",
                        style: "{showHeader}",
                        HI: {
                            tagName: "div",
                            HCELLS: {
                                tagName: "div",
                                style: "{headerHeight};",
                                HFCELL: {
                                    $order: 0,
                                    style: "{rowHandlerDisplay};{_row0DfW};",
                                    className: "{cellCls}",
                                    HCELLA: {
                                        style: "{firstCellStyle};",
                                        className: "{firstCellClass}",
                                        HHANDLER: {
                                            tagName: "div",
                                            style: "{colDDDisplay}"
                                        },
                                        FHANDLER: {
                                            tagName: "div",
                                            style: "{rowDDDisplay}"
                                        },
                                        HFMARK: {
                                            className: "xui-uicmd-check",
                                            style: "{_rowMarkDisplay}"
                                        },
                                        GRIDCAPTION: {
                                            $order: 2,
                                            text: "{gridHandlerCaption}"
                                        },
                                        SORT: {
                                            style: "{sortDisplay}"
                                        }
                                    }
                                },
                                OTHERHCELLS: {
                                    $order: 1,
                                    tagName: "text",
                                    text: "{header}"
                                }
                            }
                        }
                    },
                    SCROLL: {
                        $order: 1,
                        tagName: "div",
                        className: "xui-uibg-base ",
                        BODY: {
                            tagName: "div",
                            text: "{rows}"
                        }
                    },
                    FOOTER: {
                        $order: 2
                    },
                    COLLIST: {
                        tagName: "div"
                    },
                    ARROW: {}
                }
            },
            $submap: {
                header: {
                    HCELL: {
                        style: "width:{width}px;{colDisplay};",
                        className: "{cellCls}",
                        HCELLA: {
                            className: "{headerClass}",
                            style: "{headerStyle}",
                            HCELLCAPTION: {
                                text: "{caption}"
                            },
                            SORT: {
                                style: "{sortDisplay}"
                            },
                            HHANDLER: {
                                $order: 2,
                                tagName: "div",
                                style: "{colDDDisplay}"
                            }
                        }
                    }
                },
                rows: {
                    ROW: {
                        tagName: "div",
                        style: "{rowDisplay}",
                        PREVIEW: {
                            $order: 1,
                            tagName: "div",
                            style: "{previewDisplay}",
                            text: "{preview}"
                        },
                        CELLS: {
                            $order: 2,
                            tagName: "div",
                            className: "{rowCls} {rowClass}",
                            style: "height:{rowHeight}px;{rowStyle}",
                            FCELL: {
                                $order: 0,
                                style: "{rowHandlerDisplay};{_row0DfW};",
                                className: "{cellCls}",
                                CELLA: {
                                    tabindex: "{_tabindex}",
                                    style: "{cellStyle}{firstCellStyle}",
                                    className: "{cellClass}{firstCellClass}",
                                    ROWLRULER: {
                                        style: "{_treeMode};width:{_rulerW}px"
                                    },
                                    ROWTOGGLE: {
                                        $order: 2,
                                        style: "{_treeMode};",
                                        className: "{subClass}"
                                    },
                                    FHANDLER: {
                                        tagName: "div",
                                        style: "{rowDDDisplay}"
                                    },
                                    FCELLINN: {
                                        $order: 3,
                                        ROWNUM: {},
                                        FCELLCAPTION: {
                                            $order: 1,
                                            text: "{caption}"
                                        }
                                    },
                                    MARK: {
                                        $order: 1,
                                        style: "{_rowMarkDisplay}"
                                    }
                                }
                            },
                            OTHERCELLS: {
                                tagName: "text",
                                $order: 1,
                                text: "{cells}"
                            }
                        },
                        SUB: {
                            $order: 3,
                            tagName: "div"
                        },
                        SUMMARY: {
                            $order: 4,
                            tagName: "div",
                            style: "{summaryDisplay}",
                            text: "{summary}"
                        }
                    }
                },
                "rows.cells": function (profile, template, v, tag, result) {
                    var me = arguments.callee,
                        map = me._m || (me._m = {
                            checkbox: ".checkbox",
                            button: ".button",
                            progress: ".progress"
                        });
                    xui.UI.$doTemplate(profile, template, v, tag + (map[v.type] || ".input"), result)
                },
                "rows.cells.input": {
                    CELL: {
                        style: "width:{width}px;{cellDisplay};",
                        className: "{cellCls}",
                        CELLA: {
                            className: "{cellClass}",
                            style: "{bgcolor};{color};{cellStyle}",
                            tabindex: "{_tabindex}",
                            text: "{caption}"
                        }
                    }
                },
                "rows.cells.button": {
                    CELL: {
                        style: "width:{width}px;{cellDisplay};",
                        className: "{cellCls}",
                        CELLA: {
                            tagName: "button",
                            className: "{cellClass}",
                            style: "{cellStyle}",
                            tabindex: "{_tabindex}",
                            text: "{caption}"
                        }
                    }
                },
                "rows.cells.checkbox": {
                    CELL: {
                        style: "width:{width}px;{cellDisplay}",
                        className: "{cellCls}",
                        CELLA: {
                            className: "{cellClass}",
                            style: "{cellStyle}",
                            tabindex: "{_tabindex}",
                            CHECKBOX: {
                                className: "{checkboxCls}"
                            }
                        }
                    }
                },
                "rows.cells.progress": {
                    CELL: {
                        style: "width:{width}px;{cellDisplay}",
                        className: "{cellCls}",
                        CELLA: {
                            className: "{cellClass}",
                            style: "{cellStyle}",
                            tabindex: "{_tabindex}",
                            PROGRESS: {
                                tagName: "div",
                                style: "width:{progress};",
                                text: "{caption}"
                            }
                        }
                    }
                }
            }
        },
        Appearances: {
            KEY: {
                display: "block",
                position: "absolute",
                overflow: "hidden"
            },
            BOX: {
                display: "block",
                position: "relative",
                overflow: "hidden"
            },
            HEADER: {
                background: xui.UI.$bg("head.gif", "#CAE3FF repeat-x left top"),
                position: "relative",
                overflow: "hidden"
            },
            HI: {
                position: "relative"
            },
            SCROLL: {
                overflow: "auto",
                position: "relative"
            },
            ARROW: {
                position: "absolute",
                "z-index": "20",
                left: 0,
                top: 0,
                display: "none",
                width: "14px",
                height: "18px",
                background: xui.UI.$bg("icons.gif", "no-repeat -72px -270px", true)
            },
            COLLIST: {
                position: "absolute",
                "z-index": "10",
                left: 0,
                top: 0,
                cursor: "pointer",
                visibility: "hidden",
                background: xui.UI.$bg("collist.gif", "#FFF1A0 no-repeat center bottom"),
                border: "1px solid",
                "border-color": "#fff #ACA899 #ACA899 #fff"
            },
            BODY: {
                overflow: "visible",
                position: "absolute",
                "background-color": "#fff",
                "padding-bottom": "1px",
                left: 0,
                top: "0",
                "font-size": 0,
                "line-height": 0
            },
            "SORT, SORT-checked": {
                width: "16px",
                height: "16px"
            },
            SORT: {
                background: xui.UI.$bg("icons.gif", "no-repeat -110px -220px", true),
                position: "absolute",
                right: "2px",
                bottom: "2px"
            },
            "HCELL-mouseover SORT": {
                $order: 1,
                "background-position": "-110px -240px"
            },
            "HCELL-mousedown SORT": {
                $order: 2,
                "background-position": "-110px -260px"
            },
            "SORT-checked": {
                $order: 3,
                "background-position": "-130px -220px"
            },
            "HCELL-mouseover SORT-checked": {
                $order: 4,
                "background-position": "-130px -240px"
            },
            "HCELL-mousedown SORT-checked": {
                $order: 5,
                "background-position": "-130px -260px"
            },
            HHANDLER: {
                position: "absolute",
                background: xui.browser.ie ? "url(" + xui.ini.img_bg + ")" : null,
                width: "4px",
                top: "0",
                right: "0",
                height: "100%",
                cursor: "e-resize",
                "font-size": 0,
                "line-height": 0
            },
            "HCELLS, CELLS": {
                "overflow-y": xui.browser.ie ? "hidden" : "",
                position: "relative",
                "white-space": "nowrap",
                "font-size": "12px",
                "line-height": "18px"
            },
            HCELLS: {
                "padding-bottom": "2px"
            },
            CELLS: {
                "border-bottom": "1px solid #A2BBD9",
                overflow: "visible"
            },
            "CELLS-group": {
                $order: 1,
                "border-right": "1px solid #A2BBD9"
            },
            "CELLS-group FCELL": {
                "border-right": 0,
                "padding-right": "1px",
                overflow: "visible"
            },
            "CELLS-group FCELLCAPTION, CELLS-group CELLA, CELLS-group FCELLINN": {
                "font-weight": "bold",
                color: "#3764A0",
                overflow: "visible"
            },
            "PREVIEW,SUMMARY": {
                position: "relative",
                display: "none",
                "padding-left": "16px",
                "border-right": "1px solid #A2BBD9"
            },
            PREVIEW: {
                $order: 4,
                "border-bottom": "1px solid #A2BBD9"
            },
            SUMMARY: {
                $order: 4,
                "border-bottom": "1px solid #A2BBD9"
            },
            "CELLS-mouseover": {
                $order: 4,
                "background-color": "#DFE8F6"
            },
            "CELLS-readonly CELLA": {
                $order: 5,
                color: "#808080"
            },
            "CELL-readonly CELLA": {
                $order: 6,
                color: "#808080"
            },
            "CELLS-disabled": {
                $order: 7,
                "background-color": "#EBEADB"
            },
            "CELLS-disabled CELLA": {
                $order: 7,
                color: "#808080"
            },
            "CELL-disabled": {
                $order: 8,
                "background-color": "#EBEADB"
            },
            "CELL-disabled CELLA": {
                $order: 8,
                color: "#808080"
            },
            "CELLS-active, CELL-active": {
                $order: 5,
                "background-color": "#A3BAE9"
            },
            "CELLS-hot": {
                $order: 6,
                "background-color": "#FFE97F"
            },
            "CELLS-checked, CELL-checked, CELLS-checked CELLA, CELL-checked CELLA": {
                $order: 6,
                "background-color": "#7199E8",
                color: "#fff"
            },
            "FCELL CELLA": {
                "text-align": "left"
            },
            "HFCELL HCELLA": {
                "text-align": "center"
            },
            FHANDLER: {
                position: "absolute",
                height: "4px",
                left: "0px",
                width: "100%",
                bottom: "0px",
                cursor: "n-resize",
                "z-index": 10,
                "font-size": 0,
                "line-height": 0
            },
            "FCELLCAPTION, FCELLINN": {
                "vertical-align": "middle",
                overflow: "hidden"
            },
            "HFCELL, HCELL": {
                background: xui.UI.$bg("head.gif", "#CAE3FF repeat-x left top"),
                height: "100%",
                "border-left": "1px solid #fff",
                "border-top": "1px solid #fff",
                "border-right": "1px solid #A2BBD9",
                "border-bottom": "1px solid #A2BBD9",
                padding: 0,
                "vertical-align": "top",
                "font-size": "12px",
                "line-height": "14px"
            },
            "HFCELL-mouseover, HCELL-mouseover": {
                background: xui.UI.$bg("head_mouseover.gif", "#FFF1A0 repeat-x left top")
            },
            ROW: {
                position: "relative",
                zoom: xui.browser.ie ? 1 : null,
                width: xui.browser.ie ? "100%" : null,
                "font-size": 0,
                "line-height": 0
            },
            ROWNUM: {
                "padding-right": "6px",
                color: "#808080"
            },
            "FCELL, CELL": {
                "padding-left": "1px",
                "border-right": "1px solid #A2BBD9",
                height: "100%",
                position: "relative",
                overflow: xui.browser.ie6 ? "hidden" : "",
                "font-size": "12px",
                "line-height": "20px",
                "vertical-align": "top"
            },
            ALT: {
                "background-color": "#EFF8FF"
            },
            "CELL-label a": {
                color: "#000"
            },
            "CELL-input": {},
            "CELL-number, CELL-spin, CELL-currency": {
                "text-align": "right"
            },
            "CELL-checkbox": {
                "text-align": "center"
            },
            "CELL-button CELLA": {
                width: "100%"
            },
            "CELL-mouseover": {
                $order: 5,
                "background-color": "#DFE8F6"
            },
            "FCELL CELLA, HCELLA": {
                position: "relative"
            },
            HCELLA: {
                "text-align": "center"
            },
            "HCELLA, CELLA": {
                display: "block",
                overflow: "hidden",
                "-moz-box-flex": "1",
                "outline-offset": "-1px",
                "-moz-outline-offset": (xui.browser.gek && xui.browser.ver < 3) ? "-1px !important" : null,
                height: "100%",
                color: "#000",
                width: xui.browser.ie ? "100%" : "",
                "line-height": "20px"
            },
            "CELLA-inline": {
                $order: 5,
                display: xui.$inlineBlock,
                width: "auto",
                "-moz-box-flex": 0
            },
            PROGRESS: {
                height: "100%",
                "background-color": "#00ffff",
                "text-align": "center",
                "line-height": "22px",
                overflow: "visible",
                opacity: 0.7,
                "*filter": "alpha(opacity=70)"
            },
            "CHECKBOX, MARK": {
                cursor: "pointer",
                width: "16px",
                height: "16px",
                "vertical-align": "middle",
                background: xui.UI.$bg("icons.gif", "no-repeat -20px -70px", true)
            },
            "CELL-mouseover CHECKBOX": {
                $order: 1,
                "background-position": "-20px -90px"
            },
            "CELL-mousedown CHECKBOX": {
                $order: 2,
                "background-position": "-20px -110px"
            },
            "CHECKBOX-checked, CELLS-checked MARK": {
                $order: 3,
                "background-position": "0 -70px"
            },
            "CELL-mouseover CHECKBOX-checked": {
                $order: 4,
                "background-position": "0 -90px"
            },
            "CELL-mousedown CHECKBOX-checked": {
                $order: 5,
                "background-position": "0 -110px"
            },
            SUB: {
                zoom: xui.browser.ie ? 1 : null,
                height: 0,
                position: "relative",
                overflow: "hidden",
                "font-size": "1px",
                "line-height": "1px"
            }
        },
        _objectProp: {
            tagVar: 1,
            rowOptions: 1,
            colOptions: 1
        },
        Behaviors: {
            HoverEffected: {
                ROWTOGGLE: "ROWTOGGLE",
                HCELL: "HCELL",
                HFCELL: "HFCELL"
            },
            ClickEffected: {
                ROWTOGGLE: "ROWTOGGLE",
                CELL: "CELL",
                HCELL: "HCELL"
            },
            DroppableKeys: ["SCROLL", "CELLS", "ROWTOGGLE"],
            DraggableKeys: ["FCELL"],
            onSize: xui.UI.$onSize,
            HFMARK: {
                onClick: function (profile, e, src) {
                    if (profile.properties.selMode != "multi" && profile.properties.selMode != "multibycheckbox") {
                        return
                    }
                    var rows = [];
                    _.each(profile.rowMap, function (o) {
                        rows.push(o.id)
                    });
                    if (profile._$checkAll) {
                        delete profile._$checkAll;
                        profile.boxing().setUIValue("");
                        xui.use(src).tagClass("-checked", false);
                        profile.boxing().onRowSelected(profile, "allrows", e, src, -1)
                    } else {
                        profile._$checkAll = true;
                        xui.use(src).tagClass("-checked");
                        profile.boxing().setUIValue(rows.join(profile.properties.valueSeparator));
                        profile.boxing().onRowSelected(profile, "allrows", e, src, 1)
                    }
                    return false
                }
            },
            SCROLL: {
                onScroll: function (profile, e, src) {
                    var l = xui.use(src).get(0).scrollLeft || 0;
                    if (profile.$sl != l) {
                        profile.getSubNode("HEADER").get(0).scrollLeft = profile.$sl = l
                    }
                }
            },
            HHANDLER: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var p = profile.properties,
                        id = profile.getSubId(src);
                    col = profile.colMap[id];
                    if (col && "relWidth" in col) {
                        return
                    }
                    var o = xui(src),
                        minW = o.parent(2).width() - p._minColW,
                        scroll = profile.getSubNode("SCROLL"),
                        maxW = scroll.offset().left + scroll.width() - xui.Event.getPos(e).left - 4;
                    if (p.disabled) {
                        return false
                    }
                    if (col && col.disabled) {
                        return false
                    }
                    o.startDrag(e, {
                        horizontalOnly: true,
                        dragType: "blank",
                        dragDefer: 2,
                        maxLeftOffset: minW,
                        maxRightOffset: maxW,
                        targetReposition: false
                    });
                    xui.use(src).parent(2).onMouseout(true, {
                        $force: true
                    }).onMouseup(true)
                },
                onDragbegin: function (profile, e, src) {
                    xui.DragDrop.getProfile().proxyNode.css({
                        height: profile.getRoot().height() + "px",
                        width: "4px",
                        backgroundColor: "#ddd",
                        cursor: "e-resize"
                    })
                },
                onDrag: function (profile, e, src) {
                    var d = xui.DragDrop,
                        p = d.getProfile(),
                        b = 0;
                    if (p.x <= p.restrictedLeft || p.x >= p.restrictedRight) {
                        b = true
                    }
                    if (b) {
                        if (!profile._limited) {
                            p.proxyNode.css("backgroundColor", "#ff6600");
                            profile._limited = true
                        }
                    } else {
                        if (profile._limited) {
                            p.proxyNode.css("backgroundColor", "#ddd");
                            profile._limited = 0
                        }
                    }
                },
                onDragstop: function (profile, e, src) {
                    var o = xui(src).parent(2),
                        w = o.width() + xui.DragDrop.getProfile().offset.x,
                        col = profile.colMap[profile.getSubId(src)];
                    if (col) {
                        if ("maxWidth" in col) {
                            w = Math.min(col.maxWidth, w)
                        }
                        if ("minWidth" in col) {
                            w = Math.max(col.minWidth, w)
                        }
                    }
                    if (profile.beforeColResized && false === profile.boxing().beforeColResized(profile, col ? col.id : null, w)) {
                        profile._limited = 0;
                        return
                    }
                    o.width(w);
                    if (col) {
                        col.width = w
                    }
                    var ids = [],
                        ws = [];
                    if (profile.getKey(xui.use(src).parent(2).id()) == profile.keys.HFCELL) {
                        profile.box._setRowHanderW(profile, w)
                    } else {
                        var cells = profile.colMap[profile.getSubId(src)]._cells;
                        _.each(cells, function (o) {
                            ids.push(profile.getSubNode(profile.keys.CELL, o).id())
                        });
                        xui(ids).width(w)
                    }
                    if (profile.afterColResized) {
                        profile.boxing().afterColResized(profile, col ? col.id : null, w)
                    }
                    profile.getSubNode("SCROLL").onScroll();
                    profile.box._ajdustBody(profile);
                    profile._limited = 0
                },
                onClick: function () {
                    return false
                },
                onDblclick: function (profile, e, src) {
                    var p = profile.properties,
                        id = profile.getSubId(src);
                    col = profile.colMap[id];
                    if (col && "relWidth" in col) {
                        return
                    }
                    if (profile.getKey(xui.use(src).parent(2).id()) == profile.keys.HFCELL) {
                        profile.box._setRowHanderW(profile, true);
                        return
                    }
                    if (profile.getRootNode().clientHeight <= 0) {
                        return
                    }
                    var cells = col._cells,
                        cls = profile.getClass("CELLA", "-inline"),
                        n, ns = [],
                        ws = [],
                        w;
                    _.each(cells, function (o) {
                        n = profile.getSubNode("CELLA", o);
                        if (n._nodes.length) {
                            ns.push(n.get(0));
                            ws.push(n.addClass(cls).width())
                        }
                    });
                    ws.push(p._minColW);
                    w = parseInt(Math.max.apply(null, ws), 10);
                    if (w > p._maxColW) {
                        w = p._maxColW
                    }
                    if (profile.beforeColResized && false === profile.boxing().beforeColResized(profile, col ? col.id : null, w)) {
                        return
                    }
                    if (col) {
                        if ("maxWidth" in col) {
                            w = Math.min(col.maxWidth, w)
                        }
                        if ("minWidth" in col) {
                            w = Math.max(col.minWidth, w)
                        }
                    }
                    xui(ns).parent().width(w);
                    xui.use(src).parent(2).width(col.width = w);
                    xui(ns).removeClass(cls);
                    if (profile.afterColResized) {
                        profile.boxing().afterColResized(profile, col.id, w)
                    }
                    profile.box._ajdustBody(profile);
                    return false
                }
            },
            FHANDLER: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var p = profile.properties,
                        row = profile.rowMap[profile.getSubId(src)],
                        o = xui(src),
                        minH = o.parent(3).height() - p._minRowH,
                        scroll = profile.getSubNode("SCROLL"),
                        maxH = scroll.offset().top + scroll.height() - xui.Event.getPos(e).top - 4;
                    if (p.disabled || (row && row.disabled)) {
                        return false
                    }
                    o.startDrag(e, {
                        verticalOnly: true,
                        dragType: "blank",
                        dragDefer: 2,
                        maxTopOffset: minH,
                        maxBottomOffset: maxH,
                        targetReposition: false
                    });
                    xui.use(src).parent(2).onMouseout(true, {
                        $force: true
                    }).onMouseup(true)
                },
                onDragbegin: function (profile, e, src) {
                    xui.DragDrop.getProfile().proxyNode.css({
                        width: profile.getRoot().width() + "px",
                        height: "4px",
                        backgroundColor: "#ddd",
                        cursor: "n-resize"
                    })
                },
                onDrag: function (profile, e, src) {
                    var d = xui.DragDrop,
                        p = d.getProfile(),
                        b = 0;
                    if (p.y <= p.restrictedTop || p.y >= p.restrictedBottom) {
                        b = true
                    }
                    if (b) {
                        if (!profile._limited) {
                            p.proxyNode.css("backgroundColor", "#ff6600");
                            profile._limited = true
                        }
                    } else {
                        if (profile._limited) {
                            p.proxyNode.css("backgroundColor", "#ddd");
                            profile._limited = 0
                        }
                    }
                },
                onDragstop: function (profile, e, src) {
                    var o = xui(src).parent(3),
                        h = o.height() + xui.DragDrop.getProfile().offset.y,
                        row = profile.rowMap[profile.getSubId(src)];
                    if (xui.browser.ie && h % 2 == 1) {
                        h += 1
                    }
                    if (profile.beforeRowResized && false === profile.boxing().beforeRowResized(profile, row ? row.id : null, h)) {
                        profile._limited = 0;
                        return
                    }
                    o.height(h);
                    if (profile.getKey(xui.use(src).parent(2).id()) == profile.keys.HFCELL) {
                        profile.properties.headerHeight = h;
                        xui.UI.$tryResize(profile, profile.getRoot().width(), profile.getRoot().height(), true)
                    } else {
                        row.height = h
                    }
                    if (profile.afterRowResized) {
                        profile.boxing().afterRowResized(profile, row ? row.id : null, h)
                    }
                    profile._limited = 0
                },
                onDblclick: function (profile, e, src) {
                    var p = profile.properties,
                        sid = profile.getSubId(src),
                        row, cells;
                    if (profile.getRootNode().clientHeight <= 0) {
                        return
                    }
                    if (sid) {
                        row = profile.rowMap[sid];
                        cells = profile.getSubNode("CELLS", sid);
                        var h = cells.height("auto").height();
                        if (profile.beforeRowResized && false === profile.boxing().beforeRowResized(profile, row.id, h)) {
                            return
                        }
                        cells.height(row.height = h)
                    } else {
                        cells = profile.getSubNode("HCELLS");
                        var h = cells.height("auto").height();
                        if (profile.beforeRowResized && false === profile.boxing().beforeRowResized(profile, null, h)) {
                            return
                        }
                        cells.height(profile.properties.headerHeight = h);
                        xui.UI.$tryResize(profile, profile.getRoot().width(), profile.getRoot().height(), true)
                    }
                    if (profile.afterRowResized) {
                        profile.boxing().afterRowResized(profile, row ? row.id : null, h)
                    }
                    return false
                },
                onClick: function () {
                    return false
                }
            },
            ROWTOGGLE: {
                onClick: function (profile, e, src) {
                    var p = profile.properties,
                        row = profile.rowMap[profile.getSubId(src)];
                    if (p.disabled || row.disabled) {
                        return false
                    }
                    if (!row.sub) {
                        return
                    }
                    profile.box._setSub(profile, row, !row._checked);
                    return false
                }
            },
            HCELLA: {
                onClick: function (profile, e, src) {
                    var p = profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];
                    if (!col) {
                        if (profile.onClickGridHandler) {
                            profile.boxing().onClickGridHandler(profile, e, src)
                        }
                        if (p.disabled) {
                            return false
                        }
                        if (!p.colSortable) {
                            return
                        }
                    } else {
                        if (p.disabled || col.disabled) {
                            return false
                        }
                        if (!(col.hasOwnProperty("colSortable") ? col.colSortable : p.colSortable)) {
                            return
                        }
                    }
                    if (profile.beforeColSorted && false === profile.boxing().beforeColSorted(profile, col)) {
                        return
                    }
                    var order = (col ? col._order : profile._order) || false,
                        type = (col ? col.type : null) || "input",
                        sortby = col ? col.sortby : null,
                        index = col ? _.arr.indexOf(p.header, col) : -1,
                        me = arguments.callee,
                        fun = me.fun || (me.fun = function (profile, subNode, index, type, sortby, order, lastrownode) {
                            var rows, parent, self = arguments.callee;
                            if (subNode) {
                                rows = subNode.sub;
                                parent = profile.getSubNode("SUB", subNode._serialId).get(0)
                            } else {
                                subNode = {
                                    _inited: true
                                };
                                rows = profile.properties.rows;
                                parent = profile.getSubNode("BODY").get(0)
                            }
                            var a1 = [],
                                a2 = [],
                                a3 = [],
                                a4 = [],
                                t, ff;
                            _.arr.each(rows, function (row) {
                                if (row.sub && row.sub.length > 1) {
                                    self(profile, row, index, type, sortby, order, null)
                                }
                                a1[a1.length] = index == -1 ? row.caption : (t = row.cells) ? (t = t[index]) ? t.value : "" : row[index];
                                a4[a4.length] = index == -1 ? row : (t = row.cells) ? t[index] : row[index];
                                a2[a2.length] = a2.length
                            });
                            var sortf;
                            if (typeof sortby != "function") {
                                switch (type) {
                                case "number":
                                case "spin":
                                case "currency":
                                    ff = function (n) {
                                        return parseFloat(n) || 0
                                    };
                                    break;
                                case "datetime":
                                case "date":
                                    ff = function (n) {
                                        return _.isDate(n) ? n.getTime() : _.isFinite(n) ? parseInt(n, 10) : 0
                                    };
                                    break;
                                default:
                                    ff = function (n) {
                                        return n || ""
                                    }
                                }
                                sortf = function (x, y) {
                                    x = ff(a1[x]);
                                    y = ff(a1[y]);
                                    return (x > y ? 1 : x == y ? 0 : -1) * (order ? 1 : -1)
                                }
                            } else {
                                sortf = function (x, y) {
                                    return sortby.apply(profile, [x, y, a1, order, index, a4])
                                }
                            }
                            a2.sort(sortf);
                            var b = subNode._inited,
                                bak = _.copy(rows),
                                c;
                            if (b) {
                                a1 = parent.childNodes
                            }
                            _.arr.each(a2, function (o, i) {
                                rows[i] = bak[o];
                                if (b) {
                                    a3[i] = a1[o]
                                }
                            });
                            if (b) {
                                var fragment = document.createDocumentFragment();
                                for (var i = 0; t = a3[i]; i++) {
                                    fragment.appendChild(t)
                                }
                                if (lastrownode) {
                                    parent.insertBefore(fragment, lastrownode)
                                } else {
                                    parent.appendChild(fragment)
                                }
                            }
                        });
                    var lastrow, lastrownode;
                    if (profile.__hastmpRow) {
                        lastrow = profile.properties.rows.pop();
                        lastrownode = profile.getSubNode("BODY").get(0).lastChild
                    }
                    fun(profile, null, index, type, sortby, order, lastrownode);
                    if (profile.__hastmpRow) {
                        profile.properties.rows.push(lastrow)
                    }
                    profile.getSubNode("SORT", true).css("display", "none");
                    var node = (col ? profile.getSubNode("SORT", col._serialId) : profile.getSubNode("SORT")).css("display", "");
                    node.tagClass("-checked", col ? (!(col._order = !col._order)) : (!(profile._order = !profile._order)));
                    profile.box._asy(profile);
                    delete profile.$allrowscache;
                    if (profile.afterColSorted) {
                        profile.boxing().afterColSorted(profile, col)
                    }
                    return false
                },
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var p = profile.properties;
                    if (p.disabled) {
                        return
                    }
                    var col = profile.colMap[profile.getSubId(src)];
                    if (!col) {
                        return
                    }
                    if (p.disabled || col.disabled) {
                        return false
                    }
                    if (!(col.hasOwnProperty("colMovable") ? col.colMovable : p.colMovable)) {
                        return
                    }
                    if (false === profile.boxing().beforeColDrag(profile, col.id)) {
                        return
                    }
                    var pos = xui.Event.getPos(e),
                        o = xui(src),
                        itemId = profile.getSubId(src);
                    o.startDrag(e, {
                        dragType: "icon",
                        shadowFrom: o.parent(),
                        dragCursor: "pointer",
                        targetLeft: pos.left + 12,
                        targetTop: pos.top + 12,
                        targetReposition: false,
                        dragDefer: 2,
                        dragKey: profile.$xid + ":col",
                        dragData: o.parent().id()
                    })
                },
                onDragbegin: function (profile, e, src) {
                    xui(src).parent().onMouseout(true, {
                        $force: true
                    });
                    xui(src).onMouseup(true)
                },
                beforeMouseover: function (profile, e, src) {
                    var p = profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];
                    if (!col) {
                        return
                    }
                    if (p.disabled || col.disabled) {
                        return false
                    }
                    var dp = xui.DragDrop.getProfile();
                    if (!dp.dragData || dp.dragKey != profile.$xid + ":col") {
                        return
                    }
                    var psrc = xui.use(src).parent().xid();
                    if (false === profile.box._colDragCheck(profile, psrc)) {
                        return
                    }
                    xui.DragDrop.setDropElement(src).setDropFace(src, "move");
                    profile.getSubNode("ARROW").left(xui.use(psrc).get(0).offsetLeft - 8).top(xui.use(psrc).get(0).offsetHeight).css("display", "block")
                },
                beforeMouseout: function (profile, e, src) {
                    var p = profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];
                    if (!col) {
                        return
                    }
                    if (p.disabled || col.disabled) {
                        return false
                    }
                    var dp = xui.DragDrop.getProfile();
                    if (!dp.dragData || dp.dragKey != profile.$xid + ":col") {
                        return
                    }
                    var psrc = xui.use(src).parent().xid();
                    xui.DragDrop.setDropElement(null).setDropFace(null, "none");
                    if (false === profile.box._colDragCheck(profile, psrc)) {
                        return
                    }
                    profile.getSubNode("ARROW").css("display", "none")
                },
                onDrop: function (profile, e, src) {
                    var p = profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];
                    if (!col) {
                        return
                    }
                    if (p.disabled || col.disabled) {
                        return false
                    }
                    var psrc = xui.use(src).parent().xid();
                    profile.getSubNode("ARROW").css("display", "none");
                    if (false === profile.box._colDragCheck(profile, psrc)) {
                        return
                    }
                    var data = xui.DragDrop.getProfile().dragData,
                        fromId = data && profile.getSubId(data),
                        toId = profile.getSubId(psrc);
                    var map = profile.colMap,
                        fromTh = map[fromId],
                        toTh = map[toId];
                    if (false === profile.boxing().beforeColMoved(profile, fromTh.id, toTh.id)) {
                        return
                    }
                    xui.DragDrop.setDropFace(psrc, "none");
                    var fromIndex = _.arr.subIndexOf(p.header, "_serialId", fromId),
                        toIndex = _.arr.subIndexOf(p.header, "_serialId", toId);
                    if (fromIndex === toIndex || fromIndex === toIndex - 1) {
                        return
                    }
                    profile.getSubNode("HCELL", toId).addPrev(xui(xui.DragDrop.getProfile().dragData));
                    _.each(toTh._cells, function (o, i) {
                        profile.getSubNode("CELL", o).addPrev(profile.getSubNode("CELL", fromTh._cells[i]))
                    });
                    var temp = p.header[fromIndex];
                    _.arr.insertAny(p.header, temp, toIndex);
                    _.arr.removeFrom(p.header, fromIndex + (fromIndex > toIndex ? 1 : 0));
                    var allitems = profile.queryItems(p.rows, true, true);
                    _.arr.each(allitems, function (o) {
                        o = o.cells ? o.cells : o;
                        if (!o || o.constructor != Array) {
                            return
                        }
                        temp = o[fromIndex];
                        _.arr.removeFrom(o, fromIndex);
                        _.arr.insertAny(o, temp, toIndex)
                    });
                    profile.boxing().afterColMoved(profile, fromTh.id, toTh.id);
                    delete profile.$allrowscache
                },
                onMouseover: function (profile, e, src) {
                    var p = profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];
                    if (col) {
                        if (p.disabled || col.disabled) {
                            return false
                        }
                        if (!(col.hasOwnProperty("colHidable") ? col.colHidable : p.colHidable)) {
                            return
                        }
                    } else {
                        if (p.disabled) {
                            return false
                        }
                        if (!p.colHidable) {
                            return
                        }
                    }
                    _.resetRun(profile.$xid + ":collist", null);
                    var region = {},
                        pos = xui.use(src).parent().offset(null, profile.getSubNode("BOX")),
                        size = xui.use(src).parent().cssSize();
                    if (size.width < 16) {
                        return
                    }
                    region.height = size.height;
                    region.width = 14;
                    region.left = pos.left;
                    region.top = pos.top;
                    profile.getSubNode("COLLIST").cssRegion(region).css("visibility", "visible")
                },
                onMouseout: function (profile, e, src) {
                    var p = profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];
                    if (col) {
                        if (p.disabled || col.disabled) {
                            return false
                        }
                        if (!(col.hasOwnProperty("colHidable") ? col.colHidable : p.colHidable)) {
                            return
                        }
                    } else {
                        if (p.disabled) {
                            return false
                        }
                        if (!p.colHidable) {
                            return
                        }
                    }
                    _.resetRun(profile.$xid + ":collist", function () {
                        if (!profile.box) {
                            return
                        }
                        profile.getSubNode("COLLIST").css({
                            visibility: "hidden",
                            left: 0,
                            top: 0
                        })
                    })
                },
                onContextmenu: function (profile, e, src) {
                    if (profile.onContextmenu) {
                        var sid = profile.getSubId(src);
                        return profile.boxing().onContextmenu(profile, e, src, sid ? profile.colMap[sid] : null) !== false
                    }
                }
            },
            COLLIST: {
                onMouseover: function (profile, e, src) {
                    _.resetRun(profile.$xid + ":collist", null)
                },
                onMouseout: function (profile, e, src) {
                    _.resetRun(profile.$xid + ":collist", function () {
                        if (!profile.box) {
                            return
                        }
                        xui.use(src).css("visibility", "hidden")
                    })
                },
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (!profile.$col_pop) {
                        var items = [],
                            pop;
                        _.arr.each(profile.properties.header, function (o) {
                            if (o.hasOwnProperty("colHidable") ? o.colHidable : p.colHidable) {
                                items.push({
                                    id: o.id,
                                    caption: o.caption,
                                    type: "checkbox",
                                    value: o.hidden !== true
                                })
                            }
                        });
                        if (items.length) {
                            pop = profile.$col_pop = new xui.UI.PopMenu({
                                hideAfterClick: false,
                                items: items
                            }).render(true);
                            pop.onMenuSelected(function (p, i, s) {
                                var b = 1;
                                _.arr.each(p.properties.items, function (o) {
                                    if (o.value !== false) {
                                        return b = false
                                    }
                                });
                                if (!b) {
                                    profile.boxing().showColumn(i.id, i.value)
                                } else {
                                    p.getSubNodeByItemId("CHECKBOX", i.id).tagClass("-checked");
                                    i.value = true
                                }
                            })
                        }
                    }
                    if (profile.$col_pop) {
                        profile.$col_pop.pop(src)
                    }
                }
            },
            CELLS: {
                afterMouseover: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled) {
                        return
                    }
                    if (p.disableHoverEffect) {
                        return
                    }
                    if (p.activeMode == "row") {
                        xui.use(src).tagClass("-mouseover")
                    }
                },
                afterMouseout: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled) {
                        return
                    }
                    if (p.disableHoverEffect) {
                        return
                    }
                    if (p.activeMode == "row") {
                        xui.use(src).tagClass("-mouseover", false)
                    }
                },
                onDblclick: function (profile, e, src) {
                    var p = profile.properties,
                        row = profile.rowMap[profile.getSubId(src)];
                    if (p.disabled || row.disabled) {
                        return false
                    }
                    if (profile.onDblclickRow) {
                        profile.boxing().onDblclickRow(profile, row, e, src)
                    }
                    return false
                },
                onClick: function (profile, e, src) {
                    var p = profile.properties,
                        subid = profile.getSubId(src),
                        ks = profile.keys,
                        row = profile.rowMap[subid],
                        ck = profile.getKey(xui.Event.getSrc(e).id || "");
                    if (p.disabled || row.disabled) {
                        return false
                    }
                    if (ck == ks.ROWTOGGLE || ck == ks.MARK) {
                        return false
                    }
                    if (row.group) {
                        profile.getSubNode("ROWTOGGLE", row._serialId).onClick()
                    }
                }
            },
            CELL: {
                afterMouseover: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled) {
                        return
                    }
                    if (p.disableHoverEffect) {
                        return
                    }
                    if (p.activeMode == "cell") {
                        xui.use(src).tagClass("-mouseover")
                    }
                },
                afterMouseout: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled) {
                        return
                    }
                    if (p.disableHoverEffect) {
                        return
                    }
                    if (p.activeMode == "cell") {
                        xui.use(src).tagClass("-mouseover", false)
                    }
                }
            },
            CELLA: {
                onDblclick: function (profile, e, src) {
                    var cell = profile.cellMap[profile.getSubId(src)];
                    if (!cell) {
                        return
                    }
                    if (profile.properties.disabled) {
                        return
                    }
                    var box = profile.box,
                        getPro = box.getCellOption,
                        type = getPro(profile, cell, "type"),
                        disabled = getPro(profile, cell, "disabled"),
                        editable = getPro(profile, cell, "editable");
                    if (!disabled && (!editable || (type == "button" || type == "label"))) {
                        profile.boxing().onDblclickCell(profile, cell, e, src);
                        if (type == "button") {
                            return false
                        }
                    }
                },
                onClick: function (profile, e, src) {
                    var p = profile.properties,
                        box = profile.box,
                        getPro = box.getCellOption,
                        cell = profile.cellMap[profile.getSubId(src)],
                        id;
                    if (cell) {
                        if (profile.properties.disabled) {
                            return
                        }
                        var type = getPro(profile, cell, "type"),
                            disabled = getPro(profile, cell, "disabled"),
                            readonly = getPro(profile, cell, "readonly"),
                            event = getPro(profile, cell, "event"),
                            mode = p.activeMode,
                            editable = getPro(profile, cell, "editable");
                        if (!disabled && (!editable || (type == "button" || type == "label"))) {
                            if (typeof event == "function" && false === event.call(profile._host || profile, profile, cell, null, null, e, src)) {} else {
                                profile.boxing().onClickCell(profile, cell, e, src)
                            }
                            if (type == "button") {
                                return false
                            }
                        }
                        if (!disabled && !readonly && type == "checkbox") {
                            if (editable) {
                                box._updCell(profile, cell, !cell.value, p.dirtyMark, true);
                                profile.box._trycheckrowdirty(profile, cell);
                                var ishotrow = cell._row.id == profile.box._temprowid;
                                if (ishotrow) {
                                    profile.__needchecktmprow = true;
                                    profile.box._sethotrowoutterblur(profile)
                                }
                            }
                        }
                        if (!p.editable) {
                            if (mode == "cell") {
                                if (getPro(profile, cell, "disabled")) {
                                    return false
                                }
                                id = xui(src).parent().id();
                                box._sel(profile, "cell", src, id, e)
                            } else {
                                if (mode == "row") {
                                    if (p.disabled || cell._row.disabled) {
                                        return false
                                    }
                                    id = xui(src).parent(3).id();
                                    box._sel(profile, "row", src, id, e)
                                }
                            }
                        }
                    } else {
                        var row = profile.rowMap[profile.getSubId(src)];
                        if (p.disabled || row.disabled) {
                            return false
                        }
                        if (p.activeMode == "row") {
                            id = xui(src).parent(3).id();
                            box._sel(profile, "row", src, id, e)
                        }
                    }
                    if (profile.box) {
                        profile.box._focuscell(profile, e, src);
                        profile.$_focusbyclick = 1;
                        xui.use(src).focus();
                        delete profile.$_focusbyclick
                    }
                },
                onFocus: function (profile, e, src) {
                    var ins = profile.boxing(),
                        prop = profile.properties;
                    if (profile.$_focusbyclick) {
                        delete profile.$_focusbyclick
                    } else {
                        profile.box._focuscell(profile, e, src)
                    }
                    if (profile.afterCellFocused) {
                        var cell = profile.cellMap[profile.getSubId(src)],
                            row;
                        if (cell) {
                            row = cell._row
                        } else {
                            row = profile.rowMap[profile.getSubId(src)]
                        }
                        ins.afterCellFocused(profile, cell, row)
                    }
                    if (prop.hotRowMode != "none") {
                        var cell = profile.cellMap[profile.getSubId(src)],
                            row;
                        if (cell) {
                            row = cell._row
                        } else {
                            row = profile.rowMap[profile.getSubId(src)]
                        }
                        if (profile.__hastmpRow && profile.__needchecktmprow && row.id !== profile.box._temprowid) {
                            profile.box._checkNewLine(profile, "focuscell")
                        }
                    }
                },
                onKeydown: function (profile, e, src) {
                    var p = profile.properties,
                        keys = xui.Event.getKey(e),
                        key = keys.key,
                        shift = keys.shiftKey,
                        ctrl = keys.ctrlKey,
                        cur = xui(src),
                        body = profile.getSubNode("BODY"),
                        first = body.nextFocus(true, true, false),
                        last = body.nextFocus(false, true, false),
                        cell = profile.cellMap[profile.getSubId(src)],
                        row;
                    if (profile.beforeCellKeydown && false === profile.boxing().beforeCellKeydown(profile, cell, keys)) {
                        return false
                    }
                    switch (key) {
                    case "enter":
                        xui(src).onClick();
                        break;
                    case "tab":
                        if (shift) {
                            if (src != first.xid()) {
                                cur.nextFocus(false);
                                return false
                            }
                        } else {
                            if (src != last.xid()) {
                                cur.nextFocus();
                                return false
                            }
                        }
                        break;
                    case "left":
                        if (cur.get(0) == first.get(0)) {
                            last.focus()
                        } else {
                            cur.nextFocus(false)
                        }
                        return false;
                        break;
                    case "right":
                        if (cur.get(0) == last.get(0)) {
                            first.focus()
                        } else {
                            cur.nextFocus()
                        }
                        return false;
                        break;
                    case "up":
                        if (ctrl) {
                            if (cell) {
                                row = cell._row
                            } else {
                                row = profile.rowMap[profile.getSubId(src)]
                            }
                            if (row && !(p.disabled || row.disabled) && (row.group || row.sub)) {
                                profile.getSubNode("ROWTOGGLE", row._serialId).onClick();
                                return false
                            }
                        }
                        if (cur.get(0) == first.get(0)) {
                            last.focus();
                            return
                        }
                    case "down":
                        if (ctrl) {
                            if (cell) {
                                row = cell._row
                            } else {
                                row = profile.rowMap[profile.getSubId(src)]
                            }
                            if (row && !(p.disabled || row.disabled) && (row.group || row.sub)) {
                                profile.getSubNode("ROWTOGGLE", row._serialId).onClick();
                                return false
                            }
                        }
                        var count = 1,
                            temp = cur.parent().get(0),
                            max = temp.parentNode.childNodes.length;
                        while (temp = temp.previousSibling) {
                            count++
                        }
                        temp = cur.parent(2).get(0);
                        if (!profile.$allrowscache) {
                            profile.box._cacheRows(profile)
                        }
                        var index = _.arr.indexOf(profile.$allrowscache, temp),
                            rowLen = profile.$allrowscache.length,
                            newLine = 0;
                        if (key == "up") {
                            index--;
                            if (index == -1) {
                                index = rowLen - 1;
                                count--;
                                if (count == 0) {
                                    count = max
                                }
                            }
                        } else {
                            index++;
                            if (index == rowLen) {
                                newLine = 1;
                                index = 0;
                                count++;
                                if (count == max + 1) {
                                    count = 1
                                }
                            }
                        }
                        if (newLine && p.hotRowMode != "none") {
                            var colId;
                            if (!cell) {
                                var row = profile.rowMap[profile.getSubId(src)];
                                if (!row) {
                                    return false
                                }
                            } else {
                                colId = cell._col.id
                            }
                            var addhotrow = true,
                                cacheAll = profile.$allrowscache;
                            if (profile.__hastmpRow) {
                                addhotrow = profile.box._checkNewLine(profile, "keydown");
                                if (!profile.$allrowscache) {
                                    profile.box._cacheRows(profile)
                                }
                            }
                            if (addhotrow) {
                                profile.box._addTempRow(profile, colId);
                                return false
                            }
                        }
                        var node = xui(profile.$allrowscache[index]).first(),
                            node2 = node;
                        if (count > 1) {
                            node2 = node2.next(count - 1)
                        }
                        if (node2.isEmpty()) {
                            node2 = node
                        }
                        if (node2 && !node2.isEmpty()) {
                            node2 = node2.first()
                        }
                        if (!node2.isEmpty()) {
                            node2.focus()
                        }
                        return false;
                        break
                    }
                },
                onContextmenu: function (profile, e, src) {
                    if (profile.onContextmenu) {
                        var sid = profile.getSubId(src);
                        return profile.boxing().onContextmenu(profile, e, src, sid ? (profile.cellMap[sid] || profile.rowMap[sid]) : null) !== false
                    }
                }
            }
        },
        DataModel: {
            directInput: true,
            listKey: null,
            currencyTpl: "$ *",
            numberTpl: "",
            valueSeparator: ";",
            selMode: {
                ini: "none",
                listbox: ["single", "none", "multi", "multibycheckbox"],
                action: function (value) {
                    this.getSubNodes(["HFMARK", "MARK"], true).css("display", (value == "multi" || value == "multibycheckbox") ? "" : "none")
                }
            },
            dock: "fill",
            altRowsBg: {
                ini: false,
                action: function (value) {
                    var ns = this;
                    var altCls = ns.getClass("ALT"),
                        nodes = ns.getSubNode("CELLS", true),
                        alt, j;
                    nodes.removeClass(altCls);
                    if (value) {
                        alt = [];
                        j = 0;
                        nodes.each(function (o, i) {
                            if (o.clientHeight) {
                                o = xui([o]);
                                if ((j++) % 2 == 1) {
                                    if (!o.hasClass(altCls)) {
                                        o.addClass(altCls)
                                    }
                                } else {
                                    if (o.hasClass(altCls)) {
                                        o.removeClass(altCls)
                                    }
                                }
                            }
                        });
                        xui(alt).addClass(altCls)
                    }
                }
            },
            rowNumbered: {
                ini: false,
                action: function (value) {
                    var ns = this,
                        f = ns.CF.getNumberedStr ||
                    function (a) {
                        return a
                    }, nodes = ns.getSubNode("ROWNUM", true), i = 0, map = ns.rowMap, row, ol = 0, l = 0, a1 = [], a2 = [], tag = "", temp, t;
                    if (value) {
                        nodes.each(function (o) {
                            row = map[ns.getSubId(o.id)];
                            l = row._layer;
                            if (l > ol) {
                                a1.push(i);
                                a2.push(tag);
                                tag = tag + i + ".";
                                i = 0
                            } else {
                                if (l < ol) {
                                    while (l < ol--) {
                                        i = a1.pop();
                                        tag = a2.pop()
                                    }
                                }
                            }
                            i++;
                            ol = l;
                            row._autoNumber = f(tag + i);
                            temp = row.rowNumber || row._autoNumber;
                            if (t = o.firstChild) {
                                if (t.nodeValue != temp) {
                                    t.nodeValue = temp
                                }
                            } else {
                                o.appendChild(document.createTextNode(temp))
                            }
                        })
                    } else {
                        nodes.text("")
                    }
                }
            },
            editable: false,
            $subMargin: 16,
            iniFold: true,
            animCollapse: false,
            position: "absolute",
            width: 300,
            height: 200,
            _minColW: 5,
            _maxColW: 300,
            _minRowH: 20,
            gridHandlerCaption: {
                ini: "",
                action: function (v) {
                    v = (_.isSet(v) ? v : "") + "";
                    this.getSubNode("GRIDCAPTION").html(xui.adjustRes(v, true))
                }
            },
            rowHandlerWidth: {
                ini: 50,
                set: function (value) {
                    var o = this;
                    if (o.renderId) {
                        o.box._setRowHanderW(o, value)
                    } else {
                        o.properties.rowHandlerWidth = value
                    }
                }
            },
            showHeader: {
                ini: true,
                action: function (value) {
                    this.getSubNode("HEADER").css("display", value ? "" : "none")
                }
            },
            headerHeight: {
                ini: 18,
                action: function (v) {
                    this.getSubNode("HCELLS").height(v);
                    xui.UI.$tryResize(this, this.getRoot().width(), this.getRoot().height(), true)
                }
            },
            rowHeight: {
                ini: 20,
                action: function (v) {
                    this.getSubNode("CELLS", true).height(v)
                }
            },
            _colDfWidth: 80,
            rowHandler: {
                ini: true,
                action: function (value) {
                    this.getSubNode("HFCELL").css("display", value ? "" : "none");
                    this.getSubNode("FCELL", true).css("display", value ? "" : "none");
                    this.box._ajdustBody(this)
                }
            },
            rowResizer: {
                ini: false,
                action: function (value) {
                    this.getSubNode("FHANDLER", true).css("display", value ? "" : "none")
                }
            },
            colHidable: false,
            colResizer: {
                ini: true,
                action: function (value) {
                    this.getSubNode("HHANDLER", true).css("display", value ? "" : "none")
                }
            },
            colSortable: {
                ini: true,
                action: function (value) {
                    if (!value) {
                        this.getSubNode("SORT", true).css("display", "none")
                    }
                }
            },
            colMovable: false,
            header: {
                ini: {},
                set: function (value, ov) {
                    var o = this;
                    if (o.renderId) {
                        o.boxing()._refreshHeader(value)
                    } else {
                        o.properties.header = _.copy(value)
                    }
                }
            },
            rows: {
                ini: {},
                set: function (value) {
                    var o = this;
                    if (o.renderId) {
                        o.boxing().removeAllRows(false).insertRows(value)
                    } else {
                        o.properties.rows = _.copy(value)
                    }
                }
            },
            activeMode: {
                ini: "row",
                listbox: ["row", "cell", "none"],
                action: function (value) {
                    var profile = this;
                    if (value != "cell" && profile.$activeCell) {
                        xui(profile.$activeCell).tagClass("-active", false);
                        delete profile.$activeCell
                    }
                    if (value != "row" && profile.$activeRow) {
                        xui(profile.$activeRow).tagClass("-active", false);
                        delete profile.$activeRow
                    }
                }
            },
            rowOptions: {
                ini: {}
            },
            colOptions: {
                ini: {}
            },
            treeMode: {
                ini: true,
                action: function (value) {
                    this.getSubNodes(["ROWLRULER", "ROWTOGGLE"], true).css("display", value ? "" : "none")
                }
            },
            hotRowMode: {
                ini: "none",
                listbox: ["none", "show", "hide", "auto"],
                action: function (value) {
                    if (this.renderId) {
                        if (value == "none") {
                            this.boxing().removeHotRow()
                        } else {
                            this.box.__ensurehotrow(this, null)
                        }
                    }
                }
            },
            hotRowNumber: "[*]",
            noCtrlKey: true
        },
        EventHandlers: {
            beforeCellKeydown: function (profile, cell, keys) {},
            afterCellFocused: function (profile, cell, row) {},
            beforeInitHotRow: function (profile) {},
            onInitHotRow: function (profile) {},
            beforeHotRowAdded: function (profile, row, leaveGrid) {},
            afterHotRowAdded: function (profile, row) {},
            onGetContent: function (profile, row, callback) {},
            onRowSelected: function (profile, row, e, src, type) {},
            beforeColDrag: function (profile, colId) {},
            beforeColMoved: function (profile, colId, toId) {},
            afterColMoved: function (profile, colId, toId) {},
            beforeColSorted: function (profile, col) {},
            afterColSorted: function (profile, col) {},
            beforeColShowHide: function (profile, colId, flag) {},
            afterColShowHide: function (profile, colId, flag) {},
            beforeColResized: function (profile, colId, width) {},
            afterColResized: function (profile, colId, width) {},
            beforeRowResized: function (profile, rowId, height) {},
            afterRowResized: function (profile, rowId, height) {},
            beforeRowActive: function (profile, row) {},
            afterRowActive: function (profile, row) {},
            beforeCellActive: function (profile, cell) {},
            afterCellActive: function (profile, cell) {},
            beforeIniEditor: function (profile, cell, cellNode, pNode) {},
            onBeginEdit: function (profile, cell, editor) {},
            onEndEdit: function (profile, cell, editor) {},
            beforeCellUpdated: function (profile, cell, options, isHotRow) {},
            afterCellUpdated: function (profile, cell, options, isHotRow) {},
            onRowDirtied: function (profile, row) {},
            onDblclickRow: function (profile, row, e, src) {},
            onClickCell: function (profile, cell, e, src) {},
            onDblclickCell: function (profile, cell, e, src) {},
            onClickGridHandler: function (profile, e, src) {},
            beforeComboPop: function (profile, cell, proEditor, pos, e, src) {},
            beforePopShow: function (profile, cell, proEditor, popCtl) {},
            afterPopShow: function (profile, cell, proEditor, popCtl) {},
            onCommand: function (profile, cell, proEditor, src) {}
        },
        RenderTrigger: function () {
            var ns = this,
                pro = ns.properties,
                ins = ns.boxing();
            ns.destroyTrigger = function () {
                var ns = this,
                    pro = ns.properties;
                _.breakO([ns.colMap, ns.rowMap, ns.cellMap], 3);
                pro.header.length = 0;
                pro.rows.length = 0
            };
            if (!pro.iniFold) {
                ins._toggleRows(pro.rows, true)
            }
            ns.box._asy(ns);
            ns.box._ajdustBody(ns);
            ns.box.__ensurehotrow(ns, null)
        },
        __ensurehotrow: function (profile, focusColId) {
            var prop = profile.properties,
                box = profile.box,
                need = false;
            if (!box || !profile.renderId || prop.hotRowMode == "none") {
                return
            }
            if (profile.__hastmpRow) {
                var rows = profile.properties.rows;
                if (rows.length === 0 || rows[rows.length - 1].id != profile.box._temprowid) {
                    need = true
                }
            } else {
                need = true
            }
            if (need) {
                switch (prop.hotRowMode) {
                case "auto":
                    if (!prop.rows || prop.rows.length === 0) {
                        box._addTempRow(profile, focusColId)
                    }
                    break;
                case "show":
                    box._addTempRow(profile, focusColId);
                    break
                }
            }
        },
        _temprowid: "_ r _temp_",
        isHotRow: function (row) {
            return (row.id || row) === this._temprowid
        },
        _addTempRow: function (profile, focusColId) {
            var prop = profile.properties;
            if (prop.readonly || prop.disabled || !prop.header || prop.header.length <= 0) {
                return false
            }
            profile.box._sethotrowoutterblur(profile, true);
            delete profile.__hastmpRow;
            profile.boxing().removeRows([this._temprowid], false);
            if (profile.beforeInitHotRow && false === profile.boxing().beforeInitHotRow(profile)) {
                return false
            }
            profile.__needchecktmprow = true;
            var row = [],
                ins = profile.boxing();
            if (profile.onInitHotRow) {
                row = ins.onInitHotRow(profile)
            }
            if (_.isArr(row)) {
                row = {
                    cells: row
                }
            } else {
                if (!_.isHash(row)) {
                    row = {
                        cells: [row]
                    }
                }
            }
            row.id = this._temprowid;
            row.rowNumber = prop.hotRowNumber;
            row.rowClass = profile.getClass("CELLS", "-hot");
            ins.insertRows([row], null, null, false, false);
            profile.__hastmpRow = true;
            if (focusColId !== null) {
                ins.focusCellbyRowCol(row.id, focusColId || prop.header[0].id);
                profile.box._sethotrowoutterblur(profile)
            }
        },
        _checkNewLine: function (profile, trigger) {
            var prop = profile.properties;
            profile.box._sethotrowoutterblur(profile, true);
            if (!profile.__hastmpRow) {
                return
            }
            delete profile.__needchecktmprow;
            var ins = profile.boxing(),
                rowId = this._temprowid,
                tempRow = ins.getRowbyRowId(rowId),
                result = prop.hotRowMode == "show" ? trigger == "keydown" ? true : null : trigger ? true : false;
            if (profile.beforeHotRowAdded) {
                var result2 = ins.beforeHotRowAdded(profile, tempRow, !trigger);
                if (_.isDefined(result2)) {
                    result = result2
                }
            }
            if (result === null) {
                if (prop.hotRowMode == "hide" || prop.hotRowMode == "auto") {
                    profile.box._sethotrowoutterblur(profile)
                }
                return false
            } else {
                if (result === false) {
                    if (prop.hotRowMode == "hide" || prop.hotRowMode == "auto") {
                        delete profile.__hastmpRow;
                        ins.removeRows([rowId], false);
                        if (prop.rows.length === 0 && prop.hotRowMode == "auto") {
                            this._addTempRow(profile, null)
                        }
                    }
                    return false
                } else {
                    if (result === true) {
                        var newrow = _.clone(tempRow, true);
                        var hotcls = profile.getClass("CELLS", "-hot");
                        if (hotcls == newrow.rowClass) {
                            delete newrow.rowClass
                        } else {
                            newrow.rowClass = newrow.rowClass.replace(hotcls, "")
                        }
                        delete profile.__hastmpRow;
                        ins.removeRows([rowId], false);
                        if (newrow.id == rowId) {
                            delete newrow.id
                        }
                        if (newrow.rowNumber == prop.hotRowNumber) {
                            delete newrow.rowNumber
                        }
                        ins.insertRows([newrow], null, null, false, false);
                        if (profile.afterHotRowAdded) {
                            ins.afterHotRowAdded(profile, prop.rows[prop.rows.length - 1])
                        }
                        if (prop.hotRowMode == "show") {
                            if (!profile.__hastmpRow) {
                                this._addTempRow(profile, null)
                            }
                        }
                        return true
                    } else {
                        profile.__needchecktmprow = true;
                        if (_.isHash(result)) {
                            ins.focusCell(result)
                        } else {
                            ins.focusCell(ins.getCell(result))
                        }
                        profile.box._sethotrowoutterblur(profile);
                        return false
                    }
                }
            }
        },
        _sethotrowoutterblur: function (profile, clear) {
            profile.getSubNode("BODY").setBlurTrigger(profile.$domId + ":BODY", clear ? null : function (pos, e) {
                var trigger = xui.Event.getSrc(e) == profile.getSubNode("SCROLL").get(0) ? "focusin" : null;
                profile.__tmpRowBlurTrigger = _.asyRun(function () {
                    if (!profile.box) {
                        return
                    }
                    profile.box._checkNewLine(profile, trigger)
                })
            }, null, null, true);
            if (clear) {
                if (profile.__tmpRowBlurTrigger) {
                    clearTimeout(profile.__tmpRowBlurTrigger);
                    delete profile.__tmpRowBlurTrigger
                }
            }
        },
        _cacheRows: function (profile) {
            var all = profile.getSubNode("CELLS", true).get();
            _.filter(all, function (o) {
                return !!o.clientHeight
            });
            profile.$allrowscache = all
        },
        _asy: function (profile) {
            var pro = profile.properties,
                b = profile.boxing(),
                id = profile.$xid;
            if (pro.altRowsBg) {
                _.resetRun(id + "1", function () {
                    b.setAltRowsBg(true, true)
                })
            }
            if (pro.rowNumbered) {
                _.resetRun(id + "2", function () {
                    b.setRowNumbered(true, true)
                })
            }
        },
        _setRowHanderW: function (profile, flag) {
            var pro = profile.properties,
                ww = pro.$subMargin,
                map = profile.rowMap,
                hcell = profile.getSubNode("HFCELL"),
                n, w;
            if (typeof flag == "number") {
                w = flag
            } else {
                if (flag === true) {
                    var ws = [],
                        t;
                    profile.getSubNode("FCELLINN", true).each(function (o) {
                        if ((t = o.parentNode).parentNode.offsetHeight > 0 && xui.Dom.getStyle(t, "overflow") != "visible") {
                            if (n = map[profile.getSubId(o.id)]) {
                                ws.push(xui([o]).width() + n._layer * ww)
                            }
                        }
                    });
                    ws.push(pro._minColW);
                    w = parseInt(Math.max.apply(null, ws), 10) + ww * 2
                } else {
                    w = hcell.width()
                }
            }
            if (w) {
                if (w < pro._minColW) {
                    w = pro._minColW
                }
                if (w <= 0) {
                    return
                }
                if (pro.rowHandlerWidth != w) {
                    hcell.width(pro.rowHandlerWidth = w);
                    profile.getSubNode("FCELL", true).width(w);
                    profile.getSubNode("ROWLRULER", true).each(function (o) {
                        n = map[profile.getSubId(o.id)];
                        o.style.width = (4 + n._layer * ww) + "px"
                    });
                    profile.box._ajdustBody(profile)
                }
            }
        },
        _onStartDrag: function (profile, e, src) {
            var pos = xui.Event.getPos(e);
            profile.$_ond = src;
            xui.use(src).startDrag(e, {
                dragType: "icon",
                shadowFrom: xui.use(src).parent()._get(0),
                targetLeft: pos.left + 12,
                targetTop: pos.top + 12,
                dragCursor: "pointer",
                dragDefer: 2,
                dragKey: profile.box.getDragKey(profile, src),
                dragData: profile.box.getDragData(profile, e, src)
            });
            return false
        },
        _onDropTest: function (profile, e, src, key, data, item) {
            var fid = data && data.domId,
                tid = src,
                fp = data && data.profile,
                t;
            if (tid) {
                var k = profile.getKey(tid),
                    ks = profile.keys,
                    row = profile.rowMap[profile.getSubId(tid)];
                if (k == ks.ROWTOGGLE && !row.sub) {
                    return false
                }
            }
            if (fp && fp.$xid == profile.$xid) {
                if (fid && profile.getSubId(fid) == profile.getSubId(tid)) {
                    return false
                }
                t = profile.$_ond;
                src = xui(src).get(0);
                if (_.get(src, ["parentNode", "previousSibling"]) == t) {
                    return false
                }
                do {
                    if (src == t) {
                        src = t = null;
                        return false
                    }
                } while (src && (src = src.parentNode) && src !== document && src !== window);
                src = t = null
            }
        },
        _onDragstop: function (profile, e, src, key, data, item) {
            delete profile.$_ond
        },
        _onDrop: function (profile, e, src, key, data, item) {
            xui.DragDrop.setDragIcon("none");
            if (!data.profile || !data.profile[profile.KEY]) {
                return
            }
            var k = profile.getKey(src),
                po = data.profile,
                ps = data.domId,
                oitem, ks = profile.keys,
                t = xui.absObj.$specialChars,
                b = profile.boxing(),
                orow = po.rowMap[po.getSubId(ps)],
                row = profile.rowMap[profile.getSubId(src)];
            orow = _.clone(orow, function (o, i) {
                return !t[(i + "").charAt(0)]
            });
            po.boxing().removeRows([orow.id]);
            if (k == ks.SCROLL) {
                b.insertRows([orow], null, null, false)
            } else {
                if ((k == ks.ROWTOGGLE) && row.sub) {
                    b.insertRows([orow], row.id, null, false)
                } else {
                    if (k == ks.CELLS) {
                        b.insertRows([orow], row._pid, row.id, true)
                    }
                }
            }
            return false
        },
        _beforeSerialized: function (profile) {
            var o = arguments.callee.upper.call(this, profile),
                pp = profile.properties,
                map = xui.absObj.$specialChars,
                t;
            o.properties.header = _.clone(pp.header, function (o, i, d) {
                return !map[((d === 1 ? o.id : i) + "").charAt(0)] && o != undefined
            });
            o.properties.rows = _.clone(pp.rows, function (o, i, d) {
                return !map[((d === 1 ? o.id : i) + "").charAt(0)] && o != undefined
            });
            if (o.properties.header.length === 0) {
                delete o.properties.header
            }
            if (o.properties.rows.length === 0) {
                delete o.properties.rows
            }
            return o
        },
        _clsCache: {},
        _colDragCheck: function (profile, src) {
            var dd = xui.DragDrop.getProfile(),
                key = dd.dragKey,
                data = dd.dragData,
                col = profile.colMap[profile.getSubId(src)];
            if (!(col.hasOwnProperty("colMovable") ? col.colMovable : profile.properties.colMovable)) {
                return
            }
            if (!key || !data || key != (profile.$xid + ":col")) {
                return false
            }
            if (data == xui.use(src).id() || data == xui.use(src).prev().id()) {
                return false
            }
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile),
                NONE = "display:none";
            profile.rowMap2 = {};
            profile.rowMap = {};
            profile.cellMap = {};
            var pro = profile.properties;
            data.showHeader = pro.showHeader ? "" : NONE;
            data.colDDDisplay = pro.colResizer ? "" : NONE;
            data.rowDDDisplay = pro.rowResizer ? "" : NONE;
            data.rowHandlerDisplay = pro.rowHandler ? "" : NONE;
            data.sortDisplay = NONE;
            data.headerHeight = data.headerHeight ? ("height:" + data.headerHeight + "px;") : "";
            data._rowMarkDisplay = (pro.selMode == "multi" || pro.selMode == "multibycheckbox") ? "" : "display:none;";
            if (pro.header && pro.header.constructor != Array) {
                pro.header = []
            }
            if (pro.rows && pro.rows.constructor != Array) {
                pro.rows = []
            }
            pro.header = this._adjustHeader(pro.header);
            data.header = this._prepareHeader(profile, pro.header);
            data._row0DfW = data.rowHandlerWidth ? ("width:" + data.rowHandlerWidth + "px") : "";
            arguments.callee.upper.call(this, profile);
            pro.rows = this._adjustRows(pro.rows);
            data.rows = this._prepareItems(profile, pro.rows);
            return data
        },
        _prepareHeader: function (profile, arr) {
            var a = profile.colMap2 = {},
                b = profile.colMap = {},
                SubID = xui.UI.$tag_subId,
                pro = profile.properties,
                header = [],
                temp, t, NONE = "display:none";
            _.arr.each(arr, function (o, i) {
                temp = "h_" + profile.pickSubId("header");
                if (typeof o == "string") {
                    o = arr[i] = {
                        id: o
                    }
                }
                if (typeof o.id != "string") {
                    o.id = o.caption || (_() + "")
                }
                o._cells = {};
                o[SubID] = temp;
                b[temp] = o;
                o.width = o.width || pro._colDfWidth;
                if (!o.hasOwnProperty("relWidth")) {
                    if (o.hasOwnProperty("minWidth")) {
                        o.width = Math.max(o.minWidth)
                    }
                    if (o.hasOwnProperty("maxWidth")) {
                        o.width = Math.min(o.minWidth)
                    }
                }
                t = {
                    sortDisplay: NONE,
                    rowHandlerDisplay: pro.rowHandler ? "" : NONE
                };
                t[SubID] = temp;
                t._tabindex = pro.tabindex;
                t.colDDDisplay = (("colResizer" in o) ? o.colResizer : pro.colResizer) ? "" : NONE;
                if (o.relWidth) {
                    t.colDDDisplay = NONE
                }
                if (o.hasOwnProperty("visibility") && !o.hasOwnProperty("hidden")) {
                    o.hidden = !o.visibility
                }
                t.colDisplay = o.hidden === true ? "display:none" : "";
                t.firstCellStyle = pro.colOptions.firstCellStyle || "";
                t.firstCellClass = pro.colOptions.firstCellClass || "";
                if (!o.type) {
                    o.type = "input"
                }
                if (!o.caption) {
                    o.caption = o.id
                }
                xui.UI.adjustData(profile, o, t);
                a[o.id] = temp;
                header.push(t)
            });
            return header
        },
        _renderCell: function (profile, cell, node, options) {
            var getPro = profile.box.getCellOption,
                dom = node["xui.Dom"],
                ncell = dom ? cell : node,
                type = getPro(profile, cell, "type"),
                t1 = "",
                t2 = "",
                caption, capOut = (!dom) && node.caption,
                reg1 = /</g,
                me = arguments.callee,
                dcls = me._dcls || (me._dcls = profile.getClass("CELL", "-disabled")),
                rcls = me._rcls || (me._rcls = profile.getClass("CELL", "-readonly")),
                ren = me._ren || (me._ren = function (profile, cell, ncell, fun) {
                    return (typeof cell._$caption == "string" ? cell._$caption : typeof ncell.caption == "string" ? ncell.caption : typeof (cell.renderer || cell._renderer) == "function" ? (cell.renderer || cell._renderer).call(profile, cell) : typeof fun == "function" ? fun(cell.value, profile, cell) : (_.isSet(cell.value) ? String(cell.value) : "")) || ""
                }),
                f0 = me._f0 = (me._f0 = function (v, profile, cell) {
                    return v ? xui.Date.getText(v, getPro(profile, cell, "dateEditorTpl") || "ymdhn") : ""
                }),
                f1 = me._f1 = (me._f1 = function (v, profile, cell) {
                    return v ? xui.Date.getText(v, getPro(profile, cell, "dateEditorTpl") || "ymd") : ""
                }),
                f2 = me._f2 = (me._f2 = function (v) {
                    return v ? (v + "").replace(reg1, "&lt;").replace(/\t/g, "    ").replace(/(\r\n|\n|\r)/g, "<br />") : ""
                }),
                f3 = me._f3 = (me._f3 = function (v) {
                    return (v || v === 0) ? ((v * 100).toFixed(2) + "%") : ""
                }),
                f4 = me._f4 = (me._f4 = function (v, profile, cell) {
                    if (v || v === 0) {
                        return _.formatNumeric(parseFloat(v), getPro(profile, cell, "precision"), getPro(profile, cell, "groupingSeparator"), getPro(profile, cell, "decimalSeparator"), getPro(profile, cell, "forceFillZero"))
                    } else {
                        return ""
                    }
                }),
                f5 = me._f5 = (me._f5 = function (v, profile, cell) {
                    if (v || v === 0) {
                        var precision = getPro(profile, cell, "precision");
                        return _.formatNumeric(parseFloat(v), _.isSet(precision) ? precision : 2, getPro(profile, cell, "groupingSeparator"), getPro(profile, cell, "decimalSeparator"), getPro(profile, cell, "forceFillZero"))
                    } else {
                        return ""
                    }
                }),
                f6 = me._f6 = (me._f6 = function (v, profile, cell) {
                    var t = getPro(profile, cell, "editorListItems");
                    if (!t) {
                        if (t = getPro(profile, cell, "editorListKey")) {
                            t = xui.UI.getCachedData(t)
                        }
                    }
                    if (t && t.length) {
                        for (var i = 0, l = t.length; i < l; i++) {
                            if (t[i].id === v) {
                                return t[i].caption || v
                            }
                        }
                    }
                    return v
                });
            switch (type) {
            case "number":
            case "spin":
                var v = parseFloat(cell.value);
                cell.value = (v || v === 0) ? v : null;
                caption = capOut || ren(profile, cell, ncell, f4);
                var tpl = getPro(profile, cell, "numberTpl");
                if (tpl && caption) {
                    caption = tpl.replace("*", caption)
                }
                if (dom) {
                    node.html(caption, false)
                }
                break;
            case "currency":
                var v = parseFloat((cell.value + "").replace(/[^\d.-]/g, ""));
                cell.value = (v || v === 0) ? v : null;
                caption = capOut || ren(profile, cell, ncell, f5);
                var tpl = getPro(profile, cell, "currencyTpl");
                if (tpl && caption !== "") {
                    caption = tpl.replace("*", caption)
                }
                if (dom) {
                    node.html(caption, false)
                }
                break;
            case "date":
            case "datepicker":
                cell.value = _.isDate(cell.value) ? cell.value : _.isFinite(cell.value) ? new Date(parseInt(cell.value, 10)) : null;
                caption = capOut || ren(profile, cell, ncell, f1);
                if (dom) {
                    node.html(caption, false)
                }
                break;
            case "datetime":
                cell.value = _.isDate(cell.value) ? cell.value : _.isFinite(cell.value) ? new Date(parseInt(cell.value, 10)) : null;
                caption = capOut || ren(profile, cell, ncell, f0);
                if (dom) {
                    node.html(caption, false)
                }
                break;
            case "textarea":
                cell.value = cell.value || "";
                cell.cellClass = "xui-cls-wordwrap " + cell.cellClass;
                caption = capOut || ren(profile, cell, ncell, f2);
                if (dom) {
                    node.html(caption, false)
                }
                break;
            case "color":
            case "colorpicker":
                var c = xui.UI.ColorPicker._ensureValue(0, cell.value);
                cell.value = cell.value ? ((c !== "transparent" ? "#" : "") + c) : "";
                caption = capOut || ren(profile, cell, ncell);
                if (cell.value) {
                    t1 = xui.UI.ColorPicker.getTextColor(cell.value);
                    if (dom) {
                        node.html(caption, false);
                        node.css("color", t1).css("backgroundColor", cell.value)
                    } else {
                        node.color = "color:" + t1 + ";";
                        node.bgcolor = "background-color:" + cell.value + ";"
                    }
                } else {
                    if (dom) {
                        node.html(caption, false);
                        node.css("color", "").css("backgroundColor", "")
                    } else {}
                }
                break;
            case "checkbox":
                cell.value = !! cell.value;
                caption = cell.value + "";
                if (dom) {
                    node.first().tagClass("-checked", cell.value)
                } else {
                    node.checkboxCls = profile.getClass("CHECKBOX", cell.value ? "-checked" : "")
                }
                break;
            case "progress":
                cell.value = parseFloat(cell.value) || 0;
                cell.value = Math.min(Math.max(cell.value, 0), 1);
                caption = capOut || ren(profile, cell, ncell, f3);
                if (dom) {
                    node.first().html(caption, false).width(caption)
                } else {
                    node.progress = caption
                }
                break;
            case "listbox":
                cell.value = cell.hasOwnProperty("value") ? cell.value : "";
                caption = capOut || ren(profile, cell, ncell, f6);
                if (dom) {
                    node.html((caption === null || caption === undefined) ? cell.value : caption, false)
                }
                break;
            default:
                cell.value = cell.hasOwnProperty("value") ? cell.value : "";
                caption = capOut || ren(profile, cell, ncell);
                if (dom) {
                    node.html((caption === null || caption === undefined) ? cell.value : caption, false)
                }
            }
            cell._$tips = caption;
            var t2 = cell.disabled || cell._row.disabled || cell._col.disabled,
                t3 = cell.readonly || cell._row.readonly || cell._col.readonly;
            if (!dom) {
                node.cellCls = profile.getClass("CELL", "-" + type) + (t2 ? (" " + dcls) : "") + (t3 ? (" " + rcls) : "");
                node.type = type;
                node.value = cell.value;
                node.caption = caption;
                node.cellStyle = getPro(profile, cell, "cellStyle");
                node.cellClass = getPro(profile, cell, "cellClass")
            } else {
                if (t2) {
                    node.addClass(dcls)
                } else {
                    node.removeClass(dcls)
                }
                if (t2 = options.cellStyle) {
                    node.attr("style", node.attr("style") + ";" + t2)
                }
                if (t2 = options.cellClass) {
                    node.addClass(t2)
                }
            }
        },
        _prepareItems: function (profile, arr, pid) {
            var self = this,
                pro = profile.properties,
                mm = pro.$subMargin,
                a = profile.rowMap2,
                b = profile.rowMap,
                d = profile.cellMap,
                _layer = pid ? b[pid] ? (b[pid]._layer + 1) : 0 : 0,
                SubID = xui.UI.$tag_subId,
                me = arguments.callee,
                ider = me._id || (me._id = new _.id()),
                rows = [],
                temp, cells, t, row, g, j, v, NONE = "display:none";
            for (var i = 0, l = arr.length; i < l; i++) {
                if (!arr[i].id || a[arr[i].id]) {
                    while (a[t = ider.next()]) {}
                    arr[i].id = t
                }
                row = arr[i];
                temp = "r_" + profile.pickSubId("row");
                row[SubID] = temp;
                b[temp] = row;
                row._pid = pid;
                row._cells = {};
                row._layer = _layer;
                row._tabindex = pro.tabindex;
                row._rowMarkDisplay = (pro.selMode == "multi" || pro.selMode == "multibycheckbox") ? "" : NONE;
                row._treeMode = pro.treeMode ? "" : NONE;
                t = {
                    id: row.id
                };
                t.rowCls = "";
                if (row.disabled) {
                    t.rowCls += profile.getClass("CELLS", "-disabled")
                }
                if (row.readonly) {
                    t.rowCls += profile.getClass("CELLS", "-readonly")
                }
                if (row.group) {
                    t.rowCls += profile.getClass("CELLS", "-group")
                }
                if (row.summary) {
                    t.summaryDisplay = "display:block;"
                }
                if (row.preview) {
                    t.previewDisplay = "display:block;"
                }
                if (row.hidden) {
                    t.rowDisplay = NONE
                }
                t._row0DfW = pro.rowHandlerWidth ? ("width:" + pro.rowHandlerWidth + "px") : "";
                t._rulerW = 4 + _layer * mm;
                t.rowHeight = row.height || pro.rowHeight;
                t.rowHandlerDisplay = pro.rowHandler ? "" : NONE;
                t.rowDDDisplay = (("rowResizer" in row) ? row.rowResizer : pro.rowResizer) ? "" : NONE;
                t.firstCellStyle = pro.rowOptions.firstCellStyle || "";
                t.firstCellClass = pro.rowOptions.firstCellClass || "";
                cells = t.cells = [];
                t[SubID] = temp;
                t.subClass = row.sub ? "xui-uicmd-toggle2" : "xui-uicmd-empty";
                a[row.id] = temp;
                if (row.group) {
                    row.cells = null
                }
                if (!row.hasOwnProperty("caption") && row.hasOwnProperty("value")) {
                    row.caption = "" + row.value
                }
                if (row.caption && !row.tips) {
                    row._$tips = row.caption
                }
                if (v = row.cells) {
                    _.arr.each(pro.header, function (headCell, j) {
                        g = v[j] || (v[j] = {});
                        var n = {};
                        g._row = row;
                        g._col = headCell;
                        g[SubID] = "c_" + profile.pickSubId("cell");
                        g.id = g.id || g[SubID];
                        self._adjustCell(profile, g, n);
                        cells.push(n);
                        d[n[SubID]] = g;
                        row._cells[headCell.id] = n[SubID];
                        headCell._cells[row.id] = n[SubID]
                    })
                }
                xui.UI.adjustData(profile, row, t);
                rows.push(t)
            }
            return rows
        },
        _adjustCell: function (profile, cell, uicell) {
            var self = this,
                pro = profile.properties,
                col = cell._col,
                renderer;
            if (renderer = self.getCellOption(profile, cell, "cellRenderer")) {
                cell._renderer = renderer
            }
            xui.UI.adjustData(profile, cell, uicell);
            if (!uicell.width) {
                uicell.width = col.width
            }
            uicell._tabindex = pro.tabindex;
            uicell.cellDisplay = col.hidden === true ? "display:none;" : "";
            self._renderCell(profile, cell, uicell);
            cell._oValue = cell.value
        },
        _setSub: function (profile, item, flag) {
            var id = profile.domId,
                pro = profile.properties,
                serialId = profile.rowMap2[item.id],
                markNode = profile.getSubNode("ROWTOGGLE", serialId),
                subNs = profile.getSubNode("SUB", serialId);
            if (xui.Thread.isAlive(profile.key + profile.id)) {
                return
            }
            if (item._checked) {
                if (!flag) {
                    var h = subNs.height();
                    if (pro.animCollapse) {
                        subNs.animate({
                            height: [h, 0]
                        }, null, function () {
                            subNs.css({
                                display: "none"
                            })
                        }, 100, 5, "expoIn", profile.key + profile.id).start()
                    } else {
                        subNs.css({
                            display: "none",
                            height: 0
                        })
                    }
                    markNode.tagClass("-checked", false);
                    item._checked = false;
                    profile.box._asy(profile)
                }
            } else {
                if (flag) {
                    var openSub = function (profile, item, id, markNode, subNs, sub) {
                            var b = profile.boxing(),
                                p = profile.properties;
                            if (!item._inited) {
                                delete item.sub;
                                item._inited = true;
                                if (typeof sub == "string") {
                                    subNs.html(item.sub = sub, false)
                                } else {
                                    if (_.isArr(sub)) {
                                        b.insertRows(sub, item.id)
                                    } else {
                                        if (sub["xui.Template"] || sub["xui.UI"]) {
                                            subNs.append(item.sub = sub.render(true))
                                        }
                                    }
                                }
                                b._setCtrlValue(b.getUIValue(), true)
                            }
                            var h = subNs.height(true);
                            if (p.animCollapse) {
                                subNs.animate({
                                    height: [0, h]
                                }, function () {
                                    subNs.css({
                                        display: ""
                                    })
                                }, function () {
                                    subNs.css({
                                        height: "auto"
                                    })
                                }, 100, 5, "expoOut", profile.key + profile.id).start()
                            } else {
                                subNs.css({
                                    display: "",
                                    height: "auto"
                                })
                            }
                            markNode.tagClass("-checked");
                            item._checked = true;
                            profile.box._asy(profile)
                        };
                    var sub = item.sub,
                        callback = function (sub) {
                            openSub(profile, item, id, markNode, subNs, sub)
                        },
                        t;
                    if ((t = typeof sub) == "string" || t == "object") {
                        callback(sub)
                    } else {
                        if (profile.onGetContent) {
                            var r = profile.boxing().onGetContent(profile, item, callback);
                            if (r) {
                                if (r === true) {
                                    item._inited = true
                                }
                                callback(r)
                            }
                        }
                    }
                }
            }
            delete profile.$allrowscache
        },
        _getCellId: function (profile, rowId, colId) {
            return _.get(profile.rowMap, [profile.rowMap2[rowId], "_cells", colId])
        },
        _updCell: function (profile, cellId, options, dirtyMark, triggerEvent) {
            var box = profile.box,
                prop = profile.properties,
                pdm = prop.dirtyMark,
                psdm = prop.showDirtyMark,
                sc = xui.absObj.$specialChars,
                cell, node, ishotrow;
            if (typeof cellId == "string") {
                cell = profile.cellMap[cellId]
            } else {
                cell = cellId;
                cellId = cell._serialId
            }
            if (!cell) {
                return
            }
            ishotrow = cell._row.id == box._temprowid;
            if (!_.isHash(options)) {
                options = {
                    value: options
                }
            }
            options = _.filter(options, function (o, i) {
                return !sc[i.charAt(0)] || i == "_$caption"
            });
            if (triggerEvent) {
                if (profile.beforeCellUpdated && false === profile.boxing().beforeCellUpdated(profile, cell, options, ishotrow)) {
                    return
                }
            }
            delete cell.caption;
            delete cell._$caption;
            delete cell._$tips;
            _.merge(cell, options, "all");
            node = profile.getSubNode("CELLA", cellId);
            if ("type" in options) {
                var uicell = {};
                box._adjustCell(profile, cell, uicell);
                node.parent().replace(profile._buildItems("rows.cells", [uicell]))
            } else {
                box._renderCell(profile, cell, node, options)
            }
            if ("value" in options) {
                if (!pdm || dirtyMark === false) {
                    cell._oValue = cell.value
                } else {
                    if (cell.value === cell._oValue) {
                        if (psdm) {
                            node.removeClass("xui-ui-dirty")
                        }
                        delete cell.dirty
                    } else {
                        if (psdm) {
                            node.addClass("xui-ui-dirty")
                        }
                        cell.dirty = true
                    }
                }
            }
            if (triggerEvent) {
                if (profile.afterCellUpdated) {
                    profile.boxing().afterCellUpdated(profile, cell, options, ishotrow)
                }
            }
        },
        _ensureValue: function (profile, value) {
            if (profile.properties.selMode == "multi" || profile.properties.selMode == "multibycheckbox") {
                var arr = (value ? ("" + value) : "").split(profile.properties.valueSeparator);
                _.arr.removeValue(arr, this._temprowid);
                arr.sort();
                return arr.join(profile.properties.valueSeparator)
            } else {
                return value == this._temprowid ? null : value
            }
        },
        _sel: function (profile, type, src, id, e) {
            var properties = profile.properties;
            if (properties.activeMode != type) {
                return
            }
            var targetId = profile.getSubId(id),
                map = type == "cell" ? profile.cellMap : profile.rowMap,
                box = profile.boxing(),
                targetItem = map[targetId],
                ks = xui.Event.getKey(e),
                sid = type == "cell" ? (targetItem._row.id + "|" + targetItem._col.id) : targetItem.id,
                mode = properties.selMode;
            switch (mode) {
            case "none":
                box.onRowSelected(profile, targetItem, e, src, 0);
                break;
            case "multibycheckbox":
                if (profile.keys.MARK) {
                    var ck = profile.getKey(xui.Event.getSrc(e).id || ""),
                        clickMark = ck == profile.keys.MARK;
                    if (!clickMark) {
                        box.onRowSelected(profile, targetItem, e, src, 0);
                        break
                    }
                }
            case "multi":
                var value = box.getUIValue(),
                    arr = value ? ("" + value).split(properties.valueSeparator) : [],
                    checktype = 1;
                if (arr.length && (ks.ctrlKey || ks.shiftKey || properties.noCtrlKey)) {
                    if (ks.shiftKey && type == "row") {
                        if (profile.$firstV._pid != targetItem._pid) {
                            return false
                        }
                        var items = properties.rows;
                        if (targetItem._pid) {
                            var pitem = map[targetItem._pid];
                            if (pitem) {
                                items = pitem.sub
                            }
                        }
                        var i1 = _.arr.subIndexOf(items, "id", profile.$firstV.id),
                            i2 = _.arr.subIndexOf(items, "id", targetItem.id),
                            i;
                        arr.length = 0;
                        for (i = Math.min(i1, i2); i <= Math.max(i1, i2); i++) {
                            arr.push(items[i].id)
                        }
                    } else {
                        if (_.arr.indexOf(arr, sid) != -1) {
                            _.arr.removeValue(arr, sid);
                            checktype = -1
                        } else {
                            arr.push(sid)
                        }
                    }
                    arr.sort();
                    value = arr.join(properties.valueSeparator);
                    if (box.getUIValue() != value) {
                        box.setUIValue(value);
                        if (box.get(0) && box.getUIValue() == value) {
                            box.onRowSelected(profile, targetItem, e, src, checktype)
                        }
                    }
                    break
                }
            case "single":
                if (box.getUIValue() != sid) {
                    profile.$firstV = targetItem;
                    box.setUIValue(sid);
                    if (box.get(0) && box.getUIValue() == sid) {
                        box.onRowSelected(profile, targetItem, e, src, 1)
                    }
                }
                break
            }
        },
        _activeCell: function (profile, id) {
            if (profile.properties.activeMode != "cell") {
                return
            }
            if (profile.$activeCell == id) {
                return
            }
            var targetCell = null;
            if (profile.$activeCell) {
                xui(profile.$activeCell).tagClass("-active", false);
                delete profile.$activeCell
            }
            if (id !== false) {
                var targetId = profile.getSubId(id),
                    map = profile.cellMap;
                targetCell = map[targetId];
                if (profile.beforeCellActive && (false === profile.boxing().beforeCellActive(profile, targetCell))) {
                    return
                }
                xui(profile.$activeCell = id).tagClass("-active")
            }
            if (profile.afterCellActive) {
                profile.boxing().afterCellActive(profile, targetCell)
            }
        },
        _activeRow: function (profile, id) {
            if (profile.properties.activeMode != "row") {
                return
            }
            if (profile.$activeRow == id) {
                return
            }
            var targetRow = null;
            if (profile.$activeRow) {
                xui(profile.$activeRow).tagClass("-active", false);
                delete profile.$activeRow
            }
            if (id !== false) {
                var targetId = profile.getSubId(id),
                    map = profile.rowMap;
                targetRow = map[targetId];
                if (profile.beforeRowActive && (false === profile.boxing().beforeRowActive(profile, targetRow))) {
                    return
                }
                xui(profile.$activeRow = id).tagClass("-active")
            }
            if (profile.afterRowActive) {
                profile.boxing().afterRowActive(profile, targetRow)
            }
        },
        getCellOption: function (profile, cell, key) {
            var t = cell,
                p = profile.properties;
            return (t && t.hasOwnProperty(key) && _.isSet(t[key])) ? t[key] : ((t = cell._row) && t.hasOwnProperty(key) && _.isSet(t[key])) ? t[key] : ((t = p.rowOptions) && t.hasOwnProperty(key) && _.isSet(t[key])) ? t[key] : ((t = cell._col) && t.hasOwnProperty(key) && _.isSet(t[key])) ? t[key] : ((t = p.colOptions) && t.hasOwnProperty(key) && _.isSet(t[key])) ? t[key] : ((t = p) && t.hasOwnProperty(key) && _.isSet(t[key])) ? t[key] : null
        },
        _trycheckrowdirty: function (profile, cell) {
            if (!cell || !cell._row) {
                return
            }
            _.resetRun(profile.key + ":" + profile.$xid + ":" + cell._row.id, function () {
                if (!profile.box) {
                    return
                }
                var lc = profile.$cellInEditor;
                if (cell._row && (!lc || (lc._row && lc._row != cell._row))) {
                    var dirty = false;
                    _.arr.each(cell._row.cells, function (v) {
                        if (v._oValue !== v.value) {
                            dirty = true;
                            return false
                        }
                    });
                    if (dirty && cell._row.id != profile.box._temprowid && profile.onRowDirtied) {
                        profile.boxing().onRowDirtied(profile, cell._row)
                    }
                }
            }, 100)
        },
        _editCell: function (profile, cellId) {
            var cell = typeof cellId == "string" ? profile.cellMap[cellId] : cellId;
            if (!cell) {
                return
            }
            if (profile.box.getCellOption(profile, cell, "disabled") || profile.box.getCellOption(profile, cell, "readonly")) {
                return
            }
            cellId = cell._serialId;
            var cellNode = profile.getSubNode("CELL", cellId),
                colId = cell._col.id,
                ishotrow = cell._row.id == profile.box._temprowid;
            var editor = profile.$curEditor;
            if (editor) {
                _.tryF(editor.undo, [], editor)
            }
            editor = null;
            var grid = this,
                baseNode = profile.getSubNode("SCROLL"),
                box = profile.box,
                getPro = function (key) {
                    return box.getCellOption(profile, cell, key)
                };
            editor = profile.box.getCellOption(profile, cell, "customEditor");
            if (editor && typeof editor.iniEditor == "function") {
                editor.iniEditor(profile, cell, cellNode);
                _.tryF(editor.activate, [], editor);
                if (profile.onBeginEdit) {
                    profile.boxing().onBeginEdit(profile, cell, editor)
                }
            } else {
                if (profile.beforeIniEditor) {
                    editor = profile.boxing().beforeIniEditor(profile, cell, cellNode, baseNode);
                    if (editor === false) {
                        return
                    }
                }
                if (!editor || !editor["xui.UI"]) {
                    var type = getPro("type") || "input",
                        editorProperties = getPro("editorProperties"),
                        editorEvents = getPro("editorEvents"),
                        editorFormat = getPro("editorFormat"),
                        editorMask = getPro("editorMask"),
                        editorReadonly = getPro("editorReadonly"),
                        editorDropListWidth = getPro("editorDropListWidth"),
                        editorDropListHeight = getPro("editorDropListHeight"),
                        t, oldProp;
                    if (type == "checkbox") {
                        cellNode.first().focus();
                        return
                    } else {
                        if (type == "button" || type == "label") {
                            return
                        }
                    }
                    editor = new xui.UI.ComboInput({
                        dirtyMark: false,
                        cachePopWnd: false,
                        left: -1000,
                        top: -1000,
                        position: "absolute",
                        visibility: "hidden",
                        zIndex: 100
                    });
                    switch (type) {
                    case "number":
                    case "spin":
                    case "currency":
                        var precision = getPro("precision"),
                            currencyTpl = getPro("currencyTpl"),
                            numberTpl = getPro("numberTpl"),
                            groupingSeparator = getPro("groupingSeparator"),
                            decimalSeparator = getPro("decimalSeparator"),
                            forceFillZero = getPro("forceFillZero");
                        editor.setType(type);
                        if (type == "currency") {
                            if (!_.isSet(precision)) {
                                precision = 2
                            }
                            if (_.isSet(currencyTpl)) {
                                editor.setCurrencyTpl(currencyTpl)
                            }
                        } else {
                            if (!_.isSet(precision)) {
                                precision = 0
                            }
                            if (_.isSet(numberTpl)) {
                                editor.setNumberTpl(numberTpl)
                            }
                        }
                        if (_.isSet(precision)) {
                            editor.setPrecision(precision)
                        }
                        if (_.isSet(groupingSeparator)) {
                            editor.setFroupingSeparator(groupingSeparator)
                        }
                        if (_.isSet(decimalSeparator)) {
                            editor.setDecimalSeparator(decimalSeparator)
                        }
                        if (_.isSet(forceFillZero)) {
                            editor.setForceFillZero(forceFillZero)
                        }
                        break;
                    case "progress":
                        editor.setType("spin").setMax(1).setMin(0).setPrecision(4).setIncrement(0.01);
                        break;
                    case "input":
                        editor.setType("none");
                        break;
                    case "textarea":
                        editor.setType("none").setMultiLines(true).setCommandBtn("save").onCommand(function (p) {
                            p.boxing().hide()
                        });
                        _.tryF(editor.setResizer, [true], editor);
                        break;
                    case "date":
                    case "datepicker":
                    case "datetime":
                        var dateEditorTpl = getPro("dateEditorTpl");
                        if (dateEditorTpl) {
                            editor.setDateEditorTpl(dateEditorTpl)
                        }
                    case "listbox":
                    case "combobox":
                    case "helpinput":
                    case "time":
                    case "timepicker":
                    case "color":
                    case "colorpicker":
                    case "getter":
                    case "popbox":
                    case "cmdbox":
                        editor.setType(type);
                        if (profile.box.getCellOption(profile, cell, "disabled")) {} else {
                            editor.beforeComboPop(function (pro, pos, e, src) {
                                var cell = pro.$cell,
                                    event = profile.box.getCellOption(profile, cell, "event");
                                if (typeof event == "function") {
                                    return event.call(profile._host || profile, profile, cell, pro, pos, e, src)
                                } else {
                                    return profile.boxing().beforeComboPop(profile, cell, pro, pos, e, src)
                                }
                            });
                            if (profile.beforePopShow) {
                                editor.beforePopShow(function (pro, popCtl) {
                                    return profile.boxing().beforePopShow(profile, pro.$cell, pro, popCtl)
                                })
                            }
                            if (profile.afterPopShow) {
                                editor.afterPopShow(function (pro, popCtl) {
                                    return profile.boxing().afterPopShow(profile, pro.$cell, pro, popCt)
                                })
                            }
                            if (profile.onCommand) {
                                editor.onCommand(function (pro, node) {
                                    return profile.boxing().onCommand(profile, pro.$cell, pro, node)
                                })
                            }
                        }
                        break;
                    case "file":
                        editor.setType(type);
                        break
                    }
                    baseNode.append(editor);
                    if (editor.setInputReadonly && editorReadonly) {
                        editor.setInputReadonly(true)
                    }
                    if (editor.setDropListWidth && editorDropListWidth) {
                        editor.setDropListWidth(editorDropListWidth)
                    }
                    if (editor.setDropListHeight && editorDropListHeight) {
                        editor.setDropListHeight(editorDropListHeight)
                    }
                    if (editorFormat) {
                        if (typeof editorFormat == "function" && editor.beforeFormatCheck) {
                            editor.beforeFormatCheck(editorFormat)
                        } else {
                            if (typeof editorFormat == "string" && editor.setValueFormat) {
                                editor.setValueFormat(editorFormat)
                            }
                        }
                    }
                    if (editorMask && editor.setMask) {
                        editor.setMask(editorMask)
                    }
                    if (editorProperties) {
                        oldProp = {};
                        var h = profile.getProperties();
                        _.each(editorProperties, function (o, i) {
                            oldProp = h[i]
                        });
                        editor.setProperties(editorProperties)
                    }
                    if (editorEvents) {
                        editor.setEvents(editorEvents)
                    }
                    editor.resetValue();
                    switch (type) {
                    case "listbox":
                    case "combobox":
                    case "helpinput":
                        if (t = getPro("editorListItems")) {
                            editor.setListKey(null);
                            editor.setItems(t)
                        } else {
                            if (t = getPro("editorListKey")) {
                                editor.setItems(null);
                                editor.setListKey(t)
                            }
                        }
                        break;
                    case "cmdbox":
                    case "popbox":
                        if (editor.setCaption) {
                            editor.setCaption(cell.caption || "")
                        }
                    }
                    editor.setValue(cell.$editorValue || cell.value, true);
                    delete cell.$editorValue;
                    if (cell.$tag) {
                        if (editor.setCaption) {
                            editor.setCaption(cell.$tag)
                        } else {
                            if (editor.setValue) {
                                editor.setValue(cell.$tag)
                            }
                        }
                    }
                    editor.get(0).$cell = cell;
                    editor.get(0)._smartnav = true;
                    editor.undo = function () {
                        var editor = this;
                        profile.$curEditor = null;
                        profile.$cellInEditor = null;
                        if (profile.box) {
                            profile.box._trycheckrowdirty(profile, profile.$cellInEditor)
                        }
                        if (editor.get(0)) {
                            editor.getSubNode("INPUT").onBlur(true);
                            editor.getRoot().setBlurTrigger(profile.$xid + ":editor");
                            if (profile.properties && !profile.properties.directInput) {
                                editor.afterUIValueSet(null).beforeNextFocus(null).onCancel(null);
                                editor.setValue("", true)
                            }
                            if (editorFormat) {
                                if (editor.beforeFormatCheck) {
                                    editor.beforeFormatCheck(null)
                                }
                                if (editor.setValueFormat) {
                                    editor.setValueFormat("")
                                }
                            }
                            if (editorMask) {
                                if (editor.setMask) {
                                    editor.setMask("")
                                }
                            }
                            if (editorReadonly) {
                                if (editor.setInputReadonly) {
                                    editor.setInputReadonly(false)
                                }
                            }
                            if (editorDropListWidth) {
                                if (editor.setDropListWidth) {
                                    editor.setDropListWidth(0)
                                }
                            }
                            if (editorDropListHeight) {
                                if (editor.setDropListHeight) {
                                    editor.setDropListHeight(0)
                                }
                            }
                            if (oldProp) {
                                editor.setProperties(oldProp);
                                oldProp = null
                            }
                            delete editor.get(0).$cell;
                            delete editor.get(0)._smartnav;
                            editor.setVisibility("hidden")
                        }
                        if (editorEvents) {
                            var h = {};
                            _.each(editorEvents, function (o, i) {
                                h[i] = null
                            });
                            editor.setEvents(h)
                        }
                        editor.undo = null;
                        if (profile.onEndEdit) {
                            profile.boxing().onEndEdit(profile, cell, editor)
                        }
                        if (editor.get(0)) {
                            editor.destroy()
                        }
                        editor = null
                    };
                    editor.afterUIValueSet(function (pro, oV, nV) {
                        var type = getPro("type"),
                            _$caption;
                        switch (type) {
                        case "number":
                        case "spin":
                        case "progress":
                            nV = parseFloat(nV);
                            nV = (nV || nV === 0) ? nV : null;
                            break;
                        case "currency":
                            nV = parseFloat(("" + nV).replace(/[^\d.-]/g, ""));
                            nV = (nV || nV === 0) ? nV : null;
                            break;
                        case "cmdbox":
                        case "popbox":
                        case "combobox":
                        case "listbox":
                        case "helpinput":
                            _$caption = pro.boxing().getShowValue();
                            break
                        }
                        var options = {
                            value: nV
                        };
                        if (_.isDefined(_$caption)) {
                            options.caption = options._$caption = _$caption
                        }
                        if (pro.properties.hasOwnProperty("tagVar")) {
                            options.tagVar = pro.properties.tagVar
                        }
                        grid._updCell(profile, cellId, options, profile.properties.dirtyMark, true)
                    }).beforeNextFocus(function (pro, e) {
                        if (editor) {
                            _.tryF(editor.undo, [], editor);
                            var hash = xui.Event.getEventPara(e);
                            if (hash.keyCode == "enter") {
                                hash.keyCode = "right"
                            }
                            profile.getSubNode("CELLA", cell._serialId).onKeydown(true, hash)
                        }
                        return false
                    }).onCancel(function () {
                        if (editor) {
                            _.tryF(editor.undo, [], editor)
                        }
                    }).getRoot().setBlurTrigger(profile.$xid + ":editor", function () {
                        if (editor) {
                            _.tryF(editor.undo, [], editor)
                        }
                        return false
                    });
                    var absPos = cellNode.offset(null, baseNode),
                        size = cellNode.cssSize();
                    if (type == "textarea") {
                        editor.setWidth(Math.max(200, size.width + 3)).setHeight(Math.max(100, size.height + 2)).reLayout(true, true).reBoxing().popToTop(cellNode, 4, baseNode)
                    } else {
                        editor.setWidth(size.width + 3).setHeight(size.height + 2).reLayout(true);
                        editor.reBoxing().show((absPos.left - 1) + "px", (absPos.top - 1) + "px")
                    }
                    editor.setVisibility("visible");
                    if (profile.onBeginEdit) {
                        profile.boxing().onBeginEdit(profile, cell, editor)
                    }
                    _.asyRun(function () {
                        if (!profile.box) {
                            return
                        }
                        _.tryF(editor && editor.activate, [], editor)
                    })
                }
            }
            profile.$curEditor = editor;
            profile.$cellInEditor = cell;
            if (ishotrow) {
                profile.__needchecktmprow = true;
                profile.box._sethotrowoutterblur(profile)
            }
        },
        _ajdustBody: function (profile, callback) {
            profile.getSubNode("SCROLL").css("overflow", "hidden");
            _.resetRun(profile.$xid + "4", function () {
                if (!profile.box) {
                    return
                }
                profile.box._adjustRelWith(profile);
                var body = profile.getSubNode("BODY"),
                    header = profile.getSubNode("HCELLS"),
                    t, l, last, keys = profile.keys,
                    ww;
                if (body.get(0).clientHeight) {
                    if (header.get(0).clientHeight) {
                        if (t = header.get(0).childNodes) {
                            l = t.length;
                            while (l) {
                                if (t[l - 1].clientHeight) {
                                    last = t[l - 1];
                                    break
                                }--l
                            }
                        }
                        ww = last ? (last.offsetWidth + last.offsetLeft + 100) : 0;
                        header.parent().width(ww);
                        body.width(ww)
                    } else {
                        if (t = body.get(0).childNodes) {
                            l = t.length;
                            while (l) {
                                if (t[l - 1].clientHeight) {
                                    last = t[l - 1];
                                    break
                                }--l
                            }
                            if (last) {
                                var sid = profile.getSubId(last.id);
                                t = profile.getSubNode("CELLS", sid);
                                if (t = t.get(0).childNodes) {
                                    l = t.length;
                                    while (l) {
                                        if (t[l - 1].clientHeight) {
                                            last = t[l - 1];
                                            break
                                        }--l
                                    }
                                }
                            }
                        }
                    }
                }
                if (last) {
                    body.width(last.offsetWidth + last.offsetLeft)
                } else {
                    var prop = profile.properties,
                        hd = prop.header,
                        rows = prop.rows,
                        w = prop.rowHandler ? (prop.rowHandlerWidth + 2) : 0;
                    _.each(hd, function (o) {
                        if (o.hidden !== true) {
                            w += o.width + 2
                        }
                    });
                    body.width(w)
                }
                t = last = null;
                profile.getSubNode("SCROLL").css("overflow", "auto");
                if (callback) {
                    callback()
                }
            })
        },
        _adjustHeader: function (arr) {
            var a = _.copy(arr),
                m;
            _.arr.each(a, function (o, i) {
                a[i] = _.copy(o)
            });
            return a
        },
        _adjustRows: function (arr) {
            var a, m;
            if (_.isArr(arr) && arr.length && typeof arr[0] != "object") {
                a = [arr]
            } else {
                a = _.copy(arr)
            }
            _.arr.each(a, function (o, i) {
                if (_.isArr(o)) {
                    a[i] = {
                        cells: o
                    }
                } else {
                    a[i] = _.copy(o)
                }
                m = a[i].cells = _.copy(a[i].cells);
                _.arr.each(m, function (o, i) {
                    if ( !! o && typeof o == "object" && o.constructor == Object) {
                        m[i] = _.copy(o)
                    } else {
                        m[i] = {
                            value: o
                        }
                    }
                })
            });
            return a
        },
        _focuscell: function (profile, e, src) {
            if (profile.properties.disabled || profile.properties.readonly) {
                return
            }
            var p = profile.properties,
                box = profile.box,
                getPro = box.getCellOption,
                cell = profile.cellMap[profile.getSubId(src)],
                mode = p.activeMode,
                id;
            if (cell) {
                var edit = false;
                if (getPro(profile, cell, "editable")) {
                    if (getPro(profile, cell, "disabled") || getPro(profile, cell, "readonly")) {
                        edit = false
                    } else {
                        edit = true;
                        xui(src).parent().tagClass("-mousedown", false);
                        box._editCell(profile, cell._serialId);
                        _.asyRun(function () {
                            if (!profile.box) {
                                return
                            }
                            xui.use(src).parent().onMouseout(true, {
                                $force: true
                            }).parent().onMouseout(true, {
                                $force: true
                            })
                        })
                    }
                }
                if (!edit) {
                    if (cell && mode == "cell") {
                        id = xui.use(src).parent().id();
                        box._activeCell(profile, id)
                    }
                } else {
                    if (cell && mode == "cell") {
                        box._activeCell(profile, false)
                    }
                }
            }
            if (mode == "row") {
                id = xui.use(src).parent(2).id();
                box._activeRow(profile, id)
            }
        },
        _showTips: function (profile, node, pos) {
            if (profile.properties.disableTips) {
                return
            }
            if (profile.onShowTips) {
                return profile.boxing().onShowTips(profile, node, pos)
            }
            if (!xui.Tips) {
                return
            }
            var ks = profile.keys,
                item, hcell = ks.HCELL + ":",
                sid, id, pid;
            if (profile.properties.disabled) {
                return
            }
            id = node.id;
            pid = node.parentNode.id;
            sid = profile.getSubId(id);
            if (id.indexOf(ks.FCELL) == 0 || pid.indexOf(ks.FCELL) == 0) {
                item = profile.rowMap[sid]
            } else {
                if (id.indexOf(ks.HCELL) == 0 || pid.indexOf(ks.HCELL) == 0) {
                    item = profile.colMap[sid]
                } else {
                    if (id.indexOf(ks.CELL) == 0 || pid.indexOf(ks.CELL) == 0) {
                        item = profile.cellMap[sid]
                    }
                }
            }
            if (item) {
                xui.Tips.show(pos, ("tips" in item) ? item.tips : (item._$tips || item.caption))
            } else {
                xui.Tips.hide()
            }
            return true
        },
        _adjustRelWith: function (profile) {
            var prop = profile.properties,
                cols = profile.colMap,
                t2 = profile.getSubNode("SCROLL"),
                width = t2.width(),
                borderW = 0,
                borderC = 0;
            profile.getSubNodes("HCELL", true).each(function (hc) {
                if (hc.clientHeight) {
                    borderW = hc.offsetWidth - parseInt(hc.style.width);
                    return false
                }
            });
            var fixW = 0,
                relWTotal = 0,
                relWCol = [],
                relWCol2 = [];
            if (prop.rowHandler) {
                borderC++;
                fixW = prop.rowHandlerWidth
            }
            _.each(profile.colMap, function (col) {
                if (col.hidden) {
                    return
                }
                if (!col.hasOwnProperty("relWidth")) {
                    fixW += col.width
                } else {
                    relWTotal += parseFloat(col.width);
                    relWCol.push(col);
                    relWCol2.push(col)
                }
                borderC++
            });
            if (!relWCol.length) {
                return
            }
            while (relWCol.length && width != fixW + borderC * borderW) {
                var fW = width - (fixW + borderC * borderW),
                    fW1 = 0,
                    l = relWCol.length,
                    retry = 0;
                for (var i = l - 1; i >= 0; i--) {
                    var col = relWCol[i],
                        w = i === 0 ? (fW - fW1) : Math.round(fW * (col.width / relWTotal));
                    if (w < 0) {
                        w = 0
                    }
                    col.__tw = w;
                    if (col.hasOwnProperty("minWidth")) {
                        if (col.minWidth > w) {
                            fixW += col.minWidth;
                            col.__tw = col.minWidth;
                            _.arr.removeFrom(relWCol, i);
                            retry++
                        }
                    }
                    if (col.hasOwnProperty("maxWidth")) {
                        if (col.maxWidth < w) {
                            fixW += col.maxWidth;
                            col.__tw = col.maxWidth;
                            _.arr.removeFrom(relWCol, i);
                            retry++
                        }
                    }
                    fW1 += col.__tw
                }
                if (retry === 0 || retry === l) {
                    break
                }
            }
            if (relWCol2.length) {
                _.arr.each(relWCol2, function (col) {
                    var n, nodes = [];
                    _.each(col._cells, function (o) {
                        n = profile.getSubNode("CELL", o);
                        if (n._nodes.length) {
                            nodes.push(n.get(0))
                        }
                    });
                    n = profile.getSubNode("HCELL", col._serialId);
                    if (n._nodes.length) {
                        nodes.push(n.get(0))
                    }
                    xui(nodes).width(col.__tw);
                    delete col.__tw
                })
            }
        },
        _onresize: function (profile, width, height) {
            profile.getSubNode("BORDER").cssSize({
                width: width,
                height: height
            });
            var prop = profile.properties,
                t1 = profile.getSubNode("HEADER"),
                t2 = profile.getSubNode("SCROLL"),
                cols = profile.colMap,
                rh = 0;
            width = Math.round(width);
            profile.getSubNode("BOX").cssSize({
                width: width,
                height: height
            });
            if (width) {
                t1.width(width)
            }
            if (height) {
                rh = t1.offsetHeight()
            }
            t2.cssSize({
                width: width,
                height: height ? (height - rh) : null
            });
            this._ajdustBody(profile, function () {
                _.asyRun(function () {
                    if (!profile.box) {
                        return
                    }
                    t2.onScroll()
                })
            })
        }
    }
});
Class("xui.UI.Slider", ["xui.UI", "xui.absValue"], {
    Instance: {
        _setCtrlValue: function (value) {
            return this.each(function (profile) {
                var p = profile.properties,
                    steps = p.steps,
                    fun = function (k) {
                        return profile.getSubNode(k)
                    },
                    a = fun("IND1"),
                    b = fun("IND2"),
                    arr = profile.box._v2a(profile, value),
                    ori = p.type == "vertical" ? "top" : "left";
                a[ori](arr[0] + "%");
                if (p.isRange) {
                    b[ori](arr[1] + "%")
                }
            })
        },
        _setDirtyMark: function () {
            return arguments.callee.upper.apply(this, ["BOX"])
        }
    },
    Static: {
        Templates: {
            style: "{_style}",
            className: "{_className}",
            BOX: {
                tagName: "div",
                className: "{_cls}",
                BG: {
                    tagName: "div"
                },
                RULER: {
                    $order: 1,
                    tagName: "div",
                    RULERLEFT: {},
                    RULERRIGHT: {}
                },
                IND: {
                    $order: 2,
                    IND1: {
                        style: "{_showD}",
                        tabindex: "{tabindex}"
                    },
                    IND2: {
                        style: "{_showD2}",
                        tabindex: "{tabindex}"
                    }
                },
                DECREASE: {
                    style: "{_showDes}",
                    tabindex: "{tabindex}"
                },
                INCREASE: {
                    style: "{_showIns}",
                    tabindex: "{tabindex}"
                }
            }
        },
        Appearances: {
            "IND, BT, RULER, RULERLEFT, RULERRIGHT, IND1, IND2, DECREASE, INCREASE": {
                "font-size": 0,
                "line-height": 0,
                position: "absolute"
            },
            BOX: {
                position: "relative",
                left: 0,
                top: 0,
                width: "100%",
                height: "100%"
            },
            "BOX-h DECREASE, BOX-h INCREASE": {
                top: "50%",
                width: "17px",
                height: "17px",
                "margin-top": "-8px"
            },
            "BOX-v DECREASE, BOX-v INCREASE, BOX-h DECREASE, BOX-h INCREASE, BOX-h IND1,BOX-h IND2, BOX-v IND1,BOX-v IND2": {
                background: xui.UI.$bg("icons.gif", "no-repeat", true)
            },
            "BOX-h DECREASE": {
                $order: 1,
                left: 0,
                "background-position": "-80px -70px"
            },
            "BOX-h INCREASE": {
                $order: 1,
                right: 0,
                "background-position": "-100px -70px"
            },
            "BOX-h DECREASE-mouseover": {
                $order: 2,
                "background-position": "-80px -90px"
            },
            "BOX-h DECREASE-mousedown": {
                $order: 3,
                "background-position": "-80px -110px"
            },
            "BOX-h INCREASE-mouseover": {
                $order: 2,
                "background-position": "-100px -90px"
            },
            "BOX-h INCREASE-mousedown": {
                $order: 3,
                "background-position": "-100px -110px"
            },
            "BOX-h BG": {
                top: "50%"
            },
            "BOX-h IND, BOX-h RULER": {
                "z-index": 1,
                top: "50%",
                height: "6px",
                "margin-top": "-3px"
            },
            "BOX-h RULER, BOX-h RULERLEFT, BOX-h RULERRIGHT": {
                background: xui.UI.$bg("bar_vertical.gif", "repeat-x", true)
            },
            "BOX-h RULER": {
                $order: 2,
                "background-position": "left -482px"
            },
            "BOX-h RULERLEFT, BOX-h RULERRIGHT": {
                "z-index": 1,
                height: "6px",
                width: "5px"
            },
            "BOX-h RULERLEFT": {
                $order: 2,
                "background-position": "left -474px",
                left: "-4px",
                top: 0
            },
            "BOX-h RULERRIGHT": {
                $order: 2,
                "background-position": "left -490px",
                right: "-4px",
                top: 0
            },
            "BOX-h IND1,BOX-h IND2": {
                $order: 1,
                "z-index": 2,
                "background-position": "-21px -282px",
                height: "18px",
                width: "8px",
                left: 0,
                top: 0,
                cursor: "e-resize",
                "margin-top": "-6px"
            },
            "BOX-h IND1-mouseover,BOX-h IND2-mouseover": {
                $order: 2,
                "background-position": "-31px -282px"
            },
            "BOX-h IND1-mousedown,BOX-h IND2-mousedown": {
                $order: 3,
                "background-position": "-41px -282px"
            },
            "BOX-v DECREASE, BOX-v INCREASE": {
                $order: 10,
                left: "50%",
                width: "17px",
                height: "17px",
                "margin-left": "-8px"
            },
            "BOX-v DECREASE": {
                $order: 10,
                top: 0,
                "background-position": "-120px -70px"
            },
            "BOX-v INCREASE": {
                $order: 10,
                bottom: 0,
                "background-position": "-140px -70px"
            },
            "BOX-v DECREASE-mouseover": {
                $order: 11,
                "background-position": "-120px -90px"
            },
            "BOX-v DECREASE-mousedown": {
                $order: 12,
                "background-position": "-120px -110px"
            },
            "BOX-v INCREASE-mouseover": {
                $order: 11,
                "background-position": "-140px -90px"
            },
            "BOX-v INCREASE-mousedown": {
                $order: 12,
                "background-position": "-140px -110px"
            },
            "BOX-v BG": {
                $order: 10,
                left: "50%"
            },
            "BOX-v IND, BOX-v RULER": {
                $order: 10,
                "z-index": 1,
                left: "50%",
                width: "6px",
                "margin-left": "-3px"
            },
            "BOX-v RULER, BOX-v RULERLEFT, BOX-v RULERRIGHT": {
                background: xui.UI.$bg("bar_horizontal.gif", "repeat-y", true)
            },
            "BOX-v RULER": {
                $order: 10,
                "background-position": "-482px top"
            },
            "BOX-v RULERLEFT, BOX-v RULERRIGHT": {
                $order: 10,
                "z-index": 1,
                width: "6px",
                height: "5px"
            },
            "BOX-v RULERLEFT": {
                $order: 12,
                "background-position": "-490px top",
                top: "-4px",
                left: 0
            },
            "BOX-v RULERRIGHT": {
                $order: 12,
                "background-position": "-474px top",
                bottom: "-4px",
                left: 0
            },
            "BOX-v IND1,BOX-v IND2": {
                $order: 10,
                "z-index": 2,
                "background-position": "left -272px",
                width: "18px",
                height: "8px",
                left: 0,
                top: 0,
                cursor: "n-resize",
                "margin-left": "-6px"
            },
            "BOX-v IND1-mouseover,BOX-v IND2-mouseover": {
                $order: 11,
                "background-position": "left -282px"
            },
            "BOX-v IND1-mousedown,BOX-v IND2-mousedown": {
                $order: 12,
                "background-position": "left -292px"
            }
        },
        Behaviors: {
            HoverEffected: {
                IND1: "IND1",
                IND2: "IND2",
                DECREASE: "DECREASE",
                INCREASE: "INCREASE"
            },
            ClickEffected: {
                IND1: "IND1",
                IND2: "IND2",
                DECREASE: "DECREASE",
                INCREASE: "INCREASE"
            },
            onSize: xui.UI.$onSize,
            IND: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var p1 = xui.use(src).offset(),
                        p2 = xui.Event.getPos(e),
                        arr = profile.box._v2a(profile, profile.properties.$UIvalue),
                        i1, i2, type = p.type == "vertical",
                        k1 = type ? "top" : "left",
                        k2 = type ? "offsetTop" : "offsetLeft",
                        k3 = type ? "offsetHeight" : "offsetWidth",
                        cur = p2[k1] - p1[k1],
                        v = (cur / xui.use(src).get(0)[k3]) * 100;
                    if (!p.isRange) {
                        arr[0] = v
                    } else {
                        i1 = profile.getSubNode("IND1")[k2](), i2 = profile.getSubNode("IND2")[k2]();
                        if (Math.abs(i1 - cur) < Math.abs(i2 - cur)) {
                            arr[0] = v
                        } else {
                            arr[1] = v
                        }
                    }
                    profile.boxing().setUIValue(profile.box._adjustValue(profile, arr))
                }
            },
            IND1: {
                onKeydown: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var type = p.type == "vertical",
                        key = xui.Event.getKey(e).key;
                    if (key == (type ? "up" : "left")) {
                        profile.box._auto(profile, false)
                    }
                    if (key == (type ? "down" : "right")) {
                        profile.box._auto(profile, true)
                    }
                },
                onKeyout: function (profile) {
                    xui.Thread.abort(profile.$xid + ":auto")
                },
                onKeyup: function (profile) {
                    xui.Thread.abort(profile.$xid + ":auto")
                },
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var type = p.type == "vertical",
                        k2 = type ? "offsetTop" : "offsetLeft",
                        k3 = type ? "offsetHeight" : "offsetWidth",
                        box = profile.box;
                    xui.use(src).startDrag(e, {
                        widthIncrement: p.steps ? profile._size / p.steps : null,
                        dragType: "none",
                        targetReposition: true,
                        horizontalOnly: type ? true : null,
                        verticalOnly: type ? null : true,
                        maxLeftOffset: xui.use(src).get(0)[k2],
                        maxRightOffset: xui.use(src).parent().get(0)[k3] - xui.use(src).get(0)[k2],
                        dragCursor: "default"
                    });
                    xui.use(src).css("zIndex", 10).focus();
                    profile.getSubNode("IND2").css("zIndex", 5)
                },
                beforeDragbegin: function (profile, e, src) {
                    var type = profile.properties.type == "vertical";
                    xui(src)[type ? "top" : "left"](profile.__x = xui.use(src).get(0)[type ? "offsetTop" : "offsetLeft"])
                },
                onDrag: function (profile, e, src) {
                    var offset = xui.DragDrop.getProfile().offset,
                        type = profile.properties.type == "vertical",
                        arr = profile.box._v2a(profile, profile.properties.$UIvalue);
                    arr[0] = ((profile.__x + offset[type ? "y" : "x"]) / xui.use(src).parent().get(0)[type ? "offsetHeight" : "offsetWidth"]) * 100;
                    profile.boxing().setUIValue(profile.box._adjustValue(profile, arr))
                },
                onDragstop: function (profile, e, src) {
                    xui(src).onMouseout(true, {
                        $force: true
                    }).onMouseup(true)
                },
                onClick: function () {
                    return false
                }
            },
            IND2: {
                onKeydown: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var type = p.type == "vertical",
                        key = xui.Event.getKey(e).key;
                    if (key == (type ? "up" : "left")) {
                        profile.box._auto(profile, false)
                    }
                    if (key == (type ? "down" : "right")) {
                        profile.box._auto(profile, true)
                    }
                },
                onKeyout: function (profile) {
                    xui.Thread.abort(profile.$xid + ":auto")
                },
                onKeyup: function (profile) {
                    xui.Thread.abort(profile.$xid + ":auto")
                },
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var type = p.type == "vertical",
                        k2 = type ? "offsetTop" : "offsetLeft",
                        k3 = type ? "offsetHeight" : "offsetWidth",
                        box = profile.box;
                    xui.use(src).startDrag(e, {
                        widthIncrement: p.steps ? profile._size / p.steps : null,
                        dragType: "none",
                        targetReposition: true,
                        horizontalOnly: type ? true : null,
                        verticalOnly: type ? null : true,
                        maxLeftOffset: xui.use(src).get(0)[k2],
                        maxRightOffset: xui.use(src).parent().get(0)[k3] - xui.use(src).get(0)[k2],
                        dragCursor: "default"
                    });
                    xui.use(src).css("zIndex", 10).focus();
                    profile.getSubNode("IND1").css("zIndex", 5)
                },
                beforeDragbegin: function (profile, e, src) {
                    var type = profile.properties.type == "vertical";
                    xui(src)[type ? "top" : "left"](profile.__x = xui.use(src).get(0)[type ? "offsetTop" : "offsetLeft"])
                },
                onDrag: function (profile, e, src) {
                    var offset = xui.DragDrop.getProfile().offset,
                        type = profile.properties.type == "vertical",
                        arr = profile.box._v2a(profile, profile.properties.$UIvalue);
                    arr[1] = ((profile.__x + offset[type ? "y" : "x"]) / xui.use(src).parent().get(0)[type ? "offsetHeight" : "offsetWidth"]) * 100;
                    profile.boxing().setUIValue(profile.box._adjustValue(profile, arr))
                },
                onDragstop: function (profile, e, src) {
                    xui(src).onMouseout(true, {
                        $force: true
                    }).onMouseup(true)
                },
                onClick: function () {
                    return false
                }
            },
            RULERRIGHT: {
                onClick: function (profile, e, src) {
                    var p = profile.properties;
                    if (p.disabled || p.readonly) {
                        return
                    }
                    var b = profile.boxing(),
                        c = profile.box,
                        arr = c._v2a(profile, p.$UIvalue);
                    if (!p.isRange) {
                        arr[0] = 100
                    } else {
                        arr[1] = 100
                    }
                    b.setUIValue(profile.box._adjustValue(profile, arr))
                }
            },
            DECREASE: {
                onMousedown: function (profile) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    profile.box._auto(profile, false)
                },
                onMouseout: function (profile) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    xui.Thread.abort(profile.$xid + ":auto")
                },
                onMouseup: function (profile) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    xui.Thread.abort(profile.$xid + ":auto")
                }
            },
            INCREASE: {
                onMousedown: function (profile) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    profile.box._auto(profile, true)
                },
                onMouseout: function (profile) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    xui.Thread.abort(profile.$xid + ":auto")
                },
                onMouseup: function (profile) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    xui.Thread.abort(profile.$xid + ":auto")
                }
            }
        },
        DataModel: {
            position: "absolute",
            width: {
                ini: 200
            },
            height: {
                ini: 50
            },
            steps: 0,
            value: "0:0",
            type: {
                listbox: ["vertical", "horizontal"],
                ini: "horizontal",
                action: function (v) {
                    this.boxing().refresh()
                }
            },
            isRange: {
                ini: true,
                action: function (v) {
                    this.boxing().refresh()
                }
            },
            showIncreaseHandle: {
                ini: true,
                action: function (v) {
                    this.boxing().refresh()
                }
            },
            showDecreaseHandle: {
                ini: true,
                action: function (v) {
                    this.boxing().refresh()
                }
            }
        },
        _prepareData: function (profile) {
            var d = arguments.callee.upper.call(this, profile),
                N = "display:none";
            d._showDes = d.showDecreaseHandle ? "" : N, d._showIns = d.showIncreaseHandle ? "" : N, d._showD2 = d.isRange ? "" : N;
            d._cls = profile.getClass("BOX", d.type == "vertical" ? "-v" : "-h");
            return d
        },
        _adjustValue: function (profile, value) {
            var p = profile.properties,
                b = [];
            b[0] = parseFloat(value[0]) || 0;
            b[1] = parseFloat(value[1]) || 0;
            if (p.steps) {
                value = 100 / p.steps;
                b[0] = Math.ceil(b[0] / value);
                if (p.isRange) {
                    b[1] = Math.ceil(b[1] / value)
                }
            }
            return p.isRange ? b.join(":") : (b[0] + "")
        },
        _ensureValue: function (profile, value) {
            var p = profile.properties,
                a = String(value).split(":"),
                min = 0,
                max = p.steps ? p.steps : 100,
                b = [],
                f1 = function (a) {
                    return parseFloat(a) || 0
                },
                f2 = function (a) {
                    return Math.min(max, Math.max(min, a))
                };
            b[0] = f1(a[0]);
            if (p.isRange) {
                b[1] = f1(a[1]);
                if (b[0] > b[1]) {
                    a = b[1];
                    b[1] = b[0];
                    b[0] = a
                }
            }
            b[0] = f2(b[0]);
            if (p.isRange) {
                b[1] = f2(b[1])
            }
            return p.isRange ? b.join(":") : (b[0] + "")
        },
        _v2a: function (profile, v) {
            var steps = profile.properties.steps,
                t;
            v = typeof v == "string" ? v.split(":") : v;
            v[0] = parseFloat(v[0]) || 0;
            v[1] = parseFloat(v[1]) || 0;
            if (steps) {
                v[0] = v[0] * 100 / steps
            }
            if (steps) {
                v[1] = v[1] * 100 / steps
            }
            if (v[0] > v[1]) {
                t = v[0];
                v[1] = v[0];
                v[0] = t
            }
            return v
        },
        _auto: function (profile, flag) {
            var id = profile.$xid + ":auto";
            if (xui.Thread.isAlive(id)) {
                return
            }
            var p = profile.properties,
                t, off = (p.steps ? 100 / p.steps : 1) * (flag ? 1 : -1),
                task = {
                    delay: 300
                },
                arr = profile.box._v2a(profile, p.$UIvalue),
                fun = function () {
                    arr[0] += off;
                    if (p.isRange) {
                        arr[1] += off
                    }
                    profile.boxing().setUIValue(profile.box._adjustValue(profile, arr));
                    task.delay *= 0.8
                };
            task.task = fun;
            xui.Thread(id, [task], 500, null, fun, null, true).start()
        },
        _onresize: function (profile, width, height) {
            var p = profile.properties,
                type = p.type,
                f = function (k) {
                    return profile.getSubNode(k)
                },
                ruler = f("RULER"),
                ind = f("IND"),
                ru1 = f("RULERLEFT");
            if (type == "vertical") {
                var w = ru1.height(),
                    w1 = p.showDecreaseHandle ? f("DECREASE").height() : 0,
                    w2 = p.showIncreaseHandle ? f("INCREASE").height() : 0,
                    w3 = f("IND1").height();
                if (height) {
                    ruler.top(w1 + w).height(height - w1 - w2 - 2 * w);
                    ind.top(w1).height(profile._size = height - w1 - w2 - w3)
                }
            } else {
                var w = ru1.width(),
                    w1 = p.showDecreaseHandle ? f("DECREASE").width() : 0,
                    w2 = p.showIncreaseHandle ? f("INCREASE").width() : 0,
                    w3 = f("IND1").width();
                if (width) {
                    ruler.left(w1 + w).width(width - w1 - w2 - 2 * w);
                    ind.left(w1).width(profile._size = width - w1 - w2 - w3)
                }
            }
        }
    }
});
Class("xui.UI.Dialog", "xui.UI.Widget", {
    Instance: {
        showModal: function (parent, left, top) {
            this.show(parent, true, left, top)
        },
        show: function (parent, modal, left, top) {
            parent = parent || xui("body");
            return this.each(function (profile) {
                if (profile.inShowing) {
                    return
                }
                var t, p = profile.properties,
                    ins = profile.boxing(),
                    fun = function () {
                        var ins = profile.boxing();
                        if (left || left === 0) {
                            ins.setLeft(left)
                        }
                        if (top || top === 0) {
                            ins.setTop(top)
                        }
                        parent.append(ins);
                        var box = profile.box,
                            root = profile.getRoot();
                        var tt = profile._$rs_args;
                        xui.UI.$doResize(profile, (tt && tt[1]) || p.width, (tt && tt[2]) || p.height);
                        root.show(left ? (parseInt(left, 10) || 0) + "px" : null, top ? (parseInt(top, 10) || 0) + "px" : null);
                        if (p.iframeAutoLoad || p.ajaxAutoLoad) {
                            xui.UI.Div._applyAutoLoad(profile)
                        }
                        if (modal && !profile.$inModal) {
                            box._modal(profile)
                        }
                        ins.activate();
                        if (profile.onShow) {
                            profile.boxing().onShow(profile)
                        }
                        if (profile.properties.status == "normal") {
                            box._refreshRegion(profile)
                        }
                        delete profile.inShowing
                    };
                if (!profile._inited && p.initPos != "auto") {
                    var pr = parent.get(0) == xui("body").get(0) ? xui.win : (parent["xui.UI"] ? parent.getRoot() : parent);
                    switch (p.initPos) {
                    case "auto":
                        top = (top || top === 0) ? top : p.top;
                        left = (left || left === 0) ? left : p.left;
                    case "center":
                        top = (top || top === 0) ? top : Math.max(0, (pr.height() - p.height) / 2);
                        left = (left || left === 0) ? left : Math.max(0, (pr.width() - p.width) / 2);
                        break
                    }
                    if (left < 0) {
                        left = 0
                    }
                    if (top < 0) {
                        top = 0
                    }
                    profile._inited = 1
                } else {
                    top = (top || top === 0) ? top : p.top;
                    left = (left || left === 0) ? left : p.left
                }
                profile.inShowing = 1;
                if (t = p.fromRegion) {
                    xui.Dom.animate({
                        border: "dashed 1px #ff0000"
                    }, {
                        left: [t.left, left],
                        top: [t.top, top],
                        width: [t.width, p.width],
                        height: [t.height, p.height]
                    }, null, fun, 360, 12, "expoIn").start()
                } else {
                    fun()
                }
            })
        },
        hide: function () {
            this.each(function (profile) {
                var pro = profile.properties,
                    box = profile.box,
                    root = profile.getRoot();
                if (profile.inHiding) {
                    return
                }
                profile.inHiding = 1;
                if (profile.$inModal) {
                    box._unModal(profile)
                }
                if (pro.status == "max" || pro.status == "min") {
                    box._restore(profile)
                }
                root.hide();
                var t = pro.fromRegion,
                    fun = function () {
                        delete profile.inHiding
                    };
                if (t) {
                    xui.Dom.animate({
                        border: "dashed 1px #ff0000"
                    }, {
                        left: [pro.left, t.left],
                        top: [pro.top, t.top],
                        width: [pro.width, t.width],
                        height: [pro.height, t.height]
                    }, null, fun, 360, 12, "expoOut").start()
                } else {
                    fun()
                }
            });
            return this
        },
        close: function (triggerEvent) {
            return this.each(function (profile) {
                if (false !== triggerEvent && profile.beforeClose && false === profile.boxing().beforeClose(profile)) {
                    return
                }
                if (profile.inClosing) {
                    return
                }
                profile.inClosing = 1;
                var pro = profile.properties,
                    t = pro.fromRegion,
                    fun = function () {
                        profile.boxing().destroy();
                        delete profile.inClosing
                    };
                if (t) {
                    xui.Dom.animate({
                        border: "dashed 1px #ff0000"
                    }, {
                        left: [pro.left, t.left],
                        top: [pro.top, t.top],
                        width: [pro.width, t.width],
                        height: [pro.height, t.height]
                    }, null, fun, 360, 12, "expoOut").start()
                } else {
                    fun()
                }
            })
        },
        activate: function (flag) {
            var profile = this.get(0);
            profile.box._active(profile, flag);
            if (flag !== false) {
                _.resetRun("dlg_focus:" + profile.$xid, function () {
                    profile.getRoot().nextFocus()
                })
            }
        }
    },
    Initialize: function () {
        var ns = this,
            t = ns.getTemplate();
        _.merge(t.FRAME.BORDER, {
            TABSTOP1: {
                $order: -1
            },
            TBAR: {
                tagName: "div",
                className: "xui-uibar-top",
                TBART: {
                    cellpadding: "0",
                    cellspacing: "0",
                    width: "100%",
                    border: "0",
                    tagName: "table",
                    className: "xui-uibar-t",
                    TBARTR: {
                        tagName: "tr",
                        TBARTDL: {
                            tagName: "td",
                            className: "xui-uibar-tdl"
                        },
                        TBARTDM: {
                            $order: 1,
                            width: "100%",
                            tagName: "td",
                            className: "xui-uibar-tdm"
                        },
                        TBARTDR: {
                            $order: 2,
                            tagName: "td",
                            className: "xui-uibar-tdr"
                        }
                    }
                },
                BARCMDL: {
                    $order: 1,
                    tagName: "div",
                    className: "xui-uibar-cmdl",
                    ICON: {
                        $order: 0,
                        className: "xui-ui-icon {imageClass}",
                        style: "{backgroundImage} {backgroundPosition} {backgroundRepeat} {imageDisplay}"
                    },
                    CAPTION: {
                        $order: 1,
                        text: "{caption}"
                    }
                },
                BARCMDR: {
                    $order: 2,
                    tagName: "div",
                    className: "xui-uibar-cmdr",
                    INFO: {
                        className: "xui-uicmd-info",
                        style: "{infoDisplay}",
                        $order: 1
                    },
                    OPT: {
                        className: "xui-uicmd-opt",
                        style: "{optDisplay}",
                        $order: 1
                    },
                    PIN: {
                        $order: 2,
                        className: "xui-uicmd-pin",
                        style: "{pinDisplay}"
                    },
                    LAND: {
                        $order: 3,
                        className: "xui-uicmd-land",
                        style: "{landDisplay}"
                    },
                    REFRESH: {
                        className: "xui-uicmd-refresh",
                        style: "{refreshDisplay}",
                        $order: 4
                    },
                    MIN: {
                        $order: 5,
                        className: "xui-uicmd-min",
                        style: "{minDisplay}"
                    },
                    RESTORE: {
                        $order: 6,
                        className: "xui-uicmd-restore",
                        style: "display:none;"
                    },
                    MAX: {
                        $order: 7,
                        className: "xui-uicmd-max",
                        style: "{maxDisplay}"
                    },
                    CLOSE: {
                        $order: 8,
                        className: "xui-uicmd-close ",
                        style: "{closeDisplay}"
                    }
                }
            },
            MAIN: {
                $order: 2,
                tagName: "div",
                className: "xui-uicon-main",
                MAINI: {
                    tagName: "div",
                    className: "xui-uicon-maini",
                    PANEL: {
                        tagName: "div",
                        style: "{_overflow};",
                        text: "{html}" + xui.UI.$childTag
                    }
                }
            },
            BBAR: {
                $order: 3,
                tagName: "div",
                className: "xui-uibar-bottom",
                BBART: {
                    cellpadding: "0",
                    cellspacing: "0",
                    width: "100%",
                    border: "0",
                    tagName: "table",
                    className: "xui-uibar-t",
                    BBARTR: {
                        tagName: "tr",
                        BBARTDL: {
                            tagName: "td",
                            className: "xui-uibar-tdl"
                        },
                        BBARTDM: {
                            $order: 1,
                            width: "100%",
                            tagName: "td",
                            className: "xui-uibar-tdm"
                        },
                        BBARTDR: {
                            $order: 2,
                            tagName: "td",
                            className: "xui-uibar-tdr"
                        }
                    }
                }
            },
            TABSTOP2: {
                $order: 9
            }
        }, "all");
        ns.setTemplate(t);
        xui.alert = ns.alert;
        xui.confirm = ns.confirm;
        xui.pop = ns.pop;
        xui.prompt = ns.prompt
    },
    Static: {
        Appearances: {
            KEY: {
                overflow: "visible"
            },
            "TABSTOP1,TABSTOP2": {
                height: 0,
                width: "16px",
                display: "inline",
                position: "absolute"
            },
            PANEL: {
                position: "relative",
                overflow: "auto",
                "font-size": "12px",
                "line-height": "1"
            },
            CAPTION: {
                "font-size": "12px",
                display: "inline",
                "vertical-align": xui.browser.ie6 ? "baseline" : "middle"
            },
            BORDER: {
                position: "relative",
                "font-size": 0,
                "line-height": 0
            }
        },
        Behaviors: {
            DroppableKeys: ["PANEL"],
            PanelKeys: ["PANEL"],
            DraggableKeys: ["LAND"],
            HoverEffected: {
                INFO: "INFO",
                OPT: "OPT",
                PIN: "PIN",
                MIN: "MIN",
                MAX: "MAX",
                RESTORE: "RESTORE",
                CLOSE: "CLOSE",
                REFRESH: "REFRESH",
                LAND: "LAND"
            },
            ClickEffected: {
                INFO: "INFO",
                OPT: "OPT",
                PIN: "PIN",
                MIN: "MIN",
                MAX: "MAX",
                RESTORE: "RESTORE",
                CLOSE: "CLOSE",
                REFRESH: "REFRESH",
                LAND: "LAND"
            },
            onMousedown: function (profile, e) {
                profile.box._active(profile)
            },
            afterKeydown: function (profile, e) {
                var keys = xui.Event.getKey(e);
                if ((e.$key || e.keyCode || e.charCode) == 9) {
                    if (xui.browser.ie) {
                        var id = "xui::_specialforietab";
                        if (!xui.Dom.byId(id)) {
                            xui("body").append("<div style='display:none;position:absolute;' id=" + id + "></div>")
                        }
                        xui.Dom.byId(id).innerHTML = _() + ""
                    }
                    var n1 = profile.getSubNode("TABSTOP1").get(0),
                        n2 = profile.getSubNode("TABSTOP2").get(0),
                        m = xui.Event.getSrc(e),
                        t;
                    if (keys.shiftKey) {
                        if (m !== n1) {
                            n1.tabIndex = m.tabIndex
                        }
                        n2.removeAttribute("tabIndex")
                    } else {
                        if (m !== n2) {
                            n2.tabIndex = m.tabIndex
                        }
                        n1.removeAttribute("tabIndex")
                    }
                    n1 = n2 = m = null
                }
            },
            onDragstop: function (profile) {
                var pos = profile.getRoot().cssPos(),
                    p = profile.properties,
                    l = null,
                    t = null;
                if (p.left !== pos.left) {
                    p.left = l = pos.left
                }
                if (p.top !== pos.top) {
                    p.top = t = pos.top
                }
                if (profile.onMove && (l !== null || t !== null)) {
                    profile.boxing().onMove(profile, l, t, null, null)
                }
            },
            TABSTOP1: {
                onFocus: function (profile, e, src) {
                    var tabindex = parseInt(xui.use(src).get(0).tabIndex || 1 + "", 10) - 1;
                    var children = profile.getRoot().get(0).getElementsByTagName("*"),
                        t, n;
                    for (var i = 0, l = children.length, o; o = children[i]; i++) {
                        if (o.nodeType == 1) {
                            if (o.tabIndex && o.tabIndex <= tabindex) {
                                if (!t) {
                                    t = (n = o).tabIndex
                                }
                                if (o.tabIndex > t) {
                                    t = (n = o).tabIndex
                                }
                                if (t === tabindex) {
                                    break
                                }
                            }
                        }
                    }
                    if (o) {
                        xui(o).focus();
                        xui.use(src).get(0).tabIndex = o.tabIndex
                    } else {
                        o = profile.getRoot().nextFocus(false, true, false);
                        xui(o).focus();
                        xui.use(src).get(0).tabIndex = o.get(0).tabIndex
                    }
                    children = o = null
                }
            },
            TABSTOP2: {
                onFocus: function (profile, e, src) {
                    var tabindex = parseInt(xui.use(src).get(0).tabIndex || 1 + "") + 1;
                    var children = profile.getRoot().get(0).getElementsByTagName("*"),
                        t, n;
                    for (var i = 0, l = children.length, o; o = children[i]; i++) {
                        if (o.nodeType == 1) {
                            if (o.tabIndex && o.tabIndex >= tabindex) {
                                if (!t) {
                                    t = (n = o).tabIndex
                                }
                                if (o.tabIndex < t) {
                                    t = (n = o).tabIndex
                                }
                                if (t === tabindex) {
                                    break
                                }
                            }
                        }
                    }
                    if (o) {
                        xui(o).focus();
                        xui.use(src).get(0).tabIndex = o.tabIndex
                    } else {
                        o = profile.getRoot().nextFocus(true, true, false);
                        xui(o).focus();
                        xui.use(src).get(0).tabIndex = o.get(0).tabIndex
                    }
                    children = o = null
                }
            },
            TBAR: {
                onMousedown: function (profile, e, src) {
                    if (xui.Event.getBtn(e) != "left") {
                        return
                    }
                    if (profile.getKey(xui.Event.getSrc(e).parentNode.id) == profile.keys.BARCMDR) {
                        return
                    }
                    if (profile.properties.movable && !profile._locked) {
                        profile.box._active(profile);
                        profile.getRoot().startDrag(e, {
                            dragDefer: 1,
                            maxTopOffset: profile.getRoot().top(),
                            maxLeftOffset: profile.getRoot().left(),
                            targetOffsetParent: profile.getRoot().parent()
                        })
                    }
                },
                onDblclick: function (profile, e, src) {
                    if (profile.getKey(xui.Event.getSrc(e).parentNode.id) == profile.keys.BARCMDR) {
                        return
                    }
                    if (!profile.properties.maxBtn) {
                        return
                    }
                    if (profile.properties.status == "max") {
                        profile.box._restore(profile)
                    } else {
                        profile.box._max(profile)
                    }
                }
            },
            PIN: {
                onClick: function (profile, e, src) {
                    var key = profile.keys.PIN,
                        t = profile.properties;
                    t.pinned = !t.pinned;
                    profile.getSubNode("PIN").tagClass("-checked", t.pinned);
                    profile._locked = t.pinned;
                    if (t.resizer) {
                        if (!t.pinned) {
                            if (t.status != "min" && profile.$resizer) {
                                profile.$resizer.show()
                            }
                        } else {
                            if (profile.$resizer) {
                                profile.$resizer.hide()
                            }
                        }
                    }
                }
            },
            MIN: {
                onClick: function (profile, e, src) {
                    profile.box._min(profile)
                }
            },
            MAX: {
                onClick: function (profile, e, src) {
                    profile.box._max(profile)
                }
            },
            RESTORE: {
                onClick: function (profile, e, src) {
                    profile.box._restore(profile)
                }
            },
            INFO: {
                onClick: function (profile, e, src) {
                    profile.boxing().onShowInfo(profile, e, src)
                }
            },
            OPT: {
                onClick: function (profile, e, src) {
                    profile.boxing().onShowOptions(profile, e, src)
                }
            },
            REFRESH: {
                onClick: function (profile, e, src) {
                    profile.boxing().onRefresh(profile)
                }
            },
            CLOSE: {
                onClick: function (profile, e, src) {
                    profile.boxing().close()
                }
            },
            LAND: {
                onClick: function (profile, e, src) {
                    profile.boxing().onLand(profile, e, src)
                }
            }
        },
        DataModel: {
            selectable: true,
            tips: null,
            border: null,
            disabled: null,
            dock: "none",
            initPos: {
                ini: "center",
                listbox: ["auto", "center"]
            },
            iframeAutoLoad: "",
            ajaxAutoLoad: "",
            html: {
                html: 1,
                action: function (v) {
                    this.getSubNode("PANEL").html(xui.adjustRes(v, 0, 1))
                }
            },
            overflow: {
                ini: xui.browser.isTouch ? "auto" : undefined,
                listbox: ["", "visible", "hidden", "scroll", "auto"],
                action: function (v) {
                    this.getSubNode("PANEL").css("overflow", v || "")
                }
            },
            caption: {
                ini: undefined,
                action: function (v) {
                    v = (_.isSet(v) ? v : "") + "";
                    this.getSubNode("CAPTION").html(xui.adjustRes(v, true))
                }
            },
            image: {
                format: "image",
                action: function (value) {
                    this.getSubNode("ICON").css("display", value ? "" : "none").css("backgroundImage", "url(" + xui.adjustRes(value || "") + ")")
                }
            },
            imagePos: {
                action: function (value) {
                    this.getSubNode("ICON").css("backgroundPosition", value)
                }
            },
            shadow: true,
            resizer: true,
            movable: true,
            minBtn: {
                ini: true,
                action: function (v) {
                    var o = this.getSubNode("MIN");
                    if (v) {
                        o.setInlineBlock()
                    } else {
                        o.css("display", "none")
                    }
                }
            },
            maxBtn: {
                ini: true,
                action: function (v) {
                    var o = this.getSubNode("MAX");
                    if (v) {
                        o.setInlineBlock()
                    } else {
                        o.css("display", "none")
                    }
                }
            },
            infoBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("INFO").css("display", v ? "" : "none")
                }
            },
            optBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("OPT").css("display", v ? "" : "none")
                }
            },
            closeBtn: {
                ini: true,
                action: function (v) {
                    var o = this.getSubNode("CLOSE");
                    if (v) {
                        o.setInlineBlock()
                    } else {
                        o.css("display", "none")
                    }
                }
            },
            refreshBtn: {
                ini: false,
                action: function (v) {
                    this.getSubNode("REFRESH").css("display", v ? "" : "none")
                }
            },
            pinBtn: {
                ini: false,
                action: function (v) {
                    var o = this.getSubNode("PIN");
                    if (v) {
                        o.setInlineBlock()
                    } else {
                        o.css("display", "none")
                    }
                }
            },
            landBtn: {
                ini: false,
                action: function (v) {
                    var o = this.getSubNode("LAND");
                    if (v) {
                        o.setInlineBlock()
                    } else {
                        o.css("display", "none")
                    }
                }
            },
            width: 300,
            height: 300,
            minWidth: 200,
            minHeight: 100,
            position: "absolute",
            fromRegion: {
                hidden: true,
                ini: null
            },
            status: {
                ini: "normal",
                listbox: ["normal", "min", "max"],
                action: function (v, o) {
                    var self = this,
                        b = self.box;
                    if (v == "min") {
                        b._min(self, o)
                    } else {
                        if (v == "max") {
                            b._max(self, o)
                        } else {
                            b._restore(self, o)
                        }
                    }
                }
            }
        },
        EventHandlers: {
            onRefresh: function (profile) {},
            onShow: function (profile) {},
            beforeClose: function (profile) {},
            onShowInfo: function (profile, e, src) {},
            onShowOptions: function (profile, e, src) {},
            onLand: function (profile, e, src) {}
        },
        RenderTrigger: function () {
            this.destroyTrigger = function () {
                var s = this;
                if (s.$inModal) {
                    s.box._unModal(s)
                }
            }
        },
        LayoutTrigger: function () {
            var self = this,
                t = self.properties,
                b = self.box;
            if (t.status == "min") {
                b._min(self)
            } else {
                if (t.status == "max") {
                    b._max(self)
                } else {
                    xui.UI.$tryResize(self, t.width, t.height)
                }
            }
        },
        _prepareData: function (profile) {
            var data = arguments.callee.upper.call(this, profile),
                nodisplay = "display:none";
            data.minDisplay = data.minBtn ? "" : nodisplay;
            data.maxDisplay = data.maxBtn ? "" : nodisplay;
            data.infoDisplay = data.infoBtn ? "" : nodisplay;
            data.optDisplay = data.optBtn ? "" : nodisplay;
            data.closeDisplay = data.closeBtn ? "" : nodisplay;
            data.pinDisplay = data.pinBtn ? "" : nodisplay;
            data.landDisplay = data.landBtn ? "" : nodisplay;
            data.refreshDisplay = data.refreshBtn ? "" : nodisplay;
            data.statusDisplay = data.statusDisplay ? "" : nodisplay;
            data.statusHeight = "height:" + data.statusHeight + "px";
            var status = profile.properties.status;
            if (status == "min" || status == "max") {
                profile.$noR = profile.$noS = 1
            }
            if (_.isStr(data.overflow)) {
                data._overflow = data.overflow.indexOf(":") != -1 ? (data.overflow) : ("overflow:" + data.overflow)
            }
            return data
        },
        _min: function (profile, status) {
            var o = profile.getRoot(),
                box = profile.box,
                p = o.parent(),
                t = profile.properties;
            if (!status) {
                status = t.status
            }
            if (status == "max") {
                box._unMax(profile)
            } else {
                box._refreshRegion(profile)
            }
            profile.getSubNodes(["PANEL", "STATUS"]).css("display", "none");
            if (t.minBtn) {
                profile.getSubNode("RESTORE").setInlineBlock();
                profile.getSubNode("MIN").css("display", "none")
            }
            if (t.resizer && profile.$resizer) {
                profile.$resizer.hide()
            }
            if (t.shadow) {
                profile.boxing()._unShadow(false)
            }
            t.status = "min";
            var h1 = o.height(),
                h2 = profile.getSubNode("BORDER").height(),
                h = profile.getSubNode("TBAR").height();
            o.cssSize({
                width: t.minWidth,
                height: h + h1 - h2
            }, true)
        },
        _max: function (profile, status) {
            var o = profile.getRoot(),
                box = profile.box,
                ins = profile.boxing(),
                p = o.parent(),
                t = profile.properties;
            if (!status) {
                status = t.status
            }
            if (status == "min") {
                box._unMin(profile)
            } else {
                box._refreshRegion(profile)
            }
            if (t.pinBtn) {
                profile.getSubNode("PIN").css("display", "none")
            }
            if (t.maxBtn) {
                profile.getSubNode("MAX").css("display", "none");
                profile.getSubNode("RESTORE").setInlineBlock()
            }
            profile.old_m = t.movable;
            t.movable = false;
            if (t.resizer && profile.$resizer) {
                profile.$resizer.hide()
            }
            if (t.shadow) {
                ins._unShadow(false)
            }
            t.status = "max";
            ins.setDock("fill")
        },
        _restore: function (profile, status) {
            var o = profile.getRoot(),
                box = profile.box,
                t = profile.properties;
            if (!status) {
                status = t.status
            }
            t.status = "normal";
            if (status == "max") {
                box._unMax(profile)
            }
            if (status == "min") {
                box._unMin(profile)
            }
            profile.getSubNode("RESTORE").css("display", "none")
        },
        _unMax: function (profile) {
            var t = profile.properties,
                ins = profile.boxing();
            profile.getSubNode("MAX").setInlineBlock();
            if (t.pinBtn) {
                profile.getSubNode("PIN").setInlineBlock()
            }
            t.movable = profile.old_m;
            if (t.shadow) {
                ins._shadow()
            }
            if (t.resizer && !t.pinned) {
                if (profile.$resizer) {
                    profile.$resizer.show()
                } else {
                    ins._resizer()
                }
            }
            ins.setDock("none");
            xui.UI.$tryResize(profile, t.width, t.height, true)
        },
        _unMin: function (profile) {
            var t = profile.properties,
                ins = profile.boxing();
            profile.getSubNodes(["PANEL", "STATUS"]).css("display", "block");
            profile.getSubNode("MIN").setInlineBlock();
            if (t.shadow) {
                ins._shadow()
            }
            if (t.resizer && !t.pinned) {
                if (profile.$resizer) {
                    profile.$resizer.show()
                } else {
                    ins._resizer()
                }
            }
            profile.getRoot().cssSize({
                width: t.width,
                height: t.height
            });
            xui.UI.$tryResize(profile, t.width, t.height, true)
        },
        _active: function (profile, flag) {
            var self = this;
            if (flag !== false && self.activeWndId == profile.$xid) {
                return
            }
            self._deActive();
            if (flag !== false) {
                var o = xui(profile.domId),
                    t1 = o.topZindex(),
                    t2 = o.css("zIndex");
                o.css("zIndex", t1 > t2 ? t1 : t2);
                profile.getSubNode("TBAR").tagClass("-focus");
                self.activeWndId = profile.$xid
            }
        },
        _deActive: function () {
            var profile;
            if (profile = xui.UI._cache["$" + this.activeWndId]) {
                profile.getSubNode("TBAR").tagClass("-focus", false)
            }
            delete this.activeWndId
        },
        _modal: function (profile) {
            var s = profile.getRoot(),
                temp, p = s.parent(),
                cover;
            if (!p.isEmpty()) {
                if (!profile.$inModal) {
                    cover = profile.$modalDiv;
                    if (!cover || !cover.get(0) || !cover.get(0).parentNode) {
                        cover = profile.$modalDiv = xui.create("<div style='left:0;top:0;position:absolute;overflow:hidden;display:block;z-index:0;cursor:wait;background-image:url(" + xui.ini.img_bg + ")'></div>")
                    }
                    p.append(cover);
                    if (p.get(0) === document.body || p.get(0) === document || p.get(0) === window) {
                        p = xui.win
                    }
                    cover.css({
                        display: "block",
                        width: Math.max(p.width(), p.scrollWidth()) + "px",
                        height: Math.max(p.height(), p.scrollHeight()) + "px"
                    }).onMousedown(function () {
                        return false
                    }).topZindex(true);
                    p.onSize(function (p) {
                        p = xui(p);
                        cover.width(p.width()).height(p.height());
                        _.asyRun(function () {
                            cover.width(Math.max(p.width(), p.scrollWidth()));
                            cover.height(Math.max(p.height(), p.scrollHeight()))
                        })
                    }, "dialog:" + profile.serialId);
                    s.css("zIndex", (parseInt(cover.css("zIndex"), 10) || 0) + 1);
                    profile.$inModal = true
                }
            }
        },
        _unModal: function (profile) {
            if (profile.$inModal) {
                var p = profile.$modalDiv.parent();
                if (p.get(0) === document.body || p.get(0) === document || p.get(0) === window) {
                    p = xui.win
                }
                p.onSize(null, "dialog:" + profile.serialId);
                profile.getRoot().css("zIndex", 0);
                profile.getSubNode("BORDER").append(profile.$modalDiv.css("display", "none"));
                profile.$inModal = false
            }
        },
        _refreshRegion: function (profile) {
            if (!profile.renderId) {
                return
            }
            var pro = profile.properties;
            return _.merge(pro, profile.getRoot().cssRegion(), function (o, i) {
                return pro[i] != "auto"
            })
        },
        _adjust: function (dialog, caption, content, left, top) {
            caption = caption || "";
            if (!content) {
                content = caption;
                caption = ""
            }
            var node = dialog.$div.reBoxing(),
                ID = "xui:temp:dialog",
                me = arguments.callee,
                w, h;
            if (!xui.Dom.byId(ID)) {
                n2 = me._cache = node.clone(false);
                xui("body").append(n2);
                n2.css({
                    overflow: "visible",
                    position: "absolute",
                    visibility: "visible",
                    left: xui.Dom.HIDE_VALUE,
                    top: xui.Dom.HIDE_VALUE
                }).id(ID, true)
            }
            var n2 = me._cache;
            n2.width("auto").height("auto");
            n2.html(content, false);
            var size = n2.cssSize();
            node.html(content);
            if (size.width > 500) {
                size.width = 500;
                n2.width(500);
                size.height = n2.offsetHeight() + 10;
                n2.width("auto")
            }
            n2.html("", false);
            size.height += 10;
            if (size.height > 400) {
                size.height = 400
            }
            if (size.width < 150) {
                size.width = 150
            }
            if (size.height < 30) {
                size.height = 30
            }
            node.cssSize(size).css("overflow", "auto").show();
            w = size.width + 40;
            h = size.height + 90;
            dialog.setCaption(caption).setWidth(w).setHeight(h);
            return {
                width: w,
                height: h
            }
        },
        alert: function (title, content, onClose, btnCap, left, top, parent, subId, noCache) {
            var me = arguments.callee,
                dialog;
            if (noCache || !(dialog = me.dialog) || !dialog.get(0) || (!dialog.get(0).renderId)) {
                dialog = new xui.UI.Dialog({
                    overflow: "hidden",
                    minBtn: false,
                    maxBtn: false,
                    pinBtn: false,
                    resizer: false
                }, {
                    beforeClose: function () {
                        _.tryF(dialog._$onClose);
                        dialog._$onClose = null;
                        if (!noCache) {
                            dialog.hide();
                            return false
                        }
                    },
                    onHotKeydown: function (p, k) {
                        if (k.key == "esc") {
                            dialog.close()
                        }
                    }
                });
                var cmd = dialog.$cmd = new xui.UI.Div({
                    height: 26,
                    dock: "bottom"
                }, null, null, null, {
                    KEY: "text-align:center;"
                }),
                    btn = dialog.$btn = new xui.UI.SButton({
                        position: "relative",
                        tabindex: 1
                    }, {
                        onClick: function () {
                            dialog.close()
                        },
                        onHotKeydown: function (p, k) {
                            if (k.key == "enter") {
                                dialog.close()
                            }
                        }
                    }, null, null, {
                        KEY: "margin:0 4px"
                    });
                cmd.append(btn);
                var div = dialog.$div = new xui.UI.Div({
                    left: 10,
                    top: 10
                });
                dialog.append(cmd).append(div).render();
                if (!noCache) {
                    me.dialog = dialog
                }
            }
            dialog._$onClose = onClose;
            dialog.$btn.setCaption("&nbsp;&nbsp;" + (btnCap || xui.wrapRes("$inline.ok")) + "&nbsp;&nbsp;");
            var size = xui.UI.Dialog._adjust(dialog, title, content);
            if (parent && parent["xui.UI"]) {
                parent = parent.getContainer(subId)
            }
            if (!_.isSet(parent)) {
                parent = xui("body")
            }
            if (!_.isSet(left)) {
                left = ((parent.get(0) == xui("body").get(0) ? xui.win : parent).width() - size.width) / 2
            }
            if (!_.isSet(top)) {
                top = ((parent.get(0) == xui("body").get(0) ? xui.win : parent).height() - size.height) / 2
            }
            dialog.show(parent, true, left, top);
            _.resetRun("dlg_focus:" + dialog.get(0).$xid, function () {
                dialog.$btn.activate()
            });
            return dialog
        },
        confirm: function (title, caption, onYes, onNo, btnCapYes, btnCapNo, left, top, parent, subId, noCache) {
            var me = arguments.callee,
                dialog;
            if (noCache || !(dialog = me.dialog) || !dialog.get(0) || (!dialog.get(0).renderId)) {
                dialog = new xui.UI.Dialog({
                    overflow: "hidden",
                    minBtn: false,
                    maxBtn: false,
                    pinBtn: false,
                    resizer: false
                }, {
                    beforeClose: function () {
                        if (!dialog._$_clicked) {
                            _.tryF(dialog._$onNo, ["close"])
                        } else {
                            delete dialog._$_clicked
                        }
                        dialog._$onYes = dialog._$onNo = null;
                        if (!noCache) {
                            dialog.hide();
                            return false
                        }
                    }
                });
                var cmd = dialog.$cmd = new xui.UI.Div({
                    height: 26,
                    dock: "bottom"
                }, null, null, null, {
                    KEY: "text-align:center;"
                }),
                    btn = dialog.$btn1 = new xui.UI.SButton({
                        tabindex: 1,
                        position: "relative"
                    }, {
                        onClick: function () {
                            _.tryF(dialog._$onYes);
                            dialog._$_clicked = 1;
                            dialog.close()
                        }
                    }, null, null, {
                        KEY: "margin:0 4px"
                    });
                cmd.append(btn);
                btn = dialog.$btn2 = new xui.UI.SButton({
                    tabindex: 1,
                    position: "relative"
                }, {
                    onClick: function () {
                        _.tryF(dialog._$onNo, ["no"]);
                        dialog._$_clicked = 1;
                        dialog.close()
                    }
                }, null, null, {
                    KEY: "margin:0 4px"
                });
                cmd.append(btn);
                var div = dialog.$div = new xui.UI.Div({
                    left: 10,
                    top: 10
                });
                dialog.append(cmd).append(div).render();
                if (!noCache) {
                    me.dialog = dialog
                }
            }
            dialog._$onYes = onYes;
            dialog._$onNo = onNo;
            delete dialog._$_clicked;
            dialog.$btn1.setCaption("&nbsp;&nbsp;" + (btnCapYes || xui.wrapRes("$inline.yes")) + "&nbsp;&nbsp;");
            dialog.$btn2.setCaption("&nbsp;&nbsp;" + (btnCapNo || xui.wrapRes("$inline.no")) + "&nbsp;&nbsp;");
            var size = xui.UI.Dialog._adjust(dialog, title, caption);
            if (parent && parent["xui.UI"]) {
                parent = parent.getContainer(subId)
            }
            if (!_.isSet(parent)) {
                parent = xui("body")
            }
            if (!_.isSet(left)) {
                left = ((parent.get(0) == xui("body").get(0) ? xui.win : parent).width() - size.width) / 2
            }
            if (!_.isSet(top)) {
                top = ((parent.get(0) == xui("body").get(0) ? xui.win : parent).height() - size.height) / 2
            }
            dialog.show(parent, true, left, top);
            _.resetRun("dlg_focus:" + dialog.get(0).$xid, function () {
                dialog.$btn2.activate()
            });
            return dialog
        },
        pop: function (title, content, btnCap, left, top, parent, subId) {
            var dialog = new xui.UI.Dialog({
                overflow: "hidden",
                minBtn: false,
                maxBtn: false,
                pinBtn: false,
                resizer: false
            }, {
                onHotKeydown: function (p, k) {
                    if (k.key == "esc") {
                        dialog.close()
                    }
                }
            }),
                cmd = dialog.$cmd = new xui.UI.Div({
                    height: 26,
                    dock: "bottom"
                }, null, null, null, {
                    KEY: "text-align:center;"
                }).append(dialog.$btn = new xui.UI.SButton({
                    caption: "&nbsp;&nbsp;" + (btnCap || "$inline.ok") + "&nbsp;&nbsp;",
                    tabindex: 1,
                    position: "relative"
                }, {
                    onClick: function () {
                        dialog.destroy()
                    },
                    onHotKeydown: function (p, k) {
                        if (k.key == "enter") {
                            dialog.close()
                        }
                    }
                }, null, null, {
                    KEY: "margin:0 4px"
                })),
                div = dialog.$div = new xui.UI.Div({
                    left: 10,
                    top: 10,
                    width: 80
                }).setCustomStyle({
                    KEY: "overflow:visible"
                });
            dialog.append(cmd).append(div).render();
            var size = xui.UI.Dialog._adjust(dialog, title, content);
            if (parent && parent["xui.UI"]) {
                parent = parent.getContainer(subId)
            }
            if (!_.isSet(parent)) {
                parent = xui("body")
            }
            if (!_.isSet(left)) {
                left = ((parent.get(0) == xui("body").get(0) ? xui.win : parent).width() - size.width) / 2
            }
            if (!_.isSet(top)) {
                top = ((parent.get(0) == xui("body").get(0) ? xui.win : parent).height() - size.height) / 2
            }
            dialog.show(parent, false, left, top);
            _.resetRun("dlg_focus:" + dialog.get(0).$xid, function () {
                dialog.$btn.activate()
            });
            return dialog
        },
        prompt: function (title, caption, content, onYes, onNo, btnCapYes, btnCapNo, left, top, parent, subId, noCache) {
            var dialog, me = arguments.callee;
            if (noCache || !(dialog = me.dialog) || !dialog.get(0) || (!dialog.get(0).renderId)) {
                dialog = new xui.UI.Dialog({
                    overflow: "hidden",
                    minBtn: false,
                    maxBtn: false,
                    pinBtn: false,
                    resizer: false,
                    left: 200,
                    top: 200,
                    width: 300,
                    height: 130
                }, {
                    beforeClose: function () {
                        if (!dialog._$_clickYes) {
                            _.tryF(dialog._$onNo)
                        } else {
                            delete dialog._$_clickYes
                        }
                        dialog._$inp.setValue("");
                        dialog._$onYes = dialog._$onNo = null;
                        if (!noCache) {
                            dialog.hide();
                            return false
                        }
                    }
                });
                var con = dialog._$con = new xui.UI.Div({
                    top: 4,
                    left: 10,
                    width: 270,
                    height: 18
                }),
                    cmd = new xui.UI.Div({
                        height: 26,
                        dock: "bottom"
                    }, null, null, null, {
                        KEY: "text-align:center;"
                    }).append(dialog.$btn1 = new xui.UI.SButton({
                        position: "relative",
                        tabindex: 1
                    }, {
                        onClick: function () {
                            if (false !== _.tryF(dialog._$onYes, [dialog._$inp.getUIValue()])) {
                                dialog._$_clickYes = 1;
                                dialog.close()
                            }
                        }
                    }, null, null, {
                        KEY: "margin:0 4px"
                    }));
                cmd.append(dialog.$btn2 = new xui.UI.SButton({
                    tabindex: 1,
                    position: "relative"
                }, {
                    onClick: function () {
                        dialog.close()
                    }
                }, null, null, {
                    KEY: "margin:0 4px"
                }));
                var inp = dialog._$inp = new xui.UI.Input({
                    left: 10,
                    top: 22,
                    width: 270,
                    height: 36,
                    multiLines: true
                });
                dialog.append(con).append(cmd).append(inp).render();
                if (!noCache) {
                    me.dialog = dialog
                }
            }
            dialog.setCaption(title || "Prompt");
            dialog._$con.setHtml(caption || "");
            dialog._$inp.setValue(content || "", true);
            dialog._$onYes = onYes;
            dialog._$onNo = onNo;
            delete dialog._$_clickYes;
            dialog.$btn1.setCaption("&nbsp;&nbsp;" + (btnCapYes || xui.wrapRes("$inline.ok")) + "&nbsp;&nbsp;");
            dialog.$btn2.setCaption("&nbsp;&nbsp;" + (btnCapNo || xui.wrapRes("$inline.cancel")) + "&nbsp;&nbsp;");
            if (parent && parent["xui.UI"]) {
                parent = parent.getContainer(subId)
            }
            if (!_.isSet(parent)) {
                parent = xui("body")
            }
            if (!_.isSet(left)) {
                left = ((parent.get(0) == xui("body").get(0) ? xui.win : parent).width() - dialog.getWidth()) / 2
            }
            if (!_.isSet(top)) {
                top = ((parent.get(0) == xui("body").get(0) ? xui.win : parent).height() - dialog.getHeight()) / 2
            }
            dialog.show(parent, true, left, top);
            _.resetRun("dlg_focus:" + dialog.get(0).$xid, function () {
                dialog._$inp.activate()
            });
            return dialog
        },
        _onresize: function (profile, width, height, force) {
            if (width && profile.properties.status == "min") {
                width = profile.properties.minWidth
            }
            var size = arguments.callee.upper.apply(this, arguments),
                isize = {},
                v1 = profile.getSubNode("TBAR"),
                v2 = profile.getSubNode("PANEL"),
                v4 = profile.getSubNode("BBAR"),
                v5 = profile.getSubNode("MAIN"),
                v6 = profile.getSubNode("MAINI"),
                h1, h4, t;
            if (height) {
                if (height == "auto") {
                    isize.height = height
                } else {
                    h1 = v1.height(), h4 = v4.height();
                    if ((t = size.height - h1 - h4) > 0) {
                        isize.height = t
                    }
                }
            }
            if (width) {
                isize.width = size.width - (parseInt(v6.css("paddingRight"), 10) || 0) - (parseInt(v5.css("paddingLeft"), 10) || 0)
            }
            v2.cssSize(isize, true)
        }
    }
});
Class("xui.UI.FusionChartFree", "xui.UI.Flash", {
    Instance: {
        refreshChart: function () {
            this.refreshFlash()
        },
        setDataXML: function (xml) {
            var prf = this.get(0),
                chart = prf.box._getSWF(prf);
            if (chart) {
                chart.SetVariable("_root.dataURL", "");
                chart.SetVariable("_root.isNewData", "1");
                chart.SetVariable("_root.newData", xml);
                chart.TGotoLabel("/", "JavaScriptHandler")
            }
        }
    },
    Static: {
        _FC_LINKTAG: "JavaScript:",
        _FC_SWFFILEPRETAG: "FCF_",
        DataModel: {
            selectable: true,
            FC_eventHandler: {
                ini: true,
                action: function () {
                    this.boxing().refreshChart()
                }
            },
            FC_chartType: {
                combobox: "Column2D,Column3D,Pie2D,Pie3D,Line,Bar2D,Area2D,Doughnut2D,MSColumn2D,MSColumn3D,MSLine,MSArea2D,MSBar2D,StackedColumn2D,StackedColumn3D,StackedArea2D,StackedBar2D,Candlestick,Funnel,Gantt".split(","),
                ini: "Column2D",
                action: function (v) {
                    var ns = this,
                        prop = ns.properties;
                    if (prop.FC_demoDataPath) {
                        xui.Ajax(prop.FC_demoDataPath + v + ".xml", {
                            rnd: _()
                        }, function (rsp) {
                            prop.FC_data = xui.XML.xml2json(rsp, null, function (s) {
                                return ns.box.replaceSpecialChars(x)
                            })
                        }, null, null, {
                            asy: false,
                            rspType: "xml"
                        }).start()
                    }
                    prop.src = prop.FC_swfPath + this.box._FC_SWFFILEPRETAG + prop.FC_chartType + ".swf";
                    this.boxing().refreshChart()
                }
            },
            FC_swfPath: "FusionChartsFree/Charts/",
            FC_demoDataPath: "FusionChartsFree/Data/",
            FC_attrs: {
                ini: {
                    bgcolor: "transparent",
                    quality: "high",
                    allowScriptAccess: "always",
                    debugMode: "false",
                    registerWithJS: "1",
                    scaleMode: "noScale"
                },
                action: function () {
                    this.boxing().refreshChart()
                }
            },
            FC_labels: {
                ini: {
                    PBarLoadingText: "Loading Chart. Please Wait",
                    XMLLoadingText: "Retrieving Data. Please Wait",
                    ParsingDataText: "Reading Data. Please Wait",
                    ChartNoDataText: "No data to display",
                    RenderingChartText: "Rendering Chart. Please Wait",
                    LoadDataErrorText: "Error in loading data",
                    InvalidXMLText: "Invalid XML data"
                },
                action: function () {
                    this.boxing().refreshChart()
                }
            },
            FC_data: {
                ini: {},
                action: function (v) {
                    var ns = this;
                    ns.box._buildChartXML(ns, function (xml) {
                        ns.boxing().setDataXML(ns.box._encodeDataXML(xui.XML.json2xml(xml)))
                    })
                }
            }
        },
        RenderTrigger: function () {
            this.boxing().setFC_chartType(this.properties.FC_chartType, true).refreshChart()
        },
        EventHandlers: {
            onFC_Click: function (profile, args) {},
            onFC_PrepareXML: function (profile, json, callback) {},
            onFC_SetXML: function (profile, xml) {}
        },
        replaceSpecialChars: function (str) {
            return ("" + str).replace(/\%/g, "%25").replace(/\&/g, "%26").replace(/\</g, "&lt;").replace(/\>/g, "&gt;").replace(/\'/g, "&apos;")
        },
        _encodeDataXML: function (strDataXML) {
            var regExpReservedCharacters = ["\\$", "\\+"];
            var arrDQAtt = strDataXML.match(/=\s*\".*?\"/g);
            if (arrDQAtt) {
                for (var i = 0; i < arrDQAtt.length; i++) {
                    var repStr = arrDQAtt[i].replace(/^=\s*\"|\"$/g, "");
                    repStr = repStr.replace(/\'/g, "%26apos;");
                    var strTo = strDataXML.indexOf(arrDQAtt[i]);
                    var repStrr = "='" + repStr + "'";
                    var strStart = strDataXML.substring(0, strTo);
                    var strEnd = strDataXML.substring(strTo + arrDQAtt[i].length);
                    var strDataXML = strStart + repStrr + strEnd
                }
            }
            strDataXML = strDataXML.replace(/\"/g, "%26quot;");
            strDataXML = strDataXML.replace(/%(?![\da-f]{2}|[\da-f]{4})/ig, "%25");
            strDataXML = strDataXML.replace(/\&/g, "%26");
            return strDataXML
        },
        _buildChartXML: function (profile, callback) {
            var ns = this,
                prop = profile.properties,
                ver = ns.getFlashVersion();
            if (ver.split(",")[0] < 8) {
                xui.alert(xui.getRes("inline.noFlash"));
                return ""
            }
            var data = _.clone(prop.FC_data);
            if (prop.FC_eventHandler) {
                var serialId = profile.serialId,
                    linktag = ns._FC_LINKTAG,
                    idata;
                if (profile.onFC_PrepareXML && false === profile.boxing().onFC_PrepareXML(profile, data, callback)) {} else {
                    if (idata = (data.chart || data.graph)) {
                        if (idata.set) {
                            _.arr.each(idata.set, function (o) {
                                if (o) {
                                    o["@link"] = encodeURIComponent(linktag + ns.KEY + '._e("' + serialId + '","' + (o["@label"] || o["@name"] || "") + '","' + (o["@value"] || "") + '")')
                                }
                            })
                        }
                        _.arr.each(["lineSet", "dataset", "dataSet"], function (dskey) {
                            if (idata[dskey]) {
                                var arr = [];
                                if (idata.categories && idata.categories.category) {
                                    _.arr.each(idata.categories.category, function (o) {
                                        arr.push(o["@label"] || o["@name"] || "")
                                    })
                                }
                                var ds = idata[dskey];
                                if (!_.isArr(ds)) {
                                    ds = [ds]
                                }
                                _.arr.each(ds, function (v, i) {
                                    if (v) {
                                        _.arr.each(["lineSet", "dataset", "dataSet"], function (dskey2) {
                                            _.arr.each(v[dskey2], function (k) {
                                                if (k && k.set) {
                                                    var sn = k["@seriesName"] || k["@seriesname"] || "";
                                                    _.arr.each(k.set, function (o, j) {
                                                        if (o) {
                                                            o["@link"] = encodeURIComponent(linktag + ns.KEY + '._e("' + serialId + '","' + (arr[j] || "") + '","' + sn + '","' + (o["@value"] || o["@label"] || o["@name"] || "") + '")')
                                                        }
                                                    })
                                                }
                                            })
                                        });
                                        if (v.set) {
                                            var sn = v["@seriesName"] || v["@seriesname"] || "";
                                            _.arr.each(v.set, function (o, j) {
                                                if (o) {
                                                    o["@link"] = encodeURIComponent(linktag + ns.KEY + '._e("' + serialId + '","' + (arr[j] || "") + '","' + sn + '","' + (o["@value"] || o["@label"] || o["@name"] || "") + '")')
                                                }
                                            })
                                        }
                                    }
                                })
                            }
                        });
                        callback(data)
                    } else {
                        callback("")
                    }
                }
            } else {
                callback(data)
            }
        },
        _drawSWF: function (profile) {
            var ns = this;
            ns._buildChartXML(profile, function (data) {
                var prop = profile.properties,
                    serialId = profile.serialId,
                    src = prop.src,
                    parameters = {},
                    options = {},
                    xml = "";
                if (prop.flashvars && !_.isEmpty(prop.flashvars)) {
                    _.merge(parameters, prop.flashvars, "all")
                }
                if (prop.parameters && !_.isEmpty(prop.parameters)) {
                    _.merge(parameters, prop.parameters, "all")
                }
                if (prop.FC_attrs && !_.isEmpty(prop.FC_attrs)) {
                    _.merge(options, prop.FC_attrs, "all")
                }
                if (prop.flashvars && !_.isEmpty(prop.flashvars)) {
                    _.merge(options, prop.flashvars, "all")
                }
                options.DOMId = profile.box._idtag + profile.serialId;
                options.chartWidth = prop.width;
                options.chartHeight = prop.height;
                options.dataXML = ns._encodeDataXML(xui.XML.json2xml(data));
                if (navigator.plugins && navigator.mimeTypes && navigator.mimeTypes.length) {
                    xml += '<embed type="application/x-shockwave-flash" src="' + src + "?" + _.urlEncode(parameters) + '" ';
                    xml += 'width="' + prop.width + '" height="' + prop.height + '" ';
                    xml += 'id="' + options.DOMId + '" name="' + options.DOMId + '" ';
                    xml += 'wmode="opaque" ';
                    xml += 'flashvars="' + _.urlEncode(options) + '" ';
                    xml += "/>"
                } else {
                    xml += '<object id="' + options.DOMId + '" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" ';
                    xml += 'width="' + prop.width + '" height="' + prop.height + '">';
                    xml += '<param name="movie" value="' + src + "?" + _.urlEncode(parameters) + '" />';
                    xml += '<param name="wmode" value="opaque" />';
                    xml += '<param name="flashvars" value="' + _.urlEncode(options) + '" />';
                    xml += "</object>"
                }
                profile.getSubNode("BOX").html(xml, false);
                if (profile.onFC_SetXML) {
                    profile.boxing().onFC_SetXML(profile, xml)
                }
            })
        },
        _idtag: "xui_UI_FCF_",
        __events: {},
        _e: function () {
            var instance = this.getFromDom(this.KEY + ":" + arguments[0] + ":"),
                prf = instance && instance.get(0);
            if (prf && !prf.properties.disable && prf.onFC_Click) {
                var args = _.toArr(arguments);
                args = args.slice(1);
                instance.onFC_Click(prf, args)
            }
        }
    }
});
Class("xui.UI.FusionChart3", "xui.UI.FusionChartFree", {
    Instance: {
        setDataXML: function (xml) {
            var chart = this.constructor._getSWF(this.get(0));
            if (chart) {
                return chart.setDataXML(xml)
            }
        },
        print: function () {
            var chart = this.constructor._getSWF(this.get(0));
            if (chart) {
                return chart.print()
            }
        },
        setDataURL: function (strDataURL) {
            var chart = this.constructor._getSWF(this.get(0));
            if (chart) {
                return chart.setDataURL(strDataURL)
            }
        },
        getDataAsCSV: function () {
            var chart = this.constructor._getSWF(this.get(0));
            if (chart) {
                return chart.getDataAsCSV()
            }
        },
        hasRendered: function () {
            var chart = this.constructor._getSWF(this.get(0));
            if (chart) {
                return chart.hasRendered()
            }
        },
        getChartAttribute: function (attrName) {
            var chart = this.constructor._getSWF(this.get(0));
            if (chart) {
                return chart.getChartAttribute(attrName)
            }
        },
        getXML: function () {
            var chart = this.constructor._getSWF(this.get(0));
            if (chart) {
                return chart.getXML()
            }
        },
        callFCFunction: function (funName, funArgs) {
            var chart = this.constructor._getSWF(this.get(0));
            if (chart) {
                return chart[funName].apply(chart, funArgs)
            }
        }
    },
    Initialize: function () {
        var ns = this,
            fireEvent = function (domId, eName) {
                if (domId && ns._getSWF(domId)) {
                    var instance = ns.getFromDom(ns.KEY + ":" + domId.replace(ns._idtag, "") + ":"),
                        prf = instance && instance.get(0);
                    if (prf && prf[eName]) {
                        instance[eName](prf)
                    }
                }
            },
            old;
        old = window.FC_Loaded;
        window.FC_Loaded = function (domId) {
            fireEvent(domId, "onFC_Loaded");
            if (old) {
                old(domId)
            }
        };
        old = window.FC_Rendered;
        window.FC_Rendered = function (domId) {
            fireEvent(domId, "onFC_Rendered");
            if (old) {
                old(domId)
            }
        };
        old = window.FC_DataLoaded;
        window.FC_DataLoaded = function (domId) {
            fireEvent(domId, "onFC_DataLoaded");
            if (old) {
                old(domId)
            }
        };
        old = window.FC_DataLoadError;
        window.FC_DataLoadError = function (domId) {
            fireEvent(domId, "onFC_DataLoadError");
            if (old) {
                old(domId)
            }
        };
        old = window.FC_NoDataToDisplay;
        window.FC_NoDataToDisplay = function (domId) {
            fireEvent(domId, "onFC_NoDataToDisplay");
            if (old) {
                old(domId)
            }
        };
        old = window.FC_DataXMLInvalid;
        window.FC_DataXMLInvalid = function (domId) {
            fireEvent(domId, "onFC_DataXMLInvalid");
            if (old) {
                old(domId)
            }
        }
    },
    Static: {
        _idtag: "xui_UI_FC3_",
        _FC_SWFFILEPRETAG: "",
        DataModel: {
            selectable: true,
            FC_chartType: {
                combobox: "Column2D,Column3D,Pie2D,Pie3D,Line,Bar2D,Area2D,Doughnut2D,Doughnut3D,MSColumn2D,MSColumn3D,MSLine,MSArea,MSBar2D,MSBar3D,StackedColumn2D,StackedColumn3D,StackedArea2D,StackedBar2D,StackedBar3D,MSStackedColumn2D,MSCombi2D,MSCombi3D,MSColumnLine3D,MSCombiDY2D,MSColumn3DLineDY,StackedColumn3DLineDY,MSStackedColumn2DLineDY,Scatter,Bubble,ScrollColumn2D,ScrollLine2D,ScrollArea2D,ScrollStackedColumn2D,ScrollCombi2D,ScrollCombiDY2D".split(",")
            },
            FC_swfPath: "FusionCharts3/Charts/",
            FC_demoDataPath: "FusionCharts3/Data/"
        },
        EventHandlers: {
            onFC_Loaded: function (profile) {},
            onFC_Rendered: function (profile) {},
            onFC_DataLoaded: function (profile) {},
            onFC_DataLoadError: function (profile) {},
            onFC_NoDataToDisplay: function (profile) {},
            onFC_DataXMLInvalid: function (profile) {}
        }
    }
});
Class("xui.UI.TextEditor", ["xui.UI.Widget", "xui.absValue"], {
    Instance: {
        activate: function () {
            var profile = this.get(0);
            profile.getSubNode("INPUT").focus();
            return this
        },
        _setCtrlValue: function (value) {
            if (_.isNull(value) || !_.isDefined(value)) {
                value = ""
            }
            return this.each(function (profile) {
                var node = profile.getSubNode("INPUT").get(0);
                if (node.value.replace(/(\r\n|\r)/g, "\n") != value.replace(/(\r\n|\r)/g, "\n")) {
                    var st = node.scrollTop;
                    node.value = value;
                    node.scrollTop = st
                }
            })
        },
        _getCtrlValue: function (value) {
            var profile = this.get(0);
            return profile.getSubNode("INPUT").attr("value").replace(/(\r\n|\r)/g, "\n").replace(/( +)(\n)/g, "$2").replace(/\t/g, "    ")
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        _.merge(t.FRAME.BORDER, {
            BOX: {
                tagName: "div",
                INPUT: {
                    tagName: "textarea",
                    tabindex: "{tabindex}",
                    style: "{_css}"
                }
            },
            BAK1: {},
            BAK2: {
                tagName: "div"
            }
        }, "all");
        this.setTemplate(t)
    },
    Static: {
        Appearances: {
            BOX: {
                width: "100%",
                height: "100%",
                left: 0,
                top: 0,
                position: "absolute",
                overflow: (xui.browser.gek && xui.browser.ver < 3) ? "auto" : "hidden",
                "z-index": "10"
            },
            INPUT: {
                "font-family": "Courier New, Courier, monospace",
                "font-size": "12px",
                "line-height": "14px",
                position: "absolute",
                "background-color": "#fff",
                left: 0,
                top: 0,
                border: 0,
                margin: 0,
                padding: 0,
                overflow: "auto",
                "overflow-y": "auto",
                "overflow-x": "hidden",
                resize: "none"
            },
            "BAK1, BAK2": {
                "font-family": "Courier New, Courier, monospace",
                "font-size": "12px",
                position: "absolute",
                visibility: "hidden",
                left: "-10000px",
                top: "-10000px"
            }
        },
        Behaviors: {
            INPUT: {
                onFocus: function (profile, e, src) {
                    profile.box._onchange(profile, xui.use(src).get(0))
                },
                onChange: function (profile, e, src) {
                    profile.boxing().setUIValue(xui.use(src).get(0).value);
                    profile.box._onchange(profile, xui.use(src).get(0))
                },
                afterKeydown: function (profile, e, src) {
                    var pro = profile.properties,
                        str, t;
                    if (pro.disabled || pro.readonly) {
                        return
                    }
                    if (profile.$change) {
                        delete profile.$change
                    }
                    var key = xui.Event.getKey(e),
                        node = xui.use(src).get(0),
                        k = key.key;
                    switch (k) {
                    case "tab":
                        var r = xui.use(src).caret(),
                            sel = node.value.slice(r[0], r[1]);
                        if (/(\n|\r)/.test(sel)) {
                            str = node.value.slice(0, r[0]);
                            if (sel.charAt(0) != "\n" && sel.charAt(0) != "\r") {
                                sel = str.slice(r[0] = str.lastIndexOf("\n")) + sel
                            }
                            if (xui.browser.ie) {
                                t = (t = str.match(/\r/g)) ? t.length : 0;
                                r[0] -= t;
                                t = (t = (node.value.slice(0, r[1])).match(/\r/g)) ? t.length : 0;
                                r[1] -= t
                            }
                            xui.use(src).caret(r[0], r[1]);
                            if (key.shiftKey) {
                                sel = sel.replace(/(\n|\n\r)    /g, "$1")
                            } else {
                                sel = sel.replace(/(\n|\n\r)/g, "$1    ")
                            }
                            profile.box.insertAtCaret(profile, sel);
                            r[1] = r[0] + sel.length;
                            if (xui.browser.ie) {
                                t = (t = sel.match(/\r/g)) ? t.length : 0;
                                r[1] -= t
                            }
                            xui.use(src).caret(r[0], r[1])
                        } else {
                            if (key.shiftKey) {
                                xui.use(src).caret(r[0] - 4, r[0] - 4);
                                r[0] -= 4;
                                r[1] -= 4
                            } else {
                                profile.box.insertAtCaret(profile, "    ");
                                r[0] += 4;
                                r[1] += 4
                            }
                        }
                        profile.$pos = r;
                        return false;
                    case "enter":
                        var paras = profile.box.getParas(profile);
                        str = paras[1];
                        var len = str.length - _.str.ltrim(str).length;
                        if (str.charAt(str.length - 1) == "{") {
                            len += 4
                        }
                        if (len) {
                            profile.box.insertAtCaret(profile, "\n" + _.str.repeat(" ", len));
                            profile.$enter = true;
                            return false
                        }
                        break;
                    default:
                        if (profile.tips) {
                            profile.tips.destroy();
                            profile.tips = null
                        }
                    }
                    node = null
                },
                afterKeypress: function (profile, e, src) {
                    if (profile.properties.disabled || profile.properties.readonly) {
                        return
                    }
                    var key = xui.Event.getKey(e),
                        k = key.key;
                    var me = arguments.callee,
                        map = me.map || (me.map = {
                            space: 1,
                            enter: 1,
                            backspace: 1,
                            tab: 1,
                            "delete": 1
                        });
                    if (k.length == 1 || map[k]) {
                        profile.$change = true
                    }
                    switch (k) {
                    case "tab":
                        if (xui.browser.opr) {
                            _.asyRun(function () {
                                xui.use(src).caret(profile.$pos[0], profile.$pos[1])
                            })
                        }
                        return false;
                    case "enter":
                        if (profile.$enter) {
                            delete profile.$enter;
                            return false
                        }
                    case "}":
                        if (key.shiftKey) {
                            var paras = profile.box.getParas(profile);
                            var loc = paras[0],
                                str = paras[1],
                                pos = paras[2],
                                input = paras[3];
                            if (/ {4}$/.test(str)) {
                                var st = xui(src).scrollTop();
                                input.value = input.value.substr(0, loc).replace(/ {4}$/, "}") + input.value.substr(loc, input.value.length);
                                xui(input).onChange();
                                profile.box.setCaretTo(input, loc - 4 + 1, st);
                                return false
                            }
                        }
                        break
                    }
                },
                afterKeyup: function (profile, e, src) {
                    var key = xui.Event.getKey(e),
                        k = key.key;
                    var me = arguments.callee,
                        map = me.map || (me.map = {
                            space: 1,
                            enter: 1,
                            backspace: 1,
                            tab: 1,
                            "delete": 1
                        });
                    if (k.length == 1 || map[k]) {
                        profile.$change = true
                    }
                    if (profile.$change) {
                        delete profile.$change;
                        profile.box._onchange(profile, xui.use(src).get(0))
                    }
                }
            }
        },
        DataModel: {
            selectable: true,
            left: 0,
            top: 0,
            width: 200,
            height: 200,
            position: "absolute",
            disabled: {
                ini: false,
                action: function (v) {
                    b.boxing().setReadonly(v)
                }
            },
            readonly: {
                ini: false,
                action: function (v) {
                    this.getSubNode("INPUT").attr("readonly", v).css("background", v ? "#EBEADB" : "")
                }
            }
        },
        EventHandlers: {
            onChange: function (profile, oV, nV) {}
        },
        RenderTrigger: function () {
            var ns = this;
            if (ns.properties.readonly) {
                ns.boxing().setReadonly(true, true)
            }
            var ie = xui.browser.ie,
                src = ns.getSubNode("INPUT").get(0),
                f = function (o) {
                    if (ie && o.propertyName != "value") {
                        return true
                    }
                    var src = ie ? o.srcElement : this;
                    ns.box._onchange(ns, src)
                };
            if (ie) {
                src.attachEvent("onpropertychange", f);
                src.attachEvent("ondrop", f);
                ns.$ondestory = function () {
                    src.detachEvent("onpropertychange", f);
                    src.detachEvent("ondrop", f)
                }
            } else {
                src.addEventListener("input", f, false);
                src.addEventListener("dragdrop", f, false);
                ns.$ondestory = function () {
                    var ns = this,
                        src = ns.getSubNode("INPUT").get(0);
                    if (src) {
                        src.removeEventListener("input", f, false);
                        src.addEventListener("dragdrop", f, false);
                        src = null
                    }
                };
                ns.getSubNode("BOX").$firfox2()
            }
        },
        _onchange: function (profile, src) {
            if (profile.onChange) {
                var v = src.id;
                _.resetRun(profile.$xid + "_drop", function () {
                    v = xui.Dom.byId(v).value || "";
                    profile.$prevV = profile.$prevV || "";
                    if (v != profile.$prevV) {
                        profile.boxing().onChange(profile, profile.$prevV, v);
                        profile.$prevV = v
                    }
                })
            }
        },
        _prepareData: function (profile) {
            var d = arguments.callee.upper.call(this, profile);
            if (xui.browser.kde) {
                d._css = "resize:none;"
            }
            return d
        },
        _onresize: function (profile, width, height) {
            var size = arguments.callee.upper.apply(this, arguments);
            profile.getSubNode("BOX").cssSize(size);
            profile.getSubNode("INPUT").cssSize(size)
        },
        insertAtCaret: function (profile, text) {
            var input = profile.getSubNode("INPUT"),
                scrollTop = input.scrollTop() || null,
                ret;
            input.onChange();
            ret = input.caret(text);
            this.setCaretTo(input.get(0), ret || 0, scrollTop)
        },
        setCaretTo: function (input, pos, scrollTop) {
            input.focus();
            var s, c, h, o = xui([input]);
            if (_.isNumb(scrollTop)) {
                o.scrollTop(scrollTop)
            }
            if (scrollTop === true) {
                if (o.get(0).tagName.toLowerCase() == "textarea" && o.scrollHeight() !== o.offsetHeight()) {
                    s = o.attr("value").substr(0, pos);
                    c = o.clone().id("").css({
                        visibility: "hidden",
                        position: "absolute",
                        left: 5000 + "px"
                    }).attr("value", s);
                    xui("body").append(c);
                    h = Math.max((c.scrollHeight() > c.offsetHeight()) ? c.scrollHeight() - 30 : 0, 0);
                    o.scrollTop(h);
                    c.remove()
                }
            }
            o.caret(pos, pos)
        },
        getParas: function (profile) {
            var o = profile.getSubNode("INPUT"),
                me = arguments.callee,
                reg = me.reg || (me.reg = /\r\n/g),
                v = o.get(0).value,
                loc = o.caret();
            if (loc[0] < 0) {
                loc[0] = 0
            }
            var l = 0,
                m = v.substr(0, loc[0]).match(reg);
            if (m) {
                l = m.length
            }
            v = v.replace(reg, "\n");
            var txt = v.substr(0, loc[0] - l);
            var li = txt.lastIndexOf("\n"),
                line = txt.substr(li + 1, loc[0] - li),
                w = o.innerWidth(),
                bak1 = profile.getSubNode("BAK1"),
                bak2 = profile.getSubNode("BAK2");
            if (txt.charAt(txt.length - 1) == "\n") {
                txt += "*"
            }
            bak2.width(w);
            var x = bak1.html(line.replace(/ /g, "&nbsp;"), false).width(),
                y = bak2.html(txt.replace(/\n/g, "<br />"), false).height() - o.scrollTop();
            if (x > w) {
                bak2.html(line, false);
                var lbak = line;
                var bl = bak2.height();
                while (lbak) {
                    lbak = lbak.replace(/ [^ ]*$/, "");
                    bak2.html(lbak, false);
                    if (bak2.height() != bl) {
                        break
                    }
                }
                lbak = line.substr(lbak.length, line.length - lbak.length);
                x = bak1.html(lbak, true).width()
            }
            bak1.html("", false);
            bak2.html("", false);
            var pos = profile.getRoot().offset();
            pos.left += x;
            pos.top += y;
            return [loc[0], line, pos, o.get(0), txt]
        }
    }
});
Class("xui.UI.Calendar", "xui.UI.DatePicker", {
    Instance: {
        setDayInfo: function (key, index, value) {
            var node = this.getSubNode(key, "" + index);
            if (node.get(0)) {
                node.get(0).innerHTML = value
            }
            return this
        },
        addContents: function (index, node) {
            this.getSubNode("DC", "" + index).append(node);
            return this
        },
        clearContents: function (index) {
            this.getSubNode("DC", "" + index).empty();
            return this
        }
    },
    Initialize: function () {
        var self = this,
            id = xui.UI.$ID,
            tag = xui.UI.$tag_special,
            cls = xui.UI.$CLS,
            key = self.KEY;
        self.addTemplateKeys(["H", "W", "COL", "DH", "DAYBOX", "DC", "TBODY", "THEADER", "TD", "DF1", "DF2", "DF3", "DF4"]);
        var colgroup = '<colgroup id="' + key + "-COL:" + id + ':"  class="' + tag + "COL_CS" + tag + '"  style="' + tag + "COL_CS" + tag + '"><col width="2%"/><col width="14%"/><col width="14%"/><col width="14%"/><col width="14%"/><col width="14%"/><col width="14%"/><col width="14%"/></colgroup>',
            thead1 = '<thead ID="' + key + "-THEADER:" + id + ':" class="' + tag + "THEADER_CS" + tag + '"  style="' + tag + "THEADER_CS" + tag + '" ><tr height="1%"><th id="' + key + "-H:" + id + ':7" class="xui-node xui-node-th ' + cls + "-h " + tag + "H_CC" + tag + '"  style="' + tag + "H_CS" + tag + '"></th>',
            thead2 = "</tr></thead>",
            th = '<th id="' + key + "-H:" + id + ':@" class="xui-node xui-node-th ' + cls + "-h " + tag + "H_CC" + tag + '"  style="' + tag + "H_CS" + tag + '">@</th>',
            tbody1 = '<tbody id="' + key + "-TBODY:" + id + ':"  class="' + tag + "TBODY_CS" + tag + '"  style="' + tag + "TBODY_CS" + tag + '">',
            tbody2 = "</tbody>",
            tr1 = "<tr>",
            tr2 = "</tr>",
            td1 = '<th id="' + key + "-W:" + id + ':@"  class="xui-node xui-node-th ' + cls + "-w " + tag + "W_CC" + tag + '" style="' + tag + "W_CS" + tag + '">@</th>',
            td2 = '<td id="' + key + "-TD:" + id + ':@" class="xui-node xui-node-td ' + cls + "-td " + tag + "TD_CC" + tag + '"  style="' + tag + "TD_CS" + tag + '" ' + xui.$IEUNSELECTABLE() + '  ><div id="' + key + "-DAYBOX:" + id + ':@" class="xui-node xui-node-div ' + cls + "-daybox " + tag + "DAY_CC" + tag + '"  style="' + tag + "DAY_CS" + tag + '" ' + xui.$IEUNSELECTABLE() + ' ><div id="' + key + "-DH:" + id + ':@" class="xui-node xui-node-div ' + cls + "-dh " + tag + "DH_CC" + tag + '"  style="' + tag + "DH_CS" + tag + '"></div><div id="' + key + "-DF1:" + id + ':@" class="xui-node xui-node-div ' + cls + "-df1 " + tag + "DF1_CC" + tag + '" style="' + tag + "DF1_CS" + tag + '"></div><div id="' + key + "-DF2:" + id + ':@" class="xui-node xui-node-div ' + cls + "-df2 " + tag + "DF2_CC" + tag + '" style="' + tag + "DF2_CS" + tag + '"></div><div id="' + key + "-DF3:" + id + ':@" class="xui-node xui-node-div ' + cls + "-df3 " + tag + "DF3_CC" + tag + '" style="' + tag + "DF3_CS" + tag + '"></div><div id="' + key + "-DF4:" + id + ':@" class="xui-node xui-node-div ' + cls + "-df4 " + tag + "DF4_CC" + tag + '"  style="' + tag + "DF4_CS" + tag + '"></div><div id="' + key + "-DC:" + id + ':@" class="xui-node xui-node-div ' + cls + "-dc " + tag + "DC_CC" + tag + '"  style="' + tag + "DC_CS" + tag + '"></div></div></td>',
            body, i, j, k, l, a = [],
            b = [];
        for (i = 0; i < 7; i++) {
            b[b.length] = th.replace(/@/g, i)
        }
        k = l = 0;
        for (i = 0; i < 48; i++) {
            j = i % 8;
            a[a.length] = (j == 0 ? tr1 : "") + (j == 0 ? td1 : td2).replace(/@/g, j == 0 ? l : k) + (j == 7 ? tr2 : "");
            if (j !== 0) {
                k++
            } else {
                l++
            }
        }
        body = colgroup + thead1 + b.join("") + thead2 + tbody1 + a.join("") + tbody2;
        self.setTemplate({
            tagName: "div",
            style: "{_style}",
            className: "{_className}",
            onselectstart: "return false",
            BORDER: {
                tagName: "div",
                BODY: {
                    $order: 1,
                    tagName: "table",
                    cellpadding: "0",
                    cellspacing: "0",
                    width: "100%",
                    text: body
                }
            }
        });
        delete self.$Keys.YEAR;
        delete self.$Keys.MONTH
    },
    Static: {
        Behaviors: {
            DroppableKeys: ["DAYBOX"],
            HoverEffected: {},
            ClickEffected: {},
            onSize: xui.UI.$onSize,
            TD: {
                onClick: null,
                onDblclick: function (profile, e, src) {
                    var p = profile.properties,
                        index = profile.getSubId(src);
                    if (p.disabled) {
                        return false
                    }
                    profile.boxing().onDblclick(profile, index, e, src)
                }
            }
        },
        DataModel: {
            handleHeight: null,
            tipsHeight: null,
            closeBtn: null,
            timeInput: null,
            dataBinder: null,
            dateField: null,
            dock: "fill",
            width: 200,
            height: 200
        },
        EventHandlers: {
            onDblclick: function (profile, item, e, src) {},
            beforeClose: null
        },
        _getLabelNodes: function (profile) {
            return profile.$day1 || (profile.$day1 = profile.getSubNode("DF1", true))
        },
        _getDayNodes: function (profile) {
            return profile.$day2 || (profile.$day2 = profile.getSubNode("DAYBOX", true))
        },
        Appearances: {
            "DAYBOX, DC": {
                position: "relative"
            },
            "DF1, DF2, DF3, DF4": {
                position: "absolute",
                "white-space": "nowrap"
            },
            DF1: {
                left: "2px",
                top: "2px"
            },
            DF2: {
                right: "2px",
                top: "2px"
            },
            DF3: {
                left: "2px",
                bottom: "2px"
            },
            DF4: {
                right: "2px",
                bottom: "2px"
            },
            DAYBOX: {
                overflow: "hidden"
            },
            DC: {
                "text-align": "left"
            },
            TD: {
                "background-color": "#F9F7D1"
            },
            "TD-checked": {
                $order: 1
            },
            "TD-free": {
                $order: 1,
                "background-color": "#FFF"
            }
        },
        _onresize: function (profile, width, height) {
            var p = profile.properties,
                f = function (k) {
                    return profile.getSubNode(k)
                },
                t;
            if (height) {
                f("BORDER").height(t = height);
                f("BODY").height(t);
                t = (t - 16) / 6 - 1;
                profile.box._getDayNodes(profile).height(t)
            }
        }
    }
});
(xui.Locale.en || (xui.Locale.en = {})).RAD = {
    message: "System message!",
    noMessage: "Develop Once, Deploy Everywhere!",
    soon: "Coming soon",
    ok: "OK",
    cancel: "Cancel",
    close: "Close",
    notsave: "Not save",
    notsave2: "You are about to close a file without saving it.<p>Click [Yes] to discard and continue or [No] to go back for saving.",
    notsave3: "You have NOT saved your modifications before debugging.<p>Click [Yes] to continue anyway or [No] to go back for saving.",
    checkOK: "Congratulations! No syntax error yet!",
    en: "English",
    cn: "Chinese",
    ja: "Japanese",
    tw: "Traditional Chinese",
    ru: "Russian",
    langTips: "Switch Locale",
    selFile: "Choose File",
    selFilePath: "Please select a file path",
    spabuilder: {
        nosavefirst: "You have unsaved changed. Are you sure you want to discard current changes?",
        menubar: {
            servicetester: "CrossUI Service Tester",
            backendcode: "Back-end Service Code",
            php: "PHP Code",
            csharp: "C# Code",
            java: "JAVA Code",
            links: "Links",
            xui: "www.crossui.com",
            gcodelist: "Google Code Download List",
            cookbook: "CookBook",
            api: "API Documentation",
            codesnipt: "Code Snippet",
            forum: "Go to Forum...",
            jsoneditor: "JSON Editor",
            adv: "Builder Advanced Version",
            commecial: "Commercial Support",
            video: "Introduction Video",
            about: "About"
        },
        st_title: "CrossUI Service Test",
        st_nodata: "Need to check your uri or query object!",
        st_uri: "Service URI",
        st_queryobj: "Request Query Object",
        st_createcode: "Create Request Code",
        st_send: "Send Testing Request To Service",
        st_sending: "Trying...",
        st_result: "Result",
        st_format: "Format",
        st_mothod: "Query Method"
    },
    builder: {
        open: "Open",
        openTips: "Save or download file.",
        save: "Deploy",
        saveTips: "Deploy Application.",
        run: "Debug",
        runTips: "Debug Application.",
        dftThemeTips: "To switch theme",
        advancedBuilder: "Advanced",
        originalFile: "Original file: ",
        issave2server: "Do you mean to overwrite the original server file?",
        save2serverOK: "Saved to server successfully",
        nosavefirst: "You have unsaved changed. Are you sure you want to discard current changes?",
        savetoserver: "Save to original file (in server)",
        saveasjs: "CrossUI class file(.js) ",
        saveashtml: "Html file",
        saveasweb: "Web deploy package",
        saveaswin: "Windows 32 platform deploy",
        saveaslinux: "Linux 32 platform deploy",
        saveaslinux64: "Linux 64 platform deploy",
        saveasosx: "OS X 32 platform deploy",
        saveasmobile: "Mobile platforms Deploy",
        themes: {
            "default": "Default Theme",
            aqua: "Aqua Theme",
            vista: "Vista Theme",
            moonify: "Moonify Theme"
        },
        noexist: "$0 doesn't exist!"
    },
    menu: {
        file: "Project",
        newproject: "New Project",
        openproject: "Open Project",
        closeproject: "Close Project",
        deleteproject: "Delete Project",
        save: "Save",
        saveall: "Save All",
        tools: "Tools",
        servicetester: "CrossUI Service Test",
        command: "Command Window",
        jsoneditor: "JSON Editor",
        cookbook: "CookBook",
        api: "API Documentation",
        codesnipt: "Code Snippet",
        backendcode: "Back-end Service Code",
        php: "PHP Code",
        csharp: "C# Code",
        java: "JAVA Code",
        spy: "Components Spy",
        build: "Build",
        debug: "Debug Application",
        release: "Deploy",
        setting: "Build Setting",
        help: "Help",
        simple: "Simple Version",
        video: "Introduction Video",
        movews: "Move Workspace",
        editcfg: "Package Configure",
        editorTheme: "Editor Theme Configure",
        forum: "Go to Forum...",
        license: "License",
        gpllicense: "LGPL License",
        clicense: "Commercial License",
        purchase: "Purchase License",
        about: "About..."
    },
    tool: {
        newp: "Create a New Project",
        open: "Open a Existing Project",
        save: "Save Files",
        saveall: "Save All Changed Files",
        command: "Open Command Window",
        spy: "Open Widget Spy Window",
        debug: "Debug Application",
        release: "Deploy",
        ec: "Translate Language",
        manual: "Visual Builder Manual...",
        api: "Components API Reference...",
        demo: "Samples",
        flash: "Flash Video Show"
    },
    tool2: {
        "new": "Add files",
        del: "Delete Files",
        new2: "Add file or directory",
        del2: "Delete file or directory",
        refresh: "Refresh Project Files",
        refreshOK: "Project Refreshed!"
    },
    pm: {
        title: "Project Manager",
        html: "HTML files",
        js: "Class files"
    },
    ps: {
        noselected: "Please Select a Project First",
        noprj: "No Project Open",
        getting: "Getting Project List...",
        saved: "$0 File(s) Saved",
        noSaved: "No Files Modified Since Last Saving"
    },
    projectPro: {
        type: "Template type:",
        template: "Template list:",
        name: "Project Name :",
        "class": "Class Name :",
        pagefile: "Main File :",
        classfile: "Class File :",
        onlyword: "Words(3-15) Allowed Only",
        invalid: "Some Fileds Invalid!"
    },
    dialog: {
        newone: "Create a New Project...",
        select: "Select a Project to Open"
    },
    JSEditor: {
        sv: "Code",
        dv: "Design View",
        svtips: "Code Editor",
        dvtips: "Visual IDE for Design UI Widgets",
        codeerr: "There are syntax errors in the code!",
        specifytype: "Specify type",
        clickapi: "API window"
    },
    pageEditor: {
        check: "Syntax Check",
        reset: "Reset Code",
        checktips: "Check Code",
        resettips: "Reset Code to Original Form",
        formatted: "Formatted Code",
        outline: "Class Outline",
        search: "Search",
        replace: "Replace",
        searchreplace: "Find and Replace",
        replacesearch: "Replace / Find",
        replacewith: "Replace",
        replaceall: "Replace All",
        findnone: "No Result",
        replaceCount: "$0 matched replaced",
        jumpto: "Jump to line",
        indentall: "Re-indent",
        outlinetips: "Class Outline",
        searchtips: "Search",
        replacetips: "Replace",
        jumptotips: "Jump to line",
        indentalltips: "Re-indent",
        modeDlgCap: "Select a rendering mode please"
    },
    classtool: {
        err1: "Invalid Code Format, Please Go Back to Have a Check!",
        err2: "Invalid Code Format, Please Go Back to Have a Check!",
        err3: "Invalid Code Format, Please Go Back to Have a Check!",
        err4: "Invalid Code Format, Please Go Back to Have a Check!",
        noClass: "Not a single CrossUI Class File!"
    },
    designer: {
        toolsbox: "Tools Box",
        configwnd: "Component config",
        emptyContent: "Empty Content First...",
        prepare: "Prepare Classes...",
        createContent: "Refresh design content...",
        loading: "Loading ",
        comCodeErr: 'An Error Occurs in Function "iniComponents", Please Go Back to Check the Code',
        nameExists: 'A Widget Named "$0" Exists Already!',
        domIdExists: 'A DOM node wich id "$0" exists already!',
        domIdValid: "DOM id must be char and number only",
        confirmdel: "Delete?",
        confirmdel2: "Are You Sure to Delete the $0 Selected  Component(s)?",
        confirmrefresh1: "Refresh Design View from Code",
        confirmrefresh2: "UI has been changed, 'refresh' will result in loss of these changes, whether to refresh?",
        refreshOK: "Refreshed!",
        wlist: "Widgets List",
        weditor: "Widget Editor",
        gridcol1: "property",
        gridcol2: "value",
        clipboard: "Clipboard",
        pasted: "$0 widgets pasted into the current container!",
        clearClipboard: "Clipboard has been emptied!",
        copyOK: "$0 widgets copied to clipboard",
        cutOK: "$0 widgets cutted to clipboard",
        colneOK: "$0 widgets cloned into current container",
        openwidgets: "Expand/Fold the widgtes list",
        dragwidget: "You can drag this widget to the design window!",
        openapi: "DblClick to open API window",
        tool: {
            viewsize: "View Size",
            refresh: "Refresh the Design View",
            tocode: "Serialize selection to JS code",
            tojson: "Serialize selection to JSON code",
            left: "Align to left",
            center: "Align to center",
            right: "Align to right",
            top: "Align to top",
            middle: "Align to middle",
            bottom: "Align to botttom",
            width: "Same width",
            wh: "Same width and height",
            height: "Same height",
            toplayer: "To top layer",
            bottomlayer: "To bottom layer",
            gridxy: "Set position to grid",
            gridwh: "Set size to grid",
            copy: "Copy selected controls",
            cut: "Cut selected controls",
            paste: "Paste copied to the current container",
            clone: "Clone selected controls",
            "delete": "Delete",
            aligngroup: "Align",
            posgroup: "Grid&Layer"
        }
    },
    addfile: {
        caption: "Add file to Project...",
        sel: "Select the target Folder",
        filename: "File Name",
        filenameformat: "2 - 9 characters only",
        add: "Add",
        iDir: "Folder",
        iHtml: "New HTML file",
        iCSS: "New CSS file",
        iJs: "New JS file",
        iPhp: "New PHP file",
        iUpload: "Upload a file",
        target: "Target",
        filetype: "File Type",
        notarget: "File or Directory to be built does NOT exist",
        invalidExts: "The file type is not allowed",
        invalidName: "Only numbers and letters allowed"
    },
    delfile: {
        caption: "Delete Files From Project...",
        sel: "Select target files or folders",
        notarget: "Target files or folders does NOT exist",
        confirmdel: "Delete?",
        confirmdel2: "Are You Sure to Delete the $0 Selected  Files or Folders?",
        confirmdel3: "Are You Sure to Delete the current project?"
    },
    editorTheme: {
        name: "Editor Theme Configure",
        selTheme: "Select a theme for editor",
        selFontSize: "Specify font size"
    }
};
Class("xui.UI.AdvResizer", "xui.UI.Resizer", {
    Instance: {
        cssRegion: function () {
            var profile = this.get(0),
                target = profile._target,
                l, t, b, r, ll, tt, ww, hh, c = [];
            if (target) {
                var purge = xui.$cache.domPurgeData;
                target._nodes.sort(function (x, y) {
                    x = parseInt(purge[x].element.style.zIndex) || 0;
                    y = parseInt(purge[y].element.style.zIndex) || 0;
                    return x > y ? 1 : x == y ? 0 : -1
                });
                target.each(function (o, i) {
                    var o = xui([o]);
                    if (i === 0) {
                        l = o.offsetLeft();
                        t = o.offsetTop();
                        r = l + (ww = o.offsetWidth());
                        b = t + (hh = o.offsetHeight());
                        c.push([{
                            left: l,
                            top: t
                        }, {
                            width: ww,
                            height: hh
                        },
                        o.id()])
                    } else {
                        l = Math.min(l, ll = o.offsetLeft());
                        t = Math.min(t, tt = o.offsetTop());
                        r = Math.max(r, ll + (ww = o.offsetWidth()));
                        b = Math.max(b, tt + (hh = o.offsetHeight()));
                        c.push([{
                            left: ll,
                            top: tt
                        }, {
                            width: ww,
                            height: hh
                        },
                        o.id()])
                    }
                })
            }
            profile.regionBlocks = c;
            _.arr.each(c, function (o) {
                o[0].left -= l;
                o[0].top -= t;
                o[1].width -= 2;
                o[1].height -= 2
            });
            return {
                l: l,
                t: t,
                b: b,
                r: r
            }
        },
        rePosSize: function () {
            var self = this;
            self.each(function (o) {
                var t, t1 = o.getRoot(),
                    t2 = o._target;
                if (!t2 || t2.isEmpty()) {
                    return
                }
                if (!o.properties._attached) {
                    t = o.region = o.boxing().cssRegion();
                    t1.cssPos({
                        left: t.l,
                        top: t.t
                    }).offsetWidth(t.r - t.l).offsetHeight(t.b - t.t)
                }
                if (!o.regPool) {
                    o.regPool = xui()
                }
                if (t = o.regions) {
                    o.regPool.merge(t);
                    t.css("display", "none")
                }
                o.regions = xui();
                if (o.regionBlocks) {
                    var t, fun = function (p, e, src) {
                            var b = o.boxing(),
                                t = b.getTarget(),
                                key = xui.Event.$keyboard;
                            if (o.onRegionClick && false !== b.onRegionClick(o, e)) {
                                if (t._nodes.length > 1) {
                                    var tid = xui.getNodeData(src, "_tid");
                                    if (key && key.shiftKey) {
                                        _.arr.removeValue(t._nodes, tid);
                                        b.resetTarget(t)
                                    } else {
                                        b.focus(tid)
                                    }
                                }
                            }
                        };
                    _.arr.each(o.regionBlocks, function (v) {
                        if (!o.regPool.isEmpty()) {
                            t = o.regPool._nodes.pop();
                            xui(t).cssPos(v[0]).cssSize(v[1])
                        } else {
                            t = _.str.toDom('<div style="position:absolute;cursor:default;border:dashed 1px blue;left:{l}px;top:{t}px;width:{w}px;height:{h}px;"></div>'.replace("{l}", v[0].left).replace("{t}", v[0].top).replace("{w}", v[1].width).replace("{h}", v[1].height));
                            t.onClick(fun);
                            t = t.get(0).$xid
                        }
                        o.regions._nodes.push(t);
                        xui.setNodeData(t, "_tid", v[2])
                    });
                    o.getRoot().append(o.regions.css("display", "block"))
                }
            });
            self.focus();
            return self
        },
        getTarget: function () {
            return this.get(0)._target
        },
        resetTarget: function (target, flag) {
            var self = this,
                profile = self.get(0),
                rb = self.reBoxing(),
                ids;
            if (profile.properties._attached) {
                return
            }
            delete profile.$focus;
            if (target && !target.isEmpty()) {
                profile._target = target;
                self.rePosSize();
                rb.css({
                    zIndex: xui.Dom.TOP_ZINDEX,
                    display: "block"
                })
            } else {
                profile._target = xui();
                rb.css({
                    zIndex: 0,
                    display: "none"
                })
            }
            if (target && !target.isEmpty()) {
                ids = [];
                target.reBoxing("UI").each(function (o, i) {
                    ids.push(o.$xid)
                })
            } else {
                ids = null
            }
            if (flag !== false) {
                profile.boxing().onItemsSelected(profile, ids, profile.$xid)
            }
            return self
        },
        focus: function (id) {
            var profile = this.get(0),
                index = -1;
            if (!profile.regions) {
                return
            }
            profile.regions.css("border", "dashed 1px blue");
            var arr = profile._target.get();
            if (id) {
                index = _.arr.subIndexOf(arr, "id", id)
            }
            if (index == -1 && profile.$focus !== undefined) {
                index = profile.$focus
            }
            if (index == -1 && arr.length > 1) {
                index = arr.length - 1
            }
            if (index != -1) {
                profile.regions.css("border", "dashed 1px blue");
                xui([profile.regions.get(index)]).css("border", "solid 1px red");
                profile.$focus = index;
                if (profile.onFocusChange) {
                    profile.boxing().onFocusChange(profile, index)
                }
            }
            return this
        },
        getFocus: function () {
            return this.get(0).$focus
        },
        active: function (flag) {
            return this.each(function (profile) {
                profile.getSubNode("MOVE").css("backgroundPosition", "-17px -244px");
                profile.getSubNodes(["LT", "T", "RT", "R", "RB", "B", "LB", "L"]).css("background", xui.browser.ie ? "url(" + xui.ini.path + "bg.gif)" : "#fff");
                if (flag !== false) {
                    profile.boxing().onActive(profile)
                }
            })
        },
        inActive: function () {
            return this.each(function (profile) {
                if (profile.$onDrag) {
                    return
                }
                profile.getSubNode("MOVE").css("backgroundPosition", "-34px -244px");
                profile.getSubNodes(["LT", "T", "RT", "R", "RB", "B", "LB", "L"]).css("background", "#808080")
            })
        }
    },
    Static: {
        DataModel: {
            dragArgs: null
        },
        EventHandlers: {
            onActive: function (profile) {},
            onFocusChange: function (profile, index) {},
            onItemsSelected: function (profile, ids) {},
            onRegionClick: function (profile, e) {},
            onDblclick: function (profile, e, src) {}
        },
        _onMousedown: function (profile, e, src, ddparas) {
            if (xui.Event.getBtn(e) != "left") {
                return
            }
            var ck = xui.Event.$keyboard;
            if (ck && (ck.ctrlKey || (xui.browser.kde && ck.key == " "))) {
                profile.boxing().resetTarget(null);
                var pos = xui.Event.getPos(e);
                var hash = {
                    dragDefer: 1,
                    dragType: "icon",
                    targetLeft: pos.left + 12,
                    targetTop: pos.top + 12,
                    dragCursor: "pointer"
                };
                _.merge(hash, profile.properties.dragArgs, "all");
                hash.widthIncrement = hash.heightIncrement = 0;
                hash.dragData.pos = profile.getRoot().cssPos();
                xui().startDrag(e, hash)
            } else {
                var hash, o, absPos, pos, posbak, size;
                if (profile.properties._attached) {
                    pos = xui.Event.getPos(e);
                    xui.use(src).startDrag(e, {
                        dragDefer: 1,
                        targetReposition: false,
                        dragType: "blank",
                        dragCursor: true,
                        targetLeft: pos.left,
                        targetTop: pos.top
                    })
                } else {
                    o = profile.getRoot();
                    absPos = o.offset();
                    pos = o.cssPos();
                    posbak = _.copy(pos);
                    if (ddparas.move) {
                        absPos = xui.Event.getPos(e)
                    } else {
                        size = o.cssSize();
                        if (ddparas.left) {
                            if (ddparas.top) {} else {
                                if (ddparas.bottom) {
                                    pos.top = pos.top + size.height
                                } else {
                                    pos.top = pos.top + size.height / 2
                                }
                            }
                        }
                        if (ddparas.right) {
                            pos.left = pos.left + size.width;
                            if (ddparas.top) {} else {
                                if (ddparas.bottom) {
                                    pos.top = pos.top + size.height
                                } else {
                                    pos.top = pos.top + size.height / 2
                                }
                            }
                        }
                        if (ddparas.top && !ddparas.left && !ddparas.right) {
                            pos.left = pos.left + size.width / 2
                        }
                        if (ddparas.bottom && !ddparas.left && !ddparas.right) {
                            pos.left = pos.left + size.width / 2;
                            pos.top = pos.top + size.height
                        }
                    }
                    if ((t = profile.properties.dragArgs) && (t = t.widthIncrement)) {
                        var offx = xui.DragDrop.$proxySize % t;
                        if (ddparas.left) {
                            pos.left += offx
                        } else {
                            if (ddparas.right) {
                                pos.left += offx
                            } else {
                                if (ddparas.move) {
                                    pos.left += offx
                                }
                            }
                        }
                        pos.left += parseInt((absPos.left - posbak.left) / t) * t
                    }
                    if ((t = profile.properties.dragArgs) && (t = t.heightIncrement)) {
                        var offy = xui.DragDrop.$proxySize % t;
                        if (ddparas.top) {
                            pos.top += offy
                        } else {
                            if (ddparas.bottom) {
                                pos.top += offy
                            } else {
                                if (ddparas.move) {
                                    pos.top += offy
                                }
                            }
                        }
                        pos.top += parseInt((absPos.top - posbak.top) / t) * t
                    }
                    var hash = {
                        dragDefer: 1,
                        targetReposition: false,
                        dragType: "blank",
                        dragCursor: true,
                        targetLeft: pos.left,
                        targetTop: pos.top
                    };
                    _.merge(hash, profile.properties.dragArgs, "all");
                    hash.targetOffsetParent = profile._parent;
                    hash.dragKey = null;
                    xui.use(src).startDrag(e, hash)
                }
            }
            profile.boxing().active()
        },
        LayoutTrigger: function () {
            this.boxing().rePosSize()
        }
    }
});
Class("RAD", "xui.Com", {
    Constructor: function () {
        var self = this,
            o = xui.message;
        arguments.callee.upper.apply(self, arguments);
        SPA = this;
        self.curProject = null;
        self.curProjectName = null;
        self.Message = [];
        xui.message = function (content) {
            if (!self.Message) {
                return
            }
            if (self.Message.length > 20) {
                self.Message.pop()
            }
            if (typeof content != "string") {
                content = String(content)
            }
            if (/</.test(content)) {
                while (content != (content = content.replace(/<[^<>]*>/g, ""))) {}
            }
            self.Message.unshift({
                id: _.id(),
                caption: content.length > 50 ? content.substr(0, 50) + "..." : content,
                tips: content,
                image: CONF.img_app,
                imagePos: "-64px -64px"
            });
            self.toolbar.updateItem("info", {
                label: content.length > 50 ? content.substr(0, 50) + "..." : content
            });
            o.apply(null, arguments)
        };
        xui("body").css({
            height: "100%",
            overflow: "hidden"
        })
    },
    Instance: {
        events: {
            beforeCreated: function () {
                xui.Dom.setCover('<img src="' + xui.getPath("img/", "loading.gif") + '" border="0"/><div>Created</div>')
            },
            onLoadBaseClass: function (com, threadid, key) {
                xui.Dom.setCover('<img src="' + xui.getPath("img/", "loading.gif") + '" border="0"/><div>Load Base Class: ' + key + "</div>")
            },
            onReady: function (page) {
                xui.ComFactory.setProfile(CONF.ComFactoryProfile);
                var items, items2, items0 = [{
                    id: "newproject",
                    caption: "$RAD.menu.newproject",
                    image: CONF.img_app,
                    imagePos: "-32px top"
                }, {
                    id: "openproject",
                    caption: "$RAD.menu.openproject",
                    add: "",
                    image: CONF.img_app,
                    imagePos: "-48px top"
                }, {
                    id: "closeproject",
                    caption: "$RAD.menu.closeproject"
                }, {
                    type: "split"
                }, {
                    id: "deleteproject",
                    caption: "$RAD.menu.deleteproject",
                    image: CONF.img_app,
                    imagePos: "-16px -16px"
                }, {
                    type: "split"
                }, {
                    id: "save",
                    caption: "$RAD.menu.save",
                    add: "",
                    image: CONF.img_app,
                    imagePos: "-80px top"
                }, {
                    id: "saveall",
                    caption: "$RAD.menu.saveall",
                    add: "",
                    image: CONF.img_app,
                    imagePos: "-96px top"
                }],
                    items3 = [{
                        id: "editorTheme",
                        caption: "$RAD.menu.editorTheme"
                    }, {
                        type: "split"
                    }, {
                        id: "servicetester",
                        caption: "$RAD.menu.servicetester"
                    }, {
                        id: "command",
                        caption: "$RAD.menu.command"
                    }, {
                        id: "jsoneditor",
                        caption: "$RAD.menu.jsoneditor"
                    }, {
                        type: "split"
                    }, {
                        id: "cookbook",
                        caption: "$RAD.menu.cookbook"
                    }, {
                        id: "api",
                        caption: "$RAD.menu.api"
                    }, {
                        id: "codesnipt",
                        caption: "$RAD.menu.codesnipt"
                    }, {
                        type: "split"
                    }, {
                        id: "backendcode",
                        caption: "$RAD.menu.backendcode",
                        sub: [{
                            id: "php",
                            caption: "$RAD.menu.php"
                        }, {
                            id: "csharp",
                            caption: "$RAD.menu.csharp"
                        }, {
                            id: "java",
                            caption: "$RAD.menu.java"
                        }]
                    }];
                switch (CONF.serviceType) {
                case "remote":
                    items = [{
                        id: "saveasweb",
                        caption: "$RAD.builder.saveasweb"
                    }];
                    items2 = [{
                        id: "simple",
                        caption: "$RAD.menu.simple"
                    }, {
                        type: "split"
                    }, {
                        id: "video",
                        caption: "$RAD.menu.video"
                    }, {
                        id: "forum",
                        caption: "$RAD.menu.forum"
                    }, {
                        type: "split"
                    }, {
                        id: "about",
                        caption: "$RAD.menu.about"
                    }];
                    break;
                case "node-webkit":
                    items = [{
                        id: "saveasweb",
                        caption: "$RAD.builder.saveasweb"
                    }, {
                        id: "split1",
                        type: "split"
                    }, {
                        id: "saveaswin",
                        caption: "$RAD.builder.saveaswin"
                    }, {
                        id: "saveaslinux",
                        caption: "$RAD.builder.saveaslinux"
                    }, {
                        id: "saveaslinux64",
                        caption: "$RAD.builder.saveaslinux64"
                    }, {
                        id: "saveasosx",
                        caption: "$RAD.builder.saveasosx"
                    }, {
                        id: "split2",
                        type: "split"
                    }, {
                        id: "saveasmobile",
                        caption: "$RAD.builder.saveasmobile"
                    }];
                    items2 = [{
                        id: "video",
                        caption: "$RAD.menu.video"
                    }, {
                        id: "forum",
                        caption: "$RAD.menu.forum"
                    }, {
                        type: "split"
                    }, {
                        id: "Register",
                        caption: "Register"
                    }, {
                        id: "about",
                        caption: "$RAD.menu.about"
                    }];
                    items0.unshift({
                        id: "split",
                        type: "split"
                    });
                    items0.unshift({
                        id: "movews",
                        caption: "$RAD.menu.movews"
                    });
                    items0.unshift({
                        id: "editcfg",
                        caption: "$RAD.menu.editcfg"
                    });
                    xui.SAjax("http://www.crossui.com/services/message.js", {
                        rand: _() + ""
                    }).start();
                    xui.SAjax("http://www.crossui.com/services/latestversion.js", {
                        rand: _() + ""
                    }, function () {
                        var a = CROSSUI_LATEST_VERSION;
                        if (a.version > CONF.version) {
                            xui.alert(a.message)
                        }
                    }, null, 0, {
                        rspType: "script",
                        checkKey: "CROSSUI_LATEST_VERSION"
                    }).start();
                    break
                }
                this._pfitems = items;
                this.menubar.setItems([{
                    id: "file",
                    caption: "$RAD.menu.file",
                    sub: items0
                }, {
                    id: "build",
                    caption: "$RAD.menu.build",
                    sub: [{
                        id: "debug",
                        caption: "$RAD.menu.debug",
                        image: CONF.img_app,
                        imagePos: "-239px -64px",
                        add: ""
                    }, {
                        id: "release",
                        caption: "$RAD.menu.release",
                        image: CONF.img_app,
                        imagePos: "-144px top",
                        add: "",
                        sub: items
                    }]
                }, {
                    id: "tools",
                    caption: "$RAD.menu.tools",
                    sub: items3
                }, {
                    id: "help",
                    caption: "$RAD.menu.help",
                    sub: items2
                }]);
                this.toolbar.setItems([{
                    id: "only",
                    sub: [{
                        id: "newproject",
                        image: CONF.img_app,
                        imagePos: "-32px top",
                        tips: "$RAD.tool.newp"
                    }, {
                        id: "openproject",
                        image: CONF.img_app,
                        imagePos: "-48px top",
                        tips: "$RAD.tool.open"
                    }, {
                        split: true
                    }, {
                        id: "save",
                        image: CONF.img_app,
                        imagePos: "-80px top",
                        tips: "$RAD.tool.save"
                    }, {
                        id: "saveall",
                        image: CONF.img_app,
                        imagePos: "-96px top",
                        tips: "$RAD.tool.saveall"
                    }, {
                        split: true
                    }, {
                        id: "debug",
                        image: CONF.img_app,
                        imagePos: "-239px -64px",
                        tips: "$RAD.tool.debug"
                    }, {
                        id: "release",
                        dropButton: true,
                        image: CONF.img_app,
                        imagePos: "-144px top",
                        tips: "$RAD.tool.release",
                        sub: items
                    }, {
                        split: true
                    }, {
                        id: "ec",
                        dropButton: true,
                        image: CONF.img_app,
                        imagePos: "-96px -16px",
                        tips: "$RAD.tool.ec"
                    }, {
                        split: true
                    }, {
                        id: "theme",
                        dropButton: true,
                        image: CONF.img_app,
                        imagePos: "-208px -48px",
                        tips: "$RAD.builder.dftThemeTips"
                    }, {
                        split: true
                    }, {
                        id: "command",
                        image: CONF.img_app,
                        imagePos: "-128px -48px",
                        tips: "$RAD.menu.command"
                    }, {
                        split: true
                    }, {
                        id: "servicetester",
                        image: CONF.img_app,
                        imagePos: "-64px top",
                        tips: "$RAD.menu.servicetester"
                    }, {
                        split: true
                    }, {
                        id: "jsoneditor",
                        image: CONF.img_app,
                        imagePos: "-128px -64px",
                        tips: "$RAD.menu.jsoneditor"
                    }, {
                        split: true
                    }, {
                        id: "info",
                        caption: "...",
                        label: "$RAD.noMessage",
                        tips: "$RAD.message"
                    }]
                }]);
                this.floatLogo.setCustomStyle({
                    KEY: "position:absolute;top:0px;right:0px;z-index:100;cursor:pointer;"
                });
                this.floatLogo.setSrc(xui.getPath("img/", "logo2.png"));
                CONF.getRegisterInfo(this.statusBar)
            },
            onRender: function (page) {
                var ns = this,
                    key = "prj",
                    prj;
                var prevStatus, files, file;
                if (CONF.serviceType == "node-webkit") {
                    prevStatus = NW._status;
                    prj = prevStatus.project;
                    files = prevStatus.files;
                    file = prevStatus.file
                } else {
                    var r = "([&|?|#]|\\b)(" + key + "=)([^&]*)([&]?)",
                        a = location.href.match(new RegExp(r)),
                        prj = _.isNull(a) ? "" : decodeURIComponent(a[3])
                }
                if (prj) {
                    prj = CONF.prjPath + "/" + prj;
                    CONF.callService({
                        key: CONF.requestKey,
                        paras: {
                            action: "open",
                            hashCode: _.id(),
                            path: prj
                        }
                    }, function (txt) {
                        var obj = txt;
                        if (obj && !obj.error) {
                            try {
                                page._openproject(prj, obj.data, !! files);
                                if (files && files.length) {
                                    _.arr.each(files, function (o) {
                                        var item = {
                                            id: o,
                                            value: o,
                                            caption: o.substr(o.lastIndexOf("/") + 1, o.length)
                                        };
                                        ns._openfile(item, null, o != file, dontshowerror)
                                    })
                                }
                            } catch (e) {}
                        } else {
                            xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
                        }
                    })
                }
                page.$infoList = new xui.UI.List({
                    width: 400
                }).setCustomStyle("ITEM", "border-bottom:dashed 1px gray").render()
            }
        },
        _addfile: function (id, path, name, type, file) {
            var tb = this.treebarPrj,
                pathadd;
            if (type == "upload") {
                name = file.value
            } else {
                if (type != "/") {
                    name = name + type;
                    pathadd = path + "/" + name
                } else {
                    pathadd = path = path + "/" + name
                }
            }
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: type == "upload" ? "upload" : "add",
                    hashCode: _.id(),
                    lang: xui.getLang(),
                    type: type == "/" ? "dir" : "file",
                    path: path,
                    filename: name
                },
                file: file
            }, function (txt) {
                var obj = txt;
                if (obj && !obj.error && obj.data && obj.data.OK) {
                    if (!tb.getItemByItemId(id)) {
                        return
                    }
                    var imagePos;
                    if (type == "/") {
                        imagePos = "-48px top"
                    } else {
                        if (type == "upload") {
                            name = obj.data.name;
                            pathadd = path + "/" + name
                        }
                        var a = name.split(".");
                        switch (a[1].toLowerCase()) {
                        case "html":
                        case "txt":
                            imagePos = "-112px -48px";
                            break;
                        case "css":
                            imagePos = "-208px -48px";
                            break;
                        case "js":
                            imagePos = "-16px -48px";
                            break;
                        case "jpg":
                        case "png":
                        case "gif":
                            imagePos = "-192px 0px";
                            break;
                        default:
                            imagePos = "-96px -48px"
                        }
                    }
                    tb.insertItems([{
                        id: pathadd,
                        caption: name,
                        image: CONF.img_app,
                        imagePos: imagePos,
                        value: pathadd,
                        sub: type == "/" ? [] : null
                    }], id)
                } else {
                    xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
                }
            }, function (obj) {
                xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
            })
        },
        _delfile: function (id) {
            var self = this,
                tree = this.treebarPrj,
                tab = this.tabsMain,
                arr = id.split(";"),
                a = [];
            _.arr.each(arr, function (o, i) {
                a[i] = o
            });
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "del",
                    hashCode: _.id(),
                    path: a
                }
            }, function (txt) {
                var obj = txt;
                if (obj && !obj.error && obj.data && obj.data.OK) {
                    tree.removeItems(arr);
                    var items = tab.getItems(),
                        b = [];
                    _.arr.each(items, function (o) {
                        if (!tree.getSubIdByItemId(o.id)) {
                            b.push(o.id)
                        }
                    }, null, true);
                    tab.removeItems(b);
                    if (id == self.curProject) {
                        tab.clearItems();
                        tree.clearItems();
                        self.curProject = null
                    }
                } else {
                    xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
                }
            })
        },
        _projecttool_onclick: function (profile, item, group, e, src) {
            if (!this.curProject) {
                xui.message(xui.getRes("RAD.ps.noprj"));
                return
            }
            var self = this;
            switch (item.id) {
            case "new":
                xui.ComFactory.getCom("addFile", function () {
                    this.host = self;
                    this.reset();
                    this.setProperties({
                        onOK: self._addfile,
                        parent: self,
                        item: null,
                        fromRegion: xui(src).cssRegion(true)
                    });
                    this.show(xui("body"))
                });
                break;
            case "delete":
                xui.ComFactory.getCom("delFile", function () {
                    this.host = self;
                    this.setProperties({
                        fromRegion: xui(src).cssRegion(true),
                        parent: self,
                        onOK: self._delfile
                    });
                    this.show(xui("body"))
                });
                break;
            case "refresh":
                CONF.callService({
                    key: CONF.requestKey,
                    paras: {
                        action: "open",
                        hashCode: _.id(),
                        path: self.curProject
                    }
                }, function (txt) {
                    var obj = txt;
                    if (!obj || obj.error) {
                        xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
                    } else {
                        _.tryF(self._openproject, [self.curProject, obj.data], self);
                        xui.message(xui.getRes("RAD.tool2.refreshOK"))
                    }
                });
                break
            }
        },
        _dirtyWarn: function (callback) {
            var self = this,
                dirty, tb = this.tabsMain,
                items = tb.getItems(),
                tree = this.treebarPrj;
            _.arr.each(items, function (o) {
                if (o._dirty) {
                    return !(dirty = true)
                }
            });
            if (dirty) {
                xui.UI.Dialog.confirm(xui.getRes("RAD.notsave"), xui.getRes("RAD.notsave3"), callback)
            } else {
                callback()
            }
        },
        _closeproject: function (callback) {
            var self = this,
                dirty, tb = this.tabsMain,
                items = tb.getItems(),
                tree = this.treebarPrj;
            _.arr.each(items, function (o) {
                if (o && o._dirty) {
                    return !(dirty = true)
                }
            });
            var fun = function () {
                    tb.clearItems();
                    tree.clearItems();
                    self.curProjectName = self.curProject = null;
                    if (typeof callback == "function") {
                        callback()
                    }
                };
            if (dirty) {
                xui.UI.Dialog.confirm(xui.getRes("RAD.notsave"), xui.getRes("RAD.notsave2"), fun)
            } else {
                fun()
            }
        },
        _tabsmain_beforepageclose: function (profile, item, src) {
            if (item._dirty) {
                xui.UI.Dialog.confirm(xui.getRes("RAD.notsave"), xui.getRes("RAD.notsave2"), function () {
                    profile.boxing().removeItems(item.id)
                });
                return false
            }
        },
        _tabsmain_afterpageclose: function (profile, item, src) {
            if (item.$obj) {
                item.$obj.destroy()
            }
            SPA.currentPage = ""
        },
        _tabsmain_beforeValueUpdated: function (profile, ov, nv) {
            var item = this.tabsMain.getItemByItemId(ov),
                t;
            if (!item) {
                return
            }
            if (t = item.$obj) {
                if (t.getValue() === false) {
                    return false
                }
            }
        },
        _tabmain_onitemselected: function (profile, item, e, src) {
            if (item._inn) {
                profile.boxing().setDisabled(true);
                profile.boxing().append(item._inn, item.id);
                delete item._inn
            }
            _.tryF(function () {
                if (item.$obj) {
                    item.$obj.activate()
                }
            });
            SPA.currentPage = item.id
        },
        _treebarprj_onconm: function (profile, e, node, item) {
            var ns = this,
                items;
            if (item) {
                items = [{
                    id: "del2",
                    image: "@CONF.img_app",
                    imagePos: "-80px -16px",
                    caption: "$RAD.tool2.del2"
                }, {
                    id: "split",
                    type: "split"
                }, {
                    id: "refresh",
                    image: "@CONF.img_app",
                    imagePos: "-113px -16px",
                    caption: "$RAD.tool2.refresh"
                }];
                if (item.sub) {
                    items.unshift({
                        id: "new2",
                        image: "@CONF.img_app",
                        imagePos: "-0px -16px",
                        caption: "$RAD.tool2.new2"
                    })
                }
            } else {
                items = [{
                    id: "refresh",
                    image: "@CONF.img_app",
                    imagePos: "-113px -16px",
                    caption: "$RAD.tool2.refresh"
                }]
            }
            var pop = new xui.UI.PopMenu({
                items: items
            });
            pop.onMenuSelected(function (profile, popitem, src) {
                switch (popitem.id) {
                case "new2":
                    xui.ComFactory.getCom("addFile", function () {
                        this.host = ns;
                        this.reset();
                        this.setProperties({
                            onOK: ns._addfile,
                            parent: ns,
                            item: item,
                            fromRegion: xui(src).cssRegion(true)
                        });
                        this.show(xui("body"))
                    });
                    break;
                case "del2":
                    xui.confirm(xui.getRes("RAD.delfile.confirmdel"), xui.getRes("RAD.delfile.confirmdel2", "1"), function () {
                        ns._delfile(item.id)
                    });
                    break;
                case "refresh":
                    ns._projecttool_onclick(ns.projecttool.get(0), {
                        id: "refresh"
                    });
                    break
                }
            });
            pop.pop(item ? node : xui.Event.getPos(e));
            return false
        },
        _treebarprj_onGetContent: function (profile, item, callback) {
            var ns = this;
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "open",
                    hashCode: _.id(),
                    path: item.id
                }
            }, function (txt) {
                var obj = txt;
                if (obj && !obj.error) {
                    var root = ns.buildFileItems(item.id, obj.data);
                    callback(root.sub)
                } else {
                    xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
                }
            })
        },
        _treebarprj_onitemselected: function (profile, item, e, src) {
            if (item.sub) {
                profile.boxing().toggleNode(item.id)
            } else {
                this._openfile(item, src)
            }
        },
        _openfile: function (item, src, stopseleted, dontshowerror) {
            if (!item.id) {
                return
            }
            var page = this,
                arr = item.caption.split("."),
                type = arr[arr.length - 1];
            var value = item.value,
                arr = value.split("/"),
                filename = arr[arr.length - 1],
                filearr = filename.split("."),
                filetype = filearr[filearr.length - 1],
                imagePos = (filetype == "js" || filetype == "json") ? "-16px -48px" : "-128px -48px";
            var tb = page.tabsMain,
                pro = tb.reBoxing().cssRegion(true);
            if (tb.getItemByItemId(value)) {
                tb.fireItemClickEvent(value)
            } else {
                if (src) {
                    var t = xui(src).cssRegion(true);
                    xui.Dom.animate({
                        border: "dashed 1px #ff0000"
                    }, {
                        left: [t.left, pro.left],
                        top: [t.top, pro.top],
                        width: [t.width, pro.width],
                        height: [t.height, pro.height]
                    }, null, function () {}, 240, 8, "expoIn").start()
                }
                var funOK = function (txt) {
                        if (txt.error) {
                            xui.message(txt.error.message);
                            return
                        }
                        var filecon = txt.data.file;
                        if (_.isSet(filecon)) {
                            var item = {
                                id: value,
                                tips: value,
                                caption: filename,
                                closeBtn: true,
                                image: CONF.img_app,
                                imagePos: imagePos,
                                newText: filecon,
                                text: filecon
                            },
                                items = tb.getItems(),
                                itemid = item.id,
                                callback = function (pagprofile, b) {
                                    tb.markItemCaption(pagprofile.properties.keyId, b)
                                };
                            tb.insertItems([item], items.length ? items[items.length - 1].id : null);
                            if (filetype != "js") {
                                xui.ComFactory.newCom("RAD.PageEditor", function () {
                                    var inn = this;
                                    inn.host = page;
                                    inn.setType(filetype);
                                    inn.setProperties({
                                        keyId: itemid
                                    });
                                    inn.setEvents("onValueChanged", callback);
                                    inn.setEvents("onCommandSave", function (pagprofile) {
                                        page._menubar_onclick(page.menubar.get(0), null, {
                                            id: "save"
                                        })
                                    });
                                    inn.setEvents("afterRendered", function () {
                                        tb.setDisabled(false)
                                    });
                                    inn.setValue(filecon);
                                    var item = tb.getItemByItemId(itemid);
                                    item.$obj = inn;
                                    item._inn = inn;
                                    if (!stopseleted) {
                                        tb.fireItemClickEvent(value)
                                    }
                                })
                            } else {
                                xui.ComFactory.newCom("RAD.JSEditor", function () {
                                    var inn = this;
                                    inn.host = page;
                                    inn.setProperties({
                                        keyId: itemid
                                    });
                                    inn.setEvents("onValueChanged", callback);
                                    inn.setEvents("onCommandSave", function (pagprofile) {
                                        page._menubar_onclick(page.menubar.get(0), null, {
                                            id: "save"
                                        })
                                    });
                                    inn.setEvents("afterRendered", function () {
                                        tb.setDisabled(false)
                                    });
                                    inn.setDftPage("code");
                                    inn.setValue(filecon);
                                    var item = tb.getItemByItemId(itemid);
                                    item.$obj = inn;
                                    item._inn = inn;
                                    if (!stopseleted) {
                                        tb.fireItemClickEvent(value)
                                    }
                                })
                            }
                        }
                    },
                    funFail = function (msg) {
                        if (!dontshowerror) {
                            xui.message(msg)
                        }
                    };
                CONF.callService({
                    key: CONF.requestKey,
                    paras: {
                        action: "getfile",
                        hashCode: _.id(),
                        path: value
                    }
                }, funOK, funFail)
            }
        },
        iniComponents: function () {
            var t = this,
                n = [],
                u = xui.UI,
                f = function (c) {
                    n.push(c.get(0))
                };
            f((new u.ToolBar).setHost(t, "toolbar").setDockOrder("2").setItems([]).onClick("_toolbar_onclick"));
            f((new u.MenuBar).setHost(t, "menubar").setDockOrder("1").setItems([]).onMenuSelected("_menubar_onclick"));
            f((new u.Block).setHost(t, "statusBar").setDock("bottom").setDockOrder("2").setHeight(16).setBorderType("inset").setHtml("You are an unauthorized user!&nbsp;&nbsp;&nbsp;&nbsp;You need a <strong><a target=_blank href='http://www.crossui.com/order.html'> License Code </a></strong>"));
            f((new u.Image).setHost(t, "floatLogo").setZIndex(0).onRender(function (pro) {
                pro.getRoot().onClick(function () {
                    CONF.openURL(CONF.path_link)
                })
            }));
            f((new u.Layout).setHost(t, "layout").setLeft(0).setTop(0).setItems([{
                id: "before",
                pos: "before",
                locked: false,
                size: 150,
                min: 50,
                max: 300,
                cmd: true,
                hide: false
            }, {
                id: "main",
                min: 10
            }]).setType("horizontal"));
            t.layout.append((new u.Panel).setHost(t, "panelbar2").setCaption("$RAD.pm.title").setImage("@CONF.img_app").setImagePos("-128px -48px").setCustomStyle({
                PANEL: "overflow:auto"
            }), "before");
            t.panelbar2.append((new u.TreeView).setHost(t, "treebarPrj").setSelMode("none").setPosition("relative").setWidth("auto").setHeight("auto").setItems([]).onItemSelected("_treebarprj_onitemselected").onGetContent("_treebarprj_onGetContent").onContextmenu("_treebarprj_onconm"));
            t.layout.append((new u.Tabs).setHost(t, "tabsMain").setLeft(0).setTop(0).setItems([]).beforeUIValueSet("_tabsmain_beforeValueUpdated").beforePageClose("_tabsmain_beforepageclose").afterPageClose("_tabsmain_afterpageclose").onItemSelected("_tabmain_onitemselected").setCustomStyle({
                PANEL: "overflow:hidden;"
            }), "main");
            t.layout.append((new u.ToolBar).setHost(t, "projecttool").setDock("bottom").setHandler(false).setHAlign("right").setItems([{
                id: "only",
                sub: [{
                    id: "refresh",
                    image: "@CONF.img_app",
                    imagePos: "-113px -16px",
                    tips: "$RAD.tool2.refresh"
                }, {
                    type: "split"
                }, {
                    id: "new",
                    image: "@CONF.img_app",
                    imagePos: "-0px -16px",
                    tips: "$RAD.tool2.new"
                }, {
                    id: "delete",
                    image: "@CONF.img_app",
                    imagePos: "-80px -16px",
                    tips: "$RAD.tool2.del"
                }]
            }]).onRender(function (profile) {
                profile.getSubNode("ITEMS").css({
                    borderLeftWidth: 0,
                    borderRightWidth: 0,
                    borderBottomWidth: 0
                })
            }).onClick("_projecttool_onclick"), "before");
            return n
        },
        _toolbar_onclick: function (profile, item, group, e, src) {
            this._menubar_onclick(this.menubar.get(0), null, item, src)
        },
        buildFileItems: function (path, obj) {
            var names = path.split("/"),
                name = names[names.length - 1],
                imagePos, hash = {
                    "*": {
                        id: path,
                        caption: name,
                        image: CONF.img_app,
                        imagePos: "-128px -48px",
                        value: path,
                        sub: []
                    }
                };
            obj.sort(function (x, y) {
                return x.layer < y.layer ? 1 : x.layer == y.layer ? (x.type > y.type ? 1 : x.type == y.type ? (x.location > y.location ? 1 : -1) : -1) : -1
            });
            _.arr.each(obj, function (o) {
                if (!o.type) {
                    imagePos = "-48px top"
                } else {
                    var a = o.name.split(".");
                    switch (a[1].toLowerCase()) {
                    case "html":
                        imagePos = "-112px -48px";
                        break;
                    case "css":
                        imagePos = "-208px -48px";
                        break;
                    case "js":
                        imagePos = "-16px -48px";
                        break;
                    case "jpg":
                    case "png":
                    case "gif":
                        imagePos = "-192px 0px";
                        break;
                    default:
                        imagePos = "-96px -48px"
                    }
                }
                hash[o.id] = {
                    id: o.location,
                    caption: o.name,
                    image: CONF.img_app,
                    imagePos: imagePos,
                    value: o.location
                };
                if (!o.type) {
                    hash[o.id].sub = true
                }
                hash[o.pid].sub.push(hash[o.id])
            });
            return hash["*"]
        },
        _openproject: function (pm, obj, nomainjs) {
            var ns = this;
            pm = pm.replace(/\\/g, "/");
            window["/"] = CONF.getPrjPath(pm) + "/";
            ns.curProject = pm;
            ns.curProjectName = pm.substr(pm.lastIndexOf("/") + 1, pm.length);
            var root = ns.buildFileItems(pm, obj);
            var tb = ns.treebarPrj;
            tb.clearItems();
            tb.insertItems([root]);
            tb.toggleNode(root.id, true);
            if (!nomainjs) {
                ns._openfile({
                    id: root.id + "/App/js/index.js",
                    value: root.value + "/App/js/index.js",
                    caption: "index.js"
                })
            }
        },
        _menubar_onclick: function (profile, popPro, item, src) {
            var self = this;
            if (!self._prjserial) {
                self._prjserial = 1
            }
            switch (item.id) {
            case "newproject":
                var callback = function () {
                        xui.ComFactory.getCom("prjPro", function () {
                            this.host = self;
                            this.setProperties({
                                projectName: "MyPrj" + (self._prjserial++),
                                xuiPath: "",
                                className: "App",
                                readonly: false,
                                fromRegion: xui(src).cssRegion(true),
                                onOK: self._openproject
                            });
                            this.show(xui("body"))
                        })
                    };
                if (this.curProject) {
                    this._closeproject(callback)
                } else {
                    callback()
                }
                break;
            case "closeproject":
                if (!this.curProject) {
                    xui.message(xui.getRes("RAD.ps.noprj"));
                    return
                }
                this._closeproject();
                break;
            case "deleteproject":
                if (!this.curProject) {
                    xui.message(xui.getRes("RAD.ps.noprj"));
                    return
                }
                xui.UI.Dialog.confirm(xui.getRes("RAD.delfile.confirmdel"), xui.getRes("RAD.delfile.confirmdel3"), function () {
                    self._delfile(self.curProject)
                });
                break;
            case "openproject":
                var callback = function () {
                        xui.ComFactory.getCom("prjSel", function () {
                            this.host = self;
                            this.setProperties({
                                fromRegion: xui(src).cssRegion(true),
                                onOK: self._openproject
                            });
                            this.show(xui("body"))
                        })
                    };
                if (this.curProject) {
                    this._closeproject(callback)
                } else {
                    callback()
                }
                break;
            case "save":
                if (!this.curProject) {
                    xui.message(xui.getRes("RAD.ps.noprj"));
                    return
                }
                var tb = this.tabsMain,
                    id = tb.getUIValue(),
                    o = tb.getItemByItemId(id),
                    hash = {},
                    collections = [];
                if (o._dirty) {
                    var newText = o.$obj.getValue();
                    if (false === newText) {
                        return false
                    }
                    var paras = {
                        action: "save",
                        hashCode: _.id(),
                        path: o.id,
                        content: newText
                    };
                    var onSuccess = function (txt) {
                            var obj = txt;
                            if (obj && !obj.error && obj.data && obj.data.OK) {
                                o.$obj.setValue(newText);
                                tb.markItemCaption(o.id, false, true)
                            } else {
                                xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
                            }
                        };
                    var onFail = function (txt) {
                            xui.message(txt)
                        };
                    collections.push({
                        id: o.id,
                        paras: paras,
                        onSuccess: onSuccess,
                        onFail: onFail
                    })
                }
                CONF.saveFiles(collections);
                break;
            case "saveall":
                if (!this.curProject) {
                    xui.message(xui.getRes("RAD.ps.noprj"));
                    return
                }
                var tb = this.tabsMain,
                    count = 0,
                    items = tb.getItems(),
                    hash = {},
                    collections = [];
                _.arr.each(items, function (o) {
                    if (o._dirty) {
                        var newText = o.$obj.getValue();
                        if (false === newText) {
                            return false
                        }
                        var paras = {
                            action: "save",
                            hashCode: _.id(),
                            path: o.id,
                            content: newText
                        };
                        var onSuccess = function (txt) {
                                var obj = txt;
                                if (obj && !obj.error && obj.data && obj.data.OK) {
                                    o.$obj.setValue(newText);
                                    tb.markItemCaption(o.id, false, true);
                                    count++
                                } else {
                                    xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
                                }
                            };
                        var onFail = function (txt) {
                                xui.message(txt)
                            };
                        collections.push({
                            id: o.id,
                            paras: paras,
                            onSuccess: onSuccess,
                            onFail: onFail
                        })
                    }
                });
                CONF.saveFiles(collections);
                break;
            case "ec":
                if (!this.$dropmenulang) {
                    this.$dropmenulang = new xui.UI.PopMenu({
                        items: [{
                            id: "en",
                            caption: xui.getRes("RAD.en")
                        }, {
                            id: "cn",
                            caption: xui.getRes("RAD.cn")
                        }, {
                            id: "tw",
                            caption: xui.getRes("RAD.tw")
                        }, {
                            id: "ja",
                            caption: xui.getRes("RAD.ja")
                        }, {
                            id: "ru",
                            caption: xui.getRes("RAD.ru")
                        }]
                    }, {
                        onMenuSelected: function (p, item) {
                            var lang = item.id;
                            if (xui.getLang() != lang) {
                                xui.setLang(lang, function () {
                                    self.$dropmenulang.destroy();
                                    delete self.$dropmenulang;
                                    xui.include("xui.Locale.en.app", CONF.getAPIPath() + "Locale/en.js", function () {
                                        if (!xui.Locale[lang].doc) {
                                            xui.Locale[lang].doc = xui.Locale.en.doc
                                        }
                                    });
                                    xui.include("lang." + lang, CONF.getAPIPath() + "Locale/" + lang + ".js")
                                })
                            }
                        }
                    })
                }
                this.$dropmenulang.pop(src);
                break;
            case "theme":
                var m;
                if (!(m = this.$dropmenutheme)) {
                    m = this.$dropmenutheme = new xui.UI.PopMenu();
                    m.onMenuSelected(function (p, item) {
                        if (xui.getLang() != item.id) {
                            xui.setTheme(item.id, function () {
                                self.$dropmenutheme.destroy();
                                delete self.$dropmenutheme
                            })
                        }
                    })
                }
                var callback = function () {
                        m.pop(src)
                    };
                if (m.getTag()) {
                    callback()
                } else {
                    CONF.callService({
                        key: CONF.requestKey,
                        paras: {
                            action: "getThemes",
                            hashCode: _()
                        }
                    }, function (txt) {
                        var obj = txt;
                        if (obj && !obj.error && obj.data) {
                            var items = [];
                            _.arr.each(obj.data, function (o) {
                                items.push({
                                    id: o,
                                    caption: "$RAD.builder.themes." + o
                                })
                            });
                            var fIndex = _.arr.subIndexOf(items, "id", "default"),
                                first = items[fIndex];
                            _.arr.removeFrom(items, fIndex);
                            _.arr.insertAny(items, first, 0);
                            m.setItems(items);
                            m.setTag("Loaded");
                            callback(items)
                        } else {
                            xui.message(_.get(obj, ["error", "message"]) || obj || "no response!")
                        }
                    }, function (txt) {
                        xui.message(txt)
                    })
                }
                break;
            case "info":
                if (!this.Message.length) {
                    return
                }
                var list = this.$infoList,
                    node = list.reBoxing();
                list.setItems(_.copy(this.Message));
                node.popToTop(src, 4);
                var unFun = function () {
                        node.hide();
                        xui.Event.keyboardHook("esc")
                    };
                node.setBlurTrigger(list.get(0).$xid, unFun);
                xui.Event.keyboardHook("esc", 0, 0, 0, unFun);
                break;
            case "debug":
                if (!self.curProject) {
                    xui.message(xui.getRes("RAD.ps.noprj"));
                    return
                }
                self._dirtyWarn(function () {
                    CONF.debugApp(CONF.getPrjPath(self.curProject) + "/debug.html", {
                        rand: _()
                    })
                });
                break;
            case "release":
                if (!this.$deploymenu) {
                    this.$deploymenu = new xui.UI.PopMenu({
                        items: self._pfitems
                    }, {
                        onMenuSelected: function (p, item) {
                            self._menubar_onclick(self.menubar.get(0), null, item, src)
                        }
                    })
                }
                this.$deploymenu.pop(src);
                break;
            case "saveasweb":
                if (!self.curProject) {
                    xui.message(xui.getRes("RAD.ps.noprj"));
                    return
                }
                var hash = {
                    key: CONF.requestKey,
                    paras: {
                        action: "saveasweb",
                        ver: "advanced",
                        path: self.curProject,
                        theme: xui.getTheme(),
                        lang: xui.getLang()
                    }
                };
                CONF.saveAS(hash);
                break;
            case "saveaswin":
            case "saveaslinux":
            case "saveaslinux64":
            case "saveasosx":
                if (!self.curProject) {
                    xui.message(xui.getRes("RAD.ps.noprj"));
                    return
                }
                var hash = {
                    key: CONF.requestKey,
                    paras: {
                        action: item.id,
                        ver: "advanced",
                        path: self.curProject,
                        theme: xui.getTheme(),
                        lang: xui.getLang()
                    }
                };
                CONF.saveAS(hash);
                break;
            case "saveasmobile":
                var hash = {
                    key: CONF.requestKey,
                    paras: {
                        action: "saveasmobile",
                        ver: "advanced",
                        path: self.curProject,
                        theme: xui.getTheme(),
                        lang: xui.getLang()
                    }
                };
                CONF.saveAS(hash);
                break;
            case "servicetester":
                xui.ComFactory.getCom("RAD.ServiceTester", function () {
                    this.init();
                    this.show()
                });
                break;
            case "command":
                xui.log("Ready");
                break;
            case "jsoneditor":
                CONF.openJSONEditor();
                break;
            case "cookbook":
                CONF.openBook();
                break;
            case "api":
                CONF.openAPI();
                break;
            case "codesnipt":
                CONF.openURL("http://www.crossui.com/Forum/crossui-code-snaps-f10.html");
                break;
            case "php":
                CONF.openURL("http://www.crossui.com/Forum/php-f12.html");
                break;
            case "csharp":
                CONF.openURL("http://www.crossui.com/Forum/c-f14.html");
                break;
            case "java":
                CONF.openURL("http://www.crossui.com/Forum/java-f13.html");
                break;
            case "simple":
                CONF.openSimpleVer();
                break;
            case "video":
                CONF.openURL(CONF.path_video);
                break;
            case "editorTheme":
                xui.ComFactory.newCom("RAD.EditorTheme", function () {
                    this.show();
                    this.setEvents("onOK", function (theme, fs) {
                        if (CONF.serviceType == "node-webkit") {
                            var obj = NW.getStatus();
                            obj.editorTheme = theme;
                            obj.editorFontSize = fs;
                            NW.saveStatus(obj)
                        } else {
                            CONF.editorTheme = theme;
                            CONF.editorFontSize = fs
                        }
                        if (self.curProject) {
                            var tb = self.tabsMain,
                                items = tb.getItems();
                            _.arr.each(items, function (o) {
                                if (o = o.$obj) {
                                    o.resetEditorStyle(theme, fs)
                                }
                            })
                        }
                    })
                });
                break;
            case "editcfg":
                if (!self.curProject) {
                    xui.message(xui.getRes("RAD.ps.noprj"));
                    return
                }
                NW.ensureConfigAndIcon(self.curProject);
                self._openfile({
                    id: self.curProject + "/.settings/package.json",
                    value: self.curProject + "/.settings/package.json",
                    caption: "package.json"
                });
                break;
            case "movews":
                var f = function () {
                        xui.ComFactory.getCom("RAD.SwitchWorkspace", function () {
                            this.init();
                            this.show()
                        })
                    };
                if (this.curProject) {
                    this._closeproject(f)
                } else {
                    f()
                }
                break;
            case "forum":
                CONF.openURL(CONF.path_forum);
                break;
            case "download":
                CONF.openURL(CONF.path_download);
                break;
            case "about":
                xui.ComFactory.getCom("about", function () {
                    this.dialog.show(null, true)
                });
                break;
            case "Register":
                if (NW) {
                    NW.request("CheckRegisterStatus", 0, function () {
                        linb.alert("You are already a registered user!")
                    })
                }
                break;
            default:
                xui.message(xui.getRes("RAD.soon"))
            }
        }
    }
});
Class("RAD.CodeEditor", ["xui.UI.Widget", "xui.absValue"], {
    Instance: {
        activate: function () {
            var profile = this.get(0);
            if (profile.$cm) {
                profile.$cm.focus()
            }
            return this
        },
        getCM: function () {
            return this.get(0).$cm
        },
        resetEditorStyle: function (theme, fs, cm) {
            this.addCMTheme(theme);
            var profile = this.get(0);
            if (!cm) {
                cm = profile.$cm
            }
            if (cm) {
                cm.setOption("theme", theme);
                var n = cm.getWrapperElement();
                if (n) {
                    n.style.fontSize = fs + "px"
                }
            }
        },
        addCMTheme: function (theme) {
            var profile = this.get(0);
            var id = "cm-theme-" + theme;
            if (theme != "default" && !xui.CSS.get("id", id)) {
                xui.CSS.includeLink("codemirror3/theme/" + theme + ".css", false, id)
            }
        },
        clearHistory: function () {
            var obj = this.get(0).$editor;
            if (obj && obj.editor) {
                return obj.editor.history.clear()
            }
        },
        reindent: function () {
            var cm = this.get(0).$cm,
                doc = cm.doc;
            if (doc.somethingSelected()) {
                var p1 = doc.getCursor("start"),
                    p2 = doc.getCursor("end");
                for (var i = p1.line, l = p2.line; i <= l; i++) {
                    cm.indentLine(i)
                }
            } else {
                var p1 = doc.firstLine(),
                    p2 = doc.lastLine();
                for (var i = p1, l = p2; i <= l; i++) {
                    cm.indentLine(i)
                }
            }
        },
        callEditor: function (name, args, isDoc) {
            var obj = this.get(0).$cm;
            if (isDoc) {
                obj = obj.doc
            }
            return obj[name].apply(obj, args || [])
        },
        searchCode: function (code) {
            var profile = this.get(0),
                cm = profile.$cm;
            if (cm) {
                var cursor = cm.getSearchCursor(code);
                if (cursor.findNext()) {
                    cm.focus();
                    cm.doc.setSelection(cursor.from(), cursor.to())
                }
            }
        },
        locateTo: function (key1, key2, toSelect) {
            var ns = this,
                profile = this.get(0),
                cm = profile.$cm,
                struct, info, codefrom, codeto;
            if (cm) {
                struct = RAD.ClassTool.getClassStruct2(cm.doc.getValue());
                if (key1) {
                    if (key2 && (key1 == "Static" || key1 == "Instance")) {
                        info = _.get(struct, ["sub", key1, "sub", key2])
                    } else {
                        info = _.get(struct, ["sub", key1])
                    }
                }
                if (info) {
                    if (toSelect) {
                        cm.doc.setSelection(cm.doc.posFromIndex(info.from), cm.doc.posFromIndex(info.to))
                    } else {
                        var pos = cm.doc.posFromIndex(info.from);
                        cm.focus();
                        cm.doc.setCursor(pos);
                        cm.scrollIntoView(pos)
                    }
                    return true
                }
            }
            return false
        },
        addCodeInto: function (key1, key2, code, isFun) {
            var ns = this,
                profile = this.get(0),
                cm = profile.$cm;
            if (cm) {
                var struct = RAD.ClassTool.getClassStructWithScope(cm.getValue()),
                    fo = _.get(struct, ["sub", key1, "sub", key2]),
                    fo2;
                if (fo && (fo.type == "function" || fo.type == "object")) {
                    cm.doc.replaceRange(code, cm.doc.posFromIndex(fo.from), cm.doc.posFromIndex(fo.to))
                } else {
                    fo = _.get(struct, ["sub", key1]);
                    if (!fo) {
                        fo2 = _.get(struct, ["sub", struct.arr[struct.arr.length - 1]]);
                        if (fo2) {
                            code = ",\n" + key1 + ":{\n" + key2 + ":" + (isFun ? "function()" : "") + code + "\n}"
                        } else {
                            code = key1 + ":{\n" + key2 + ":" + (isFun ? "function()" : "") + code + "\n}\n";
                            fo2 = struct;
                            fo2.to--
                        }
                    } else {
                        fo2 = _.get(fo, ["sub", fo.arr[fo.arr.length - 1]]);
                        if (fo2) {
                            code = ",\n" + key2 + ":" + (isFun ? "function()" : "") + code
                        } else {
                            code = key2 + ":" + (isFun ? "function()" : "") + code + "\n";
                            fo2 = fo;
                            fo2.to--
                        }
                    }
                    var pos = cm.doc.posFromIndex(fo2.to);
                    cm.doc.replaceRange(code, pos, pos);
                    cm.doc.setSelection(pos, cm.doc.posFromIndex(fo2.to + code.length));
                    ns.reindent()
                }
                ns.locateTo(key1, key2)
            }
        },
        _setCtrlValue: function (value) {
            if (!_.isSet(value)) {
                value = ""
            }
            return this.each(function (profile) {
                if (profile.$cm) {
                    profile.$cm.doc.setValue(value)
                }
            })
        },
        _getCtrlValue: function () {
            var profile = this.get(0);
            if (profile.$cm) {
                return profile.$cm.doc.getValue()
            } else {
                return profile.properties.$UIvalue
            }
        }
    },
    Initialize: function () {
        var t = this.getTemplate();
        _.merge(t.FRAME.BORDER, {
            BOX: {
                tagName: "div"
            }
        }, "all");
        this.setTemplate(t);
        __trim = function (s) {
            if (/[^\s\uFEFF\xA0]/.test(s)) {
                return _.str.trim(s)
            } else {
                return s
            }
        }
    },
    Static: {
        $tempsandbox: "_$temp_for_xui_sandbox",
        $tempsandbox2: "_$temp_for_xui_sandbox2",
        $temppool: "_$temp_for_xui_pool",
        Appearances: {
            BOX: {
                width: "100%",
                height: "100%",
                left: 0,
                top: 0,
                position: "absolute",
                background: "#fff"
            }
        },
        Behaviors: {},
        DataModel: {
            left: 0,
            top: 0,
            width: 200,
            height: 200,
            position: "absolute",
            json: {
                ini: false
            },
            codeType: {
                ini: "js",
                listbox: ["js", "css", "php", "html", "xml", "other"]
            },
            readonly: {
                ini: false,
                action: function (value) {
                    if (this.$cm) {
                        this.$cm.setOption("readOnly", !! value)
                    }
                }
            }
        },
        EventHandlers: {
            onValueChanged: function (profile) {},
            onRendered: function (profile) {},
            onGetHelpInfo: function (profile, key) {},
            onSaveCommand: function () {}
        },
        RenderTrigger: function () {
            var key = this.box.$temppool,
                subkey = this.$xid;
            this.box._loadEditor(this);
            this.destroyTrigger = function () {
                delete this.$cm;
                delete this.$editor;
                if (this.$popList) {
                    this.$popList.destroy()
                }
                if (this.$popHelp) {
                    this.$popHelp.destroy()
                }
                if (this.$popCustom) {
                    this.$popCustom.destroy()
                }
                if (window[key]) {
                    delete window[key][subkey]
                }
            }
        },
        evalInSandbox: function (code, isjson, name, subCacheKey) {
            if (name && document.getElementById(name)) {
                document.body.removeChild(document.getElementById(name));
                try {
                    delete frames[name]
                } catch (e) {}
            }
            var ns = this,
                iframe = document.createElement("iframe"),
                result, wnd, line, errmsg, type;
            if (name) {
                iframe.name = name;
                iframe.id = name
            }
            iframe.src = "about:blank";
            iframe.style.display = "none";
            document.body.appendChild(iframe);
            wnd = frames[frames.length - 1];
            wnd.document.open();
            wnd.document.write('<meta http-equiv="content-type" content="text/html; charset=utf-8" />');
            wnd.document.write("<script>\nglobal=process=Buffer=require=module=exports=null;\n_=window._=parent._;\nClass=window.Class=parent.Class;\nxui=window.xui=parent.xui;\nvar __cache={},__getThis=function(pname,type){\n      if(__cache[pname+':'+type])return __cache[pname+':'+type];\n      var obj=type==1?function(){}:{};\n      if(pname){\n          if(_.isArr(pname)){\n              _.each(pname,function(cls){\n                  obj=_.merge(obj, type==1?xui.SC(cls):(new xui.SC(cls)),'all')\n              });\n          }else{\n              obj=_.merge(obj, type==1?xui.SC(pname):(new xui.SC(pname)),'all')\n          }\n      }\n      if(window['" + ns.$temppool + "'] && window['" + ns.$temppool + "']['" + subCacheKey + "']){\n          obj=_.merge(obj, window['" + ns.$temppool + "']['" + subCacheKey + "'][type==1?'Static':'Instance'],'all')\n      }\n      return __cache[pname+':'+type]=obj;\n  };\ndompack=window.dompack=function(){var o=new xui.Dom(false),d=document.getElementById('abc');o._nodes=[d];return o};\nwindow['" + ns.$temppool + "']=parent['" + ns.$temppool + "'];\nparent['" + ns.$tempsandbox + "']=/*@cc_on !@*/0?this:{eval:function(s){return (function(){var b=arguments.callee;return window.eval.call(window,s)})()}};\nparent['" + ns.$tempsandbox2 + "']={getErrLine:function(s,cb){window.onerror=function(){cb.apply(null,arguments);return true;};var n=document.createElement('script');n.type='text/javascript';if(/*@cc_on !@*/0){n.text=s;}else{n.appendChild(document.createTextNode(s));};document.body.appendChild(n);window.onerror=null;}};\ntry{top=parent=null;}catch(e){}<\/script><body><span id='abc'></span></body>");
            wnd.document.close();
            var bak = xui.Dom.pack;
            try {
                xui.Dom.pack = wnd.dompack;
                result = window[ns.$tempsandbox].eval(isjson ? ("(" + code + ")") : code);
                type = (result === wnd || result === wnd.content) ? "window" : result === wnd.history ? "history" : result === wnd.screen ? "screen" : result === wnd.location ? "location" : result === wnd.navigator ? "navigator" : result === wnd.document ? "document" : null
            } catch (e) {
                if (_.isSet(e.line || e.lineNumber)) {
                    line = e.line || e.lineNumber;
                    if (xui.browser.gek) {
                        line -= 6;
                        if (line < 1) {
                            line = 2
                        }
                    }
                } else {
                    var base = 0;
                    if (xui.browser.ie) {
                        window[ns.$tempsandbox2].getErrLine("var _a={;", function (a, b, c) {
                            base = c - 1;
                            return true
                        })
                    }
                    window[ns.$tempsandbox2].getErrLine(isjson ? ("(" + code + ")") : (code), function (a, b, c) {
                        line = c - base;
                        return true
                    })
                }
                errmsg = ((e.name ? e.name + " : " : "") + (e.description || e.message || "") + (line ? "\n line : " + line : ""));
                if (!_.isSet(line) && /.*at line ([\d]+).*/.test(errmsg)) {
                    line = errmsg.replace(/.*at line ([\d]+).*/, "$1")
                }
            } finally {
                xui.Dom.pack = bak;
                wnd.Class = wnd._ = wnd.xui = wnd[ns.$temppool] = null;
                window[ns.$tempsandbox] = undefined;
                window[ns.$tempsandbox2] = undefined;
                if (!name) {
                    document.body.removeChild(iframe)
                }
                iframe = wnd = null
            }
            return {
                ok: result,
                type: type,
                ko: errmsg,
                line: line
            }
        },
        _buildItem: function (id, type, key, o, caption, value, order, itemStyle) {
            return {
                id: id,
                caption: caption || id,
                value: value || id,
                tag: (order || (type == "property" ? "b" : type == "function" ? "c" : type == "class" ? "d" : type == "event" ? "e" : "a")) + ":" + id.toLowerCase(),
                path: (key ? (key + ".") : "") + id,
                itemStyle: itemStyle,
                image: type ? xui.getPath("img/", "App.gif") : null,
                imagePos: !type ? null : (type == "property" ? (_.isSet(o) && _.isHash(o)) ? "-16px -32px" : (_.isSet(o) && _.isArr(o)) ? "-128px -32px" : "0 -32px" : type == "var" ? "0 -32px" : type == "event" ? "-48px -32px" : type == "function" ? "-32px -32px" : type == "class" ? "-16px -48px" : "-64px -32px")
            }
        },
        _intellcache: {},
        _enumKeys: function (target, key, normalObj, ownOnly) {
            if (!_.isObj(target) || _.isArr(target)) {
                return []
            }
            normalObj = normalObj !== false;
            var ns = this,
                isxuiobj = target.$xui$,
                o, isfun, list = [];
            for (var i in target) {
                if ("prototype" == i || "constructor" == i) {
                    continue
                }
                if (isxuiobj) {
                    if ("upper" == i || "After" == i || "Before" == i || "Instance" == i || "Static" == i || "Constructor" == i) {
                        continue
                    }
                }
                try {
                    if (i.charAt(0) != "_" && i.charAt(0) != "$" && /^[\w_]+$/.test(i)) {
                        o = target[i];
                        if (normalObj && (o && o.$abstract)) {
                            continue
                        }
                        isfun = typeof o == "function" && (!(o && o.$xui$) || o.$asFunction);
                        if (ownOnly && (!target.hasOwnProperty(i) || !target.propertyIsEnumerable(i))) {
                            continue
                        }
                        list.push(ns._buildItem(i, (typeof o == "function") ? (o && o.$xui$ && !o.$asFunction) ? "class" : (o && o.$event$) ? "event" : "function" : "property", key, o, i + (isfun ? "(" : "") + ((isfun && normalObj) ? _.fun.args(o) : "") + (isfun ? ")" : ""), i + (isfun ? "(" : "") + ((isfun && normalObj) ? _.fun.args(o) : "") + (isfun ? ")" : "")))
                    }
                } catch (e) {}
            }
            return list
        },
        _getIntellisenseList: function (key, cachedata) {
            if (!key) {
                return null
            }
            cachedata = cachedata !== false;
            var ns = this,
                cache = ns._intellcache,
                buildItem = ns._buildItem;
            if (cachedata && cache[key]) {
                return cache[key]
            }
            var list = [];
            if (key == ns.$temppool) {
                return []
            }
            switch (key) {
            case " variables ":
                list = [buildItem("_", 0, 0, 0, 0, 0, 2, "font-weight:bold;color:#ff0000;"), buildItem("_()", 0, 0, 0, "_()", "_()", 2, "font-weight:bold;color:#ff0000;"), buildItem("Class", 0, 0, 0, "Class(...)", 'Class("","",{\n})', 2, "font-weight:bold;color:#ff0000;"), buildItem("xui", 0, 0, 0, 0, 0, 2, "font-weight:bold;color:#ff0000;"), buildItem("xui()", 0, 0, 0, "xui()", "xui()", 2, "font-weight:bold;color:#ff0000;"), buildItem("top", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("parent", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("window", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("document", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("navigator", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("history", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("location", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("screen", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("Math", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("Number", 0, 0, 0, 0, 0, 3, "font-weight:bold;"), buildItem("if  ", 0, 0, 0, "if...", "if(){\n\n}", 5), buildItem("ifelse", 0, 0, 0, "if...else...", "if(){\n\n}else{\n\n}", 5), buildItem("while", 0, 0, 0, "while...", "while(){\n\n};", 5), buildItem("do  ", 0, 0, 0, "do...while", "do{\n\n}while();", 5), buildItem("try  ", 0, 0, 0, "try...catch...finally", "try{\n\n}catch(e){\n\n}finally{\n\n}", 5), buildItem("for  ", 0, 0, 0, "for...", "for(;;;){\n\n}", 5), buildItem("forin  ", 0, 0, 0, "for...in", "for( in ){\n\n}", 5), buildItem("function", 0, 0, 0, "function...", "function(){\n\n}", 5), buildItem("switch", 0, 0, 0, "switch...", "switch(){\n  case : \n\n  break;\n  case : \n\n  break;\ndefault: \n\n}", 5), buildItem("with", 0, 0, 0, "with...", "with(){\n\n}", 5), buildItem("return", 0, 0, 0, "return", "return ", 4), buildItem("break", 0, 0, 0, "break", "break;", 4), buildItem("continue", 0, 0, 0, "continue", "continue;", 4), buildItem("throw", 0, 0, 0, "throw", "throw ", 4), buildItem("new ", 0, 0, 0, "new", "new ", 4), buildItem("delete", 0, 0, 0, "delete", "delete ", 4), buildItem("arguments", 0, 0, 0, "arguments", "arguments", 4), buildItem("var", 0, 0, 0, "var", "var ", 4), buildItem("case", 0, 0, 0, "case", "case :", 4), buildItem("default", 0, 0, 0, "default", "default :", 4), buildItem("typeof", 0, 0, 0, "typeof", "typeof ", 4), buildItem("instanceof", 0, 0, 0, "instanceof", "instanceof ", 4), buildItem("void", 0, 0, 0, "void", "void", 4), buildItem("true", 0, 0, 0, "true", "true", 4), buildItem("false", 0, 0, 0, "false", "false", 4), buildItem("null", 0, 0, 0, "null", "null", 4), buildItem("NaN", 0, 0, 0, "NaN", "NaN", 4), buildItem("undefined", 0, 0, 0, "undefined", "undefined", 4), buildItem("Infinity", 0, 0, 0, "Infinity", "Infinity", 4), buildItem("decodeURI()", "function"), buildItem("decodeURIComponent()", "function"), buildItem("encodeURI()", "function"), buildItem("encodeURIComponent()", "function"), buildItem("escape()", "function"), buildItem("eval()", "function"), buildItem("isFinite()", "function"), buildItem("parseFloat()", "function"), buildItem("parseInt()", "function"), buildItem("unescape()", "function"), buildItem("Number()", "function"), buildItem("String()", "function")];
                break;
            case "new":
                list = [buildItem("String", "class", 0, 0, 0, "String();", 1), buildItem("Object", "class", 0, 0, 0, "Object();", 1), buildItem("Array", "class", 0, 0, 0, "Array();", 1), buildItem("RegExp", "class", 0, 0, 0, "RegExp();", 1), buildItem("Boolean", "class", 0, 0, 0, "Boolean();", 1), buildItem("Number", "class", 0, 0, 0, "Number();", 1), buildItem("Date", "class", 0, 0, 0, "Date();", 1), buildItem("xui.Dom", "class", 0, 0, 0, "xui.Dom();", 2), buildItem("xui.UIProfile", "class", 0, 0, 0, "xui.UIProfile();", 2), buildItem("xui.Com", "class", 0, 0, 0, "xui.Com();", 2), buildItem("xui.Template", "class", 0, 0, 0, "xui.Template();", 2), buildItem("xui.UI", "class", 0, 0, 0, "xui.UI();", 2), buildItem("xui.DataBinder", "class", 0, 0, 0, "xui.DataBinder();", 2)];
                for (var i in xui.UI) {
                    if (i != "upper" && xui.UI[i].$xui$) {
                        list.push(buildItem("xui.UI." + i, "class", 0, 0, 0, " xui.UI." + i + "();", 2))
                    }
                }
                break;
            case "history":
            case "screen":
                break;
            case "arguments":
                list = [buildItem("callee", "property", key), buildItem("length", "property", key)];
                break;
            case "arguments.callee":
                list = [buildItem("caller", "property", key), buildItem("length", "property", key), buildItem("call()", "function", key), buildItem("apply()", "function", key)];
                break;
            case "top":
            case "parent":
            case "window":
                var iframe = document.createElement("iframe");
                iframe.style.display = "none";
                document.body.appendChild(iframe);
                var target = frames[frames.length - 1];
                list = ns._enumKeys(target, key, false);
                document.body.removeChild(iframe);
                break;
            case "document":
                var iframe = document.createElement("iframe");
                iframe.style.display = "none";
                document.body.appendChild(iframe);
                var target = frames[frames.length - 1];
                list = ns._enumKeys(target.document, key, false);
                document.body.removeChild(iframe);
                break;
            case "Element.prototype":
                var iframe = document.createElement("iframe");
                iframe.style.display = "none";
                document.body.appendChild(iframe);
                var target = frames[frames.length - 1];
                target.document.write("<span>a</span>");
                list = ns._enumKeys(target.document.body.firstChild, key, false);
                document.body.removeChild(iframe);
                break;
            case "Math":
                list = [buildItem("E", "property", key), buildItem("LN2", "property", key), buildItem("LN10", "property", key), buildItem("LOG2E", "property", key), buildItem("LOG10E", "property", key), buildItem("PI", "property", key), buildItem("SQRT1_2", "property", key), buildItem("SQRT2", "property", key), buildItem("abs(x)", "function", key), buildItem("acos(x)", "function", key), buildItem("asin(x)", "function", key), buildItem("atan(x)", "function", key), buildItem("atan2(y,x)", "function", key), buildItem("ceil(x)", "function", key), buildItem("cos(x)", "function", key), buildItem("exp(x)", "function", key), buildItem("floor(x)", "function", key), buildItem("log(x)", "function", key), buildItem("max(x,y,z,...,n)", "function", key), buildItem("min(x,y,z,...,n)", "function", key), buildItem("pow(x,y)", "function", key), buildItem("random()", "function", key), buildItem("round(x)", "function", key), buildItem("sin(x)", "function", key), buildItem("sqrt(x)", "function", key), buildItem("tan(x)", "function", key)];
                break;
            case "Number":
                list = [buildItem("MAX_VALUE", "property", key), buildItem("MIN_VALUE", "property", key), buildItem("NEGATIVE_INFINITY", "property", key), buildItem("POSITIVE_INFINITY", "property", key)];
                break;
            case "Array.prototype":
                list = [buildItem("length", "property", key), buildItem("concat()", "function", key), buildItem("join()", "function", key), buildItem("pop()", "function", key), buildItem("push()", "function", key), buildItem("reverse()", "function", key), buildItem("shift()", "function", key), buildItem("sort()", "function", key), buildItem("concat()", "function", key), buildItem("splice()", "function", key), buildItem("toString()", "function", key), buildItem("unshift()", "function", key)];
                break;
            case "Date.prototype":
                list = [buildItem("getDate()", "function", key), buildItem("getDay()", "function", key), buildItem("getFullYear()", "function", key), buildItem("getHours()", "function", key), buildItem("getMilliseconds()", "function", key), buildItem("getMinutes()", "function", key), buildItem("getMonth()", "function", key), buildItem("getTime()", "function", key), buildItem("getSeconds()", "function", key), buildItem("getTimezoneOffset()", "function", key), buildItem("getUTCDate()", "function", key), buildItem("getUTCDay()", "function", key), buildItem("getUTCFullYear()", "function", key), buildItem("getUTCHours()", "function", key), buildItem("getUTCMilliseconds()", "function", key), buildItem("getUTCMinutes()", "function", key), buildItem("getUTCMonth()", "function", key), buildItem("getUTCSeconds()", "function", key), buildItem("getYear()", "function", key), buildItem("parse()", "function", key), buildItem("setDate()", "function", key), buildItem("setFullYear()", "function", key), buildItem("setHours()", "function", key), buildItem("setMilliseconds()", "function", key), buildItem("setMinutes()", "function", key), buildItem("setMonth()", "function", key), buildItem("setSeconds()", "function", key), buildItem("setTime()", "function", key), buildItem("setUTCDate()", "function", key), buildItem("setUTCFullYear()", "function", key), buildItem("setUTCHours()", "function", key), buildItem("setUTCMilliseconds()", "function", key), buildItem("setUTCMinutes()", "function", key), buildItem("setUTCSeconds()", "function", key), buildItem("setUTCMonth()", "function", key), buildItem("setYear()", "function", key), buildItem("toDateString()", "function", key), buildItem("toGMTString()", "function", key), buildItem("toLocaleDateString()", "function", key), buildItem("toLocaleTimeString()", "function", key), buildItem("toLocaleString()", "function", key), buildItem("toString()", "function", key), buildItem("toUTCString()", "function", key), buildItem("toTimeString()", "function", key), buildItem("UTC()", "function", key)];
                break;
            case "Number.prototype":
                list = [buildItem("toExponential()", "function", key), buildItem("toFixed()", "function", key), buildItem("toPrecision()", "function", key), buildItem("toString()", "function", key)];
                break;
            case "Boolean.prototype":
                list = [buildItem("toString()", "function", key)];
                break;
            case "Function.prototype":
                list = [buildItem("toString()", "function", key), buildItem("call()", "function", key), buildItem("apply()", "function", key)];
                break;
            case "RegExp.prototype":
                list = [buildItem("global", "property", key), buildItem("ignoreCase", "property", key), buildItem("multiline", "property", key), buildItem("lastIndex", "property", key), buildItem("source", "property", key), buildItem("compile()", "function", key), buildItem("exec()", "function", key), buildItem("test()", "function", key)];
                break;
            case "String.prototype":
                list = [buildItem("length", "property", key), buildItem("charAt()", "function", key), buildItem("charCodeAt()", "function", key), buildItem("concat()", "function", key), buildItem("fromCharCode()", "function", key), buildItem("indexOf()", "function", key), buildItem("lastIndexOf()", "function", key), buildItem("match()", "function", key), buildItem("replace()", "function", key), buildItem("search()", "function", key), buildItem("slice()", "function", key), buildItem("split()", "function", key), buildItem("substr()", "function", key), buildItem("substring()", "function", key), buildItem("toLowerCase()", "function", key), buildItem("toUpperCase()", "function", key)];
                break;
            case "Object.prototype":
                list = [buildItem("toString()", "function", key, 0, 0, 0, "z"), buildItem("toLocaleString()", "function", key, 0, 0, 0, "z"), buildItem("hasOwnProperty(key)", "function", key, 0, 0, 0, "z"), buildItem("propertyIsEnumerable(key)", "function", key, 0, 0, 0, "z"), buildItem("isPrototypeOf(obj)", "function", key, 0, 0, 0, "z")];
                break;
            default:
                if (/\.prototype$/.test(key)) {
                    try {
                        var target = eval("new " + key.replace(/\.prototype$/, ""));
                        list = ns._enumKeys(target, key)
                    } catch (e) {}
                }
                if (!list.length) {
                    var target = _.get(window, key.split("."));
                    list = ns._enumKeys(target, key);
                    cachedata = false
                }
            }
            if (cachedata) {
                cache[key] = list
            }
            return list
        },
        _getFromFunctionExp: function (code) {
            var type;
            if (/toString\([^)]*\)$/.test(code)) {
                type = "String.prototype"
            } else {
                if (/^\s*\(?\s*new\s+([\w_.]+)\s*\(?\s*[^)]*\)?\s*\)?(\s*\.\s*(set|on|before|after)[\w]+\s*\([^)]*\)\s*)*$/.test(code)) {
                    code = code.replace(/^\s*\(?\s*new\s+([\w_.]+)\s*\(?\s*[^)]*\)?\s*\)?(\s*\.\s*(set|on|before|after)[\w]+\s*\([^)]*\)\s*)*$/, "$1");
                    type = code + ".prototype"
                } else {
                    if (/.*\.reBoxing\(([^)]*)\)(\s*\.\s*(set|on|before|after)[\w]+\s*\([^)]*\)\s*)*$/.test(code)) {
                        code = code.replace(/.*\.reBoxing\(([^)]*)\)(\s*\.\s*(set|on|before|after)[\w]+\s*\([^)]*\)\s*)*$/, "$1");
                        if (code) {
                            type = code.replace(/[\'\"]/g, "") + ".prototype"
                        } else {
                            type = "xui.Dom.prototype"
                        }
                    } else {
                        if (code.indexOf("xui.alert(") == 0 || code.indexOf("xui.prompt(") == 0 || code.indexOf("xui.pop(") == 0 || code.indexOf("xui.confirm(") == 0) {
                            type = "xui.UI.Dialog.prototype"
                        } else {
                            if (code.indexOf("xui(") == 0 || code.indexOf("xui.use(") == 0) {
                                type = "xui.Dom.prototype"
                            } else {
                                if (code.indexOf("xui.Thread(") == 0 || code.indexOf("xui.Ajax(") == 0 || code.indexOf("xui.SAjax(") == 0 || code.indexOf("xui.IAjax(") == 0) {
                                    type = "xui.Thread.prototype"
                                } else {
                                    if (/.*\.(getRoot|getSubNode|getSubNodes)\s*\(\s*[^\)]*\)\s*$/.test(code)) {
                                        type = "xui.Dom.prototype"
                                    } else {
                                        if (/.*\.getElementById\s*\(\s*[^\)]*\)\s*$/.test(code)) {
                                            type = "Element.prototype"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return type
        },
        _getFromObject: function (target) {
            if (!_.isSet(target)) {
                return null
            } else {
                if (target.$xui$) {
                    if (typeof target == "function") {
                        return target.KEY
                    } else {
                        return target.KEY + ".prototype"
                    }
                } else {
                    if (_.isArr(target)) {
                        return "Array.prototype"
                    } else {
                        if (_.isDate(target)) {
                            return "Date.prototype"
                        } else {
                            if (_.isReg(target)) {
                                return "RegExp.prototype"
                            } else {
                                if (_.isNumb(target)) {
                                    return "Number.prototype"
                                } else {
                                    if (_.isStr(target)) {
                                        return "String.prototype"
                                    } else {
                                        if (_.isBool(target)) {
                                            return "Boolean.prototype"
                                        } else {
                                            if (_.isFun(target)) {
                                                return "Function.prototype"
                                            } else {
                                                if (_.isObj(target)) {
                                                    return "Object.prototype"
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        _findVars: function (profile, tonode, braceId) {
            var ns = this,
                cm = profile.$editor,
                arr = [];
            if (cm && tonode) {
                var doc = cm.win.document,
                    isBr = function (elem) {
                        return elem.tagName == "BR" || elem.tagName == "br"
                    },
                    isB = function (elem) {
                        return elem.tagName == "B" || elem.tagName == "b"
                    },
                    elem = doc.body.firstChild,
                    scope = "",
                    cls, txt, temp = [],
                    cursor;
                cursor = arr;
                cursor.push(["this", ""]);
                while ((elem = elem.nextSibling) && elem != tonode) {
                    if (isB(elem) && elem._uid && elem.id.charAt(0) == "b") {
                        if (!braceId || braceId.indexOf(elem.id) !== 0) {
                            elem = doc.getElementById("e" + elem.id.slice(1))
                        } else {
                            scope = elem._uid;
                            _.arr.each(temp, function (o) {
                                o[1] = scope
                            });
                            arr = arr.concat(temp)
                        }
                        temp = [];
                        cursor = arr
                    }
                    cls = __trim(elem.className);
                    txt = __trim(elem.currentText);
                    if (cls == "js-keyword" && txt == "function") {
                        while ((elem = elem.nextSibling) && elem != tonode && (isBr(elem) || __trim(elem.className) == "whitespace" || __trim(elem.className) == "js-comment")) {}
                        cls = __trim(elem.className);
                        txt = __trim(elem.currentText);
                        if (cls == "js-variabledef") {
                            cursor.push([txt, scope])
                        }
                        cursor = temp;
                        cursor.push(["this", scope])
                    }
                    if (cls == "js-variabledef") {
                        cursor.push([txt, scope])
                    }
                }
            }
            return arr
        },
        _getIntellisense: function (profile, key, index, nolist) {
            var ns = this,
                _this = RAD.ClassTool._this;
            if (key.indexOf("new ") == 0) {
                type = "new"
            } else {
                if (key.charAt(key.length - 1) == ".") {
                    type = "properties";
                    key = key.slice(0, -1)
                } else {
                    if (key.indexOf(".") != -1) {
                        type = "properties";
                        key = key.slice(0, key.lastIndexOf("."))
                    } else {
                        type = "var"
                    }
                }
            }
            if (type == "properties") {
                if (key.indexOf("(") != -1) {
                    type = "function"
                }
            }
            var target, code, list = [],
                otype, ocode, oextra = [];
            switch (type) {
            case "new":
                otype = type;
                break;
            case "function":
                type = ns._getFromFunctionExp(key);
                if (type) {
                    otype = type;
                    break
                }
            case "properties":
                if (key == "arguments" || key == "arguments.callee") {
                    otype = key;
                    break
                } else {
                    var arrcode = [],
                        code = profile.$cm.getValue(),
                        allcode = RAD.ClassTool.getContextAssignments(code, index),
                        struct = RAD.ClassTool.getClassStructWithScope(code, index, ns.$temppool, profile.$xid);
                    arrcode.push("var a=(function(){try{\n");
                    arrcode.push("var " + _this + "=window;\n");
                    var added1 = false,
                        added2 = false,
                        len = allcode.vars.length;
                    for (var i = 0; i < len; i++) {
                        arrcode.push("var " + allcode.vars[i] + "=undefined;\n")
                    }
                    for (var i = -1; i < len; i++) {
                        if (allcode.scopeS == -1 || i >= allcode.scopeS) {
                            if (!added1) {
                                added1 = true;
                                var o;
                                if (allcode.secondKey && allcode.secondType == "function") {
                                    o = _.get(struct, ["sub", allcode.firstKey, "sub", allcode.secondKey])
                                } else {
                                    if (allcode.firstKey && allcode.firstType == "function") {
                                        o = _.get(struct, ["sub", allcode.firstKey])
                                    }
                                }
                                if (o) {
                                    arrcode.push("try{" + _this + "=" + o._this + "}catch(e){};\n");
                                    _.arr.each(o.argsv, function (arg, i) {
                                        if (!o.args || !o.args[i]) {
                                            return false
                                        }
                                        if (arg.code) {
                                            arrcode.push("try{" + o.args[i] + "=" + arg.code + "}catch(e){};\n")
                                        } else {
                                            if (/\.prototype$/.test(arg.type)) {
                                                arrcode.push("try{" + o.args[i] + "=" + arg.type.replace(/(.+)(\.prototype)$/, "new $1();") + "}catch(e){};\n")
                                            } else {
                                                arrcode.push("try{" + o.args[i] + "=" + arg.type + "}catch(e){};\n")
                                            }
                                        }
                                    })
                                }
                            }
                        }
                        if (allcode.scopeS != -1 && i >= allcode.scopeE) {
                            if (!added2) {
                                added2 = true;
                                arrcode.push("try{" + _this + "=window;}catch(e){};\n")
                            }
                        }
                        if (i >= 0) {
                            arrcode.push("try{" + allcode.vars[i] + "=" + allcode.code[i] + ";}catch(e){};\n")
                        }
                    }
                    if (allcode.scopeS != -1 && allcode.outscope) {
                        if (!added2) {
                            arrcode.push("try{" + _this + "={};}catch(e){};\n")
                        }
                    }
                    arrcode.push("return (" + key + ");\n}catch(e){}\n}).call({});\n");
                    arrcode.push("a;");
                    ocode = arrcode.join("").replace(/\bthis\b/g, _this)
                }
                break;
            case "var":
                otype = " variables ";
                var hash, cache = ns.__varscache || (ns.__varscache = {});
                if (cache[index]) {
                    hash = cache[index]
                } else {
                    cache = ns.__varscache = {};
                    cache[index] = hash = RAD.ClassTool.getContextVars(profile.$cm.getValue(), index)
                }
                if (hash["this"]) {
                    oextra.push(ns._buildItem("this", 0, 0, 0, 0, 0, 1, "color:#ff0000;"));
                    delete hash["this"]
                }
                if (hash["arguments"]) {
                    oextra.push(ns._buildItem("arguments", 0, 0, 0, 0, 0, 1, "color:#ff0000;"));
                    delete hash["arguments"]
                }
                _.each(hash, function (o, i) {
                    oextra.push(ns._buildItem(i, "var", 0, 0, 0, 0, 1, "color:#666;"))
                });
                break
            }
            if (oextra && oextra.length) {
                if (!nolist) {
                    Array.prototype.push.apply(list, oextra)
                }
            }
            if (ocode) {
                result = ns.evalInSandbox(ocode, false, null, profile.$xid);
                if (_.isSet(result.ok)) {
                    if (result.type) {
                        otype = result.type
                    } else {
                        otype = ns._getFromObject(result.ok);
                        if (!nolist) {
                            Array.prototype.push.apply(list, ns._enumKeys(result.ok, otype, true, true))
                        }
                    }
                }
            }
            if (otype) {
                if (!nolist) {
                    Array.prototype.push.apply(list, ns._getIntellisenseList(otype))
                }
            }
            if (list.length) {
                list = _.arr.removeDuplicate(list, "id");
                list.sort(function (x, y) {
                    return x.tag > y.tag ? 1 : x.tag == y.tag ? 0 : -1
                })
            }
            return [otype, list, key]
        },
        _loadEditor: function (profile) {
            var ns = this,
                _this = RAD.ClassTool._this;
            var $suggestionShowed = false,
                $suggestionBaseScope = null,
                showSuggetionID = "CodeEditor.showSuggetion.resetRun",
                adjustSuggetionID = "CodeEditor.adjustSuggetion.resetRun",
                $currentText = "",
                $willshowDotHint = false,
                $activeWord;
            var getShortContentCode = function (index) {
                    var reg = /\s+/g,
                        arr = [],
                        extxt = "",
                        cm = profile.$cm,
                        pos = cm.doc.posFromIndex(index),
                        line = pos.line,
                        elem = cm.getTokenAt(pos),
                        prev = function (elem) {
                            if (elem.start === 0) {
                                pos.line--;
                                if (pos.line === 0) {
                                    return null
                                }
                                pos.ch = cm.doc.getLine(pos.line).length
                            } else {
                                pos.ch = elem.start
                            }
                            return cm.getTokenAt(pos)
                        };
                    if (!(elem.type === null && elem.string == ".")) {
                        extxt = __trim(elem.string);
                        elem = prev(elem)
                    }
                    if (elem && (elem.type === null && elem.string == ".")) {
                        do {
                            if (elem.type === null && elem.string == ".") {
                                while (elem = prev(elem)) {
                                    if (!(!elem || elem.type == "comment" || elem.type == "tab" || (elem.type === null && /^\s+$/.test(elem.string)))) {
                                        break
                                    }
                                }
                                if (elem) {
                                    var con1 = "";
                                    if (elem.type === null && elem.string === ")") {
                                        var deep1 = 0;
                                        do {
                                            if (elem.type === null && elem.string === ")") {
                                                deep1++
                                            }
                                            if (elem.type === null && elem.string === "(") {
                                                deep1--
                                            }
                                            if (elem.string) {
                                                con1 = elem.string + con1
                                            }
                                        } while ((elem = prev(elem)) && deep1 !== 0)
                                    }
                                    if (elem) {
                                        if (elem.type == "property" || elem.type == "variable" || elem.type == "variable-2" || elem.type == "xuiglobal" || (elem.type == "keyword" && elem.string == "this")) {
                                            arr.push(elem.string.replace(reg, "") + con1)
                                        } else {
                                            if (con1) {
                                                arr.push(con1)
                                            } else {
                                                break
                                            }
                                        }
                                    }
                                }
                            } else {
                                break
                            }
                        } while (elem = prev(elem))
                    } else {
                        if (elem && (elem.type == null && elem.string === " ")) {
                            while (elem = prev(elem)) {
                                if (!(!elem || elem.type == "comment" || (elem.type == null && elem.string === " "))) {
                                    break
                                }
                            }
                            if (elem.type == "keyword" && elem.string == "new") {
                                extxt = "new " + extxt
                            }
                        }
                    }
                    return (arr.length ? (arr.reverse().join(".") + ".") : "") + extxt
                };
            var iniComponents = function () {
                    var host = this,
                        children = [],
                        append = function (child) {
                            children.push(child.get(0))
                        };
                    append((new xui.UI.Pane).setHost(host, "$popList").setLeft(10).setTop(10).setWidth(300).setHeight(180));
                    host.$popList.append((new xui.UI.List).setHost(host, "$lstsug").setTheme("codemirror").setDirtyMark(false).setTop(18).setWidth(300).setHeight(162).setDisableHoverEffect(true));
                    host.$popList.append((new xui.UI.Block).setHost(host, "block1").setLeft(0).setTop(0).setWidth(300).setHeight(20).setBorderType("flat"));
                    host.block1.append((new xui.UI.SLabel).setHost(host, "$objType").setLeft(6).setTop(2).setWidth(252).setCaption("").setHAlign("left").setCustomStyle({
                        KEY: "font-weight:bold;"
                    }));
                    append((new xui.UI.Block).setHost(host, "$popHelp").setLeft(410).setTop(10).setWidth(300).setHeight(180).setBorderType("flat").setBackground("#FFF8DC"));
                    host.$popHelp.append((new xui.UI.Div).setHost(host, "$divhelp").setTheme("codemirror").setLeft(-1).setTop(19).setWidth(292).setHeight(152).setCustomStyle({
                        KEY: "overflow:auto; padding:4px;"
                    }));
                    host.$popHelp.append((new xui.UI.Block).setHost(host, "block3").setLeft(-1).setTop(-1).setWidth(300).setHeight(20).setBorderType("flat"));
                    host.block3.append((new xui.UI.Link).setHost(host, "$linkAPI").setLeft("auto").setRight(2).setTop(1).setCaption("$RAD.JSEditor.clickapi"));
                    host.block3.append((new xui.UI.SLabel).setHost(host, "$lblTips").setLeft(6).setTop(2).setWidth(133).setCaption("").setHAlign("left"));
                    return children
                };
            var handle = {
                moveFocus: function (step) {
                    var list = profile.$lstsug,
                        items = list.get(0).properties.items,
                        length = items.length,
                        value = list.getUIValue(),
                        index = _.arr.subIndexOf(items, "id", value);
                    if (step === true) {
                        index = 0
                    } else {
                        if (step === false) {
                            index = length - 1
                        } else {
                            index += step;
                            if (index < 0) {
                                index = 0
                            }
                            if (index > length - 1) {
                                index = length - 1
                            }
                        }
                    }
                    if (items[index]) {
                        list.setUIValue(items[index].id, true)
                    }
                },
                close: function () {
                    hideSuggestion()
                },
                pick: function () {
                    var list = profile.$lstsug,
                        items = list.get(0).properties.items,
                        length = items.length,
                        value = list.getUIValue(),
                        index = _.arr.subIndexOf(items, "id", value);
                    if (items[index]) {
                        applySuggestion(items[index].value || items[index].caption)
                    }
                    hideSuggestion()
                }
            };
            var keyMap = {
                Up: function () {
                    handle.moveFocus(-1)
                },
                Down: function () {
                    handle.moveFocus(1)
                },
                PageUp: function () {
                    handle.moveFocus(-8, true)
                },
                PageDown: function () {
                    handle.moveFocus(8, true)
                },
                Home: function () {
                    handle.moveFocus(true)
                },
                End: function () {
                    handle.moveFocus(false)
                },
                Enter: function () {
                    handle.pick()
                },
                Tab: function () {
                    handle.pick()
                },
                Esc: function () {
                    handle.close()
                }
            };
            var showSuggestion = function (key, index, fromDot, dftTxt) {
                    var rtn = profile.box._getIntellisense(profile, key, index),
                        keyword = rtn[0],
                        items = rtn[1];
                    if (!keyword && !(items && items.length)) {
                        hideSuggestion();
                        return
                    }
                    var coordinates = cm.cursorCoords(true, "page"),
                        left = coordinates.left,
                        top = coordinates.top;
                    if (!profile.$popList) {
                        iniComponents.call(profile);
                        xui("body").append(profile.$popList.setDisplay("none"));
                        xui("body").append(profile.$popHelp.setDisplay("none"));
                        profile.$divhelp.getRoot().setSelectable(true);
                        profile.$linkAPI.onClick(function (p) {
                            CONF.openAPI(p.properties.tag)
                        });
                        var out = true,
                            tryToClose = function () {
                                _.resetRun("codemirror:aaa", function () {
                                    if (out && profile.$popCustom) {
                                        profile.$popCustom.setDisplay("none")
                                    }
                                })
                            };
                        profile.$lstsug.afterUIValueSet(function (profile, ov, v) {
                            showTips2(profile.getItemByItemId(v))
                        }).onClick(function (profile, item) {
                            applySuggestion(item.value || item.caption);
                            hideSuggestion()
                        })
                    }
                    if ((items && items.length) || fromDot) {
                        $suggestionShowed = fromDot ? 1 : true;
                        if (items && items.length) {
                            profile.$lstsug.setItems(items)
                        }
                        var fun = function () {
                                hideSuggestion()
                            },
                            group = xui([profile.$popList.getRootNode(), profile.$popHelp.getRootNode(), profile.getSubNode("BOX").get(0)]);
                        profile.$popList.getRoot().popToTop({
                            region: {
                                left: left,
                                top: top,
                                width: 2,
                                height: 16
                            }
                        }, 1).setBlurTrigger(showSuggetionID, fun, group);
                        xui.Event.keyboardHook("esc", 0, 0, 0, fun);
                        profile.$popList.setDisplay("");
                        $activeWord = rtn[2] || null;
                        if (items && items.length) {
                            adjustSuggetion(left, top, dftTxt || key, "", true, true)
                        }
                    }
                    profile.$objType.setCaption(keyword || "none");
                    profile.$cm.removeKeyMap(keyMap);
                    profile.$cm.addKeyMap(keyMap)
                };
            var hideSuggestion = function () {
                    xui.Event.keyboardHook("esc", 0, 0, 0);
                    profile.$cm.removeKeyMap(keyMap);
                    _.resetRun(showSuggetionID);
                    _.resetRun(adjustSuggetionID);
                    $suggestionBaseScope = null;
                    $suggestionShowed = false;
                    $willshowDotHint = false;
                    if (profile.$popList) {
                        profile.$objType.setCaption("");
                        profile.$lstsug.setItems([]).setUIValue(null);
                        profile.$popList.setDisplay("none");
                        profile.$lblTips.setCaption("");
                        profile.$divhelp.setHtml("");
                        profile.$popHelp.setDisplay("none");
                        if (profile.$popCustom) {
                            profile.$popCustom.setDisplay("none")
                        }
                        $currentText = null
                    }
                };
            var adjustSuggetion = function (left, top, txt, extxt, forVisibleOnly, asnyc) {
                    if (!profile.$lstsug) {
                        return
                    }
                    var prf = profile.$lstsug.get(0),
                        items = prf.properties.items,
                        f = function () {
                            if (forVisibleOnly && !$suggestionShowed) {
                                return
                            }
                            var fid;
                            if (extxt) {
                                txt += extxt
                            }
                            if (!_.isSet($currentText) || txt !== $currentText) {
                                $currentText = txt;
                                _.arr.each(items, function (item) {
                                    if (_.str.startWith(item.id.toLowerCase(), $currentText.toLowerCase())) {
                                        fid = item.id;
                                        return false
                                    }
                                })
                            }
                            if (!prf.properties.$UIvalue && !fid && prf.properties.items && prf.properties.items.length) {
                                fid = prf.properties.items[0].id
                            }
                            if (fid) {
                                prf.boxing().setUIValue(fid)
                            }
                            profile.$popList.getRoot().popToTop({
                                region: {
                                    left: left,
                                    top: top,
                                    width: 2,
                                    height: 16
                                }
                            }, 1);
                            if (profile.$popHelp && profile.$popHelp.getDisplay() != "none") {
                                profile.$popHelp.getRoot().popToTop(profile.$popList.getRoot(), 2)
                            }
                        };
                    if (!asnyc) {
                        f()
                    } else {
                        _.resetRun(adjustSuggetionID, f, 100)
                    }
                };
            var showTips = function (key, str) {
                    if (!profile.$popHelp) {
                        return
                    }
                    if (profile.$popList.getDisplay() != "none") {
                        profile.$linkAPI.setTag(key);
                        profile.$lblTips.setCaption(key);
                        profile.$divhelp.setHtml(str);
                        profile.$popHelp.getRoot().popToTop(profile.$popList.getRoot(), 2);
                        profile.$popHelp.setDisplay("")
                    }
                };
            var hideTips = function (key, str) {
                    if (!profile.$popHelp) {
                        return
                    }
                    profile.$linkAPI.setTag(null);
                    profile.$lblTips.setCaption("");
                    profile.$divhelp.setHtml("");
                    profile.$popHelp.setDisplay("none")
                };
            var showTips1 = function (elem) {
                    if (!profile.$popHelp) {
                        return
                    }
                    var key = getShortContentCode(elem);
                    var str = profile.onGetHelpInfo && profile.boxing().onGetHelpInfo(profile, key.key);
                    if (str) {
                        showTips(key.key, str)
                    } else {
                        hideTips()
                    }
                };
            var showTips2 = function (item) {
                    if (!profile.$popHelp) {
                        return
                    }
                    if (!item) {
                        return
                    }
                    var str = profile.onGetHelpInfo && profile.boxing().onGetHelpInfo(profile, item.path);
                    if (str) {
                        showTips(item.path, str)
                    } else {
                        hideTips()
                    }
                };
            var showDotHint = function (index, scope, dftTxt) {
                    $suggestionBaseScope = null;
                    hideSuggestion();
                    $willshowDotHint = true;
                    _.resetRun(showSuggetionID, function () {
                        var key = getShortContentCode(index);
                        if (!key) {
                            hideSuggestion()
                        } else {
                            $willshowDotHint = false;
                            if (key != dftTxt) {
                                showSuggestion(key, index, true, dftTxt)
                            }
                        }
                    }, 100);
                    $suggestionBaseScope = scope
                };
            var showVarsHint = function (key, index, scope) {
                    _.resetRun(showSuggetionID, function () {
                        showSuggestion(key, index)
                    });
                    $suggestionBaseScope = scope
                };
            var tryToAdjustHint = function (key, index, scope) {
                    var sc = $suggestionBaseScope;
                    if (sc && sc.line == scope.line && sc.start == scope.start) {
                        var coordinates = cm.cursorCoords(true, "page"),
                            left = coordinates.left,
                            top = coordinates.top;
                        adjustSuggetion(left, top, key, "", true)
                    }
                    $suggestionBaseScope = scope
                };
            var applySuggestion = function (value) {
                    var editor = profile.$cm,
                        o = $suggestionBaseScope;
                    editor.replaceRange(value, {
                        line: o.line,
                        ch: o.start
                    }, {
                        line: o.line,
                        ch: o.end
                    });
                    var line = o.line,
                        hasE;
                    value.replace(/\n/g, function () {
                        editor.indentLine(++line);
                        hasE = 1
                    });
                    editor.setCursor({
                        line: o.line + (hasE ? 1 : 0),
                        ch: o.start + value.length
                    })
                };
            var codeType = profile.properties.codeType,
                modekey, cmmode = codeType == "js" ? {
                    name: modekey = "javascript",
                    json: profile.properties.json
                } : codeType == "json" ? {
                    name: modekey = "javascript",
                    json: true
                } : codeType == "css" ? {
                    name: modekey = "css"
                } : codeType == "php" ? {
                    name: modekey = "php"
                } : codeType == "xml" ? {
                    name: modekey = "xml"
                } : codeType == "css" ? {
                    name: modekey = "css"
                } : codeType == "html" ? {
                    name: modekey = "htmlmixed"
                } : null;
            if (!cmmode) {
                var i = _.arr.subIndexOf(CodeMirror.modeInfo, "name", codeType);
                if (i != -1) {
                    cmmode = {
                        name: modekey = CodeMirror.modeInfo.mode
                    }
                } else {
                    cmmode = modekey = null
                }
            }
            var options = {
                value: profile.properties.value || "",
                smartIndent: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                mode: cmmode,
                matchBrackets: true,
                continueComments: "Enter",
                autoCloseBrackets: true,
                lineNumbers: true,
                lint: (codeType == "js" || codeType == "json" || codeType == "css") ? true : false,
                readOnly: profile.properties.readonly,
                styleActiveLine: true,
                lineWrapping: true,
                flattenSpans: false,
                highlightSelectionMatches: {
                    showToken: /^[$\w]\w*/
                },
                foldGutter: (codeType == "js" || codeType == "json") ? {
                    rangeFinder: new CodeMirror.fold.combine(CodeMirror.fold.brace, CodeMirror.fold.comment)
                } : true,
                gutters: ["CodeMirror-lint-markers", "CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-Q": function (cm) {
                        cm.foldCode(cm.getCursor())
                    },
                    "Ctrl-S": function () {
                        if (profile.onSaveCommand) {
                            profile.boxing().onSaveCommand(profile)
                        }
                    },
                    "Ctrl-F": function () {
                        RAD.EditorTool.showFindWnd(profile.boxing(), {
                            left: 200,
                            top: 100
                        })
                    },
                    Tab: function (cm) {
                        if (cm.doc.somethingSelected()) {
                            return CodeMirror.Pass
                        }
                        var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
                        cm.replaceSelection(spaces, "end", "+input")
                    }
                }
            };
            var obj = CONF.serviceType == "node-webkit" ? NW.getStatus() : CONF,
                editorTheme = obj.editorTheme,
                editorFontSize = obj.editorFontSize;
            if (editorTheme) {
                profile.boxing().addCMTheme(editorTheme);
                options.theme = editorTheme
            }
            var cm = profile.$cm = new CodeMirror(function (elt) {
                profile.getSubNode("BOX").append(elt);
                if (editorFontSize) {
                    elt.style.fontSize = editorFontSize + "px"
                }
            }, options);
            CodeMirror.modeURL = "codemirror3/mode/%N/%N.js";
            if (modekey) {
                CodeMirror.autoLoadMode(cm, modekey)
            } else {
                var callback = function (mode) {
                        if (!mode || mode === "none") {
                            if (!profile.$initialized) {
                                profile.$initialized = true
                            }
                            if (profile.onRendered) {
                                profile.boxing().onRendered(profile, true)
                            }
                        } else {
                            cm.setOption("mode", mode);
                            CodeMirror.autoLoadMode(cm, mode)
                        }
                    };
                xui.ComFactory.newCom("RAD.SelRenderMode", function () {
                    this.setEvents("onSel", callback);
                    this.mainDlg.showModal()
                })
            }
            cm.on("rendered", function (cm, finished) {
                if (!profile.$initialized) {
                    profile.$initialized = true
                }
                if (profile.onRendered) {
                    profile.boxing().onRendered(profile, finished)
                }
            });
            cm.on("change", function (cm, obj) {
                if (profile.$initialized && profile.onValueChanged) {
                    profile.boxing().onValueChanged(profile)
                }
                if (codeType != "js" && codeType != "html") {
                    return
                }
                var handled;
                if (obj.origin == "+input") {
                    if (obj.text[0] == ".") {
                        if (codeType != "js") {
                            return
                        }
                        obj.to.ch++;
                        var token = cm.getTokenAt(obj.to),
                            type = token.type;
                        var pos = cm.getCursor();
                        if (type !== null) {
                            return
                        }
                        showDotHint(cm.doc.indexFromPos(pos), {
                            start: ++token.start,
                            end: ++token.end,
                            line: pos.line
                        });
                        handled = true
                    } else {
                        if (obj.text[0] !== " ") {
                            obj.to.ch++;
                            var token = cm.getTokenAt(obj.to),
                                type = token.type;
                            if (type == "variable" || type == "variable-2" || type == "keyword" || (type == "property" && $suggestionShowed === 1)) {
                                var pos = cm.getCursor();
                                if (pos.line == obj.to.line && pos.ch >= token.start && pos.ch <= token.end) {
                                    if ($suggestionShowed) {
                                        tryToAdjustHint(token.string, cm.doc.indexFromPos(pos), {
                                            start: token.start,
                                            end: token.end,
                                            line: pos.line
                                        })
                                    } else {
                                        showVarsHint(token.string, cm.doc.indexFromPos(pos), {
                                            start: token.start,
                                            end: token.end,
                                            line: pos.line
                                        })
                                    }
                                    handled = true
                                }
                            }
                        }
                    }
                } else {
                    if (obj.origin == "+delete") {
                        if ($suggestionShowed) {
                            var token = cm.getTokenAt(obj.to),
                                type = token.type,
                                str = token.string;
                            if ($suggestionShowed === true) {
                                if (type == "variable" || type == "variable-2" || type == "keyword") {
                                    var pos = cm.getCursor();
                                    if (pos.line == obj.to.line && pos.ch >= token.start && pos.ch <= token.end) {
                                        tryToAdjustHint(token.string, cm.doc.indexFromPos(pos), {
                                            start: token.start,
                                            end: token.end,
                                            line: pos.line
                                        });
                                        handled = true
                                    }
                                }
                            } else {
                                if ($suggestionShowed === 1) {
                                    if (type == "property") {
                                        var pos = cm.getCursor();
                                        tryToAdjustHint(token.string, cm.doc.indexFromPos(pos), {
                                            start: token.start,
                                            end: token.end,
                                            line: pos.line
                                        });
                                        handled = true
                                    } else {
                                        if (type === null && str == ".") {
                                            var pos = cm.getCursor();
                                            showDotHint(cm.doc.indexFromPos(pos), {
                                                start: ++token.start,
                                                end: ++token.end,
                                                line: pos.line
                                            });
                                            handled = true
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (!handled) {
                    hideSuggestion()
                }
            });
            cm.on("blur", function () {});
            cm.on("keypress", function (cm, key) {
                if (codeType != "js" && codeType != "html") {
                    return
                }
                if ($willshowDotHint && xui.Event.getKey(key)[0] != ".") {
                    hideSuggestion()
                }
            });
            cm.on("keydown", function (cm, key) {
                if (codeType != "js" && codeType != "html") {
                    return
                }
                if ($willshowDotHint && xui.Event.getKey(key)[0] != ".") {
                    hideSuggestion()
                }
            });
            cm.on("cursorActivity", function (cm) {
                if (!cm.hasFocus()) {
                    return
                }
                if (codeType != "js" && codeType != "html") {
                    return
                }
                if ($suggestionBaseScope) {
                    var pos = cm.getCursor(),
                        scope = $suggestionBaseScope;
                    if (pos.line !== scope.line || pos.ch < scope.start || pos.ch > scope.end) {
                        hideSuggestion()
                    }
                }
                _.resetRun("cm_showtips", function () {
                    var state = cm.state.matchHighlighter;
                    if (state.overlay && state.style == "matchhighlight" && cm.doc.somethingSelected()) {
                        var cur = cm.getCursor(),
                            sel = cm.doc.getSelection(),
                            token = cm.getTokenAt(cur);
                        if (sel === token.string) {
                            showDotHint(cm.doc.indexFromPos(cur), {
                                start: token.start,
                                end: token.end,
                                line: cur.line
                            }, token.string)
                        }
                    }
                }, 200)
            })
        },
        _onresize: function (profile, width, height) {
            var size = arguments.callee.upper.apply(this, arguments);
            profile.getSubNode("BOX").cssSize(size);
            if (profile.$cm) {
                profile.$cm.setSize(size.width, size.height)
            }
        }
    }
});
Class("RAD.PageEditor", "xui.Com", {
    Instance: {
        __json: false,
        setJSON: function (v) {
            this.__json = !! v
        },
        Initialize: function () {
            var ns = this;
            ns._ovalue = "";
            ns._dirty = false
        },
        resetEditorStyle: function (theme, fs) {
            this.codeeditor.resetEditorStyle(theme, fs)
        },
        setType: function (type) {
            this.codeeditor.setCodeType(type)
        },
        activate: function () {
            this.codeeditor.activate()
        },
        getValue: function () {
            var ns = this;
            return ns._dirty ? (ns._ovalue = ns.codeeditor.getUIValue()) : ns._ovalue
        },
        setValue: function (value) {
            value = (value || "").replace(/\t/g, "    ").replace(/\u00a0/g, " ").replace(/\r\n?/g, "\n");
            var ns = this;
            if (ns._ovalue != value) {
                ns._ovalue = value;
                ns._dirty = false;
                ns._codeeditor_onrender(null, false);
                if (ns.codeeditor) {
                    ns.codeeditor.setValue(ns._ovalue)
                }
            }
            return ns
        },
        iniComponents: function (com, threadid) {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.ToolBar).setHost(host, "toolbar4").setItems([{
                id: "fun",
                sub: [{
                    id: "searchreplace",
                    caption: "$RAD.pageEditor.searchreplace",
                    image: "@CONF.img_app",
                    imagePos: "-240px -48px",
                    type: "button",
                    tips: "$RAD.pageEditor.replacetips"
                }, {
                    id: "jumpto",
                    caption: "$RAD.pageEditor.jumpto",
                    image: "@CONF.img_app",
                    imagePos: "-160px -48px",
                    type: "button",
                    tips: "$RAD.pageEditor.jumptotips"
                }, {
                    id: "indentall",
                    caption: "$RAD.pageEditor.indentall",
                    image: "@CONF.img_app",
                    imagePos: "-224px -48px",
                    type: "button",
                    tips: "$RAD.pageEditor.indentalltips"
                }, {
                    id: "progress",
                    object: (new xui.UI.Image({
                        src: xui.getPath("img/", "progress.gif")
                    })).setHost(host, "imgProgress")
                }]
            }]).onClick("_toolbar_onclick"));
            append((new RAD.CodeEditor).setHost(host, "codeeditor").setDock("fill").setValue(host._ovalue || "").onValueChanged("_codeeditor_onChange").onSaveCommand("_codeeditor_onsave").onGetHelpInfo("_codeeditor_ongett").onRendered("_codeeditor_onrender"));
            return children
        },
        events: {
            onReady: "_onready"
        },
        _onready: function (com) {
            com.codeeditor.setJson(com.__json)
        },
        _codeeditor_onrender: function (profile, finished) {
            var ns = this;
            if (!ns.codeeditor) {
                return
            }
            var id = ns.KEY + ":" + ns.$xid + ":progress";
            if (finished) {
                _.resetRun(id);
                ns.toolbar4.setDisabled(false);
                ns.codeeditor.setReadonly(false);
                ns.imgProgress.setDisplay("none");
                if (!ns.$initializd) {
                    ns.$initializd = true;
                    ns.fireEvent("afterRendered")
                }
            } else {
                _.resetRun(id, function () {
                    ns.toolbar4.setDisabled(true);
                    ns.codeeditor.setReadonly(true);
                    ns.imgProgress.setDisplay("")
                })
            }
        },
        _codeeditor_ongett: function (profile, key) {
            _.asyRun(function () {
                xui.Coder.applyById("doc:code", true)
            });
            return RAD.EditorTool.getDoc(key)
        },
        _codeeditor_onChange: function (profile) {
            this._dirty = true;
            this.fireEvent("onValueChanged", [this, true])
        },
        _codeeditor_onsave: function (profile) {
            var ns = this;
            ns.fireEvent("onCommandSave", [ns])
        },
        _toolbar_onclick: function (profile, item, grp, e, src) {
            var ns = this,
                eidtor = this.codeeditor,
                pos = xui.use(src).offset();
            switch (item.id) {
            case "indentall":
                eidtor.reindent();
                break;
            case "searchreplace":
                RAD.EditorTool.showFindWnd(eidtor, pos);
                break;
            case "jumpto":
                RAD.EditorTool.showJumpToWnd(eidtor, pos);
                break;
                break
            }
        }
    }
});
Class("RAD.ClassTool", null, {
    Static: {
        _this: "____this____",
        getClassName: function (str) {
            var reg1 = /^(\s*\/\*[^*@]*\*+([^\/][^*]*\*+)*\/\s*)|^(\s*\/\/[^\n]*\s*)/,
                reg12 = /(\s*\/\*[^*@]*\*+([^\/][^*]*\*+)*\/\s*)$|(\s*\/\/[^\n]*\s*)$/,
                reg2 = /(\{([^\{\}]*)\})|(\[([^\[\]]*)\])/,
                reg3 = /\s*(((function\s*([\w$]+\s*)?\(\s*([\w$\s,]*)\s*\)\s*)?(\{([^\{\}]*)\}))|(\[([^\[\]]*)\]))/g,
                reg4 = /^[\xEF\xBB\xBF\uFEFF\s]*Class\s*\(\s*(([\']([^\']+)[\'])|([\"]([^\"]+)[\"]))\s*\,\s*(([\']([^\']*)[\'])|([\"]([^\"]*)[\"])|(null)|(undefined))\s*\,1\s*\)\s*;?\s*$/,
                reg5 = /^[\xEF\xBB\xBF\uFEFF\s]*Class\s*\(/,
                reg6 = /^[a-zA-Z]+[\w\.]*[\w]+$/,
                reg7 = /^\"[a-zA-Z]+[\w\.]*[\w]*\"$/,
                reg8 = /^\'[a-zA-Z]+[\w\.]*[\w]*\'$/;
            while (reg1.test(str)) {
                str = str.replace(reg1, "")
            }
            while (reg12.test(str)) {
                str = str.replace(reg12, "")
            }
            var arr = [
                [/"(\\.|[^"\\\n])*"/, function (a) {
                    return reg7.test(a[0]) ? a[0] : '""'
                }],
                [/'(\\.|[^'\\\n])*'/, function (a) {
                    return reg8.test(a[0]) ? a[0] : "''"
                }],
                [/\/(\\[\/\\]|[^*\/])(\\.|[^\/\n\\])*\/[gim]*/, "null"],
                [/\/\*[^*]*\*+([^\/][^*]*\*+)*\//, ""],
                [/\/\/[^\n]*/, ""]
            ];
            str = linb.Coder.replace(str, arr);
            if (!reg5.test(str)) {
                return false
            }
            while (reg2.test(str)) {
                str = str.replace(reg3, "1")
            }
            if (reg4.test(str)) {
                str = str.replace(reg4, "$1").replace(/[\'\"]/g, "")
            } else {
                return false
            }
            if (reg6.test(str)) {
                return str
            } else {
                return false
            }
        },
        isJson: function (txt) {
            var reg = new RegExp("^(\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*)|^(\\s*\\/\\/[^\\n]*\\s*)");
            while (reg.test(txt)) {
                txt = txt.replace(reg, "")
            }
            return /^\s*(\{|\[|function)/.test(txt)
        },
        getClassObject: function (str) {
            str = str.slice(str.indexOf("{") + 1, str.lastIndexOf("}"));
            var obj = eval("({" + str + "})");
            return obj
        },
        getCodeFromStruct: function (o, sublayer) {
            try {
                var self = arguments.callee,
                    arr = [];
                if (o) {
                    if (o.sub) {
                        if (o.frame) {
                            _.each(o.sub, function (o, i) {
                                if (!_.isNull(o.comments)) {
                                    arr.push((o.comments || "") + i + ":" + (o.code ? o.code : o.sub ? self.call(this, o, true) : ""))
                                }
                            }, this);
                            return (sublayer ? "" : (o.comments || "")) + o.frame.replace("*1", o.name || "").replace("*2", o.pname || "").replace("*3", arr.join(", ").replace(/\$/g, "\x01")).replace(/\x01/g, "$")
                        } else {
                            return ""
                        }
                    } else {
                        return (o.code || "").replace(/^[\r\n]*/, "")
                    }
                } else {
                    return ""
                }
            } catch (e) {
                xui.message(xui.getRes("RAD.classtool.err2")) + ":" + String(e);
                return false
            }
        },
        parseSingleBlock: function (txt) {
            try {
                var reg1 = new RegExp("^(\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*)|^(\\s*\\/\\/[^\\n]*\\s*)"),
                    reg2 = new RegExp("(\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*)|^(\\s*\\/\\/[^\\n]*\\s*)$"),
                    str, comments, code;
                while (reg2.test(txt)) {
                    txt = txt.replace(reg2, "")
                }
                str = txt;
                while (reg1.test(str)) {
                    str = str.replace(reg1, "")
                }
                str = str.replace(/\s*/, "");
                if (!str) {
                    return {
                        comments: null,
                        code: null
                    }
                }
                comments = "\n" + txt.replace(str, "");
                code = str.replace(/\s*$/, "");
                str = xui.Coder.replace(str, [
                    ["(^|\\n)\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*", ""],
                    ["\\n\\s*\\/\\/[^\\n]*\\s*", ""],
                    [/([^\w\x24\/\'\"*)\]\?:]\s*)(\/(\\[\/\\]|[^*\/])(\\.|[^\/\n\\])*\/[gim]*)\s*([\)\}\]:,;\r\n])/.source, function (arg, i) {
                        return str[i + 1] + str[i + 5]
                    }]
                ]);
                code = code.replace(/([}\]])[^}\]]*$/, "$1");
                str = xui.Coder.replace(code, [
                    ["null|undefined|NaN", ""],
                    [/\/(\\[\/\\]|[^*\/])(\\.|[^\/\n\\])*\/[gim]*/, ""],
                    [/-?(\d*\.?\d+|\d+\.?\d*)([eE][+-]?\d+|%)?\b/, ""],
                    ["'(\\\\.|[^'\\\\])*'", ""],
                    ['"(\\\\.|[^"\\\\])*"', ""]
                ]);
                while (/(\{([^\{\}]*)\})|(\[([^\[\]]*)\])/.test(str)) {
                    str = str.replace(/\s*(((function\s*([\w$]+\s*)?\(\s*([\w$\s,]*)\s*\)\s*)?(\{([^\{\}]*)\}))|(\[([^\[\]]*)\]))/g, "")
                }
                if (_.str.trim(str) != "") {
                    return false
                }
                return {
                    comments: comments,
                    code: code
                }
            } catch (e) {
                xui.message(xui.getRes("RAD.classtool.err3") + ":" + String(e));
                return false
            }
        },
        getClassStruct: function (str) {
            try {
                str = xui.Coder.replace(str, [
                    [/(\r\n|\r)/g, "\n"],
                    [/( +)(\n)/g, "$2"],
                    [/\t/g, "    "]
                ]);
                var t, index = 1,
                    index1 = 1,
                    cache = {},
                    cache1 = {},
                    result, result2, code = function (str, i) {
                        var ret = "#" + (index++) + "#";
                        cache[ret] = str[0];
                        return ret
                    },
                    _code = function (str, i) {
                        var ret = "#" + (index++) + "#";
                        cache[ret] = str[i + 2];
                        return str[i + 1] + ret + str[i + 5]
                    },
                    code1 = function (str) {
                        var ret = "`" + (index1++);
                        cache1[ret] = str[0];
                        return ret
                    },
                    restore = function (str) {
                        return str.replace(/#(\d+)#/g, function (m) {
                            return cache[m]
                        })
                    },
                    restore1 = function (str) {
                        return str.replace(/`(\d+)/g, function (m) {
                            return cache1[m]
                        })
                    };
                str = xui.Coder.replace(str, [
                    ["(^|\\n)\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/[^\\n]*", code],
                    ["(^|\\n)\\s*\\/\\/[^\\n]*", code],
                    [/([^\w\x24\/\'\"*)\]\?:]\s*)(\/(\\[\/\\]|[^*\/])(\\.|[^\/\n\\])*\/[gim]*)\s*([\)\}\]:,;\r\n])/g.source, _code]
                ]);
                str = xui.Coder.replace(str, [
                    ["'(\\\\.|[^'\\\\])*'", code1],
                    ['"(\\\\.|[^"\\\\])*"', code1]
                ]);
                var frame = str.replace(/(^[^{]*\{)\s*((.|[\r\n])*)([^\s])(\s*}[^}]*$)/, "$1*3$5").replace(/(#\d+#)+/g, ""),
                    o = {
                        sub: {}
                    };
                if (t = str.match(/^((#\d+#)+)/)) {
                    o.comments = restore(t[0])
                } else {
                    o.comments = ""
                }
                o.name = restore1(cache1["`1"].replace(/[\'\" ]*/g, ""));
                var i2 = str.indexOf(",", 1),
                    i21 = str.indexOf("[", i2 + 1),
                    i22 = str.indexOf("]", i2 + 1),
                    i3 = str.indexOf(",", i2 + 1);
                if (i21 < i3) {
                    o.pname = eval(restore(restore1(str.substring(i21, i22 + 1))))
                } else {
                    o.pname = str.substring(i2 + 1, i3);
                    o.pname = /[\'\"]/.test(o.pname) ? o.pname.replace(/[\'\" ]*/g, "") : null
                }
                o.frame = restore1(frame.replace(o.name, "*1").replace(o.pname, "*2"));
                str = str.slice(str.indexOf("{") + 1, str.lastIndexOf("}"));
                result = o.sub;
                var index2 = 1,
                    cache2 = {},
                    code2 = function (str) {
                        var ret = "'~" + index2+++"'";
                        cache2[ret] = str;
                        return ret
                    },
                    code3 = function (a, b, str) {
                        if (a.indexOf("~") != -1) {
                            return a
                        }
                        var ret = "'~" + index2+++"'";
                        cache2[ret] = str;
                        return b + ret
                    },
                    restore2 = function (str) {
                        if (str.indexOf("~") == -1) {
                            return str
                        }
                        str = cache2["'" + str + "'"];
                        while (/'~\d+'/.test(str)) {
                            str = str.replace(/'~\d+'/g, function (m) {
                                return cache2[m]
                            })
                        }
                        return str
                    };
                while (/(\{([^\{\}\[\]]*)\})|(\[([^\[\]\{\}]*)\])/.test(str)) {
                    str = str.replace(/\s*(((function\s*([\w$]+\s*)?\(\s*([\w$\s,]*)\s*\)\s*)?(\{([^\{\}\[\]]*)\}))|(\[([^\[\]\{\}]*)\]))/g, code2)
                }
                if (/[\{\}\[\]]/.test(str)) {
                    return false
                }
                str = xui.Coder.replace(str, ["\\s+", code]);
                str = str.replace(/((#\d+#)+)([\w]+)((#\d+#)*):/g, function (z, a, b, c) {
                    result[c] = {
                        comments: restore(a)
                    };
                    return c + ":"
                });
                str = str.replace(/(#\d+#)/g, "");
                var obj;
                try {
                    obj = eval("({" + str + "})")
                } catch (e) {
                    return false
                }
                _.arr.each(["Constructor", "Dependency", "Initialize", "Before", "After", "$End"], function (i) {
                    if (obj[i]) {
                        result[i] = result[i] || {};
                        result[i].code = restore(restore1(restore2(obj[i])))
                    } else {
                        result[i] = {}
                    }
                    _.arr.each(_.toArr("code,comments"), function (j) {
                        result[i][j] = _.isDefined(result[i][j]) ? result[i][j] : null
                    })
                });
                var obj2;
                _.arr.each(["Instance", "Static"], function (i) {
                    if (obj[i]) {
                        var temp = cache2["'" + obj[i] + "'"];
                        var frame = temp.replace(/(^[^{]*\{)\s*((.|[\r\n])*)([^\s])(\s*}[^}]*$)/, "$1*3$5");
                        temp = temp.replace(/(#\d+#)*\s*(\})$/g, "$2");
                        temp = "(" + temp + ")";
                        temp = xui.Coder.replace(temp, ["\\s+", code]);
                        result[i] = result[i] || {};
                        result2 = result[i].sub = {};
                        result[i].frame = frame;
                        temp = temp.replace(/(:)([^,\}]+)/g, code3);
                        temp = restore1(temp);
                        temp = temp.replace(/((#\d+#)+)([\w]+)((#\d+#)*):/g, function (z, a, b, c) {
                            result2[c] = {
                                comments: restore(a)
                            };
                            return c + ":"
                        });
                        temp = temp.replace(/(#\d+#)/g, "");
                        obj2 = eval(temp);
                        _.each(obj2, function (o, j) {
                            result2[j] = result2[j] || {};
                            result2[j].code = restore(restore1(restore2(o)))
                        })
                    } else {
                        result[i] = {}
                    }
                    _.arr.each(_.toArr("code,comments,sub,frame"), function (j) {
                        result[i][j] = _.isDefined(result[i][j]) ? result[i][j] : null
                    })
                });
                return o
            } catch (e) {
                return false
            }
        },
        getClassStruct2: function (code, index) {
            if ((!_.isSet(index)) || index < 0 || index >= code.length) {
                index = code.length
            }
            var ns = this,
                cache = ns._Cache2 || (ns._Cache2 = {});
            if (cache[code + "^**^" + index]) {
                return cache[code + "^**^" + index]
            }
            var rf = function (a) {
                    return _.str.repeat(" ", a[0].length)
                };
            var ocode = code;
            code = xui.Coder.replace(code, [
                [/\r\n?|\n/, "\n"],
                [/(\uFEFF|\xA0|[\t\x0B\f])/, rf],
                [/"([\w\$])?[\w\.]*"/, "$0"],
                [/'([\w\$])?[\w\.]*'/, "$0"],
                [/"(\\.|[^"\\\n])*"/, rf],
                [/'(\\.|[^'\\\n])*'/, rf],
                [/\/(\\[\/\\]|[^*\/])(\\.|[^\/\n\\])*\/[gim]*/, rf],
                [/\/\*[^*]*\*+([^\/][^*]*\*+)*\//, rf],
                [/\/\/[^\n]*/, rf], ]);
            var regxuiCls = /\bClass\s*\(\s*["'\w\$\.]+\s*\,\s*["'\w\$\.]+\s*\,\s*\{/g,
                found, clsStartPos = -1,
                clsEnd, j = -1,
                codeStart;
            if ((found = regxuiCls.exec(code)) != null) {
                j = regxuiCls.lastIndex;
                if (j >= index) {
                    if (clsStartPos == -1) {
                        return null
                    }
                }
                clsStartPos = j - found[0].length
            }
            var len = code.length,
                pos = code.indexOf("{", clsStartPos) + 1,
                clsCodeStart = pos,
                layer = 1,
                i1 = code.indexOf("(", clsStartPos + 1),
                i2 = code.indexOf(",", i1 + 1),
                i21 = code.indexOf("[", i2 + 1),
                i22 = code.indexOf("]", i2 + 1),
                i3 = code.indexOf(",", i2 + 1),
                hash = {},
                prevColonPos = -1,
                qMark = false,
                keyPattern = /((\b[\w\$][\w]*\b)|(\'[^']*\')|(\"[^"]*\"))\s*$/,
                lastOKPos = pos,
                c, tmpstr, tmpstr2, tmpResult, key, type, args, subcode, codefrom, codeto, layer1Key;
            hash.name = code.substring(i1 + 1, i2).replace(/[\'\" ]*/g, "");
            if (i21 < i3) {
                hash.pname = code.substring(i21, i22 + 1);
                try {
                    hash.pname = eval(hash.pname)
                } catch (e) {
                    return null
                }
                _.arr.each(hash.pname, function (o) {
                    if (o == "xui.Com") {
                        hash.isCom = true
                    } else {
                        var t = xui.SC(o);
                        hash.isCom = t && t["xui.Com"]
                    }
                })
            } else {
                hash.pname = code.substring(i2 + 1, i3);
                hash.pname = /[\'\"]/.test(hash.pname) ? hash.pname.replace(/[\'\" ]*/g, "") : null;
                if (!/^[\w\$][\w\.]*$/.test(hash.name) || !/^[\w\$][\w\.]*$/.test(hash.pname)) {
                    return null
                }
                if (hash.pname == "xui.Com") {
                    hash.isCom = true
                } else {
                    if (hash.pname) {
                        var t = xui.SC(hash.pname);
                        hash.isCom = t && t["xui.Com"]
                    }
                }
            }
            hash.arr = [];
            do {
                c = code[pos++];
                if (c == "?") {
                    if (layer <= 2) {
                        qMark = true
                    }
                } else {
                    if (c == ":") {
                        if (layer <= 2) {
                            if (qMark) {
                                qMark = false;
                                continue
                            } else {
                                if (prevColonPos != -1) {
                                    continue
                                } else {
                                    prevColonPos = pos
                                }
                            }
                        }
                    } else {
                        if (c == "(") {
                            if (prevColonPos != -1) {
                                var nn = code.indexOf(")", pos);
                                if (nn != -1) {
                                    pos = nn + 1;
                                    continue
                                }
                            }
                        } else {
                            if (c == ",") {
                                if (prevColonPos != -1) {
                                    if (layer <= 3) {
                                        type = "other";
                                        subcode = ocode.substring(codefrom = prevColonPos, codeto = pos - 1)
                                    }
                                    tmpstr2 = code.substring(lastOKPos + 1, prevColonPos - 1);
                                    tmpResult = keyPattern.exec(tmpstr2);
                                    if (tmpResult != null) {
                                        key = tmpResult[0].replace(/[\'\"\s]/g, "")
                                    }
                                    prevColonPos = -1;
                                    lastOKPos = pos
                                }
                            } else {
                                if (c == "{") {
                                    layer++;
                                    if (prevColonPos != -1) {
                                        if (layer <= 3) {
                                            tmpstr = code.substring(prevColonPos, pos).replace(/\s*/, "");
                                            if (tmpstr[0] == "f") {
                                                args = tmpstr.substring(tmpstr.indexOf("(") + 1, tmpstr.indexOf(")")).split(",");
                                                if (args[0] === "") {
                                                    args = null
                                                }
                                                type = "function"
                                            } else {
                                                if (tmpstr[0] == "{") {
                                                    type = "object"
                                                }
                                            }
                                            tmpstr2 = code.substring(lastOKPos + 1, prevColonPos - 1);
                                            tmpResult = keyPattern.exec(tmpstr2);
                                            if (tmpResult != null) {
                                                key = tmpResult[0].replace(/[\'\"\s]/g, "");
                                                if (layer == 2 && (type == "object" || type == "function")) {
                                                    layer1Key = key;
                                                    codefrom = pos - 1
                                                }
                                            }
                                        }
                                        prevColonPos = -1;
                                        lastOKPos = pos
                                    }
                                } else {
                                    if (c == "}") {
                                        if (prevColonPos != -1) {
                                            if (layer <= 3) {
                                                type = "other";
                                                subcode = ocode.substring(codefrom = prevColonPos, codeto = pos - 1)
                                            }
                                            tmpstr2 = code.substring(lastOKPos + 1, prevColonPos - 1);
                                            tmpResult = keyPattern.exec(tmpstr2);
                                            if (tmpResult != null) {
                                                key = tmpResult[0].replace(/[\'\"\s]/g, "")
                                            }
                                            prevColonPos = -1;
                                            lastOKPos = pos
                                        }
                                        layer--;
                                        if (layer === 0) {
                                            subcode = ocode.substring(codefrom = clsCodeStart - 1, codeto = pos);
                                            hash.code = subcode;
                                            hash.from = codefrom;
                                            hash.to = codeto
                                        } else {
                                            if (layer === 1) {
                                                if (layer1Key) {
                                                    _.set(hash.sub, [layer1Key, "to"], pos);
                                                    hash.arr.push(layer1Key);
                                                    layer1Key = null
                                                }
                                            } else {
                                                if (layer === 2) {
                                                    subcode = ocode.substring(codefrom = codeStart - 1, codeto = pos);
                                                    _.set(hash.sub, [layer1Key, "sub", key, "code"], subcode);
                                                    _.set(hash.sub, [layer1Key, "sub", key, "from"], codefrom);
                                                    _.set(hash.sub, [layer1Key, "sub", key, "to"], codeto)
                                                }
                                            }
                                        }
                                        prevColonPos = -1;
                                        lastOKPos = pos
                                    }
                                }
                            }
                        }
                    }
                }
                if (type) {
                    if (!hash.sub) {
                        hash.sub = {}
                    }
                    if (layer1Key) {
                        if (layer1Key != key) {
                            if (!_.get(hash.sub, [layer1Key, "sub"])) {
                                _.set(hash.sub, [layer1Key, "sub"], {})
                            }
                            _.set(hash.sub, [layer1Key, "sub", key], {
                                type: type,
                                args: args,
                                code: subcode,
                                from: codefrom,
                                to: codeto
                            });
                            hash.sub[layer1Key].arr.push(key)
                        } else {
                            _.set(hash.sub, [layer1Key], {
                                type: "object",
                                from: codefrom,
                                arr: []
                            })
                        }
                    } else {
                        hash.sub[key] = {
                            type: type,
                            args: args,
                            code: subcode,
                            from: codefrom,
                            to: codeto
                        }
                    }
                    codeStart = pos
                }
                type = args = null
            } while (pos <= len && layer > 0);
            _.breakO(cache);
            return cache[code + "^**^" + index] = hash
        },
        getClassStructWithScope: function (code, index, cacheKey1, cacheKey2) {
            var ns = this,
                cache = ns._Cache1 || (ns._Cache1 = {});
            if (cache[code + "^**^" + index]) {
                return cache[code + "^**^" + index]
            }
            var hash = ns.getClassStruct2(code, index),
                _this = ns._this,
                t, t1, getArgsFromAPI = function (cls, key, isInstance, firstArgsCode) {
                    var doc = xui.getRes("doc." + cls + (isInstance ? ".prototype" : "") + "." + key);
                    if (doc === key) {
                        var obj = _.get(window, (cls + "." + key).split("."));
                        if (obj && obj.$original$) {
                            doc = xui.getRes("doc." + obj.$original$ + ".prototype." + key)
                        }
                    }
                    if (doc) {
                        var paras = doc.$paras,
                            arr = [],
                            str;
                        if (paras && paras.length) {
                            if (firstArgsCode) {
                                arr = [{
                                    code: firstArgsCode
                                }]
                            }
                            for (var i = firstArgsCode ? 1 : 0; i < paras.length; i++) {
                                str = paras[i].replace(/.*\:\s*(([\w]+\.)*[\w]+).*/, "$1");
                                if (str == "Event" || str == "Element" || str == "Document") {
                                    str = "Object"
                                }
                                arr.push({
                                    type: str + ".prototype"
                                })
                            }
                            return arr
                        }
                    }
                    return null
                };
            if (!hash) {
                return null
            }
            _.arr.each(["Constructor", "Dependency", "Initialize", "Before", "After", "$End"], function (i) {
                if ((t = _.get(hash, ["sub", i])) && t.type == "function") {
                    _.set(hash, ["sub", i], {
                        argsv: [_this, "''"],
                        _this: hash.pname ? ("__getThis('" + hash.pname + "',1)") : "{}"
                    })
                }
            });
            if (t = _.get(hash, ["sub", "Instance", "sub", "initialize"])) {
                t._this = hash.pname ? ("__getThis('" + hash.pname + "',1)") : "{}"
            }
            if (hash.pname) {
                if (t = _.get(hash, ["sub", "Static", "sub"])) {
                    _.each(t, function (o, key) {
                        if (key === "sub") {
                            return
                        }
                        o._this = hash.pname ? ("__getThis('" + hash.pname + "',1)") : "{}";
                        if (typeof (hash.pname) == "string") {
                            var arr = getArgsFromAPI(hash.pname, key, false);
                            if (arr) {
                                o.argsv = arr
                            }
                        } else {
                            _.arr.each(hash.pname, function (cls) {
                                var arr = getArgsFromAPI(cls, key, false);
                                if (arr) {
                                    o.argsv = arr
                                }
                            })
                        }
                    })
                }
                if (t = _.get(hash, ["sub", "Instance", "sub"])) {
                    _.each(t, function (o, key) {
                        o._this = hash.pname ? ("__getThis('" + hash.pname + "',0)") : "{}";
                        if (typeof (hash.pname) == "string") {
                            var arr = getArgsFromAPI(hash.pname, key, true);
                            if (arr) {
                                o.argsv = arr
                            }
                        } else {
                            _.arr.each(hash.pname, function (cls) {
                                var arr = getArgsFromAPI(cls, key, true);
                                if (arr) {
                                    o.argsv = arr
                                }
                            })
                        }
                    })
                }
            }
            var globalCache;
            if (cacheKey1 && cacheKey2) {
                globalCache = window[cacheKey1] || (window[cacheKey1] = {});
                if (globalCache[cacheKey2]) {
                    for (var i in globalCache[cacheKey2]) {
                        delete globalCache[cacheKey2][i]
                    }
                } else {
                    globalCache[cacheKey2] = {}
                }
                globalCache = globalCache[cacheKey2]
            } else {
                globalCache = {}
            }
            globalCache.Instance = {
                _ctrlpool: {},
                properties: {},
                events: {}
            };
            globalCache.Static = {};
            if (t1 = _.get(hash, ["sub", "Instance", "sub"])) {
                _.each(t1, function (o, i) {
                    try {
                        globalCache.Instance[i] = o.type == "function" ? eval("(function(" + (o.args ? o.args.join(",") : "") + "){})") : eval("(" + o.code + ")")
                    } catch (e) {
                        globalCache.Instance[i] = null
                    }
                })
            }
            if (t1 = _.get(hash, ["sub", "Static", "sub"])) {
                _.each(t1, function (o, i) {
                    try {
                        globalCache.Static[i] = o.type == "function" ? eval("(function(" + (o.args ? o.args.join(",") : "") + "){})") : eval("(" + o.code + ")")
                    } catch (e) {
                        globalCache.Static[i] = null
                    }
                })
            }
            if (hash.isCom) {
                if (t = _.get(hash, ["sub", "Instance", "sub", "events"])) {
                    if (t = t.code) {
                        try {
                            t = eval("(" + t + ")")
                        } catch (e) {
                            t = null
                        }
                        if (t && _.isHash(t)) {
                            _.each(t, function (evt, name) {
                                if (t1 = _.get(hash, ["sub", "Instance", "sub", evt])) {
                                    t1.argsv = getArgsFromAPI("xui.Com", name, true, "this")
                                }
                            })
                        }
                    }
                }
                if (t = _.get(hash, ["sub", "Instance", "sub", "initialize"])) {
                    if (t = t.code) {
                        try {
                            t = eval("(function()" + t + ")")
                        } catch (e) {
                            t = null
                        }
                        if (typeof (t) == "function") {
                            try {
                                t.call(globalCache.Instance)
                            } catch (e) {}
                        }
                    }
                }
                if (t = _.get(hash, ["sub", "Instance", "sub", "iniComponents"])) {
                    if (t = t.code) {
                        try {
                            t = eval("(function()" + t + ")")
                        } catch (e) {
                            t = null
                        }
                        if (typeof (t) == "function") {
                            try {
                                t.call(globalCache.Instance)
                            } catch (e) {}
                            _.each(globalCache.Instance._ctrlpool, function (o, i) {
                                var cls = o.key;
                                _.each(o.getEvents(), function (evt, key) {
                                    if (t1 = _.get(hash, ["sub", "Instance", "sub", evt])) {
                                        t1.argsv = getArgsFromAPI(cls, key, true, "(new " + cls + ").get(0)")
                                    }
                                })
                            })
                        }
                    }
                }
            }
            _.breakO(cache);
            return cache[code + "^**^" + index] = hash
        },
        getMinCode: function (code, index) {
            if (index < 0 || index >= code.length) {
                return ""
            }
            var t1 = new Date;
            var reg2 = /(\{(((\{\})|[^\{\}\x01])+)\})|(\[([^\[\]0\x01]+)\])/,
                reg3 = /(((\s*function\s*([\w$][\w]*\s*)?\(\s*([\w$\s,]*)\s*\)\s*)?(\{(((\{\})|[^\{\}\x01])*)\}))|(\[([^\[\]0\x01]+)\]))/g;
            code = code.replace(/\x01/g, "0");
            code = code.substring(0, index) + "\x01" + code.substring(index + 1, code.length);
            code = xui.Coder.replace(code, [
                [/\r\n?|\n/, "\n"],
                [/(\uFEFF|\xA0|[\t\x0B\f])/, " "],
                [/"[\w\$][\w\.]*"\s*\:/, "$0"],
                [/'[\w\$][\w\.]*'\s*\:/, "$0"],
                [/"(\\.|[^"\\\n])*"/, '"a"'],
                [/'(\\.|[^'\\\n])*'/, "'a'"],
                [/\/(\\[\/\\]|[^*\/])(\\.|[^\/\n\\])*\/[gim]*/, "(new RegExp())"],
                [/\/\*[^*]*\*+([^\/][^*]*\*+)*\//, ""],
                [/\/\/[^\n]*/, ""]
            ]);
            var t2 = new Date;
            while (reg2.test(code)) {
                code = code.replace(reg3, function (a) {
                    return a[0] == "{" ? "{}" : a[0] == "[" ? "[0]" : "(new Function())"
                })
            }
            var t3 = new Date;
            var i = 0,
                k = code.indexOf("\x01"),
                l = code.length,
                ignoreComma = true,
                a1 = [],
                a2 = [],
                a3 = [],
                arr2 = [],
                arr3 = [],
                c, tmp = 0,
                strtmp, prevDo = true;
            var tests = code.substring(0, k);
            if (!/\bfunction\b/.test(tests)) {
                return tests
            }
            do {
                c = code[i++];
                if (i < k) {
                    if (c == "{" && code[i] != "}") {
                        strtmp = code.substring(tmp, i + 1);
                        arr2.push(strtmp + "\n");
                        if (/\:\s*function\b/.test(strtmp)) {
                            arr2.push(code.substring(i + 1, k) + "\n");
                            i = k;
                            continue
                        }
                        ignoreComma = false
                    }
                    if ((c == "{" && code[i] != "}") || ((!ignoreComma) && c == ",")) {
                        tmp = i
                    }
                    if (c == "(") {
                        if (code.substring(i - 1, i + 13) == "(new RegExp())") {
                            i += 13
                        } else {
                            if (code.substring(i - 1, i + 15) == "(new Function())") {
                                i += 15
                            } else {
                                ignoreComma = true
                            }
                        }
                    }
                } else {
                    if (prevDo) {
                        arr2.push("{}");
                        prevDo = false
                    }
                    if (c == "{") {
                        a1.push(c)
                    } else {
                        if (c == "}") {
                            if (a1.length === 0) {
                                arr3.push(c)
                            } else {
                                a1.pop()
                            }
                        } else {
                            if (c == "[") {
                                a2.push(c)
                            } else {
                                if (c == "]") {
                                    if (a2.length === 0) {
                                        arr3.push(c)
                                    } else {
                                        a2.pop()
                                    }
                                } else {
                                    if (c == "(") {
                                        a3.push(c)
                                    } else {
                                        if (c == ")") {
                                            if (a3.length === 0) {
                                                arr3.push(c)
                                            } else {
                                                a3.pop()
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } while (i < l);
            return arr2.join("\n").replace(/\s*\n\s*/g, "\n") + arr3.join("")
        },
        getContextVars: function (code, index) {
            code = code.substring(0, index);
            var cm = new CodeMirror(new Function);
            cm.setValue(code);
            var hash = {},
                funPos, getVars = function (obj, hash) {
                    vars = obj && obj.vars;
                    if (vars) {
                        do {
                            hash[vars.name] = 1
                        } while (vars = vars.next)
                    }
                    if (obj && obj.prev) {
                        getVars(obj.prev, hash)
                    }
                };
            var state = cm.getStateAfter(cm.doc.posFromIndex(index).line),
                vars;
            vars = state.localVars;
            if (vars) {
                do {
                    hash[vars.name] = 1
                } while (vars = vars.next)
            }
            vars = state.globalVars;
            if (vars) {
                do {
                    hash[vars.name] = 1
                } while (vars = vars.next)
            }
            getVars(state.context, hash);
            return hash
        },
        getContextAssignments: function (code, index) {
            code = this.getMinCode(code, index);
            index = code.lastIndexOf("\n");
            code = code.replace(/[ ]+/g, " ");
            code = code.replace(/\bClass\s*\(\s*["'\w\$\.]+\s*\,\s*["'\w\$\.]+\s*\,\s*\{\}\s*\)\s*(;)?/g, "");
            var len = code.length,
                funpatt = /\s*function\s*([\w$]+\s*)?\(\s*[\w$\s,]*\s*\)\s*\{/g;
            var regxuiCls = /\bClass\s*\(\s*["'\w\$\.]+\s*\,\s*["'\w\$\.]+\s*\,\s*\{/,
                isXUIClass = regxuiCls.exec(code);
            if (isXUIClass != null) {
                var i = regxuiCls.lastIndex + isXUIClass[0].length,
                    firstType = null,
                    firstKey = null,
                    secondType = null,
                    secondKey = null,
                    specialScopeS = -1,
                    specialScopeE = len,
                    specialVarDef = [],
                    keepi = i,
                    colon, c;
                while (i < len) {
                    c = code[i++];
                    if (c == " " || c == "\n") {
                        continue
                    }
                    if (colon) {
                        if (c == "{") {
                            firstType = "hash";
                            firstKey = code.substring(keepi + 1, i - 1).replace(/[\'\" \n:]/g, "");
                            keepi = i;
                            colon = false;
                            while (i < len) {
                                c = code[i++];
                                if (c == " " || c == "\n") {
                                    continue
                                }
                                if (colon) {
                                    if (funpatt.test(code.substring(i - 1, len))) {
                                        secondType = "function";
                                        secondKey = code.substring(keepi + 1, i - 1).replace(/[\'\" \n:]/g, "");
                                        specialScopeS = i - 1;
                                        if (funpatt.test(code.substring(i - 1, len))) {
                                            specialScopeE = funpatt.lastIndex + i - 1
                                        }
                                        var stra = "",
                                            startC;
                                        while (i < len) {
                                            c = code[i++];
                                            if (c == " " || c == "\n") {
                                                continue
                                            }
                                            if (c == "(") {
                                                startC = 1;
                                                continue
                                            } else {
                                                if (c == ")") {
                                                    break
                                                }
                                            }
                                            if (startC) {
                                                stra += c
                                            }
                                        }
                                        specialVarDef = stra.split(",")
                                    } else {}
                                    break
                                }
                                colon = c == ":"
                            }
                        } else {
                            if (c == "f") {
                                firstType = "function";
                                firstKey = code.substring(keepi + 1, i - 1).replace(/[\'\" \n:]/g, "");
                                specialScopeS = i - 1;
                                if (funpatt.test(code.substring(i - 1, len))) {
                                    specialScopeE = funpatt.lastIndex + i - 1
                                }
                                var stra = "",
                                    startC;
                                while (i < len) {
                                    c = code[i++];
                                    if (c == " " || c == "\n") {
                                        continue
                                    }
                                    if (c == "(") {
                                        startC = 1;
                                        continue
                                    } else {
                                        if (c == ")") {
                                            break
                                        }
                                    }
                                    if (startC) {
                                        stra += c
                                    }
                                }
                                specialVarDef = stra.split(",")
                            } else {}
                        }
                        break
                    }
                    colon = c == ":"
                }
            }
            var arr1 = [],
                arr2 = [],
                scopeS = -1,
                scopeE = -1,
                result, added = false,
                patt = /([\w$][\w]*)\s*\=\s*([^\s]{1})/g,
                codeL = code.length,
                inSpecialScope = false;
            outerloop: while ((result = patt.exec(code)) != null) {
                if (specialScopeS != -1) {
                    if (patt.lastIndex >= specialScopeS) {
                        if (patt.lastIndex < specialScopeE) {
                            inSpecialScope = true;
                            if (!added) {
                                scopeS = arr1.length;
                                added = true
                            }
                        } else {
                            inSpecialScope = false;
                            scopeE = arr1.length
                        }
                    } else {
                        inSpecialScope = false
                    }
                }
                var v2 = result[2];
                if ("=" == v2[0]) {
                    continue outerloop
                } else {
                    if ("{" == v2[0]) {
                        v2 = "{}"
                    } else {
                        if ("[" == v2[0]) {
                            v2 = "[]"
                        } else {
                            var j = patt.lastIndex - 1,
                                cc, count = 0,
                                prevIsOperator = false,
                                enter = false;
                            while (j <= codeL) {
                                cc = code[j++];
                                if (cc == " ") {
                                    continue
                                }
                                if (prevIsOperator) {
                                    prevIsOperator = false
                                }
                                if (enter) {
                                    enter = false;
                                    if (!(cc == "+" || cc == "-" || cc == "*" || cc == "/" || cc == ".")) {
                                        break
                                    }
                                }
                                if (cc == "(") {
                                    count++
                                } else {
                                    if (cc == ")" || cc == "}") {
                                        if (count > 0) {
                                            count--
                                        } else {
                                            break
                                        }
                                    } else {
                                        if (cc == "+" || cc == "-" || cc == "*" || cc == "/" || cc == ".") {
                                            prevIsOperator = true;
                                            continue
                                        }
                                    }
                                }
                                if (count > 0) {
                                    continue
                                } else {
                                    if (cc == "," || cc == ";") {
                                        break
                                    } else {
                                        if (cc == "\n") {
                                            if (prevIsOperator) {
                                                continue
                                            } else {
                                                break
                                            }
                                        }
                                    }
                                }
                            }
                            v2 = code.substring(patt.lastIndex - 1, j - 1);
                            if (/\bfunction\s*\(/.test(v2)) {
                                v2 = "(new Function())"
                            }
                            if (/\.$/.test(v2)) {
                                v2 = v2.replace(/[\.]+$/, "")
                            }
                        }
                    }
                }
                arr1.push(result[1]);
                arr2.push(v2)
            }
            return {
                vars: arr1,
                code: arr2,
                firstType: firstType,
                firstKey: firstKey,
                secondType: secondType,
                secondKey: secondKey,
                scopeS: scopeS,
                scopeE: scopeS == -1 ? -1 : (scopeE == -1 ? arr1.length : scopeE),
                outscope: scopeS == -1 ? false : index >= specialScopeE
            }
        }
    }
});
Class("RAD.JSEditor", "xui.Com", {
    Instance: {
        events: {
            onRender: "_onRender"
        },
        _onRender: function (com) {},
        _ondestroy: function () {
            var ns = this;
            ns.___buildNSCode = ns.___treeHash = null
        },
        resetEditorStyle: function (theme, fs) {
            this.codeeditor.resetEditorStyle(theme, fs)
        },
        initialize: function () {
            var ns = this;
            ns.$transTaskList = [];
            ns.$transTaskListCached = {};
            ns._ovalue = "";
            ns._dirty = false;
            ns._uicode = null;
            ns._evalcache = {};
            ns.properties.$pageviewType = "xui.UI.ButtonViews"
        },
        _regClass: /\bClass\s*\(\s*["'\w\$\.]+\s*\,\s*["'\w\$\.]+\s*\,\s*\{/,
        _rebuildNameSpace: function (value) {
            var ns = this,
                editor = ns.codeeditor,
                bv = ns.buttonview,
                lo = ns.layoutFill,
                tb = ns.toolbar4,
                value = value || ns.getValue();
            if (!ns._regClass.test(value)) {
                if (bv && !bv.getItemByItemId("design").disabled) {
                    lo.updateItem("before", {
                        hidden: true
                    });
                    bv.updateItem("design", {
                        disabled: true
                    });
                    bv.reLayout(true);
                    tb.updateItem("outline", {
                        value: true
                    });
                    tb.showGroup("g1", false)
                }
                return
            } else {
                if (bv && bv.getItemByItemId("design").disabled) {
                    lo.updateItem("before", {
                        hidden: false
                    });
                    bv.updateItem("design", {
                        disabled: false
                    });
                    bv.reLayout(true);
                    tb.updateItem("outline", {
                        value: true
                    });
                    tb.showGroup("g1", true)
                }
            }
            if (value === ns.___buildNSCode) {
                return
            }
            ns.___buildNSCode = value;
            var globalCache = {},
                struct = RAD.ClassTool.getClassStructWithScope(value);
            ns._rebuildTree(struct)
        },
        _rebuildTree: function (struct) {
            var ns = this,
                hashArr = [],
                items = [],
                icon = xui.getPath("img/", "App.gif"),
                item, iconPos;
            _.each(_.get(struct, ["sub"]), function (obj, i) {
                hashArr.push(i);
                item = {
                    id: i,
                    caption: i,
                    tips: i,
                    image: icon
                };
                switch (i) {
                case "Static":
                    item.imagePos = "-16px -32px";
                    item.sub = [];
                    hashArr.push("[");
                    _.each(obj.sub, function (o, i) {
                        hashArr.push(i);
                        iconPos = o.type == "function" ? "-32px -32px" : o.type == "object" ? "-16px -32px" : "0 -32px";
                        item.sub.push({
                            id: "Static." + i,
                            tips: i,
                            caption: i,
                            image: icon,
                            imagePos: iconPos
                        })
                    });
                    hashArr.push("]");
                    break;
                case "Instance":
                    item.imagePos = "-16px -32px";
                    item.sub = [];
                    hashArr.push("[");
                    _.each(obj.sub, function (o, i) {
                        hashArr.push(i);
                        iconPos = o.type == "function" ? "-32px -32px" : o.type == "object" ? "-16px -32px" : "0 -32px";
                        item.sub.push({
                            id: "Instance." + i,
                            tips: i,
                            caption: i,
                            image: icon,
                            imagePos: iconPos
                        })
                    });
                    hashArr.push("]");
                    break;
                case "Dependency":
                    item.imagePos = "0 -32px";
                    break;
                case "Constructor":
                case "Initialize":
                case "Before":
                case "After":
                    item.imagePos = "-32px -32px";
                    break;
                default:
                    item.imagePos = item.type == "function" ? "-32px -32px" : item.type == "object" ? "-16px -32px" : "0 -32px"
                }
                items.push(item)
            });
            var hash = hashArr.join("#");
            if (hash !== ns.___treeHash) {
                ns.___treeHash = hash;
                ns.treebarClass.setItems(items)
            }
        },
        _getEval: function (text) {
            var ns = this,
                code = (text || ns.getValue()),
                result;
            if (ns._evalcache[code]) {
                result = ns._evalcache[code]
            } else {
                result = RAD.CodeEditor.evalInSandbox("Class=function(a,b,c){return c;};" + code);
                if (result.ok) {
                    _.breakO(ns._evalcache);
                    ns._evalcache[code] = result;
                    ns._designer.setLinkObj(result.ok)
                }
            }
            return result
        },
        activate: function () {
            var ns = this,
                view = ns.buttonview.getUIValue();
            if (view == "code") {
                ns.codeeditor.activate()
            }
        },
        getValue: function () {
            var ns = this;
            if (ns._designer.isDirty()) {
                ns._designer.resetCodeFromDesigner(true);
                ns._ovalue = ns.codeeditor.getUIValue();
                ns._dirty = false
            }
            return ns._dirty ? (ns._ovalue = ns.codeeditor.getUIValue()) : ns._ovalue
        },
        setValue: function (value) {
            value = (value || "").replace(/\t/g, "    ").replace(/\u00a0/g, " ").replace(/\r\n?/g, "\n");
            var ns = this;
            if (ns._ovalue != value) {
                ns._ovalue = value;
                ns._dirty = false;
                ns.codeeditor.setValue(value);
                ns._uicode = null;
                if (ns.buttonview.getUIValue() == "design") {
                    ns._beforeValueUpdated(null, null, "design")
                }
            }
            var isCls = ns._regClass.test(value);
            ns.layoutFill.updateItem("before", {
                hidden: !isCls
            });
            ns.buttonview.updateItem("design", {
                disabled: !isCls
            });
            ns.toolbar4.showGroup("g1", isCls);
            return ns
        },
        customAppend: function (parent, subId, left, top) {
            var ns = this;
            parent.append(ns.paneMain, subId);
            ns.buttonview.getSubNode("ITEMS").append((new xui.UI.Image({
                src: xui.getPath("img/", "progress.gif"),
                position: "relative",
                left: 4,
                top: 6
            })).setHost(ns, "imgProgress"))
        },
        iniExComs: function () {
            var ns = this;
            var pageview = (new(xui.SC.get(ns.properties.$pageviewType))).setHost(ns, "buttonview").setNoPanel(true).setDock("top").setHeight("auto").setItems([{
                id: "code",
                caption: "$RAD.JSEditor.sv",
                image: "@CONF.img_app",
                imagePos: "-80px -48px",
                tips: "$RAD.JSEditor.svtips"
            }, {
                id: "design",
                caption: "$RAD.JSEditor.dv",
                image: "@CONF.img_app",
                imagePos: "-192px -48px",
                tips: "$RAD.JSEditor.dvtips"
            }]).beforeUIValueSet("_beforeValueUpdated");
            if (ns.properties.$pageviewType == "xui.UI.ButtonViews") {
                pageview.setBarSize(28);
                pageview.setCustomStyle({
                    ITEMS: "position:relative",
                    LIST: "position:relative"
                })
            }
            ns.paneMain.append(pageview);
            var designer = new RAD.Designer();
            designer.setHost(ns, "_designer");
            designer.setEvents("onValueChanged", function (ipage, profile) {
                ns.fireEvent("onValueChanged", [ns, true])
            });
            designer.resetTaskList = function () {
                ns._disable();
                ns.$transTaskList = [];
                ns.$transTaskListCached = {}
            };
            designer.addTask = function (task) {
                ns.$transTaskList.push(task)
            };
            designer.hasTask = function (task) {
                return !!ns.$transTaskList.length
            };
            designer.startTaskList = function () {
                ns.checkRenderStatus(ns)
            };
            designer.resetCode = function (pkey, key, code, syn, isFun) {
                var fun = function () {
                        if (ns.$transTaskListCached[pkey + ":" + key] === code) {
                            return
                        }
                        ns.addCodeToEditor(pkey, key, code, isFun);
                        ns.$transTaskListCached[pkey + ":" + key] = code
                    };
                if (syn) {
                    fun()
                } else {
                    ns.$transTaskList.push(fun)
                }
            };
            designer.addCode = function (pkey, key, code, syn, isFun) {
                var fun = function () {
                        if (ns.$transTaskListCached[pkey + ":" + key] === code) {
                            return
                        }
                        ns.addCodeToEditor("Instance", key, code, isFun);
                        ns.$transTaskListCached[pkey + ":" + key] = code
                    };
                if (syn) {
                    fun()
                } else {
                    ns.$transTaskList.push(fun)
                }
            };
            designer.focusEditor = function (pkey, key) {
                ns.showPage("code");
                ns._enable();
                ns.tryToLocale([pkey, key])
            };
            designer.searchInEditor = function (code) {
                ns.showPage("code");
                ns._enable();
                var cursor = ns.codeeditor.searchCode(code)
            };
            designer.refreshFromCode = function () {
                var obj = ns._getEval(ns._ovalue = ns.codeeditor.getUIValue());
                if (obj.ok) {
                    ns.$transTaskListCached["Static:viewSize"] = this.refreshViewSize(obj.ok);
                    ns.$transTaskListCached["Instance:iniComponents"] = this.refreshView(obj.ok);
                    xui.message(xui.getRes("RAD.designer.refreshOK"))
                }
            };
            ns.paneDesign.append(designer)
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Pane).setHost(host, "paneMain").setDock("fill"));
            host.paneMain.append((new xui.UI.Pane).setHost(host, "paneCode").setVisibility("hidden").setDock("fill").setDockIgnore(true).setLeft(-1000));
            host.paneMain.append((new xui.UI.Pane).setVisibility("hidden").setHost(host, "paneDesign").setDock("fill"));
            host.paneCode.append((new xui.UI.Layout).setHost(host, "layoutFill").setItems([{
                id: "before",
                pos: "before",
                locked: false,
                size: 150,
                min: 50,
                max: 200,
                cmd: false,
                folded: false,
                hidden: false
            }, {
                id: "main",
                min: 10
            }]).setType("horizontal"));
            host.layoutFill.append((new xui.UI.TreeBar).setHost(host, "treebarClass").setIniFold(false).setSelMode("none").onItemSelected("_treebarclass_onitemselected"), "before");
            host.paneCode.append((new xui.UI.ToolBar).setHost(host, "toolbar4").setItems([{
                id: "g1",
                sub: [{
                    id: "outline",
                    caption: "$RAD.pageEditor.outline",
                    image: "@CONF.img_app",
                    imagePos: "-16px -48px",
                    statusButton: true,
                    value: true,
                    tips: "$RAD.pageEditor.outlinetips"
                }]
            }, {
                id: "fun",
                sub: [{
                    id: "searchreplace",
                    caption: "$RAD.pageEditor.searchreplace",
                    image: "@CONF.img_app",
                    imagePos: "-240px -48px",
                    type: "button",
                    tips: "$RAD.pageEditor.replacetips"
                }, {
                    id: "jumpto",
                    caption: "$RAD.pageEditor.jumpto",
                    image: "@CONF.img_app",
                    imagePos: "-160px -48px",
                    type: "button",
                    tips: "$RAD.pageEditor.jumptotips"
                }, {
                    id: "indentall",
                    caption: "$RAD.pageEditor.indentall",
                    image: "@CONF.img_app",
                    imagePos: "-224px -48px",
                    type: "button",
                    tips: "$RAD.pageEditor.indentalltips"
                }]
            }]).onClick("_toolbar_onclick"));
            host.layoutFill.append((new RAD.CodeEditor).setHost(host, "codeeditor").setDock("fill").onValueChanged("_codeeditor_onChange").onRendered("_codeeditor_onrender").onSaveCommand("_codeeditor_onsave").onGetHelpInfo("_codeeditor_ongett"), "main");
            return children
        },
        onDestroy: function () {
            this._designer.destroy()
        },
        setDftPage: function (key) {
            var ns = this;
            ns.$dftpage = key
        },
        showPage: function (key) {
            var ns = this;
            if (ns._once) {
                return
            }
            ns.buttonview.setUIValue(key, true)
        },
        _codeeditor_ongett: function (profile, key) {
            _.asyRun(function () {
                xui.Coder.applyById("doc:code", true)
            });
            return RAD.EditorTool.getDoc(key)
        },
        _beforeValueUpdated: function (profile, ov, nv) {
            var ns = this;
            ns._once = true;
            if (nv == "code") {
                if (ns._designer.isDirty()) {
                    ns._designer.resetCodeFromDesigner();
                    ns._dirty = true
                }
                ns.paneDesign.setDisplay("none").setZIndex(1);
                ns.paneCode.setDockIgnore(false).setVisibility("visible").setZIndex(100).reLayout()
            } else {
                if (nv == "design") {
                    var result = ns._getEval();
                    if (!result.ok) {
                        xui.message(xui.getRes("RAD.JSEditor.codeerr"));
                        return false
                    }
                    if (!RAD.ClassTool.getClassName(ns.codeeditor.getUIValue() || "")) {
                        xui.message(xui.getRes("RAD.classtool.noClass"));
                        return false
                    }
                    ns.codeeditor.clearHistory();
                    var needRef = false;
                    var needRefSize = false;
                    if (!ns._uicode) {
                        needRef = true
                    } else {
                        var f = _.get(result.ok, ["Instance", "iniComponents"]);
                        if (!f) {
                            needRef = true
                        } else {
                            var code = f.toString();
                            code = code.slice(code.indexOf("{") + 1, code.lastIndexOf("}"));
                            if (code != ns._uicode) {
                                ns._uicode = code;
                                needRef = true
                            }
                        }
                    }
                    if (!ns._uiviewsize) {
                        needRefSize = true
                    } else {
                        var w = parseInt(_.get(result.ok, ["Static", "viewSize", "width"]), 10),
                            h = parseInt(_.get(result.ok, ["Static", "viewSize", "height"]), 10);
                        if (!w || !h) {
                            needRefSize = true
                        } else {
                            if (w != ns._uiviewsize.w || h != ns._uiviewsize.h) {
                                ns._uiviewsize = {
                                    w: w,
                                    h: h
                                };
                                needRefSize = true
                            }
                        }
                    }
                    if (needRefSize) {
                        ns.$transTaskListCached["Static:viewSize"] = ns._designer.refreshViewSize(result.ok)
                    }
                    if (needRef) {
                        ns.$transTaskListCached["Instance:iniComponents"] = ns._designer.refreshView(result.ok)
                    }
                    ns.paneCode.setDockIgnore(true).setLeft(-10000).setVisibility("hidden").setZIndex(1);
                    ns.paneDesign.setDisplay("").setVisibility("visible").setZIndex(100).reLayout(true);
                    ns._designer.reLayout(true)
                }
            }
            ns._once = false
        },
        _disable: function () {
            var ns = this;
            var id = ns.KEY + ":" + ns.$xid + ":progress";
            _.resetRun(id, function () {
                if (!ns.__disabledUI) {
                    ns.codeeditor.setReadonly(true);
                    ns.toolbar4.setDisabled(true);
                    ns.treebarClass.setDisabled(true);
                    if (ns.imgProgress) {
                        ns.imgProgress.setDisplay("")
                    }
                    ns.__disabledUI = true
                }
            })
        },
        _enable: function () {
            var ns = this;
            var id = ns.KEY + ":" + ns.$xid + ":progress";
            _.resetRun(id);
            delete ns.__disabledUI;
            ns.codeeditor.setReadonly(false);
            ns.toolbar4.setDisabled(false);
            ns.treebarClass.setDisabled(false);
            if (ns.imgProgress) {
                ns.imgProgress.setDisplay("none")
            }
        },
        checkRenderStatus: function (ns) {
            if (ns._renderStatus && ns.$transTaskList && ns.$transTaskList.length) {
                var fun = ns.$transTaskList.shift();
                _.tryF(fun)
            }
        },
        _codeeditor_onrender: function (profile, finished) {
            var ns = this;
            if (finished) {
                var id = ns.KEY + ":" + ns.$xid + ":rebuildNS";
                _.resetRun(id, function () {
                    ns._rebuildNameSpace()
                }, 1000);
                ns._enable();
                if (!ns.$initializd) {
                    ns.$tasksthread = xui.Thread.repeat(function () {
                        try {
                            ns.checkRenderStatus(ns)
                        } catch (e) {}
                    }, 100);
                    ns.$tasksthread.start();
                    ns.$initializd = true;
                    ns.showPage(ns.$dftpage);
                    ns.fireEvent("afterRendered")
                }
            } else {
                ns._disable()
            }
            ns._renderStatus = !! finished
        },
        _codeeditor_onChange: function (profile) {
            var ns = this;
            ns._dynamicDirty = 1;
            ns._dirty = true;
            ns.fireEvent("onValueChanged", [ns, true])
        },
        _codeeditor_onsave: function (profile) {
            var ns = this;
            ns.fireEvent("onCommandSave", [ns])
        },
        _treebarclass_onitemselected: function (profile, item, node) {
            var ns = this,
                arr = item.id.split(".");
            ns.tryToLocale(arr)
        },
        addCodeToEditor: function (pkey, key, code, isFun) {
            var ns = this,
                editor = this.codeeditor;
            editor.addCodeInto(pkey, key, code, isFun)
        },
        tryToLocale: function (arr) {
            var ns = this,
                editor = this.codeeditor;
            editor.locateTo(arr[0], arr[1])
        },
        _toolbar_onclick: function (profile, item, grp, e, src) {
            var ns = this,
                editor = this.codeeditor,
                pos = xui.use(src).offset();
            switch (item.id) {
            case "indentall":
                editor.reindent();
                break;
            case "searchreplace":
                RAD.EditorTool.showFindWnd(editor, pos);
                break;
            case "jumpto":
                RAD.EditorTool.showJumpToWnd(editor, pos);
                break;
            case "outline":
                ns.layoutFill.updateItem("before", {
                    hidden: !item.value
                });
                break
            }
        }
    }
});
Class("RAD.EditorTool", null, {
    Static: {
        getDoc: function (key) {
            if (!key) {
                return ""
            }
            if (key.indexOf("(") != -1) {
                key = key.replace(/[()]/g, "")
            }
            var o = xui.getRes("doc." + key);
            try {
                if (typeof o == "string") {
                    var obj = _.get(window, key.split("."));
                    if (obj && obj.$original$) {
                        o = xui.getRes("doc." + obj.$original$ + ((obj.$type$ == "instance" || obj.$type$ == "event") ? ".prototype" : "") + "." + obj.$name$)
                    }
                    if (typeof o == "string") {
                        return null
                    }
                }
                return this._buildDoc(o)
            } catch (e) {
                return null
            }
        },
        _buildDoc: function (o) {
            var arr = [];
            if (o) {
                if (o.$desc) {
                    arr.push('<div class="doc-inndiv">' + o.$desc + "</div>")
                }
                if (o.$rtn) {
                    arr.push('<div class="doc-inndiv"><strong>' + xui.getRes("app.retV") + ": </strong>" + o.$rtn + "</div>")
                }
                if (o.$paras) {
                    arr.push('<div class="doc-inndiv"><div><strong>' + xui.getRes("app.param") + ": </strong></div><ul>");
                    _.arr.each(o.$paras, function (v) {
                        v = v.replace(/^([^:\[]*)([^:]*):(.*)$/, "<strong>$1</strong> $2 : $3");
                        arr.push("<li> " + v + " </li>")
                    });
                    arr.push("</ul></div>")
                }
                if (o.$snippet) {
                    arr.push('<div class="doc-inndiv"><div><strong>' + xui.getRes("app.codesnip") + ": </strong></div>");
                    _.arr.each(o.$snippet, function (v) {
                        arr.push('<textarea id="doc:code" class="js plain fold" style="display:none;">' + v + "</textarea><p>&nbsp;</p>")
                    });
                    arr.push("</div>")
                }
                if (o.$memo) {
                    arr.push('<div class="doc-inndiv"><strong>' + xui.getRes("app.memo") + ": </strong>" + o.$memo + "</div>")
                }
                if (o.$links) {
                    arr.push('<div class="doc-inndiv"><div><strong>' + xui.getRes("app.seealso") + ": </strong></div><ul>");
                    _.arr.each(o.$links, function (v) {
                        arr.push('<li><a target="' + (v[2] || "") + '" href="' + v[1] + '">' + v[0] + "</a></li>")
                    });
                    arr.push("</ul></div>")
                }
            }
            return arr.join("")
        },
        showFindWnd: function (editor, pos) {
            xui.ComFactory.getCom("RAD.FAndR", function () {
                this._editor = editor;
                this.show(null, null, null, null, pos.left, pos.top)
            })
        },
        showJumpToWnd: function (editor, pos) {
            xui.ComFactory.getCom("RAD.JumpTo", function () {
                this.setEvents({
                    onOK: function (line) {
                        try {
                            editor.callEditor("focus");
                            editor.callEditor("setCursor", [line - 1, 0], true)
                        } catch (e) {}
                    }
                });
                this.show(null, null, null, null, pos.left, pos.top)
            })
        }
    }
});
Class("RAD.EditorTheme", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog()).setHost(host, "dlg").setLeft(20).setTop(50).setWidth(608).setHeight(370).setCaption("$RAD.editorTheme.name").setMinBtn(false).setMaxBtn(false));
            host.dlg.append((new xui.UI.Button()).setHost(host, "btnOK").setLeft(440).setTop(300).setWidth(90).setCaption("$RAD.ok").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            host.dlg.append((new xui.UI.Button()).setHost(host, "ctl_sbutton13").setLeft(290).setTop(300).setWidth(90).setCaption("$RAD.cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.dlg.append((new xui.UI.Block()).setHost(host, "codePreview").setLeft(170).setTop(10).setWidth(420).setHeight(280).setBorderType("inset").setBackground("#FFFFFF"));
            host.dlg.append((new xui.UI.Panel()).setHost(host, "ctl_panel4").setDock("none").setLeft(10).setTop(10).setWidth(150).setHeight(220).setZIndex(1).setCaption("$RAD.editorTheme.selTheme"));
            host.ctl_panel4.append((new xui.UI.List()).setHost(host, "_ctl_theme").setDirtyMark(false).setItems([{
                id: "default",
                caption: "default"
            }, {
                id: "3024-day",
                caption: "3024-day"
            }, {
                id: "3024-night",
                caption: "3024-night"
            }, {
                id: "ambiance",
                caption: "ambiance"
            }, {
                id: "base16-dark",
                caption: "base16-dark"
            }, {
                id: "base16-light",
                caption: "base16-light"
            }, {
                id: "blackboard",
                caption: "blackboard"
            }, {
                id: "cobalt",
                caption: "cobalt"
            }, {
                id: "eclipse",
                caption: "eclipse"
            }, {
                id: "elegant",
                caption: "elegant"
            }, {
                id: "erlang-dark",
                caption: "erlang-dark"
            }, {
                id: "lesser-dark",
                caption: "lesser-dark"
            }, {
                id: "mbo",
                caption: "mbo"
            }, {
                id: "midnight",
                caption: "midnight"
            }, {
                id: "monokai",
                caption: "monokai"
            }, {
                id: "neat",
                caption: "neat"
            }, {
                id: "night",
                caption: "night"
            }, {
                id: "paraiso-dark",
                caption: "paraiso-dark"
            }, {
                id: "paraiso-light",
                caption: "paraiso-light"
            }, {
                id: "rubyblue",
                caption: "rubyblue"
            }, {
                id: "solarized dark",
                caption: "solarized dark"
            }, {
                id: "solarized light",
                caption: "solarized light"
            }, {
                id: "the-matrix",
                caption: "the-matrix"
            }, {
                id: "tomorrow-night-eighties",
                caption: "tomorrow-night-eighties"
            }, {
                id: "twilight",
                caption: "twilight"
            }, {
                id: "vibrant-ink",
                caption: "vibrant-ink"
            }, {
                id: "xq-dark",
                caption: "xq-dark"
            }, {
                id: "xq-light",
                caption: "xq-light"
            }]).setDock("fill").setBorderType("none").setValue("elegant").afterValueSet("_ctl_theme_aftervalueset"));
            host.dlg.append((new xui.UI.Panel()).setHost(host, "ctl_panel7").setDock("none").setLeft(10).setTop(230).setWidth(150).setHeight(61).setZIndex(1).setCaption("$RAD.editorTheme.selFontSize"));
            host.ctl_panel7.append((new xui.UI.ComboInput()).setHost(host, "_ctl_fs").setDirtyMark(false).setLeft(20).setTop(4).setWidth(60).setZIndex(1003).setType("spin").setPrecision(0).setIncrement(1).setMin(1).setMax(100).afterValueSet("_ctl_fs_aftervalueset"));
            host.ctl_panel7.append((new xui.UI.SLabel()).setHost(host, "ctl_slabel5").setLeft(90).setTop(8).setWidth(14).setZIndex(1003).setCaption("px"));
            return children
        },
        _btnok_onclick: function (profile, e, src, value) {
            this.fireEvent("onOK", [this._theme, this._fontsize], this);
            this.dlg.close()
        },
        _btncancel_onclick: function (profile, e, src, value) {
            this.dlg.close()
        },
        customAppend: function (parent) {
            var ns = this,
                fontsize = parseInt(xui.CSS.$getCSSValue(".codemirror", "fontSize"), 10) || 13,
                theme = "default";
            if (CONF.serviceType == "node-webkit") {
                var obj = NW.getStatus();
                if (obj) {
                    if (_.isFinite(obj.editorFontSize)) {
                        fontsize = obj.editorFontSize
                    }
                    if (obj.editorTheme) {
                        theme = obj.editorTheme
                    }
                }
            }
            ns._ctl_fs.setUIValue(ns._fontsize = fontsize);
            ns._ctl_theme.setUIValue(ns._theme = theme);
            ns.dlg.showModal(parent);
            return false
        },
        _refreshCode: function () {            
            var ns = this,
                id = "cm-theme-" + ns._theme,
                path = "template/" + xui.getLang() + "/index.js";
            if (ns._theme != "default" && !xui.CSS.get("id", id)) {
                xui.CSS.includeLink("codemirror3/theme/" + ns._theme + ".css", false, id)
            }
            debugger;
            CONF.getLocalFile(path, function (code) {
                code = code.replace("{className}", "className");
                ns.codePreview.getSubNode("PANEL").html("", true);
                var cm = new CodeMirror(function (elt) {
                    ns.codePreview.getSubNode("PANEL").append(elt);
                    elt.style.fontSize = ns._fontsize + "px"
                }, {
                    theme: ns._theme,
                    readOnly: true,
                    value: code
                })
            }, function () {
                alert(xui.getRes("RAD.builder.noexist", path))
            })
        },
        _ctl_fs_aftervalueset: function (prf) {
            var ns = this;
            ns._fontsize = prf.boxing().getValue();
            _.resetRun(this.$xid, function () {
                ns._refreshCode()
            }, 100)
        },
        _ctl_theme_aftervalueset: function (prf) {
            var ns = this;
            ns._theme = prf.boxing().getValue();
            _.resetRun(this.$xid, function () {
                ns._refreshCode()
            }, 100)
        }
    }
});
Class("RAD.ObjectEditor", "xui.Com", {
    Instance: {
        $PageEditor: null,
        activate: function () {
            this.$PageEditor.activate()
        },
        setValue: function (text) {
            this.$PageEditor.setValue(text || "")
        },
        _dialog_beforeclose: function (profile) {
            this.dialog.hide();
            return false
        },
        _btncancel_onclick: function () {
            this.setValue("");
            this.dialog.close()
        },
        _btnok_onclick: function () {
            var self = this,
                prop = self.properties,
                txt = self.$PageEditor.getValue();
            if (txt === false) {
                return false
            }
            if ((prop.text || "") != (txt || "")) {
                var result = RAD.CodeEditor.evalInSandbox(txt, true);
                if (result.ko) {
                    xui.message(xui.getRes("RAD.JSEditor.codeerr"));
                    return false
                }
                prop.result = RAD.ClassTool.parseSingleBlock(txt);
                if (false === prop.result) {
                    xui.message(xui.getRes("RAD.classtool.err1"));
                    return false
                }
                prop.object = _.unserialize(txt) || null;
                _.tryF(prop.onOK, [self], self.host)
            }
            self.setValue(prop.text = "");
            self.dialog.close()
        },
        customAppend: function (parent) {
            var page = this,
                prop = page.properties,
                dlg = page.dialog;
            dlg.setCaption(prop.caption).setImage(prop.image).setImagePos(prop.imagePos);
            if (prop.fromRegion) {
                dlg.setFromRegion(prop.fromRegion)
            }
            if (!page.$PageEditor) {
                var pe = new RAD.PageEditor;
                pe.setHost(page, "$PageEditor");
                pe.setJSON(true);
                page.panelMain.append(pe)
            }
            page.setValue(prop.text || "");
            dlg.showModal(parent)
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(70).setTop(40).setWidth(500).setCaption("dialog").setMinBtn(false).setMaxBtn(false).beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Block).setHost(host, "panelMain").setDock("fill").setBorderType("inset"));
            host.dialog.append((new xui.UI.Pane).setHost(host, "panelB").setDock("bottom").setHeight(35));
            host.panelB.append((new xui.UI.Pane).setHost(host, "panelR").setDock("right").setWidth(284));
            host.panelR.append((new xui.UI.Button).setHost(host, "btnCancel").setLeft(64).setTop(8).setWidth(100).setCaption("Cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.panelR.append((new xui.UI.Button).setHost(host, "btnOK").setLeft(176).setTop(8).setWidth(100).setCaption("OK").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            return children
        }
    }
});
Class("RAD.FileSelector", "xui.Com", {
    Instance: {
        customAppend: function (parent) {
            var self = this,
                prop = self.properties,
                pp = prop.parent,
                dlg = self.dialog;
            if (prop.fromRegion) {
                dlg.setFromRegion(prop.fromRegion)
            }
            if (!dlg.get(0).renderId) {
                dlg.render()
            }
            self.treebar.resetValue();
            dlg.show(parent, true);
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "open",
                    hashCode: _.id(),
                    path: SPA.curProject
                }
            }, function (txt) {
                var obj = txt;
                if (!obj || obj.error) {
                    xui.message(_.get(obj, ["error", "message"]) || "no response!")
                } else {
                    var root = SPA.buildFileItems(SPA.curProject, obj.data);
                    self.treebar.setItems([root]).toggleNode(root.id, true)
                }
            })
        },
        _dialog_beforeclose: function (profile) {
            this.dialog.hide();
            return false
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(247).setTop(120).setWidth(433).setHeight(220).setResizer(false).setCaption("$RAD.selFile").setImage("@CONF.img_app").setImagePos("-176px 0px").setMinBtn(false).setMaxBtn(false).onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Button).setHost(host, "btnCancel").setLeft(80).setTop(150).setWidth(90).setCaption("$RAD.cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.dialog.append((new xui.UI.Button).setHost(host, "btnOK").setLeft(250).setTop(150).setWidth(90).setCaption("$RAD.ok").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            host.dialog.append((new xui.UI.Group).setHost(host, "panelbar2").setDock("top").setHeight(140).setCaption("$RAD.selFilePath").setToggleBtn(false).setCustomStyle({
                PANEL: "overflow:auto"
            }));
            host.panelbar2.append((new xui.UI.TreeView).setHost(host, "treebar").setDock("none").setWidth("auto").setHeight("auto").setPosition("relative").setSelMode("single").beforeUIValueSet("_treebar_beforevalueupdated").onGetContent("_treebar_ongetcontent").onClick("_treebar_onclick"));
            return children
        },
        _btncancel_onclick: function (profile, e, value) {
            this.dialog.close()
        },
        _btnok_onclick: function (profile, e, value) {
            var s = this.treebar.getUIValue(),
                self = this;
            if (s) {
                _.tryF(self.properties.onOK, [this, s], self.host);
                self.dialog.close()
            }
        },
        _treebar_beforevalueupdated: function (profile, oldValue, newValue) {
            if (newValue) {
                var file = newValue.split("/").pop();
                if (file.indexOf(".") == -1) {
                    return false
                }
            } else {
                return false
            }
        },
        _dialog_onhotkey: function (profile, key) {
            if (key.key == "esc") {
                profile.boxing().close()
            }
        },
        _treebar_ongetcontent: function (profile, item, callback) {
            var ns = this;
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "open",
                    hashCode: _.id(),
                    path: item.id
                }
            }, function (txt) {
                var obj = txt;
                if (obj && !obj.error) {
                    var root = SPA.buildFileItems(item.id, obj.data);
                    callback(root.sub)
                } else {
                    xui.message(obj.error.message)
                }
            })
        },
        _treebar_onclick: function (profile, item, e, src) {
            if (item.sub) {
                profile.boxing().toggleNode(item.id)
            }
        }
    }
});
Class("RAD.HTMLEditor", "xui.Com", {
    Instance: {
        activate: function () {
            this.rInput.activate()
        },
        setValue: function (text) {
            this.rInput.setValue(text, true)
        },
        _dialog_beforeclose: function (profile) {
            this.dialog.hide();
            return false
        },
        _btncancel_onclick: function () {
            this.setValue("", true);
            this.dialog.close()
        },
        _btnok_onclick: function () {
            var self = this,
                prop = self.properties,
                txt = self.rInput.getUIValue();
            if (txt === false) {
                return false
            }
            if (prop.text != txt) {
                _.tryF(prop.onOK, [self, txt], self.host)
            }
            self.setValue(prop.text = "", true);
            self.dialog.close()
        },
        customAppend: function (parent) {
            var page = this,
                prop = page.properties,
                dlg = page.dialog;
            dlg.setCaption(prop.caption).setImage(prop.image).setImagePos(prop.imagePos);
            if (prop.fromRegion) {
                dlg.setFromRegion(prop.fromRegion)
            }
            page.setValue(prop.text || "", true);
            dlg.showModal(parent)
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(70).setTop(40).setWidth(500).setCaption("dialog").setMinBtn(false).setMaxBtn(false).beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Block).setHost(host, "panelMain").setDock("fill").setBorderType("inset").setBackground("#fff"));
            host.panelMain.append((new xui.UI.RichEditor).setHost(host, "rInput").setDock("fill"));
            host.dialog.append((new xui.UI.Pane).setHost(host, "panelB").setDock("bottom").setHeight(35));
            host.panelB.append((new xui.UI.Pane).setHost(host, "panelR").setDock("right").setWidth(284));
            host.panelR.append((new xui.UI.Button).setHost(host, "btnCancel").setLeft(64).setTop(8).setWidth(100).setCaption("Cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.panelR.append((new xui.UI.Button).setHost(host, "btnOK").setLeft(176).setTop(8).setWidth(100).setCaption("OK").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            return children
        }
    }
});
Class("RAD.ProjectPro", "xui.Com", {
    Instance: {
        _template: "Blank",
        events: {
            onReady: "_onReady"
        },
        customAppend: function () {
            var self = this,
                prop = self.properties;
            self.inputName.setValue(prop.projectName, true);
            self._refreshLabel(prop.projectName);
            if (prop.fromRegion) {
                self.dialog.setFromRegion(prop.fromRegion)
            }
            self.inputName.setDisabled(prop.readonly);
            self.listTemplate.setValue(self._template = "Blank", true);
            self.dialog.show(self.parent, true)
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(100).setTop(30).setWidth(522).setHeight(382).setResizer(false).setOverflow("visible").setCaption("$RAD.dialog.newone").setImage("@CONF.img_app").setImagePos("-32px top").setMinBtn(false).setMaxBtn(false).onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Button).setHost(host, "btnCancel").setLeft(262).setTop(324).setWidth(90).setTabindex("0").setCaption("$RAD.cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.dialog.append((new xui.UI.SLabel).setHost(host, "label2").setLeft(10).setTop(289).setWidth(88).setCaption("$RAD.projectPro.pagefile"));
            host.dialog.append((new xui.UI.SLabel).setHost(host, "label1").setLeft(10).setTop(226).setWidth(88).setCaption("$RAD.projectPro.name"));
            host.dialog.append((new xui.UI.SLabel).setHost(host, "label3").setLeft(10).setTop(253).setWidth(88).setCaption("$RAD.projectPro.classfile"));
            host.dialog.append((new xui.UI.Gallery).setHost(host, "listTemplate").setDirtyMark(false).setLeft(10).setTop(30).setWidth(490).setHeight(180).setItemWidth(80).setItemHeight(92).setImgWidth(64).setImgHeight(64).onDblclick("_listtempl_ondblclick").onItemSelected("_listtempl_onitemsel"));
            host.dialog.append((new xui.UI.Input).setHost(host, "inputName").setLeft(110).setTop(220).setWidth(390).setTipsErr("$RAD.projectPro.onlyword").setValueFormat("^\\w{3,120}$").afterUIValueSet("_inputname_aftervalueupdated"));
            host.dialog.append((new xui.UI.SLabel).setHost(host, "label8").setLeft(110).setTop(253).setWidth(384).setHeight(32).setCaption("label8").setHAlign("left").setCustomStyle({
                KEY: "overflow:auto"
            }).setCustomClass({
                KEY: "uiborder-inset"
            }));
            host.dialog.append((new xui.UI.Button).setHost(host, "btnOK").setLeft(374).setTop(324).setWidth(90).setCaption("$RAD.ok").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            host.dialog.append((new xui.UI.SLabel).setHost(host, "slabel13").setLeft(20).setTop(10).setWidth(274).setCaption("$RAD.projectPro.template").setHAlign("left"));
            host.dialog.append((new xui.UI.SLabel).setHost(host, "label7").setLeft(110).setTop(289).setWidth(384).setHeight(32).setCaption("label7").setHAlign("left").setCustomStyle({
                KEY: "overflow:auto"
            }).setCustomClass({
                KEY: "uiborder-inset"
            }));
            return children
        },
        _dialog_beforeclose: function (profile) {
            this.dialog.hide();
            return false
        },
        _btncancel_onclick: function () {
            this.dialog.close()
        },
        _btnok_onclick: function () {
            var self = this;
            if (self.inputName.checkValid() === false) {
                xui.message(xui.getRes("RAD.projectPro.invalid"));
                return
            }
            self.projectName = self.inputName.updateValue().getValue();
            self._buildApp()
        },
        _buildApp: function () {
            var self = this;
            CONF.callService({
                key: CONF.requestKey2,
                paras: {
                    action: "buildWizard",
                    hashCode: _.id(),
                    lang: xui.getLang(),
                    path: self._template == "Blank" ? "" : self._template,
                    paras: {
                        pathName: self.projectName,
                        className: "App"
                    }
                }
            }, function (txt) {
                var obj = txt;
                if (obj.error) {
                    xui.alert(obj.error.message)
                } else {
                    _.tryF(self.properties.onOK, [CONF.prjPath + "/" + self.projectName, obj.data], self.host);
                    self.dialog.setFromRegion(null).close()
                }
            }, function (txt) {
                xui.message(txt)
            })
        },
        _inputname_aftervalueupdated: function (profile, oldValue, newValue) {
            this._refreshLabel(newValue)
        },
        _refreshLabel: function (prjname, filename) {
            var self = this;
            filename = filename || "index";
            self.label7.setCaption(CONF.prjPath + "/" + prjname + "/" + filename + ".html");
            var mjs = CONF.prjPath + "/" + prjname + "/App/js/" + filename + ".js";
            self.label8.setCaption(mjs)
        },
        _dialog_onhotkey: function (profile, key) {
            if (key.key == "esc") {
                profile.boxing().close()
            }
        },
        _onReady: function () {
            var self = this;
            self.listTemplate.setItems([{
                id: "Blank",
                caption: null,
                comment: "Blank Template"
            }]);
            CONF.callService({
                key: CONF.requestKey2,
                paras: {
                    action: "getWizardList",
                    hashCode: _.id()
                }
            }, function (txt) {
                var obj = txt;
                if (!obj || obj.error) {
                    xui.message(_.get(obj, ["error", "message"]) || "no response!")
                } else {
                    obj = obj.data;
                    if (obj && obj.length) {
                        self.listTemplate.insertItems(obj)
                    }
                }
            }, function (msg) {
                xui.message(msg)
            })
        },
        _listtempl_onitemsel: function (profile, item) {
            var ns = this,
                id = item.id;
            ns._template = id;
            if (item.id == "Blank") {
                ns.inputName.setUIValue(ns.properties.projectName, true)
            } else {
                ns.inputName.setUIValue("My" + item.id, true)
            }
        }
    }
});
Class("RAD.ProjectSelector", "xui.Com", {
    Instance: {
        customAppend: function () {
            var self = this,
                dlg = self.dialog,
                prop = self.properties;
            self.listName.setItems([]).setUIValue("", true);
            if (prop.fromRegion) {
                dlg.setFromRegion(prop.fromRegion)
            }
            dlg.show(self.parent, true);
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "open",
                    hashCode: _.id(),
                    path: CONF.prjPath,
                    deep: "0"
                }
            }, function (txt) {
                var obj = txt;
                if (!obj || obj.error) {
                    xui.message(_.get(obj, ["error", "message"]) || "no response!")
                } else {
                    obj = obj.data;
                    self.properties.projectList = [];
                    if (obj && obj.length) {
                        _.arr.each(obj, function (i) {
                            if (i.type === 0) {
                                self.properties.projectList.push({
                                    id: i.location,
                                    caption: i.name
                                })
                            }
                        })
                    }
                    self.listName.setItems(prop.projectList)
                }
            }, function (msg) {
                xui.message(msg)
            })
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(90).setTop(40).setWidth(360).setHeight(270).setOverflow("visible").setCaption("$RAD.dialog.select").setImage("@CONF.img_app").setImagePos("-48px top").setMinBtn(false).setMaxBtn(false).onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.List).setHost(host, "listName").setDirtyMark(false).setDock("fill").onDblclick("_listname_ondblclick"));
            host.dialog.append((new xui.UI.Pane).setHost(host, "ctl_pane68").setDock("bottom").setHeight(40).setOverflow("visible"));
            host.ctl_pane68.append((new xui.UI.Button).setHost(host, "btnCancel").setTop(12).setWidth(90).setRight(120).setZIndex("1").setCaption("$RAD.cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.ctl_pane68.append((new xui.UI.Button).setHost(host, "btnOK").setTop(12).setWidth(90).setRight(20).setZIndex("1").setCaption("$RAD.ok").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            return children
        },
        _btncancel_onclick: function () {
            this.dialog.close()
        },
        _btnok_onclick: function () {
            var self = this,
                pm = self.projectName = self.listName.getUIValue();
            if (!self.projectName) {
                xui.message(xui.getRes("RAD.ps.noselected"));
                return
            }
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "open",
                    hashCode: _.id(),
                    path: this.projectName
                }
            }, function (txt) {
                var obj = txt;
                if (!obj || obj.error) {
                    xui.message(_.get(obj, ["error", "message"]) || "no response!")
                } else {
                    _.tryF(self.properties.onOK, [pm, obj.data], self.host)
                }
                self.dialog.close()
            })
        },
        _dialog_beforeclose: function (profile) {
            this.dialog.hide();
            return false
        },
        _dialog_onhotkey: function (profile, key) {
            if (key.key == "esc") {
                profile.boxing().close()
            }
        },
        _listname_ondblclick: function (profile, item, src) {
            this.btnOK.onClick()
        }
    }
});
Class("RAD.Designer", "xui.Com", {
    Constructor: function () {
        arguments.callee.upper.apply(this, arguments);
        this.$host = {}
    },
    Instance: {
        $viewSize: {
            "800": {
                width: 800,
                height: 600
            },
            "1024": {
                width: 1024,
                height: 768
            },
            "1280": {
                width: 1280,
                height: 1024
            }
        },
        dropOffset: 10,
        events: {
            onSelected: function (page, profile, ids) {
                var v = null,
                    id = ids && ids[ids.length - 1];
                if (id) {
                    var o = xui.getObject(id);
                    if (o) {
                        v = o
                    }
                }
                page.listObject.setUIValue(v ? v.alias : "com", true);
                _.resetRun("$profilegrid$", page._refreshProfileGrid, 0, [ids], page);
                page.resizer.setConfigBtn(ids && ids.length == 1);
                page.resizer.setTag(ids[0])
            },
            onReady: function (page) {
                var tbpath = xui.getPath("img/designer/", "toolbar.gif"),
                    tbk = "$RAD.designer.tool.",
                    showRefresh = CONF.designer_editMode != "simple";
                page.$canvasMenuItems = [{
                    id: "code",
                    level: 1,
                    maybecanvas: true,
                    sub: [{
                        id: "viewsize",
                        type: "button",
                        dropButton: true,
                        caption: "800 &#215 600",
                        tips: tbk + "viewsize"
                    }, {
                        id: "refresh",
                        image: showRefresh ? CONF.img_app : null,
                        imagePos: showRefresh ? "-112px -16px" : null,
                        type: showRefresh ? "button" : "split",
                        tips: showRefresh ? (tbk + "refresh") : null
                    }, {
                        id: "format",
                        image: CONF.img_app,
                        imagePos: "-32px -48px",
                        type: "button",
                        tips: tbk + "tocode"
                    }, {
                        id: "json",
                        image: CONF.img_app,
                        imagePos: "-128px -64px",
                        type: "button",
                        tips: tbk + "tojson"
                    }]
                }, {
                    id: "align",
                    level: 2,
                    caption: tbk + "aligngroup",
                    sub: [{
                        id: "left",
                        caption: "",
                        image: tbpath,
                        imagePos: "0 top",
                        tips: tbk + "left"
                    }, {
                        id: "center",
                        caption: "",
                        image: tbpath,
                        imagePos: "-16px top",
                        tips: tbk + "center"
                    }, {
                        id: "right",
                        caption: "",
                        image: tbpath,
                        imagePos: "-32px top",
                        tips: tbk + "right"
                    }, {
                        id: "s1",
                        type: "split"
                    }, {
                        id: "top",
                        caption: "",
                        image: tbpath,
                        imagePos: "-48px top",
                        tips: tbk + "top"
                    }, {
                        id: "middle",
                        caption: "",
                        image: tbpath,
                        imagePos: "-64px top",
                        tips: tbk + "middle"
                    }, {
                        id: "bottom",
                        caption: "",
                        image: tbpath,
                        imagePos: "-80px top",
                        tips: tbk + "bottom"
                    }, {
                        id: "s2",
                        type: "split"
                    }, {
                        id: "w",
                        caption: "",
                        image: tbpath,
                        imagePos: "-96px top",
                        tips: tbk + "width"
                    }, {
                        id: "wh",
                        caption: "",
                        image: tbpath,
                        imagePos: "-112px top",
                        tips: tbk + "wh"
                    }, {
                        id: "h",
                        caption: "",
                        image: tbpath,
                        imagePos: "-128px top",
                        tips: tbk + "height"
                    }]
                }, {
                    id: "pos",
                    level: 2,
                    caption: tbk + "posgroup",
                    sub: [{
                        id: "zindex1",
                        caption: "",
                        image: tbpath,
                        imagePos: "-144px top",
                        tips: tbk + "toplayer"
                    }, {
                        id: "zindex2",
                        caption: "",
                        image: tbpath,
                        imagePos: "-160px top",
                        tips: tbk + "bottomlayer"
                    }, {
                        id: "s1",
                        type: "split"
                    }, {
                        id: "repos",
                        caption: "",
                        image: tbpath,
                        imagePos: "-176px top",
                        tips: tbk + "gridxy"
                    }, {
                        id: "resize",
                        caption: "",
                        image: tbpath,
                        imagePos: "-192px top",
                        tips: tbk + "gridwh"
                    }]
                }, {
                    id: "copyclone",
                    level: 1,
                    sub: [{
                        id: "copy",
                        caption: "",
                        image: tbpath,
                        imagePos: "-289px top",
                        tips: tbk + "copy"
                    }, {
                        id: "clone",
                        caption: "",
                        image: tbpath,
                        imagePos: "-241px top",
                        tips: tbk + "clone"
                    }, {
                        id: "cut",
                        caption: "",
                        image: tbpath,
                        imagePos: "-305px top",
                        tips: tbk + "cut"
                    }, {
                        id: "delete",
                        caption: "",
                        image: tbpath,
                        imagePos: "-257px top",
                        tips: tbk + "delete"
                    }]
                }, {
                    id: "pastefun",
                    maybecanvas: true,
                    level: 1,
                    sub: [{
                        id: "paste",
                        caption: "",
                        image: tbpath,
                        imagePos: "-273px top",
                        tips: tbk + "paste"
                    }]
                }];
                page.$canvasMenuItems1 = [{
                    id: "800",
                    viewsize: true,
                    caption: "800 &#215 600"
                }, {
                    id: "1024",
                    viewsize: true,
                    caption: "1024 &#215 768"
                }, {
                    id: "1280",
                    viewsize: true,
                    caption: "1280 &#215 1024"
                }];
                page.popViewSize.setItems(page.$canvasMenuItems1);
                page.toolbar.setItems(page.$canvasMenuItems);
                if (typeof CONF.customDesingerOnReady == "function") {
                    CONF.customDesingerOnReady(page)
                }
            },
            onRender: function (page) {
                var _refresh = page._refresh = function (obj, key, region) {
                        var profile = obj.get(0),
                            fn = "set" + _.str.initial(key),
                            t;
                        if (_.isFun(obj[fn])) {
                            if (profile.renderId) {
                                if (region && region[key]) {
                                    obj.getRoot()[key + "By"](region[key], true)
                                }
                                var t = parseInt(profile.getRoot().css(key)) || 0
                            } else {
                                t = profile.properties[key]
                            }
                            obj[fn](t)
                        }
                        var v = obj["get" + _.str.initial(key)]();
                        if (xui.UI.$ps[key]) {
                            t = parseInt(profile.getRoot().css(key)) || 0;
                            if (t != v) {
                                if ((t = profile.parent) && t.reSelectObject && page.tempSelected && _.arr.indexOf(page.tempSelected, profile.$xid) != -1) {
                                    _.resetRun(":" + page.tempSelected.join(":"), function () {
                                        if (!profile.box) {
                                            return
                                        }
                                        if (page.tempSelected.length > 1) {
                                            t.reSelectObject.call(t, profile, profile.getRoot().parent())
                                        } else {
                                            t.selectObject.call(t, profile, profile.getRoot().parent())
                                        }
                                    })
                                }
                            }
                        }
                        return v
                    };
                page.holder = xui.create('<div style="display:none;"></div>');
                page.panelDiv.reBoxing().append(page.holder);
                page._createResizer();
                page.treebarCom.setItems(_.clone(CONF.widgets)).setCustomBehavior({
                    BAR: {
                        beforeMousedown: function (profile, e, src) {
                            if (xui.Event.getBtn(e) != "left") {
                                return
                            }
                            if (profile.properties.disabled) {
                                return
                            }
                            if (!profile.properties.dragKey) {
                                return
                            }
                            if (profile.behavior.NoDraggableKeys) {
                                var sk = profile.getKey(xui.Event.getSrc(e).id || "").split("-")[1];
                                if (sk && _.arr.indexOf(profile.behavior.NoDraggableKeys, sk) != -1) {
                                    return
                                }
                            }
                            var id = xui.use(src).id(),
                                itemId = profile.getSubId(id),
                                properties = profile.properties,
                                item = profile.getItemByDom(id),
                                pos = xui.Event.getPos(e);
                            if (item.draggable) {
                                profile.getSubNode("ITEMICON", itemId).startDrag(e, {
                                    dragType: "icon",
                                    shadowFrom: src,
                                    dragCursor: "pointer",
                                    targetLeft: pos.left + 12,
                                    targetTop: pos.top + 12,
                                    dragKey: item.dragKey || profile.properties.dragKey,
                                    dragData: {
                                        type: item.key,
                                        iniProp: item.iniProp,
                                        customRegion: item.customRegion,
                                        image: item.image,
                                        imagePos: item.imagePos
                                    }
                                });
                                xui.use(src).tagClass("-mouseover", false);
                                page._clearSelect();
                                page._setSelected([], true)
                            }
                        }
                    }
                }).toggleNode("xui.UI.absForm", true);
                page.focusBtn = xui.create('<a href="javascript;" style="position:absolute;left:-10000px;top:-10000px;width:1px;height:1px;">o</a>');
                page.focusBtn.onKeydown(function (pro, e) {
                    if (!page.resizer) {
                        return
                    }
                    var key = xui.Event.getKey(e),
                        k = key.key,
                        ctrl = key.ctrlKey,
                        shift = key.shiftKey,
                        step = 1,
                        o = page.resizer.reBoxing(),
                        profile = page.resizer.get(0),
                        cssPos = o.cssPos(),
                        cssSize = o.cssSize(),
                        gridh = profile.properties.dragArgs.heightIncrement,
                        gridw = profile.properties.dragArgs.widthIncrement;
                    var t, b = false,
                        size = null,
                        pos = null;
                    switch (k) {
                    case "up":
                        b = true;
                        if (ctrl) {
                            step = -1
                        } else {
                            if (shift) {
                                step = (t = (cssPos.top + cssSize.height) % gridh) ? -t : -gridh
                            } else {
                                step = (t = cssPos.top % gridh) ? -t : -gridh
                            }
                        }
                        if (shift) {
                            o.heightBy(step);
                            profile.regions.heightBy(step);
                            size = {
                                width: 0,
                                height: step
                            }
                        } else {
                            o.topBy(step);
                            pos = {
                                left: 0,
                                top: step
                            }
                        }
                        break;
                    case "down":
                        b = true;
                        if (ctrl) {
                            step = 1
                        } else {
                            if (shift) {
                                step = (t = (cssPos.top + cssSize.height) % gridh) ? gridh - t : gridh
                            } else {
                                step = (t = cssPos.top % gridh) ? gridh - t : gridh
                            }
                        }
                        if (shift) {
                            o.heightBy(step);
                            profile.regions.heightBy(step);
                            size = {
                                width: 0,
                                height: step
                            }
                        } else {
                            o.topBy(step);
                            pos = {
                                left: 0,
                                top: step
                            }
                        }
                        break;
                    case "left":
                        b = true;
                        if (ctrl) {
                            step = -1
                        } else {
                            if (shift) {
                                step = (t = (cssPos.left + cssSize.width) % gridw) ? -t : -gridw
                            } else {
                                step = (t = cssPos.left % gridw) ? -t : -gridw
                            }
                        }
                        if (shift) {
                            profile.regions.widthBy(step);
                            o.widthBy(step);
                            size = {
                                width: step,
                                height: null
                            }
                        } else {
                            o.leftBy(step);
                            pos = {
                                left: step,
                                top: 0
                            }
                        }
                        break;
                    case "right":
                        b = true;
                        if (ctrl) {
                            step = 1
                        } else {
                            if (shift) {
                                step = (t = (cssPos.left + cssSize.width) % gridw) ? gridw - t : gridw
                            } else {
                                step = (t = cssPos.left % gridw) ? gridw - t : gridw
                            }
                        }
                        if (shift) {
                            o.widthBy(step);
                            profile.regions.widthBy(step);
                            size = {
                                width: step,
                                height: null
                            }
                        } else {
                            o.leftBy(step);
                            pos = {
                                left: step,
                                top: 0
                            }
                        }
                        break;
                    case "delete":
                        page._deleteSelected();
                        page._focus();
                        break;
                    case "esc":
                        page._clearSelect();
                        page._setSelected([], true);
                        break
                    }
                    if (b) {
                        profile.boxing().onUpdate(profile, profile._target, size, pos);
                        return false
                    }
                }).onFocus(function (pro, e) {
                    clearTimeout(page.timer);
                    page.resizer.active(false)
                }).onBlur(function (pro, e) {
                    page.timer = _.asyRun(function () {
                        if (page.resizer) {
                            page.resizer.inActive()
                        }
                    }, 200)
                });
                page.layoutBase.reBoxing().prepend(page.focusBtn);
                page._giveHandler(page.canvas.get(0), true);
                page._enablePanelDesign(page.canvas.get(0));
                if (typeof CONF.customDesingerOnRender == "function") {
                    CONF.customDesingerOnRender(page)
                }
            },
            onDestroy: function (page) {
                if (page.frame && page.frame.destroy) {
                    page.frame.destroy()
                }
            }
        },
        isDirty: function () {
            return !!this._dirty || !! this._demenstiondirty
        },
        $tryToRefreshSel: function (profile) {
            var page = this,
                t;
            if ((t = profile.parent) && t.reSelectObject && page.tempSelected && _.arr.indexOf(page.tempSelected, profile.$xid) != -1) {
                _.resetRun(":" + page.tempSelected.join(":"), function () {
                    if (!profile.box) {
                        return
                    }
                    if (page.tempSelected.length > 1) {
                        t.reSelectObject.call(t, profile, profile.getRoot().parent())
                    } else {
                        t.selectObject.call(t, profile, profile.getRoot().parent())
                    }
                });
                page.profileGrid.offEditor()
            }
        },
        resetCodeFromDesigner: function (sync) {
            var page = this;
            if (page._demenstiondirty) {
                page.resetCode("Static", "viewSize", _.stringify(page.$curViewSize), !! sync);
                page._demenstiondirty = false
            }
            if (page._dirty) {
                var nodes = page.getWidgets(true);
                var code = ("{\n" + page.getJSCode(nodes)).replace(/\n/g, "\n" + _.str.repeat(" ", 12)) + "\n" + _.str.repeat(" ", 8) + "}";
                page.resetCode("Instance", "iniComponents", code, !! sync, true);
                page._dirty = false
            }
        },
        _inplaceedit: function (prf, nodeKey, multi, conf, node, left, top, w, h) {
            var page = this,
                ismulti = !! conf[0],
                getF = conf[1],
                setF = conf[2],
                itemKey = conf[3],
                item;
            var unFun = function (setV) {
                    if (!inplaceEditor || !inplaceEditor.getSubNode("INPUT")) {
                        return
                    }
                    inplaceEditor.getSubNode("INPUT").onBlur();
                    inplaceEditor.setVisibility("hidden").setLeft(-1000).setValue("", true);
                    xui.Event.keyboardHook("esc")
                };
            if (!page.$inplaceEditor || page.$inplaceEditor.isDestroyed()) {
                page.$inplaceEditor = new xui.UI.ComboInput({
                    type: "none",
                    dirtyMark: false,
                    visibility: "hidden"
                }, {
                    onHotKeydown: function (p, kb) {
                        if (kb.key == "tab" || kb.key == "enter") {
                            unFun();
                            return false
                        }
                    }
                });
                page.canvas.append(page.$inplaceEditor);
                page.$inplaceEditor.render(true)
            }
            var inplaceEditor = page.$inplaceEditor;
            inplaceEditor.afterUIValueSet(function (p, ov, nv) {
                if (ismulti) {
                    if (typeof setF == "function") {
                        setF(prf, item, itemKey, nv)
                    } else {
                        var options = {};
                        options[itemKey || "caption"] = nv;
                        prf.boxing()[setF](item.id, options)
                    }
                } else {
                    prf.boxing()[setF](nv)
                }
                page._change();
                if (page.tempSelected && page.tempSelected.length == 1 && prf.parent && prf.parent.selectObject) {
                    prf.parent.selectObject.call(prf.parent, prf, prf.getRoot().parent())
                }
            });
            var oldV;
            if (ismulti) {
                if (typeof getF == "function") {
                    item = getF(prf, node.get(0))
                } else {
                    item = prf.boxing()[getF](node.get(0).$xid)
                }
                if (item) {
                    oldV = item[itemKey || "caption"] || ""
                } else {
                    return
                }
            } else {
                oldV = prf.boxing()[getF]()
            }
            inplaceEditor.setValue(oldV, true);
            inplaceEditor.setZIndex(xui.Dom.TOP_ZINDEX + 10);
            inplaceEditor.setLeft(left - 1).setTop(top - 1).setWidth(w < 10 ? 10 : (w + 2)).setHeight(h < 20 ? 20 : (h + 2));
            node.setBlurTrigger("design:inplace:editor", unFun);
            xui.Event.keyboardHook("esc", 0, 0, 0, function () {
                inplaceEditor.setValue(oldV, true);
                unFun()
            });
            inplaceEditor.setVisibility("visible").activate()
        },
        _showPopMenu: function (e, flag) {
            var page = this,
                toolbaritems = page.toolbar.getItems(),
                popMenu, items = [];
            _.arr.each(toolbaritems, function (item, i) {
                if (item.hidden) {
                    return
                }
                if (flag && !item.maybecanvas) {
                    return
                }
                if (item.id == "pastefun") {
                    if (!SPA.__copied) {
                        return
                    }
                    var sel = page.tempSelected,
                        ctrl;
                    if (!sel || sel.length == 0 || (sel.length === 1 && (ctrl = page.getByCacheId(sel)) && ctrl.get(0) && ctrl.get(0).boxing().getDropKeys)) {} else {
                        return
                    }
                }
                if (item.level == 1 && i !== 0 && items.length > 0) {
                    items.push({
                        type: "split"
                    })
                }
                if (item.level == 1) {
                    _.arr.each(item.sub, function (subitem) {
                        if (subitem.hidden) {
                            return
                        }
                        if (subitem.id == "viewsize") {
                            items.push({
                                id: item.id,
                                caption: subitem.tips,
                                sub: page.$canvasMenuItems1
                            })
                        } else {
                            if (subitem.type == "split") {
                                items.push({
                                    type: "split"
                                })
                            } else {
                                items.push({
                                    id: subitem.id,
                                    image: subitem.image,
                                    imagePos: subitem.imagePos,
                                    caption: subitem.tips
                                })
                            }
                        }
                    })
                } else {
                    var sub = [];
                    _.arr.each(item.sub, function (subitem) {
                        if (subitem.hidden) {
                            return
                        }
                        if (subitem.type == "split") {
                            sub.push({
                                type: "split"
                            })
                        } else {
                            sub.push({
                                id: subitem.id,
                                image: subitem.image,
                                imagePos: subitem.imagePos,
                                caption: subitem.tips
                            })
                        }
                    });
                    items.push({
                        id: item.id,
                        caption: item.caption,
                        sub: sub
                    })
                }
            });
            popMenu = new xui.UI.PopMenu({
                items: items
            }, {
                onHide: function (p) {
                    p.boxing().destroy()
                },
                onMenuSelected: function (p, item) {
                    if (item.viewsize) {
                        page.popViewSize.fireItemClickEvent(item.id)
                    } else {
                        page.toolbar.fireItemClickEvent(item.id)
                    }
                    p.boxing().hide()
                }
            });
            popMenu.pop(xui.Event.getPos(e))
        },
        _oncanvasmenu: function (profile, e, src) {
            if (xui.Event.getSrc(e) == this.canvas.getRootNode()) {
                this._showPopMenu(e, true);
                return false
            }
        },
        _createResizer: function () {
            var page = this;
            page.proxy = xui.create('<div style="position:absolute;border:dashed 1px blue;overflow:visible;left:-100px;top:-100px;z-index:1000"></div>');
            page.proxy.get(0).zIndexIgnore = true;
            page.holder.append(page.proxy);
            page.resizer = xui.create("AdvResizer", {
                forceMovable: false,
                dragArgs: {
                    widthIncrement: this.dropOffset,
                    heightIncrement: this.dropOffset
                },
                zIndex: xui.Dom.TOP_ZINDEX
            }, {
                onConfig: function (profile, e, src) {
                    var prf = xui.getObject(profile.properties.tag);
                    if (prf) {
                        _.asyRun(function () {
                            if (page.__dblclickctrl) {
                                return
                            }
                            xui.ComFactory.getCom("RAD.CustomDecoration", function () {
                                this.setProperties({
                                    targetProfile: prf
                                });
                                this.setEvents({
                                    onDirty: function () {
                                        page._change()
                                    }
                                });
                                this.show()
                            })
                        })
                    }
                },
                onContextmenu: function (profile, e, src) {
                    this._showPopMenu(e);
                    return false
                }
            });
            page.resizer.setHost(page).onItemsSelected(function (profile, ids) {
                this.pProfile.setSelectFromResizer.call(this.pProfile, ids)
            }).onActive(function (profile) {
                clearTimeout(this.timer);
                this._focus()
            }).onUpdate(function (profile, target, size, cssPos) {
                page._change();
                var self = this;
                if (target) {
                    var b = false;
                    target.each(function (target) {
                        target = xui([target]);
                        var profile = xui.UIProfile.getFromDom(target.get(0).id),
                            widget = profile.boxing(),
                            p = profile.properties,
                            m = profile.box.$DataModel;
                        if (size) {
                            var w = null,
                                h = null;
                            if (size.width) {
                                if (p && !m.width) {
                                    b = true
                                } else {
                                    switch (p.dock) {
                                    case "top":
                                    case "bottom":
                                    case "fill":
                                    case "cover":
                                    case "width":
                                        b = true;
                                        break;
                                    case "left":
                                    case "right":
                                    case "height":
                                        b = true;
                                    default:
                                        w = page._refresh(widget, "width", size)
                                    }
                                }
                            }
                            if (size.height) {
                                if (p && !m.height) {
                                    b = true
                                } else {
                                    switch (p.dock) {
                                    case "left":
                                    case "right":
                                    case "fill":
                                    case "cover":
                                    case "height":
                                        b = true;
                                        break;
                                    case "top":
                                    case "bottom":
                                    case "width":
                                        b = true;
                                    default:
                                        h = page._refresh(widget, "height", size)
                                    }
                                }
                            }
                            self._sizeUpdated(target, {
                                width: w,
                                height: h
                            });
                            xui.UI.$tryResize(profile, w, h, null, true)
                        }
                        if (cssPos) {
                            var x = null,
                                y = null;
                            if (cssPos.left) {
                                if (p && !m.left) {
                                    b = true
                                } else {
                                    switch (p.dock) {
                                    case "top":
                                    case "bottom":
                                    case "left":
                                    case "right":
                                    case "fill":
                                    case "cover":
                                    case "width":
                                        b = true;
                                        break;
                                    case "height":
                                        b = true;
                                    default:
                                        x = page._refresh(widget, "left", cssPos)
                                    }
                                }
                            }
                            if (cssPos.top) {
                                if (p && !m.top) {
                                    b = true
                                } else {
                                    switch (p.dock) {
                                    case "left":
                                    case "right":
                                    case "top":
                                    case "bottom":
                                    case "fill":
                                    case "cover":
                                    case "height":
                                        b = true;
                                        break;
                                    case "width":
                                        b = true;
                                    default:
                                        y = page._refresh(widget, "top", cssPos)
                                    }
                                }
                            }
                            self._posUpdated(target, {
                                left: x,
                                top: y
                            })
                        }
                    });
                    if (b) {
                        profile.boxing().rePosSize()
                    }
                }
                return false
            }).onFocusChange(function (profile, index) {
                if (this.tempSelected) {
                    this.SelectedFocus = index;
                    _.resetRun("$profilegrid$", this._refreshProfileGrid, 0, [this.tempSelected], this);
                    this.resizer.setConfigBtn(this.tempSelected.length == 1);
                    this.resizer.setTag(this.tempSelected[0])
                }
            }).onDblclick(function (profile, e, src) {
                if (CONF.designer_editMode != "simple") {
                    var arr = this.tempSelected;
                    if (arr && arr.length) {
                        var o = xui.getObject(arr[0]);
                        page.resetTaskList();
                        if (page._dirty) {
                            page.resetCodeFromDesigner()
                        }
                        page.addTask(function () {
                            page.searchInEditor('.setHost(host,"' + o.alias + '")')
                        });
                        page.__dblclickctrl = true;
                        _.asyRun(function () {
                            page.__dblclickctrl = false
                        });
                        page.startTaskList()
                    }
                } else {
                    if (typeof CONF.designer_ctrldblclick == "function") {
                        var arr = this.tempSelected,
                            prf;
                        if (arr && arr.length) {
                            prf = xui.getObject(arr[0])
                        }
                        page.__dblclickctrl = true;
                        _.asyRun(function () {
                            page.__dblclickctrl = false
                        });
                        CONF.designer_ctrldblclick(page, prf, e, src)
                    }
                }
            }).onRegionClick(function (profile, e) {
                var ep = xui.Event.getPos(e),
                    arr, t, m, ret;
                var tryinplaceedit = function (prf, nodeKey, multi, conf, node, root, epoff, ppos, rgw, rgh, subId) {
                        if (node && !node.isEmpty()) {
                            var pos = node.offset(null, root),
                                w = node.offsetWidth(),
                                h = node.offsetHeight();
                            if (epoff.left > pos.left && epoff.top > pos.top && epoff.left < pos.left + w && epoff.top < pos.top + h && epoff.left < rgw && epoff.top < rgh) {
                                _.asyRun(function () {
                                    if (!node.get(0) || !node.get(0).offsetWidth) {
                                        return
                                    }
                                    page._inplaceedit(prf, nodeKey, multi, conf, node, ppos.left + pos.left, ppos.top + pos.top, w, h)
                                }, 200);
                                return true
                            }
                        }
                        return false
                    };
                var fun1 = function (ep, prf) {
                        var conf = CONF.inplaceedit && CONF.inplaceedit[prf.key],
                            root, nodes, node;
                        if (!_.isHash(conf)) {
                            return false
                        }
                        for (var nodeKey in conf) {
                            var item = conf[nodeKey],
                                ismulti = !! item[0];
                            var root = prf.getRoot(),
                                epoff = {},
                                ppos = root.offset(),
                                inpos = root.offset(null, page.canvas.getRoot()),
                                rgw = root.offsetWidth(),
                                rgh = root.offsetHeight();
                            epoff.left = ep.left - ppos.left;
                            epoff.top = ep.top - ppos.top;
                            if (ismulti) {
                                var nodes = prf.getSubNode(nodeKey, true).get(),
                                    node;
                                for (var i = 0, l = nodes.length; i < l; i++) {
                                    node = nodes[i];
                                    if (node.id) {
                                        var subId = prf.getSubId(node.id);
                                        if (tryinplaceedit(prf, nodeKey, 1, item, xui([node.$xid]), root, epoff, inpos, rgw, rgh, subId)) {
                                            return true
                                        }
                                    }
                                }
                            } else {
                                if (tryinplaceedit(prf, nodeKey, 0, item, prf.getSubNode(nodeKey), root, epoff, inpos, rgw, rgh, subId)) {
                                    return true
                                }
                            }
                        }
                        return false
                    },
                    fun2 = function (arr, ep, parent) {
                        var me = arguments.callee,
                            m, rt, pos, w, h, epoff = {},
                            ppos = parent.offset(),
                            rgw = parent.offsetWidth(),
                            rgh = parent.offsetHeight();
                        epoff.left = ep.left - ppos.left;
                        epoff.top = ep.top - ppos.top;
                        _.arr.each(arr, function (o) {
                            if (!(m = o[0].getRoot()).isEmpty()) {
                                if ((o[0].children).length) {
                                    if (rt = me(o[0].children, ep, m)) {
                                        return false
                                    }
                                }
                                pos = m.offset(null, parent);
                                w = m.offsetWidth();
                                h = m.offsetHeight();
                                if (epoff.left > pos.left && epoff.top > pos.top && epoff.left < pos.left + w && epoff.top < pos.top + h && epoff.left < rgw && epoff.top < rgh) {
                                    rt = o[0].$xid;
                                    return false
                                }
                            }
                        });
                        return rt
                    };
                if (!(arr = this.tempSelected) || !arr.length) {
                    return
                }
                _.arr.each(arr, function (o) {
                    t = xui.getObject(o);
                    ret = fun1(ep, t);
                    if (ret) {
                        return false
                    }
                    ret = fun2(t.children, ep, t.getRoot());
                    if (ret) {
                        return false
                    }
                });
                if (ret) {
                    if (ret !== true) {
                        this.selectWidget([ret]);
                        return false
                    }
                }
            });
            page.holder.append(page.resizer)
        },
        _detatchResizer: function () {
            var self = this;
            self.holder.append(self.resizer);
            self.holder.append(self.proxy);
            self.pProfile = self.pNode = null
        },
        _attachResizer: function (profile, node) {
            var self = this;
            self.proxy.css("display", "none");
            if (!self.resizer || !self.resizer.getRootNode() || !self.resizer.get(0).renderId) {
                self._createResizer()
            }
            self.resizer.resetTarget(null, false);
            xui(node).append(self.resizer).append(self.proxy);
            self.pProfile = profile;
            self.pNode = node;
            _.merge(self.resizer.get(0).properties.dragArgs, {
                widthIncrement: self.dropOffset,
                heightIncrement: self.dropOffset
            }, "all")
        },
        _focus: function () {
            this.focusBtn.focus()
        },
        _setSelected: function (ids, flag) {
            var self = this,
                tb = self.toolbar,
                t;
            ids = _.isArr(ids) ? ids : [];
            self.tempSelected = ids;
            self.SelectedFocus = ids.length - 1;
            tb.showGroup("align", ids.length > 1 ? true : false);
            if (ids.length > 0 && (t = xui.getObject(ids[0]))) {
                tb.showGroup("pos", (t.box["xui.UI"] && !t.box.$noDomRoot))
            } else {
                tb.showGroup("pos", false)
            }
            tb.showGroup("copyclone", ids.length > 0 ? true : false);
            var showPasteBtn = false;
            if (SPA.__copied) {
                var ctrl;
                showPasteBtn = !ids || ids.length === 0 || (ids.length === 1 && (ctrl = self.getByCacheId(ids)) && ctrl.get(0) && ctrl.get(0).boxing().getDropKeys)
            }
            tb.showGroup("pastefun", !! showPasteBtn);
            if (flag) {
                self.events.onSelected.apply(self.parent, [self, self.pProfile, ids])
            }
            self._focus();
            return self
        },
        _sizeUpdated: function (pro, size) {
            var t, self = this;
            if (!(t = self.profileGrid.get(0).$widget)) {
                return
            }
            if (xui.UIProfile.getFromDom(pro.get(0).id) == t.get(t._nodes.length - 1)) {
                if (size.width !== null) {
                    self.profileGrid.updateCellByRowCol("properties:width", "value", {
                        value: size.width
                    })
                }
                if (size.height !== null) {
                    self.profileGrid.updateCellByRowCol("properties:height", "value", {
                        value: size.height
                    })
                }
            }
        },
        _posUpdated: function (pro, cssPos) {
            var t, self = this;
            if (!(t = self.profileGrid.get(0).$widget)) {
                return
            }
            if (xui.UIProfile.getFromDom(pro.get(0).id) == t.get(t._nodes.length - 1)) {
                if (cssPos.left !== null) {
                    self.profileGrid.updateCellByRowCol("properties:left", "value", {
                        value: cssPos.left
                    })
                }
                if (cssPos.top !== null) {
                    self.profileGrid.updateCellByRowCol("properties:top", "value", {
                        value: cssPos.top
                    })
                }
            }
        },
        parseFun: function (txt) {
            var str = txt;
            var reg = new RegExp("^(\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*)|^(\\s*\\/\\/[^\\n]*\\s*)");
            while (reg.test(str)) {
                str = str.replace(reg, "")
            }
            str = str.replace(/\s*/, "");
            if (!str) {
                return {
                    comments: null,
                    code: null
                }
            }
            if (false === this.check(str.replace(/\s*$/, ""))) {
                return false
            }
            return {
                comments: "\n" + txt.replace(str, ""),
                code: str.replace(/\s*$/, "")
            }
        },
        _designable: function (profile) {
            var me = arguments.callee,
                self = this;
            self._giveHandler(profile);
            profile.$inDesign = true;
            var t = profile.behavior.PanelKeys;
            if (t && t.length) {
                self._enablePanelDesign(profile)
            }
            if (profile.children && profile.children.length) {
                _.arr.each(profile.children, function (o) {
                    me.call(self, o[0])
                })
            }
            profile.$refreshTrigger = function (profile) {
                me.call(self, profile);
                self.profileGrid.offEditor()
            }
        },
        _WidgetsSelected: function (ids) {
            var self = this;
            self._setSelected(ids, true);
            self.iconlist.setUIValue(null)
        },
        _clearSelect: function (profile) {
            var self = this;
            if (self.resizer && self.resizer.get(0) && self.resizer.get(0).renderId) {
                self.resizer.resetTarget(null, false);
                self._detatchResizer()
            }
            self.iconlist.setUIValue(null)
        },
        getByCacheId: function (idArr) {
            var arr = [],
                t, n = xui.UI._cache;
            idArr = idArr instanceof Array ? idArr : [idArr];
            _.arr.each(idArr, function (id) {
                if (t = n["$" + id]) {
                    arr[arr.length] = t
                }
            });
            return xui.UI.pack(arr, false)
        },
        _deleteSelected: function (force) {
            var page = this,
                fun = function () {
                    var sel = page.getByCacheId(page.tempSelected);
                    if (!sel.isEmpty()) {
                        var ids = [];
                        var ws = page.getByCacheId(page.tempSelected);
                        ws.each(function (o) {
                            if (!(o.box["xui.UI"] && !o.box.$noDomRoot)) {
                                page.iconlist.removeItems(o.$xid)
                            } else {
                                if (o.properties && o.properties.dock && o.properties.dock != "none") {
                                    o.boxing().setDockIgnore(true)
                                }
                            }
                        });
                        ws.destroy()
                    } else {
                        var o = xui.getObject(page.tempSelected[0]);
                        page.iconlist.removeItems(page.tempSelected);
                        o.boxing().destroy()
                    }
                    page._change();
                    page._clearSelect(page.pProfile);
                    page._setSelected(null, true)
                };
            if (!page.tempSelected || !page.tempSelected.length) {
                return
            }
            if (!force) {
                xui.UI.Dialog.confirm(xui.getRes("RAD.designer.confirmdel"), xui.getRes("RAD.designer.confirmdel2", page.tempSelected.length), fun)
            } else {
                fun()
            }
        },
        _giveHandler: function (profile, isCanvas) {
            var prevent = function () {
                    return
                },
                page = this,
                fun = function () {
                    if (!isCanvas) {
                        profile.getRoot().setSelectable(false).beforeClick(prevent).afterClick(prevent).onClick(function (pro, e, src) {
                            var esrc = xui.Event.getSrc(e),
                                id, profile;
                            while ((!esrc.id || esrc.id == xui.$localeDomId) && esrc.parentNode !== document && esrc.parentNode !== window) {
                                esrc = esrc.parentNode
                            }
                            id = esrc.id;
                            esrc = null;
                            if (!id) {
                                return
                            }
                            if (xui.UIProfile.getFromDom(id) !== (profile = xui.UIProfile.getFromDom(xui.use(src).id()))) {
                                return
                            }
                            if (!profile) {
                                return
                            }
                            var t, key = xui.Event.$keyboard;
                            if (page.pProfile && (page.pProfile != profile.parent)) {
                                page.pProfile.selected = []
                            }
                            if (t = profile.parent) {
                                if (key && key.shiftKey) {
                                    t.reSelectObject.call(t, profile, profile.getRoot().parent())
                                } else {
                                    t.selectObject.call(t, profile, profile.getRoot().parent())
                                }
                            }
                            return false
                        });
                        profile.$onDock = function (profile) {
                            page.$tryToRefreshSel(profile)
                        };
                        profile.$afterRefresh = function (profile) {
                            page.$tryToRefreshSel(profile)
                        }
                    }
                    var t = profile.behavior.PanelKeys;
                    if (t && t.length) {
                        profile.getSubNode(t[0], true).addClass("panel").$addEventHandler("drop").$addEventHandler("mousedown").$addEventHandler("click").$addEventHandler("drag").$addEventHandler("dragstop").$addEventHandler("mouseup")
                    }
                };
            if (profile.renderId) {
                fun()
            } else {
                profile.$onrender = fun
            }
        },
        _enablePanelDesign: function (profile) {
            var ns = profile,
                ins = profile.boxing(),
                t, key = profile.box.KEY,
                pool = profile.behavior.PanelKeys,
                page = this,
                h, k, self = this,
                cb = {
                    beforeMouseover: function (profile, e, src) {
                        var dd = xui.DragDrop,
                            pp = dd.getProfile(),
                            key = pp.dragKey,
                            data = pp.dragData;
                        if (!key || !data || !(new RegExp("\\b" + key + "\\b")).test(profile.box.getDropKeys(profile, src) + ":___iDesign") || data.parentId == profile.$xid || (data.data && _.arr.indexOf(data.data, profile.$xid) != -1) || (profile.onDropTest && (false === profile.boxing().onDropTest(profile, key, data)))) {
                            return
                        }
                        dd.setDropElement(src);
                        _.resetRun("setDropFace", dd.setDropFace, 0, [src], dd);
                        if (profile.onDragEnter) {
                            profile.boxing().onDragEnter(profile, e, this, key, data, profile.getItemByDom(xui.use(src).id()))
                        }
                    },
                    beforeDrop: function (profile, e, src) {
                        self._change();
                        var target, dd = xui.DragDrop.getProfile(),
                            dropx = dd.x,
                            dropy = dd.y,
                            dragKey = dd.dragKey,
                            dragData = dd.dragData,
                            type = dragData.type,
                            iniProp = dragData.iniProp,
                            customRegion = dragData.customRegion,
                            image = dragData.image,
                            imagePos = dragData.imagePos,
                            data = dragData.data,
                            pos = dragData.pos,
                            ids, offset = self.dropOffset,
                            fun = function () {
                                var page = arguments.callee.page,
                                    t = xui.SC(type);
                                if (!(t["xui.UI"] && !t.$noDomRoot)) {
                                    var o = xui.create(type).get(0);
                                    o.$inDesign = true;
                                    page.iconlist.insertItems([{
                                        id: o.$xid,
                                        image: xui.ini.img_bg,
                                        tips: o.key,
                                        imgStyle: "background:url(" + image + ") " + imagePos
                                    }], null, false);
                                    page.iconlist.setUIValue(o.$xid)
                                } else {
                                    target = new(xui.SC(xui.absBox.$type[type]));
                                    target.get(0).$inDesign = true;
                                    if (_.isHash(iniProp)) {
                                        target.setProperties(iniProp)
                                    }
                                    if (!customRegion && target["xui.UI"]) {
                                        var parentNode = profile.keys.PANEL ? profile.getSubNode(profile.keys.PANEL, profile.getSubId(src)) : profile.getRoot();
                                        if (!parentNode.isEmpty()) {
                                            var p = target.get(0).properties,
                                                h = parentNode.get(0).style.height;
                                            if (h && h != "auto") {
                                                var basePos = xui.use(src).offset(),
                                                    cssPos = {
                                                        left: parseInt((dropx - basePos.left) / offset) * offset,
                                                        top: parseInt((dropy - basePos.top) / offset) * offset
                                                    };
                                                target.setLeft(_.arr.indexOf(["top", "bottom", "width", "fill", "cover"], p.dock) != -1 ? 0 : cssPos.left);
                                                target.setTop(_.arr.indexOf(["left", "right", "height", "fill", "cover"], p.dock) != -1 ? 0 : cssPos.top);
                                                target.setPosition("absolute")
                                            } else {
                                                target.setLeft("auto");
                                                target.setTop("auto");
                                                target.setPosition("relative")
                                            }
                                        }
                                    }
                                    target.setZIndex(1);
                                    target.render();
                                    var pro = target.get(0);
                                    page._designable(pro);
                                    pro._host = page;
                                    ids = [target["xui.absBox"] ? pro.$xid : target.$xid];
                                    if (target["xui.UI"]) {
                                        profile.boxing().append(target, profile.getItemIdByDom(xui.use(src).id()))
                                    }
                                    profile.setSelectFromPanel.call(profile, src, ids)
                                }
                            };
                        fun.page = page;
                        if (type) {
                            if (xui.SC.get(type)) {
                                fun()
                            } else {
                                _.observableRun(function () {
                                    xui.Dom.setCover(xui.getRes("RAD.designer.loading") + type);
                                    xui.SC(type, fun, true)
                                })
                            }
                        } else {
                            var basePos = xui.use(src).offset(),
                                cssPos = {
                                    left: parseInt((dropx - basePos.left) / offset) * offset,
                                    top: parseInt((dropy - basePos.top) / offset) * offset
                                };
                            var t;
                            ids = data;
                            target = self.getByCacheId(ids);
                            var minx, miny;
                            target.each(function (o, i) {
                                if (i === 0) {
                                    minx = o.properties.left;
                                    miny = o.properties.top
                                } else {
                                    minx = Math.min(o.properties.left, minx);
                                    miny = Math.min(o.properties.top, miny)
                                }
                            });
                            target.each(function (o) {
                                if (o.properties.dock != "none") {
                                    xui.UI.$dock(o, true)
                                } else {
                                    o.boxing().setLeft(o.properties.left - minx + cssPos.left).setTop(o.properties.top - miny + cssPos.top)
                                }
                            });
                            profile.boxing().append(target, profile.getItemIdByDom(src));
                            profile.setSelectFromPanel.call(profile, src, ids)
                        }
                    },
                    onMousedown: function (profile, e, src) {
                        if (xui.Event.getBtn(e) != "left") {
                            return
                        }
                        if (xui.Event.getSrc(e).$xid !== src) {
                            return
                        }
                        var o = xui(src),
                            pos = xui.Event.getPos(e),
                            absPos = o.offset(),
                            w = o.innerWidth(),
                            h = o.innerHeight();
                        if (pos.left - absPos.left > w) {
                            return
                        }
                        if (pos.top - absPos.top > h) {
                            return
                        }
                        profile._offsetPos = absPos;
                        profile._scrollTop = o.scrollTop();
                        profile._scrollLeft = o.scrollLeft();
                        page._attachResizer(profile, src);
                        profile._selregion = {};
                        var pos = xui.Event.getPos(e);
                        xui(src).startDrag(e, {
                            targetReposition: false,
                            dragType: "blank",
                            dragCursor: "crosshair",
                            targetLeft: pos.left,
                            targetTop: pos.top,
                            dragDefer: 1
                        });
                        profile.$dragging = false
                    },
                    onClick: function (profile, e, src) {
                        if (xui.Event.getSrc(e) !== xui.use(src).get(0)) {
                            return
                        }
                        self._clearSelect(profile);
                        profile.setSelectFromPanel.call(profile, src, [])
                    },
                    beforeDrag: function (profile, e, src) {
                        var t, dd = xui.DragDrop.getProfile(),
                            pos = dd.offset,
                            proxy = page.proxy;
                        var region = profile._selregion;
                        if ((t = pos.x) < 0) {
                            pos.x = -t
                        }
                        if ((t = pos.y) < 0) {
                            pos.y = -t
                        }
                        region.left = Math.min(dd.ox, dd.x) - profile._offsetPos.left + profile._scrollLeft;
                        region.top = Math.min(dd.oy, dd.y) - profile._offsetPos.top + profile._scrollTop;
                        region.width = pos.x;
                        region.height = pos.y;
                        proxy.cssRegion(region);
                        if (!profile.$dragging) {
                            proxy.css("display", "block");
                            profile.$dragging = true
                        }
                    },
                    beforeDragstop: function (profile, e, src) {
                        var region = profile._selregion,
                            proxy = page.proxy,
                            selected = [],
                            t, m, o, x1, y1, x2, y2, xx1, yy1, xx2, yy2, self = xui.use(src).get(0);
                        xx1 = region.left;
                        yy1 = region.top;
                        xx2 = xx1 + region.width;
                        yy2 = yy1 + region.height;
                        if (m = profile.children) {
                            _.arr.each(m, function (v, i) {
                                v = v[0];
                                if (v.renderId && v.getRootNode() && v.getRootNode().parentNode === self && v.getRootNode().style.display != "none" && v.getRootNode().style.visibility != "hidden") {
                                    o = v.getRoot();
                                    x1 = o.offsetLeft();
                                    y1 = o.offsetTop();
                                    x2 = x1 + o.width();
                                    y2 = y1 + o.height();
                                    if (xx2 > x1 && x2 > xx1 && yy2 > y1 && y2 > yy1) {
                                        selected.push(v.$xid)
                                    }
                                }
                            });
                            profile.setSelectFromPanel.call(profile, src, selected)
                        }
                        _.asyRun(function () {
                            proxy.css("display", "none")
                        })
                    },
                    onMouseup: function (profile, e, src) {
                        _.asyRun(function () {
                            page.proxy.css("display", "none")
                        })
                    }
                };
            if (t = pool) {
                var i = _.arr.indexOf(t, "PANEL");
                if (i == -1) {
                    i = _.arr.indexOf(t, "KEY")
                }
                if (i != -1) {
                    i = t[i];
                    if (profile.keys.KEY == profile.keys[i]) {
                        h = cb
                    } else {
                        h = {};
                        h[i] = cb
                    }
                    profile._CB = h;
                    profile.clearCache()
                }
                if (xui.browser.isTouch) {
                    _.arr.each(t, function (o) {
                        ins.getSubNode(o, true).each(function (node) {
                            var c = xui.$cache.droppable,
                                i = "___iDesign";
                            c[i] = c[i] || [];
                            c[i].push(node.$xid)
                        })
                    })
                }
            }
            _.merge(profile, {
                selectObject: function (obj, node) {
                    var profile = this,
                        id = obj.$xid;
                    return this.setSelectFromPanel(node, [id])
                },
                reSelectObject: function (obj, node) {
                    var profile = this;
                    id = obj.$xid;
                    if (profile.selected && _.arr.indexOf(profile.selected, id) != -1) {
                        _.arr.removeValue(profile.selected, id)
                    } else {
                        (profile.selected || (profile.selected = [])).push(id)
                    }
                    return this.setSelectFromPanel(node, profile.selected)
                },
                setSelectFromResizer: function (ids) {
                    var profile = this;
                    profile.selected = ids;
                    return this.resetSelectRel()
                },
                setSelectFromPanel: function (node, ids) {
                    var profile = this;
                    if (self.pProfile !== profile || self.pNode !== node) {
                        self._clearSelect(profile);
                        self._attachResizer(profile, node)
                    }
                    profile.selected = ids;
                    self.resizer.resetTarget(self.getByCacheId(profile.selected).reBoxing(), false);
                    return this.resetSelectRel()
                },
                resetSelectRel: function () {
                    var profile = this;
                    if (profile.selected && profile.selected.length) {
                        var t = self.resizer.get(0).properties;
                        t.dragArgs = {
                            dragKey: "___iDesign",
                            widthIncrement: self.dropOffset,
                            heightIncrement: self.dropOffset,
                            dragData: {
                                parentId: profile.$xid,
                                data: profile.selected
                            }
                        }
                    } else {
                        self._clearSelect(profile)
                    }
                    _.tryF(self._WidgetsSelected, [profile.selected], self);
                    self._focus()
                }
            }, "all")
        },
        _refreshProfileGrid: function (ids) {
            var page = this,
                data = page._cls;
            page.profileGrid.removeAllRows();
            if (!ids || !ids.length) {
                var pro = this.canvas.get(0),
                    arr = [],
                    eh = xui.Com.$EventHandlers;
                if (!_.get(data, ["Instance", "events"])) {
                    _.set(data, ["Instance", "events"], {})
                }
                var em = _.get(data, ["Instance", "events"]);
                _.each(eh, function (o, i) {
                    var $fun = function (profile, cell) {
                            if (page.hasTask()) {
                                return
                            }
                            var o = cell.$tagVar;
                            if (!o) {
                                return
                            }
                            var funname;
                            if (!cell.value) {
                                funname = "_" + o.widgetName.toLowerCase().replace(/\./g, "_") + "_" + o.key.toLowerCase();
                                profile.boxing().updateCell(cell.id, {
                                    value: funname
                                }, false, true)
                            } else {
                                funname = cell.value
                            }
                            page.resetTaskList();
                            if (!_.get(page, ["_cls", "Instance", funname])) {
                                page.resetCode("Instance", "events", _.stringify(page._cls.Instance.events));
                                page.addCode("Instance", funname, o.ini.toString().replace(/\s*\}$/, "\n\n}"))
                            }
                            page.addTask(function () {
                                page.focusEditor("Instance", funname)
                            });
                            page.startTaskList();
                            page._dirty = false
                        },
                        $tagVar = {
                            widgetName: "com",
                            path: "Instance",
                            key: i,
                            ini: o
                        };
                    arr.push({
                        id: "event:" + i,
                        tipk: "event",
                        tipv: i,
                        value: i,
                        caption: i,
                        cells: [{
                            value: (em && em[i]) || "",
                            type: "popbox",
                            $tagVar: $tagVar,
                            event: $fun
                        }]
                    })
                });
                var rows = [{
                    id: "properties:width",
                    caption: "width",
                    tips: "Canvas width",
                    cells: [{
                        type: "number",
                        value: pro.properties.width
                    }]
                }, {
                    id: "properties:height",
                    caption: "height",
                    tips: "Canvas height",
                    cells: [{
                        type: "number",
                        value: pro.properties.height
                    }]
                }];
                if (CONF.designer_editMode != "simple") {
                    rows.push({
                        id: "UIE",
                        group: true,
                        caption: "events",
                        sub: arr
                    })
                }
                var list = [];
                page.profileGrid.insertRows(rows);
                page.profileGrid.get(0).$widget = page.canvas
            } else {
                var t, len, uis = page.getByCacheId(ids),
                    pro, rows = [],
                    $fun = function (profile, cell) {
                        var o = cell.$tagVar;
                        if (!o) {
                            return
                        }
                        var node = profile.getSubNode("CELL", cell._serialId),
                            obj = o.profile[o.name];
                        xui.ComFactory.getCom("objEditor", function () {
                            this.host = page;
                            this.setProperties({
                                caption: o.widgetName + " => " + o.name,
                                image: CONF.img_app,
                                imagePos: obj.constructor == Array ? "-128px -32px" : "-16px -32px",
                                text: xui.Coder.formatText(_.stringify(_.clone(obj, function (o, i) {
                                    return (i + "").charAt(0) != "_"
                                }))),
                                fromRegion: node.cssRegion(true),
                                tagVar: o,
                                onOK: function (page) {
                                    this._change();
                                    var tagVar = page.properties.tagVar;
                                    tagVar.profile.boxing()[tagVar.funName](page.properties.object);
                                    node.focus()
                                }
                            });
                            this.show()
                        })
                    };
                if (len = uis._nodes.length) {
                    pro = uis.get(this.SelectedFocus)
                } else {
                    pro = xui.getObject(ids[0]);
                    uis = pro.boxing()
                }
                rows.push({
                    id: "key",
                    tipk: "class",
                    caption: "<strong>class</strong>",
                    tips: CONF.designer_editMode != "simple" ? xui.getRes("RAD.designer.openapi") : "",
                    cells: [{
                        disabled: true,
                        value: "<strong>" + pro.key + "</strong>",
                        type: "label",
                        tips: CONF.designer_editMode != "simple" ? xui.getRes("RAD.designer.openapi") : ""
                    }]
                });
                rows.push({
                    id: "alias",
                    tipk: "fun",
                    tipv: "alias",
                    caption: "<strong>alias</strong>",
                    cells: [{
                        value: pro.alias,
                        type: uis._nodes.length === 1 ? "input" : "label"
                    }]
                });
                if (CONF.designer_editMode != "simple") {
                    if (pro.domId) {
                        rows.push({
                            id: "theme",
                            tipk: "fun",
                            tipv: "theme",
                            caption: "<strong>theme</strong>",
                            cells: [{
                                value: pro.theme,
                                type: "input"
                            }]
                        });
                        rows.push({
                            id: "domId",
                            tipk: "fun",
                            tipv: "setDomId",
                            value: "setDomId",
                            caption: "<strong>domId</strong>",
                            cells: [{
                                value: pro.domId,
                                type: uis._nodes.length === 1 ? "input" : "label"
                            }]
                        })
                    }
                }
                if (uis._nodes.length == 1) {
                    var arr = page.__buildSubRows(uis, "special", true);
                    _.arr.each(arr, function (o) {
                        o.cells[0].caption = o.cells[0].value;
                        rows.push(o)
                    })
                }
                rows.push({
                    id: "properties",
                    group: true,
                    caption: "properties",
                    sub: true
                });
                if (uis._nodes.length == 1) {
                    if (CONF.designer_editMode != "simple") {
                        rows.push({
                            id: "UIE",
                            group: true,
                            caption: "events",
                            sub: true
                        })
                    }
                }
                this.profileGrid.insertRows(rows);
                this.profileGrid.get(0).$widget = uis
            }
        },
        _change: function () {
            this._dirty = true;
            _.tryF(this.events.onValueChanged, [this, null], this.host)
        },
        $toolbar_onclick: function (profile, item, group, e, src) {
            var page = this,
                id = item.id;
            switch (group.id) {
            case "code":
                switch (id) {
                case "viewsize":
                    page.popViewSize.pop(src);
                    break;
                case "format":
                case "json":
                    _.observableRun(function () {
                        var dialog = page.$codeDlg || (page.$codeDlg = new xui.UI.Dialog({
                            left: 100,
                            top: 100,
                            width: 600,
                            height: 400,
                            minBtn: false,
                            caption: "$RAD.pageEditor.formatted"
                        }, {
                            beforeClose: function (p) {
                                p.boxing().hide();
                                return false
                            }
                        })),
                            t, nodes, code;
                        if (page.tempSelected && page.tempSelected.length) {
                            nodes = [];
                            _.arr.each(page.tempSelected, function (i) {
                                nodes.push(xui.getObject(i))
                            })
                        } else {
                            nodes = page.getWidgets(true)
                        }
                        switch (id) {
                        case "format":
                            code = xui.Coder.formatHTML(page.getJSCode(nodes), "js", ["plain"]);
                            break;
                        case "json":
                            code = xui.Coder.formatAll(page.getJSONCode(nodes), "js", ["plain"]);
                            break
                        }
                        dialog.setHtml(code);
                        dialog.show(xui("body"), true)
                    });
                    break;
                case "refresh":
                    if (!page._dirty) {
                        page.refreshFromCode()
                    } else {
                        xui.UI.Dialog.confirm(xui.getRes("RAD.designer.confirmrefresh1"), xui.getRes("RAD.designer.confirmrefresh2"), function () {
                            page.refreshFromCode()
                        })
                    }
                    break
                }
                break;
            case "align":
                this._change();
                var sel = page.getByCacheId(this.tempSelected);
                var p = sel.get(this.SelectedFocus),
                    o = p.getRoot(),
                    size = o.cssSize(),
                    pos = o.cssPos();
                sel.each(function (o) {
                    if (o.locked) {
                        return
                    }
                    var node = o.getRoot();
                    switch (id) {
                    case "left":
                        node.left(pos.left);
                        page._refresh(o.boxing(), "left");
                        break;
                    case "center":
                        node.left(pos.left + size.width / 2 - node.width() / 2);
                        page._refresh(o.boxing(), "left");
                        break;
                    case "right":
                        node.left(pos.left + size.width - node.width());
                        page._refresh(o.boxing(), "left");
                        break;
                    case "top":
                        node.top(pos.top);
                        page._refresh(o.boxing(), "top");
                        break;
                    case "middle":
                        node.top(pos.top + size.height / 2 - node.height() / 2);
                        page._refresh(o.boxing(), "top");
                        break;
                    case "bottom":
                        node.top(pos.top + size.height - node.height());
                        page._refresh(o.boxing(), "top");
                        break;
                    case "w":
                        node.width(size.width);
                        page._refresh(o.boxing(), "width");
                        break;
                    case "wh":
                        node.width(size.width).height(size.height);
                        page._refresh(o.boxing(), "width");
                        page._refresh(o.boxing(), "height");
                        break;
                    case "h":
                        node.height(size.height);
                        page._refresh(o.boxing(), "height");
                        break
                    }
                });
                this.resizer.rePosSize();
                this._focus();
                break;
            case "pos":
                this._change();
                var sel = page.getByCacheId(this.tempSelected),
                    zIndex = 0;
                sel.each(function (o) {
                    var ins = o.boxing();
                    var node = ins.reBoxing();
                    switch (id) {
                    case "zindex1":
                        if (o.locked) {
                            return
                        }
                        if (!zIndex) {
                            zIndex = node.topZindex()
                        }
                        node.css("zIndex", zIndex + 1);
                        page._refresh(ins, "zIndex");
                        break;
                    case "zindex2":
                        if (o.locked) {
                            return
                        }
                        node.css("zIndex", 0);
                        page._refresh(ins, "zIndex");
                        break;
                    case "repos":
                    case "resize":
                        if (o.locked) {
                            return
                        }
                        var l = node.left(),
                            t = node.top(),
                            offset = page.dropOffset;
                        node.left(parseInt(l / offset) * offset).top(parseInt(t / offset) * offset);
                        if (id == "resize") {
                            var w = node.width(),
                                h = node.height();
                            node.width((parseInt((w + offset - 1) / offset)) * offset).height((parseInt((h + offset - 1) / offset)) * offset)
                        }
                        page.resizer.rePosSize();
                        page._refresh(ins, "left");
                        page._refresh(ins, "top");
                        page._refresh(ins, "width");
                        page._refresh(ins, "height");
                        break
                    }
                });
                this._focus();
                break;
            case "copyclone":
                if ("delete" == id) {
                    this._deleteSelected()
                } else {
                    if ("cut" == id || "copy" == id) {
                        var src = page.getByCacheId(this.tempSelected);
                        var tar = src.clone();
                        tar.each(function (o) {
                            o.$inDesign = true
                        });
                        xui.message(xui.getRes("RAD.designer." + ("cut" == id ? "cutOK" : "copyOK"), tar.size()));
                        SPA.__copied = tar;
                        var dlg = SPA.__pasteDlg;
                        if (!dlg) {
                            dlg = SPA.__pasteDlg = xui.pop(xui.wrapRes("RAD.designer.clipboard"), "<div style='position:relative;overflow:auto;width:200px;height:100px;'></div>", null, 20, 20);
                            dlg.setResizer(true).setMinBtn(true).onDestroy(function () {
                                delete SPA.__copied;
                                delete SPA.__pasteDlg;
                                xui.message(xui.wrapRes("RAD.designer.clearClipboard"))
                            });
                            dlg.getRoot().css("opacity", 0.75).onMouseover(function (prf, e, src) {
                                xui(src).css("opacity", 1)
                            }).onMouseout(function (prf, e, src) {
                                xui(src).css("opacity", 0.75)
                            })
                        }
                        dlg.setHtml("", true);
                        var div = new xui.UI.Block({
                            dock: "fill",
                            overflow: "auto",
                            borderType: "inset"
                        });
                        div.append(src.clone());
                        dlg.append(div);
                        if ("cut" == id) {
                            this._deleteSelected(true);
                            this._change()
                        }
                    } else {
                        if ("clone" == id) {
                            var ids = [],
                                pid;
                            var src = page.getByCacheId(this.tempSelected);
                            var tar = src.clone();
                            tar.each(function (o) {
                                o.$inDesign = true;
                                o = o.properties;
                                if (parseInt(o.left) || o.left === 0) {
                                    o.left += 10
                                }
                                if (parseInt(o.top) || o.top === 0) {
                                    o.top += 10
                                }
                            });
                            src.get(0).parent.boxing().append(tar, src.get(0).childrenId);
                            tar.each(function (o) {
                                page._designable(o)
                            });
                            this.resizer.resetTarget(xui(tar));
                            xui.message(xui.getRes("RAD.designer.colneOK", tar.size()));
                            this._change()
                        }
                    }
                }
                break;
            case "pastefun":
                if ("paste" == id) {
                    this._change();
                    var pid;
                    if (SPA.__copied) {
                        var sel = this.tempSelected,
                            ctrl, ids = [];
                        if (!sel || sel.length == 0 || (sel.length === 1 && (ctrl = page.getByCacheId(sel)) && ctrl.get(0) && ctrl.get(0).boxing().getDropKeys)) {
                            if (!sel || sel.length == 0) {
                                ctrl = page.canvas
                            } else {
                                ctrl = ctrl.get(0).boxing()
                            }
                            var tar = SPA.__copied.clone();
                            ctrl.append(tar);
                            tar.each(function (o) {
                                page._designable(o);
                                ids.push(o.$xid)
                            });
                            page.selectWidget(ids);
                            xui.message(xui.getRes("RAD.designer.pasted", tar.size()))
                        }
                    } else {
                        xui.message(xui.wrapRes("RAD.designer.clearClipboard"))
                    }
                }
                break
            }
        },
        _map1: {
            left: 1,
            top: 1,
            width: 1,
            height: 1,
            right: 1,
            bottom: 1
        },
        _map2: {
            left: 1,
            top: 1,
            width: 1,
            height: 1,
            right: 1,
            position: 1,
            bottom: 1,
            dock: 1,
            dockOrder: 1,
            dockMargin: 1,
            dockFloat: 1,
            dockIgnore: 1,
            dockMinH: 1,
            dockMinW: 1
        },
        $profilegrid_beforecellvalueset: function (profile, cell, hash) {
            var attr, t, type, funName, property, value, target = profile.$widget;
            if (target.get(0) != this.canvas.get(0)) {
                this._change()
            }
            var page = this,
                data = page._cls;
            try {
                value = hash.value;
                if ((attr = cell._row.id.split(":")).length > 1) {
                    type = attr[0];
                    property = attr[1]
                } else {
                    property = cell._row.id
                }
                switch (type) {
                case "properties":
                    funName = "set" + _.str.initial(property);
                    if (target.get(0) == this.canvas.get(0)) {
                        var temp = {};
                        temp[property] = value;
                        page.setViewSize(temp)
                    } else {
                        var b;
                        if (page._map1[property]) {
                            value = String((value == "auto") ? value : (parseFloat(value) === 0 ? 0 : (parseFloat(value) || "auto")));
                            if (value !== hash.value) {
                                profile.boxing().updateCell(cell, {
                                    value: value
                                });
                                b = 1
                            }
                        }
                        target.each(function (o) {
                            if (value !== o.properties[property]) {
                                if (_.isFun(o.boxing()[funName])) {
                                    o.boxing()[funName](value)
                                }
                            }
                        });
                        if (page._map2[property]) {
                            this.resizer.rePosSize()
                        }
                        if (b) {
                            return false
                        }
                    }
                    break;
                case "event":
                    if (target.get(0) == this.canvas.get(0)) {
                        if (hash.value) {
                            var em = _.get(data, ["Instance", "events"]);
                            if (!em) {
                                _.set(data, ["Instance", "events"], em = {})
                            }
                            em[property] = hash.value
                        }
                    } else {
                        target.each(function (o) {
                            if (hash.value) {
                                o[property] = hash.value
                            } else {
                                delete o[property]
                            }
                        })
                    }
                    break;
                default:
                    if (property == "domId") {
                        if (value == target.domId) {
                            return false
                        }
                        if (target.get(0).$domId != value && !/^[\w_-]*$/.test(value)) {
                            xui.message(xui.getRes("RAD.designer.domIdValid", value));
                            return false
                        }
                        if (target.get(0).$domId != value && xui.Dom.byId(value)) {
                            xui.message(xui.getRes("RAD.designer.domIdExists", value));
                            return false
                        }
                        var b;
                        if (_.str.trim(String(value)) == "") {
                            value = target.get(0).$domId
                        }
                        if (value !== hash.value) {
                            profile.boxing().updateCell(cell, {
                                value: value
                            });
                            b = 1
                        }
                        target.setDomId(value);
                        if (b) {
                            return false
                        }
                    } else {
                        if (property == "theme") {
                            if (value) {
                                value = ("" + value).replace(/[^a-zA-Z0-9-]/g, "")
                            }
                            var b;
                            if (value !== hash.value) {
                                profile.boxing().updateCell(cell, {
                                    value: value
                                });
                                b = 1
                            }
                            if (!value) {
                                value = null
                            }
                            target.each(function (o) {
                                if (value != o.theme) {
                                    if (value) {
                                        o.theme = value
                                    } else {
                                        delete o.theme
                                    }
                                }
                            });
                            if (b) {
                                return false
                            }
                        } else {
                            if (property == "alias") {
                                if (value == target.alias) {
                                    return false
                                }
                                var hash = this.getNames();
                                if (!value) {
                                    return false
                                }
                                if (hash[value]) {
                                    xui.message(xui.getRes("RAD.designer.nameExists", value));
                                    return false
                                }
                                this.listObject.setUIValue(value, true);
                                target.setAlias(value)
                            } else {
                                target[property](value)
                            }
                        }
                    }
                }
            } catch (e) {
                throw (e);
                return false
            }
        },
        $tg_click: function (profile, row, e, src) {
            if (row.group) {
                return
            }
            var page = this,
                i = row.tipv,
                name = (row.tipk == "property" ? "get" + _.str.initial(i) : i) || "",
                widget, key, fun;
            if (!(widget = profile.$widget)) {
                return
            }
            if (widget == page.canvas) {
                key = "xui.Com"
            } else {
                if (!(key = widget.get(0) && widget.get(0).key)) {
                    return
                }
            }
            if (row.tipk == "class") {
                CONF.openAPI(key)
            } else {
                CONF.openAPI(key + (key == "xui.Com" ? (name ? "." : "") : ".prototype" + (name ? "." : "")) + name)
            }
        },
        $tg_tips: function (profile, node, pos) {
            var page = this,
                ks = profile.keys,
                cell, sid, id, pid, o, widget, key, row, str = "";
            if (profile.properties.disabled) {
                return
            }
            if (!(widget = profile.$widget)) {
                return
            }
            if (widget == page.canvas) {
                key = "xui.Com"
            } else {
                if (!(key = widget.get(0) && widget.get(0).key)) {
                    return
                }
            }
            id = node.id;
            pid = node.parentNode && node.parentNode.id;
            if (!id || !pid) {
                return
            }
            sid = profile.getSubId(id);
            if (id.indexOf(ks.FCELL) == 0 || pid.indexOf(ks.FCELL) == 0) {
                cell = row = profile.rowMap[sid];
                if (!cell) {
                    return true
                }
            } else {
                if (id.indexOf(ks.CELL) == 0 || pid.indexOf(ks.CELL) == 0) {
                    cell = profile.cellMap[sid];
                    if (!cell) {
                        return true
                    }
                    row = cell._row
                }
            }
            if (row) {
                if (row.tipk) {
                    if (row.tipk == "class") {
                        str += "<div>" + key + " [Class]</div>"
                    } else {
                        if (row.tipk == "fun") {
                            str += "<div>" + key + " [function] : <b>" + row.tipv + "</b></div> "
                        } else {
                            if (row.tipk == "property") {
                                str += "<div>" + key + " [property] : <b>" + row.tipv + "</b></div> "
                            } else {
                                if (row.tipk == "event") {
                                    str += "<div>" + key + " [event] : <b>" + row.tipv + "</b> </div>"
                                }
                            }
                        }
                    }
                    if (CONF.designer_editMode != "simple") {
                        if (row.tipk == "class" || cell.value == row.tipv) {
                            str += '<div><em style="background-color:#EBEADB;">' + xui.getRes("RAD.designer.openapi") + "</em></div>"
                        }
                    }
                    xui.Tips.show(pos, str)
                } else {
                    if (cell.tips) {
                        xui.Tips.show(pos, cell.tips)
                    }
                }
            } else {
                xui.Tips.hide()
            }
            return true
        },
        $profilegrid_onrequestdata: function (profile, item, callback) {
            return this.__buildSubRows(profile.$widget, item.id)
        },
        __buildSubRows: function (uis, id, specailFlag) {
            var cv, arr = [],
                t, page = this,
                deeppage = this,
                data = page._cls,
                type, caption, cellEx, len = uis._nodes.length;
            var target = uis.get(len - 1),
                dm = target.box.$DataModel,
                format, listKey, editorListItems, list, $tag, $fun, $tagVar, value, editorReadonly, editorDisabled;
            var specailItems = len === 1 ? (CONF.widgets_xprops[target.key] || []) : [];
            if (id == "properties" || id == "special") {
                _.each(target.box.$DataStruct, function (o, i) {
                    if (CONF.widgets_hideProps && CONF.widgets_hideProps[i]) {
                        return
                    }
                    caption = cellEx = null;
                    $tagVar = null;
                    if (i.charAt(0) == "_" || i.charAt(0) == "$") {
                        return
                    }
                    if (dm[i].hidden) {
                        return
                    }
                    var inSpecial = _.arr.indexOf(specailItems, i) != -1;
                    if (specailFlag === true ? !inSpecial : inSpecial) {
                        return
                    }
                    type = "none";
                    list = null;
                    editorReadonly = false;
                    editorDisabled = false;
                    listKey = null;
                    $tag = "";
                    cv = "";
                    if (dm[i].inner && !dm[i].trigger) {
                        return
                    } else {
                        if (i == "dataBinder") {
                            type = "combobox";
                            var nodes = page.getWidgets(true),
                                arr2 = [];
                            _.arr.each(nodes, function (o) {
                                if (o.key == "xui.DataBinder") {
                                    arr2.push(o.properties.name)
                                }
                            });
                            if (arr2 && arr2.length) {
                                editorListItems = arr2
                            }
                        } else {
                            if (i == "renderer") {
                                type = "popbox";
                                editorReadonly = true;
                                $tag = null;
                                $fun = function (profile, cell) {
                                    var o = cell.$tagVar;
                                    if (!o) {
                                        return
                                    }
                                    var node = profile.getSubNode("CELL", cell._serialId);
                                    xui.ComFactory.getCom("objEditor", function () {
                                        this.host = page;
                                        this.setProperties({
                                            image: CONF.img_app,
                                            imagePos: "-32px -32px",
                                            caption: o.widgetName + " => renderer ",
                                            text: typeof o.ini == "function" ? String(o.ini) : "function(){\n}",
                                            fromRegion: node.cssRegion(true),
                                            tagVar: o,
                                            onOK: function (page) {
                                                this._change();
                                                var tagVar = page.properties.tagVar,
                                                    code = page.properties.result.code;
                                                o.ini = tagVar.profile.properties.renderer = code !== null ? new Function(_.fun.args(code), _.fun.body(code)) : null;
                                                node.focus()
                                            }
                                        });
                                        this.show()
                                    })
                                };
                                $tagVar = {
                                    widgetName: target.alias,
                                    profile: target,
                                    ini: target.properties[i]
                                };
                                cv = "[<strong> Function </strong>]"
                            } else {
                                if (dm[i].readonly) {
                                    type = "label";
                                    editorDisabled = true
                                } else {
                                    if (dm[i].custom) {
                                        type = "popbox";
                                        editorReadonly = true;
                                        cv = caption = "[<strong> custom </strong>]";
                                        if (_.isFun(dm[i].customIniCell)) {
                                            type = "label";
                                            cv = "";
                                            cellEx = dm[i].customIniCell(target, i)
                                        }
                                        $tag = null;
                                        $fun = function (profile, cell) {
                                            var tagVar = cell.$tagVar;
                                            if (!tagVar) {
                                                return
                                            }
                                            var node = profile.getSubNode("CELL", cell._serialId),
                                                callback = function (newValue, cellOptions) {
                                                    var b = tagVar.profile.boxing(),
                                                        fn = "set" + _.str.initial(tagVar.key);
                                                    if (!_.isFun(b[fn])) {
                                                        return
                                                    }
                                                    page._change();
                                                    b[fn](newValue);
                                                    if (cellOptions) {
                                                        profile.boxing().updateCell(cell, cellOptions)
                                                    }
                                                    node.focus()
                                                };
                                            dm[i].custom(tagVar.profile, tagVar.key, tagVar.profile.properties[tagVar.key], callback, page, profile, cell, node)
                                        };
                                        $tagVar = {
                                            profile: target,
                                            alias: target.alias,
                                            key: i
                                        }
                                    } else {
                                        if (dm[i].html) {
                                            type = "popbox";
                                            editorReadonly = true;
                                            $tag = null;
                                            $fun = function (profile, cell) {
                                                var o = cell.$tagVar;
                                                if (!o) {
                                                    return
                                                }
                                                var node = profile.getSubNode("CELL", cell._serialId);
                                                var html = o.profile.boxing()["get" + _.str.initial(o.name)]();
                                                xui.ComFactory.getCom("HTMLEditor", function () {
                                                    this.host = page;
                                                    this.setProperties({
                                                        caption: o.widgetName + " => " + o.name,
                                                        image: CONF.img_app,
                                                        imagePos: "-112px -48px",
                                                        text: html,
                                                        fromRegion: node.cssRegion(true),
                                                        tagVar: o,
                                                        onOK: function (page, html) {
                                                            var t, tagVar = page.properties.tagVar,
                                                                b = tagVar.profile.boxing(),
                                                                fn = "set" + _.str.initial(o.name);
                                                            if (!_.isFun(b[fn])) {
                                                                return
                                                            }
                                                            this._change();
                                                            b[fn](html);
                                                            node.focus()
                                                        }
                                                    });
                                                    this.show()
                                                })
                                            };
                                            $tagVar = {
                                                widgetName: target.alias,
                                                profile: target,
                                                name: i
                                            };
                                            cv = caption = "[<strong> HTML </strong>]"
                                        } else {
                                            if (dm[i].listbox) {
                                                type = "listbox";
                                                list = [];
                                                listKey = target.key + ":properties:" + i;
                                                if (_.isFun(dm[i].listbox)) {
                                                    var d = dm[i].listbox;
                                                    list = function () {
                                                        var a = d.call(target),
                                                            list = [];
                                                        _.arr.each(a, function (o) {
                                                            list.push({
                                                                id: o,
                                                                caption: o,
                                                                value: o
                                                            })
                                                        });
                                                        return list
                                                    }
                                                } else {
                                                    if (_.isObj(dm[i].listbox[0])) {
                                                        list = _.copy(dm[i].listbox)
                                                    } else {
                                                        _.arr.each(dm[i].listbox, function (o, i) {
                                                            list.push({
                                                                id: o,
                                                                caption: o
                                                            })
                                                        })
                                                    }
                                                }
                                                xui.UI.cacheData(listKey, list)
                                            } else {
                                                if (dm[i].combobox) {
                                                    type = "combobox";
                                                    list = [];
                                                    if (_.isFun(dm[i].combobox)) {
                                                        var d = dm[i].combobox;
                                                        list = function () {
                                                            var a = d.call(target),
                                                                list = [];
                                                            _.arr.each(a, function (o) {
                                                                list.push({
                                                                    id: o,
                                                                    caption: o
                                                                })
                                                            });
                                                            return list
                                                        }
                                                    } else {
                                                        if (_.isObj(dm[i].combobox[0])) {
                                                            list = _.copy(dm[i].combobox)
                                                        } else {
                                                            _.arr.each(dm[i].combobox, function (o, i) {
                                                                list.push({
                                                                    id: o,
                                                                    caption: o
                                                                })
                                                            })
                                                        }
                                                    }
                                                    listKey = target.key + ":properties:" + i;
                                                    xui.UI.cacheData(listKey, list)
                                                } else {
                                                    if (dm[i].helpinput) {
                                                        listKey = target.key + ":properties:" + i;
                                                        type = "helpinput";
                                                        list = _.copy(dm[i].helpinput);
                                                        xui.UI.cacheData(listKey, list)
                                                    } else {
                                                        if (dm[i].trigger) {
                                                            type = "button";
                                                            editorReadonly = true;
                                                            cv = caption = "<strong> Invoke </strong>";
                                                            value = i;
                                                            $fun = function (profile, cell, pro) {
                                                                var o = cell.$tagVar;
                                                                if (!o) {
                                                                    return
                                                                }
                                                                _.tryF(o.trigger, null, o.profile.boxing())
                                                            };
                                                            $tagVar = {
                                                                profile: target,
                                                                name: i,
                                                                trigger: dm[i].trigger
                                                            }
                                                        } else {
                                                            if (_.isBool(o)) {
                                                                type = "checkbox";
                                                                $tag = i
                                                            } else {
                                                                if (page._map1[i]) {
                                                                    type = "input"
                                                                } else {
                                                                    if (dm[i].format) {
                                                                        if (!(window.xuiBuilder && window.xuiBuilder.KEY == "UIDesigner") && CONF.designer_editMode != "simple" && (dm[i].format == "image" || dm[i].format == "flash")) {
                                                                            type = "popbox";
                                                                            $tag = null;
                                                                            $fun = function (profile, cell) {
                                                                                var o = cell.$tagVar;
                                                                                if (!o) {
                                                                                    return
                                                                                }
                                                                                var node = profile.getSubNode("CELL", cell._serialId);
                                                                                var path = o.profile.boxing()["get" + _.str.initial(o.name)]();
                                                                                xui.ComFactory.getCom("FileSelector", function () {
                                                                                    this.host = page;
                                                                                    this.setProperties({
                                                                                        caption: o.widgetName + " => " + o.name,
                                                                                        image: CONF.img_app,
                                                                                        imagePos: "-48px 0",
                                                                                        text: path,
                                                                                        fromRegion: node.cssRegion(true),
                                                                                        tagVar: o,
                                                                                        onOK: function (page, path) {
                                                                                            var t, tagVar = page.properties.tagVar,
                                                                                                b = tagVar.profile.boxing(),
                                                                                                fn = "set" + _.str.initial(o.name);
                                                                                            if (!_.isFun(b[fn])) {
                                                                                                return
                                                                                            }
                                                                                            this._change();
                                                                                            if (path && SPA.curProject) {
                                                                                                path = path.replace(/\\/g, "/").replace(SPA.curProject.replace(/\\/g, "/") + "/", "{/}")
                                                                                            }
                                                                                            b[fn](path);
                                                                                            profile.boxing().updateCell(cell, {
                                                                                                value: path
                                                                                            }, false, false);
                                                                                            node.focus()
                                                                                        }
                                                                                    });
                                                                                    this.show()
                                                                                })
                                                                            };
                                                                            $tagVar = {
                                                                                widgetName: target.alias,
                                                                                profile: target,
                                                                                name: i
                                                                            }
                                                                        } else {
                                                                            type = "input"
                                                                        }
                                                                    } else {
                                                                        if (_.isNumb(o)) {
                                                                            type = "number"
                                                                        } else {
                                                                            if (_.isObj(o)) {
                                                                                type = "popbox";
                                                                                editorReadonly = true;
                                                                                $tag = null;
                                                                                $fun = function (profile, cell) {
                                                                                    var o = cell.$tagVar;
                                                                                    if (!o) {
                                                                                        return
                                                                                    }
                                                                                    var node = profile.getSubNode("CELL", cell._serialId);
                                                                                    var obj = o.profile.boxing()["get" + _.str.initial(o.name)]();
                                                                                    xui.ComFactory.getCom("objEditor", function () {
                                                                                        this.host = page;
                                                                                        this.setProperties({
                                                                                            caption: o.widgetName + " => " + o.name,
                                                                                            image: CONF.img_app,
                                                                                            imagePos: obj.constructor == Array ? "-128px -32px" : "-16px -32px",
                                                                                            text: xui.Coder.formatText(_.stringify(_.clone(obj, function (o, i) {
                                                                                                return (i + "").charAt(0) != "_"
                                                                                            }))),
                                                                                            fromRegion: node.cssRegion(true),
                                                                                            tagVar: o,
                                                                                            onOK: function (page) {
                                                                                                var t, tagVar = page.properties.tagVar,
                                                                                                    b = tagVar.profile.boxing(),
                                                                                                    fn = "set" + _.str.initial(o.name);
                                                                                                if (!_.isFun(b[fn])) {
                                                                                                    return
                                                                                                }
                                                                                                this._change();
                                                                                                b[fn](page.properties.object);
                                                                                                if ("dockMargin" == o.name) {
                                                                                                    deeppage.resizer.rePosSize()
                                                                                                }
                                                                                                node.focus();
                                                                                                if (o.name == "items") {
                                                                                                    if (null === page.properties.object) {
                                                                                                        b.setItems([])
                                                                                                    }
                                                                                                    if (t = tagVar.profile.behavior.PanelKeys) {
                                                                                                        deeppage._giveHandler(tagVar.profile)
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        });
                                                                                        this.show()
                                                                                    })
                                                                                };
                                                                                $tagVar = {
                                                                                    widgetName: target.alias,
                                                                                    profile: target,
                                                                                    name: i
                                                                                };
                                                                                cv = caption = "[<strong> key/value pairs</strong>]"
                                                                            } else {
                                                                                type = "input"
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    cv = cv || target.properties[i];
                    if (_.isStr(cv)) {}
                    var cell = {
                        value: cv,
                        type: type,
                        disabled: editorDisabled,
                        editorReadonly: editorReadonly,
                        $tag: $tag,
                        event: $fun,
                        $tagVar: $tagVar,
                        editorListKey: listKey,
                        editorListItems: editorListItems
                    };
                    if (caption) {
                        cell.caption = caption
                    }
                    if (cellEx) {
                        _.merge(cell, cellEx, "all")
                    }
                    arr.push({
                        id: "properties:" + i,
                        tipk: "property",
                        tipv: i,
                        value: i,
                        caption: i,
                        cells: [cell]
                    })
                })
            }
            if (id != "special") {
                arr.sort(function (x, y) {
                    x = x.value || "";
                    y = y.value || "";
                    return x > y ? 1 : x == y ? 0 : -1
                })
            }
            if (id == "UIE" || id == "special") {
                var $fun = function (profile, cell) {
                        if (page.hasTask()) {
                            return
                        }
                        var o = cell.$tagVar;
                        if (!o) {
                            return
                        }
                        var funname;
                        if (!cell.value) {
                            funname = "_" + o.widgetName.toLowerCase().replace(/\./g, "_") + "_" + o.key.toLowerCase();
                            profile.boxing().updateCell(cell.id, {
                                value: funname
                            }, false, true)
                        } else {
                            funname = cell.value
                        }
                        page.resetTaskList();
                        if (page._dirty) {
                            var nodes = page.getWidgets(true);
                            var code = ("{\n" + page.getJSCode(nodes)).replace(/\n/g, "\n" + _.str.repeat(" ", 12)) + "\n" + _.str.repeat(" ", 8) + "}";
                            page.resetCode(o.path, "iniComponents", code, false, true)
                        }
                        if (!page._cls.Instance[funname]) {
                            var code = o.ini.toString().replace(/\s*\}$/, "") + "\n" + _.str.repeat(" ", 4) + "var ns = this, uictrl = profile.boxing();\n}";
                            page.addCode(o.path, funname, code)
                        }
                        page.addTask(function () {
                            page.focusEditor(o.path, funname)
                        });
                        page.startTaskList();
                        page._dirty = false
                    };
                _.each(target.box.$EventHandlers, function (o, i) {
                    if (specailItems) {
                        var inSpecial = _.arr.indexOf(specailItems, i) != -1;
                        if (specailFlag === true ? !inSpecial : inSpecial) {
                            return
                        }
                    }
                    $tagVar = {
                        widgetName: target.alias,
                        path: "Instance",
                        key: i,
                        ini: o
                    };
                    arr.push({
                        id: "event:" + i,
                        tipk: "event",
                        tipv: i,
                        value: i,
                        caption: i,
                        cells: [{
                            value: typeof target[i] == "string" ? target[i] : "",
                            type: "popbox",
                            $tagVar: $tagVar,
                            event: $fun
                        }]
                    });
                    arr.sort(function (x, y) {
                        x = x.value || "";
                        y = y.value || "";
                        return x > y ? 1 : x == y ? 0 : -1
                    })
                })
            }
            _.filter(arr, function (o, i) {
                var ns = uis._nodes,
                    key = o.value,
                    value = o.cells[0].value,
                    prop;
                for (var i = 0; i < ns.length - 1; i++) {
                    prop = ns[i].properties;
                    if (!(key in prop)) {
                        return false
                    }
                    if (prop[key] !== value) {
                        return false
                    }
                }
            });
            return arr
        },
        $iconlist_aftervalueupdated: function (profile, ov, nv) {
            if (nv) {
                this.resizer.resetTarget(null, false);
                this._setSelected([nv], true)
            }
        },
        $listobject_onlistshow: function (profile, pos) {
            var page = this;
            if (!page.objlistBlock) {
                page.objlistBlock = new xui.UI.Block({
                    width: 200,
                    height: 400,
                    borderType: "ridge",
                    background: "#fff",
                    shadow: true,
                    resizer: true
                });
                if (!page.frame || !page.frame.get(0)) {
                    page.frame = xui.create('<div style="z-index:2000;background-color:red;position:absolute;font-size:0;line-height:0;display:none;">').css("opacity", 0.3);
                    xui("body").append(page.frame)
                }
                page.treebarObj = new xui.UI.TreeBar({
                    group: false,
                    selMode: "none",
                    caption: null
                }, {
                    onItemSelected: function (profile, item, src) {
                        page.selectWidget(item.id);
                        profile.parent.getRoot().css("display", "none");
                        page.frame.css("display", "none");
                        profile.boxing().clearItems();
                        _.asyRun(function () {
                            page._focus()
                        });
                        return false
                    },
                    beforeHoverEffect: function (profile, item, e, src, type) {
                        if (!item) {
                            return
                        }
                        if (item.id == this.canvas.get(0).$xid) {
                            return
                        }
                        if (type == "mouseover") {
                            _.resetRun("", function () {
                                var v = xui.getObject(item.id);
                                if (v && (v = v.getRoot())) {
                                    page.frame.cssRegion(v.cssRegion(true)).css("display", "block")
                                }
                            }, 100)
                        } else {
                            _.resetRun("", function () {
                                page.frame.css("display", "none")
                            }, 100)
                        }
                    }
                }, page);
                page.objlistBlock.append(page.treebarObj).render(true)
            }
            var items = [];
            var fun = function (profile, items, map) {
                    if ((page.$inplaceEditor && page.$inplaceEditor.get(0)) == profile) {
                        return
                    }
                    var self = arguments.callee,
                        t, item = {
                            id: profile.$xid,
                            caption: profile.alias,
                            image: (t = map[profile.box.KEY]) ? t.image : "",
                            imagePos: (t = map[profile.box.KEY]) ? t.imagePos : ""
                        };
                    items.push(item);
                    if (profile.children && profile.children.length) {
                        var sub = [];
                        item.sub = sub;
                        _.arr.each(profile.children, function (o) {
                            self.call(null, o[0], sub, map)
                        })
                    }
                };
            fun(page.canvas.get(0), items, CONF.mapWidgets);
            page.treebarObj.setItems(items).toggleNode(page.canvas.get(0).$xid, true, true);
            var node = page.objlistBlock.reBoxing();
            node.popToTop(profile.getRoot());
            var unFun = function () {
                    node.css("display", "none");
                    page.treebarObj.clearItems();
                    page.frame.css("display", "none");
                    xui.Event.keyboardHook("esc")
                };
            node.setBlurTrigger("design:pop:objecttree", unFun);
            xui.Event.keyboardHook("esc", 0, 0, 0, unFun)
        },
        $unique: function (arr) {
            var i, l, a = _.copy(arr);
            arr.length = 0;
            for (i = 0, l = a.length; i < l; i++) {
                if (_.arr.indexOf(arr, a[i]) == -1) {
                    arr[arr.length] = a[i]
                }
            }
            return arr
        },
        getWidgets: function (flag) {
            if (!flag) {
                this._clearSelect(this.canvas.get(0))
            }
            var page = this,
                arr = [],
                c = page.canvas.get(0).children || page.canvas.get(0).childNodes;
            _.arr.each(c, function (o) {
                if ((page.$inplaceEditor && page.$inplaceEditor.get(0)) == o[0]) {
                    return
                }
                arr.push(o[0])
            });
            var items = this.iconlist.getItems();
            if (items && items.length) {
                _.arr.each(items, function (o, i) {
                    arr.push(xui.getObject(o.id))
                })
            }
            return this.$unique(arr)
        },
        getJSONCode: function (nodes) {
            var f = function (x, y) {
                    x = parseInt((x[0] || x).properties.tabindex) || 0;
                    y = parseInt((y[0] || y).properties.tabindex) || 0;
                    return x > y ? 1 : x == y ? 0 : -1
                },
                fun = function (arr) {
                    arr.sort(f);
                    for (var i = 0; i < arr.length; i++) {
                        if ((arr[i][0] || arr[i]).children && (arr[i][0] || arr[i]).children.length) {
                            (arr[i][0] || arr[i]).children.sort(f)
                        }
                    }
                };
            fun(nodes);
            return "return xui.create(" + _.stringify(nodes) + ").get();"
        },
        getJSCode: function (nodes) {
            nodes.sort(function (x, y) {
                x = parseInt(x.properties.tabindex) || 0;
                y = parseInt(y.properties.tabindex) || 0;
                return x > y ? 1 : x == y ? 0 : -1
            });
            var t, arr = [];
            arr.push("// [[Code created by CrossUI RAD Tools\n");
            arr.push("var host=this, children=[], append=function(child){children.push(child.get(0));};");
            var fun = function (v, pName, argsStr, arr) {
                    var self = arguments.callee,
                        ui = v.box["xui.UI"],
                        o = v.serialize(false),
                        name = o.alias,
                        b, t, ins = v.boxing();
                    delete o.id;
                    if (o.properties && o.properties.dropKeys) {
                        if (o.properties.dropKeys == v.box.$DataStruct.dropKeys) {
                            delete o.properties.dropKeys
                        }
                    }
                    if (o.theme) {
                        o.theme = ("" + o.theme).replace(/[^a-zA-Z0-9-]/g, "")
                    }
                    if (_.isEmpty(o.properties)) {
                        delete o.properties
                    }
                    if (_.isEmpty(o.events)) {
                        delete o.events
                    }
                    if (!o.theme) {
                        delete o.theme
                    }
                    if (_.isEmpty(o.CS)) {
                        delete o.CS
                    }
                    if (_.isEmpty(o.CC)) {
                        delete o.CC
                    }
                    if (_.isEmpty(o.CB)) {
                        delete o.CB
                    }
                    if (_.isEmpty(o.CF)) {
                        delete o.CF
                    }
                    arr.push("\n\n");
                    if (pName) {
                        arr.push(pName + ".append((new " + o.key + "())")
                    } else {
                        arr.push("append((new " + o.key + "())")
                    }
                    arr.push('\n.setHost(host,"' + name + '")');
                    if (o.theme) {
                        arr.push('\n.setTheme("' + o.theme + '")')
                    }
                    if (o.domId != o.$domId) {
                        arr.push('\n.setDomId("' + o.domId + '")')
                    }
                    if (o.properties) {
                        _.each(o.properties, function (o, i) {
                            if (i == "value") {
                                return
                            }
                            t = "set" + _.str.initial(i);
                            if (typeof ins[t] == "function") {
                                arr.push("\n." + t + "(" + _.stringify(o) + ")")
                            }
                        });
                        if (typeof ins.setValue == "function" && "value" in o.properties) {
                            arr.push("\n.setValue(" + _.stringify(o.properties.value) + ")")
                        }
                    }
                    if (o.events) {
                        _.each(o.events, function (o, i) {
                            arr.push("\n." + i + "(" + _.stringify(o) + ")")
                        })
                    }
                    if (o.CS) {
                        arr.push("\n.setCustomStyle(" + _.stringify(o.CS) + ")")
                    }
                    if (o.CC) {
                        arr.push("\n.setCustomClass(" + _.stringify(o.CC) + ")")
                    }
                    if (o.CB) {
                        arr.push("\n.setCustomBehavior(" + _.stringify(o.CB) + ")")
                    }
                    if (o.CF) {
                        arr.push("\n.setCustomFunction(" + _.stringify(o.CF) + ")")
                    }
                    if (pName) {
                        arr.push("\n" + (argsStr ? (", " + argsStr) : "") + ");")
                    } else {
                        arr.push("\n);")
                    }
                    if (v.children && v.children.length) {
                        _.arr.each(v.children, function (o) {
                            var j = o[0],
                                sa = [],
                                s;
                            for (var i = 1; i < o.length; i++) {
                                switch (typeof o[i]) {
                                case "number":
                                    sa.push(o[i]);
                                    break;
                                case "string":
                                    sa.push('"' + o[i] + '"');
                                    break
                                }
                            }
                            if (sa.length) {
                                s = sa.join(",")
                            } else {
                                s = null
                            }
                            self.call(this, j, "host." + name, s, arr)
                        }, this)
                    }
                };
            _.arr.each(nodes, function (v) {
                fun(v, null, null, arr)
            });
            arr.push("\n\n");
            arr.push("return children;\n");
            arr.push("// ]]Code created by CrossUI RAD Tools");
            return _.fromUTF8(arr.join(""))
        },
        getNames: function () {
            var nodes = this.getWidgets(true);
            var page = this,
                t, hash = {};
            var fun = function (target) {
                    var self = arguments.callee;
                    hash[target.alias] = target;
                    if (target.children && target.children.length) {
                        _.arr.each(target.children, function (o) {
                            self.call(null, o[0])
                        })
                    }
                };
            _.arr.each(nodes, function (o) {
                fun(o)
            });
            return hash
        },
        selectWidget: function (ids) {
            if (!_.isArr(ids)) {
                ids = [ids]
            }
            var profile = xui.getObject(ids[0]);
            var p = profile.parent;
            if (p.setSelectFromPanel) {
                p.setSelectFromPanel.call(p, profile.getRoot().parent(), ids);
                this._setSelected(ids, true)
            } else {
                this._clearSelect();
                this._setSelected(null, true)
            }
        },
        activate: function () {},
        setLinkObj: function (obj) {
            this._cls = obj
        },
        refreshView: function (obj, onlyCavas) {
            var self = this;
            if (!onlyCavas) {
                self._cls = obj
            }
            var ns = self.getWidgets();
            _.arr.each(ns, function (o) {
                o.boxing().destroy()
            });
            self.iconlist.clearItems();
            self.canvas.reBoxing().empty();
            var fun = onlyCavas ? obj : _.get(obj, ["Instance", "iniComponents"]);
            if (fun) {
                xui.Dom.setCover(xui.getRes("RAD.designer.createContent"));
                fun = new Function([], typeof fun == "string" ? fun : _.fun.body(fun));
                try {
                    self.$host = {};
                    var nodes = fun.call(self.$host) || [],
                        n2 = [];
                    _.filter(nodes, function (target) {
                        if (!(target.box["xui.UI"] && !target.box.$noDomRoot)) {
                            n2.push(target);
                            return false
                        }
                    });
                    _.arr.each(nodes, function (o) {
                        self._designable(o)
                    });
                    self.canvas.append(xui.UI.pack(nodes, false));
                    _.arr.each(n2, function (target) {
                        self.iconlist.insertItems([{
                            id: target.$xid,
                            image: xui.ini.img_bg,
                            tips: target.key,
                            imgStyle: "background:url(" + CONF.mapWidgets[target.box.KEY].image + ") " + CONF.mapWidgets[target.box.KEY].imagePos
                        }], null, false)
                    });
                    var t = self.layoutBase.reBoxing();
                    if (t.css("display") == "none") {
                        t.css("display", "block");
                        t.parent().css("background", "")
                    }
                    _.asyRun(function () {
                        xui.UI.pack(nodes, false).adjustDock()
                    })
                } catch (e) {
                    self.iconlist.clearItems();
                    self.canvas.reBoxing().empty();
                    self.layoutBase.reBoxing().css("display", "none").parent().css("background", "url(" + xui.getPath("img/", "error.gif") + ")");
                    xui.message(xui.getRes("RAD.designer.comCodeErr"));
                    xui.pop(e.description || e.message)
                }
                xui.Dom.setCover(false)
            }
            self._dirty = false;
            self._clearSelect();
            self._setSelected([], true);
            return fun
        },
        refreshViewSize: function (obj) {
            var self = this;
            var viewSize = _.get(obj, ["Static", "viewSize"]) || self.$viewSize["800"];
            self.setViewSize(viewSize);
            self._demenstiondirty = false;
            return _.stringify(viewSize)
        },
        _popvs_onmenusel: function (p, item) {
            var page = this;
            page.setViewSize(page.$viewSize[item.id])
        },
        setViewSize: function (size) {
            var page = this,
                w = page.canvas.getWidth(),
                h = page.canvas.getHeight(),
                b;
            if ("width" in size) {
                size.width = parseInt(size.width, 10);
                if (!_.isNumb(size.width) || size.width <= 0) {
                    size.width = page.$viewSize["800"].width
                }
            }
            if ("height" in size) {
                size.height = parseInt(size.height, 10);
                if (!_.isNumb(size.height) || size.height <= 0) {
                    size.height = page.$viewSize["800"].height
                }
            }
            if (size.width && String(size.width) != String(w)) {
                page.canvas.setWidth(size.width);
                page.panelBG.setWidth(size.width);
                b = 1
            }
            if (size.height && String(size.height) != String(h)) {
                page.canvas.setHeight(size.height);
                page.panelBG.setHeight(size.height);
                b = 1
            }
            if (b) {
                w = size.width || w;
                h = size.height || h;
                page.toolbar.updateItem("viewsize", {
                    caption: w + " &#215 " + h
                });
                page.$curViewSize = {
                    width: w,
                    height: h
                };
                page._demenstiondirty = true;
                var t = page.profileGrid;
                if (t && (t = t.get(0).$widget) && (t.get(0) == page.canvas.get(0))) {
                    page.profileGrid.updateCellByRowCol("properties:width", "value", {
                        value: w
                    });
                    page.profileGrid.updateCellByRowCol("properties:height", "value", {
                        value: h
                    })
                }
            }
        },
        reLayout: function (force) {
            this.toolbar.reLayout(force)
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.PopMenu).setHost(host, "popViewSize").onMenuSelected("_popvs_onmenusel"));
            append((new xui.UI.Layout).setHost(host, "layoutBase").setItems([{
                id: "before",
                pos: "before",
                locked: false,
                cmd: true,
                size: 170,
                min: 100,
                max: 300,
                hide: false,
                folded: false,
                hidden: false
            }, {
                id: "main",
                min: 10
            }, {
                id: "after",
                pos: "after",
                locked: false,
                cmd: false,
                size: 265,
                min: 100,
                max: 350,
                hide: false,
                folded: false,
                hidden: false
            }]).setType("horizontal"));
            host.layoutBase.append((new xui.UI.ToolBar).setHost(host, "toolbar").setItems([]).onClick("$toolbar_onclick"), "main");
            host.layoutBase.append((new xui.UI.Panel).setHost(host, "panelRigth").setCaption("$RAD.designer.configwnd").setCustomStyle({
                PANEL: "overflow:hidden"
            }), "after");
            host.panelRigth.append((new xui.UI.ComboInput).setHost(host, "listObject").setDirtyMark(false).setDock("top").setType("popbox").setInputReadonly(true).beforeComboPop("$listobject_onlistshow"));
            host.panelRigth.append((new xui.UI.TreeGrid).setHost(host, "profileGrid").setDirtyMark(false).setEditable(true).setGridHandlerCaption("$RAD.designer.gridcol1").setRowHandlerWidth(100).setColSortable(false).setHeader([{
                id: "value",
                caption: "$RAD.designer.gridcol2",
                width: 120,
                type: "input"
            }]).onShowTips("$tg_tips").onGetContent("$profilegrid_onrequestdata").beforeCellUpdated("$profilegrid_beforecellvalueset").onDblclickRow("$tg_click"));
            host.layoutBase.append((new xui.UI.Panel).setHost(host, "panelLeft").setCaption("$RAD.designer.toolsbox").setCustomStyle({
                PANEL: "overflow:hidden"
            }), "before");
            host.panelLeft.append((new xui.UI.TreeBar).setHost(host, "treebarCom").setSelMode("none").setDragKey("___iDesign"));
            host.layoutBase.append((new xui.UI.Div).setHost(host, "panelDiv").setDock("fill").setCustomStyle({
                KEY: "overflow:auto;"
            }).setCustomClass({
                KEY: "xuidesign"
            }), "main");
            host.panelDiv.append((new xui.UI.Div).setHost(host, "panelBG").setLeft(5).setTop(5).setWidth(100).setHeight(100).setZIndex(10));
            host.panelBG.append((new xui.UI.Div).setHost(host, "panelBGl").setWidth(100).setHeight(100).setCustomStyle({
                KEY: "font-size:0;line-height:0;position:absolute;left:0;top:0;width:10px;height:100%;background:url(" + xui.getPath("img/designer/", "left.gif") + ") left top"
            }));
            host.panelBG.append((new xui.UI.Div).setHost(host, "panelBGb").setWidth(100).setHeight(100).setCustomStyle({
                KEY: "font-size:0;line-height:0;position:absolute;left:0;bottom:0;height:10px;width:100%;background:url(" + xui.getPath("img/designer/", "top.gif") + ") left bottom"
            }));
            host.panelBG.append((new xui.UI.Div).setHost(host, "panelBGt").setWidth(100).setHeight(100).setCustomStyle({
                KEY: "font-size:0;line-height:0;position:absolute;left:0;top:0;height:10px;width:100%;background:url(" + xui.getPath("img/designer/", "top.gif") + ") left top"
            }));
            host.panelBG.append((new xui.UI.Div).setHost(host, "panelBGr").setWidth(100).setHeight(100).setCustomStyle({
                KEY: "font-size:0;line-height:0;position:absolute;right:0;top:0;width:10px;height:100%;background:url(" + xui.getPath("img/designer/", "left.gif") + ") top right"
            }));
            host.panelDiv.append((new xui.UI.Pane).setHost(host, "canvas").setLeft(5).setTop(5).setWidth(100).setHeight(100).setZIndex(20).setCustomStyle({
                KEY: "overflow:visible"
            }).onContextmenu("_oncanvasmenu"));
            return children
        },
        iniExComs: function (com, threadid) {
            var host = this;
            host.layoutBase.append((new xui.UI.IconList).setHost(host, "iconlist").setDirtyMark(false).setDock("bottom").setHeight(40).setZIndex(10).setDisplay("none").afterUIValueSet("$iconlist_aftervalueupdated").setCustomStyle({
                KEY: "border-top:solid 1px #CDCDCD;"
            }), "main");
            if (CONF.designer_editMode != "simple") {
                host.iconlist.setDisplay("")
            }
        }
    },
    Static: {
        destroy: function () {
            this.objlistBlock.destroy();
            arguments.callee.upper.apply(this, arguments)
        }
    },
    Initialize: function () {
        xui.CSS.addStyleSheet(xui.UI.buildCSSText({
            ".xuidesign .panel": {
                "background-image": "url(" + xui.getPath("img/designer/", "bg.gif") + ")",
                "background-position": "left top",
                "background-repeat": "repeat"
            }
        }), "xui.UI.design");
        var preLoad = new Image();
        preLoad.src = xui.ini.path + "ondrag.gif";
        preLoad = null;
        var recover = function (obj) {
                var me = arguments.callee;
                _.arr.each(obj.$children, function (o) {
                    var o = xui.SC.get(o);
                    o._getChildren = xui.UI._getChildren;
                    if (o.$children) {
                        me(o)
                    }
                })
            };
        recover(xui.UI);
        if (CONF.serviceType == "remote") {
            window.onbeforeunload = function (e) {
                if (xui.browser.ie) {
                    window.event.returnValue = " "
                } else {
                    return " "
                }
            }
        } else {
            if (CONF.serviceType == "node-webkit") {
                var gui = require("nw.gui");
                var win = gui.Window.get();
                win.on("close", function () {
                    var ns = this;
                    SPA._dirtyWarn(function () {
                        var hash = NW.getStatus();
                        _.merge(hash, {
                            dftdir: NW._defaultdir || "deployed",
                            workspace: CONF.prjPath || "XUIWorkSpace",
                            theme: xui.getTheme(),
                            lang: xui.getLang(),
                            project: SPA ? SPA.curProjectName : "",
                            files: (SPA && SPA.tabsMain) ? SPA.tabsMain.getItems("min") : [],
                            file: (SPA && SPA.currentPage) || ""
                        }, "all");
                        NW.saveStatus(hash);
                        ns.close(true)
                    })
                })
            }
        }
        xui.doc.onContextmenu(function () {
            return false
        })
    }
});
Class("RAD.AddFile", "xui.Com", {
    Instance: {
        customAppend: function (parent) {
            var self = this,
                dlg = self.dialog,
                prop = self.properties,
                pp = prop.parent;
            if (prop.fromRegion) {
                dlg.setFromRegion(prop.fromRegion)
            }
            if (!dlg.get(0).renderId) {
                dlg.render()
            }
            self.treebar.resetValue();
            self.input.resetValue();
            self.inputTarget.resetValue();
            self.comboinput.setValue(".js", true);
            dlg.show(parent, true);
            if (self.properties.item) {
                var item = _.copy(self.properties.item);
                item.caption = item.id;
                item.readonly = true;
                delete item.sub;
                self.treebar.setValue(item.id, true).setItems([item], true)
            } else {
                CONF.callService({
                    key: CONF.requestKey,
                    paras: {
                        action: "open",
                        hashCode: _.id(),
                        type: "0",
                        path: pp.curProject
                    }
                }, function (txt) {
                    var obj = txt;
                    if (!obj || obj.error) {
                        xui.message(_.get(obj, ["error", "message"]) || "no response!")
                    } else {
                        var root = pp.buildFileItems(pp.curProject, obj.data);
                        self._rootId = root.id;
                        self.treebar.setItems([root]).openToNode(root.id)
                    }
                })
            }
        },
        reset: function () {
            var ns = this;
            ns.treebar.setValue(self._rootId || null, true);
            ns.input.setValue("", true).setType("none");
            ns.inputTarget.setValue("", true);
            ns.comboinput.setValue(".js", true)
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog()).setHost(host, "dialog").setLeft(240).setTop(80).setWidth(430).setHeight(280).setResizer(false).setCaption("$RAD.tool2.new").setImage("@CONF.img_app").setImagePos("-0px -16px").setMinBtn(false).setMaxBtn(false).onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Label()).setHost(host, "label4").setLeft(0).setTop(184).setWidth(80).setCaption("$RAD.addfile.target"));
            host.dialog.append((new xui.UI.Group()).setHost(host, "panelbar2").setDock("top").setHeight(140).setCaption("$RAD.addfile.sel").setToggleBtn(false).setCustomStyle({
                PANEL: "overflow:auto"
            }));
            host.panelbar2.append((new xui.UI.TreeView()).setHost(host, "treebar").setPosition("relative").onGetContent("_treebar_ongetcontent").onItemSelected("_refresh"));
            host.dialog.append((new xui.UI.Label()).setHost(host, "label1").setLeft(10).setTop(154).setWidth(70).setCaption("$RAD.addfile.filename"));
            host.dialog.append((new xui.UI.Label()).setHost(host, "label3").setLeft(230).setTop(154).setWidth(70).setCaption("$RAD.addfile.filetype"));
            host.dialog.append((new xui.UI.ComboInput()).setHost(host, "input").setLeft(80).setTop(150).setWidth(140).setDynCheck(true).setType("none").beforeUIValueSet("_beforeInpuSet").afterUIValueSet("_refresh"));
            host.dialog.append((new xui.UI.Input()).setHost(host, "inputTarget").setReadonly(true).setLeft(80).setTop(180).setWidth(330));
            host.dialog.append((new xui.UI.ComboInput()).setHost(host, "comboinput").setDirtyMark(false).setLeft(300).setTop(150).setWidth(110).setTabindex(2).setType("listbox").setItems([{
                id: "/",
                caption: "$RAD.addfile.iDir"
            }, {
                id: ".html",
                caption: "$RAD.addfile.iHtml"
            }, {
                id: ".css",
                caption: "$RAD.addfile.iCSS"
            }, {
                id: ".js",
                caption: "$RAD.addfile.iJs"
            }, {
                id: "upload",
                disabled: false,
                caption: "$RAD.addfile.iUpload"
            }]).setValue(".js").afterUIValueSet("_refresh"));
            host.dialog.append((new xui.UI.Button()).setHost(host, "btnCancel").setLeft(80).setTop(210).setWidth(90).setTabindex(3).setCaption("$RAD.cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.dialog.append((new xui.UI.Button()).setHost(host, "btnOK").setLeft(250).setTop(210).setWidth(90).setTabindex(4).setCaption("$RAD.ok").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            return children
        },
        _dialog_beforeclose: function (profile) {
            this.dialog.hide();
            return false
        },
        _btncancel_onclick: function (profile, e, value) {
            this.dialog.close()
        },
        _beforeInpuSet: function (profile, ov, nv) {
            if (profile.properties.type == "upload" && nv) {
                if (!CONF.fileExts.test(nv)) {
                    xui.message(xui.getRes("RAD.addfile.invalidExts"));
                    return false
                }
                if (!CONF.fileNames.test(nv)) {
                    xui.message(xui.getRes("RAD.addfile.invalidName"));
                    return false
                }
            }
        },
        _refresh: function (profile) {
            var self = this,
                s1 = self.treebar.getUIValue(),
                s2 = self.input.getUIValue(),
                s3 = self.comboinput.getUIValue();
            if (profile == self.comboinput.get(0)) {
                self.input.setValue("", true);
                if (s3 == "upload") {
                    self.input.setType("file")
                } else {
                    self.input.setType("none")
                }
            }
            if (s1) {
                var str = s1;
                if (s2 && s3 && s3 != "upload") {
                    str = s1 + "/" + s2 + s3
                }
                self.inputTarget.setValue(str, true)
            }
            return false
        },
        _btnok_onclick: function (profile, e, value) {
            var self = this,
                s = self.input.getUIValue(),
                type = self.comboinput.getUIValue();
            if (!s) {
                xui.message(xui.getRes("RAD.addfile.notarget"))
            } else {
                if (type != "upload") {
                    if (!/^[\w]{2,18}$/.test(s)) {
                        xui.message(xui.getRes("RAD.addfile.filenameformat"));
                        self.input.activate();
                        return
                    }
                }
                _.tryF(self.properties.onOK, [self.treebar.getUIValue(), self.treebar.getUIValue(), self.input.getUIValue(), type, type == "upload" ? self.input.getUploadObj() : null], self.host);
                self.dialog.close()
            }
        },
        _dialog_onhotkey: function (profile, key) {
            if (key.key == "esc") {
                profile.boxing().close()
            }
        },
        _treebar_ongetcontent: function (profile, item, callback) {
            var ns = this;
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "open",
                    type: "0",
                    hashCode: _.id(),
                    path: item.id
                }
            }, function (txt) {
                var obj = txt;
                if (obj && !obj.error) {
                    var root = ns.properties.parent.buildFileItems(item.id, obj.data);
                    callback(root.sub)
                } else {
                    xui.message(obj.error.message)
                }
            })
        }
    }
});
Class("RAD.DelFile", "xui.Com", {
    Instance: {
        customAppend: function (parent) {
            var self = this,
                prop = self.properties,
                pp = prop.parent,
                dlg = self.dialog;
            if (prop.fromRegion) {
                dlg.setFromRegion(prop.fromRegion)
            }
            if (!dlg.get(0).renderId) {
                dlg.render()
            }
            self.treebar.resetValue();
            dlg.show(parent, true);
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "open",
                    hashCode: _.id(),
                    path: pp.curProject
                }
            }, function (txt) {
                var obj = txt;
                if (!obj || obj.error) {
                    xui.message(_.get(obj, ["error", "message"]) || "no response!")
                } else {
                    var root = pp.buildFileItems(pp.curProject, obj.data);
                    self.treebar.setItems([root]).toggleNode(root.id, true)
                }
            })
        },
        _dialog_beforeclose: function (profile) {
            this.dialog.hide();
            return false
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(247).setTop(120).setWidth(433).setHeight(220).setResizer(false).setCaption("$RAD.tool2.del").setImage("@CONF.img_app").setImagePos("-80px -16px").setMinBtn(false).setMaxBtn(false).onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Button).setHost(host, "btnCancel").setLeft(80).setTop(150).setWidth(90).setCaption("$RAD.cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.dialog.append((new xui.UI.Button).setHost(host, "btnOK").setLeft(250).setTop(150).setWidth(90).setCaption("$RAD.ok").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            host.dialog.append((new xui.UI.Group).setHost(host, "panelbar2").setDock("top").setHeight(140).setCaption("$RAD.delfile.sel").setToggleBtn(false).setCustomStyle({
                PANEL: "overflow:auto"
            }));
            host.panelbar2.append((new xui.UI.TreeBar).setHost(host, "treebar").setDock("none").setWidth("auto").setHeight("auto").setPosition("relative").setSelMode("multi").beforeUIValueSet("_treebar_beforevalueupdated").onGetContent("_treebar_ongetcontent"));
            return children
        },
        _btncancel_onclick: function (profile, e, value) {
            this.dialog.close()
        },
        _btnok_onclick: function (profile, e, value) {
            var s = this.treebar.getUIValue(),
                self = this;
            if (!s) {
                xui.message(xui.getRes("RAD.delfile.notarget"))
            } else {
                xui.UI.Dialog.confirm(xui.getRes("RAD.delfile.confirmdel"), xui.getRes("RAD.delfile.confirmdel2", s.split(";").length), function () {
                    _.tryF(self.properties.onOK, [s], self.host);
                    self.dialog.close()
                })
            }
        },
        _treebar_beforevalueupdated: function (profile, oldValue, newValue) {
            if (!newValue) {
                return
            }
            var arr = newValue.split(";");
            arr.sort();
            _.filter(arr, function (o, j) {
                for (var i = 0, l = this.length; i < l; i++) {
                    if (i == j) {
                        break
                    }
                    var s = this[j].replace(this[i], "");
                    if (s != this[j] && (s.indexOf("/") != -1 || s.indexOf("\\") != -1)) {
                        return false
                    }
                }
            });
            return arr.join(";")
        },
        _dialog_onhotkey: function (profile, key) {
            if (key.key == "esc") {
                profile.boxing().close()
            }
        },
        _treebar_ongetcontent: function (profile, item, callback) {
            var ns = this;
            CONF.callService({
                key: CONF.requestKey,
                paras: {
                    action: "open",
                    hashCode: _.id(),
                    path: item.id
                }
            }, function (txt) {
                var obj = txt;
                if (obj && !obj.error) {
                    var root = ns.properties.parent.buildFileItems(item.id, obj.data);
                    callback(root.sub)
                } else {
                    xui.message(obj.error.message)
                }
            })
        }
    }
});
Class("RAD.About", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(250).setTop(150).setHeight(170).setResizer(false).setCaption("$RAD.menu.about").setMinBtn(false).setMaxBtn(false).onHotKeydown("_dialog_onhotkey").beforeClose("_dialog2_beforeclose"));
            host.dialog.append((new xui.UI.Div).setHost(host, "div12").setLeft(10).setTop(10).setWidth(260).setHeight(80).setHtml("<b>CrossUI RAD Tools</b> {ver}<br><br><i>Powered by CrossUI.<br>©2006-present All rights reserved.</i>"));
            host.dialog.append((new xui.UI.Button).setHost(host, "button3").setLeft(120).setTop(100).setWidth(50).setZIndex("10").setCaption("$inline.ok").onClick("_button3_onclick"));
            return children
        },
        _dialog2_beforeclose: function (profile) {
            profile.boxing().hide();
            return false
        },
        _dialog_onhotkey: function (profile, key) {
            if (key.key == "esc") {
                profile.boxing().close()
            }
        },
        _button3_onclick: function (profile, e, value) {
            this.dialog.close()
        },
        events: {
            onReady: "_com_onready"
        },
        _com_onready: function (com, threadid) {
            var html = this.div12.getHtml();
            html = html.replace("{ver}", CONF.version);
            this.div12.setHtml(html)
        }
    }
});
Class("UIDesigner", "xui.Com", {
    Instance: {
        $classEditor: null,
        $pageviewType: "xui.UI.Tabs",
        $firstView: "design",
        $dftCodePath: "template/",
        $dftCodeFileName: "index.js",
        $fetchedCode: "",
        $iniCode: "",
        $url: "",
        $dirty: false,
        onDestroy: function () {
            this.$classEditor.destroy()
        },
        events: {
            onReady: function () {
                SPA = this;
                xuiBuilder = this;
                xui.ComFactory.setProfile(CONF.ComFactoryProfile)
            },
            onRender: function (com, threadid) {
                com.setValue(com.$fetchedCode || com.$iniCode, com.$fetchedurl);
                com.$classEditor.setDftPage(com.$firstView)
            },
            afterIniComponents: function () {
                var self = this,
                    items;
                self.popLang.setItems(CONF.localeItems);
                switch (CONF.serviceType) {
                case "remote":
                    items = [{
                        id: "savetoserver",
                        caption: "$RAD.builder.savetoserver"
                    }, {
                        id: "saveasjs",
                        caption: "$RAD.builder.saveasjs"
                    }, {
                        id: "saveashtml",
                        caption: "$RAD.builder.saveashtml"
                    }, {
                        id: "saveasweb",
                        caption: "$RAD.builder.saveasweb"
                    }];
                    break;
                case "node-webkit":
                    items = [{
                        id: "saveasjs",
                        caption: "$RAD.builder.saveasjs"
                    }, ,
                    {
                        id: "saveashtml",
                        caption: "$RAD.builder.saveashtml"
                    }, {
                        id: "split1",
                        type: "split"
                    }, {
                        id: "saveasweb",
                        caption: "$RAD.builder.saveasweb"
                    }, {
                        id: "split1",
                        type: "split"
                    }, {
                        id: "saveaswin",
                        caption: "$RAD.builder.saveaswin"
                    }, {
                        id: "saveaslinux",
                        caption: "$RAD.builder.saveaslinux"
                    }, {
                        id: "saveaslinux64",
                        caption: "$RAD.builder.saveaslinux64"
                    }, {
                        id: "saveasosx",
                        caption: "$RAD.builder.saveasosx"
                    }, {
                        id: "split2",
                        type: "split"
                    }, {
                        id: "saveasmobile",
                        caption: "$RAD.builder.saveasmobile"
                    }];
                    request = function () {
                        return NW.request.apply(NW, arguments)
                    };
                    break
                }
                self.popSave.setItems(items);
                self.appRoot.append(new xui.UI.Button({
                    caption: xui.wrapRes("RAD.builder.save"),
                    tips: "$RAD.builder.saveTips",
                    zIndex: 100,
                    left: "auto",
                    top: 6,
                    right: 130,
                    width: 68,
                    height: 54,
                    type: "custom",
                    border: true,
                    renderer: function (item) {
                        return "<img src=img/save.png /><br />" + item.caption
                    }
                }, {
                    onClick: function (p, e, src) {
                        self.popSave.updateItem("savetoserver", {
                            disabled: !self.$url || xui.absIO.isCrossDomain(self.$url)
                        });
                        if (self.popSave.$lang != xui.getLang()) {
                            self.popSave.$lang = xui.getLang();
                            self.popSave.refresh()
                        }
                        self.popSave.pop(src)
                    }
                })).append(self.$btnRun = new xui.UI.Button({
                    caption: xui.wrapRes("RAD.builder.run"),
                    tips: "$RAD.builder.runTips",
                    zIndex: 100,
                    left: "auto",
                    top: 6,
                    right: 210,
                    width: 68,
                    height: 54,
                    type: "custom",
                    border: true,
                    renderer: function (item) {
                        return "<img src=img/run.gif /><br />" + item.caption
                    }
                }, {
                    onClick: function () {
                        var content = self.getValue(),
                            clsName = RAD.ClassTool.getClassName(content);
                        if (false === content) {
                            return
                        }
                        if (!clsName) {
                            xui.message(xui.getRes("RAD.classtool.noClass"));
                            return false
                        }
                        CONF.debugApp(CONF.testPath, {
                            testTpl: CONF.testTpl,
                            clsName: clsName,
                            content: content,
                            theme: xui.getTheme(),
                            lang: xui.getLang()
                        })
                    }
                }));
                self.$btnTheme = new xui.UI.Button({
                    type: "drop",
                    caption: xui.wrapRes("RAD.builder.themes.Vista"),
                    tips: "$RAD.builder.dftThemeTips",
                    position: "absolute",
                    top: 38,
                    right: 4,
                    left: "auto",
                    width: 110,
                    zIndex: 100
                }, {
                    onClick: function (profile, e, src) {
                        profile.boxing().onClickDrop(profile, e, src)
                    },
                    onClickDrop: function (profile, e, src) {
                        var callback = function (items) {
                                if (SPA.popTheme.$lang != xui.getLang()) {
                                    SPA.popTheme.$lang = xui.getLang();
                                    SPA.popTheme.refresh()
                                }
                                SPA.popTheme.pop(src)
                            };
                        if (SPA.popTheme.getTag()) {
                            callback()
                        } else {
                            CONF.callService({
                                key: CONF.requestKey,
                                paras: {
                                    action: "getThemes",
                                    hashCode: _()
                                }
                            }, function (txt) {
                                var obj = txt;
                                if (obj && !obj.error && obj.data) {
                                    var items = [];
                                    _.arr.each(obj.data, function (o) {
                                        items.push({
                                            id: o,
                                            caption: "$RAD.builder.themes." + o
                                        })
                                    });
                                    var fIndex = _.arr.subIndexOf(items, "id", "default"),
                                        first = items[fIndex];
                                    _.arr.removeFrom(items, fIndex);
                                    _.arr.insertAny(items, first, 0);
                                    SPA.popTheme.setItems(items);
                                    SPA.popTheme.setTag("Loaded");
                                    callback(items)
                                } else {
                                    xui.message(obj.error.message)
                                }
                            }, function (txt) {
                                xui.message(txt)
                            })
                        }
                    }
                });
                self.appRoot.append(self.$btnTheme);
                self.$btnLang = new xui.UI.Button({
                    type: "drop",
                    caption: xui.wrapRes("RAD." + xui.getLang()),
                    tips: "$RAD.langTips",
                    position: "absolute",
                    top: 6,
                    right: 4,
                    left: "auto",
                    width: 110,
                    zIndex: 100
                }, {
                    onClick: function (profile, e, src) {
                        profile.boxing().onClickDrop(profile, e, src)
                    },
                    onClickDrop: function (profile, e, src) {
                        if (SPA.popLang.$lang != xui.getLang()) {
                            SPA.popLang.$lang = xui.getLang();
                            SPA.popLang.refresh()
                        }
                        SPA.popLang.pop(src)
                    }
                });
                self.appRoot.append(self.$btnLang)
            }
        },
        iniResource: function (com, threadid) {
            var pd = xui("_post_data").html();
            pd = _.str.trim(pd);
            if (pd && pd.length > 1) {
                com.$iniCode = com.$fetchedCode = pd;
                return
            }
            var com = this,
                url = _.urlDecode(location.href.split("#")[1], "url");
            xui.Thread.suspend(threadid);
            var finish1 = false,
                finish2 = false,
                fun = function () {
                    if (finish1 && finish2) {
                        xui.Thread.resume(threadid)
                    }
                };
            if (!url) {
                finish2 = true
            }
            debugger;
            CONF.getLocalFile(com.$dftCodePath + xui.getLang() + "/" + (CONF.initFilePath || com.$dftCodeFileName), function (code) {
                com.$iniCode = code.replace("{className}", "App");
                finish1 = true;
                fun()
            }, function () {
                finish1 = true;
                fun();
                debugger;
                alert(xui.getRes("RAD.builder.noexist", com.$dftCodePath))
            });
            if (url) {
                com.$url = url;
                CONF.callService({
                    key: CONF.requestKey,
                    paras: {
                        action: "fetchwebfile",
                        path: url
                    }
                }, function (txt) {
                    var obj = txt;
                    if (!obj.error) {
                        com.$fetchedCode = obj.data;
                        com.$fetchedurl = url
                    } else {
                        xui.message(obj.error.message)
                    }
                    finish2 = true;
                    fun()
                }, function () {
                    finish2 = true;
                    fun();
                    alert(xui.getRes("RAD.builder.noexist", url))
                })
            }
        },
        iniExComs: function (com, threadid) {
            var com = this;
            xui.ComFactory.newCom("RAD.JSEditor", function (threadid) {
                var inn = this;
                inn.host = com;
                inn.setEvents("onValueChanged", function () {
                    com.$dirty = true
                });
                inn.create(function (o, threadid) {
                    inn.paneMain.setDockMargin({
                        left: 0,
                        top: 40,
                        right: 0,
                        bottom: 0
                    });
                    com.appRoot.append(inn)
                }, threadid);
                com.$classEditor = inn
            }, threadid, {
                $pageviewType: com.$pageviewType
            })
        },
        getValue: function () {
            return this.$classEditor.getValue()
        },
        setValue: function (str, url) {
            var self = this;
            if (str) {
                self.$classEditor.setValue(str)
            }
            if (url) {
                self.$url = url
            }
            var dis = self.$url ? !xui.absIO.isCrossDomain(self.$url) ? "" : "none" : "none";
            self.$dirty = false
        },
        _pop_onmenuselected: function (profile, item, src) {
            var ns = this;
            var lang = item.id;
            if (xui.getLang() == lang) {
                return
            }
            SPA.$btnLang.setCaption(xui.wrapRes("RAD." + lang));
            xui.setLang(lang);
            ns.ctl_menubar1.clearPopCache();
            xui.include("xui.Locale." + item.id + ".app", CONF.getAPIPath() + "Locale/" + item.id + ".js", function () {
                if (!xui.Locale[lang].doc) {
                    xui.Locale[lang].doc = xui.Locale.en.doc
                }
            });
            xui.include("lang." + lang, CONF.getAPIPath() + "Locale/" + lang + ".js")
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.PopMenu).setHost(host, "popLang").onMenuSelected("_pop_onmenuselected"));
            append((new xui.UI.PopMenu).setHost(host, "popSave").onMenuSelected("_popsave_onmenusel"));
            append((new xui.UI.PopMenu).setHost(host, "popTheme").onMenuSelected("_onmenusel"));
            append((new xui.UI.Pane).setHost(host, "appRoot").setDock("fill").setWidth(800).setHeight(600).setDockMinW(600).setDockMinH(300));
            host.appRoot.append((new xui.UI.Image).setHost(host, "image1").setTop(4).setRight(280).setZIndex(0).setSrc("img/logo.png").setCursor("pointer").onClick("_image1_onclick"));
            host.appRoot.append((new xui.UI.MenuBar).setHost(host, "ctl_menubar1").setItems([{
                id: "tools",
                caption: "$RAD.menu.tools",
                sub: [{
                    id: "editorTheme",
                    caption: "$RAD.menu.editorTheme"
                }, {
                    type: "split"
                }, {
                    id: "servicetester",
                    caption: "$RAD.menu.servicetester"
                }, {
                    id: "jsoneditor",
                    caption: "$RAD.menu.jsoneditor"
                }, {
                    type: "split"
                }, {
                    id: "command",
                    caption: "$RAD.menu.command"
                }, {
                    type: "split"
                }, {
                    id: "xui",
                    caption: "$RAD.spabuilder.menubar.xui"
                }, {
                    id: "cookbook",
                    caption: "$RAD.menu.cookbook"
                }, {
                    id: "api",
                    caption: "$RAD.menu.api"
                }, {
                    id: "codesnipt",
                    caption: "$RAD.menu.codesnipt"
                }, {
                    type: "split"
                }, {
                    id: "backendcode",
                    caption: "$RAD.menu.backendcode",
                    sub: [{
                        id: "php",
                        caption: "$RAD.menu.php"
                    }, {
                        id: "csharp",
                        caption: "$RAD.menu.csharp"
                    }, {
                        id: "java",
                        caption: "$RAD.menu.java"
                    }]
                }]
            }, {
                id: "links",
                caption: "$RAD.spabuilder.menubar.links",
                sub: [{
                    id: "adv",
                    caption: "$RAD.spabuilder.menubar.adv"
                }, {
                    type: "split"
                }, {
                    id: "video",
                    caption: "$RAD.spabuilder.menubar.video"
                }, {
                    id: "forum",
                    caption: "$RAD.spabuilder.menubar.forum"
                }, {
                    type: "split"
                }, {
                    id: "about",
                    caption: "$RAD.spabuilder.menubar.about"
                }]
            }]).setHandler(false).setDockFloat(true).setDockMargin({
                top: 6,
                left: 2,
                right: 0,
                bottom: 0
            }).setCustomStyle({
                BORDER: "border:none;background:none;"
            }).onMenuSelected("_menubar_selected").setZIndex(5));
            return children
        },
        _image1_onclick: function () {
            CONF.openURL(CONF.path_link)
        },
        _menubar_selected: function (profile, popProfile, item, src) {
            var self = this;
            switch (item.id) {
            case "xui":
                CONF.openURL("http://www.crossui.com");
                break;
            case "gcodelist":
                CONF.openURL("http://code.google.com/p/crossui/downloads/list");
                break;
            case "cookbook":
                CONF.openBook();
                break;
            case "api":
                CONF.openAPI();
                break;
            case "codesnipt":
                CONF.openURL("http://www.crossui.com/Forum/crossui-code-snaps-f10.html");
                break;
            case "forum":
                CONF.openURL(CONF.path_forum);
                break;
            case "video":
                CONF.openURL(CONF.path_video);
                break;
            case "editorTheme":
                xui.ComFactory.newCom("RAD.EditorTheme", function () {
                    this.show();
                    this.setEvents("onOK", function (theme, fs) {
                        CONF.editorTheme = theme;
                        CONF.editorFontSize = fs;
                        self.$classEditor.resetEditorStyle(theme, fs)
                    })
                });
                break;
            case "about":
                xui.ComFactory.getCom("RAD.About", function () {
                    this.dialog.showModal()
                });
                break;
            case "adv":
                CONF.openAdvanceVer();
                break;
            case "php":
                CONF.openURL("http://www.crossui.com/Forum/php-f12.html");
                break;
            case "csharp":
                CONF.openURL("http://www.crossui.com/Forum/c-f14.html");
                break;
            case "java":
                CONF.openURL("http://www.crossui.com/Forum/java-f13.html");
                break;
            case "servicetester":
                xui.ComFactory.getCom("RAD.ServiceTester", function () {
                    this.init();
                    this.show()
                });
                break;
            case "jsoneditor":
                CONF.openJSONEditor();
                break;
            case "command":
                xui.log("Ready");
                break
            }
        },
        _onmenusel: function (profile, item) {
            var id = item.id;
            if ((SPA.$curTheme || "vista") == id) {
                return
            }
            xui.setTheme(SPA.$curTheme = id);
            SPA.$btnTheme.setCaption(xui.wrapRes(item.caption))
        },
        _popsave_onmenusel: function (profile, item) {
            var self = this,
                id = item.id;
            ifrid = "ifr_for_download", content = self.getValue(), clsName = RAD.ClassTool.getClassName(content);
            if (false === content) {
                return
            }
            if (!clsName) {
                xui.message(xui.getRes("RAD.classtool.noClass"));
                return false
            }
            if (id == "saveasjs") {
                var hash = {
                    key: CONF.requestKey,
                    paras: {
                        action: "saveasjs",
                        content: content
                    }
                };
                CONF.saveAS(hash)
            } else {
                if (id == "saveashtml") {
                    var hash = {
                        key: CONF.requestKey,
                        paras: {
                            action: "saveashtml",
                            content: content,
                            clsName: clsName,
                            theme: xui.getTheme(),
                            lang: xui.getLang()
                        }
                    };
                    CONF.saveAS(hash)
                } else {
                    if (id == "saveasweb") {
                        var hash = {
                            key: CONF.requestKey,
                            paras: {
                                action: "saveasweb",
                                content: content,
                                clsName: clsName,
                                theme: xui.getTheme(),
                                lang: xui.getLang()
                            }
                        };
                        CONF.saveAS(hash)
                    } else {
                        if (id == "saveaswin") {
                            var hash = {
                                key: CONF.requestKey,
                                paras: {
                                    action: "saveaswin",
                                    content: content,
                                    clsName: clsName,
                                    theme: xui.getTheme(),
                                    lang: xui.getLang()
                                }
                            };
                            CONF.saveAS(hash)
                        } else {
                            if (id == "saveaslinux") {
                                var hash = {
                                    key: CONF.requestKey,
                                    paras: {
                                        action: "saveaslinux",
                                        content: content,
                                        clsName: clsName,
                                        theme: xui.getTheme(),
                                        lang: xui.getLang()
                                    }
                                };
                                CONF.saveAS(hash)
                            } else {
                                if (id == "saveasosx") {
                                    var hash = {
                                        key: CONF.requestKey,
                                        paras: {
                                            action: "saveasosx",
                                            content: content,
                                            clsName: clsName,
                                            theme: xui.getTheme(),
                                            lang: xui.getLang()
                                        }
                                    };
                                    CONF.saveAS(hash)
                                } else {
                                    if (id == "saveasmobile") {
                                        var hash = {
                                            key: CONF.requestKey,
                                            paras: {
                                                action: "saveasmobile",
                                                content: content,
                                                clsName: clsName,
                                                theme: xui.getTheme(),
                                                lang: xui.getLang()
                                            }
                                        };
                                        CONF.saveAS(hash)
                                    } else {
                                        if (id == "savetoserver") {
                                            var path = self.$url;
                                            if (!path) {
                                                return
                                            }
                                            if (self.$dirty) {
                                                if (false === confirm(xui.getRes("RAD.builder.issave2server"))) {
                                                    return
                                                }
                                            } else {
                                                return
                                            }
                                            if (/^(http|https)\:\/\//.test(self.$url)) {
                                                var s1 = self.$url.replace(/^.+\:\/\/[^/]+\//, ""),
                                                    s2 = xui.ini.appPath.replace(/^.+\:\/\/[^/]+\//, "").replace(/\/$/, ""),
                                                    a1 = s1.split("/"),
                                                    a2 = s2.split("/"),
                                                    count = 0,
                                                    as = "";
                                                _.arr.each(a2, function (o, i) {
                                                    if (a1[i] != o) {
                                                        return false
                                                    } else {
                                                        count++
                                                    }
                                                });
                                                as += _.str.repeat("../", (a2.length - count));
                                                path = as + a1.slice(count, a1.length).join("/")
                                            }
                                            xui.IAjax(CONF.phpPath, {
                                                key: CONF.requestKey,
                                                para: {
                                                    action: "savetoserver",
                                                    hashCode: _(),
                                                    path: path,
                                                    content: content
                                                }
                                            }, function (txt) {
                                                var obj = txt;
                                                if (obj && !obj.error && obj.data && obj.data.OK) {
                                                    xui.message(xui.getRes("RAD.builder.save2serverOK"));
                                                    self.imgEdit.setDisplay("none");
                                                    self.$dirty = false
                                                } else {
                                                    xui.message(obj.error.message)
                                                }
                                            }, function (txt) {
                                                xui.message(txt)
                                            })
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        getDesigner: function () {
            return this.$classEditor._designer
        },
        getViewSize: function () {
            return _.copy(this.getDesigner().$curViewSize)
        },
        setViewSize: function (size) {
            this.getDesigner().setViewSize(size)
        },
        getSelected: function () {
            var sel = this.getDesigner().tempSelected,
                out;
            if (sel && sel.length) {
                out = [];
                _.arr.each(sel, function (o) {
                    out.push(xui.getObject(o))
                })
            }
            return out
        },
        selectByAlias: function (alias) {
            var des = this.getDesigner(),
                hash = des.getNames();
            if (hash[alias]) {
                des.selectWidget(hash[alias].$xid)
            }
        },
        clearSelected: function () {
            var des = this.getDesigner();
            des._clearSelect();
            des._setSelected(null, true)
        },
        delSelected: function () {
            this.getDesigner()._deleteSelected(true)
        },
        getWidgetByAlias: function (alias) {
            var des = this.getDesigner(),
                hash = des.getNames();
            return hash[alias]
        },
        addWidget: function (widget, parentAlias, subId) {
            if (widget.$key == "xui.UIProfile") {
                widget = widget.boxing()
            }
            if (widget["xui.UI"]) {
                var des = this.getDesigner(),
                    p = this.getWidgetByAlias(parentAlias);
                if (p && p.behavior.PanelKeys && p.behavior.PanelKeys.length) {
                    p = p.boxing()
                } else {
                    p = des.canvas
                }
                p.append(widget, subId);
                des._designable(widget.get(0));
                des._dirty = true
            }
        },
        removeWidgetByAlias: function (alias) {
            var des = this.getDesigner(),
                n = this.getWidgetByAlias(alias);
            if (n) {
                n.boxing().destroy();
                des._dirty = true
            }
            this.clearSelected()
        },
        getRootWidgets: function () {
            return this.getDesigner().getWidgets()
        },
        getAllWidgets: function () {
            return this.getDesigner().getNames()
        },
        getJSCode: function () {
            var des = this.getDesigner(),
                code = des.getJSCode(des.getWidgets());
            code = code.replace(/^return xui\.create\(/, "");
            code = code.replace(/\)\.get\(\);$/, "");
            return code
        },
        getJSONCode: function () {
            var des = this.getDesigner(),
                code = des.getJSONCode(des.getWidgets());
            code = code.replace(/^return xui\.create\(/, "");
            code = code.replace(/\)\.get\(\);$/, "");
            return code
        },
        clearCode: function () {
            var des = this.getDesigner();
            des._clearSelect();
            des.canvas.removeChildren(null, true);
            des._dirty = true;
            des.resetCodeFromDesigner(true)
        },
        setJSCode: function (code) {
            var des = this.getDesigner();
            this.clearCode();
            des.refreshView(code, true);
            des._dirty = true;
            des.resetCodeFromDesigner(false)
        },
        setJSONCode: function (json) {
            this.setJSCode("return xui.UI.unserialize(" + json + ").get();")
        },
        isDirtied: function () {
            return this.getDesigner().isDirty()
        }
    }
});
Class("RAD.OpenFile", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dlg").setWidth(690).setHeight(100).setResizer(false).setCaption("Open CrossUI Class File").setMinBtn(false).setMaxBtn(false).setPinBtn(false).beforeClose("_beforeClose"));
            host.dlg.append((new xui.UI.Pane).setHost(host, "pane6").setWidth("auto").setHeight("40").setPosition("relative"));
            host.pane6.append((new xui.UI.ComboInput).setHost(host, "combo").setLeft(50).setTop(10).setWidth(517).setDirtyMark(false).setValueFormat("^(http|https)\\:\\/\\/[\\w\\-\\_\\.]+[\\w\\-\\_](:[\\w]*)?\\/?([\\w\\-\\._\\?\\,\\'\\/\\\\\\+&amp;%\\$#\\=~])*$").setType("none"));
            host.pane6.append((new xui.UI.Div).setHost(host, "div19").setLeft(20).setTop(10).setWidth("40").setHeight(20).setHtml("URL:"));
            host.pane6.append((new xui.UI.Button).setHost(host, "button5").setLeft(570).setTop(9).setWidth(90).setCaption("Open it").onClick("_open"));
            host.dlg.append((new xui.UI.Pane).setHost(host, "pane7").setWidth("auto").setHeight("auto").setPosition("relative"));
            host.pane7.append((new xui.UI.Group).setHost(host, "group1").setLeft("20").setWidth(640).setHeight("auto").setPosition("relative").setCaption("Open from samples").setToggle(false).onIniPanelView("_grp_iniview").beforeFold("_grp_onfold").beforeExpand("_grp_onexpand"));
            host.group1.append((new xui.UI.TreeBar).setHost(host, "treebar").setDock("none").setLeft(10).setWidth(620).setHeight(140).setPosition("relative").setSelMode("none").onItemSelected("_tb_onsel"));
            return children
        },
        _open: function (profile, item, group, e, src) {
            if (!this.combo.checkValid()) {
                return false
            }
            var url = this.combo.getUIValue();
            if (!/\.js/.test(url)) {
                xui.message("Not a js file.");
                return
            }
            _.tryF(this.onOpenFile, [url], this)
        },
        _beforeClose: function (profile) {
            profile.boxing().hide();
            return false
        },
        _grp_onexpand: function (profile) {
            this.dlg.setHeight(240)
        },
        _grp_onfold: function (profile) {
            this.dlg.setHeight(100)
        },
        _grp_iniview: function (profile) {
            var ins = profile.boxing(),
                self = this;
            ins.busy();
            xui.Thread.observableRun(function (threadid) {
                xui.Ajax("js/ClsSamples.js", "", function (txt) {
                    var items = txt;
                    if (false === items) {
                        xui.message("Data source format error!")
                    } else {
                        self.treebar.setItems(items)
                    }
                    ins.free()
                }, function (msg) {
                    xui.message(msg);
                    ins.free()
                }, threadid).start()
            })
        },
        _tb_onsel: function (profile, item) {
            _.tryF(this.onOpenFile, [item.value], this)
        }
    }
});
Class("RAD.FAndR", "xui.Com", {
    Instance: {
        _start: 0,
        _editor: null,
        initialize: function () {
            this.autoDestroy = true;
            this.properties = {}
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog()).setHost(host, "ctl_dialog").setLeft(140).setTop(40).setWidth(250).setHeight(160).setResizer(false).setCaption("$RAD.pageEditor.searchreplace").setMinBtn(false).setMaxBtn(false).onHotKeydown("_ctl_dialog_onhotkeydown").beforeClose("_ctl_dialog_beforeclose"));
            host.ctl_dialog.append((new xui.UI.SLabel()).setHost(host, "ctl_slabel1").setLeft(20).setTop(14).setWidth(84).setCaption("$RAD.pageEditor.search"));
            host.ctl_dialog.append((new xui.UI.SLabel()).setHost(host, "ctl_slabel2").setLeft(20).setTop(43).setWidth(84).setCaption("$RAD.pageEditor.replacewith"));
            host.ctl_dialog.append((new xui.UI.Input()).setHost(host, "ctl_i1").setDirtyMark(false).setLeft(110).setTop(10).setWidth(110).onHotKeydown("_ctl_i1_onhotkeydown"));
            host.ctl_dialog.append((new xui.UI.Input()).setHost(host, "ctl_i2").setDirtyMark(false).setLeft(110).setTop(39).setWidth(110));
            host.ctl_dialog.append((new xui.UI.SButton()).setHost(host, "ctl_sbtnSearch").setLeft(20).setTop(70).setWidth(90).setCaption("$RAD.pageEditor.search").onClick("_ctl_sbtnsearch_onclick"));
            host.ctl_dialog.append((new xui.UI.SButton()).setHost(host, "ctl_sbtnReplace").setLeft(20).setTop(100).setWidth(90).setCaption("$RAD.pageEditor.replace").onClick("_ctl_sbtnreplace_onclick"));
            host.ctl_dialog.append((new xui.UI.SButton()).setHost(host, "ctl_sbtnSR").setLeft(130).setTop(70).setWidth(90).setCaption("$RAD.pageEditor.replacesearch").onClick("_ctl_sbtnsr_onclick"));
            host.ctl_dialog.append((new xui.UI.SButton()).setHost(host, "ctl_sbtnRA").setLeft(130).setTop(100).setWidth(90).setCaption("$RAD.pageEditor.replaceall").onClick("_ctl_sbtnra_onclick"));
            return children
        },
        customAppend: function (parent, subId, left, top) {
            var ns = this;
            ns.ctl_i1.setUIValue("");
            ns.ctl_i2.setUIValue("");
            ns.ctl_dialog.showModal(parent, left, top)
        },
        _ctl_dialog_beforeclose: function (profile) {
            this.ctl_dialog.hide();
            this._start = 0;
            this._SearchCursor = null;
            return false
        },
        getCM: function () {
            var ns = this;
            if (ns._editor) {
                return ns._editor.getCM()
            }
        },
        _ctl_sbtnsearch_onclick: function (profile, e, src, value) {
            var ns = this,
                query = ns.ctl_i1.getUIValue(),
                cm;
            if (query && (cm = ns.getCM())) {
                var cs = ns._SearchCursor = cm.getSearchCursor(query, ns._start, true);
                if (cs.findNext()) {
                    cm.doc.setSelection(cs.from(), ns._start = cs.to())
                } else {
                    cs = ns._SearchCursor = cm.getSearchCursor(query, 0, true);
                    if (cs.findNext()) {
                        cm.doc.setSelection(cs.from(), ns._start = cs.to())
                    } else {
                        xui.message(xui.getRes("RAD.pageEditor.findnone"))
                    }
                }
            }
        },
        _ctl_sbtnreplace_onclick: function (profile, e, src, value) {
            var ns = this,
                query = ns.ctl_i1.getUIValue(),
                rep = ns.ctl_i2.getUIValue(),
                cm;
            if (query && (cm = ns.getCM())) {
                if (ns._SearchCursor && cm.getSelection() == query) {
                    ns._SearchCursor.replace(rep)
                }
            }
        },
        _ctl_sbtnsr_onclick: function (profile, e, src, value) {
            var ns = this,
                query = ns.ctl_i1.getUIValue(),
                rep = ns.ctl_i2.getUIValue(),
                cm;
            if (query && (cm = ns.getCM())) {
                if (ns._SearchCursor && cm.getSelection() == query) {
                    ns._SearchCursor.replace(rep)
                }
                ns._ctl_sbtnsearch_onclick()
            }
        },
        _ctl_sbtnra_onclick: function (profile, e, src, value) {
            var ns = this,
                query = ns.ctl_i1.getUIValue(),
                rep = ns.ctl_i2.getUIValue(),
                cm;
            if (query && (cm = ns.getCM())) {
                var count = 0;
                ns._start = 0;
                var cs = ns._SearchCursor = cm.getSearchCursor(query, ns._start, true);
                while (cs.findNext()) {
                    cs.replace(rep);
                    count++
                }
                ns._start = 0;
                linb.message(linb.getRes("RAD.pageEditor.replaceCount", count))
            }
        },
        _ctl_dialog_onhotkeydown: function (profile, keyboard) {
            if (keyboard.key == "esc") {
                this.ctl_dialog.close()
            }
        },
        _ctl_i1_onhotkeydown: function (profile, keyboard, e, src) {
            if (keyboard.key == "enter") {
                this.ctl_sbtnSearch.onClick()
            }
        }
    }
});
Class("RAD.JumpTo", "xui.Com", {
    Instance: {
        initialize: function () {
            this.autoDestroy = true;
            this.properties = {}
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "ctl_dialog").setLeft(70).setTop(40).setWidth(200).setHeight(100).setResizer(false).setCaption("$RAD.jumpto").setMinBtn(false).setMaxBtn(false).onHotKeydown("_ctl_dialog_onhotkeydown").beforeClose("_ctl_dialog_beforeclose"));
            host.ctl_dialog.append((new xui.UI.SLabel).setHost(host, "ctl_slabel1").setLeft(10).setTop(14).setWidth(74).setCaption("$RAD.jumpto"));
            host.ctl_dialog.append((new xui.UI.ComboInput).setHost(host, "ctl_comboinput3").setDirtyMark(false).setLeft(110).setTop(10).setWidth(60).setType("spin").setPrecision(0).setIncrement(1).setMin(1).setMax(100000).setValue(1));
            host.ctl_dialog.append((new xui.UI.SButton).setHost(host, "ctl_sbutton5").setLeft(30).setTop(40).setWidth(60).setCaption("$RAD.cancel").onClick("_ctl_sbutton5_onclick"));
            host.ctl_dialog.append((new xui.UI.SButton).setHost(host, "ctl_btnok").setLeft(110).setTop(40).setWidth(60).setCaption("$RAD.ok").onClick("_ctl_btnok_onclick"));
            return children
        },
        customAppend: function (parent, subId, left, top) {
            this.ctl_comboinput3.setUIValue(1, true);
            this.ctl_dialog.showModal(parent, left, top)
        },
        events: {},
        _ctl_sbutton5_onclick: function (profile, e, src, value) {
            this.ctl_dialog.close()
        },
        _ctl_dialog_beforeclose: function (profile) {
            this.ctl_dialog.hide();
            return false
        },
        _ctl_btnok_onclick: function (profile, e, src, value) {
            this.fireEvent("onOK", [this.ctl_comboinput3.getUIValue()]);
            this.ctl_dialog.close()
        },
        _ctl_dialog_onhotkeydown: function (profile, keyboard) {
            if (keyboard.key == "esc") {
                this.ctl_dialog.close()
            }
        }
    }
});
Class("RAD.ServiceTester", "xui.Com", {
    Instance: {
        initialize: function () {
            this.autoDestroy = true;
            this.properties = {}
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dlg").setLeft(60).setTop(60).setWidth(600).setHeight(407).setCaption("$RAD.spabuilder.st_title").setMinBtn(false).setMaxBtn(false).setOverflow("visible").beforeClose("_dlg_beforeclose"));
            host.dlg.append((new xui.UI.SLabel).setHost(host, "ctl_slabel1").setLeft(10).setTop(10).setWidth(74).setCaption("$RAD.spabuilder.st_uri"));
            host.dlg.append((new xui.UI.Group).setHost(host, "ctl_group1").setLeft(10).setTop(40).setWidth(570).setHeight(120).setCaption("$RAD.spabuilder.st_queryobj").setCustomStyle({
                PANEL: "overflow:visible"
            }).setToggleBtn(false));
            host.ctl_group1.append((new xui.UI.TextEditor).setHost(host, "ctl_query").setDirtyMark(false).setLeft(5).setWidth(560).setHeight(100).setValue("{a:1,b:2}"));
            host.dlg.append((new xui.UI.SButton).setHost(host, "ctl_sbutton5").setLeft(460).setTop(342).setWidth(110).setCaption("$RAD.close").onClick("_ctl_sbutton5_onclick"));
            host.dlg.append((new xui.UI.SButton).setHost(host, "ctl_sbutton6").setLeft(280).setTop(342).setWidth(170).setCaption("$RAD.spabuilder.st_createcode").onClick("_ctl_sbutton6_onclick"));
            host.dlg.append((new xui.UI.Button).setHost(host, "ctl_sbutton15").setLeft(340).setTop(174).setWidth(230).setHeight(36).setCaption("<strong>$RAD.spabuilder.st_send</strong>").onClick("_ctl_sbutton15_onclick"));
            host.dlg.append((new xui.UI.Group).setHost(host, "ctl_group3").setLeft(10).setTop(212).setWidth(570).setHeight(120).setCaption("$RAD.spabuilder.st_result").setCustomStyle({
                PANEL: "overflow:visible"
            }).setToggleBtn(false));
            host.ctl_group3.append((new xui.UI.Input).setHost(host, "ctl_result").setDirtyMark(false).setLeft(4).setTop(0).setWidth(560).setHeight(100).setMultiLines(true));
            host.dlg.append((new xui.UI.SButton).setHost(host, "ctl_sbutton26").setLeft(500).setTop(35).setWidth(70).setCaption("$RAD.spabuilder.st_format").onClick("_ctl_sbutton26_onclick"));
            host.dlg.append((new xui.UI.RadioBox).setHost(host, "ctl_method").setDirtyMark(false).setItems([{
                id: "auto",
                caption: "Auto"
            }, {
                id: "get",
                caption: "Get"
            }, {
                id: "post",
                caption: "Post"
            }]).setLeft(90).setTop(175).setWidth(220).setHeight(26).setValue("auto"));
            host.dlg.append((new xui.UI.SLabel).setHost(host, "ctl_slabel13").setLeft(0).setTop(180).setWidth(84).setCaption("$RAD.spabuilder.st_method"));
            host.dlg.append((new xui.UI.ComboInput).setHost(host, "ctl_uri").setDirtyMark(false).setLeft(90).setTop(6).setWidth(484).setValueFormat("^(http|https)\\:").setType("popbox").setValue("http://www.crossui.com/xui/backend/PHP/demo.php").onClick("_ctl_uri_onclick"));
            return children
        },
        customAppend: function (parent, subId, left, top) {
            var ns = this;
            ns.dlg.setDisplay("block");
            ns.dlg.showModal();
            return false
        },
        events: {},
        init: function (force) {
            var ns = this;
            if (force) {
                ns.ctl_uri.setValue("http://www.crossui.com/xui/backend/PHP/demo.php", true);
                ns.ctl_query.setValue("{a:1,b:2}", true)
            }
            ns.ctl_method.setValue("auto", true);
            ns.ctl_result.setValue("", true)
        },
        _ctl_sbutton5_onclick: function (profile, e, src, value) {
            var ns = this,
                uictrl = profile.boxing();
            ns.dlg.close()
        },
        _ctl_sbutton15_onclick: function (profile, e, src, value) {
            var ns = this,
                ctrl = profile.boxing(),
                options = {},
                uri = ns.ctl_uri.getUIValue(),
                str_query = ns.ctl_query.getUIValue();
            if (uri && str_query) {
                var query = _.unserialize(str_query);
                if (query) {
                    var method = ns.ctl_method.getUIValue();
                    if (method != "auto") {
                        options.method = method
                    }
                    ctrl.getRoot().onMouseout(true);
                    ctrl.setDisabled(true).setCaption("<strong>$RAD.spabuilder.st_sending</strong>");
                    xui.request(uri, query, function (rsp) {
                        var rspobj = rsp;
                        if (rspobj) {
                            ns.showResult(rspobj)
                        } else {
                            ns.showErr(rsp)
                        }
                        ctrl.setDisabled(false).setCaption("<strong>$RAD.spabuilder.st_send</strong>")
                    }, function (rsp) {
                        ns.showErr(rsp);
                        ctrl.setDisabled(false).setCaption("<strong>$RAD.spabuilder.st_send</strong>")
                    }, null, options);
                    return
                }
            }
            xui.message(xui.getRes("RAD.spabuilder.st_nodata"))
        },
        showErr: function (msg) {
            xui.alert(msg)
        },
        showResult: function (obj) {
            var ns = this;
            ns.ctl_result.setValue(xui.Coder.formatText(_.stringify(obj)), true)
        },
        _ctl_sbutton26_onclick: function (profile, e, src, value) {
            var ns = this;
            this.ctl_query.setValue(xui.Coder.formatText(ns.ctl_query.getUIValue()), true)
        },
        _ctl_sbutton6_onclick: function (profile, e, src, value) {
            var ns = this,
                uictrl = profile.boxing(),
                uri = ns.ctl_uri.getUIValue(),
                str_query = ns.ctl_query.getUIValue(),
                method = ns.ctl_method.getUIValue();
            var code = 'xui.request("$1", \n$2, \nfunction(rsp){\n    var rspobj = rsp;\n    if(rspobj){\n        // handle result\n    }else{\n        // handle exception\n    }\n    }, function(rsp){\n        // handle exception\n    }, null, $3);';
            code = code.replace("$1", uri).replace("$2", str_query).replace("$3", method == "auto" ? "null" : ("{method:'" + method + "'}"));
            ns.ctl_result.setValue(code, true)
        },
        _dlg_beforeclose: function (profile) {
            this.dlg.hide();
            this.dlg.setDisplay("none");
            return false
        },
        _ctl_uri_onclick: function (profile, node) {
            var ns = this,
                uictrl = profile.boxing();
            xui.Dom.submit(uictrl.getUIValue())
        }
    }
});
Class("RAD.CustomDecoration", "xui.Com", {
    Instance: {
        initialize: function () {
            this.autoDestroy = true;
            this.properties = {}
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(210).setTop(20).setWidth(260).setHeight(410).setResizer(false).setOverflow("visible").setCaption("Custom Decoration").setMinBtn(false).setMaxBtn(false).beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Group).setHost(host, "grpNodes").setLeft(0).setTop(4).setWidth(250).setHeight(126).setCaption("grpNodes").setToggleBtn(false));
            host.grpNodes.append((new xui.UI.TreeView).setHost(host, "tv").setDirtyMark(false).onItemSelected("_tv_onitemselected").setCustomStyle({
                BOX: "background-color:transparent;"
            }));
            host.dialog.append((new xui.UI.Block).setHost(host, "ctl_block3").setLeft(0).setTop(153).setWidth(250).setHeight(227).setBorderType("inset").setBackground("#fff"));
            host.ctl_block3.append((new xui.UI.TreeGrid).setHost(host, "tg").setDirtyMark(false).setRowHandler(false).setColSortable(false).setHeader([{
                id: "key",
                width: 90,
                type: "label",
                caption: "Prop"
            }, {
                id: "value",
                editable: true,
                width: 134,
                type: "input",
                caption: "Custom Value"
            }]).afterCellUpdated("_tg_aftercellupdated").beforeComboPop("_tg_beforeComboPop").setCustomStyle({
                SCROLL: "overflow-x:hidden;overflow-y:auto;"
            }));
            host.dialog.append((new xui.UI.Input).setHost(host, "ctl_input1").setReadonly(true).setLeft(0).setTop(133).setWidth(250).setLabelCaption("ctl_input1"));
            return children
        },
        customAppend: function (parent, subId, left, top) {
            var ns = this,
                prop = ns.properties;
            ns.setTargetProfile(prop.targetProfile);
            xui("body").append(ns.dialog);
            ns.dialog.getRoot().popToTop(prop.targetProfile.getRootNode(), 2).setBlurTrigger("RAD.CustomDecoration", function () {
                ns.dialog.close()
            });
            ns.dialog.activate();
            return true
        },
        setTargetProfile: function (profile) {
            var ns = this,
                items = [],
                rootItem;
            var fun = function (hash, subMap, arr, tag) {
                    var item;
                    for (var i in hash) {
                        if (i.charAt(0) != "$") {
                            var tagName = (hash[i] && hash[i].tagName || "span").toLowerCase();
                            if (!/[a-z]/.test(i)) {
                                item = {
                                    id: i,
                                    caption: i + " [" + tagName.toUpperCase() + "]",
                                    image: xui.getPath("img/", "App.gif"),
                                    imagePos: "-112px 0"
                                };
                                if (subMap && hash[i].text && subMap[(tag ? (tag + ".") : "") + hash[i].text.replace(/^{(.*)}$/, "$1")]) {
                                    item.sub = [];
                                    var tag = (tag ? (tag + ".") : "") + hash[i].text.replace(/^{(.*)}$/, "$1");
                                    if (tag == "rows.cells") {
                                        tag = "rows.cells.input"
                                    }
                                    arguments.callee(subMap[tag], subMap, item.sub, tag);
                                    if (tagName == "text" && item.sub.length) {
                                        item = item.sub[0]
                                    }
                                } else {
                                    if (tagName == "text") {
                                        continue
                                    } else {
                                        if (typeof hash[i] == "object" && tagName != "text") {
                                            item.sub = [];
                                            arguments.callee(hash[i], subMap, item.sub, tag)
                                        }
                                    }
                                }
                                if (!item.sub || !item.sub.length) {
                                    delete item.sub
                                }
                                arr[arr.length] = item
                            }
                        }
                    }
                };
            var i = "_",
                hash = profile.box.$Templates,
                tagName = (hash[i].tagName || "span").toLowerCase();
            items.push(rootItem = {
                id: "KEY",
                caption: "ROOT [" + tagName.toUpperCase() + "]",
                image: xui.getPath("img/", "App.gif"),
                imagePos: "-112px 0",
                sub: []
            });
            var subMap = hash[i].$submap;
            if (subMap && hash[i].text && subMap[hash[i].text.replace(/^{(.*)}$/, "$1")]) {
                var tag = hash[i].text.replace(/^{(.*)}$/, "$1");
                fun(subMap[tag], subMap, rootItem.sub, tag);
                if (tagName == "text" && rootItem.sub.length) {
                    rootItem = rootItem.sub[0]
                }
            }
            fun(hash[i], subMap, rootItem.sub, null);
            if (!rootItem.sub.length) {
                delete rootItem.sub
            }
            ns.grpNodes.setCaption(profile.key.slice(profile.key.lastIndexOf(".") + 1) + " : " + profile.alias);
            ns.tv.setTagVar(profile);
            ns.tv.setItems(items);
            ns.tg.updateCellByRowCol("classname", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("font-family", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("font-size", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("font-weight", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("font-style", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("color", "value", {
                value: tagName == "image" ? "#EBEADB" : "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("background-color", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("border", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("border-radius", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("text-decoration", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("text-align", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("text-shadow", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("cursor", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("overflow", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("opacity", "value", {
                value: 1
            }, false, false);
            ns.tg.updateCellByRowCol("transform", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("box-shadow", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("$gradients", "value", {
                value: ""
            }, false, false);
            ns.tg.setDisabled(true);
            ns.ctl_input1.setValue("");
            ns.tv.toggleNode("KEY", true, true);
            ns.tv.fireItemClickEvent("KEY")
        },
        _tv_onitemselected: function (profile, item, e) {
            var ns = this,
                prf = profile.boxing().getTagVar(),
                box = prf.box,
                PanelKeys = box.$Behaviors && box.$Behaviors.PanelKeys;
            ns.tg.setDisabled(false);
            if (!ns.$coverMark) {
                ns.$coverMark = xui.create('<div style="z-index:2000;border:solid 1px;background-color:#ff0000;position:absolute;font-size:0;line-height:0;display:none;">').css("opacity", 0.3);
                xui("body").append(ns.$coverMark);
                ns.$coverMarkTask = xui.Thread.repeat(function () {
                    ns.$coverMarkTask.$_mark = !ns.$coverMarkTask.$_mark;
                    ns.$coverMark.css("backgroundColor", ns.$coverMarkTask.$_mark ? "#0000ff" : "#ff0000");
                    ns.$coverMark.css("border-color", ns.$coverMarkTask.$_mark ? "#fff" : "#000")
                }, 500)
            }
            if (item.id == "KEY") {
                ns.$coverMark.css("display", "none");
                var node = prf.getRootNode();
                var nodeText = "<" + node.tagName + " id='" + node.id + "' class='" + node.className + "' style='" + xui(node).attr("style") + "'>";
                ns.ctl_input1.setValue(nodeText).setTips(nodeText.replace(/</, "&lt;"))
            } else {
                var nodes = prf.getSubNode(item.id, true);
                if (nodes.get(0)) {
                    var set = false;
                    nodes.each(function (node) {
                        if (node.offsetWidth) {
                            var region = xui(node).offset();
                            region.width = node.offsetWidth;
                            region.height = node.offsetHeight;
                            if (region.width <= 0) {
                                region.width = 2
                            } else {
                                region.width -= 2
                            }
                            if (region.height <= 0) {
                                region.height = 2
                            } else {
                                region.height -= 2
                            }
                            if (region.width <= 0) {
                                region.width = 2
                            }
                            if (region.height <= 0) {
                                region.height = 2
                            }
                            ns.$coverMark.cssRegion(region).css("display", "block");
                            var nodeText = "<" + node.tagName + " id='" + node.id + "' class='" + node.className + "' style='" + xui(node).attr("style") + "'>";
                            ns.ctl_input1.setValue(nodeText).setTips(nodeText.replace(/</, "&lt;"));
                            set = true;
                            return false
                        }
                    });
                    if (!set) {
                        ns.$coverMark.css("display", "none")
                    }
                } else {
                    ns.$coverMark.css("display", "none")
                }
            }
            ns.tg.updateCellByRowCol("classname", "value", {
                value: prf.CC[item.id] || null
            }, false, false);
            var cs = prf.CS[item.id],
                csaMap = {};
            if (cs) {
                if (_.isStr(cs)) {
                    var csa = cs.split(/\s*;+\s*/);
                    _.arr.each(csa, function (style) {
                        if (style) {
                            var kv = style.split(/\s*:\s*/);
                            if (kv.length == 2) {
                                csaMap[kv[0]] = kv[1]
                            }
                        }
                    })
                } else {
                    csaMap = cs
                }
            }
            ns.tg.updateCellByRowCol("font-family", "value", {
                value: csaMap["font-family"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("font-size", "value", {
                value: csaMap["font-size"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("font-weight", "value", {
                value: csaMap["font-weight"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("font-style", "value", {
                value: csaMap["font-style"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("color", "value", {
                value: csaMap.color || ""
            }, false, false);
            ns.tg.updateCellByRowCol("background-color", "value", {
                value: csaMap["background-color"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("border", "value", {
                value: csaMap.border || ""
            }, false, false);
            ns.tg.updateCellByRowCol("border-radius", "value", {
                value: csaMap["border-radius"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("text-align", "value", {
                value: csaMap["text-align"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("text-decoration", "value", {
                value: csaMap["text-decoration"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("text-shadow", "value", {
                value: csaMap["text-shadow"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("box-shadow", "value", {
                value: csaMap["box-shadow"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("$gradients", "value", {
                value: csaMap["$gradients"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("cursor", "value", {
                value: csaMap.cursor || ""
            }, false, false);
            ns.tg.updateCellByRowCol("overflow", "value", {
                value: csaMap.overflow || ""
            }, false, false);
            ns.tg.updateCellByRowCol("opacity", "value", {
                value: (parseFloat(csaMap.opacity) || parseFloat(csaMap.opacity) === 0) ? csaMap.opacity : 1
            }, false, false);
            ns.tg.updateCellByRowCol("transform", "value", {
                value: csaMap.transform || ""
            }, false, false);
            profile.boxing().setTag(item.id)
        },
        events: {
            onReady: "_com_onready",
            onDestroy: "_com_ondestroy"
        },
        _com_onready: function (com, threadid) {
            var ns = this,
                rows = [];
            rows.push({
                id: "classname",
                cellStyle: "font-weight:bold;",
                cells: ["class", ""]
            });
            rows.push({
                id: "font-family",
                cells: ["font-family",
                {
                    type: "helpinput",
                    editorListItems: CONF.designer_data_fontfamily
                }]
            });
            rows.push({
                id: "font-size",
                cells: ["font-size",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_fontsize
                }]
            });
            rows.push({
                id: "font-weight",
                cells: ["font-weight",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_fontweight
                }]
            });
            rows.push({
                id: "font-style",
                cells: ["font-style",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_fontstyle
                }]
            });
            rows.push({
                id: "color",
                cells: ["color",
                {
                    type: "color"
                }]
            });
            rows.push({
                id: "background-color",
                cells: ["background-color",
                {
                    type: "color"
                }]
            });
            rows.push({
                id: "border",
                cells: ["border",
                {
                    type: "popbox"
                }]
            });
            if (xui.Dom.css3Support("border-radius")) {
                rows.push({
                    id: "border-radius",
                    cells: ["border-radius",
                    {
                        type: "popbox"
                    }]
                })
            }
            rows.push({
                id: "text-align",
                cells: ["text-align",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_textalign
                }]
            });
            rows.push({
                id: "text-decoration",
                cells: ["text-decoration",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_textdecoration
                }]
            });
            if (xui.Dom.css3Support("text-shadow")) {
                rows.push({
                    id: "text-shadow",
                    cells: ["text-shadow",
                    {
                        type: "popbox"
                    }]
                })
            }
            if (xui.Dom.css3Support("box-shadow")) {
                rows.push({
                    id: "box-shadow",
                    cells: ["box-shadow",
                    {
                        type: "popbox"
                    }]
                })
            }
            if (xui.Dom.css3Support("gradient")) {
                rows.push({
                    id: "$gradients",
                    cells: ["gradients",
                    {
                        type: "popbox",
                        editorReadonly: true
                    }]
                })
            }
            rows.push({
                id: "cursor",
                cells: ["cursor",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_cursor
                }]
            });
            if (xui.Dom.css3Support("transform")) {
                rows.push({
                    id: "transform",
                    cells: ["transform",
                    {
                        type: "popbox"
                    }]
                })
            }
            rows.push({
                id: "overflow",
                cells: ["overflow",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_overflow
                }]
            });
            if (xui.Dom.css3Support("opacity")) {
                rows.push({
                    id: "opacity",
                    cells: ["opacity",
                    {
                        type: "progress",
                        editorProperties: {
                            min: 0,
                            max: 1
                        }
                    }]
                })
            }
            ns.tg.setRows(rows)
        },
        _ctl_sbutton1_onclick: function (profile) {
            this.setTargetProfile(this.ctl_panel3.get(0))
        },
        _ctl_sbutton37_onclick: function (profile, e, src, value) {
            this.setTargetProfile(this.ctl_tabs2.get(0))
        },
        _com_ondestroy: function (com) {
            if (this.$coverMark) {
                this.$coverMark.remove()
            }
            if (this.$coverMarkTask) {
                this.$coverMarkTask.abort()
            }
        },
        _dialog_beforeclose: function (profile) {
            profile.boxing().hide();
            this.$coverMark.css("display", "none");
            this.tv.setValue(null, true);
            return false
        },
        _tg_beforeComboPop: function (profile, cell, pro, pos, e, src) {
            var ns = this,
                prf = ns.tv.getTagVar(),
                tplKey = ns.tv.getTag(),
                cls;
            switch (cell._row.id) {
            case "border":
                cls = "RAD.CustomBorder";
                break;
            case "border-radius":
                cls = "RAD.CustomBorderRadius";
                break;
            case "text-shadow":
                cls = "RAD.CustomTextShadow";
                break;
            case "box-shadow":
                cls = "RAD.CustomBoxShadow";
                break;
            case "transform":
                cls = "RAD.CustomTransform";
                break;
            case "$gradients":
                cls = "RAD.CustomGradients";
                break
            }
            if (cls) {
                xui.ComFactory.getCom(cls, function () {
                    this.init(prf, tplKey);
                    this.setEvents({
                        onChange: function (str) {
                            pro.boxing().setValue(_.isStr(str) ? str : "[object]", true);
                            profile.boxing().updateCell(cell, {
                                value: str
                            }, false, true)
                        }
                    });
                    this.render();
                    var r = this.mainPane.getRoot();
                    r.popToTop(pro.getRoot());
                    r.setBlurTrigger(r.$xid, function () {
                        r.hide()
                    })
                })
            }
        },
        _tg_aftercellupdated: function (profile, cell, options) {
            if ("value" in options) {
                var ns = this,
                    grid = ns.tg,
                    prf = ns.tv.getTagVar(),
                    tplKey = ns.tv.getTag();
                if (prf && tplKey) {
                    var className = "",
                        hash = {},
                        cells = grid.getCells(null, "value");
                    _.each(cells, function (cell) {
                        if (cell._row.id == "classname") {
                            if (_.str.trim(cell.value) !== "") {
                                className = _.str.trim(cell.value)
                            }
                        } else {
                            var v = "";
                            if (cell._row.id == "$gradients") {
                                hash[cell._row.id] = cell.value
                            } else {
                                if (cell._row.id == "opacity") {
                                    if (parseFloat(cell.value) !== 1) {
                                        v = parseFloat(cell.value);
                                        hash[cell._row.id] = v
                                    }
                                } else {
                                    if (_.str.trim(cell.value) !== "") {
                                        v = _.str.trim(cell.value);
                                        hash[cell._row.id] = v
                                    }
                                }
                            }
                        }
                    });
                    prf.boxing().setCustomClass(tplKey, className || null);
                    prf.boxing().setCustomStyle(tplKey, _.isEmpty(hash) ? null : hash);
                    ns.fireEvent("onDirty")
                }
            }
        }
    }
});
Class("RAD.CustomBorder", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Panel).setHost(host, "mainPane").setDock("none").setLeft(70).setTop(40).setWidth(240).setHeight(140).setZIndex(1).setCaption("Custom Border").setCloseBtn(true).beforeClose("_ctl_panel4_beforeclose"));
            host.mainPane.append((new xui.UI.ComboInput).setHost(host, "r_cS").setDirtyMark(false).setLeft(80).setTop(11).setType("listbox").setItems([{
                id: "dashed",
                caption: "dashed"
            }, {
                id: "dotted",
                caption: "dotted"
            }, {
                id: "double",
                caption: "double"
            }, {
                id: "groove",
                caption: "groove"
            }, {
                id: "hidden",
                caption: "hidden"
            }, {
                id: "inset",
                caption: "inset"
            }, {
                id: "none",
                caption: "none"
            }, {
                id: "outset",
                caption: "outset"
            }, {
                id: "ridge",
                caption: "ridge"
            }, {
                id: "solid",
                caption: "solid"
            }, {
                id: "inherit",
                caption: "inherit"
            }]).setValue("none").afterUIValueSet("_r_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel1").setLeft(10).setTop(15).setWidth(84).setCaption("Style").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel2").setLeft(10).setTop(79).setWidth(84).setCaption("Width").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel7").setLeft(10).setTop(45).setWidth(84).setCaption("Color").setHAlign("left"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "r_sW").setDirtyMark(false).setLeft(61).setTop(71).setWidth(150).setHeight(30).setSteps(15).setIsRange(false).setValue("0").afterUIValueSet("_r_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.ComboInput).setHost(host, "r_cC").setDirtyMark(false).setLeft(80).setTop(41).setType("color").afterUIValueSet("_r_cs_afteruivalueset"));
            return children
        },
        _getValues: function () {
            var ns = this;
            return {
                style: ns.r_cS.getValue(),
                color: ns.r_cC.getValue(),
                width: ns.r_sW.getValue()
            }
        },
        _r_cs_afteruivalueset: function (profile) {
            _.resetRun("border_radius", this.setBR, 0, null, this)
        },
        setBR: function () {
            var values = this._getValues();
            this.fireEvent("onChange", [values.style == "none" ? "" : (values.style + " " + values.color + " " + values.width + "px")])
        },
        init: function (prf, tplkey) {
            var ns = this,
                n = prf.getSubNode(tplkey);
            ns.r_cS.setValue(n.css("borderStyle") || "none", true);
            ns.r_cC.setValue(n.css("borderColor") || "", true);
            ns.r_sW.setValue(n.css("borderWidth") || 0)
        },
        _ctl_panel4_beforeclose: function (profile) {
            profile.boxing().hide();
            return false
        }
    }
});
Class("RAD.CustomBorderRadius", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Panel).setHost(host, "mainPane").setDock("none").setLeft(70).setTop(40).setWidth(280).setHeight(170).setZIndex(1).setCaption("Custom Border Radius").setCloseBtn(true).beforeClose("_ctl_panel4_beforeclose"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel3").setLeft(20).setTop(18).setWidth(84).setCaption("Radius T-left").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel4").setLeft(20).setTop(48).setWidth(84).setCaption("Radius T-Right").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel5").setLeft(20).setTop(78).setWidth(84).setCaption("Radius B-left").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel6").setLeft(20).setTop(108).setWidth(84).setCaption("Radius B-Right").setHAlign("left"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "r_sTL").setDirtyMark(false).setLeft(110).setTop(10).setWidth(150).setHeight(30).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_r_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "r_sTR").setDirtyMark(false).setLeft(110).setTop(40).setWidth(150).setHeight(30).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_r_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "r_sBL").setDirtyMark(false).setLeft(110).setTop(70).setWidth(150).setHeight(30).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_r_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "r_sBR").setDirtyMark(false).setLeft(110).setTop(100).setWidth(150).setHeight(30).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_r_cs_afteruivalueset"));
            return children
        },
        _getValues: function () {
            var ns = this;
            return {
                tl: ns.r_sTL.getValue(),
                tr: ns.r_sTR.getValue(),
                bl: ns.r_sBL.getValue(),
                br: ns.r_sBR.getValue()
            }
        },
        _r_cs_afteruivalueset: function (profile) {
            _.resetRun("border_radius", this.setBR, 0, null, this)
        },
        setBR: function () {
            var values = this._getValues(),
                v;
            if (!(parseInt(values.tl) || parseInt(values.tr) || parseInt(values.br) || parseInt(values.bl))) {
                v = ""
            } else {
                v = values.tl + "px " + values.tr + "px " + values.br + "px " + values.bl + "px"
            }
            this.fireEvent("onChange", [v])
        },
        init: function (prf, tplkey) {
            var ns = this,
                n = prf.getSubNode(tplkey);
            ns.r_sTL.setValue(n.css("borderTopLeftRadius") || 0, true);
            ns.r_sTR.setValue(n.css("borderTopRightRadius") || 0, true);
            ns.r_sBL.setValue(n.css("borderBottomLeftRadius") || 0);
            ns.r_sBR.setValue(n.css("borderBottomRightRadius") || 0)
        },
        _ctl_panel4_beforeclose: function (profile) {
            profile.boxing().hide();
            return false
        }
    }
});
Class("RAD.CustomTextShadow", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Panel).setHost(host, "mainPane").setDock("none").setLeft(70).setTop(40).setWidth(330).setHeight(190).setZIndex(1).setCaption("Custom Text Shadow").setCloseBtn(true).beforeClose("_ctl_panel4_beforeclose"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel3").setLeft(20).setTop(60).setWidth(114).setHeight(10).setCaption("Horizontal Length").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel4").setLeft(20).setTop(93).setWidth(84).setCaption("Vertical Length").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel5").setLeft(20).setTop(128).setWidth(84).setCaption("Blur Radius").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel6").setLeft(20).setTop(24).setWidth(84).setCaption("Shadow Color").setHAlign("left"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "sd_hl").setDirtyMark(false).setLeft(140).setTop(50).setWidth(160).setHeight(30).setSteps(150).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "sd_vl").setDirtyMark(false).setLeft(140).setTop(90).setWidth(160).setHeight(20).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "sd_br").setDirtyMark(false).setLeft(140).setTop(120).setWidth(160).setHeight(30).setSteps(35).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.mainPane.append((new xui.UI.ComboInput).setHost(host, "sd_clr").setDirtyMark(false).setLeft(157).setTop(20).setWidth(130).setType("color").afterUIValueSet("_t_sd_afteruivalueset"));
            return children
        },
        _getValues: function () {
            var ns = this;
            return {
                hl: parseInt(ns.sd_hl.getValue()) - 75,
                vl: parseInt(ns.sd_vl.getValue()) - 50,
                br: ns.sd_br.getValue(),
                clr: ns.sd_clr.getValue()
            }
        },
        _t_sd_afteruivalueset: function (profile) {
            _.resetRun("textShadow", this.setBR, 0, null, this)
        },
        setBR: function () {
            var values = this._getValues(),
                v;
            if (!(values.clr || parseInt(values.hl) || parseInt(values.vl) || parseInt(values.br))) {
                v = ""
            } else {
                v = values.hl + "px " + values.vl + "px " + values.br + "px " + values.clr
            }
            this.fireEvent("onChange", [v])
        },
        init: function (prf, tplkey) {
            var ns = this,
                v = _.get(prf.CS, [tplkey, "textShadow"]);
            if (v) {
                var arr = /([\.\d]+)px\s*([\.\d]+)px\s*([\.\d]+)px\s*(.*)/.exec(v);
                if (arr && arr.length) {
                    arr[1] = 75 + parseFloat(arr[1]);
                    arr[2] = 50 + parseFloat(arr[2]);
                    arr[3] = parseFloat(arr[3])
                }
            }
            if (!arr) {
                arr = [, 75, 50, 0, ""]
            }
            ns.sd_hl.setValue(arr[1]);
            ns.sd_vl.setValue(arr[2]);
            ns.sd_br.setValue(arr[3]);
            ns.sd_clr.setValue(arr[4])
        },
        _ctl_panel4_beforeclose: function (profile) {
            profile.boxing().hide();
            return false
        }
    }
});
Class("RAD.CustomBoxShadow", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Panel).setHost(host, "mainPane").setDock("none").setLeft(70).setTop(40).setWidth(330).setHeight(200).setZIndex(1).setCaption("Custom Box Shadow").setCloseBtn(true).beforeClose("_ctl_panel4_beforeclose"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel3").setLeft(20).setTop(69).setWidth(114).setHeight(10).setCaption("Horizontal Length").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel4").setLeft(20).setTop(102).setWidth(84).setCaption("Vertical Length").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel5").setLeft(20).setTop(137).setWidth(84).setCaption("Blur Radius").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel6").setLeft(20).setTop(35).setWidth(84).setCaption("Shadow Color").setHAlign("left"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "sd_hl").setDirtyMark(false).setLeft(140).setTop(59).setWidth(160).setHeight(30).setSteps(150).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "sd_vl").setDirtyMark(false).setLeft(140).setTop(99).setWidth(160).setHeight(20).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "sd_br").setDirtyMark(false).setLeft(140).setTop(129).setWidth(160).setHeight(30).setSteps(35).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.mainPane.append((new xui.UI.ComboInput).setHost(host, "sd_clr").setDirtyMark(false).setLeft(157).setTop(31).setWidth(134).setType("color").afterUIValueSet("_t_sd_afteruivalueset"));
            host.mainPane.append((new xui.UI.SCheckBox).setHost(host, "c_inset").setDirtyMark(false).setLeft(157).setTop(1).setCaption("Inset").afterValueSet("_t_sd_afteruivalueset"));
            return children
        },
        _getValues: function () {
            var ns = this;
            return {
                hl: parseInt(ns.sd_hl.getValue()) - 75,
                vl: parseInt(ns.sd_vl.getValue()) - 50,
                br: ns.sd_br.getValue(),
                clr: ns.sd_clr.getValue(),
                inset: ns.c_inset.getValue()
            }
        },
        _t_sd_afteruivalueset: function (profile) {
            _.resetRun("boxShadow", this.setBR, 0, null, this)
        },
        setBR: function () {
            var values = this._getValues(),
                v;
            if (!(values.clr || parseInt(values.hl) || parseInt(values.vl) || parseInt(values.br))) {
                v = ""
            } else {
                v = (values.inset ? ("inset ") : "") + values.hl + "px " + values.vl + "px " + values.br + "px " + values.clr
            }
            this.fireEvent("onChange", [v])
        },
        init: function (prf, tplkey) {
            var ns = this,
                v = _.get(prf.CS, [tplkey, "boxShadow"]);
            if (v) {
                var arr = /([\w]*)?\s*([\.\d]+)px\s*([\.\d]+)px\s*([\.\d]+)px\s*(.*)?/.exec(v);
                if (arr && arr.length) {
                    arr[2] = 75 + parseFloat(arr[2]);
                    arr[3] = 50 + parseFloat(arr[3]);
                    arr[4] = parseFloat(arr[4])
                }
            }
            if (!arr) {
                arr = [, "", 75, 50, 0, ""]
            }
            if (_.str.trim(arr[1] || "").toLowerCase() == "inset") {
                ns.c_inset.setValue(true)
            } else {
                ns.c_inset.setValue(false)
            }
            ns.sd_hl.setValue(arr[2]);
            ns.sd_vl.setValue(arr[3]);
            ns.sd_br.setValue(arr[4]);
            ns.sd_clr.setValue(arr[5])
        },
        _ctl_panel4_beforeclose: function (profile) {
            profile.boxing().hide();
            return false
        }
    }
});
Class("RAD.CustomTransform", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Panel).setHost(host, "mainPane").setDock("none").setLeft(50).setTop(0).setWidth(500).setHeight(180).setZIndex(1).setCaption("Custom Transform").setCloseBtn(true).beforeClose("_ctl_panel4_beforeclose"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel3").setLeft(11).setTop(21).setWidth(84).setCaption("Rotate").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel4").setLeft(11).setTop(59).setWidth(84).setCaption("Scale X").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel5").setLeft(11).setTop(89).setWidth(84).setCaption("Skew X").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel6").setLeft(11).setTop(119).setWidth(84).setCaption("Translate X").setHAlign("left"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "t_Rotate").setDirtyMark(false).setLeft(81).setTop(11).setWidth(400).setHeight(30).setSteps(360).setIsRange(false).setValue("0").afterUIValueSet("_t_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "t_ScaleY").setDirtyMark(false).setLeft(331).setTop(51).setWidth(150).setHeight(30).setSteps(150).setIsRange(false).setValue("0").afterUIValueSet("_t_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "t_ScaleX").setDirtyMark(false).setLeft(81).setTop(51).setWidth(150).setHeight(30).setSteps(150).setIsRange(false).setValue("0").afterUIValueSet("_t_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel63").setLeft(261).setTop(59).setWidth(84).setCaption("Scale Y").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel64").setLeft(261).setTop(91).setWidth(84).setCaption("Skew Y").setHAlign("left"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel65").setLeft(261).setTop(121).setWidth(84).setCaption("Translate Y").setHAlign("left"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "t_SkewX").setDirtyMark(false).setLeft(81).setTop(81).setWidth(150).setHeight(30).setSteps(360).setIsRange(false).setValue("0").afterUIValueSet("_t_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "t_SkewY").setDirtyMark(false).setLeft(331).setTop(81).setWidth(150).setHeight(30).setSteps(360).setIsRange(false).setValue("0").afterUIValueSet("_t_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "t_TransY").setDirtyMark(false).setLeft(331).setTop(111).setWidth(150).setHeight(30).setSteps(200).setIsRange(false).setValue("0").afterUIValueSet("_t_cs_afteruivalueset"));
            host.mainPane.append((new xui.UI.Slider).setHost(host, "t_TransX").setDirtyMark(false).setLeft(81).setTop(111).setWidth(150).setHeight(30).setSteps(200).setIsRange(false).setValue("4").afterUIValueSet("_t_cs_afteruivalueset"));
            return children
        },
        _getValues: function () {
            var ns = this;
            return {
                rotate: parseInt(ns.t_Rotate.getValue()),
                scale: [parseInt(ns.t_ScaleX.getValue()) / 100, parseInt(ns.t_ScaleY.getValue()) / 100],
                skew: [parseInt(ns.t_SkewX.getValue()) - 180, parseInt(ns.t_SkewY.getValue()) - 180],
                translate: [parseInt(ns.t_TransX.getValue()) - 100, parseInt(ns.t_TransY.getValue()) - 100]
            }
        },
        _t_cs_afteruivalueset: function (profile) {
            _.resetRun("border_transform", this.setBR, 0, null, this)
        },
        setBR: function () {
            var ns = this;
            var values = this._getValues(),
                v;
            if (!(parseInt(ns.t_Rotate.getValue()) || parseInt(ns.t_ScaleX.getValue(100)) || parseInt(ns.t_ScaleY.getValue(100)) || parseInt(ns.t_SkewX.getValue()) || parseInt(ns.t_SkewY.getValue()) || parseInt(ns.t_TransX.getValue()) || parseInt(ns.t_TransY.getValue()))) {
                v = ""
            } else {
                v = "rotate(" + values.rotate + "deg) scale(" + values.scale.join(",") + ") skew(" + values.skew.join("deg,") + "deg) translate(" + values.translate.join("px,") + "px) "
            }
            this.fireEvent("onChange", [v])
        },
        init: function (prf, tplkey) {
            var ns = this,
                v = _.get(prf.CS, [tplkey, "transform"]);
            if (v) {
                var arr = /rotate\(([\.\d]+)deg\)\s+scale\(([\.\d]+),\s*([\.\d]+)\)\s+skew\(([\.\d]+)deg,\s*([\.\d]+)deg\)\s+translate\(([\.\d]+)px,\s*([\.\d]+)px\)/.exec(v);
                if (arr && arr.length) {
                    arr[1] = parseFloat(arr[1]);
                    arr[2] = 100 * parseFloat(arr[2]);
                    arr[3] = 100 * parseFloat(arr[3]);
                    arr[4] = 180 + parseInt(arr[4]);
                    arr[5] = 180 + parseInt(arr[5]);
                    arr[6] = 100 + parseInt(arr[6]);
                    arr[7] = 100 + parseInt(arr[7])
                }
            }
            if (!arr) {
                arr = [, 0, 100, 100, 180, 180, 100, 100]
            }
            ns.t_Rotate.setValue(arr[1]);
            ns.t_ScaleX.setValue(arr[2]);
            ns.t_ScaleY.setValue(arr[3]);
            ns.t_SkewX.setValue(arr[4]);
            ns.t_SkewY.setValue(arr[5]);
            ns.t_TransX.setValue(arr[6]);
            ns.t_TransY.setValue(arr[7])
        },
        _ctl_panel4_beforeclose: function (profile) {
            profile.boxing().hide();
            return false
        }
    }
});
Class("RAD.CustomDecoration", "xui.Com", {
    Instance: {
        initialize: function () {
            this.autoDestroy = true;
            this.properties = {}
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dialog").setLeft(210).setTop(20).setWidth(260).setHeight(410).setResizer(false).setOverflow("visible").setCaption("Custom Decoration").setMinBtn(false).setMaxBtn(false).beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Group).setHost(host, "grpNodes").setLeft(0).setTop(4).setWidth(250).setHeight(126).setCaption("grpNodes").setToggleBtn(false));
            host.grpNodes.append((new xui.UI.TreeView).setHost(host, "tv").setDirtyMark(false).onItemSelected("_tv_onitemselected").setCustomStyle({
                BOX: "background-color:transparent;"
            }));
            host.dialog.append((new xui.UI.Block).setHost(host, "ctl_block3").setLeft(0).setTop(153).setWidth(250).setHeight(227).setBorderType("inset").setBackground("#fff"));
            host.ctl_block3.append((new xui.UI.TreeGrid).setHost(host, "tg").setDirtyMark(false).setRowHandler(false).setColSortable(false).setHeader([{
                id: "key",
                width: 90,
                type: "label",
                caption: "Prop"
            }, {
                id: "value",
                editable: true,
                width: 134,
                type: "input",
                caption: "Custom Value"
            }]).afterCellUpdated("_tg_aftercellupdated").beforeComboPop("_tg_beforeComboPop").setCustomStyle({
                SCROLL: "overflow-x:hidden;overflow-y:auto;"
            }));
            host.dialog.append((new xui.UI.Input).setHost(host, "ctl_input1").setReadonly(true).setLeft(0).setTop(133).setWidth(250).setLabelCaption("ctl_input1"));
            return children
        },
        customAppend: function (parent, subId, left, top) {
            var ns = this,
                prop = ns.properties;
            ns.setTargetProfile(prop.targetProfile);
            xui("body").append(ns.dialog);
            ns.dialog.getRoot().popToTop(prop.targetProfile.getRootNode(), 2).setBlurTrigger("RAD.CustomDecoration", function () {
                ns.dialog.close()
            });
            ns.dialog.activate();
            return true
        },
        setTargetProfile: function (profile) {
            var ns = this,
                items = [],
                rootItem;
            var fun = function (hash, subMap, arr, tag) {
                    var item;
                    for (var i in hash) {
                        if (i.charAt(0) != "$") {
                            var tagName = (hash[i] && hash[i].tagName || "span").toLowerCase();
                            if (!/[a-z]/.test(i)) {
                                item = {
                                    id: i,
                                    caption: i + " [" + tagName.toUpperCase() + "]",
                                    image: xui.getPath("img/", "App.gif"),
                                    imagePos: "-112px 0"
                                };
                                if (subMap && hash[i].text && subMap[(tag ? (tag + ".") : "") + hash[i].text.replace(/^{(.*)}$/, "$1")]) {
                                    item.sub = [];
                                    var tag = (tag ? (tag + ".") : "") + hash[i].text.replace(/^{(.*)}$/, "$1");
                                    if (tag == "rows.cells") {
                                        tag = "rows.cells.input"
                                    }
                                    arguments.callee(subMap[tag], subMap, item.sub, tag);
                                    if (tagName == "text" && item.sub.length) {
                                        item = item.sub[0]
                                    }
                                } else {
                                    if (tagName == "text") {
                                        continue
                                    } else {
                                        if (typeof hash[i] == "object" && tagName != "text") {
                                            item.sub = [];
                                            arguments.callee(hash[i], subMap, item.sub, tag)
                                        }
                                    }
                                }
                                if (!item.sub || !item.sub.length) {
                                    delete item.sub
                                }
                                arr[arr.length] = item
                            }
                        }
                    }
                };
            var i = "_",
                hash = profile.box.$Templates,
                tagName = (hash[i].tagName || "span").toLowerCase();
            items.push(rootItem = {
                id: "KEY",
                caption: "ROOT [" + tagName.toUpperCase() + "]",
                image: xui.getPath("img/", "App.gif"),
                imagePos: "-112px 0",
                sub: []
            });
            var subMap = hash[i].$submap;
            if (subMap && hash[i].text && subMap[hash[i].text.replace(/^{(.*)}$/, "$1")]) {
                var tag = hash[i].text.replace(/^{(.*)}$/, "$1");
                fun(subMap[tag], subMap, rootItem.sub, tag);
                if (tagName == "text" && rootItem.sub.length) {
                    rootItem = rootItem.sub[0]
                }
            }
            fun(hash[i], subMap, rootItem.sub, null);
            if (!rootItem.sub.length) {
                delete rootItem.sub
            }
            ns.grpNodes.setCaption(profile.key.slice(profile.key.lastIndexOf(".") + 1) + " : " + profile.alias);
            ns.tv.setTagVar(profile);
            ns.tv.setItems(items);
            ns.tg.updateCellByRowCol("classname", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("font-family", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("font-size", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("font-weight", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("font-style", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("color", "value", {
                value: tagName == "image" ? "#EBEADB" : "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("background-color", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("border", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("border-radius", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("text-decoration", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("text-align", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("text-shadow", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("cursor", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("overflow", "value", {
                value: "",
                disabled: tagName == "image"
            }, false, false);
            ns.tg.updateCellByRowCol("opacity", "value", {
                value: 1
            }, false, false);
            ns.tg.updateCellByRowCol("transform", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("box-shadow", "value", {
                value: ""
            }, false, false);
            ns.tg.updateCellByRowCol("$gradients", "value", {
                value: ""
            }, false, false);
            ns.tg.setDisabled(true);
            ns.ctl_input1.setValue("");
            ns.tv.toggleNode("KEY", true, true);
            ns.tv.fireItemClickEvent("KEY")
        },
        _tv_onitemselected: function (profile, item, e) {
            var ns = this,
                prf = profile.boxing().getTagVar(),
                box = prf.box,
                PanelKeys = box.$Behaviors && box.$Behaviors.PanelKeys;
            ns.tg.setDisabled(false);
            if (!ns.$coverMark) {
                ns.$coverMark = xui.create('<div style="z-index:2000;border:solid 1px;background-color:#ff0000;position:absolute;font-size:0;line-height:0;display:none;">').css("opacity", 0.3);
                xui("body").append(ns.$coverMark);
                ns.$coverMarkTask = xui.Thread.repeat(function () {
                    ns.$coverMarkTask.$_mark = !ns.$coverMarkTask.$_mark;
                    ns.$coverMark.css("backgroundColor", ns.$coverMarkTask.$_mark ? "#0000ff" : "#ff0000");
                    ns.$coverMark.css("border-color", ns.$coverMarkTask.$_mark ? "#fff" : "#000")
                }, 500)
            }
            if (item.id == "KEY") {
                ns.$coverMark.css("display", "none");
                var node = prf.getRootNode();
                var nodeText = "<" + node.tagName + " id='" + node.id + "' class='" + node.className + "' style='" + xui(node).attr("style") + "'>";
                ns.ctl_input1.setValue(nodeText).setTips(nodeText.replace(/</, "&lt;"))
            } else {
                var nodes = prf.getSubNode(item.id, true);
                if (nodes.get(0)) {
                    var set = false;
                    nodes.each(function (node) {
                        if (node.offsetWidth) {
                            var region = xui(node).offset();
                            region.width = node.offsetWidth;
                            region.height = node.offsetHeight;
                            if (region.width <= 0) {
                                region.width = 2
                            } else {
                                region.width -= 2
                            }
                            if (region.height <= 0) {
                                region.height = 2
                            } else {
                                region.height -= 2
                            }
                            if (region.width <= 0) {
                                region.width = 2
                            }
                            if (region.height <= 0) {
                                region.height = 2
                            }
                            ns.$coverMark.cssRegion(region).css("display", "block");
                            var nodeText = "<" + node.tagName + " id='" + node.id + "' class='" + node.className + "' style='" + xui(node).attr("style") + "'>";
                            ns.ctl_input1.setValue(nodeText).setTips(nodeText.replace(/</, "&lt;"));
                            set = true;
                            return false
                        }
                    });
                    if (!set) {
                        ns.$coverMark.css("display", "none")
                    }
                } else {
                    ns.$coverMark.css("display", "none")
                }
            }
            ns.tg.updateCellByRowCol("classname", "value", {
                value: prf.CC[item.id] || null
            }, false, false);
            var cs = prf.CS[item.id],
                csaMap = {};
            if (cs) {
                if (_.isStr(cs)) {
                    var csa = cs.split(/\s*;+\s*/);
                    _.arr.each(csa, function (style) {
                        if (style) {
                            var kv = style.split(/\s*:\s*/);
                            if (kv.length == 2) {
                                csaMap[kv[0]] = kv[1]
                            }
                        }
                    })
                } else {
                    csaMap = cs
                }
            }
            ns.tg.updateCellByRowCol("font-family", "value", {
                value: csaMap["font-family"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("font-size", "value", {
                value: csaMap["font-size"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("font-weight", "value", {
                value: csaMap["font-weight"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("font-style", "value", {
                value: csaMap["font-style"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("color", "value", {
                value: csaMap.color || ""
            }, false, false);
            ns.tg.updateCellByRowCol("background-color", "value", {
                value: csaMap["background-color"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("border", "value", {
                value: csaMap.border || ""
            }, false, false);
            ns.tg.updateCellByRowCol("border-radius", "value", {
                value: csaMap["border-radius"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("text-align", "value", {
                value: csaMap["text-align"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("text-decoration", "value", {
                value: csaMap["text-decoration"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("text-shadow", "value", {
                value: csaMap["text-shadow"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("box-shadow", "value", {
                value: csaMap["box-shadow"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("$gradients", "value", {
                value: csaMap["$gradients"] || ""
            }, false, false);
            ns.tg.updateCellByRowCol("cursor", "value", {
                value: csaMap.cursor || ""
            }, false, false);
            ns.tg.updateCellByRowCol("overflow", "value", {
                value: csaMap.overflow || ""
            }, false, false);
            ns.tg.updateCellByRowCol("opacity", "value", {
                value: (parseFloat(csaMap.opacity) || parseFloat(csaMap.opacity) === 0) ? csaMap.opacity : 1
            }, false, false);
            ns.tg.updateCellByRowCol("transform", "value", {
                value: csaMap.transform || ""
            }, false, false);
            profile.boxing().setTag(item.id)
        },
        events: {
            onReady: "_com_onready",
            onDestroy: "_com_ondestroy"
        },
        _com_onready: function (com, threadid) {
            var ns = this,
                rows = [];
            rows.push({
                id: "classname",
                cellStyle: "font-weight:bold;",
                cells: ["class", ""]
            });
            rows.push({
                id: "font-family",
                cells: ["font-family",
                {
                    type: "helpinput",
                    editorListItems: CONF.designer_data_fontfamily
                }]
            });
            rows.push({
                id: "font-size",
                cells: ["font-size",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_fontsize
                }]
            });
            rows.push({
                id: "font-weight",
                cells: ["font-weight",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_fontweight
                }]
            });
            rows.push({
                id: "font-style",
                cells: ["font-style",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_fontstyle
                }]
            });
            rows.push({
                id: "color",
                cells: ["color",
                {
                    type: "color"
                }]
            });
            rows.push({
                id: "background-color",
                cells: ["background-color",
                {
                    type: "color"
                }]
            });
            rows.push({
                id: "border",
                cells: ["border",
                {
                    type: "popbox"
                }]
            });
            if (xui.Dom.css3Support("border-radius")) {
                rows.push({
                    id: "border-radius",
                    cells: ["border-radius",
                    {
                        type: "popbox"
                    }]
                })
            }
            rows.push({
                id: "text-align",
                cells: ["text-align",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_textalign
                }]
            });
            rows.push({
                id: "text-decoration",
                cells: ["text-decoration",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_textdecoration
                }]
            });
            if (xui.Dom.css3Support("text-shadow")) {
                rows.push({
                    id: "text-shadow",
                    cells: ["text-shadow",
                    {
                        type: "popbox"
                    }]
                })
            }
            if (xui.Dom.css3Support("box-shadow")) {
                rows.push({
                    id: "box-shadow",
                    cells: ["box-shadow",
                    {
                        type: "popbox"
                    }]
                })
            }
            if (xui.Dom.css3Support("gradient")) {
                rows.push({
                    id: "$gradients",
                    cells: ["gradients",
                    {
                        type: "popbox",
                        editorReadonly: true
                    }]
                })
            }
            rows.push({
                id: "cursor",
                cells: ["cursor",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_cursor
                }]
            });
            if (xui.Dom.css3Support("transform")) {
                rows.push({
                    id: "transform",
                    cells: ["transform",
                    {
                        type: "popbox"
                    }]
                })
            }
            rows.push({
                id: "overflow",
                cells: ["overflow",
                {
                    type: "combobox",
                    editorListItems: CONF.designer_data_overflow
                }]
            });
            if (xui.Dom.css3Support("opacity")) {
                rows.push({
                    id: "opacity",
                    cells: ["opacity",
                    {
                        type: "progress",
                        editorProperties: {
                            min: 0,
                            max: 1
                        }
                    }]
                })
            }
            ns.tg.setRows(rows)
        },
        _ctl_sbutton1_onclick: function (profile) {
            this.setTargetProfile(this.ctl_panel3.get(0))
        },
        _ctl_sbutton37_onclick: function (profile, e, src, value) {
            this.setTargetProfile(this.ctl_tabs2.get(0))
        },
        _com_ondestroy: function (com) {
            if (this.$coverMark) {
                this.$coverMark.remove()
            }
            if (this.$coverMarkTask) {
                this.$coverMarkTask.abort()
            }
        },
        _dialog_beforeclose: function (profile) {
            profile.boxing().hide();
            this.$coverMark.css("display", "none");
            this.tv.setValue(null, true);
            return false
        },
        _tg_beforeComboPop: function (profile, cell, pro, pos, e, src) {
            var ns = this,
                prf = ns.tv.getTagVar(),
                tplKey = ns.tv.getTag(),
                cls;
            switch (cell._row.id) {
            case "border":
                cls = "RAD.CustomBorder";
                break;
            case "border-radius":
                cls = "RAD.CustomBorderRadius";
                break;
            case "text-shadow":
                cls = "RAD.CustomTextShadow";
                break;
            case "box-shadow":
                cls = "RAD.CustomBoxShadow";
                break;
            case "transform":
                cls = "RAD.CustomTransform";
                break;
            case "$gradients":
                cls = "RAD.CustomGradients";
                break
            }
            if (cls) {
                xui.ComFactory.getCom(cls, function () {
                    this.init(prf, tplKey);
                    this.setEvents({
                        onChange: function (str) {
                            pro.boxing().setValue(_.isStr(str) ? str : "[object]", true);
                            profile.boxing().updateCell(cell, {
                                value: str
                            }, false, true)
                        }
                    });
                    this.render();
                    var r = this.mainPane.getRoot();
                    r.popToTop(pro.getRoot());
                    r.setBlurTrigger(r.$xid, function () {
                        r.hide()
                    })
                })
            }
        },
        _tg_aftercellupdated: function (profile, cell, options) {
            if ("value" in options) {
                var ns = this,
                    grid = ns.tg,
                    prf = ns.tv.getTagVar(),
                    tplKey = ns.tv.getTag();
                if (prf && tplKey) {
                    var className = "",
                        hash = {},
                        cells = grid.getCells(null, "value");
                    _.each(cells, function (cell) {
                        if (cell._row.id == "classname") {
                            if (_.str.trim(cell.value) !== "") {
                                className = _.str.trim(cell.value)
                            }
                        } else {
                            var v = "";
                            if (cell._row.id == "$gradients") {
                                hash[cell._row.id] = cell.value
                            } else {
                                if (cell._row.id == "opacity") {
                                    if (parseFloat(cell.value) !== 1) {
                                        v = parseFloat(cell.value);
                                        hash[cell._row.id] = v
                                    }
                                } else {
                                    if (_.str.trim(cell.value) !== "") {
                                        v = _.str.trim(cell.value);
                                        hash[cell._row.id] = v
                                    }
                                }
                            }
                        }
                    });
                    prf.boxing().setCustomClass(tplKey, className || null);
                    prf.boxing().setCustomStyle(tplKey, _.isEmpty(hash) ? null : hash);
                    ns.fireEvent("onDirty")
                }
            }
        }
    }
});
Class("RAD.CustomGradients", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Panel).setHost(host, "mainPane").setDock("none").setLeft(70).setTop(30).setWidth(440).setHeight(220).setCaption("Custom Gradients").setCloseBtn(true).beforeClose("_ctl_panel4_beforeclose"));
            host.mainPane.append((new xui.UI.SLabel).setHost(host, "ctl_slabel26").setLeft(28).setTop(15).setWidth(64).setHeight(14).setCaption("Orientation").setHAlign("left"));
            host.mainPane.append((new xui.UI.ComboInput).setHost(host, "t_otype").setDirtyMark(false).setLeft(108).setTop(11).setWidth(313).setType("listbox").setItems([{
                id: "linear-LT",
                caption: "Linear - from LeftTop"
            }, {
                id: "linear-T",
                caption: "Linear - from Top"
            }, {
                id: "linear-RT",
                caption: "Linear - from RightTop"
            }, {
                id: "linear-R",
                caption: "Linear - from Right"
            }, {
                id: "linear-RB",
                caption: "Linear - from RightBottom"
            }, {
                id: "linear-B",
                caption: "Linear - from Bottom"
            }, {
                id: "linear-LB",
                caption: "Linear - from LeftBottom"
            }, {
                id: "linear-L",
                caption: "Linear - from Left"
            }, {
                id: "none",
                disabled: true,
                caption: "-------------"
            }, {
                id: "radial-C",
                caption: "Radial - at Center"
            }, {
                id: "radial-LT",
                caption: "Radial - at LeftTop"
            }, {
                id: "radial-T",
                caption: "Radial - at Top"
            }, {
                id: "radial-RT",
                caption: "Radial - at RightTop"
            }, {
                id: "radial-R",
                caption: "Radial - at Right"
            }, {
                id: "radial-RB",
                caption: "Radial - at RightBottom"
            }, {
                id: "radial-B",
                caption: "Radial - at Bottom"
            }, {
                id: "radial-LB",
                caption: "Radial - at LeftBottom"
            }, {
                id: "radial-L",
                caption: "Radial - at Left"
            }]).setValue("linear-T").afterUIValueSet("_t_sd_afteruivalueset"));
            host.mainPane.append((new xui.UI.Block).setHost(host, "ctl_block3").setLeft(9).setTop(41).setWidth(414).setHeight(20).setBorderType("inset"));
            host.ctl_block3.append((new xui.UI.SLabel).setHost(host, "ctl_slabel5").setLeft(354).setTop(3).setCaption("Opacity"));
            host.ctl_block3.append((new xui.UI.SLabel).setHost(host, "ctl_slabel4").setLeft(290).setTop(3).setCaption("Color"));
            host.ctl_block3.append((new xui.UI.SLabel).setHost(host, "ctl_slabel3").setLeft(158).setTop(3).setCaption("Offset"));
            host.ctl_block3.append((new xui.UI.SLabel).setHost(host, "ctl_slabel6").setLeft(30).setTop(2).setCaption("Stops"));
            host.mainPane.append((new xui.UI.Block).setHost(host, "ctl_block7").setLeft(9).setTop(61).setWidth(414).setHeight(125).setBorderType("inset"));
            host.ctl_block7.append((new xui.UI.Slider).setHost(host, "g_step1").setDirtyMark(false).setDisabled(true).setLeft(80).setTop(0).setWidth(181).setHeight(30).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.ComboInput).setHost(host, "g_step1clr").setDirtyMark(false).setDisabled(true).setLeft(261).setTop(4).setWidth(91).setType("color").afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.Slider).setHost(host, "g_step2").setDirtyMark(false).setDisabled(true).setLeft(80).setTop(30).setWidth(181).setHeight(30).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.ComboInput).setHost(host, "g_step2clr").setDirtyMark(false).setDisabled(true).setLeft(261).setTop(34).setWidth(91).setType("color").afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.Slider).setHost(host, "g_step3").setDirtyMark(false).setDisabled(true).setLeft(80).setTop(60).setWidth(181).setHeight(30).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.ComboInput).setHost(host, "g_step3clr").setDirtyMark(false).setDisabled(true).setLeft(261).setTop(64).setWidth(91).setType("color").afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.SCheckBox).setHost(host, "c_step1").setDirtyMark(false).setLeft(10).setTop(2).setCaption("Stop").afterValueSet("_c_step1_aftervalueset"));
            host.ctl_block7.append((new xui.UI.SCheckBox).setHost(host, "c_step2").setDirtyMark(false).setLeft(10).setTop(32).setCaption("Stop").afterValueSet("_c_step2_aftervalueset"));
            host.ctl_block7.append((new xui.UI.SCheckBox).setHost(host, "c_step3").setDirtyMark(false).setLeft(10).setTop(62).setCaption("Stop").afterValueSet("_c_step3_aftervalueset"));
            host.ctl_block7.append((new xui.UI.Slider).setHost(host, "g_step4").setDirtyMark(false).setDisabled(true).setLeft(80).setTop(90).setWidth(181).setHeight(30).setSteps(100).setIsRange(false).setValue("0").afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.ComboInput).setHost(host, "g_step4clr").setDirtyMark(false).setDisabled(true).setLeft(261).setTop(94).setWidth(91).setType("color").afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.SCheckBox).setHost(host, "c_step4").setDirtyMark(false).setLeft(10).setTop(92).setCaption("Stop").afterValueSet("_c_step4_aftervalueset"));
            host.ctl_block7.append((new xui.UI.ComboInput).setHost(host, "g_step1o").setDisabled(true).setLeft(353).setTop(4).setWidth(51).setType("spin").setDirtyMark(false).setPrecision(2).setIncrement(0.1).setMin(0).setMax(1).setValue(1).afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.ComboInput).setHost(host, "g_step2o").setLeft(353).setTop(34).setWidth(51).setType("spin").setDirtyMark(false).setPrecision(2).setIncrement(0.1).setMin(0).setMax(1).setValue(1).afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.ComboInput).setHost(host, "g_step3o").setLeft(353).setTop(64).setWidth(51).setType("spin").setDirtyMark(false).setPrecision(2).setIncrement(0.1).setMin(0).setMax(1).setValue(1).afterUIValueSet("_t_sd_afteruivalueset"));
            host.ctl_block7.append((new xui.UI.ComboInput).setHost(host, "g_step4o").setLeft(353).setTop(94).setWidth(51).setType("spin").setDirtyMark(false).setPrecision(2).setIncrement(0.1).setMin(0).setMax(1).setValue(1).afterUIValueSet("_t_sd_afteruivalueset"));
            return children
        },
        _getValues: function () {
            var ns = this,
                arr = [],
                h, i;
            if (ns.c_step1.getValue()) {
                h = {
                    pos: ns.g_step1.getValue() + "%",
                    clr: ns.g_step1clr.getValue() || "#ffffff"
                };
                i = ns.g_step1o.getValue();
                if (parseInt(i * 100) != 100) {
                    h.opacity = i
                }
                arr.push(h)
            }
            if (ns.c_step2.getValue()) {
                h = {
                    pos: ns.g_step2.getValue() + "%",
                    clr: ns.g_step2clr.getValue() || "#ffffff"
                };
                i = ns.g_step2o.getValue();
                if (parseInt(i * 100) != 100) {
                    h.opacity = i
                }
                arr.push(h)
            }
            if (ns.c_step3.getValue()) {
                h = {
                    pos: ns.g_step3.getValue() + "%",
                    clr: ns.g_step3clr.getValue() || "#ffffff"
                };
                i = ns.g_step3o.getValue();
                if (parseInt(i * 100) != 100) {
                    h.opacity = i
                }
                arr.push(h)
            }
            if (ns.c_step4.getValue()) {
                h = {
                    pos: ns.g_step4.getValue() + "%",
                    clr: ns.g_step4clr.getValue() || "#ffffff"
                };
                i = ns.g_step4o.getValue();
                if (parseInt(i * 100) != 100) {
                    h.opacity = i
                }
                arr.push(h)
            }
            if (arr.length) {
                arr.sort(function (x, y) {
                    x = parseFloat(x.step);
                    y = parseFloat(y.step);
                    return x > y ? 1 : x == y ? 0 : -1
                })
            }
            return arr
        },
        _t_sd_afteruivalueset: function (profile) {
            _.resetRun("Gradients", this.setTS, 0, null, this)
        },
        setTS: function () {
            var ns = this,
                ori = ns.t_otype.getValue(),
                v = {
                    stops: ns._getValues()
                };
            ori = ori.split("-");
            v.type = ori[0];
            v.orient = ori[1];
            if (v.stops.length <= 0) {
                v = null
            }
            this.fireEvent("onChange", [v])
        },
        init: function (prf, tplkey) {
            var ns = this,
                v = _.get(prf.CS, [tplkey, "$gradients"]),
                type, op;
            if (!v) {
                v = {}
            }
            if (!v.type) {
                v.type = "linear"
            }
            if (!v.orient) {
                v.orient = "T"
            }
            if (!v.point) {
                v.point = "left"
            }
            if (!v.stops) {
                v.stops = []
            }
            type = v.type + "-" + v.orient;
            ns.t_otype.setValue(type);
            if (v.stops.length > 0) {
                ns.c_step1.setValue(true, true);
                ns.g_step1.setValue(v.stops[0].pos || 0);
                ns.g_step1clr.setValue(v.stops[0].clr || "");
                op = v.stops[0].opacity;
                ns.g_step1o.setValue((op || op === 0) ? op : 100)
            } else {
                ns.c_step1.setValue(false, true);
                ns.g_step1.setValue(0);
                ns.g_step1clr.setValue("");
                ns.g_step1o.setValue(1)
            }
            if (v.stops.length > 1) {
                ns.c_step2.setValue(true, true);
                ns.g_step2.setValue(v.stops[1].pos || 0);
                ns.g_step2clr.setValue(v.stops[1].clr || "");
                op = v.stops[1].opacity;
                ns.g_step2o.setValue((op || op === 0) ? op : 100)
            } else {
                ns.c_step2.setValue(false, true);
                ns.g_step2.setValue(0);
                ns.g_step2clr.setValue("");
                ns.g_step2o.setValue(1)
            }
            if (v.stops.length > 2) {
                ns.c_step3.setValue(true, true);
                ns.g_step3.setValue(v.stops[2].pos || 0);
                ns.g_step3clr.setValue(v.stops[2].clr || "");
                op = v.stops[2].opacity;
                ns.g_step3o.setValue((op || op === 0) ? op : 100)
            } else {
                ns.c_step3.setValue(false, true);
                ns.g_step3.setValue(0);
                ns.g_step3clr.setValue("");
                ns.g_step3o.setValue(1)
            }
            if (v.stops.length > 3) {
                ns.c_step4.setValue(true, true);
                ns.g_step4.setValue(v.stops[3].pos || 0);
                ns.g_step4clr.setValue(v.stops[3].clr || "");
                op = v.stops[3].opacity;
                ns.g_step4o.setValue((op || op === 0) ? op : 100)
            } else {
                ns.c_step4.setValue(false, true);
                ns.g_step4.setValue(0);
                ns.g_step4clr.setValue("");
                ns.g_step4o.setValue(1)
            }
        },
        _ctl_panel4_beforeclose: function (profile) {
            profile.boxing().hide();
            return false
        },
        _c_step1_aftervalueset: function (profile, oldValue, newValue) {
            var ns = this;
            ns.g_step1.setValue(0).setDisabled(!newValue);
            ns.g_step1clr.setValue("").setDisabled(!newValue);
            ns.g_step1o.setValue("1").setDisabled(!newValue);
            ns.setTS()
        },
        _c_step2_aftervalueset: function (profile, oldValue, newValue) {
            var ns = this;
            ns.g_step2.setValue(0).setDisabled(!newValue);
            ns.g_step2clr.setValue("").setDisabled(!newValue);
            ns.g_step2o.setValue("1").setDisabled(!newValue);
            ns.setTS()
        },
        _c_step3_aftervalueset: function (profile, oldValue, newValue) {
            var ns = this;
            ns.g_step3.setValue(0).setDisabled(!newValue);
            ns.g_step3clr.setValue("").setDisabled(!newValue);
            ns.g_step3o.setValue("1").setDisabled(!newValue);
            ns.setTS()
        },
        _c_step4_aftervalueset: function (profile, oldValue, newValue) {
            var ns = this;
            ns.g_step4.setValue(0).setDisabled(!newValue);
            ns.g_step4clr.setValue("").setDisabled(!newValue);
            ns.g_step4o.setValue("1").setDisabled(!newValue);
            ns.setTS()
        }
    }
});
Class("RAD.RegisterForm", "xui.Com", {
    Instance: {
        customAppend: function () {
            this.dlg.showModal();
            if (this.properties.registered) {
                this.ctl_sbutton8.setDisplay("none");
                this.ctl_sbutton9.setCaption("Close");
                xui.alert("You'v registered already!")
            } else {
                this.ctl_sbutton8.setDisplay("");
                this.ctl_sbutton9.setCaption("Continue trial")
            }
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dlg").setLeft(120).setTop(60).setWidth(371).setHeight(140).setResizer(false).setCaption("Register").setMinBtn(false).setMaxBtn(false).setCloseBtn(false).beforeClose("_dlg_beforeclose"));
            host.dlg.append((new xui.UI.Div).setHost(host, "ctl_div10").setLeft(20).setTop(10).setWidth(320).setHeight(20).setHtml("Enter <b>License Code</b>:<br>"));
            host.dlg.append((new xui.UI.Input).setHost(host, "ctl_input2").setDirtyMark(false).setLeft(20).setTop(30).setWidth(170));
            host.dlg.append((new xui.UI.SButton).setHost(host, "ctl_sbutton5").setLeft(210).setTop(30).setWidth(130).setCaption("Click to Register").onClick("_ctl_sbutton5_onclick"));
            host.dlg.append((new xui.UI.SButton).setHost(host, "ctl_sbutton8").setLeft(210).setTop(70).setWidth(130).setCaption("Buy licence code").onClick("_ctl_sbutton8_onclick"));
            host.dlg.append((new xui.UI.SButton).setHost(host, "ctl_sbutton9").setLeft(20).setTop(70).setWidth(170).setCaption("Continue trial").onClick("_ctl_sbutton9_onclick"));
            host.dlg.append((new xui.UI.Block).setHost(host, "ctl_block6").setLeft(10).setTop(60).setWidth(340).setHeight(2).setBorderType("inset"));
            return children
        },
        _ctl_sbutton5_onclick: function (profile, e, src, value) {
            var ns = this,
                code = ns.ctl_input2.getUIValue();
            code = _.str.trim(code);
            if (!code) {
                return
            }
            ns.dlg.busy("Try to register ...");
            this.fireEvent("onOK", [code, function (text) {
                SPA.statusBar.setHtml(text);
                ns.dlg.free();
                xui.alert("Register success!");
                ns.dlg.close()
            }, function (err) {
                ns.dlg.free();
                xui.alert(err)
            }])
        },
        _dlg_beforeclose: function (profile) {
            this.dlg.hide();
            return false
        },
        _ctl_sbutton9_onclick: function (profile, e, src, value) {
            this.dlg.close()
        },
        _ctl_sbutton8_onclick: function (profile, e, src, value) {
            CONF.openURL("http://www.crossui.com/order.html")
        }
    }
});
Class("RAD.MobileInstruction", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog).setHost(host, "dlg").setLeft(130).setTop(80).setWidth(710).setHeight(450).setResizer(false).setOverflow("hidden").setCaption("Mobile Deploy Instruction").setMinBtn(false).setMaxBtn(false).beforeClose("_dlg_beforeclose"));
            host.dlg.append((new xui.UI.SButton).setHost(host, "ctl_sbutton5").setLeft(280).setTop(386).setWidth(130).setCaption("O K").onClick("_ctl_sbutton5_onclick"));
            host.dlg.append((new xui.UI.Div).setHost(host, "ctl_div11").setLeft(13).setTop(5).setWidth(671).setHeight(368).onRender("_ondivr").setCustomStyle({
                KEY: "background-color:#FFFFF0;border:solid 1px #ababab;overflow:auto;"
            }));
            return children
        },
        _ctl_sbutton5_onclick: function (profile, e, src, value) {
            this.dlg.close()
        },
        _dlg_beforeclose: function (profile) {
            this.dlg.hide();
            return false
        },
        _ondivr: function (profile) {
            profile.boxing().setHtml('<font face="Arial"><br>&nbsp; <font size="2">Instruction for Mobile Application Deploy:<br></font></font><ol><li><font face="Arial" size="2"><b>Create </b>"Web deploy package"(zip file) from the CrossUI RAD Tools;<br><img src="' + xui.getPath("img/", "BuildWeb.png") + '"></font></li><li><font face="Arial" size="2"><b>Upload </b>the zip file to <a target="_blank" href="https://build.phonegap.com/">PhoneGap</a>;</font></li><li><font face="Arial" size="2"><b>Build </b>it in PhoneGap;<br><img src="' + xui.getPath("img/", "PhoneGap.png") + '"></font></li><li><font face="Arial" size="2"><b>Download </b>output files from PhoneGap\'s "Public Page"(like <a target="_blank" href="https://build.phonegap.com/apps/359497/share">this</a>)</font></li></ol>')
        }
    }
});
Class("RAD.SwitchWorkspace", "xui.Com", {
    Instance: {
        customAppend: function () {
            var self = this,
                dlg = self.dialog;
            dlg.show(self.parent, true)
        },
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog()).setHost(host, "dialog").setLeft(50).setTop(30).setWidth(460).setHeight(230).setOverflow("visible").setCaption("Move/Switch Workspace").setMinBtn(false).setMaxBtn(false).onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));
            host.dialog.append((new xui.UI.Pane()).setHost(host, "ctl_pane68").setDock("bottom").setHeight(40).setOverflow("visible"));
            host.ctl_pane68.append((new xui.UI.Button()).setHost(host, "btnCancel").setTop(12).setWidth(90).setRight(120).setZIndex("1").setCaption("$RAD.cancel").setImage("@CONF.img_app").setImagePos("-16px -16px").onClick("_btncancel_onclick"));
            host.ctl_pane68.append((new xui.UI.Button()).setHost(host, "btnOK").setTop(12).setWidth(90).setRight(20).setZIndex("1").setCaption("$RAD.ok").setImage("@CONF.img_app").setImagePos("-64px -16px").onClick("_btnok_onclick"));
            host.dialog.append((new xui.UI.SLabel()).setHost(host, "ctl_slabel1").setLeft(10).setTop(8).setCaption("CrossUI stores your projects in a  folder, called XUIWorkspace. Choose a folder to move/switch your XUIWorkspace to.").setHAlign("left"));
            host.dialog.append((new xui.UI.Group()).setHost(host, "ctl_group1").setLeft(10).setTop(40).setWidth(430).setHeight(120).setOverflow("hidden").setCaption("Select target folder").setToggleBtn(false));
            host.ctl_group1.append((new xui.UI.ComboInput()).setHost(host, "ctl_comboinput14").setDirtyMark(false).setLeft(100).setTop(70).setWidth(320).setType("popbox").setCachePopWnd(false).setInputReadonly(true).beforeComboPop("_beforepopshow"));
            host.ctl_group1.append((new xui.UI.RadioBox()).setHost(host, "ctl_radiobox4").setDirtyMark(false).setItems([{
                id: "move",
                caption: "Move"
            }, {
                id: "switch",
                caption: "Switch"
            }]).setLeft(6).setTop(1).setWidth(414).setHeight(30).afterUIValueSet("_ctl_radiobox4_afteruivalueset"));
            host.ctl_group1.append((new xui.UI.SLabel()).setHost(host, "ctl_tips").setLeft(20).setTop(31).setWidth(394).setHeight(35).setCaption("").setHAlign("left").setCustomStyle({
                KEY: {
                    color: "#544444",
                    "text-decoration": "underline",
                    "$gradients": ""
                }
            }));
            host.ctl_group1.append((new xui.UI.SLabel()).setHost(host, "ctl_slabel8").setLeft(3).setTop(74).setWidth(94).setHeight(16).setCaption("Target Folder").setHAlign("left"));
            return children
        },
        init: function () {
            this.ctl_radiobox4.setUIValue("switch", true);
            this.ctl_comboinput14.setUIValue(CONF.prjPath, true)
        },
        _beforepopshow: function (profile, popCtl) {
            var ctrl = profile.boxing();
            NW.popSaveAsDlg("", "", function (v) {
                v = v.replace(/\\/g, "/");
                ctrl.setValue(v, true)
            }, true);
            return false
        },
        _btncancel_onclick: function () {
            this.dialog.close()
        },
        _btnok_onclick: function () {
            var ns = this,
                path = ns.ctl_comboinput14.getUIValue(),
                b = ns.ctl_radiobox4.getUIValue();
            if (path == CONF.prjPath) {
                return
            }
            NW.moveWorksapceTo(path, b, function () {
                ns.dialog.close();
                linb.alert("Your XUIWorkSpace has been " + (b ? "moved" : "switched") + " to '" + path + "' successfully!")
            }, function (error) {
                linb.alert(_.get(error, ["error", "message"]) || error || "no response!")
            })
        },
        _dialog_beforeclose: function (profile) {
            this.dialog.hide();
            return false
        },
        _dialog_onhotkey: function (profile, key) {
            if (key.key == "esc") {
                profile.boxing().close()
            }
        },
        _ctl_radiobox4_afteruivalueset: function (profile, oldValue, newValue) {
            if (newValue == "move") {
                this.ctl_tips.setCaption("Switch XUI Workspace to following target folder, move all project files into it, and remove the old XUI Workspace folder.")
            } else {
                this.ctl_tips.setCaption("Switch XUI Workspace to following target folder only, don't move any project files, don't remove the old XUI Workspace")
            }
        }
    }
});
Class("RAD.SelRenderMode", "xui.Com", {
    Instance: {
        iniComponents: function () {
            var host = this,
                children = [],
                append = function (child) {
                    children.push(child.get(0))
                };
            append((new xui.UI.Dialog()).setHost(host, "mainDlg").setLeft(210).setTop(10).setHeight(290).setResizer(false).setOverflow("hidden").setCaption("$RAD.pageEditor.modeDlgCap").setMinBtn(false).setMaxBtn(false).setCloseBtn(false));
            host.mainDlg.append((new xui.UI.List()).setHost(host, "modeList").setDirtyMark(false).setLeft(3).setTop(5).setWidth(285).setHeight(220).setBorderType("inset").setValue("a"));
            host.mainDlg.append((new xui.UI.SButton()).setHost(host, "ctl_sbutton5").setLeft(170).setTop(232).setWidth(70).setCaption("$RAD.ok").onClick("_ctl_sbutton5_onclick"));
            host.mainDlg.append((new xui.UI.SButton()).setHost(host, "ctl_sbutton26").setLeft(50).setTop(232).setWidth(70).setCaption("$RAD.cancel").onClick("_ctl_sbutton26_onclick"));
            return children
        },
        events: {
            onReady: "_com_onready"
        },
        _com_onready: function (com, threadid) {
            var arr = [{
                id: "none"
            }];
            _.arr.each(CodeMirror.modeInfo, function (o, i) {
                arr.push({
                    id: o.mode,
                    caption: o.name
                })
            });
            this.modeList.setItems(arr).setValue("none", true)
        },
        _ctl_sbutton26_onclick: function (profile, e, src, value) {
            var ns = this;
            ns.fireEvent("onSel", [null]);
            ns.mainDlg.close()
        },
        _ctl_sbutton5_onclick: function (profile, e, src, value) {
            var ns = this;
            ns.fireEvent("onSel", [ns.modeList.getUIValue()]);
            ns.mainDlg.close()
        }
    }
});
window.CodeMirror = (function () {
    var gecko = /gecko\/\d/i.test(navigator.userAgent);
    var ie = /MSIE \d/.test(navigator.userAgent);
    var ie_lt8 = ie && (document.documentMode == null || document.documentMode < 8);
    var ie_lt9 = ie && (document.documentMode == null || document.documentMode < 9);
    var webkit = /WebKit\//.test(navigator.userAgent);
    var qtwebkit = webkit && /Qt\/\d+\.\d+/.test(navigator.userAgent);
    var chrome = /Chrome\//.test(navigator.userAgent);
    var opera = /Opera\//.test(navigator.userAgent);
    var safari = /Apple Computer/.test(navigator.vendor);
    var khtml = /KHTML\//.test(navigator.userAgent);
    var mac_geLion = /Mac OS X 1\d\D([7-9]|\d\d)\D/.test(navigator.userAgent);
    var mac_geMountainLion = /Mac OS X 1\d\D([8-9]|\d\d)\D/.test(navigator.userAgent);
    var phantom = /PhantomJS/.test(navigator.userAgent);
    var ios = /AppleWebKit/.test(navigator.userAgent) && /Mobile\/\w+/.test(navigator.userAgent);
    var mobile = ios || /Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent);
    var mac = ios || /Mac/.test(navigator.platform);
    var windows = /win/i.test(navigator.platform);
    var opera_version = opera && navigator.userAgent.match(/Version\/(\d*\.\d*)/);
    if (opera_version) {
        opera_version = Number(opera_version[1])
    }
    if (opera_version && opera_version >= 15) {
        opera = false;
        webkit = true
    }
    var flipCtrlCmd = mac && (qtwebkit || opera && (opera_version == null || opera_version < 12.11));
    var captureMiddleClick = gecko || (ie && !ie_lt9);
    var sawReadOnlySpans = false,
        sawCollapsedSpans = false;

    function CodeMirror(place, options) {
        if (!(this instanceof CodeMirror)) {
            return new CodeMirror(place, options)
        }
        this.options = options = options || {};
        for (var opt in defaults) {
            if (!options.hasOwnProperty(opt) && defaults.hasOwnProperty(opt)) {
                options[opt] = defaults[opt]
            }
        }
        setGuttersForLineNumbers(options);
        var docStart = typeof options.value == "string" ? 0 : options.value.first;
        var display = this.display = makeDisplay(place, docStart);
        display.wrapper.CodeMirror = this;
        updateGutters(this);
        if (options.autofocus && !mobile) {
            focusInput(this)
        }
        this.state = {
            keyMaps: [],
            overlays: [],
            modeGen: 0,
            overwrite: false,
            focused: false,
            suppressEdits: false,
            pasteIncoming: false,
            draggingText: false,
            highlight: new Delayed()
        };
        themeChanged(this);
        if (options.lineWrapping) {
            this.display.wrapper.className += " CodeMirror-wrap"
        }
        var doc = options.value;
        if (typeof doc == "string") {
            doc = new Doc(options.value, options.mode)
        }
        operation(this, attachDoc)(this, doc);
        if (ie) {
            setTimeout(bind(resetInput, this, true), 20)
        }
        registerEventHandlers(this);
        var hasFocus;
        try {
            hasFocus = (document.activeElement == display.input)
        } catch (e) {}
        if (hasFocus || (options.autofocus && !mobile)) {
            setTimeout(bind(onFocus, this), 20)
        } else {
            onBlur(this)
        }
        operation(this, function () {
            for (var opt in optionHandlers) {
                if (optionHandlers.propertyIsEnumerable(opt)) {
                    optionHandlers[opt](this, options[opt], Init)
                }
            }
            for (var i = 0; i < initHooks.length; ++i) {
                initHooks[i](this)
            }
        })()
    }
    function makeDisplay(place, docStart) {
        var d = {};
        var input = d.input = elt("textarea", null, null, "position: absolute; padding: 0; width: 1px; height: 1em; outline: none; font-size: 4px;");
        if (webkit) {
            input.style.width = "1000px"
        } else {
            input.setAttribute("wrap", "off")
        }
        if (ios) {
            input.style.border = "1px solid black"
        }
        input.setAttribute("autocorrect", "off");
        input.setAttribute("autocapitalize", "off");
        input.setAttribute("spellcheck", "false");
        d.inputDiv = elt("div", [input], null, "overflow: hidden; position: relative; width: 3px; height: 0px;");
        d.scrollbarH = elt("div", [elt("div", null, null, "height: 1px")], "CodeMirror-hscrollbar");
        d.scrollbarV = elt("div", [elt("div", null, null, "width: 1px")], "CodeMirror-vscrollbar");
        d.scrollbarFiller = elt("div", null, "CodeMirror-scrollbar-filler");
        d.gutterFiller = elt("div", null, "CodeMirror-gutter-filler");
        d.lineDiv = elt("div", null, "CodeMirror-code");
        d.selectionDiv = elt("div", null, null, "position: relative; z-index: 1");
        d.cursor = elt("div", "\u00a0", "CodeMirror-cursor");
        d.otherCursor = elt("div", "\u00a0", "CodeMirror-cursor CodeMirror-secondarycursor");
        d.measure = elt("div", null, "CodeMirror-measure");
        d.lineSpace = elt("div", [d.measure, d.selectionDiv, d.lineDiv, d.cursor, d.otherCursor], null, "position: relative; outline: none");
        d.mover = elt("div", [elt("div", [d.lineSpace], "CodeMirror-lines")], null, "position: relative");
        d.sizer = elt("div", [d.mover], "CodeMirror-sizer");
        d.heightForcer = elt("div", null, null, "position: absolute; height: " + scrollerCutOff + "px; width: 1px;");
        d.gutters = elt("div", null, "CodeMirror-gutters");
        d.lineGutter = null;
        d.scroller = elt("div", [d.sizer, d.heightForcer, d.gutters], "CodeMirror-scroll");
        d.scroller.setAttribute("tabIndex", "-1");
        d.wrapper = elt("div", [d.inputDiv, d.scrollbarH, d.scrollbarV, d.scrollbarFiller, d.gutterFiller, d.scroller], "CodeMirror");
        if (ie_lt8) {
            d.gutters.style.zIndex = -1;
            d.scroller.style.paddingRight = 0
        }
        if (place.appendChild) {
            place.appendChild(d.wrapper)
        } else {
            place(d.wrapper)
        }
        if (ios) {
            input.style.width = "0px"
        }
        if (!webkit) {
            d.scroller.draggable = true
        }
        if (khtml) {
            d.inputDiv.style.height = "1px";
            d.inputDiv.style.position = "absolute"
        } else {
            if (ie_lt8) {
                d.scrollbarH.style.minWidth = d.scrollbarV.style.minWidth = "18px"
            }
        }
        d.viewOffset = d.lastSizeC = 0;
        d.showingFrom = d.showingTo = docStart;
        d.lineNumWidth = d.lineNumInnerWidth = d.lineNumChars = null;
        d.prevInput = "";
        d.alignWidgets = false;
        d.pollingFast = false;
        d.poll = new Delayed();
        d.cachedCharWidth = d.cachedTextHeight = null;
        d.measureLineCache = [];
        d.measureLineCachePos = 0;
        d.inaccurateSelection = false;
        d.maxLine = null;
        d.maxLineLength = 0;
        d.maxLineChanged = false;
        d.wheelDX = d.wheelDY = d.wheelStartX = d.wheelStartY = null;
        return d
    }
    function loadMode(cm) {
        cm.doc.mode = CodeMirror.getMode(cm.options, cm.doc.modeOption);
        cm.doc.iter(function (line) {
            if (line.stateAfter) {
                line.stateAfter = null
            }
            if (line.styles) {
                line.styles = null
            }
        });
        cm.doc.frontier = cm.doc.first;
        startWorker(cm, 100);
        cm.state.modeGen++;
        if (cm.curOp) {
            regChange(cm)
        }
    }
    function wrappingChanged(cm) {
        if (cm.options.lineWrapping) {
            cm.display.wrapper.className += " CodeMirror-wrap";
            cm.display.sizer.style.minWidth = ""
        } else {
            cm.display.wrapper.className = cm.display.wrapper.className.replace(" CodeMirror-wrap", "");
            computeMaxLength(cm)
        }
        estimateLineHeights(cm);
        regChange(cm);
        clearCaches(cm);
        setTimeout(function () {
            updateScrollbars(cm)
        }, 100)
    }
    function estimateHeight(cm) {
        var th = textHeight(cm.display),
            wrapping = cm.options.lineWrapping;
        var perLine = wrapping && Math.max(5, cm.display.scroller.clientWidth / charWidth(cm.display) - 3);
        return function (line) {
            if (lineIsHidden(cm.doc, line)) {
                return 0
            } else {
                if (wrapping) {
                    return (Math.ceil(line.text.length / perLine) || 1) * th
                } else {
                    return th
                }
            }
        }
    }
    function estimateLineHeights(cm) {
        var doc = cm.doc,
            est = estimateHeight(cm);
        doc.iter(function (line) {
            var estHeight = est(line);
            if (estHeight != line.height) {
                updateLineHeight(line, estHeight)
            }
        })
    }
    function keyMapChanged(cm) {
        var map = keyMap[cm.options.keyMap],
            style = map.style;
        cm.display.wrapper.className = cm.display.wrapper.className.replace(/\s*cm-keymap-\S+/g, "") + (style ? " cm-keymap-" + style : "");
        cm.state.disableInput = map.disableInput
    }
    function themeChanged(cm) {
        cm.display.wrapper.className = cm.display.wrapper.className.replace(/\s*cm-s-\S+/g, "") + cm.options.theme.replace(/(^|\s)\s*/g, " cm-s-");
        clearCaches(cm)
    }
    function guttersChanged(cm) {
        updateGutters(cm);
        regChange(cm);
        setTimeout(function () {
            alignHorizontally(cm)
        }, 20)
    }
    function updateGutters(cm) {
        var gutters = cm.display.gutters,
            specs = cm.options.gutters;
        removeChildren(gutters);
        for (var i = 0; i < specs.length; ++i) {
            var gutterClass = specs[i];
            var gElt = gutters.appendChild(elt("div", null, "CodeMirror-gutter " + gutterClass));
            if (gutterClass == "CodeMirror-linenumbers") {
                cm.display.lineGutter = gElt;
                gElt.style.width = (cm.display.lineNumWidth || 1) + "px"
            }
        }
        gutters.style.display = i ? "" : "none"
    }
    function lineLength(doc, line) {
        if (line.height == 0) {
            return 0
        }
        var len = line.text.length,
            merged, cur = line;
        while (merged = collapsedSpanAtStart(cur)) {
            var found = merged.find();
            cur = getLine(doc, found.from.line);
            len += found.from.ch - found.to.ch
        }
        cur = line;
        while (merged = collapsedSpanAtEnd(cur)) {
            var found = merged.find();
            len -= cur.text.length - found.from.ch;
            cur = getLine(doc, found.to.line);
            len += cur.text.length - found.to.ch
        }
        return len
    }
    function computeMaxLength(cm) {
        var d = cm.display,
            doc = cm.doc;
        d.maxLine = getLine(doc, doc.first);
        d.maxLineLength = lineLength(doc, d.maxLine);
        d.maxLineChanged = true;
        doc.iter(function (line) {
            var len = lineLength(doc, line);
            if (len > d.maxLineLength) {
                d.maxLineLength = len;
                d.maxLine = line
            }
        })
    }
    function setGuttersForLineNumbers(options) {
        var found = indexOf(options.gutters, "CodeMirror-linenumbers");
        if (found == -1 && options.lineNumbers) {
            options.gutters = options.gutters.concat(["CodeMirror-linenumbers"])
        } else {
            if (found > -1 && !options.lineNumbers) {
                options.gutters = options.gutters.slice(0);
                options.gutters.splice(found, 1)
            }
        }
    }
    function updateScrollbars(cm) {
        var d = cm.display,
            docHeight = cm.doc.height;
        var totalHeight = docHeight + paddingVert(d);
        d.sizer.style.minHeight = d.heightForcer.style.top = totalHeight + "px";
        d.gutters.style.height = Math.max(totalHeight, d.scroller.clientHeight - scrollerCutOff) + "px";
        var scrollHeight = Math.max(totalHeight, d.scroller.scrollHeight);
        var needsH = d.scroller.scrollWidth > (d.scroller.clientWidth + 1);
        var needsV = scrollHeight > (d.scroller.clientHeight + 1);
        if (needsV) {
            d.scrollbarV.style.display = "block";
            d.scrollbarV.style.bottom = needsH ? scrollbarWidth(d.measure) + "px" : "0";
            d.scrollbarV.firstChild.style.height = (scrollHeight - d.scroller.clientHeight + d.scrollbarV.clientHeight) + "px"
        } else {
            d.scrollbarV.style.display = "";
            d.scrollbarV.firstChild.style.height = "0"
        }
        if (needsH) {
            d.scrollbarH.style.display = "block";
            d.scrollbarH.style.right = needsV ? scrollbarWidth(d.measure) + "px" : "0";
            d.scrollbarH.firstChild.style.width = (d.scroller.scrollWidth - d.scroller.clientWidth + d.scrollbarH.clientWidth) + "px"
        } else {
            d.scrollbarH.style.display = "";
            d.scrollbarH.firstChild.style.width = "0"
        }
        if (needsH && needsV) {
            d.scrollbarFiller.style.display = "block";
            d.scrollbarFiller.style.height = d.scrollbarFiller.style.width = scrollbarWidth(d.measure) + "px"
        } else {
            d.scrollbarFiller.style.display = ""
        }
        if (needsH && cm.options.coverGutterNextToScrollbar && cm.options.fixedGutter) {
            d.gutterFiller.style.display = "block";
            d.gutterFiller.style.height = scrollbarWidth(d.measure) + "px";
            d.gutterFiller.style.width = d.gutters.offsetWidth + "px"
        } else {
            d.gutterFiller.style.display = ""
        }
        if (mac_geLion && scrollbarWidth(d.measure) === 0) {
            d.scrollbarV.style.minWidth = d.scrollbarH.style.minHeight = mac_geMountainLion ? "18px" : "12px"
        }
    }
    function visibleLines(display, doc, viewPort) {
        var top = display.scroller.scrollTop,
            height = display.wrapper.clientHeight;
        if (typeof viewPort == "number") {
            top = viewPort
        } else {
            if (viewPort) {
                top = viewPort.top;
                height = viewPort.bottom - viewPort.top
            }
        }
        top = Math.floor(top - paddingTop(display));
        var bottom = Math.ceil(top + height);
        return {
            from: lineAtHeight(doc, top),
            to: lineAtHeight(doc, bottom)
        }
    }
    function alignHorizontally(cm) {
        var display = cm.display;
        if (!display.alignWidgets && (!display.gutters.firstChild || !cm.options.fixedGutter)) {
            return
        }
        var comp = compensateForHScroll(display) - display.scroller.scrollLeft + cm.doc.scrollLeft;
        var gutterW = display.gutters.offsetWidth,
            l = comp + "px";
        for (var n = display.lineDiv.firstChild; n; n = n.nextSibling) {
            if (n.alignable) {
                for (var i = 0, a = n.alignable; i < a.length; ++i) {
                    a[i].style.left = l
                }
            }
        }
        if (cm.options.fixedGutter) {
            display.gutters.style.left = (comp + gutterW) + "px"
        }
    }
    function maybeUpdateLineNumberWidth(cm) {
        if (!cm.options.lineNumbers) {
            return false
        }
        var doc = cm.doc,
            last = lineNumberFor(cm.options, doc.first + doc.size - 1),
            display = cm.display;
        if (last.length != display.lineNumChars) {
            var test = display.measure.appendChild(elt("div", [elt("div", last)], "CodeMirror-linenumber CodeMirror-gutter-elt"));
            var innerW = test.firstChild.offsetWidth,
                padding = test.offsetWidth - innerW;
            display.lineGutter.style.width = "";
            display.lineNumInnerWidth = Math.max(innerW, display.lineGutter.offsetWidth - padding);
            display.lineNumWidth = display.lineNumInnerWidth + padding;
            display.lineNumChars = display.lineNumInnerWidth ? last.length : -1;
            display.lineGutter.style.width = display.lineNumWidth + "px";
            return true
        }
        return false
    }
    function lineNumberFor(options, i) {
        return String(options.lineNumberFormatter(i + options.firstLineNumber))
    }
    function compensateForHScroll(display) {
        return getRect(display.scroller).left - getRect(display.sizer).left
    }
    function updateDisplay(cm, changes, viewPort, forced) {
        var oldFrom = cm.display.showingFrom,
            oldTo = cm.display.showingTo,
            updated;
        var visible = visibleLines(cm.display, cm.doc, viewPort);
        for (var first = true;; first = false) {
            var oldWidth = cm.display.scroller.clientWidth;
            if (!updateDisplayInner(cm, changes, visible, forced)) {
                break
            }
            updated = true;
            changes = [];
            updateSelection(cm);
            updateScrollbars(cm);
            if (first && cm.options.lineWrapping && oldWidth != cm.display.scroller.clientWidth) {
                forced = true;
                continue
            }
            forced = false;
            if (viewPort) {
                viewPort = Math.min(cm.display.scroller.scrollHeight - cm.display.scroller.clientHeight, typeof viewPort == "number" ? viewPort : viewPort.top)
            }
            visible = visibleLines(cm.display, cm.doc, viewPort);
            if (visible.from >= cm.display.showingFrom && visible.to <= cm.display.showingTo) {
                break
            }
        }
        if (updated) {
            signalLater(cm, "update", cm);
            if (cm.display.showingFrom != oldFrom || cm.display.showingTo != oldTo) {
                signalLater(cm, "viewportChange", cm, cm.display.showingFrom, cm.display.showingTo)
            }
        }
        return updated
    }
    function updateDisplayInner(cm, changes, visible, forced) {
        var display = cm.display,
            doc = cm.doc;
        if (!display.wrapper.clientWidth) {
            display.showingFrom = display.showingTo = doc.first;
            display.viewOffset = 0;
            return
        }
        if (!forced && changes.length == 0 && visible.from > display.showingFrom && visible.to < display.showingTo) {
            return
        }
        if (maybeUpdateLineNumberWidth(cm)) {
            changes = [{
                from: doc.first,
                to: doc.first + doc.size
            }]
        }
        var gutterW = display.sizer.style.marginLeft = display.gutters.offsetWidth + "px";
        display.scrollbarH.style.left = cm.options.fixedGutter ? gutterW : "0";
        var positionsChangedFrom = Infinity;
        if (cm.options.lineNumbers) {
            for (var i = 0; i < changes.length; ++i) {
                if (changes[i].diff && changes[i].from < positionsChangedFrom) {
                    positionsChangedFrom = changes[i].from
                }
            }
        }
        var end = doc.first + doc.size;
        var from = Math.max(visible.from - cm.options.viewportMargin, doc.first);
        var to = Math.min(end, visible.to + cm.options.viewportMargin);
        if (display.showingFrom < from && from - display.showingFrom < 20) {
            from = Math.max(doc.first, display.showingFrom)
        }
        if (display.showingTo > to && display.showingTo - to < 20) {
            to = Math.min(end, display.showingTo)
        }
        if (sawCollapsedSpans) {
            from = lineNo(visualLine(doc, getLine(doc, from)));
            while (to < end && lineIsHidden(doc, getLine(doc, to))) {
                ++to
            }
        }
        var intact = [{
            from: Math.max(display.showingFrom, doc.first),
            to: Math.min(display.showingTo, end)
        }];
        if (intact[0].from >= intact[0].to) {
            intact = []
        } else {
            intact = computeIntact(intact, changes)
        }
        if (sawCollapsedSpans) {
            for (var i = 0; i < intact.length; ++i) {
                var range = intact[i],
                    merged;
                while (merged = collapsedSpanAtEnd(getLine(doc, range.to - 1))) {
                    var newTo = merged.find().from.line;
                    if (newTo > range.from) {
                        range.to = newTo
                    } else {
                        intact.splice(i--, 1);
                        break
                    }
                }
            }
        }
        var intactLines = 0;
        for (var i = 0; i < intact.length; ++i) {
            var range = intact[i];
            if (range.from < from) {
                range.from = from
            }
            if (range.to > to) {
                range.to = to
            }
            if (range.from >= range.to) {
                intact.splice(i--, 1)
            } else {
                intactLines += range.to - range.from
            }
        }
        if (!forced && intactLines == to - from && from == display.showingFrom && to == display.showingTo) {
            updateViewOffset(cm);
            return
        }
        intact.sort(function (a, b) {
            return a.from - b.from
        });
        try {
            var focused = document.activeElement
        } catch (e) {}
        if (intactLines < (to - from) * 0.7) {
            display.lineDiv.style.display = "none"
        }
        patchDisplay(cm, from, to, intact, positionsChangedFrom);
        display.lineDiv.style.display = "";
        if (focused && document.activeElement != focused && focused.offsetHeight) {
            focused.focus()
        }
        var different = from != display.showingFrom || to != display.showingTo || display.lastSizeC != display.wrapper.clientHeight;
        if (different) {
            display.lastSizeC = display.wrapper.clientHeight;
            startWorker(cm, 400)
        }
        display.showingFrom = from;
        display.showingTo = to;
        updateHeightsInViewport(cm);
        updateViewOffset(cm);
        return true
    }
    function updateHeightsInViewport(cm) {
        var display = cm.display;
        var prevBottom = display.lineDiv.offsetTop;
        for (var node = display.lineDiv.firstChild, height; node; node = node.nextSibling) {
            if (node.lineObj) {
                if (ie_lt8) {
                    var bot = node.offsetTop + node.offsetHeight;
                    height = bot - prevBottom;
                    prevBottom = bot
                } else {
                    var box = getRect(node);
                    height = box.bottom - box.top
                }
                var diff = node.lineObj.height - height;
                if (height < 2) {
                    height = textHeight(display)
                }
                if (diff > 0.001 || diff < -0.001) {
                    updateLineHeight(node.lineObj, height);
                    var widgets = node.lineObj.widgets;
                    if (widgets) {
                        for (var i = 0; i < widgets.length; ++i) {
                            widgets[i].height = widgets[i].node.offsetHeight
                        }
                    }
                }
            }
        }
    }
    function updateViewOffset(cm) {
        var off = cm.display.viewOffset = heightAtLine(cm, getLine(cm.doc, cm.display.showingFrom));
        cm.display.mover.style.top = off + "px"
    }
    function computeIntact(intact, changes) {
        for (var i = 0, l = changes.length || 0; i < l; ++i) {
            var change = changes[i],
                intact2 = [],
                diff = change.diff || 0;
            for (var j = 0, l2 = intact.length; j < l2; ++j) {
                var range = intact[j];
                if (change.to <= range.from && change.diff) {
                    intact2.push({
                        from: range.from + diff,
                        to: range.to + diff
                    })
                } else {
                    if (change.to <= range.from || change.from >= range.to) {
                        intact2.push(range)
                    } else {
                        if (change.from > range.from) {
                            intact2.push({
                                from: range.from,
                                to: change.from
                            })
                        }
                        if (change.to < range.to) {
                            intact2.push({
                                from: change.to + diff,
                                to: range.to + diff
                            })
                        }
                    }
                }
            }
            intact = intact2
        }
        return intact
    }
    function getDimensions(cm) {
        var d = cm.display,
            left = {},
            width = {};
        for (var n = d.gutters.firstChild, i = 0; n; n = n.nextSibling, ++i) {
            left[cm.options.gutters[i]] = n.offsetLeft;
            width[cm.options.gutters[i]] = n.offsetWidth
        }
        return {
            fixedPos: compensateForHScroll(d),
            gutterTotalWidth: d.gutters.offsetWidth,
            gutterLeft: left,
            gutterWidth: width,
            wrapperWidth: d.wrapper.clientWidth
        }
    }
    function patchDisplay(cm, from, to, intact, updateNumbersFrom) {
        var dims = getDimensions(cm);
        var display = cm.display,
            lineNumbers = cm.options.lineNumbers;
        if (!intact.length && (!webkit || !cm.display.currentWheelTarget)) {
            removeChildren(display.lineDiv)
        }
        var container = display.lineDiv,
            cur = container.firstChild;

        function rm(node) {
            var next = node.nextSibling;
            if (webkit && mac && cm.display.currentWheelTarget == node) {
                node.style.display = "none";
                node.lineObj = null
            } else {
                node.parentNode.removeChild(node)
            }
            return next
        }
        var nextIntact = intact.shift(),
            lineN = from;
        cm.doc.iter(from, to, function (line) {
            if (nextIntact && nextIntact.to == lineN) {
                nextIntact = intact.shift()
            }
            if (lineIsHidden(cm.doc, line)) {
                if (line.height != 0) {
                    updateLineHeight(line, 0)
                }
                if (line.widgets && cur && cur.previousSibling) {
                    for (var i = 0; i < line.widgets.length; ++i) {
                        var w = line.widgets[i];
                        if (w.showIfHidden) {
                            var prev = cur.previousSibling;
                            if (/pre/i.test(prev.nodeName)) {
                                var wrap = elt("div", null, null, "position: relative");
                                prev.parentNode.replaceChild(wrap, prev);
                                wrap.appendChild(prev);
                                prev = wrap
                            }
                            var wnode = prev.appendChild(elt("div", [w.node], "CodeMirror-linewidget"));
                            if (!w.handleMouseEvents) {
                                wnode.ignoreEvents = true
                            }
                            positionLineWidget(w, wnode, prev, dims)
                        }
                    }
                }
            } else {
                if (nextIntact && nextIntact.from <= lineN && nextIntact.to > lineN) {
                    while (cur.lineObj != line) {
                        cur = rm(cur)
                    }
                    if (lineNumbers && updateNumbersFrom <= lineN && cur.lineNumber) {
                        setTextContent(cur.lineNumber, lineNumberFor(cm.options, lineN))
                    }
                    cur = cur.nextSibling
                } else {
                    if (line.widgets) {
                        for (var j = 0, search = cur, reuse; search && j < 20; ++j, search = search.nextSibling) {
                            if (search.lineObj == line && /div/i.test(search.nodeName)) {
                                reuse = search;
                                break
                            }
                        }
                    }
                    var lineNode = buildLineElement(cm, line, lineN, dims, reuse);
                    if (lineNode != reuse) {
                        container.insertBefore(lineNode, cur)
                    } else {
                        while (cur != reuse) {
                            cur = rm(cur)
                        }
                        cur = cur.nextSibling
                    }
                    lineNode.lineObj = line
                }
            }++lineN
        });
        while (cur) {
            cur = rm(cur)
        }
    }
    function buildLineElement(cm, line, lineNo, dims, reuse) {
        var built = buildLineContent(cm, line),
            lineElement = built.pre;
        var markers = line.gutterMarkers,
            display = cm.display,
            wrap;
        var bgClass = built.bgClass ? built.bgClass + " " + (line.bgClass || "") : line.bgClass;
        if (!cm.options.lineNumbers && !markers && !bgClass && !line.wrapClass && !line.widgets) {
            return lineElement
        }
        if (reuse) {
            reuse.alignable = null;
            var isOk = true,
                widgetsSeen = 0,
                insertBefore = null;
            for (var n = reuse.firstChild, next; n; n = next) {
                next = n.nextSibling;
                if (!/\bCodeMirror-linewidget\b/.test(n.className)) {
                    reuse.removeChild(n)
                } else {
                    for (var i = 0; i < line.widgets.length; ++i) {
                        var widget = line.widgets[i];
                        if (widget.node == n.firstChild) {
                            if (!widget.above && !insertBefore) {
                                insertBefore = n
                            }
                            positionLineWidget(widget, n, reuse, dims);
                            ++widgetsSeen;
                            break
                        }
                    }
                    if (i == line.widgets.length) {
                        isOk = false;
                        break
                    }
                }
            }
            reuse.insertBefore(lineElement, insertBefore);
            if (isOk && widgetsSeen == line.widgets.length) {
                wrap = reuse;
                reuse.className = line.wrapClass || ""
            }
        }
        if (!wrap) {
            wrap = elt("div", null, line.wrapClass, "position: relative");
            wrap.appendChild(lineElement)
        }
        if (bgClass) {
            wrap.insertBefore(elt("div", null, bgClass + " CodeMirror-linebackground"), wrap.firstChild)
        }
        if (cm.options.lineNumbers || markers) {
            var gutterWrap = wrap.insertBefore(elt("div", null, null, "position: absolute; left: " + (cm.options.fixedGutter ? dims.fixedPos : -dims.gutterTotalWidth) + "px"), wrap.firstChild);
            if (cm.options.fixedGutter) {
                (wrap.alignable || (wrap.alignable = [])).push(gutterWrap)
            }
            if (cm.options.lineNumbers && (!markers || !markers["CodeMirror-linenumbers"])) {
                wrap.lineNumber = gutterWrap.appendChild(elt("div", lineNumberFor(cm.options, lineNo), "CodeMirror-linenumber CodeMirror-gutter-elt", "left: " + dims.gutterLeft["CodeMirror-linenumbers"] + "px; width: " + display.lineNumInnerWidth + "px"))
            }
            if (markers) {
                for (var k = 0; k < cm.options.gutters.length; ++k) {
                    var id = cm.options.gutters[k],
                        found = markers.hasOwnProperty(id) && markers[id];
                    if (found) {
                        gutterWrap.appendChild(elt("div", [found], "CodeMirror-gutter-elt", "left: " + dims.gutterLeft[id] + "px; width: " + dims.gutterWidth[id] + "px"))
                    }
                }
            }
        }
        if (ie_lt8) {
            wrap.style.zIndex = 2
        }
        if (line.widgets && wrap != reuse) {
            for (var i = 0, ws = line.widgets; i < ws.length; ++i) {
                var widget = ws[i],
                    node = elt("div", [widget.node], "CodeMirror-linewidget");
                if (!widget.handleMouseEvents) {
                    node.ignoreEvents = true
                }
                positionLineWidget(widget, node, wrap, dims);
                if (widget.above) {
                    wrap.insertBefore(node, cm.options.lineNumbers && line.height != 0 ? gutterWrap : lineElement)
                } else {
                    wrap.appendChild(node)
                }
                signalLater(widget, "redraw")
            }
        }
        return wrap
    }
    function positionLineWidget(widget, node, wrap, dims) {
        if (widget.noHScroll) {
            (wrap.alignable || (wrap.alignable = [])).push(node);
            var width = dims.wrapperWidth;
            node.style.left = dims.fixedPos + "px";
            if (!widget.coverGutter) {
                width -= dims.gutterTotalWidth;
                node.style.paddingLeft = dims.gutterTotalWidth + "px"
            }
            node.style.width = width + "px"
        }
        if (widget.coverGutter) {
            node.style.zIndex = 5;
            node.style.position = "relative";
            if (!widget.noHScroll) {
                node.style.marginLeft = -dims.gutterTotalWidth + "px"
            }
        }
    }
    function updateSelection(cm) {
        var display = cm.display;
        var collapsed = posEq(cm.doc.sel.from, cm.doc.sel.to);
        if (collapsed || cm.options.showCursorWhenSelecting) {
            updateSelectionCursor(cm)
        } else {
            display.cursor.style.display = display.otherCursor.style.display = "none"
        }
        if (!collapsed) {
            updateSelectionRange(cm)
        } else {
            display.selectionDiv.style.display = "none"
        }
        if (cm.options.moveInputWithCursor) {
            var headPos = cursorCoords(cm, cm.doc.sel.head, "div");
            var wrapOff = getRect(display.wrapper),
                lineOff = getRect(display.lineDiv);
            display.inputDiv.style.top = Math.max(0, Math.min(display.wrapper.clientHeight - 10, headPos.top + lineOff.top - wrapOff.top)) + "px";
            display.inputDiv.style.left = Math.max(0, Math.min(display.wrapper.clientWidth - 10, headPos.left + lineOff.left - wrapOff.left)) + "px"
        }
    }
    function updateSelectionCursor(cm) {
        var display = cm.display,
            pos = cursorCoords(cm, cm.doc.sel.head, "div");
        display.cursor.style.left = pos.left + "px";
        display.cursor.style.top = pos.top + "px";
        display.cursor.style.height = Math.max(0, pos.bottom - pos.top) * cm.options.cursorHeight + "px";
        display.cursor.style.display = "";
        if (pos.other) {
            display.otherCursor.style.display = "";
            display.otherCursor.style.left = pos.other.left + "px";
            display.otherCursor.style.top = pos.other.top + "px";
            display.otherCursor.style.height = (pos.other.bottom - pos.other.top) * 0.85 + "px"
        } else {
            display.otherCursor.style.display = "none"
        }
    }
    function updateSelectionRange(cm) {
        var display = cm.display,
            doc = cm.doc,
            sel = cm.doc.sel;
        var fragment = document.createDocumentFragment();
        var clientWidth = display.lineSpace.offsetWidth,
            pl = paddingLeft(cm.display);

        function add(left, top, width, bottom) {
            if (top < 0) {
                top = 0
            }
            fragment.appendChild(elt("div", null, "CodeMirror-selected", "position: absolute; left: " + left + "px; top: " + top + "px; width: " + (width == null ? clientWidth - left : width) + "px; height: " + (bottom - top) + "px"))
        }
        function drawForLine(line, fromArg, toArg) {
            var lineObj = getLine(doc, line);
            var lineLen = lineObj.text.length;
            var start, end;

            function coords(ch, bias) {
                return charCoords(cm, Pos(line, ch), "div", lineObj, bias)
            }
            iterateBidiSections(getOrder(lineObj), fromArg || 0, toArg == null ? lineLen : toArg, function (from, to, dir) {
                var leftPos = coords(from, "left"),
                    rightPos, left, right;
                if (from == to) {
                    rightPos = leftPos;
                    left = right = leftPos.left
                } else {
                    rightPos = coords(to - 1, "right");
                    if (dir == "rtl") {
                        var tmp = leftPos;
                        leftPos = rightPos;
                        rightPos = tmp
                    }
                    left = leftPos.left;
                    right = rightPos.right
                }
                if (fromArg == null && from == 0) {
                    left = pl
                }
                if (rightPos.top - leftPos.top > 3) {
                    add(left, leftPos.top, null, leftPos.bottom);
                    left = pl;
                    if (leftPos.bottom < rightPos.top) {
                        add(left, leftPos.bottom, null, rightPos.top)
                    }
                }
                if (toArg == null && to == lineLen) {
                    right = clientWidth
                }
                if (!start || leftPos.top < start.top || leftPos.top == start.top && leftPos.left < start.left) {
                    start = leftPos
                }
                if (!end || rightPos.bottom > end.bottom || rightPos.bottom == end.bottom && rightPos.right > end.right) {
                    end = rightPos
                }
                if (left < pl + 1) {
                    left = pl
                }
                add(left, rightPos.top, right - left, rightPos.bottom)
            });
            return {
                start: start,
                end: end
            }
        }
        if (sel.from.line == sel.to.line) {
            drawForLine(sel.from.line, sel.from.ch, sel.to.ch)
        } else {
            var fromLine = getLine(doc, sel.from.line),
                toLine = getLine(doc, sel.to.line);
            var singleVLine = visualLine(doc, fromLine) == visualLine(doc, toLine);
            var leftEnd = drawForLine(sel.from.line, sel.from.ch, singleVLine ? fromLine.text.length : null).end;
            var rightStart = drawForLine(sel.to.line, singleVLine ? 0 : null, sel.to.ch).start;
            if (singleVLine) {
                if (leftEnd.top < rightStart.top - 2) {
                    add(leftEnd.right, leftEnd.top, null, leftEnd.bottom);
                    add(pl, rightStart.top, rightStart.left, rightStart.bottom)
                } else {
                    add(leftEnd.right, leftEnd.top, rightStart.left - leftEnd.right, leftEnd.bottom)
                }
            }
            if (leftEnd.bottom < rightStart.top) {
                add(pl, leftEnd.bottom, null, rightStart.top)
            }
        }
        removeChildrenAndAdd(display.selectionDiv, fragment);
        display.selectionDiv.style.display = ""
    }
    function restartBlink(cm) {
        if (!cm.state.focused) {
            return
        }
        var display = cm.display;
        clearInterval(display.blinker);
        var on = true;
        display.cursor.style.visibility = display.otherCursor.style.visibility = "";
        if (cm.options.cursorBlinkRate > 0) {
            display.blinker = setInterval(function () {
                display.cursor.style.visibility = display.otherCursor.style.visibility = (on = !on) ? "" : "hidden"
            }, cm.options.cursorBlinkRate)
        }
    }
    function startWorker(cm, time) {
        if (cm.doc.mode.startState && cm.doc.frontier < cm.display.showingTo) {
            cm.state.highlight.set(time, bind(highlightWorker, cm))
        }
    }
    function highlightWorker(cm) {
        var doc = cm.doc;
        if (doc.frontier < doc.first) {
            doc.frontier = doc.first
        }
        if (doc.frontier >= cm.display.showingTo) {
            signal(cm, "rendered", cm, true);
            return
        }
        var end = +new Date + cm.options.workTime;
        var state = copyState(doc.mode, getStateBefore(cm, doc.frontier));
        var changed = [],
            prevChange;
        var done = true;
        doc.iter(doc.frontier, Math.min(doc.first + doc.size, cm.display.showingTo + 500), function (line) {
            if (doc.frontier >= cm.display.showingFrom) {
                var oldStyles = line.styles;
                line.styles = highlightLine(cm, line, state);
                var ischange = !oldStyles || oldStyles.length != line.styles.length;
                for (var i = 0; !ischange && i < oldStyles.length; ++i) {
                    ischange = oldStyles[i] != line.styles[i]
                }
                if (ischange) {
                    if (prevChange && prevChange.end == doc.frontier) {
                        prevChange.end++
                    } else {
                        changed.push(prevChange = {
                            start: doc.frontier,
                            end: doc.frontier + 1
                        })
                    }
                }
                line.stateAfter = copyState(doc.mode, state)
            } else {
                processLine(cm, line, state);
                line.stateAfter = doc.frontier % 5 == 0 ? copyState(doc.mode, state) : null
            }++doc.frontier;
            if (+new Date > end) {
                if (cm.doc.mode.startState && cm.doc.frontier < cm.display.showingTo) {
                    done = false;
                    startWorker(cm, cm.options.workDelay)
                }
                return true
            }
        });
        if (changed.length) {
            operation(cm, function () {
                for (var i = 0; i < changed.length; ++i) {
                    regChange(this, changed[i].start, changed[i].end)
                }
            })();
            signal(cm, "rendered", cm, done)
        } else {
            signal(cm, "rendered", cm, true)
        }
    }
    function findStartLine(cm, n, precise) {
        var minindent, minline, doc = cm.doc,
            maxScan = cm.doc.mode.innerMode ? 1000 : 100;
        for (var search = n, lim = n - maxScan; search > lim; --search) {
            if (search <= doc.first) {
                return doc.first
            }
            var line = getLine(doc, search - 1);
            if (line.stateAfter && (!precise || search <= doc.frontier)) {
                return search
            }
            var indented = countColumn(line.text, null, cm.options.tabSize);
            if (minline == null || minindent > indented) {
                minline = search - 1;
                minindent = indented
            }
        }
        return minline
    }
    function getStateBefore(cm, n, precise) {
        var doc = cm.doc,
            display = cm.display;
        if (!doc.mode.startState) {
            return true
        }
        var pos = findStartLine(cm, n, precise),
            state = pos > doc.first && getLine(doc, pos - 1).stateAfter;
        if (!state) {
            state = startState(doc.mode)
        } else {
            state = copyState(doc.mode, state)
        }
        doc.iter(pos, n, function (line) {
            processLine(cm, line, state);
            var save = pos == n - 1 || pos % 5 == 0 || pos >= display.showingFrom && pos < display.showingTo;
            line.stateAfter = save ? copyState(doc.mode, state) : null;
            ++pos
        });
        return state
    }
    function paddingTop(display) {
        return display.lineSpace.offsetTop
    }
    function paddingVert(display) {
        return display.mover.offsetHeight - display.lineSpace.offsetHeight
    }
    function paddingLeft(display) {
        var e = removeChildrenAndAdd(display.measure, elt("pre", null, null, "text-align: left")).appendChild(elt("span", "x"));
        return e.offsetLeft
    }
    function measureChar(cm, line, ch, data, bias) {
        var dir = -1;
        data = data || measureLine(cm, line);
        if (data.crude) {
            var left = data.left + ch * data.width;
            return {
                left: left,
                right: left + data.width,
                top: data.top,
                bottom: data.bottom
            }
        }
        for (var pos = ch;; pos += dir) {
            var r = data[pos];
            if (r) {
                break
            }
            if (dir < 0 && pos == 0) {
                dir = 1
            }
        }
        bias = pos > ch ? "left" : pos < ch ? "right" : bias;
        if (bias == "left" && r.leftSide) {
            r = r.leftSide
        } else {
            if (bias == "right" && r.rightSide) {
                r = r.rightSide
            }
        }
        return {
            left: pos < ch ? r.right : r.left,
            right: pos > ch ? r.left : r.right,
            top: r.top,
            bottom: r.bottom
        }
    }
    function findCachedMeasurement(cm, line) {
        var cache = cm.display.measureLineCache;
        for (var i = 0; i < cache.length; ++i) {
            var memo = cache[i];
            if (memo.text == line.text && memo.markedSpans == line.markedSpans && cm.display.scroller.clientWidth == memo.width && memo.classes == line.textClass + "|" + line.wrapClass) {
                return memo
            }
        }
    }
    function clearCachedMeasurement(cm, line) {
        var exists = findCachedMeasurement(cm, line);
        if (exists) {
            exists.text = exists.measure = exists.markedSpans = null
        }
    }
    function measureLine(cm, line) {
        var cached = findCachedMeasurement(cm, line);
        if (cached) {
            return cached.measure
        }
        var measure = measureLineInner(cm, line);
        var cache = cm.display.measureLineCache;
        var memo = {
            text: line.text,
            width: cm.display.scroller.clientWidth,
            markedSpans: line.markedSpans,
            measure: measure,
            classes: line.textClass + "|" + line.wrapClass
        };
        if (cache.length == 16) {
            cache[++cm.display.measureLineCachePos % 16] = memo
        } else {
            cache.push(memo)
        }
        return measure
    }
    function measureLineInner(cm, line) {
        if (!cm.options.lineWrapping && line.text.length >= cm.options.crudeMeasuringFrom) {
            return crudelyMeasureLine(cm, line)
        }
        var display = cm.display,
            measure = emptyArray(line.text.length);
        var pre = buildLineContent(cm, line, measure, true).pre;
        if (ie && !ie_lt8 && !cm.options.lineWrapping && pre.childNodes.length > 100) {
            var fragment = document.createDocumentFragment();
            var chunk = 10,
                n = pre.childNodes.length;
            for (var i = 0, chunks = Math.ceil(n / chunk); i < chunks; ++i) {
                var wrap = elt("div", null, null, "display: inline-block");
                for (var j = 0; j < chunk && n; ++j) {
                    wrap.appendChild(pre.firstChild);
                    --n
                }
                fragment.appendChild(wrap)
            }
            pre.appendChild(fragment)
        }
        removeChildrenAndAdd(display.measure, pre);
        var outer = getRect(display.lineDiv);
        var vranges = [],
            data = emptyArray(line.text.length),
            maxBot = pre.offsetHeight;
        if (ie_lt9 && display.measure.first != pre) {
            removeChildrenAndAdd(display.measure, pre)
        }
        function measureRect(rect) {
            var top = rect.top - outer.top,
                bot = rect.bottom - outer.top;
            if (bot > maxBot) {
                bot = maxBot
            }
            if (top < 0) {
                top = 0
            }
            for (var i = vranges.length - 2; i >= 0; i -= 2) {
                var rtop = vranges[i],
                    rbot = vranges[i + 1];
                if (rtop > bot || rbot < top) {
                    continue
                }
                if (rtop <= top && rbot >= bot || top <= rtop && bot >= rbot || Math.min(bot, rbot) - Math.max(top, rtop) >= (bot - top) >> 1) {
                    vranges[i] = Math.min(top, rtop);
                    vranges[i + 1] = Math.max(bot, rbot);
                    break
                }
            }
            if (i < 0) {
                i = vranges.length;
                vranges.push(top, bot)
            }
            return {
                left: rect.left - outer.left,
                right: rect.right - outer.left,
                top: i,
                bottom: null
            }
        }
        function finishRect(rect) {
            rect.bottom = vranges[rect.top + 1];
            rect.top = vranges[rect.top]
        }
        for (var i = 0, cur; i < measure.length; ++i) {
            if (cur = measure[i]) {
                var node = cur,
                    rect = null;
                if (/\bCodeMirror-widget\b/.test(cur.className) && cur.getClientRects) {
                    if (cur.firstChild.nodeType == 1) {
                        node = cur.firstChild
                    }
                    var rects = node.getClientRects();
                    if (rects.length > 1) {
                        rect = data[i] = measureRect(rects[0]);
                        rect.rightSide = measureRect(rects[rects.length - 1])
                    }
                }
                if (!rect) {
                    rect = data[i] = measureRect(getRect(node))
                }
                if (cur.measureRight) {
                    rect.right = getRect(cur.measureRight).left
                }
                if (cur.leftSide) {
                    rect.leftSide = measureRect(getRect(cur.leftSide))
                }
            }
        }
        removeChildren(cm.display.measure);
        for (var i = 0, cur; i < data.length; ++i) {
            if (cur = data[i]) {
                finishRect(cur);
                if (cur.leftSide) {
                    finishRect(cur.leftSide)
                }
                if (cur.rightSide) {
                    finishRect(cur.rightSide)
                }
            }
        }
        return data
    }
    function crudelyMeasureLine(cm, line) {
        var copy = new Line(line.text.slice(0, 100), null);
        if (line.textClass) {
            copy.textClass = line.textClass
        }
        var measure = measureLineInner(cm, copy);
        var left = measureChar(cm, copy, 0, measure, "left");
        var right = measureChar(cm, copy, 99, measure, "right");
        return {
            crude: true,
            top: left.top,
            left: left.left,
            bottom: left.bottom,
            width: (right.right - left.left) / 100
        }
    }
    function measureLineWidth(cm, line) {
        var hasBadSpan = false;
        if (line.markedSpans) {
            for (var i = 0; i < line.markedSpans; ++i) {
                var sp = line.markedSpans[i];
                if (sp.collapsed && (sp.to == null || sp.to == line.text.length)) {
                    hasBadSpan = true
                }
            }
        }
        var cached = !hasBadSpan && findCachedMeasurement(cm, line);
        if (cached || line.text.length >= cm.options.crudeMeasuringFrom) {
            return measureChar(cm, line, line.text.length, cached && cached.measure, "right").right
        }
        var pre = buildLineContent(cm, line, null, true).pre;
        var end = pre.appendChild(zeroWidthElement(cm.display.measure));
        removeChildrenAndAdd(cm.display.measure, pre);
        return getRect(end).right - getRect(cm.display.lineDiv).left
    }
    function clearCaches(cm) {
        cm.display.measureLineCache.length = cm.display.measureLineCachePos = 0;
        cm.display.cachedCharWidth = cm.display.cachedTextHeight = null;
        if (!cm.options.lineWrapping) {
            cm.display.maxLineChanged = true
        }
        cm.display.lineNumChars = null
    }
    function pageScrollX() {
        return window.pageXOffset || (document.documentElement || document.body).scrollLeft
    }
    function pageScrollY() {
        return window.pageYOffset || (document.documentElement || document.body).scrollTop
    }
    function intoCoordSystem(cm, lineObj, rect, context) {
        if (lineObj.widgets) {
            for (var i = 0; i < lineObj.widgets.length; ++i) {
                if (lineObj.widgets[i].above) {
                    var size = widgetHeight(lineObj.widgets[i]);
                    rect.top += size;
                    rect.bottom += size
                }
            }
        }
        if (context == "line") {
            return rect
        }
        if (!context) {
            context = "local"
        }
        var yOff = heightAtLine(cm, lineObj);
        if (context == "local") {
            yOff += paddingTop(cm.display)
        } else {
            yOff -= cm.display.viewOffset
        }
        if (context == "page" || context == "window") {
            var lOff = getRect(cm.display.lineSpace);
            yOff += lOff.top + (context == "window" ? 0 : pageScrollY());
            var xOff = lOff.left + (context == "window" ? 0 : pageScrollX());
            rect.left += xOff;
            rect.right += xOff
        }
        rect.top += yOff;
        rect.bottom += yOff;
        return rect
    }
    function fromCoordSystem(cm, coords, context) {
        if (context == "div") {
            return coords
        }
        var left = coords.left,
            top = coords.top;
        if (context == "page") {
            left -= pageScrollX();
            top -= pageScrollY()
        } else {
            if (context == "local" || !context) {
                var localBox = getRect(cm.display.sizer);
                left += localBox.left;
                top += localBox.top
            }
        }
        var lineSpaceBox = getRect(cm.display.lineSpace);
        return {
            left: left - lineSpaceBox.left,
            top: top - lineSpaceBox.top
        }
    }
    function charCoords(cm, pos, context, lineObj, bias) {
        if (!lineObj) {
            lineObj = getLine(cm.doc, pos.line)
        }
        return intoCoordSystem(cm, lineObj, measureChar(cm, lineObj, pos.ch, null, bias), context)
    }
    function cursorCoords(cm, pos, context, lineObj, measurement) {
        lineObj = lineObj || getLine(cm.doc, pos.line);
        if (!measurement) {
            measurement = measureLine(cm, lineObj)
        }
        function get(ch, right) {
            var m = measureChar(cm, lineObj, ch, measurement, right ? "right" : "left");
            if (right) {
                m.left = m.right
            } else {
                m.right = m.left
            }
            return intoCoordSystem(cm, lineObj, m, context)
        }
        function getBidi(ch, partPos) {
            var part = order[partPos],
                right = part.level % 2;
            if (ch == bidiLeft(part) && partPos && part.level < order[partPos - 1].level) {
                part = order[--partPos];
                ch = bidiRight(part) - (part.level % 2 ? 0 : 1);
                right = true
            } else {
                if (ch == bidiRight(part) && partPos < order.length - 1 && part.level < order[partPos + 1].level) {
                    part = order[++partPos];
                    ch = bidiLeft(part) - part.level % 2;
                    right = false
                }
            }
            if (right && ch == part.to && ch > part.from) {
                return get(ch - 1)
            }
            return get(ch, right)
        }
        var order = getOrder(lineObj),
            ch = pos.ch;
        if (!order) {
            return get(ch)
        }
        var partPos = getBidiPartAt(order, ch);
        var val = getBidi(ch, partPos);
        if (bidiOther != null) {
            val.other = getBidi(ch, bidiOther)
        }
        return val
    }
    function PosWithInfo(line, ch, outside, xRel) {
        var pos = new Pos(line, ch);
        pos.xRel = xRel;
        if (outside) {
            pos.outside = true
        }
        return pos
    }
    function coordsChar(cm, x, y) {
        var doc = cm.doc;
        y += cm.display.viewOffset;
        if (y < 0) {
            return PosWithInfo(doc.first, 0, true, -1)
        }
        var lineNo = lineAtHeight(doc, y),
            last = doc.first + doc.size - 1;
        if (lineNo > last) {
            return PosWithInfo(doc.first + doc.size - 1, getLine(doc, last).text.length, true, 1)
        }
        if (x < 0) {
            x = 0
        }
        for (;;) {
            var lineObj = getLine(doc, lineNo);
            var found = coordsCharInner(cm, lineObj, lineNo, x, y);
            var merged = collapsedSpanAtEnd(lineObj);
            var mergedPos = merged && merged.find();
            if (merged && (found.ch > mergedPos.from.ch || found.ch == mergedPos.from.ch && found.xRel > 0)) {
                lineNo = mergedPos.to.line
            } else {
                return found
            }
        }
    }
    function coordsCharInner(cm, lineObj, lineNo, x, y) {
        var innerOff = y - heightAtLine(cm, lineObj);
        var wrongLine = false,
            adjust = 2 * cm.display.wrapper.clientWidth;
        var measurement = measureLine(cm, lineObj);

        function getX(ch) {
            var sp = cursorCoords(cm, Pos(lineNo, ch), "line", lineObj, measurement);
            wrongLine = true;
            if (innerOff > sp.bottom) {
                return sp.left - adjust
            } else {
                if (innerOff < sp.top) {
                    return sp.left + adjust
                } else {
                    wrongLine = false
                }
            }
            return sp.left
        }
        var bidi = getOrder(lineObj),
            dist = lineObj.text.length;
        var from = lineLeft(lineObj),
            to = lineRight(lineObj);
        var fromX = getX(from),
            fromOutside = wrongLine,
            toX = getX(to),
            toOutside = wrongLine;
        if (x > toX) {
            return PosWithInfo(lineNo, to, toOutside, 1)
        }
        for (;;) {
            if (bidi ? to == from || to == moveVisually(lineObj, from, 1) : to - from <= 1) {
                var ch = x < fromX || x - fromX <= toX - x ? from : to;
                var xDiff = x - (ch == from ? fromX : toX);
                while (isExtendingChar.test(lineObj.text.charAt(ch))) {
                    ++ch
                }
                var pos = PosWithInfo(lineNo, ch, ch == from ? fromOutside : toOutside, xDiff < 0 ? -1 : xDiff ? 1 : 0);
                return pos
            }
            var step = Math.ceil(dist / 2),
                middle = from + step;
            if (bidi) {
                middle = from;
                for (var i = 0; i < step; ++i) {
                    middle = moveVisually(lineObj, middle, 1)
                }
            }
            var middleX = getX(middle);
            if (middleX > x) {
                to = middle;
                toX = middleX;
                if (toOutside = wrongLine) {
                    toX += 1000
                }
                dist = step
            } else {
                from = middle;
                fromX = middleX;
                fromOutside = wrongLine;
                dist -= step
            }
        }
    }
    var measureText;

    function textHeight(display) {
        if (display.cachedTextHeight != null) {
            return display.cachedTextHeight
        }
        if (measureText == null) {
            measureText = elt("pre");
            for (var i = 0; i < 49; ++i) {
                measureText.appendChild(document.createTextNode("x"));
                measureText.appendChild(elt("br"))
            }
            measureText.appendChild(document.createTextNode("x"))
        }
        removeChildrenAndAdd(display.measure, measureText);
        var height = measureText.offsetHeight / 50;
        if (height > 3) {
            display.cachedTextHeight = height
        }
        removeChildren(display.measure);
        return height || 1
    }
    function charWidth(display) {
        if (display.cachedCharWidth != null) {
            return display.cachedCharWidth
        }
        var anchor = elt("span", "x");
        var pre = elt("pre", [anchor]);
        removeChildrenAndAdd(display.measure, pre);
        var width = anchor.offsetWidth;
        if (width > 2) {
            display.cachedCharWidth = width
        }
        return width || 10
    }
    var nextOpId = 0;

    function startOperation(cm) {
        cm.curOp = {
            changes: [],
            forceUpdate: false,
            updateInput: null,
            userSelChange: null,
            textChanged: null,
            selectionChanged: false,
            cursorActivity: false,
            updateMaxLine: false,
            updateScrollPos: false,
            id: ++nextOpId
        };
        if (!delayedCallbackDepth++) {
            delayedCallbacks = []
        }
    }
    function endOperation(cm) {
        var op = cm.curOp,
            doc = cm.doc,
            display = cm.display;
        cm.curOp = null;
        if (op.updateMaxLine) {
            computeMaxLength(cm)
        }
        if (display.maxLineChanged && !cm.options.lineWrapping && display.maxLine) {
            var width = measureLineWidth(cm, display.maxLine);
            display.sizer.style.minWidth = Math.max(0, width + 3 + scrollerCutOff) + "px";
            display.maxLineChanged = false;
            var maxScrollLeft = Math.max(0, display.sizer.offsetLeft + display.sizer.offsetWidth - display.scroller.clientWidth);
            if (maxScrollLeft < doc.scrollLeft && !op.updateScrollPos) {
                setScrollLeft(cm, Math.min(display.scroller.scrollLeft, maxScrollLeft), true)
            }
        }
        var newScrollPos, updated;
        if (op.updateScrollPos) {
            newScrollPos = op.updateScrollPos
        } else {
            if (op.selectionChanged && display.scroller.clientHeight) {
                var coords = cursorCoords(cm, doc.sel.head);
                newScrollPos = calculateScrollPos(cm, coords.left, coords.top, coords.left, coords.bottom)
            }
        }
        if (op.changes.length || op.forceUpdate || newScrollPos && newScrollPos.scrollTop != null) {
            updated = updateDisplay(cm, op.changes, newScrollPos && newScrollPos.scrollTop, op.forceUpdate);
            if (cm.display.scroller.offsetHeight) {
                cm.doc.scrollTop = cm.display.scroller.scrollTop
            }
        }
        if (!updated && op.selectionChanged) {
            updateSelection(cm)
        }
        if (op.updateScrollPos) {
            display.scroller.scrollTop = display.scrollbarV.scrollTop = doc.scrollTop = newScrollPos.scrollTop;
            display.scroller.scrollLeft = display.scrollbarH.scrollLeft = doc.scrollLeft = newScrollPos.scrollLeft;
            alignHorizontally(cm);
            if (op.scrollToPos) {
                scrollPosIntoView(cm, clipPos(cm.doc, op.scrollToPos), op.scrollToPosMargin)
            }
        } else {
            if (newScrollPos) {
                scrollCursorIntoView(cm)
            }
        }
        if (op.selectionChanged) {
            restartBlink(cm)
        }
        if (cm.state.focused && op.updateInput) {
            resetInput(cm, op.userSelChange)
        }
        var hidden = op.maybeHiddenMarkers,
            unhidden = op.maybeUnhiddenMarkers;
        if (hidden) {
            for (var i = 0; i < hidden.length; ++i) {
                if (!hidden[i].lines.length) {
                    signal(hidden[i], "hide")
                }
            }
        }
        if (unhidden) {
            for (var i = 0; i < unhidden.length; ++i) {
                if (unhidden[i].lines.length) {
                    signal(unhidden[i], "unhide")
                }
            }
        }
        var delayed;
        if (!--delayedCallbackDepth) {
            delayed = delayedCallbacks;
            delayedCallbacks = null
        }
        if (op.textChanged) {
            signal(cm, "change", cm, op.textChanged)
        }
        if (op.cursorActivity) {
            signal(cm, "cursorActivity", cm)
        }
        if (delayed) {
            for (var i = 0; i < delayed.length; ++i) {
                delayed[i]()
            }
        }
    }
    function operation(cm1, f) {
        return function () {
            var cm = cm1 || this,
                withOp = !cm.curOp;
            if (withOp) {
                startOperation(cm)
            }
            try {
                var result = f.apply(cm, arguments)
            } finally {
                if (withOp) {
                    endOperation(cm)
                }
            }
            return result
        }
    }
    function docOperation(f) {
        return function () {
            var withOp = this.cm && !this.cm.curOp,
                result;
            if (withOp) {
                startOperation(this.cm)
            }
            try {
                result = f.apply(this, arguments)
            } finally {
                if (withOp) {
                    endOperation(this.cm)
                }
            }
            return result
        }
    }
    function runInOp(cm, f) {
        var withOp = !cm.curOp,
            result;
        if (withOp) {
            startOperation(cm)
        }
        try {
            result = f()
        } finally {
            if (withOp) {
                endOperation(cm)
            }
        }
        return result
    }
    function regChange(cm, from, to, lendiff) {
        if (from == null) {
            from = cm.doc.first
        }
        if (to == null) {
            to = cm.doc.first + cm.doc.size
        }
        cm.curOp.changes.push({
            from: from,
            to: to,
            diff: lendiff
        })
    }
    function slowPoll(cm) {
        if (cm.display.pollingFast) {
            return
        }
        cm.display.poll.set(cm.options.pollInterval, function () {
            readInput(cm);
            if (cm.state.focused) {
                slowPoll(cm)
            }
        })
    }
    function fastPoll(cm) {
        var missed = false;
        cm.display.pollingFast = true;

        function p() {
            var changed = readInput(cm);
            if (!changed && !missed) {
                missed = true;
                cm.display.poll.set(60, p)
            } else {
                cm.display.pollingFast = false;
                slowPoll(cm)
            }
        }
        cm.display.poll.set(20, p)
    }
    function readInput(cm) {
        var input = cm.display.input,
            prevInput = cm.display.prevInput,
            doc = cm.doc,
            sel = doc.sel;
        if (!cm.state.focused || hasSelection(input) || isReadOnly(cm) || cm.state.disableInput) {
            return false
        }
        if (cm.state.pasteIncoming && cm.state.fakedLastChar) {
            input.value = input.value.substring(0, input.value.length - 1);
            cm.state.fakedLastChar = false
        }
        var text = input.value;
        if (text == prevInput && posEq(sel.from, sel.to)) {
            return false
        }
        if (ie && !ie_lt9 && cm.display.inputHasSelection === text) {
            resetInput(cm, true);
            return false
        }
        var withOp = !cm.curOp;
        if (withOp) {
            startOperation(cm)
        }
        sel.shift = false;
        var same = 0,
            l = Math.min(prevInput.length, text.length);
        while (same < l && prevInput.charCodeAt(same) == text.charCodeAt(same)) {
            ++same
        }
        var from = sel.from,
            to = sel.to;
        if (same < prevInput.length) {
            from = Pos(from.line, from.ch - (prevInput.length - same))
        } else {
            if (cm.state.overwrite && posEq(from, to) && !cm.state.pasteIncoming) {
                to = Pos(to.line, Math.min(getLine(doc, to.line).text.length, to.ch + (text.length - same)))
            }
        }
        var updateInput = cm.curOp.updateInput;
        var changeEvent = {
            from: from,
            to: to,
            text: splitLines(text.slice(same)),
            origin: cm.state.pasteIncoming ? "paste" : "+input"
        };
        makeChange(cm.doc, changeEvent, "end");
        cm.curOp.updateInput = updateInput;
        signalLater(cm, "inputRead", cm, changeEvent);
        if (text.length > 1000 || text.indexOf("\n") > -1) {
            input.value = cm.display.prevInput = ""
        } else {
            cm.display.prevInput = text
        }
        if (withOp) {
            endOperation(cm)
        }
        cm.state.pasteIncoming = false;
        return true
    }
    function resetInput(cm, user) {
        var minimal, selected, doc = cm.doc;
        if (!posEq(doc.sel.from, doc.sel.to)) {
            cm.display.prevInput = "";
            minimal = hasCopyEvent && (doc.sel.to.line - doc.sel.from.line > 100 || (selected = cm.getSelection()).length > 1000);
            var content = minimal ? "-" : selected || cm.getSelection();
            cm.display.input.value = content;
            if (cm.state.focused) {
                selectInput(cm.display.input)
            }
            if (ie && !ie_lt9) {
                cm.display.inputHasSelection = content
            }
        } else {
            if (user) {
                cm.display.prevInput = cm.display.input.value = "";
                if (ie && !ie_lt9) {
                    cm.display.inputHasSelection = null
                }
            }
        }
        cm.display.inaccurateSelection = minimal
    }
    function focusInput(cm) {
        if (cm.options.readOnly != "nocursor" && (!mobile || document.activeElement != cm.display.input)) {
            cm.display.input.focus()
        }
    }
    function isReadOnly(cm) {
        return cm.options.readOnly || cm.doc.cantEdit
    }
    function registerEventHandlers(cm) {
        var d = cm.display;
        on(d.scroller, "mousedown", operation(cm, onMouseDown));
        if (ie) {
            on(d.scroller, "dblclick", operation(cm, function (e) {
                if (signalDOMEvent(cm, e)) {
                    return
                }
                var pos = posFromMouse(cm, e);
                if (!pos || clickInGutter(cm, e) || eventInWidget(cm.display, e)) {
                    return
                }
                e_preventDefault(e);
                var word = findWordAt(getLine(cm.doc, pos.line).text, pos);
                extendSelection(cm.doc, word.from, word.to)
            }))
        } else {
            on(d.scroller, "dblclick", function (e) {
                signalDOMEvent(cm, e) || e_preventDefault(e)
            })
        }
        on(d.lineSpace, "selectstart", function (e) {
            if (!eventInWidget(d, e)) {
                e_preventDefault(e)
            }
        });
        if (!captureMiddleClick) {
            on(d.scroller, "contextmenu", function (e) {
                onContextMenu(cm, e)
            })
        }
        on(d.scroller, "scroll", function () {
            if (d.scroller.clientHeight) {
                setScrollTop(cm, d.scroller.scrollTop);
                setScrollLeft(cm, d.scroller.scrollLeft, true);
                signal(cm, "scroll", cm)
            }
        });
        on(d.scrollbarV, "scroll", function () {
            if (d.scroller.clientHeight) {
                setScrollTop(cm, d.scrollbarV.scrollTop)
            }
        });
        on(d.scrollbarH, "scroll", function () {
            if (d.scroller.clientHeight) {
                setScrollLeft(cm, d.scrollbarH.scrollLeft)
            }
        });
        on(d.scroller, "mousewheel", function (e) {
            onScrollWheel(cm, e)
        });
        on(d.scroller, "DOMMouseScroll", function (e) {
            onScrollWheel(cm, e)
        });

        function reFocus() {
            if (cm.state.focused) {
                setTimeout(bind(focusInput, cm), 0)
            }
        }
        on(d.scrollbarH, "mousedown", reFocus);
        on(d.scrollbarV, "mousedown", reFocus);
        on(d.wrapper, "scroll", function () {
            d.wrapper.scrollTop = d.wrapper.scrollLeft = 0
        });
        var resizeTimer;

        function onResize() {
            if (resizeTimer == null) {
                resizeTimer = setTimeout(function () {
                    resizeTimer = null;
                    d.cachedCharWidth = d.cachedTextHeight = knownScrollbarWidth = null;
                    clearCaches(cm);
                    runInOp(cm, bind(regChange, cm))
                }, 100)
            }
        }
        on(window, "resize", onResize);

        function unregister() {
            for (var p = d.wrapper.parentNode; p && p != document.body; p = p.parentNode) {}
            if (p) {
                setTimeout(unregister, 5000)
            } else {
                off(window, "resize", onResize)
            }
        }
        setTimeout(unregister, 5000);
        on(d.input, "keyup", operation(cm, function (e) {
            if (signalDOMEvent(cm, e) || cm.options.onKeyEvent && cm.options.onKeyEvent(cm, addStop(e))) {
                return
            }
            if (e.keyCode == 16) {
                cm.doc.sel.shift = false
            }
        }));
        on(d.input, "input", function () {
            if (ie && !ie_lt9 && cm.display.inputHasSelection) {
                cm.display.inputHasSelection = null
            }
            fastPoll(cm)
        });
        on(d.input, "keydown", operation(cm, onKeyDown));
        on(d.input, "keypress", operation(cm, onKeyPress));
        on(d.input, "focus", bind(onFocus, cm));
        on(d.input, "blur", bind(onBlur, cm));

        function drag_(e) {
            if (signalDOMEvent(cm, e) || cm.options.onDragEvent && cm.options.onDragEvent(cm, addStop(e))) {
                return
            }
            e_stop(e)
        }
        if (cm.options.dragDrop) {
            on(d.scroller, "dragstart", function (e) {
                onDragStart(cm, e)
            });
            on(d.scroller, "dragenter", drag_);
            on(d.scroller, "dragover", drag_);
            on(d.scroller, "drop", operation(cm, onDrop))
        }
        on(d.scroller, "paste", function (e) {
            if (eventInWidget(d, e)) {
                return
            }
            focusInput(cm);
            fastPoll(cm)
        });
        on(d.input, "paste", function () {
            if (webkit && !cm.state.fakedLastChar && !(new Date - cm.state.lastMiddleDown < 200)) {
                var start = d.input.selectionStart,
                    end = d.input.selectionEnd;
                d.input.value += "$";
                d.input.selectionStart = start;
                d.input.selectionEnd = end;
                cm.state.fakedLastChar = true
            }
            cm.state.pasteIncoming = true;
            fastPoll(cm)
        });

        function prepareCopy() {
            if (d.inaccurateSelection) {
                d.prevInput = "";
                d.inaccurateSelection = false;
                d.input.value = cm.getSelection();
                selectInput(d.input)
            }
        }
        on(d.input, "cut", prepareCopy);
        on(d.input, "copy", prepareCopy);
        if (khtml) {
            on(d.sizer, "mouseup", function () {
                if (document.activeElement == d.input) {
                    d.input.blur()
                }
                focusInput(cm)
            })
        }
    }
    function eventInWidget(display, e) {
        for (var n = e_target(e); n != display.wrapper; n = n.parentNode) {
            if (!n || n.ignoreEvents || n.parentNode == display.sizer && n != display.mover) {
                return true
            }
        }
    }
    function posFromMouse(cm, e, liberal) {
        var display = cm.display;
        if (!liberal) {
            var target = e_target(e);
            if (target == display.scrollbarH || target == display.scrollbarH.firstChild || target == display.scrollbarV || target == display.scrollbarV.firstChild || target == display.scrollbarFiller || target == display.gutterFiller) {
                return null
            }
        }
        var x, y, space = getRect(display.lineSpace);
        try {
            x = e.clientX;
            y = e.clientY
        } catch (e) {
            return null
        }
        return coordsChar(cm, x - space.left, y - space.top)
    }
    var lastClick, lastDoubleClick;

    function onMouseDown(e) {
        if (signalDOMEvent(this, e)) {
            return
        }
        var cm = this,
            display = cm.display,
            doc = cm.doc,
            sel = doc.sel;
        sel.shift = e.shiftKey;
        if (eventInWidget(display, e)) {
            if (!webkit) {
                display.scroller.draggable = false;
                setTimeout(function () {
                    display.scroller.draggable = true
                }, 100)
            }
            return
        }
        if (clickInGutter(cm, e)) {
            return
        }
        var start = posFromMouse(cm, e);
        switch (e_button(e)) {
        case 3:
            if (captureMiddleClick) {
                onContextMenu.call(cm, cm, e)
            }
            return;
        case 2:
            if (webkit) {
                cm.state.lastMiddleDown = +new Date
            }
            if (start) {
                extendSelection(cm.doc, start)
            }
            setTimeout(bind(focusInput, cm), 20);
            e_preventDefault(e);
            return
        }
        if (!start) {
            if (e_target(e) == display.scroller) {
                e_preventDefault(e)
            }
            return
        }
        if (!cm.state.focused) {
            onFocus(cm)
        }
        var now = +new Date,
            type = "single";
        if (lastDoubleClick && lastDoubleClick.time > now - 400 && posEq(lastDoubleClick.pos, start)) {
            type = "triple";
            e_preventDefault(e);
            setTimeout(bind(focusInput, cm), 20);
            selectLine(cm, start.line)
        } else {
            if (lastClick && lastClick.time > now - 400 && posEq(lastClick.pos, start)) {
                type = "double";
                lastDoubleClick = {
                    time: now,
                    pos: start
                };
                e_preventDefault(e);
                var word = findWordAt(getLine(doc, start.line).text, start);
                extendSelection(cm.doc, word.from, word.to)
            } else {
                lastClick = {
                    time: now,
                    pos: start
                }
            }
        }
        var last = start;
        if (cm.options.dragDrop && dragAndDrop && !isReadOnly(cm) && !posEq(sel.from, sel.to) && !posLess(start, sel.from) && !posLess(sel.to, start) && type == "single") {
            var dragEnd = operation(cm, function (e2) {
                if (webkit) {
                    display.scroller.draggable = false
                }
                cm.state.draggingText = false;
                off(document, "mouseup", dragEnd);
                off(display.scroller, "drop", dragEnd);
                if (Math.abs(e.clientX - e2.clientX) + Math.abs(e.clientY - e2.clientY) < 10) {
                    e_preventDefault(e2);
                    extendSelection(cm.doc, start);
                    focusInput(cm)
                }
            });
            if (webkit) {
                display.scroller.draggable = true
            }
            cm.state.draggingText = dragEnd;
            if (display.scroller.dragDrop) {
                display.scroller.dragDrop()
            }
            on(document, "mouseup", dragEnd);
            on(display.scroller, "drop", dragEnd);
            return
        }
        e_preventDefault(e);
        if (type == "single") {
            extendSelection(cm.doc, clipPos(doc, start))
        }
        var startstart = sel.from,
            startend = sel.to,
            lastPos = start;

        function doSelect(cur) {
            if (posEq(lastPos, cur)) {
                return
            }
            lastPos = cur;
            if (type == "single") {
                extendSelection(cm.doc, clipPos(doc, start), cur);
                return
            }
            startstart = clipPos(doc, startstart);
            startend = clipPos(doc, startend);
            if (type == "double") {
                var word = findWordAt(getLine(doc, cur.line).text, cur);
                if (posLess(cur, startstart)) {
                    extendSelection(cm.doc, word.from, startend)
                } else {
                    extendSelection(cm.doc, startstart, word.to)
                }
            } else {
                if (type == "triple") {
                    if (posLess(cur, startstart)) {
                        extendSelection(cm.doc, startend, clipPos(doc, Pos(cur.line, 0)))
                    } else {
                        extendSelection(cm.doc, startstart, clipPos(doc, Pos(cur.line + 1, 0)))
                    }
                }
            }
        }
        var editorSize = getRect(display.wrapper);
        var counter = 0;

        function extend(e) {
            var curCount = ++counter;
            var cur = posFromMouse(cm, e, true);
            if (!cur) {
                return
            }
            if (!posEq(cur, last)) {
                if (!cm.state.focused) {
                    onFocus(cm)
                }
                last = cur;
                doSelect(cur);
                var visible = visibleLines(display, doc);
                if (cur.line >= visible.to || cur.line < visible.from) {
                    setTimeout(operation(cm, function () {
                        if (counter == curCount) {
                            extend(e)
                        }
                    }), 150)
                }
            } else {
                var outside = e.clientY < editorSize.top ? -20 : e.clientY > editorSize.bottom ? 20 : 0;
                if (outside) {
                    setTimeout(operation(cm, function () {
                        if (counter != curCount) {
                            return
                        }
                        display.scroller.scrollTop += outside;
                        extend(e)
                    }), 50)
                }
            }
        }
        function done(e) {
            counter = Infinity;
            e_preventDefault(e);
            focusInput(cm);
            off(document, "mousemove", move);
            off(document, "mouseup", up)
        }
        var move = operation(cm, function (e) {
            if (!ie && !e_button(e)) {
                done(e)
            } else {
                extend(e)
            }
        });
        var up = operation(cm, done);
        on(document, "mousemove", move);
        on(document, "mouseup", up)
    }
    function gutterEvent(cm, e, type, prevent, signalfn) {
        try {
            var mX = e.clientX,
                mY = e.clientY
        } catch (e) {
            return false
        }
        if (mX >= Math.floor(getRect(cm.display.gutters).right)) {
            return false
        }
        if (prevent) {
            e_preventDefault(e)
        }
        var display = cm.display;
        var lineBox = getRect(display.lineDiv);
        if (mY > lineBox.bottom || !hasHandler(cm, type)) {
            return e_defaultPrevented(e)
        }
        mY -= lineBox.top - display.viewOffset;
        for (var i = 0; i < cm.options.gutters.length; ++i) {
            var g = display.gutters.childNodes[i];
            if (g && getRect(g).right >= mX) {
                var line = lineAtHeight(cm.doc, mY);
                var gutter = cm.options.gutters[i];
                signalfn(cm, type, cm, line, gutter, e);
                return e_defaultPrevented(e)
            }
        }
    }
    function contextMenuInGutter(cm, e) {
        if (!hasHandler(cm, "gutterContextMenu")) {
            return false
        }
        return gutterEvent(cm, e, "gutterContextMenu", false, signal)
    }
    function clickInGutter(cm, e) {
        return gutterEvent(cm, e, "gutterClick", true, signalLater)
    }
    var lastDrop = 0;

    function onDrop(e) {
        var cm = this;
        if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e) || (cm.options.onDragEvent && cm.options.onDragEvent(cm, addStop(e)))) {
            return
        }
        e_preventDefault(e);
        if (ie) {
            lastDrop = +new Date
        }
        var pos = posFromMouse(cm, e, true),
            files = e.dataTransfer.files;
        if (!pos || isReadOnly(cm)) {
            return
        }
        if (files && files.length && window.FileReader && window.File) {
            var n = files.length,
                text = Array(n),
                read = 0;
            var loadFile = function (file, i) {
                    var reader = new FileReader;
                    reader.onload = function () {
                        text[i] = reader.result;
                        if (++read == n) {
                            pos = clipPos(cm.doc, pos);
                            makeChange(cm.doc, {
                                from: pos,
                                to: pos,
                                text: splitLines(text.join("\n")),
                                origin: "paste"
                            }, "around")
                        }
                    };
                    reader.readAsText(file)
                };
            for (var i = 0; i < n; ++i) {
                loadFile(files[i], i)
            }
        } else {
            if (cm.state.draggingText && !(posLess(pos, cm.doc.sel.from) || posLess(cm.doc.sel.to, pos))) {
                cm.state.draggingText(e);
                setTimeout(bind(focusInput, cm), 20);
                return
            }
            try {
                var text = e.dataTransfer.getData("Text");
                if (text) {
                    var curFrom = cm.doc.sel.from,
                        curTo = cm.doc.sel.to;
                    setSelection(cm.doc, pos, pos);
                    if (cm.state.draggingText) {
                        replaceRange(cm.doc, "", curFrom, curTo, "paste")
                    }
                    cm.replaceSelection(text, null, "paste");
                    focusInput(cm);
                    onFocus(cm)
                }
            } catch (e) {}
        }
    }
    function onDragStart(cm, e) {
        if (ie && (!cm.state.draggingText || +new Date - lastDrop < 100)) {
            e_stop(e);
            return
        }
        if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e)) {
            return
        }
        var txt = cm.getSelection();
        e.dataTransfer.setData("Text", txt);
        if (e.dataTransfer.setDragImage && !safari) {
            var img = elt("img", null, null, "position: fixed; left: 0; top: 0;");
            img.src = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";
            if (opera) {
                img.width = img.height = 1;
                cm.display.wrapper.appendChild(img);
                img._top = img.offsetTop
            }
            e.dataTransfer.setDragImage(img, 0, 0);
            if (opera) {
                img.parentNode.removeChild(img)
            }
        }
    }
    function setScrollTop(cm, val) {
        if (Math.abs(cm.doc.scrollTop - val) < 2) {
            return
        }
        cm.doc.scrollTop = val;
        if (!gecko) {
            updateDisplay(cm, [], val)
        }
        if (cm.display.scroller.scrollTop != val) {
            cm.display.scroller.scrollTop = val
        }
        if (cm.display.scrollbarV.scrollTop != val) {
            cm.display.scrollbarV.scrollTop = val
        }
        if (gecko) {
            updateDisplay(cm, [])
        }
        startWorker(cm, 100)
    }
    function setScrollLeft(cm, val, isScroller) {
        if (isScroller ? val == cm.doc.scrollLeft : Math.abs(cm.doc.scrollLeft - val) < 2) {
            return
        }
        val = Math.min(val, cm.display.scroller.scrollWidth - cm.display.scroller.clientWidth);
        cm.doc.scrollLeft = val;
        alignHorizontally(cm);
        if (cm.display.scroller.scrollLeft != val) {
            cm.display.scroller.scrollLeft = val
        }
        if (cm.display.scrollbarH.scrollLeft != val) {
            cm.display.scrollbarH.scrollLeft = val
        }
    }
    var wheelSamples = 0,
        wheelPixelsPerUnit = null;
    if (ie) {
        wheelPixelsPerUnit = -0.53
    } else {
        if (gecko) {
            wheelPixelsPerUnit = 15
        } else {
            if (chrome) {
                wheelPixelsPerUnit = -0.7
            } else {
                if (safari) {
                    wheelPixelsPerUnit = -1 / 3
                }
            }
        }
    }
    function onScrollWheel(cm, e) {
        var dx = e.wheelDeltaX,
            dy = e.wheelDeltaY;
        if (dx == null && e.detail && e.axis == e.HORIZONTAL_AXIS) {
            dx = e.detail
        }
        if (dy == null && e.detail && e.axis == e.VERTICAL_AXIS) {
            dy = e.detail
        } else {
            if (dy == null) {
                dy = e.wheelDelta
            }
        }
        var display = cm.display,
            scroll = display.scroller;
        if (!(dx && scroll.scrollWidth > scroll.clientWidth || dy && scroll.scrollHeight > scroll.clientHeight)) {
            return
        }
        if (dy && mac && webkit) {
            for (var cur = e.target; cur != scroll; cur = cur.parentNode) {
                if (cur.lineObj) {
                    cm.display.currentWheelTarget = cur;
                    break
                }
            }
        }
        if (dx && !gecko && !opera && wheelPixelsPerUnit != null) {
            if (dy) {
                setScrollTop(cm, Math.max(0, Math.min(scroll.scrollTop + dy * wheelPixelsPerUnit, scroll.scrollHeight - scroll.clientHeight)))
            }
            setScrollLeft(cm, Math.max(0, Math.min(scroll.scrollLeft + dx * wheelPixelsPerUnit, scroll.scrollWidth - scroll.clientWidth)));
            e_preventDefault(e);
            display.wheelStartX = null;
            return
        }
        if (dy && wheelPixelsPerUnit != null) {
            var pixels = dy * wheelPixelsPerUnit;
            var top = cm.doc.scrollTop,
                bot = top + display.wrapper.clientHeight;
            if (pixels < 0) {
                top = Math.max(0, top + pixels - 50)
            } else {
                bot = Math.min(cm.doc.height, bot + pixels + 50)
            }
            updateDisplay(cm, [], {
                top: top,
                bottom: bot
            })
        }
        if (wheelSamples < 20) {
            if (display.wheelStartX == null) {
                display.wheelStartX = scroll.scrollLeft;
                display.wheelStartY = scroll.scrollTop;
                display.wheelDX = dx;
                display.wheelDY = dy;
                setTimeout(function () {
                    if (display.wheelStartX == null) {
                        return
                    }
                    var movedX = scroll.scrollLeft - display.wheelStartX;
                    var movedY = scroll.scrollTop - display.wheelStartY;
                    var sample = (movedY && display.wheelDY && movedY / display.wheelDY) || (movedX && display.wheelDX && movedX / display.wheelDX);
                    display.wheelStartX = display.wheelStartY = null;
                    if (!sample) {
                        return
                    }
                    wheelPixelsPerUnit = (wheelPixelsPerUnit * wheelSamples + sample) / (wheelSamples + 1);
                    ++wheelSamples
                }, 200)
            } else {
                display.wheelDX += dx;
                display.wheelDY += dy
            }
        }
    }
    function doHandleBinding(cm, bound, dropShift) {
        if (typeof bound == "string") {
            bound = commands[bound];
            if (!bound) {
                return false
            }
        }
        if (cm.display.pollingFast && readInput(cm)) {
            cm.display.pollingFast = false
        }
        var doc = cm.doc,
            prevShift = doc.sel.shift,
            done = false;
        try {
            if (isReadOnly(cm)) {
                cm.state.suppressEdits = true
            }
            if (dropShift) {
                doc.sel.shift = false
            }
            done = bound(cm) != Pass
        } finally {
            doc.sel.shift = prevShift;
            cm.state.suppressEdits = false
        }
        return done
    }
    function allKeyMaps(cm) {
        var maps = cm.state.keyMaps.slice(0);
        if (cm.options.extraKeys) {
            maps.push(cm.options.extraKeys)
        }
        maps.push(cm.options.keyMap);
        return maps
    }
    var maybeTransition;

    function handleKeyBinding(cm, e) {
        var startMap = getKeyMap(cm.options.keyMap),
            next = startMap.auto;
        clearTimeout(maybeTransition);
        if (next && !isModifierKey(e)) {
            maybeTransition = setTimeout(function () {
                if (getKeyMap(cm.options.keyMap) == startMap) {
                    cm.options.keyMap = (next.call ? next.call(null, cm) : next);
                    keyMapChanged(cm)
                }
            }, 50)
        }
        var name = keyName(e, true),
            handled = false;
        if (!name) {
            return false
        }
        var keymaps = allKeyMaps(cm);
        if (e.shiftKey) {
            handled = lookupKey("Shift-" + name, keymaps, function (b) {
                return doHandleBinding(cm, b, true)
            }) || lookupKey(name, keymaps, function (b) {
                if (typeof b == "string" ? /^go[A-Z]/.test(b) : b.motion) {
                    return doHandleBinding(cm, b)
                }
            })
        } else {
            handled = lookupKey(name, keymaps, function (b) {
                return doHandleBinding(cm, b)
            })
        }
        if (handled) {
            e_preventDefault(e);
            restartBlink(cm);
            if (ie_lt9) {
                e.oldKeyCode = e.keyCode;
                e.keyCode = 0
            }
            signalLater(cm, "keyHandled", cm, name, e)
        }
        return handled
    }
    function handleCharBinding(cm, e, ch) {
        var handled = lookupKey("'" + ch + "'", allKeyMaps(cm), function (b) {
            return doHandleBinding(cm, b, true)
        });
        if (handled) {
            e_preventDefault(e);
            restartBlink(cm);
            signalLater(cm, "keyHandled", cm, "'" + ch + "'", e)
        }
        return handled
    }
    var lastStoppedKey = null;

    function onKeyDown(e) {
        var cm = this;
        if (!cm.state.focused) {
            onFocus(cm)
        }
        if (signalDOMEvent(cm, e) || cm.options.onKeyEvent && cm.options.onKeyEvent(cm, addStop(e))) {
            return
        }
        if (ie && e.keyCode == 27) {
            e.returnValue = false
        }
        var code = e.keyCode;
        cm.doc.sel.shift = code == 16 || e.shiftKey;
        var handled = handleKeyBinding(cm, e);
        if (opera) {
            lastStoppedKey = handled ? code : null;
            if (!handled && code == 88 && !hasCopyEvent && (mac ? e.metaKey : e.ctrlKey)) {
                cm.replaceSelection("")
            }
        }
    }
    function onKeyPress(e) {
        var cm = this;
        if (signalDOMEvent(cm, e) || cm.options.onKeyEvent && cm.options.onKeyEvent(cm, addStop(e))) {
            return
        }
        var keyCode = e.keyCode,
            charCode = e.charCode;
        if (opera && keyCode == lastStoppedKey) {
            lastStoppedKey = null;
            e_preventDefault(e);
            return
        }
        if (((opera && (!e.which || e.which < 10)) || khtml) && handleKeyBinding(cm, e)) {
            return
        }
        var ch = String.fromCharCode(charCode == null ? keyCode : charCode);
        if (this.options.electricChars && this.doc.mode.electricChars && this.options.smartIndent && !isReadOnly(this) && this.doc.mode.electricChars.indexOf(ch) > -1) {
            setTimeout(operation(cm, function () {
                indentLine(cm, cm.doc.sel.to.line, "smart")
            }), 75)
        }
        if (handleCharBinding(cm, e, ch)) {
            return
        }
        if (ie && !ie_lt9) {
            cm.display.inputHasSelection = null
        }
        fastPoll(cm)
    }
    function onFocus(cm) {
        if (cm.options.readOnly == "nocursor") {
            return
        }
        if (!cm.state.focused) {
            signal(cm, "focus", cm);
            cm.state.focused = true;
            if (cm.display.wrapper.className.search(/\bCodeMirror-focused\b/) == -1) {
                cm.display.wrapper.className += " CodeMirror-focused"
            }
            if (!cm.curOp) {
                resetInput(cm, true);
                if (webkit) {
                    setTimeout(bind(resetInput, cm, true), 0)
                }
            }
        }
        slowPoll(cm);
        restartBlink(cm)
    }
    function onBlur(cm) {
        if (cm.state.focused) {
            signal(cm, "blur", cm);
            cm.state.focused = false;
            cm.display.wrapper.className = cm.display.wrapper.className.replace(" CodeMirror-focused", "")
        }
        clearInterval(cm.display.blinker);
        setTimeout(function () {
            if (!cm.state.focused) {
                cm.doc.sel.shift = false
            }
        }, 150)
    }
    var detectingSelectAll;

    function onContextMenu(cm, e) {
        if (signalDOMEvent(cm, e, "contextmenu")) {
            return
        }
        var display = cm.display,
            sel = cm.doc.sel;
        if (eventInWidget(display, e) || contextMenuInGutter(cm, e)) {
            return
        }
        var pos = posFromMouse(cm, e),
            scrollPos = display.scroller.scrollTop;
        if (!pos || opera) {
            return
        }
        if (posEq(sel.from, sel.to) || posLess(pos, sel.from) || !posLess(pos, sel.to)) {
            operation(cm, setSelection)(cm.doc, pos, pos)
        }
        var oldCSS = display.input.style.cssText;
        display.inputDiv.style.position = "absolute";
        display.input.style.cssText = "position: fixed; width: 30px; height: 30px; top: " + (e.clientY - 5) + "px; left: " + (e.clientX - 5) + "px; z-index: 1000; background: white; outline: none;border-width: 0; outline: none; overflow: hidden; opacity: .05; -ms-opacity: .05; filter: alpha(opacity=5);";
        focusInput(cm);
        resetInput(cm, true);
        if (posEq(sel.from, sel.to)) {
            display.input.value = display.prevInput = " "
        }
        function prepareSelectAllHack() {
            if (display.input.selectionStart != null) {
                var extval = display.input.value = "\u200b" + (posEq(sel.from, sel.to) ? "" : display.input.value);
                display.prevInput = "\u200b";
                display.input.selectionStart = 1;
                display.input.selectionEnd = extval.length
            }
        }
        function rehide() {
            display.inputDiv.style.position = "relative";
            display.input.style.cssText = oldCSS;
            if (ie_lt9) {
                display.scrollbarV.scrollTop = display.scroller.scrollTop = scrollPos
            }
            slowPoll(cm);
            if (display.input.selectionStart != null) {
                if (!ie || ie_lt9) {
                    prepareSelectAllHack()
                }
                clearTimeout(detectingSelectAll);
                var i = 0,
                    poll = function () {
                        if (display.prevInput == " " && display.input.selectionStart == 0) {
                            operation(cm, commands.selectAll)(cm)
                        } else {
                            if (i++ < 10) {
                                detectingSelectAll = setTimeout(poll, 500)
                            } else {
                                resetInput(cm)
                            }
                        }
                    };
                detectingSelectAll = setTimeout(poll, 200)
            }
        }
        if (ie && !ie_lt9) {
            prepareSelectAllHack()
        }
        if (captureMiddleClick) {
            e_stop(e);
            var mouseup = function () {
                    off(window, "mouseup", mouseup);
                    setTimeout(rehide, 20)
                };
            on(window, "mouseup", mouseup)
        } else {
            setTimeout(rehide, 50)
        }
    }
    var changeEnd = CodeMirror.changeEnd = function (change) {
            if (!change.text) {
                return change.to
            }
            return Pos(change.from.line + change.text.length - 1, lst(change.text).length + (change.text.length == 1 ? change.from.ch : 0))
        };

    function clipPostChange(doc, change, pos) {
        if (!posLess(change.from, pos)) {
            return clipPos(doc, pos)
        }
        var diff = (change.text.length - 1) - (change.to.line - change.from.line);
        if (pos.line > change.to.line + diff) {
            var preLine = pos.line - diff,
                lastLine = doc.first + doc.size - 1;
            if (preLine > lastLine) {
                return Pos(lastLine, getLine(doc, lastLine).text.length)
            }
            return clipToLen(pos, getLine(doc, preLine).text.length)
        }
        if (pos.line == change.to.line + diff) {
            return clipToLen(pos, lst(change.text).length + (change.text.length == 1 ? change.from.ch : 0) + getLine(doc, change.to.line).text.length - change.to.ch)
        }
        var inside = pos.line - change.from.line;
        return clipToLen(pos, change.text[inside].length + (inside ? 0 : change.from.ch))
    }
    function computeSelAfterChange(doc, change, hint) {
        if (hint && typeof hint == "object") {
            return {
                anchor: clipPostChange(doc, change, hint.anchor),
                head: clipPostChange(doc, change, hint.head)
            }
        }
        if (hint == "start") {
            return {
                anchor: change.from,
                head: change.from
            }
        }
        var end = changeEnd(change);
        if (hint == "around") {
            return {
                anchor: change.from,
                head: end
            }
        }
        if (hint == "end") {
            return {
                anchor: end,
                head: end
            }
        }
        var adjustPos = function (pos) {
                if (posLess(pos, change.from)) {
                    return pos
                }
                if (!posLess(change.to, pos)) {
                    return end
                }
                var line = pos.line + change.text.length - (change.to.line - change.from.line) - 1,
                    ch = pos.ch;
                if (pos.line == change.to.line) {
                    ch += end.ch - change.to.ch
                }
                return Pos(line, ch)
            };
        return {
            anchor: adjustPos(doc.sel.anchor),
            head: adjustPos(doc.sel.head)
        }
    }
    function filterChange(doc, change, update) {
        var obj = {
            canceled: false,
            from: change.from,
            to: change.to,
            text: change.text,
            origin: change.origin,
            cancel: function () {
                this.canceled = true
            }
        };
        if (update) {
            obj.update = function (from, to, text, origin) {
                if (from) {
                    this.from = clipPos(doc, from)
                }
                if (to) {
                    this.to = clipPos(doc, to)
                }
                if (text) {
                    this.text = text
                }
                if (origin !== undefined) {
                    this.origin = origin
                }
            }
        }
        signal(doc, "beforeChange", doc, obj);
        if (doc.cm) {
            signal(doc.cm, "beforeChange", doc.cm, obj)
        }
        if (obj.canceled) {
            return null
        }
        return {
            from: obj.from,
            to: obj.to,
            text: obj.text,
            origin: obj.origin
        }
    }
    function makeChange(doc, change, selUpdate, ignoreReadOnly) {
        if (doc.cm) {
            if (!doc.cm.curOp) {
                return operation(doc.cm, makeChange)(doc, change, selUpdate, ignoreReadOnly)
            }
            if (doc.cm.state.suppressEdits) {
                return
            }
        }
        if (hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange")) {
            change = filterChange(doc, change, true);
            if (!change) {
                return
            }
        }
        var split = sawReadOnlySpans && !ignoreReadOnly && removeReadOnlyRanges(doc, change.from, change.to);
        if (split) {
            for (var i = split.length - 1; i >= 1; --i) {
                makeChangeNoReadonly(doc, {
                    from: split[i].from,
                    to: split[i].to,
                    text: [""]
                })
            }
            if (split.length) {
                makeChangeNoReadonly(doc, {
                    from: split[0].from,
                    to: split[0].to,
                    text: change.text
                }, selUpdate)
            }
        } else {
            makeChangeNoReadonly(doc, change, selUpdate)
        }
    }
    function makeChangeNoReadonly(doc, change, selUpdate) {
        if (change.text.length == 1 && change.text[0] == "" && posEq(change.from, change.to)) {
            return
        }
        var selAfter = computeSelAfterChange(doc, change, selUpdate);
        addToHistory(doc, change, selAfter, doc.cm ? doc.cm.curOp.id : NaN);
        makeChangeSingleDoc(doc, change, selAfter, stretchSpansOverChange(doc, change));
        var rebased = [];
        linkedDocs(doc, function (doc, sharedHist) {
            if (!sharedHist && indexOf(rebased, doc.history) == -1) {
                rebaseHist(doc.history, change);
                rebased.push(doc.history)
            }
            makeChangeSingleDoc(doc, change, null, stretchSpansOverChange(doc, change))
        })
    }
    function makeChangeFromHistory(doc, type) {
        if (doc.cm && doc.cm.state.suppressEdits) {
            return
        }
        var hist = doc.history;
        var event = (type == "undo" ? hist.done : hist.undone).pop();
        if (!event) {
            return
        }
        var anti = {
            changes: [],
            anchorBefore: event.anchorAfter,
            headBefore: event.headAfter,
            anchorAfter: event.anchorBefore,
            headAfter: event.headBefore,
            generation: hist.generation
        };
        (type == "undo" ? hist.undone : hist.done).push(anti);
        hist.generation = event.generation || ++hist.maxGeneration;
        var filter = hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange");
        for (var i = event.changes.length - 1; i >= 0; --i) {
            var change = event.changes[i];
            change.origin = type;
            if (filter && !filterChange(doc, change, false)) {
                (type == "undo" ? hist.done : hist.undone).length = 0;
                return
            }
            anti.changes.push(historyChangeFromChange(doc, change));
            var after = i ? computeSelAfterChange(doc, change, null) : {
                anchor: event.anchorBefore,
                head: event.headBefore
            };
            makeChangeSingleDoc(doc, change, after, mergeOldSpans(doc, change));
            var rebased = [];
            linkedDocs(doc, function (doc, sharedHist) {
                if (!sharedHist && indexOf(rebased, doc.history) == -1) {
                    rebaseHist(doc.history, change);
                    rebased.push(doc.history)
                }
                makeChangeSingleDoc(doc, change, null, mergeOldSpans(doc, change))
            })
        }
    }
    function shiftDoc(doc, distance) {
        function shiftPos(pos) {
            return Pos(pos.line + distance, pos.ch)
        }
        doc.first += distance;
        if (doc.cm) {
            regChange(doc.cm, doc.first, doc.first, distance)
        }
        doc.sel.head = shiftPos(doc.sel.head);
        doc.sel.anchor = shiftPos(doc.sel.anchor);
        doc.sel.from = shiftPos(doc.sel.from);
        doc.sel.to = shiftPos(doc.sel.to)
    }
    function makeChangeSingleDoc(doc, change, selAfter, spans) {
        if (doc.cm && !doc.cm.curOp) {
            return operation(doc.cm, makeChangeSingleDoc)(doc, change, selAfter, spans)
        }
        if (change.to.line < doc.first) {
            shiftDoc(doc, change.text.length - 1 - (change.to.line - change.from.line));
            return
        }
        if (change.from.line > doc.lastLine()) {
            return
        }
        if (change.from.line < doc.first) {
            var shift = change.text.length - 1 - (doc.first - change.from.line);
            shiftDoc(doc, shift);
            change = {
                from: Pos(doc.first, 0),
                to: Pos(change.to.line + shift, change.to.ch),
                text: [lst(change.text)],
                origin: change.origin
            }
        }
        var last = doc.lastLine();
        if (change.to.line > last) {
            change = {
                from: change.from,
                to: Pos(last, getLine(doc, last).text.length),
                text: [change.text[0]],
                origin: change.origin
            }
        }
        change.removed = getBetween(doc, change.from, change.to);
        if (!selAfter) {
            selAfter = computeSelAfterChange(doc, change, null)
        }
        if (doc.cm) {
            makeChangeSingleDocInEditor(doc.cm, change, spans, selAfter)
        } else {
            updateDoc(doc, change, spans, selAfter)
        }
    }
    function makeChangeSingleDocInEditor(cm, change, spans, selAfter) {
        var doc = cm.doc,
            display = cm.display,
            from = change.from,
            to = change.to;
        var recomputeMaxLength = false,
            checkWidthStart = from.line;
        if (!cm.options.lineWrapping) {
            checkWidthStart = lineNo(visualLine(doc, getLine(doc, from.line)));
            doc.iter(checkWidthStart, to.line + 1, function (line) {
                if (line == display.maxLine) {
                    recomputeMaxLength = true;
                    return true
                }
            })
        }
        if (!posLess(doc.sel.head, change.from) && !posLess(change.to, doc.sel.head)) {
            cm.curOp.cursorActivity = true
        }
        updateDoc(doc, change, spans, selAfter, estimateHeight(cm));
        if (!cm.options.lineWrapping) {
            doc.iter(checkWidthStart, from.line + change.text.length, function (line) {
                var len = lineLength(doc, line);
                if (len > display.maxLineLength) {
                    display.maxLine = line;
                    display.maxLineLength = len;
                    display.maxLineChanged = true;
                    recomputeMaxLength = false
                }
            });
            if (recomputeMaxLength) {
                cm.curOp.updateMaxLine = true
            }
        }
        doc.frontier = Math.min(doc.frontier, from.line);
        startWorker(cm, 400);
        var lendiff = change.text.length - (to.line - from.line) - 1;
        regChange(cm, from.line, to.line + 1, lendiff);
        if (hasHandler(cm, "change")) {
            var changeObj = {
                from: from,
                to: to,
                text: change.text,
                removed: change.removed,
                origin: change.origin
            };
            if (cm.curOp.textChanged) {
                for (var cur = cm.curOp.textChanged; cur.next; cur = cur.next) {}
                cur.next = changeObj
            } else {
                cm.curOp.textChanged = changeObj
            }
        }
    }
    function replaceRange(doc, code, from, to, origin) {
        if (!to) {
            to = from
        }
        if (posLess(to, from)) {
            var tmp = to;
            to = from;
            from = tmp
        }
        if (typeof code == "string") {
            code = splitLines(code)
        }
        makeChange(doc, {
            from: from,
            to: to,
            text: code,
            origin: origin
        }, null)
    }
    function Pos(line, ch) {
        if (!(this instanceof Pos)) {
            return new Pos(line, ch)
        }
        this.line = line;
        this.ch = ch
    }
    CodeMirror.Pos = Pos;

    function posEq(a, b) {
        return a.line == b.line && a.ch == b.ch
    }
    function posLess(a, b) {
        return a.line < b.line || (a.line == b.line && a.ch < b.ch)
    }
    function copyPos(x) {
        return Pos(x.line, x.ch)
    }
    function clipLine(doc, n) {
        return Math.max(doc.first, Math.min(n, doc.first + doc.size - 1))
    }
    function clipPos(doc, pos) {
        if (pos.line < doc.first) {
            return Pos(doc.first, 0)
        }
        var last = doc.first + doc.size - 1;
        if (pos.line > last) {
            return Pos(last, getLine(doc, last).text.length)
        }
        return clipToLen(pos, getLine(doc, pos.line).text.length)
    }
    function clipToLen(pos, linelen) {
        var ch = pos.ch;
        if (ch == null || ch > linelen) {
            return Pos(pos.line, linelen)
        } else {
            if (ch < 0) {
                return Pos(pos.line, 0)
            } else {
                return pos
            }
        }
    }
    function isLine(doc, l) {
        return l >= doc.first && l < doc.first + doc.size
    }
    function extendSelection(doc, pos, other, bias) {
        if (doc.sel.shift || doc.sel.extend) {
            var anchor = doc.sel.anchor;
            if (other) {
                var posBefore = posLess(pos, anchor);
                if (posBefore != posLess(other, anchor)) {
                    anchor = pos;
                    pos = other
                } else {
                    if (posBefore != posLess(pos, other)) {
                        pos = other
                    }
                }
            }
            setSelection(doc, anchor, pos, bias)
        } else {
            setSelection(doc, pos, other || pos, bias)
        }
        if (doc.cm) {
            doc.cm.curOp.userSelChange = true
        }
    }
    function filterSelectionChange(doc, anchor, head) {
        var obj = {
            anchor: anchor,
            head: head
        };
        signal(doc, "beforeSelectionChange", doc, obj);
        if (doc.cm) {
            signal(doc.cm, "beforeSelectionChange", doc.cm, obj)
        }
        obj.anchor = clipPos(doc, obj.anchor);
        obj.head = clipPos(doc, obj.head);
        return obj
    }
    function setSelection(doc, anchor, head, bias, checkAtomic) {
        if (!checkAtomic && hasHandler(doc, "beforeSelectionChange") || doc.cm && hasHandler(doc.cm, "beforeSelectionChange")) {
            var filtered = filterSelectionChange(doc, anchor, head);
            head = filtered.head;
            anchor = filtered.anchor
        }
        var sel = doc.sel;
        sel.goalColumn = null;
        if (bias == null) {
            bias = posLess(head, sel.head) ? -1 : 1
        }
        if (checkAtomic || !posEq(anchor, sel.anchor)) {
            anchor = skipAtomic(doc, anchor, bias, checkAtomic != "push")
        }
        if (checkAtomic || !posEq(head, sel.head)) {
            head = skipAtomic(doc, head, bias, checkAtomic != "push")
        }
        if (posEq(sel.anchor, anchor) && posEq(sel.head, head)) {
            return
        }
        sel.anchor = anchor;
        sel.head = head;
        var inv = posLess(head, anchor);
        sel.from = inv ? head : anchor;
        sel.to = inv ? anchor : head;
        if (doc.cm) {
            doc.cm.curOp.updateInput = doc.cm.curOp.selectionChanged = doc.cm.curOp.cursorActivity = true
        }
        signalLater(doc, "cursorActivity", doc)
    }
    function reCheckSelection(cm) {
        setSelection(cm.doc, cm.doc.sel.from, cm.doc.sel.to, null, "push")
    }
    function skipAtomic(doc, pos, bias, mayClear) {
        var flipped = false,
            curPos = pos;
        var dir = bias || 1;
        doc.cantEdit = false;
        search: for (;;) {
            var line = getLine(doc, curPos.line);
            if (line.markedSpans) {
                for (var i = 0; i < line.markedSpans.length; ++i) {
                    var sp = line.markedSpans[i],
                        m = sp.marker;
                    if ((sp.from == null || (m.inclusiveLeft ? sp.from <= curPos.ch : sp.from < curPos.ch)) && (sp.to == null || (m.inclusiveRight ? sp.to >= curPos.ch : sp.to > curPos.ch))) {
                        if (mayClear) {
                            signal(m, "beforeCursorEnter");
                            if (m.explicitlyCleared) {
                                if (!line.markedSpans) {
                                    break
                                } else {
                                    --i;
                                    continue
                                }
                            }
                        }
                        if (!m.atomic) {
                            continue
                        }
                        var newPos = m.find()[dir < 0 ? "from" : "to"];
                        if (posEq(newPos, curPos)) {
                            newPos.ch += dir;
                            if (newPos.ch < 0) {
                                if (newPos.line > doc.first) {
                                    newPos = clipPos(doc, Pos(newPos.line - 1))
                                } else {
                                    newPos = null
                                }
                            } else {
                                if (newPos.ch > line.text.length) {
                                    if (newPos.line < doc.first + doc.size - 1) {
                                        newPos = Pos(newPos.line + 1, 0)
                                    } else {
                                        newPos = null
                                    }
                                }
                            }
                            if (!newPos) {
                                if (flipped) {
                                    if (!mayClear) {
                                        return skipAtomic(doc, pos, bias, true)
                                    }
                                    doc.cantEdit = true;
                                    return Pos(doc.first, 0)
                                }
                                flipped = true;
                                newPos = pos;
                                dir = -dir
                            }
                        }
                        curPos = newPos;
                        continue search
                    }
                }
            }
            return curPos
        }
    }
    function scrollCursorIntoView(cm) {
        var coords = scrollPosIntoView(cm, cm.doc.sel.head, cm.options.cursorScrollMargin);
        if (!cm.state.focused) {
            return
        }
        var display = cm.display,
            box = getRect(display.sizer),
            doScroll = null;
        if (coords.top + box.top < 0) {
            doScroll = true
        } else {
            if (coords.bottom + box.top > (window.innerHeight || document.documentElement.clientHeight)) {
                doScroll = false
            }
        }
        if (doScroll != null && !phantom) {
            var hidden = display.cursor.style.display == "none";
            if (hidden) {
                display.cursor.style.display = "";
                display.cursor.style.left = coords.left + "px";
                display.cursor.style.top = (coords.top - display.viewOffset) + "px"
            }
            display.cursor.scrollIntoView(doScroll);
            if (hidden) {
                display.cursor.style.display = "none"
            }
        }
    }
    function scrollPosIntoView(cm, pos, margin) {
        if (margin == null) {
            margin = 0
        }
        for (;;) {
            var changed = false,
                coords = cursorCoords(cm, pos);
            var scrollPos = calculateScrollPos(cm, coords.left, coords.top - margin, coords.left, coords.bottom + margin);
            var startTop = cm.doc.scrollTop,
                startLeft = cm.doc.scrollLeft;
            if (scrollPos.scrollTop != null) {
                setScrollTop(cm, scrollPos.scrollTop);
                if (Math.abs(cm.doc.scrollTop - startTop) > 1) {
                    changed = true
                }
            }
            if (scrollPos.scrollLeft != null) {
                setScrollLeft(cm, scrollPos.scrollLeft);
                if (Math.abs(cm.doc.scrollLeft - startLeft) > 1) {
                    changed = true
                }
            }
            if (!changed) {
                return coords
            }
        }
    }
    function scrollIntoView(cm, x1, y1, x2, y2) {
        var scrollPos = calculateScrollPos(cm, x1, y1, x2, y2);
        if (scrollPos.scrollTop != null) {
            setScrollTop(cm, scrollPos.scrollTop)
        }
        if (scrollPos.scrollLeft != null) {
            setScrollLeft(cm, scrollPos.scrollLeft)
        }
    }
    function calculateScrollPos(cm, x1, y1, x2, y2) {
        var display = cm.display,
            snapMargin = textHeight(cm.display);
        if (y1 < 0) {
            y1 = 0
        }
        var screen = display.scroller.clientHeight - scrollerCutOff,
            screentop = display.scroller.scrollTop,
            result = {};
        var docBottom = cm.doc.height + paddingVert(display);
        var atTop = y1 < snapMargin,
            atBottom = y2 > docBottom - snapMargin;
        if (y1 < screentop) {
            result.scrollTop = atTop ? 0 : y1
        } else {
            if (y2 > screentop + screen) {
                var newTop = Math.min(y1, (atBottom ? docBottom : y2) - screen);
                if (newTop != screentop) {
                    result.scrollTop = newTop
                }
            }
        }
        var screenw = display.scroller.clientWidth - scrollerCutOff,
            screenleft = display.scroller.scrollLeft;
        x1 += display.gutters.offsetWidth;
        x2 += display.gutters.offsetWidth;
        var gutterw = display.gutters.offsetWidth;
        var atLeft = x1 < gutterw + 10;
        if (x1 < screenleft + gutterw || atLeft) {
            if (atLeft) {
                x1 = 0
            }
            result.scrollLeft = Math.max(0, x1 - 10 - gutterw)
        } else {
            if (x2 > screenw + screenleft - 3) {
                result.scrollLeft = x2 + 10 - screenw
            }
        }
        return result
    }
    function updateScrollPos(cm, left, top) {
        cm.curOp.updateScrollPos = {
            scrollLeft: left == null ? cm.doc.scrollLeft : left,
            scrollTop: top == null ? cm.doc.scrollTop : top
        }
    }
    function addToScrollPos(cm, left, top) {
        var pos = cm.curOp.updateScrollPos || (cm.curOp.updateScrollPos = {
            scrollLeft: cm.doc.scrollLeft,
            scrollTop: cm.doc.scrollTop
        });
        var scroll = cm.display.scroller;
        pos.scrollTop = Math.max(0, Math.min(scroll.scrollHeight - scroll.clientHeight, pos.scrollTop + top));
        pos.scrollLeft = Math.max(0, Math.min(scroll.scrollWidth - scroll.clientWidth, pos.scrollLeft + left))
    }
    function indentLine(cm, n, how, aggressive) {
        var doc = cm.doc;
        if (how == null) {
            how = "add"
        }
        if (how == "smart") {
            if (!cm.doc.mode.indent) {
                how = "prev"
            } else {
                var state = getStateBefore(cm, n)
            }
        }
        var tabSize = cm.options.tabSize;
        var line = getLine(doc, n),
            curSpace = countColumn(line.text, null, tabSize);
        var curSpaceString = line.text.match(/^\s*/)[0],
            indentation;
        if (how == "smart") {
            indentation = cm.doc.mode.indent(state, line.text.slice(curSpaceString.length), line.text);
            if (indentation == Pass) {
                if (!aggressive) {
                    return
                }
                how = "prev"
            }
        }
        if (how == "prev") {
            if (n > doc.first) {
                indentation = countColumn(getLine(doc, n - 1).text, null, tabSize)
            } else {
                indentation = 0
            }
        } else {
            if (how == "add") {
                indentation = curSpace + cm.options.indentUnit
            } else {
                if (how == "subtract") {
                    indentation = curSpace - cm.options.indentUnit
                } else {
                    if (typeof how == "number") {
                        indentation = curSpace + how
                    }
                }
            }
        }
        indentation = Math.max(0, indentation);
        var indentString = "",
            pos = 0;
        if (cm.options.indentWithTabs) {
            for (var i = Math.floor(indentation / tabSize); i; --i) {
                pos += tabSize;
                indentString += "\t"
            }
        }
        if (pos < indentation) {
            indentString += spaceStr(indentation - pos)
        }
        if (indentString != curSpaceString) {
            replaceRange(cm.doc, indentString, Pos(n, 0), Pos(n, curSpaceString.length), "+input")
        }
        line.stateAfter = null
    }
    function changeLine(cm, handle, op) {
        var no = handle,
            line = handle,
            doc = cm.doc;
        if (typeof handle == "number") {
            line = getLine(doc, clipLine(doc, handle))
        } else {
            no = lineNo(handle)
        }
        if (no == null) {
            return null
        }
        if (op(line, no)) {
            regChange(cm, no, no + 1)
        } else {
            return null
        }
        return line
    }
    function findPosH(doc, pos, dir, unit, visually) {
        var line = pos.line,
            ch = pos.ch,
            origDir = dir;
        var lineObj = getLine(doc, line);
        var possible = true;

        function findNextLine() {
            var l = line + dir;
            if (l < doc.first || l >= doc.first + doc.size) {
                return (possible = false)
            }
            line = l;
            return lineObj = getLine(doc, l)
        }
        function moveOnce(boundToLine) {
            var next = (visually ? moveVisually : moveLogically)(lineObj, ch, dir, true);
            if (next == null) {
                if (!boundToLine && findNextLine()) {
                    if (visually) {
                        ch = (dir < 0 ? lineRight : lineLeft)(lineObj)
                    } else {
                        ch = dir < 0 ? lineObj.text.length : 0
                    }
                } else {
                    return (possible = false)
                }
            } else {
                ch = next
            }
            return true
        }
        if (unit == "char") {
            moveOnce()
        } else {
            if (unit == "column") {
                moveOnce(true)
            } else {
                if (unit == "word" || unit == "group") {
                    var sawType = null,
                        group = unit == "group";
                    for (var first = true;; first = false) {
                        if (dir < 0 && !moveOnce(!first)) {
                            break
                        }
                        var cur = lineObj.text.charAt(ch) || "\n";
                        var type = isWordChar(cur) ? "w" : !group ? null : /\s/.test(cur) ? null : "p";
                        if (sawType && sawType != type) {
                            if (dir < 0) {
                                dir = 1;
                                moveOnce()
                            }
                            break
                        }
                        if (type) {
                            sawType = type
                        }
                        if (dir > 0 && !moveOnce(!first)) {
                            break
                        }
                    }
                }
            }
        }
        var result = skipAtomic(doc, Pos(line, ch), origDir, true);
        if (!possible) {
            result.hitSide = true
        }
        return result
    }
    function findPosV(cm, pos, dir, unit) {
        var doc = cm.doc,
            x = pos.left,
            y;
        if (unit == "page") {
            var pageSize = Math.min(cm.display.wrapper.clientHeight, window.innerHeight || document.documentElement.clientHeight);
            y = pos.top + dir * (pageSize - (dir < 0 ? 1.5 : 0.5) * textHeight(cm.display))
        } else {
            if (unit == "line") {
                y = dir > 0 ? pos.bottom + 3 : pos.top - 3
            }
        }
        for (;;) {
            var target = coordsChar(cm, x, y);
            if (!target.outside) {
                break
            }
            if (dir < 0 ? y <= 0 : y >= doc.height) {
                target.hitSide = true;
                break
            }
            y += dir * 5
        }
        return target
    }
    function findWordAt(line, pos) {
        var start = pos.ch,
            end = pos.ch;
        if (line) {
            if ((pos.xRel < 0 || end == line.length) && start) {
                --start
            } else {
                ++end
            }
            var startChar = line.charAt(start);
            var check = isWordChar(startChar) ? isWordChar : /\s/.test(startChar) ?
            function (ch) {
                return /\s/.test(ch)
            } : function (ch) {
                return !/\s/.test(ch) && !isWordChar(ch)
            };
            while (start > 0 && check(line.charAt(start - 1))) {
                --start
            }
            while (end < line.length && check(line.charAt(end))) {
                ++end
            }
        }
        return {
            from: Pos(pos.line, start),
            to: Pos(pos.line, end)
        }
    }
    function selectLine(cm, line) {
        extendSelection(cm.doc, Pos(line, 0), clipPos(cm.doc, Pos(line + 1, 0)))
    }
    CodeMirror.prototype = {
        constructor: CodeMirror,
        focus: function () {
            window.focus();
            focusInput(this);
            onFocus(this);
            fastPoll(this)
        },
        setOption: function (option, value) {
            var options = this.options,
                old = options[option];
            if (options[option] == value && option != "mode") {
                return
            }
            options[option] = value;
            if (optionHandlers.hasOwnProperty(option)) {
                operation(this, optionHandlers[option])(this, value, old)
            }
        },
        getOption: function (option) {
            return this.options[option]
        },
        getDoc: function () {
            return this.doc
        },
        addKeyMap: function (map, bottom) {
            this.state.keyMaps[bottom ? "push" : "unshift"](map)
        },
        removeKeyMap: function (map) {
            var maps = this.state.keyMaps;
            for (var i = 0; i < maps.length; ++i) {
                if (maps[i] == map || (typeof maps[i] != "string" && maps[i].name == map)) {
                    maps.splice(i, 1);
                    return true
                }
            }
        },
        addOverlay: operation(null, function (spec, options) {
            var mode = spec.token ? spec : CodeMirror.getMode(this.options, spec);
            if (mode.startState) {
                throw new Error("Overlays may not be stateful.")
            }
            this.state.overlays.push({
                mode: mode,
                modeSpec: spec,
                opaque: options && options.opaque
            });
            this.state.modeGen++;
            regChange(this)
        }),
        removeOverlay: operation(null, function (spec) {
            var overlays = this.state.overlays;
            for (var i = 0; i < overlays.length; ++i) {
                var cur = overlays[i].modeSpec;
                if (cur == spec || typeof spec == "string" && cur.name == spec) {
                    overlays.splice(i, 1);
                    this.state.modeGen++;
                    regChange(this);
                    return
                }
            }
        }),
        indentLine: operation(null, function (n, dir, aggressive) {
            if (typeof dir != "string" && typeof dir != "number") {
                if (dir == null) {
                    dir = this.options.smartIndent ? "smart" : "prev"
                } else {
                    dir = dir ? "add" : "subtract"
                }
            }
            if (isLine(this.doc, n)) {
                indentLine(this, n, dir, aggressive)
            }
        }),
        indentSelection: operation(null, function (how) {
            var sel = this.doc.sel;
            if (posEq(sel.from, sel.to)) {
                return indentLine(this, sel.from.line, how)
            }
            var e = sel.to.line - (sel.to.ch ? 0 : 1);
            for (var i = sel.from.line; i <= e; ++i) {
                indentLine(this, i, how)
            }
        }),
        getTokenAt: function (pos, precise) {
            var doc = this.doc;
            pos = clipPos(doc, pos);
            var state = getStateBefore(this, pos.line, precise),
                mode = this.doc.mode;
            var line = getLine(doc, pos.line);
            var stream = new StringStream(line.text, this.options.tabSize);
            while (stream.pos < pos.ch && !stream.eol()) {
                stream.start = stream.pos;
                var style = mode.token(stream, state)
            }
            return {
                start: stream.start,
                end: stream.pos,
                string: stream.current(),
                className: style || null,
                type: style || null,
                state: state
            }
        },
        getTokenTypeAt: function (pos) {
            pos = clipPos(this.doc, pos);
            var styles = getLineStyles(this, getLine(this.doc, pos.line));
            var before = 0,
                after = (styles.length - 1) / 2,
                ch = pos.ch;
            if (ch == 0) {
                return styles[2]
            }
            for (;;) {
                var mid = (before + after) >> 1;
                if ((mid ? styles[mid * 2 - 1] : 0) >= ch) {
                    after = mid
                } else {
                    if (styles[mid * 2 + 1] < ch) {
                        before = mid + 1
                    } else {
                        return styles[mid * 2 + 2]
                    }
                }
            }
        },
        getModeAt: function (pos) {
            var mode = this.doc.mode;
            if (!mode.innerMode) {
                return mode
            }
            return CodeMirror.innerMode(mode, this.getTokenAt(pos).state).mode
        },
        getHelper: function (pos, type) {
            if (!helpers.hasOwnProperty(type)) {
                return
            }
            var help = helpers[type],
                mode = this.getModeAt(pos);
            return mode[type] && help[mode[type]] || mode.helperType && help[mode.helperType] || help[mode.name]
        },
        getStateAfter: function (line, precise) {
            var doc = this.doc;
            line = clipLine(doc, line == null ? doc.first + doc.size - 1 : line);
            return getStateBefore(this, line + 1, precise)
        },
        cursorCoords: function (start, mode) {
            var pos, sel = this.doc.sel;
            if (start == null) {
                pos = sel.head
            } else {
                if (typeof start == "object") {
                    pos = clipPos(this.doc, start)
                } else {
                    pos = start ? sel.from : sel.to
                }
            }
            return cursorCoords(this, pos, mode || "page")
        },
        charCoords: function (pos, mode) {
            return charCoords(this, clipPos(this.doc, pos), mode || "page")
        },
        coordsChar: function (coords, mode) {
            coords = fromCoordSystem(this, coords, mode || "page");
            return coordsChar(this, coords.left, coords.top)
        },
        lineAtHeight: function (height, mode) {
            height = fromCoordSystem(this, {
                top: height,
                left: 0
            }, mode || "page").top;
            return lineAtHeight(this.doc, height + this.display.viewOffset)
        },
        heightAtLine: function (line, mode) {
            var end = false,
                last = this.doc.first + this.doc.size - 1;
            if (line < this.doc.first) {
                line = this.doc.first
            } else {
                if (line > last) {
                    line = last;
                    end = true
                }
            }
            var lineObj = getLine(this.doc, line);
            return intoCoordSystem(this, getLine(this.doc, line), {
                top: 0,
                left: 0
            }, mode || "page").top + (end ? lineObj.height : 0)
        },
        defaultTextHeight: function () {
            return textHeight(this.display)
        },
        defaultCharWidth: function () {
            return charWidth(this.display)
        },
        setGutterMarker: operation(null, function (line, gutterID, value) {
            return changeLine(this, line, function (line) {
                var markers = line.gutterMarkers || (line.gutterMarkers = {});
                markers[gutterID] = value;
                if (!value && isEmpty(markers)) {
                    line.gutterMarkers = null
                }
                return true
            })
        }),
        clearGutter: operation(null, function (gutterID) {
            var cm = this,
                doc = cm.doc,
                i = doc.first;
            doc.iter(function (line) {
                if (line.gutterMarkers && line.gutterMarkers[gutterID]) {
                    line.gutterMarkers[gutterID] = null;
                    regChange(cm, i, i + 1);
                    if (isEmpty(line.gutterMarkers)) {
                        line.gutterMarkers = null
                    }
                }++i
            })
        }),
        addLineClass: operation(null, function (handle, where, cls) {
            return changeLine(this, handle, function (line) {
                var prop = where == "text" ? "textClass" : where == "background" ? "bgClass" : "wrapClass";
                if (!line[prop]) {
                    line[prop] = cls
                } else {
                    if (new RegExp("(?:^|\\s)" + cls + "(?:$|\\s)").test(line[prop])) {
                        return false
                    } else {
                        line[prop] += " " + cls
                    }
                }
                return true
            })
        }),
        removeLineClass: operation(null, function (handle, where, cls) {
            return changeLine(this, handle, function (line) {
                var prop = where == "text" ? "textClass" : where == "background" ? "bgClass" : "wrapClass";
                var cur = line[prop];
                if (!cur) {
                    return false
                } else {
                    if (cls == null) {
                        line[prop] = null
                    } else {
                        var found = cur.match(new RegExp("(?:^|\\s+)" + cls + "(?:$|\\s+)"));
                        if (!found) {
                            return false
                        }
                        var end = found.index + found[0].length;
                        line[prop] = cur.slice(0, found.index) + (!found.index || end == cur.length ? "" : " ") + cur.slice(end) || null
                    }
                }
                return true
            })
        }),
        addLineWidget: operation(null, function (handle, node, options) {
            return addLineWidget(this, handle, node, options)
        }),
        removeLineWidget: function (widget) {
            widget.clear()
        },
        lineInfo: function (line) {
            if (typeof line == "number") {
                if (!isLine(this.doc, line)) {
                    return null
                }
                var n = line;
                line = getLine(this.doc, line);
                if (!line) {
                    return null
                }
            } else {
                var n = lineNo(line);
                if (n == null) {
                    return null
                }
            }
            return {
                line: n,
                handle: line,
                text: line.text,
                gutterMarkers: line.gutterMarkers,
                textClass: line.textClass,
                bgClass: line.bgClass,
                wrapClass: line.wrapClass,
                widgets: line.widgets
            }
        },
        getViewport: function () {
            return {
                from: this.display.showingFrom,
                to: this.display.showingTo
            }
        },
        addWidget: function (pos, node, scroll, vert, horiz) {
            var display = this.display;
            pos = cursorCoords(this, clipPos(this.doc, pos));
            var top = pos.bottom,
                left = pos.left;
            node.style.position = "absolute";
            display.sizer.appendChild(node);
            if (vert == "over") {
                top = pos.top
            } else {
                if (vert == "above" || vert == "near") {
                    var vspace = Math.max(display.wrapper.clientHeight, this.doc.height),
                        hspace = Math.max(display.sizer.clientWidth, display.lineSpace.clientWidth);
                    if ((vert == "above" || pos.bottom + node.offsetHeight > vspace) && pos.top > node.offsetHeight) {
                        top = pos.top - node.offsetHeight
                    } else {
                        if (pos.bottom + node.offsetHeight <= vspace) {
                            top = pos.bottom
                        }
                    }
                    if (left + node.offsetWidth > hspace) {
                        left = hspace - node.offsetWidth
                    }
                }
            }
            node.style.top = top + "px";
            node.style.left = node.style.right = "";
            if (horiz == "right") {
                left = display.sizer.clientWidth - node.offsetWidth;
                node.style.right = "0px"
            } else {
                if (horiz == "left") {
                    left = 0
                } else {
                    if (horiz == "middle") {
                        left = (display.sizer.clientWidth - node.offsetWidth) / 2
                    }
                }
                node.style.left = left + "px"
            }
            if (scroll) {
                scrollIntoView(this, left, top, left + node.offsetWidth, top + node.offsetHeight)
            }
        },
        triggerOnKeyDown: operation(null, onKeyDown),
        execCommand: function (cmd) {
            return commands[cmd](this)
        },
        findPosH: function (from, amount, unit, visually) {
            var dir = 1;
            if (amount < 0) {
                dir = -1;
                amount = -amount
            }
            for (var i = 0, cur = clipPos(this.doc, from); i < amount; ++i) {
                cur = findPosH(this.doc, cur, dir, unit, visually);
                if (cur.hitSide) {
                    break
                }
            }
            return cur
        },
        moveH: operation(null, function (dir, unit) {
            var sel = this.doc.sel,
                pos;
            if (sel.shift || sel.extend || posEq(sel.from, sel.to)) {
                pos = findPosH(this.doc, sel.head, dir, unit, this.options.rtlMoveVisually)
            } else {
                pos = dir < 0 ? sel.from : sel.to
            }
            extendSelection(this.doc, pos, pos, dir)
        }),
        deleteH: operation(null, function (dir, unit) {
            var sel = this.doc.sel;
            if (!posEq(sel.from, sel.to)) {
                replaceRange(this.doc, "", sel.from, sel.to, "+delete")
            } else {
                replaceRange(this.doc, "", sel.from, findPosH(this.doc, sel.head, dir, unit, false), "+delete")
            }
            this.curOp.userSelChange = true
        }),
        findPosV: function (from, amount, unit, goalColumn) {
            var dir = 1,
                x = goalColumn;
            if (amount < 0) {
                dir = -1;
                amount = -amount
            }
            for (var i = 0, cur = clipPos(this.doc, from); i < amount; ++i) {
                var coords = cursorCoords(this, cur, "div");
                if (x == null) {
                    x = coords.left
                } else {
                    coords.left = x
                }
                cur = findPosV(this, coords, dir, unit);
                if (cur.hitSide) {
                    break
                }
            }
            return cur
        },
        moveV: operation(null, function (dir, unit) {
            var sel = this.doc.sel;
            var pos = cursorCoords(this, sel.head, "div");
            if (sel.goalColumn != null) {
                pos.left = sel.goalColumn
            }
            var target = findPosV(this, pos, dir, unit);
            if (unit == "page") {
                addToScrollPos(this, 0, charCoords(this, target, "div").top - pos.top)
            }
            extendSelection(this.doc, target, target, dir);
            sel.goalColumn = pos.left
        }),
        toggleOverwrite: function (value) {
            if (value != null && value == this.state.overwrite) {
                return
            }
            if (this.state.overwrite = !this.state.overwrite) {
                this.display.cursor.className += " CodeMirror-overwrite"
            } else {
                this.display.cursor.className = this.display.cursor.className.replace(" CodeMirror-overwrite", "")
            }
        },
        hasFocus: function () {
            return this.state.focused
        },
        scrollTo: operation(null, function (x, y) {
            updateScrollPos(this, x, y)
        }),
        getScrollInfo: function () {
            var scroller = this.display.scroller,
                co = scrollerCutOff;
            return {
                left: scroller.scrollLeft,
                top: scroller.scrollTop,
                height: scroller.scrollHeight - co,
                width: scroller.scrollWidth - co,
                clientHeight: scroller.clientHeight - co,
                clientWidth: scroller.clientWidth - co
            }
        },
        scrollIntoView: operation(null, function (pos, margin) {
            if (typeof pos == "number") {
                pos = Pos(pos, 0)
            }
            if (!margin) {
                margin = 0
            }
            var coords = pos;
            if (!pos || pos.line != null) {
                this.curOp.scrollToPos = pos ? clipPos(this.doc, pos) : this.doc.sel.head;
                this.curOp.scrollToPosMargin = margin;
                coords = cursorCoords(this, this.curOp.scrollToPos)
            }
            var sPos = calculateScrollPos(this, coords.left, coords.top - margin, coords.right, coords.bottom + margin);
            updateScrollPos(this, sPos.scrollLeft, sPos.scrollTop)
        }),
        setSize: operation(null, function (width, height) {
            function interpret(val) {
                return typeof val == "number" || /^\d+$/.test(String(val)) ? val + "px" : val
            }
            if (width != null) {
                this.display.wrapper.style.width = interpret(width)
            }
            if (height != null) {
                this.display.wrapper.style.height = interpret(height)
            }
            if (this.options.lineWrapping) {
                this.display.measureLineCache.length = this.display.measureLineCachePos = 0
            }
            this.curOp.forceUpdate = true
        }),
        operation: function (f) {
            return runInOp(this, f)
        },
        refresh: operation(null, function () {
            var badHeight = this.display.cachedTextHeight == null;
            clearCaches(this);
            updateScrollPos(this, this.doc.scrollLeft, this.doc.scrollTop);
            regChange(this);
            if (badHeight) {
                estimateLineHeights(this)
            }
        }),
        swapDoc: operation(null, function (doc) {
            var old = this.doc;
            old.cm = null;
            attachDoc(this, doc);
            clearCaches(this);
            resetInput(this, true);
            updateScrollPos(this, doc.scrollLeft, doc.scrollTop);
            return old
        }),
        getInputField: function () {
            return this.display.input
        },
        getWrapperElement: function () {
            return this.display.wrapper
        },
        getScrollerElement: function () {
            return this.display.scroller
        },
        getGutterElement: function () {
            return this.display.gutters
        }
    };
    eventMixin(CodeMirror);
    var optionHandlers = CodeMirror.optionHandlers = {};
    var defaults = CodeMirror.defaults = {};

    function option(name, deflt, handle, notOnInit) {
        CodeMirror.defaults[name] = deflt;
        if (handle) {
            optionHandlers[name] = notOnInit ?
            function (cm, val, old) {
                if (old != Init) {
                    handle(cm, val, old)
                }
            } : handle
        }
    }
    var Init = CodeMirror.Init = {
        toString: function () {
            return "CodeMirror.Init"
        }
    };
    option("value", "", function (cm, val) {
        cm.setValue(val)
    }, true);
    option("mode", null, function (cm, val) {
        cm.doc.modeOption = val;
        loadMode(cm)
    }, true);
    option("indentUnit", 2, loadMode, true);
    option("indentWithTabs", false);
    option("smartIndent", true);
    option("tabSize", 4, function (cm) {
        loadMode(cm);
        clearCaches(cm);
        regChange(cm)
    }, true);
    option("electricChars", true);
    option("rtlMoveVisually", !windows);
    option("theme", "default", function (cm) {
        themeChanged(cm);
        guttersChanged(cm)
    }, true);
    option("keyMap", "default", keyMapChanged);
    option("extraKeys", null);
    option("onKeyEvent", null);
    option("onDragEvent", null);
    option("lineWrapping", false, wrappingChanged, true);
    option("gutters", [], function (cm) {
        setGuttersForLineNumbers(cm.options);
        guttersChanged(cm)
    }, true);
    option("fixedGutter", true, function (cm, val) {
        cm.display.gutters.style.left = val ? compensateForHScroll(cm.display) + "px" : "0";
        cm.refresh()
    }, true);
    option("coverGutterNextToScrollbar", false, updateScrollbars, true);
    option("lineNumbers", false, function (cm) {
        setGuttersForLineNumbers(cm.options);
        guttersChanged(cm)
    }, true);
    option("firstLineNumber", 1, guttersChanged, true);
    option("lineNumberFormatter", function (integer) {
        return integer
    }, guttersChanged, true);
    option("showCursorWhenSelecting", false, updateSelection, true);
    option("readOnly", false, function (cm, val) {
        if (val == "nocursor") {
            onBlur(cm);
            cm.display.input.blur()
        } else {
            if (!val) {
                resetInput(cm, true)
            }
        }
    });
    option("dragDrop", true);
    option("cursorBlinkRate", 530);
    option("cursorScrollMargin", 0);
    option("cursorHeight", 1);
    option("workTime", 100);
    option("workDelay", 100);
    option("flattenSpans", true);
    option("pollInterval", 100);
    option("undoDepth", 40, function (cm, val) {
        cm.doc.history.undoDepth = val
    });
    option("historyEventDelay", 500);
    option("viewportMargin", 10, function (cm) {
        cm.refresh()
    }, true);
    option("maxHighlightLength", 10000, function (cm) {
        loadMode(cm);
        cm.refresh()
    }, true);
    option("crudeMeasuringFrom", 10000);
    option("moveInputWithCursor", true, function (cm, val) {
        if (!val) {
            cm.display.inputDiv.style.top = cm.display.inputDiv.style.left = 0
        }
    });
    option("tabindex", null, function (cm, val) {
        cm.display.input.tabIndex = val || ""
    });
    option("autofocus", null);
    var modes = CodeMirror.modes = {},
        mimeModes = CodeMirror.mimeModes = {};
    CodeMirror.defineMode = function (name, mode) {
        if (!CodeMirror.defaults.mode && name != "null") {
            CodeMirror.defaults.mode = name
        }
        if (arguments.length > 2) {
            mode.dependencies = [];
            for (var i = 2; i < arguments.length; ++i) {
                mode.dependencies.push(arguments[i])
            }
        }
        modes[name] = mode
    };
    CodeMirror.defineMIME = function (mime, spec) {
        mimeModes[mime] = spec
    };
    CodeMirror.resolveMode = function (spec) {
        if (typeof spec == "string" && mimeModes.hasOwnProperty(spec)) {
            spec = mimeModes[spec]
        } else {
            if (spec && typeof spec.name == "string" && mimeModes.hasOwnProperty(spec.name)) {
                var found = mimeModes[spec.name];
                spec = createObj(found, spec);
                spec.name = found.name
            } else {
                if (typeof spec == "string" && /^[\w\-]+\/[\w\-]+\+xml$/.test(spec)) {
                    return CodeMirror.resolveMode("application/xml")
                }
            }
        }
        if (typeof spec == "string") {
            return {
                name: spec
            }
        } else {
            return spec || {
                name: "null"
            }
        }
    };
    CodeMirror.getMode = function (options, spec) {
        var spec = CodeMirror.resolveMode(spec);
        var mfactory = modes[spec.name];
        if (!mfactory) {
            return CodeMirror.getMode(options, "text/plain")
        }
        var modeObj = mfactory(options, spec);
        if (modeExtensions.hasOwnProperty(spec.name)) {
            var exts = modeExtensions[spec.name];
            for (var prop in exts) {
                if (!exts.hasOwnProperty(prop)) {
                    continue
                }
                if (modeObj.hasOwnProperty(prop)) {
                    modeObj["_" + prop] = modeObj[prop]
                }
                modeObj[prop] = exts[prop]
            }
        }
        modeObj.name = spec.name;
        return modeObj
    };
    CodeMirror.defineMode("null", function () {
        return {
            token: function (stream) {
                stream.skipToEnd()
            }
        }
    });
    CodeMirror.defineMIME("text/plain", "null");
    var modeExtensions = CodeMirror.modeExtensions = {};
    CodeMirror.extendMode = function (mode, properties) {
        var exts = modeExtensions.hasOwnProperty(mode) ? modeExtensions[mode] : (modeExtensions[mode] = {});
        copyObj(properties, exts)
    };
    CodeMirror.defineExtension = function (name, func) {
        CodeMirror.prototype[name] = func
    };
    CodeMirror.defineDocExtension = function (name, func) {
        Doc.prototype[name] = func
    };
    CodeMirror.defineOption = option;
    var initHooks = [];
    CodeMirror.defineInitHook = function (f) {
        initHooks.push(f)
    };
    var helpers = CodeMirror.helpers = {};
    CodeMirror.registerHelper = function (type, name, value) {
        if (!helpers.hasOwnProperty(type)) {
            helpers[type] = CodeMirror[type] = {}
        }
        helpers[type][name] = value
    };
    CodeMirror.isWordChar = isWordChar;

    function copyState(mode, state) {
        if (state === true) {
            return state
        }
        if (mode.copyState) {
            return mode.copyState(state)
        }
        var nstate = {};
        for (var n in state) {
            var val = state[n];
            if (val instanceof Array) {
                val = val.concat([])
            }
            nstate[n] = val
        }
        return nstate
    }
    CodeMirror.copyState = copyState;

    function startState(mode, a1, a2) {
        return mode.startState ? mode.startState(a1, a2) : true
    }
    CodeMirror.startState = startState;
    CodeMirror.innerMode = function (mode, state) {
        while (mode.innerMode) {
            var info = mode.innerMode(state);
            if (!info || info.mode == mode) {
                break
            }
            state = info.state;
            mode = info.mode
        }
        return info || {
            mode: mode,
            state: state
        }
    };
    var commands = CodeMirror.commands = {
        selectAll: function (cm) {
            cm.setSelection(Pos(cm.firstLine(), 0), Pos(cm.lastLine()))
        },
        killLine: function (cm) {
            var from = cm.getCursor(true),
                to = cm.getCursor(false),
                sel = !posEq(from, to);
            if (!sel && cm.getLine(from.line).length == from.ch) {
                cm.replaceRange("", from, Pos(from.line + 1, 0), "+delete")
            } else {
                cm.replaceRange("", from, sel ? to : Pos(from.line), "+delete")
            }
        },
        deleteLine: function (cm) {
            var l = cm.getCursor().line;
            cm.replaceRange("", Pos(l, 0), Pos(l), "+delete")
        },
        delLineLeft: function (cm) {
            var cur = cm.getCursor();
            cm.replaceRange("", Pos(cur.line, 0), cur, "+delete")
        },
        undo: function (cm) {
            cm.undo()
        },
        redo: function (cm) {
            cm.redo()
        },
        goDocStart: function (cm) {
            cm.extendSelection(Pos(cm.firstLine(), 0))
        },
        goDocEnd: function (cm) {
            cm.extendSelection(Pos(cm.lastLine()))
        },
        goLineStart: function (cm) {
            cm.extendSelection(lineStart(cm, cm.getCursor().line))
        },
        goLineStartSmart: function (cm) {
            var cur = cm.getCursor(),
                start = lineStart(cm, cur.line);
            var line = cm.getLineHandle(start.line);
            var order = getOrder(line);
            if (!order || order[0].level == 0) {
                var firstNonWS = Math.max(0, line.text.search(/\S/));
                var inWS = cur.line == start.line && cur.ch <= firstNonWS && cur.ch;
                cm.extendSelection(Pos(start.line, inWS ? 0 : firstNonWS))
            } else {
                cm.extendSelection(start)
            }
        },
        goLineEnd: function (cm) {
            cm.extendSelection(lineEnd(cm, cm.getCursor().line))
        },
        goLineRight: function (cm) {
            var top = cm.charCoords(cm.getCursor(), "div").top + 5;
            cm.extendSelection(cm.coordsChar({
                left: cm.display.lineDiv.offsetWidth + 100,
                top: top
            }, "div"))
        },
        goLineLeft: function (cm) {
            var top = cm.charCoords(cm.getCursor(), "div").top + 5;
            cm.extendSelection(cm.coordsChar({
                left: 0,
                top: top
            }, "div"))
        },
        goLineUp: function (cm) {
            cm.moveV(-1, "line")
        },
        goLineDown: function (cm) {
            cm.moveV(1, "line")
        },
        goPageUp: function (cm) {
            cm.moveV(-1, "page")
        },
        goPageDown: function (cm) {
            cm.moveV(1, "page")
        },
        goCharLeft: function (cm) {
            cm.moveH(-1, "char")
        },
        goCharRight: function (cm) {
            cm.moveH(1, "char")
        },
        goColumnLeft: function (cm) {
            cm.moveH(-1, "column")
        },
        goColumnRight: function (cm) {
            cm.moveH(1, "column")
        },
        goWordLeft: function (cm) {
            cm.moveH(-1, "word")
        },
        goGroupRight: function (cm) {
            cm.moveH(1, "group")
        },
        goGroupLeft: function (cm) {
            cm.moveH(-1, "group")
        },
        goWordRight: function (cm) {
            cm.moveH(1, "word")
        },
        delCharBefore: function (cm) {
            cm.deleteH(-1, "char")
        },
        delCharAfter: function (cm) {
            cm.deleteH(1, "char")
        },
        delWordBefore: function (cm) {
            cm.deleteH(-1, "word")
        },
        delWordAfter: function (cm) {
            cm.deleteH(1, "word")
        },
        delGroupBefore: function (cm) {
            cm.deleteH(-1, "group")
        },
        delGroupAfter: function (cm) {
            cm.deleteH(1, "group")
        },
        indentAuto: function (cm) {
            cm.indentSelection("smart")
        },
        indentMore: function (cm) {
            cm.indentSelection("add")
        },
        indentLess: function (cm) {
            cm.indentSelection("subtract")
        },
        insertTab: function (cm) {
            cm.replaceSelection("\t", "end", "+input")
        },
        defaultTab: function (cm) {
            if (cm.somethingSelected()) {
                cm.indentSelection("add")
            } else {
                cm.replaceSelection("\t", "end", "+input")
            }
        },
        transposeChars: function (cm) {
            var cur = cm.getCursor(),
                line = cm.getLine(cur.line);
            if (cur.ch > 0 && cur.ch < line.length - 1) {
                cm.replaceRange(line.charAt(cur.ch) + line.charAt(cur.ch - 1), Pos(cur.line, cur.ch - 1), Pos(cur.line, cur.ch + 1))
            }
        },
        newlineAndIndent: function (cm) {
            operation(cm, function () {
                cm.replaceSelection("\n", "end", "+input");
                cm.indentLine(cm.getCursor().line, null, true)
            })()
        },
        toggleOverwrite: function (cm) {
            cm.toggleOverwrite()
        }
    };
    var keyMap = CodeMirror.keyMap = {};
    keyMap.basic = {
        Left: "goCharLeft",
        Right: "goCharRight",
        Up: "goLineUp",
        Down: "goLineDown",
        End: "goLineEnd",
        Home: "goLineStartSmart",
        PageUp: "goPageUp",
        PageDown: "goPageDown",
        Delete: "delCharAfter",
        Backspace: "delCharBefore",
        Tab: "defaultTab",
        "Shift-Tab": "indentAuto",
        Enter: "newlineAndIndent",
        Insert: "toggleOverwrite"
    };
    keyMap.pcDefault = {
        "Ctrl-A": "selectAll",
        "Ctrl-D": "deleteLine",
        "Ctrl-Z": "undo",
        "Shift-Ctrl-Z": "redo",
        "Ctrl-Y": "redo",
        "Ctrl-Home": "goDocStart",
        "Alt-Up": "goDocStart",
        "Ctrl-End": "goDocEnd",
        "Ctrl-Down": "goDocEnd",
        "Ctrl-Left": "goGroupLeft",
        "Ctrl-Right": "goGroupRight",
        "Alt-Left": "goLineStart",
        "Alt-Right": "goLineEnd",
        "Ctrl-Backspace": "delGroupBefore",
        "Ctrl-Delete": "delGroupAfter",
        "Ctrl-S": "save",
        "Ctrl-F": "find",
        "Ctrl-G": "findNext",
        "Shift-Ctrl-G": "findPrev",
        "Shift-Ctrl-F": "replace",
        "Shift-Ctrl-R": "replaceAll",
        "Ctrl-[": "indentLess",
        "Ctrl-]": "indentMore",
        fallthrough: "basic"
    };
    keyMap.macDefault = {
        "Cmd-A": "selectAll",
        "Cmd-D": "deleteLine",
        "Cmd-Z": "undo",
        "Shift-Cmd-Z": "redo",
        "Cmd-Y": "redo",
        "Cmd-Up": "goDocStart",
        "Cmd-End": "goDocEnd",
        "Cmd-Down": "goDocEnd",
        "Alt-Left": "goGroupLeft",
        "Alt-Right": "goGroupRight",
        "Cmd-Left": "goLineStart",
        "Cmd-Right": "goLineEnd",
        "Alt-Backspace": "delGroupBefore",
        "Ctrl-Alt-Backspace": "delGroupAfter",
        "Alt-Delete": "delGroupAfter",
        "Cmd-S": "save",
        "Cmd-F": "find",
        "Cmd-G": "findNext",
        "Shift-Cmd-G": "findPrev",
        "Cmd-Alt-F": "replace",
        "Shift-Cmd-Alt-F": "replaceAll",
        "Cmd-[": "indentLess",
        "Cmd-]": "indentMore",
        "Cmd-Backspace": "delLineLeft",
        fallthrough: ["basic", "emacsy"]
    };
    keyMap["default"] = mac ? keyMap.macDefault : keyMap.pcDefault;
    keyMap.emacsy = {
        "Ctrl-F": "goCharRight",
        "Ctrl-B": "goCharLeft",
        "Ctrl-P": "goLineUp",
        "Ctrl-N": "goLineDown",
        "Alt-F": "goWordRight",
        "Alt-B": "goWordLeft",
        "Ctrl-A": "goLineStart",
        "Ctrl-E": "goLineEnd",
        "Ctrl-V": "goPageDown",
        "Shift-Ctrl-V": "goPageUp",
        "Ctrl-D": "delCharAfter",
        "Ctrl-H": "delCharBefore",
        "Alt-D": "delWordAfter",
        "Alt-Backspace": "delWordBefore",
        "Ctrl-K": "killLine",
        "Ctrl-T": "transposeChars"
    };

    function getKeyMap(val) {
        if (typeof val == "string") {
            return keyMap[val]
        } else {
            return val
        }
    }
    function lookupKey(name, maps, handle) {
        function lookup(map) {
            map = getKeyMap(map);
            var found = map[name];
            if (found === false) {
                return "stop"
            }
            if (found != null && handle(found)) {
                return true
            }
            if (map.nofallthrough) {
                return "stop"
            }
            var fallthrough = map.fallthrough;
            if (fallthrough == null) {
                return false
            }
            if (Object.prototype.toString.call(fallthrough) != "[object Array]") {
                return lookup(fallthrough)
            }
            for (var i = 0, e = fallthrough.length; i < e; ++i) {
                var done = lookup(fallthrough[i]);
                if (done) {
                    return done
                }
            }
            return false
        }
        for (var i = 0; i < maps.length; ++i) {
            var done = lookup(maps[i]);
            if (done) {
                return done != "stop"
            }
        }
    }
    function isModifierKey(event) {
        var name = keyNames[event.keyCode];
        return name == "Ctrl" || name == "Alt" || name == "Shift" || name == "Mod"
    }
    function keyName(event, noShift) {
        if (opera && event.keyCode == 34 && event["char"]) {
            return false
        }
        var name = keyNames[event.keyCode];
        if (name == null || event.altGraphKey) {
            return false
        }
        if (event.altKey) {
            name = "Alt-" + name
        }
        if (flipCtrlCmd ? event.metaKey : event.ctrlKey) {
            name = "Ctrl-" + name
        }
        if (flipCtrlCmd ? event.ctrlKey : event.metaKey) {
            name = "Cmd-" + name
        }
        if (!noShift && event.shiftKey) {
            name = "Shift-" + name
        }
        return name
    }
    CodeMirror.lookupKey = lookupKey;
    CodeMirror.isModifierKey = isModifierKey;
    CodeMirror.keyName = keyName;
    CodeMirror.fromTextArea = function (textarea, options) {
        if (!options) {
            options = {}
        }
        options.value = textarea.value;
        if (!options.tabindex && textarea.tabindex) {
            options.tabindex = textarea.tabindex
        }
        if (!options.placeholder && textarea.placeholder) {
            options.placeholder = textarea.placeholder
        }
        if (options.autofocus == null) {
            var hasFocus = document.body;
            try {
                hasFocus = document.activeElement
            } catch (e) {}
            options.autofocus = hasFocus == textarea || textarea.getAttribute("autofocus") != null && hasFocus == document.body
        }
        function save() {
            textarea.value = cm.getValue()
        }
        if (textarea.form) {
            on(textarea.form, "submit", save);
            if (!options.leaveSubmitMethodAlone) {
                var form = textarea.form,
                    realSubmit = form.submit;
                try {
                    var wrappedSubmit = form.submit = function () {
                            save();
                            form.submit = realSubmit;
                            form.submit();
                            form.submit = wrappedSubmit
                        }
                } catch (e) {}
            }
        }
        textarea.style.display = "none";
        var cm = CodeMirror(function (node) {
            textarea.parentNode.insertBefore(node, textarea.nextSibling)
        }, options);
        cm.save = save;
        cm.getTextArea = function () {
            return textarea
        };
        cm.toTextArea = function () {
            save();
            textarea.parentNode.removeChild(cm.getWrapperElement());
            textarea.style.display = "";
            if (textarea.form) {
                off(textarea.form, "submit", save);
                if (typeof textarea.form.submit == "function") {
                    textarea.form.submit = realSubmit
                }
            }
        };
        return cm
    };

    function StringStream(string, tabSize) {
        this.pos = this.start = 0;
        this.string = string;
        this.tabSize = tabSize || 8;
        this.lastColumnPos = this.lastColumnValue = 0
    }
    StringStream.prototype = {
        eol: function () {
            return this.pos >= this.string.length
        },
        sol: function () {
            return this.pos == 0
        },
        peek: function () {
            return this.string.charAt(this.pos) || undefined
        },
        next: function () {
            if (this.pos < this.string.length) {
                return this.string.charAt(this.pos++)
            }
        },
        eat: function (match) {
            var ch = this.string.charAt(this.pos);
            if (typeof match == "string") {
                var ok = ch == match
            } else {
                var ok = ch && (match.test ? match.test(ch) : match(ch))
            }
            if (ok) {
                ++this.pos;
                return ch
            }
        },
        eatWhile: function (match) {
            var start = this.pos;
            while (this.eat(match)) {}
            return this.pos > start
        },
        eatSpace: function () {
            var start = this.pos;
            while (/[\s\u00a0]/.test(this.string.charAt(this.pos))) {
                ++this.pos
            }
            return this.pos > start
        },
        skipToEnd: function () {
            this.pos = this.string.length
        },
        skipTo: function (ch) {
            var found = this.string.indexOf(ch, this.pos);
            if (found > -1) {
                this.pos = found;
                return true
            }
        },
        backUp: function (n) {
            this.pos -= n
        },
        column: function () {
            if (this.lastColumnPos < this.start) {
                this.lastColumnValue = countColumn(this.string, this.start, this.tabSize, this.lastColumnPos, this.lastColumnValue);
                this.lastColumnPos = this.start
            }
            return this.lastColumnValue
        },
        indentation: function () {
            return countColumn(this.string, null, this.tabSize)
        },
        match: function (pattern, consume, caseInsensitive) {
            if (typeof pattern == "string") {
                var cased = function (str) {
                        return caseInsensitive ? str.toLowerCase() : str
                    };
                var substr = this.string.substr(this.pos, pattern.length);
                if (cased(substr) == cased(pattern)) {
                    if (consume !== false) {
                        this.pos += pattern.length
                    }
                    return true
                }
            } else {
                var match = this.string.slice(this.pos).match(pattern);
                if (match && match.index > 0) {
                    return null
                }
                if (match && consume !== false) {
                    this.pos += match[0].length
                }
                return match
            }
        },
        current: function () {
            return this.string.slice(this.start, this.pos)
        }
    };
    CodeMirror.StringStream = StringStream;

    function TextMarker(doc, type) {
        this.lines = [];
        this.type = type;
        this.doc = doc
    }
    CodeMirror.TextMarker = TextMarker;
    eventMixin(TextMarker);
    TextMarker.prototype.clear = function () {
        if (this.explicitlyCleared) {
            return
        }
        var cm = this.doc.cm,
            withOp = cm && !cm.curOp;
        if (withOp) {
            startOperation(cm)
        }
        if (hasHandler(this, "clear")) {
            var found = this.find();
            if (found) {
                signalLater(this, "clear", found.from, found.to)
            }
        }
        var min = null,
            max = null;
        for (var i = 0; i < this.lines.length; ++i) {
            var line = this.lines[i];
            var span = getMarkedSpanFor(line.markedSpans, this);
            if (span.to != null) {
                max = lineNo(line)
            }
            line.markedSpans = removeMarkedSpan(line.markedSpans, span);
            if (span.from != null) {
                min = lineNo(line)
            } else {
                if (this.collapsed && !lineIsHidden(this.doc, line) && cm) {
                    updateLineHeight(line, textHeight(cm.display))
                }
            }
        }
        if (cm && this.collapsed && !cm.options.lineWrapping) {
            for (var i = 0; i < this.lines.length; ++i) {
                var visual = visualLine(cm.doc, this.lines[i]),
                    len = lineLength(cm.doc, visual);
                if (len > cm.display.maxLineLength) {
                    cm.display.maxLine = visual;
                    cm.display.maxLineLength = len;
                    cm.display.maxLineChanged = true
                }
            }
        }
        if (min != null && cm) {
            regChange(cm, min, max + 1)
        }
        this.lines.length = 0;
        this.explicitlyCleared = true;
        if (this.atomic && this.doc.cantEdit) {
            this.doc.cantEdit = false;
            if (cm) {
                reCheckSelection(cm)
            }
        }
        if (withOp) {
            endOperation(cm)
        }
    };
    TextMarker.prototype.find = function () {
        var from, to;
        for (var i = 0; i < this.lines.length; ++i) {
            var line = this.lines[i];
            var span = getMarkedSpanFor(line.markedSpans, this);
            if (span.from != null || span.to != null) {
                var found = lineNo(line);
                if (span.from != null) {
                    from = Pos(found, span.from)
                }
                if (span.to != null) {
                    to = Pos(found, span.to)
                }
            }
        }
        if (this.type == "bookmark") {
            return from
        }
        return from && {
            from: from,
            to: to
        }
    };
    TextMarker.prototype.changed = function () {
        var pos = this.find(),
            cm = this.doc.cm;
        if (!pos || !cm) {
            return
        }
        if (this.type != "bookmark") {
            pos = pos.from
        }
        var line = getLine(this.doc, pos.line);
        clearCachedMeasurement(cm, line);
        if (pos.line >= cm.display.showingFrom && pos.line < cm.display.showingTo) {
            for (var node = cm.display.lineDiv.firstChild; node; node = node.nextSibling) {
                if (node.lineObj == line) {
                    if (node.offsetHeight != line.height) {
                        updateLineHeight(line, node.offsetHeight)
                    }
                    break
                }
            }
            runInOp(cm, function () {
                cm.curOp.selectionChanged = cm.curOp.forceUpdate = cm.curOp.updateMaxLine = true
            })
        }
    };
    TextMarker.prototype.attachLine = function (line) {
        if (!this.lines.length && this.doc.cm) {
            var op = this.doc.cm.curOp;
            if (!op.maybeHiddenMarkers || indexOf(op.maybeHiddenMarkers, this) == -1) {
                (op.maybeUnhiddenMarkers || (op.maybeUnhiddenMarkers = [])).push(this)
            }
        }
        this.lines.push(line)
    };
    TextMarker.prototype.detachLine = function (line) {
        this.lines.splice(indexOf(this.lines, line), 1);
        if (!this.lines.length && this.doc.cm) {
            var op = this.doc.cm.curOp;
            (op.maybeHiddenMarkers || (op.maybeHiddenMarkers = [])).push(this)
        }
    };

    function markText(doc, from, to, options, type) {
        if (options && options.shared) {
            return markTextShared(doc, from, to, options, type)
        }
        if (doc.cm && !doc.cm.curOp) {
            return operation(doc.cm, markText)(doc, from, to, options, type)
        }
        var marker = new TextMarker(doc, type);
        if (type == "range" && !posLess(from, to)) {
            return marker
        }
        if (options) {
            copyObj(options, marker)
        }
        if (marker.replacedWith) {
            marker.collapsed = true;
            marker.replacedWith = elt("span", [marker.replacedWith], "CodeMirror-widget");
            if (!options.handleMouseEvents) {
                marker.replacedWith.ignoreEvents = true
            }
        }
        if (marker.collapsed) {
            sawCollapsedSpans = true
        }
        if (marker.addToHistory) {
            addToHistory(doc, {
                from: from,
                to: to,
                origin: "markText"
            }, {
                head: doc.sel.head,
                anchor: doc.sel.anchor
            }, NaN)
        }
        var curLine = from.line,
            size = 0,
            collapsedAtStart, collapsedAtEnd, cm = doc.cm,
            updateMaxLine;
        doc.iter(curLine, to.line + 1, function (line) {
            if (cm && marker.collapsed && !cm.options.lineWrapping && visualLine(doc, line) == cm.display.maxLine) {
                updateMaxLine = true
            }
            var span = {
                from: null,
                to: null,
                marker: marker
            };
            size += line.text.length;
            if (curLine == from.line) {
                span.from = from.ch;
                size -= from.ch
            }
            if (curLine == to.line) {
                span.to = to.ch;
                size -= line.text.length - to.ch
            }
            if (marker.collapsed) {
                if (curLine == to.line) {
                    collapsedAtEnd = collapsedSpanAt(line, to.ch)
                }
                if (curLine == from.line) {
                    collapsedAtStart = collapsedSpanAt(line, from.ch)
                } else {
                    updateLineHeight(line, 0)
                }
            }
            addMarkedSpan(line, span);
            ++curLine
        });
        if (marker.collapsed) {
            doc.iter(from.line, to.line + 1, function (line) {
                if (lineIsHidden(doc, line)) {
                    updateLineHeight(line, 0)
                }
            })
        }
        if (marker.clearOnEnter) {
            on(marker, "beforeCursorEnter", function () {
                marker.clear()
            })
        }
        if (marker.readOnly) {
            sawReadOnlySpans = true;
            if (doc.history.done.length || doc.history.undone.length) {
                doc.clearHistory()
            }
        }
        if (marker.collapsed) {
            if (collapsedAtStart != collapsedAtEnd) {
                throw new Error("Inserting collapsed marker overlapping an existing one")
            }
            marker.size = size;
            marker.atomic = true
        }
        if (cm) {
            if (updateMaxLine) {
                cm.curOp.updateMaxLine = true
            }
            if (marker.className || marker.title || marker.startStyle || marker.endStyle || marker.collapsed) {
                regChange(cm, from.line, to.line + 1)
            }
            if (marker.atomic) {
                reCheckSelection(cm)
            }
        }
        return marker
    }
    function SharedTextMarker(markers, primary) {
        this.markers = markers;
        this.primary = primary;
        for (var i = 0, me = this; i < markers.length; ++i) {
            markers[i].parent = this;
            on(markers[i], "clear", function () {
                me.clear()
            })
        }
    }
    CodeMirror.SharedTextMarker = SharedTextMarker;
    eventMixin(SharedTextMarker);
    SharedTextMarker.prototype.clear = function () {
        if (this.explicitlyCleared) {
            return
        }
        this.explicitlyCleared = true;
        for (var i = 0; i < this.markers.length; ++i) {
            this.markers[i].clear()
        }
        signalLater(this, "clear")
    };
    SharedTextMarker.prototype.find = function () {
        return this.primary.find()
    };

    function markTextShared(doc, from, to, options, type) {
        options = copyObj(options);
        options.shared = false;
        var markers = [markText(doc, from, to, options, type)],
            primary = markers[0];
        var widget = options.replacedWith;
        linkedDocs(doc, function (doc) {
            if (widget) {
                options.replacedWith = widget.cloneNode(true)
            }
            markers.push(markText(doc, clipPos(doc, from), clipPos(doc, to), options, type));
            for (var i = 0; i < doc.linked.length; ++i) {
                if (doc.linked[i].isParent) {
                    return
                }
            }
            primary = lst(markers)
        });
        return new SharedTextMarker(markers, primary)
    }
    function getMarkedSpanFor(spans, marker) {
        if (spans) {
            for (var i = 0; i < spans.length; ++i) {
                var span = spans[i];
                if (span.marker == marker) {
                    return span
                }
            }
        }
    }
    function removeMarkedSpan(spans, span) {
        for (var r, i = 0; i < spans.length; ++i) {
            if (spans[i] != span) {
                (r || (r = [])).push(spans[i])
            }
        }
        return r
    }
    function addMarkedSpan(line, span) {
        line.markedSpans = line.markedSpans ? line.markedSpans.concat([span]) : [span];
        span.marker.attachLine(line)
    }
    function markedSpansBefore(old, startCh, isInsert) {
        if (old) {
            for (var i = 0, nw; i < old.length; ++i) {
                var span = old[i],
                    marker = span.marker;
                var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= startCh : span.from < startCh);
                if (startsBefore || marker.type == "bookmark" && span.from == startCh && (!isInsert || !span.marker.insertLeft)) {
                    var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= startCh : span.to > startCh);
                    (nw || (nw = [])).push({
                        from: span.from,
                        to: endsAfter ? null : span.to,
                        marker: marker
                    })
                }
            }
        }
        return nw
    }
    function markedSpansAfter(old, endCh, isInsert) {
        if (old) {
            for (var i = 0, nw; i < old.length; ++i) {
                var span = old[i],
                    marker = span.marker;
                var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= endCh : span.to > endCh);
                if (endsAfter || marker.type == "bookmark" && span.from == endCh && (!isInsert || span.marker.insertLeft)) {
                    var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= endCh : span.from < endCh);
                    (nw || (nw = [])).push({
                        from: startsBefore ? null : span.from - endCh,
                        to: span.to == null ? null : span.to - endCh,
                        marker: marker
                    })
                }
            }
        }
        return nw
    }
    function stretchSpansOverChange(doc, change) {
        var oldFirst = isLine(doc, change.from.line) && getLine(doc, change.from.line).markedSpans;
        var oldLast = isLine(doc, change.to.line) && getLine(doc, change.to.line).markedSpans;
        if (!oldFirst && !oldLast) {
            return null
        }
        var startCh = change.from.ch,
            endCh = change.to.ch,
            isInsert = posEq(change.from, change.to);
        var first = markedSpansBefore(oldFirst, startCh, isInsert);
        var last = markedSpansAfter(oldLast, endCh, isInsert);
        var sameLine = change.text.length == 1,
            offset = lst(change.text).length + (sameLine ? startCh : 0);
        if (first) {
            for (var i = 0; i < first.length; ++i) {
                var span = first[i];
                if (span.to == null) {
                    var found = getMarkedSpanFor(last, span.marker);
                    if (!found) {
                        span.to = startCh
                    } else {
                        if (sameLine) {
                            span.to = found.to == null ? null : found.to + offset
                        }
                    }
                }
            }
        }
        if (last) {
            for (var i = 0; i < last.length; ++i) {
                var span = last[i];
                if (span.to != null) {
                    span.to += offset
                }
                if (span.from == null) {
                    var found = getMarkedSpanFor(first, span.marker);
                    if (!found) {
                        span.from = offset;
                        if (sameLine) {
                            (first || (first = [])).push(span)
                        }
                    }
                } else {
                    span.from += offset;
                    if (sameLine) {
                        (first || (first = [])).push(span)
                    }
                }
            }
        }
        if (sameLine && first) {
            for (var i = 0; i < first.length; ++i) {
                if (first[i].from != null && first[i].from == first[i].to && first[i].marker.type != "bookmark") {
                    first.splice(i--, 1)
                }
            }
            if (!first.length) {
                first = null
            }
        }
        var newMarkers = [first];
        if (!sameLine) {
            var gap = change.text.length - 2,
                gapMarkers;
            if (gap > 0 && first) {
                for (var i = 0; i < first.length; ++i) {
                    if (first[i].to == null) {
                        (gapMarkers || (gapMarkers = [])).push({
                            from: null,
                            to: null,
                            marker: first[i].marker
                        })
                    }
                }
            }
            for (var i = 0; i < gap; ++i) {
                newMarkers.push(gapMarkers)
            }
            newMarkers.push(last)
        }
        return newMarkers
    }
    function mergeOldSpans(doc, change) {
        var old = getOldSpans(doc, change);
        var stretched = stretchSpansOverChange(doc, change);
        if (!old) {
            return stretched
        }
        if (!stretched) {
            return old
        }
        for (var i = 0; i < old.length; ++i) {
            var oldCur = old[i],
                stretchCur = stretched[i];
            if (oldCur && stretchCur) {
                spans: for (var j = 0; j < stretchCur.length; ++j) {
                    var span = stretchCur[j];
                    for (var k = 0; k < oldCur.length; ++k) {
                        if (oldCur[k].marker == span.marker) {
                            continue spans
                        }
                    }
                    oldCur.push(span)
                }
            } else {
                if (stretchCur) {
                    old[i] = stretchCur
                }
            }
        }
        return old
    }
    function removeReadOnlyRanges(doc, from, to) {
        var markers = null;
        doc.iter(from.line, to.line + 1, function (line) {
            if (line.markedSpans) {
                for (var i = 0; i < line.markedSpans.length; ++i) {
                    var mark = line.markedSpans[i].marker;
                    if (mark.readOnly && (!markers || indexOf(markers, mark) == -1)) {
                        (markers || (markers = [])).push(mark)
                    }
                }
            }
        });
        if (!markers) {
            return null
        }
        var parts = [{
            from: from,
            to: to
        }];
        for (var i = 0; i < markers.length; ++i) {
            var mk = markers[i],
                m = mk.find();
            for (var j = 0; j < parts.length; ++j) {
                var p = parts[j];
                if (posLess(p.to, m.from) || posLess(m.to, p.from)) {
                    continue
                }
                var newParts = [j, 1];
                if (posLess(p.from, m.from) || !mk.inclusiveLeft && posEq(p.from, m.from)) {
                    newParts.push({
                        from: p.from,
                        to: m.from
                    })
                }
                if (posLess(m.to, p.to) || !mk.inclusiveRight && posEq(p.to, m.to)) {
                    newParts.push({
                        from: m.to,
                        to: p.to
                    })
                }
                parts.splice.apply(parts, newParts);
                j += newParts.length - 1
            }
        }
        return parts
    }
    function collapsedSpanAt(line, ch) {
        var sps = sawCollapsedSpans && line.markedSpans,
            found;
        if (sps) {
            for (var sp, i = 0; i < sps.length; ++i) {
                sp = sps[i];
                if (!sp.marker.collapsed) {
                    continue
                }
                if ((sp.from == null || sp.from < ch) && (sp.to == null || sp.to > ch) && (!found || found.width < sp.marker.width)) {
                    found = sp.marker
                }
            }
        }
        return found
    }
    function collapsedSpanAtStart(line) {
        return collapsedSpanAt(line, -1)
    }
    function collapsedSpanAtEnd(line) {
        return collapsedSpanAt(line, line.text.length + 1)
    }
    function visualLine(doc, line) {
        var merged;
        while (merged = collapsedSpanAtStart(line)) {
            line = getLine(doc, merged.find().from.line)
        }
        return line
    }
    function lineIsHidden(doc, line) {
        var sps = sawCollapsedSpans && line.markedSpans;
        if (sps) {
            for (var sp, i = 0; i < sps.length; ++i) {
                sp = sps[i];
                if (!sp.marker.collapsed) {
                    continue
                }
                if (sp.from == null) {
                    return true
                }
                if (sp.marker.replacedWith) {
                    continue
                }
                if (sp.from == 0 && sp.marker.inclusiveLeft && lineIsHiddenInner(doc, line, sp)) {
                    return true
                }
            }
        }
    }
    function lineIsHiddenInner(doc, line, span) {
        if (span.to == null) {
            var end = span.marker.find().to,
                endLine = getLine(doc, end.line);
            return lineIsHiddenInner(doc, endLine, getMarkedSpanFor(endLine.markedSpans, span.marker))
        }
        if (span.marker.inclusiveRight && span.to == line.text.length) {
            return true
        }
        for (var sp, i = 0; i < line.markedSpans.length; ++i) {
            sp = line.markedSpans[i];
            if (sp.marker.collapsed && !sp.marker.replacedWith && sp.from == span.to && (sp.marker.inclusiveLeft || span.marker.inclusiveRight) && lineIsHiddenInner(doc, line, sp)) {
                return true
            }
        }
    }
    function detachMarkedSpans(line) {
        var spans = line.markedSpans;
        if (!spans) {
            return
        }
        for (var i = 0; i < spans.length; ++i) {
            spans[i].marker.detachLine(line)
        }
        line.markedSpans = null
    }
    function attachMarkedSpans(line, spans) {
        if (!spans) {
            return
        }
        for (var i = 0; i < spans.length; ++i) {
            spans[i].marker.attachLine(line)
        }
        line.markedSpans = spans
    }
    var LineWidget = CodeMirror.LineWidget = function (cm, node, options) {
            if (options) {
                for (var opt in options) {
                    if (options.hasOwnProperty(opt)) {
                        this[opt] = options[opt]
                    }
                }
            }
            this.cm = cm;
            this.node = node
        };
    eventMixin(LineWidget);

    function widgetOperation(f) {
        return function () {
            var withOp = !this.cm.curOp;
            if (withOp) {
                startOperation(this.cm)
            }
            try {
                var result = f.apply(this, arguments)
            } finally {
                if (withOp) {
                    endOperation(this.cm)
                }
            }
            return result
        }
    }
    LineWidget.prototype.clear = widgetOperation(function () {
        var ws = this.line.widgets,
            no = lineNo(this.line);
        if (no == null || !ws) {
            return
        }
        for (var i = 0; i < ws.length; ++i) {
            if (ws[i] == this) {
                ws.splice(i--, 1)
            }
        }
        if (!ws.length) {
            this.line.widgets = null
        }
        var aboveVisible = heightAtLine(this.cm, this.line) < this.cm.doc.scrollTop;
        updateLineHeight(this.line, Math.max(0, this.line.height - widgetHeight(this)));
        if (aboveVisible) {
            addToScrollPos(this.cm, 0, -this.height)
        }
        regChange(this.cm, no, no + 1)
    });
    LineWidget.prototype.changed = widgetOperation(function () {
        var oldH = this.height;
        this.height = null;
        var diff = widgetHeight(this) - oldH;
        if (!diff) {
            return
        }
        updateLineHeight(this.line, this.line.height + diff);
        var no = lineNo(this.line);
        regChange(this.cm, no, no + 1)
    });

    function widgetHeight(widget) {
        if (widget.height != null) {
            return widget.height
        }
        if (!widget.node.parentNode || widget.node.parentNode.nodeType != 1) {
            removeChildrenAndAdd(widget.cm.display.measure, elt("div", [widget.node], null, "position: relative"))
        }
        return widget.height = widget.node.offsetHeight
    }
    function addLineWidget(cm, handle, node, options) {
        var widget = new LineWidget(cm, node, options);
        if (widget.noHScroll) {
            cm.display.alignWidgets = true
        }
        changeLine(cm, handle, function (line) {
            var widgets = line.widgets || (line.widgets = []);
            if (widget.insertAt == null) {
                widgets.push(widget)
            } else {
                widgets.splice(Math.min(widgets.length - 1, Math.max(0, widget.insertAt)), 0, widget)
            }
            widget.line = line;
            if (!lineIsHidden(cm.doc, line) || widget.showIfHidden) {
                var aboveVisible = heightAtLine(cm, line) < cm.doc.scrollTop;
                updateLineHeight(line, line.height + widgetHeight(widget));
                if (aboveVisible) {
                    addToScrollPos(cm, 0, widget.height)
                }
            }
            return true
        });
        return widget
    }
    var Line = CodeMirror.Line = function (text, markedSpans, estimateHeight) {
            this.text = text;
            attachMarkedSpans(this, markedSpans);
            this.height = estimateHeight ? estimateHeight(this) : 1
        };
    eventMixin(Line);

    function updateLine(line, text, markedSpans, estimateHeight) {
        line.text = text;
        if (line.stateAfter) {
            line.stateAfter = null
        }
        if (line.styles) {
            line.styles = null
        }
        if (line.order != null) {
            line.order = null
        }
        detachMarkedSpans(line);
        attachMarkedSpans(line, markedSpans);
        var estHeight = estimateHeight ? estimateHeight(line) : 1;
        if (estHeight != line.height) {
            updateLineHeight(line, estHeight)
        }
    }
    function cleanUpLine(line) {
        line.parent = null;
        detachMarkedSpans(line)
    }
    function runMode(cm, text, mode, state, f) {
        var flattenSpans = mode.flattenSpans;
        if (flattenSpans == null) {
            flattenSpans = cm.options.flattenSpans
        }
        var curStart = 0,
            curStyle = null;
        var stream = new StringStream(text, cm.options.tabSize),
            style;
        if (text == "" && mode.blankLine) {
            mode.blankLine(state)
        }
        while (!stream.eol()) {
            if (stream.pos > cm.options.maxHighlightLength) {
                flattenSpans = false;
                stream.pos = text.length;
                style = null
            } else {
                style = mode.token(stream, state)
            }
            if (!flattenSpans || curStyle != style) {
                if (curStart < stream.start) {
                    f(stream.start, curStyle)
                }
                curStart = stream.start;
                curStyle = style
            }
            stream.start = stream.pos
        }
        while (curStart < stream.pos) {
            var pos = Math.min(stream.pos, curStart + 50000);
            f(pos, curStyle);
            curStart = pos
        }
    }
    function highlightLine(cm, line, state) {
        var st = [cm.state.modeGen];
        runMode(cm, line.text, cm.doc.mode, state, function (end, style) {
            st.push(end, style)
        });
        for (var o = 0; o < cm.state.overlays.length; ++o) {
            var overlay = cm.state.overlays[o],
                i = 1,
                at = 0;
            runMode(cm, line.text, overlay.mode, true, function (end, style) {
                var start = i;
                while (at < end) {
                    var i_end = st[i];
                    if (i_end > end) {
                        st.splice(i, 1, end, st[i + 1], i_end)
                    }
                    i += 2;
                    at = Math.min(end, i_end)
                }
                if (!style) {
                    return
                }
                if (overlay.opaque) {
                    st.splice(start, i - start, end, style);
                    i = start + 2
                } else {
                    for (; start < i; start += 2) {
                        var cur = st[start + 1];
                        st[start + 1] = cur ? cur + " " + style : style
                    }
                }
            })
        }
        return st
    }
    function getLineStyles(cm, line) {
        if (!line.styles || line.styles[0] != cm.state.modeGen) {
            line.styles = highlightLine(cm, line, line.stateAfter = getStateBefore(cm, lineNo(line)))
        }
        return line.styles
    }
    function processLine(cm, line, state) {
        var mode = cm.doc.mode;
        var stream = new StringStream(line.text, cm.options.tabSize);
        if (line.text == "" && mode.blankLine) {
            mode.blankLine(state)
        }
        while (!stream.eol() && stream.pos <= cm.options.maxHighlightLength) {
            mode.token(stream, state);
            stream.start = stream.pos
        }
    }
    var styleToClassCache = {};

    function interpretTokenStyle(style, builder) {
        if (!style) {
            return null
        }
        for (;;) {
            var lineClass = style.match(/(?:^|\s)line-(background-)?(\S+)/);
            if (!lineClass) {
                break
            }
            style = style.slice(0, lineClass.index) + style.slice(lineClass.index + lineClass[0].length);
            var prop = lineClass[1] ? "bgClass" : "textClass";
            if (builder[prop] == null) {
                builder[prop] = lineClass[2]
            } else {
                if (!(new RegExp("(?:^|s)" + lineClass[2] + "(?:$|s)")).test(builder[prop])) {
                    builder[prop] += " " + lineClass[2]
                }
            }
        }
        return styleToClassCache[style] || (styleToClassCache[style] = "cm-" + style.replace(/ +/g, " cm-"))
    }
    function buildLineContent(cm, realLine, measure, copyWidgets) {
        var merged, line = realLine,
            empty = true;
        while (merged = collapsedSpanAtStart(line)) {
            line = getLine(cm.doc, merged.find().from.line)
        }
        var builder = {
            pre: elt("pre"),
            col: 0,
            pos: 0,
            measure: null,
            measuredSomething: false,
            cm: cm,
            copyWidgets: copyWidgets
        };
        do {
            if (line.text) {
                empty = false
            }
            builder.measure = line == realLine && measure;
            builder.pos = 0;
            builder.addToken = builder.measure ? buildTokenMeasure : buildToken;
            if ((ie || webkit) && cm.getOption("lineWrapping")) {
                builder.addToken = buildTokenSplitSpaces(builder.addToken)
            }
            var next = insertLineContent(line, builder, getLineStyles(cm, line));
            if (measure && line == realLine && !builder.measuredSomething) {
                measure[0] = builder.pre.appendChild(zeroWidthElement(cm.display.measure));
                builder.measuredSomething = true
            }
            if (next) {
                line = getLine(cm.doc, next.to.line)
            }
        } while (next);
        if (measure && !builder.measuredSomething && !measure[0]) {
            measure[0] = builder.pre.appendChild(empty ? elt("span", "\u00a0") : zeroWidthElement(cm.display.measure))
        }
        if (!builder.pre.firstChild && !lineIsHidden(cm.doc, realLine)) {
            builder.pre.appendChild(document.createTextNode("\u00a0"))
        }
        var order;
        if (measure && ie && (order = getOrder(line))) {
            var l = order.length - 1;
            if (order[l].from == order[l].to) {
                --l
            }
            var last = order[l],
                prev = order[l - 1];
            if (last.from + 1 == last.to && prev && last.level < prev.level) {
                var span = measure[builder.pos - 1];
                if (span) {
                    span.parentNode.insertBefore(span.measureRight = zeroWidthElement(cm.display.measure), span.nextSibling)
                }
            }
        }
        var textClass = builder.textClass ? builder.textClass + " " + (realLine.textClass || "") : realLine.textClass;
        if (textClass) {
            builder.pre.className = textClass
        }
        signal(cm, "renderLine", cm, realLine, builder.pre);
        return builder
    }
    var tokenSpecialChars = /[\t\u0000-\u0019\u00ad\u200b\u2028\u2029\uFEFF]/g;

    function buildToken(builder, text, style, startStyle, endStyle, title) {
        if (!text) {
            return
        }
        if (!tokenSpecialChars.test(text)) {
            builder.col += text.length;
            var content = document.createTextNode(text)
        } else {
            var content = document.createDocumentFragment(),
                pos = 0;
            while (true) {
                tokenSpecialChars.lastIndex = pos;
                var m = tokenSpecialChars.exec(text);
                var skipped = m ? m.index - pos : text.length - pos;
                if (skipped) {
                    content.appendChild(document.createTextNode(text.slice(pos, pos + skipped)));
                    builder.col += skipped
                }
                if (!m) {
                    break
                }
                pos += skipped + 1;
                if (m[0] == "\t") {
                    var tabSize = builder.cm.options.tabSize,
                        tabWidth = tabSize - builder.col % tabSize;
                    content.appendChild(elt("span", spaceStr(tabWidth), "cm-tab"));
                    builder.col += tabWidth
                } else {
                    var token = elt("span", "\u2022", "cm-invalidchar");
                    token.title = "\\u" + m[0].charCodeAt(0).toString(16);
                    content.appendChild(token);
                    builder.col += 1
                }
            }
        }
        if (style || startStyle || endStyle || builder.measure) {
            var fullStyle = style || "";
            if (startStyle) {
                fullStyle += startStyle
            }
            if (endStyle) {
                fullStyle += endStyle
            }
            var token = elt("span", [content], fullStyle);
            if (title) {
                token.title = title
            }
            return builder.pre.appendChild(token)
        }
        builder.pre.appendChild(content)
    }
    function buildTokenMeasure(builder, text, style, startStyle, endStyle) {
        var wrapping = builder.cm.options.lineWrapping;
        for (var i = 0; i < text.length; ++i) {
            var ch = text.charAt(i),
                start = i == 0;
            if (ch >= "\ud800" && ch < "\udbff" && i < text.length - 1) {
                ch = text.slice(i, i + 2);
                ++i
            } else {
                if (i && wrapping && spanAffectsWrapping(text, i)) {
                    builder.pre.appendChild(elt("wbr"))
                }
            }
            var old = builder.measure[builder.pos];
            var span = builder.measure[builder.pos] = buildToken(builder, ch, style, start && startStyle, i == text.length - 1 && endStyle);
            if (old) {
                span.leftSide = old.leftSide || old
            }
            if (ie && wrapping && ch == " " && i && !/\s/.test(text.charAt(i - 1)) && i < text.length - 1 && !/\s/.test(text.charAt(i + 1))) {
                span.style.whiteSpace = "normal"
            }
            builder.pos += ch.length
        }
        if (text.length) {
            builder.measuredSomething = true
        }
    }
    function buildTokenSplitSpaces(inner) {
        function split(old) {
            var out = " ";
            for (var i = 0; i < old.length - 2; ++i) {
                out += i % 2 ? " " : "\u00a0"
            }
            out += " ";
            return out
        }
        return function (builder, text, style, startStyle, endStyle, title) {
            return inner(builder, text.replace(/ {3,}/g, split), style, startStyle, endStyle, title)
        }
    }
    function buildCollapsedSpan(builder, size, marker, ignoreWidget) {
        var widget = !ignoreWidget && marker.replacedWith;
        if (widget) {
            if (builder.copyWidgets) {
                widget = widget.cloneNode(true)
            }
            builder.pre.appendChild(widget);
            if (builder.measure) {
                if (size) {
                    builder.measure[builder.pos] = widget
                } else {
                    var elt = zeroWidthElement(builder.cm.display.measure);
                    if (marker.type == "bookmark" && !marker.insertLeft) {
                        builder.measure[builder.pos] = builder.pre.appendChild(elt)
                    } else {
                        if (builder.measure[builder.pos]) {
                            return
                        } else {
                            builder.measure[builder.pos] = builder.pre.insertBefore(elt, widget)
                        }
                    }
                }
                builder.measuredSomething = true
            }
        }
        builder.pos += size
    }
    function insertLineContent(line, builder, styles) {
        var spans = line.markedSpans,
            allText = line.text,
            at = 0;
        if (!spans) {
            for (var i = 1; i < styles.length; i += 2) {
                builder.addToken(builder, allText.slice(at, at = styles[i]), interpretTokenStyle(styles[i + 1], builder))
            }
            return
        }
        var len = allText.length,
            pos = 0,
            i = 1,
            text = "",
            style;
        var nextChange = 0,
            spanStyle, spanEndStyle, spanStartStyle, title, collapsed;
        for (;;) {
            if (nextChange == pos) {
                spanStyle = spanEndStyle = spanStartStyle = title = "";
                collapsed = null;
                nextChange = Infinity;
                var foundBookmarks = [];
                for (var j = 0; j < spans.length; ++j) {
                    var sp = spans[j],
                        m = sp.marker;
                    if (sp.from <= pos && (sp.to == null || sp.to > pos)) {
                        if (sp.to != null && nextChange > sp.to) {
                            nextChange = sp.to;
                            spanEndStyle = ""
                        }
                        if (m.className) {
                            spanStyle += " " + m.className
                        }
                        if (m.startStyle && sp.from == pos) {
                            spanStartStyle += " " + m.startStyle
                        }
                        if (m.endStyle && sp.to == nextChange) {
                            spanEndStyle += " " + m.endStyle
                        }
                        if (m.title && !title) {
                            title = m.title
                        }
                        if (m.collapsed && (!collapsed || collapsed.marker.size < m.size)) {
                            collapsed = sp
                        }
                    } else {
                        if (sp.from > pos && nextChange > sp.from) {
                            nextChange = sp.from
                        }
                    }
                    if (m.type == "bookmark" && sp.from == pos && m.replacedWith) {
                        foundBookmarks.push(m)
                    }
                }
                if (collapsed && (collapsed.from || 0) == pos) {
                    buildCollapsedSpan(builder, (collapsed.to == null ? len : collapsed.to) - pos, collapsed.marker, collapsed.from == null);
                    if (collapsed.to == null) {
                        return collapsed.marker.find()
                    }
                }
                if (!collapsed && foundBookmarks.length) {
                    for (var j = 0; j < foundBookmarks.length; ++j) {
                        buildCollapsedSpan(builder, 0, foundBookmarks[j])
                    }
                }
            }
            if (pos >= len) {
                break
            }
            var upto = Math.min(len, nextChange);
            while (true) {
                if (text) {
                    var end = pos + text.length;
                    if (!collapsed) {
                        var tokenText = end > upto ? text.slice(0, upto - pos) : text;
                        builder.addToken(builder, tokenText, style ? style + spanStyle : spanStyle, spanStartStyle, pos + tokenText.length == nextChange ? spanEndStyle : "", title)
                    }
                    if (end >= upto) {
                        text = text.slice(upto - pos);
                        pos = upto;
                        break
                    }
                    pos = end;
                    spanStartStyle = ""
                }
                text = allText.slice(at, at = styles[i++]);
                style = interpretTokenStyle(styles[i++], builder)
            }
        }
    }
    function updateDoc(doc, change, markedSpans, selAfter, estimateHeight) {
        function spansFor(n) {
            return markedSpans ? markedSpans[n] : null
        }
        function update(line, text, spans) {
            updateLine(line, text, spans, estimateHeight);
            signalLater(line, "change", line, change)
        }
        var from = change.from,
            to = change.to,
            text = change.text;
        var firstLine = getLine(doc, from.line),
            lastLine = getLine(doc, to.line);
        var lastText = lst(text),
            lastSpans = spansFor(text.length - 1),
            nlines = to.line - from.line;
        if (from.ch == 0 && to.ch == 0 && lastText == "") {
            for (var i = 0, e = text.length - 1, added = []; i < e; ++i) {
                added.push(new Line(text[i], spansFor(i), estimateHeight))
            }
            update(lastLine, lastLine.text, lastSpans);
            if (nlines) {
                doc.remove(from.line, nlines)
            }
            if (added.length) {
                doc.insert(from.line, added)
            }
        } else {
            if (firstLine == lastLine) {
                if (text.length == 1) {
                    update(firstLine, firstLine.text.slice(0, from.ch) + lastText + firstLine.text.slice(to.ch), lastSpans)
                } else {
                    for (var added = [], i = 1, e = text.length - 1; i < e; ++i) {
                        added.push(new Line(text[i], spansFor(i), estimateHeight))
                    }
                    added.push(new Line(lastText + firstLine.text.slice(to.ch), lastSpans, estimateHeight));
                    update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0));
                    doc.insert(from.line + 1, added)
                }
            } else {
                if (text.length == 1) {
                    update(firstLine, firstLine.text.slice(0, from.ch) + text[0] + lastLine.text.slice(to.ch), spansFor(0));
                    doc.remove(from.line + 1, nlines)
                } else {
                    update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0));
                    update(lastLine, lastText + lastLine.text.slice(to.ch), lastSpans);
                    for (var i = 1, e = text.length - 1, added = []; i < e; ++i) {
                        added.push(new Line(text[i], spansFor(i), estimateHeight))
                    }
                    if (nlines > 1) {
                        doc.remove(from.line + 1, nlines - 1)
                    }
                    doc.insert(from.line + 1, added)
                }
            }
        }
        signalLater(doc, "change", doc, change);
        setSelection(doc, selAfter.anchor, selAfter.head, null, true)
    }
    function LeafChunk(lines) {
        this.lines = lines;
        this.parent = null;
        for (var i = 0, e = lines.length, height = 0; i < e; ++i) {
            lines[i].parent = this;
            height += lines[i].height
        }
        this.height = height
    }
    LeafChunk.prototype = {
        chunkSize: function () {
            return this.lines.length
        },
        removeInner: function (at, n) {
            for (var i = at, e = at + n; i < e; ++i) {
                var line = this.lines[i];
                this.height -= line.height;
                cleanUpLine(line);
                signalLater(line, "delete")
            }
            this.lines.splice(at, n)
        },
        collapse: function (lines) {
            lines.splice.apply(lines, [lines.length, 0].concat(this.lines))
        },
        insertInner: function (at, lines, height) {
            this.height += height;
            this.lines = this.lines.slice(0, at).concat(lines).concat(this.lines.slice(at));
            for (var i = 0, e = lines.length; i < e; ++i) {
                lines[i].parent = this
            }
        },
        iterN: function (at, n, op) {
            for (var e = at + n; at < e; ++at) {
                if (op(this.lines[at])) {
                    return true
                }
            }
        }
    };

    function BranchChunk(children) {
        this.children = children;
        var size = 0,
            height = 0;
        for (var i = 0, e = children.length; i < e; ++i) {
            var ch = children[i];
            size += ch.chunkSize();
            height += ch.height;
            ch.parent = this
        }
        this.size = size;
        this.height = height;
        this.parent = null
    }
    BranchChunk.prototype = {
        chunkSize: function () {
            return this.size
        },
        removeInner: function (at, n) {
            this.size -= n;
            for (var i = 0; i < this.children.length; ++i) {
                var child = this.children[i],
                    sz = child.chunkSize();
                if (at < sz) {
                    var rm = Math.min(n, sz - at),
                        oldHeight = child.height;
                    child.removeInner(at, rm);
                    this.height -= oldHeight - child.height;
                    if (sz == rm) {
                        this.children.splice(i--, 1);
                        child.parent = null
                    }
                    if ((n -= rm) == 0) {
                        break
                    }
                    at = 0
                } else {
                    at -= sz
                }
            }
            if (this.size - n < 25) {
                var lines = [];
                this.collapse(lines);
                this.children = [new LeafChunk(lines)];
                this.children[0].parent = this
            }
        },
        collapse: function (lines) {
            for (var i = 0, e = this.children.length; i < e; ++i) {
                this.children[i].collapse(lines)
            }
        },
        insertInner: function (at, lines, height) {
            this.size += lines.length;
            this.height += height;
            for (var i = 0, e = this.children.length; i < e; ++i) {
                var child = this.children[i],
                    sz = child.chunkSize();
                if (at <= sz) {
                    child.insertInner(at, lines, height);
                    if (child.lines && child.lines.length > 50) {
                        while (child.lines.length > 50) {
                            var spilled = child.lines.splice(child.lines.length - 25, 25);
                            var newleaf = new LeafChunk(spilled);
                            child.height -= newleaf.height;
                            this.children.splice(i + 1, 0, newleaf);
                            newleaf.parent = this
                        }
                        this.maybeSpill()
                    }
                    break
                }
                at -= sz
            }
        },
        maybeSpill: function () {
            if (this.children.length <= 10) {
                return
            }
            var me = this;
            do {
                var spilled = me.children.splice(me.children.length - 5, 5);
                var sibling = new BranchChunk(spilled);
                if (!me.parent) {
                    var copy = new BranchChunk(me.children);
                    copy.parent = me;
                    me.children = [copy, sibling];
                    me = copy
                } else {
                    me.size -= sibling.size;
                    me.height -= sibling.height;
                    var myIndex = indexOf(me.parent.children, me);
                    me.parent.children.splice(myIndex + 1, 0, sibling)
                }
                sibling.parent = me.parent
            } while (me.children.length > 10);
            me.parent.maybeSpill()
        },
        iterN: function (at, n, op) {
            for (var i = 0, e = this.children.length; i < e; ++i) {
                var child = this.children[i],
                    sz = child.chunkSize();
                if (at < sz) {
                    var used = Math.min(n, sz - at);
                    if (child.iterN(at, used, op)) {
                        return true
                    }
                    if ((n -= used) == 0) {
                        break
                    }
                    at = 0
                } else {
                    at -= sz
                }
            }
        }
    };
    var nextDocId = 0;
    var Doc = CodeMirror.Doc = function (text, mode, firstLine) {
            if (!(this instanceof Doc)) {
                return new Doc(text, mode, firstLine)
            }
            if (firstLine == null) {
                firstLine = 0
            }
            BranchChunk.call(this, [new LeafChunk([new Line("", null)])]);
            this.first = firstLine;
            this.scrollTop = this.scrollLeft = 0;
            this.cantEdit = false;
            this.history = makeHistory();
            this.cleanGeneration = 1;
            this.frontier = firstLine;
            var start = Pos(firstLine, 0);
            this.sel = {
                from: start,
                to: start,
                head: start,
                anchor: start,
                shift: false,
                extend: false,
                goalColumn: null
            };
            this.id = ++nextDocId;
            this.modeOption = mode;
            if (typeof text == "string") {
                text = splitLines(text)
            }
            updateDoc(this, {
                from: start,
                to: start,
                text: text
            }, null, {
                head: start,
                anchor: start
            })
        };
    Doc.prototype = createObj(BranchChunk.prototype, {
        constructor: Doc,
        iter: function (from, to, op) {
            if (op) {
                this.iterN(from - this.first, to - from, op)
            } else {
                this.iterN(this.first, this.first + this.size, from)
            }
        },
        insert: function (at, lines) {
            var height = 0;
            for (var i = 0, e = lines.length; i < e; ++i) {
                height += lines[i].height
            }
            this.insertInner(at - this.first, lines, height)
        },
        remove: function (at, n) {
            this.removeInner(at - this.first, n)
        },
        getValue: function (lineSep) {
            var lines = getLines(this, this.first, this.first + this.size);
            if (lineSep === false) {
                return lines
            }
            return lines.join(lineSep || "\n")
        },
        setValue: function (code) {
            var top = Pos(this.first, 0),
                last = this.first + this.size - 1;
            makeChange(this, {
                from: top,
                to: Pos(last, getLine(this, last).text.length),
                text: splitLines(code),
                origin: "setValue"
            }, {
                head: top,
                anchor: top
            }, true)
        },
        replaceRange: function (code, from, to, origin) {
            from = clipPos(this, from);
            to = to ? clipPos(this, to) : from;
            replaceRange(this, code, from, to, origin)
        },
        getRange: function (from, to, lineSep) {
            var lines = getBetween(this, clipPos(this, from), clipPos(this, to));
            if (lineSep === false) {
                return lines
            }
            return lines.join(lineSep || "\n")
        },
        getLine: function (line) {
            var l = this.getLineHandle(line);
            return l && l.text
        },
        setLine: function (line, text) {
            if (isLine(this, line)) {
                replaceRange(this, text, Pos(line, 0), clipPos(this, Pos(line)))
            }
        },
        removeLine: function (line) {
            if (line) {
                replaceRange(this, "", clipPos(this, Pos(line - 1)), clipPos(this, Pos(line)))
            } else {
                replaceRange(this, "", Pos(0, 0), clipPos(this, Pos(1, 0)))
            }
        },
        getLineHandle: function (line) {
            if (isLine(this, line)) {
                return getLine(this, line)
            }
        },
        getLineNumber: function (line) {
            return lineNo(line)
        },
        getLineHandleVisualStart: function (line) {
            if (typeof line == "number") {
                line = getLine(this, line)
            }
            return visualLine(this, line)
        },
        lineCount: function () {
            return this.size
        },
        firstLine: function () {
            return this.first
        },
        lastLine: function () {
            return this.first + this.size - 1
        },
        clipPos: function (pos) {
            return clipPos(this, pos)
        },
        getCursor: function (start) {
            var sel = this.sel,
                pos;
            if (start == null || start == "head") {
                pos = sel.head
            } else {
                if (start == "anchor") {
                    pos = sel.anchor
                } else {
                    if (start == "end" || start === false) {
                        pos = sel.to
                    } else {
                        pos = sel.from
                    }
                }
            }
            return copyPos(pos)
        },
        somethingSelected: function () {
            return !posEq(this.sel.head, this.sel.anchor)
        },
        setCursor: docOperation(function (line, ch, extend) {
            var pos = clipPos(this, typeof line == "number" ? Pos(line, ch || 0) : line);
            if (extend) {
                extendSelection(this, pos)
            } else {
                setSelection(this, pos, pos)
            }
        }),
        setSelection: docOperation(function (anchor, head, bias) {
            setSelection(this, clipPos(this, anchor), clipPos(this, head || anchor), bias)
        }),
        extendSelection: docOperation(function (from, to, bias) {
            extendSelection(this, clipPos(this, from), to && clipPos(this, to), bias)
        }),
        getSelection: function (lineSep) {
            return this.getRange(this.sel.from, this.sel.to, lineSep)
        },
        replaceSelection: function (code, collapse, origin) {
            makeChange(this, {
                from: this.sel.from,
                to: this.sel.to,
                text: splitLines(code),
                origin: origin
            }, collapse || "around")
        },
        undo: docOperation(function () {
            makeChangeFromHistory(this, "undo")
        }),
        redo: docOperation(function () {
            makeChangeFromHistory(this, "redo")
        }),
        setExtending: function (val) {
            this.sel.extend = val
        },
        historySize: function () {
            var hist = this.history;
            return {
                undo: hist.done.length,
                redo: hist.undone.length
            }
        },
        clearHistory: function () {
            this.history = makeHistory(this.history.maxGeneration)
        },
        markClean: function () {
            this.cleanGeneration = this.changeGeneration()
        },
        changeGeneration: function () {
            this.history.lastOp = this.history.lastOrigin = null;
            return this.history.generation
        },
        isClean: function (gen) {
            return this.history.generation == (gen || this.cleanGeneration)
        },
        getHistory: function () {
            return {
                done: copyHistoryArray(this.history.done),
                undone: copyHistoryArray(this.history.undone)
            }
        },
        setHistory: function (histData) {
            var hist = this.history = makeHistory(this.history.maxGeneration);
            hist.done = histData.done.slice(0);
            hist.undone = histData.undone.slice(0)
        },
        markText: function (from, to, options) {
            return markText(this, clipPos(this, from), clipPos(this, to), options, "range")
        },
        setBookmark: function (pos, options) {
            var realOpts = {
                replacedWith: options && (options.nodeType == null ? options.widget : options),
                insertLeft: options && options.insertLeft
            };
            pos = clipPos(this, pos);
            return markText(this, pos, pos, realOpts, "bookmark")
        },
        findMarksAt: function (pos) {
            pos = clipPos(this, pos);
            var markers = [],
                spans = getLine(this, pos.line).markedSpans;
            if (spans) {
                for (var i = 0; i < spans.length; ++i) {
                    var span = spans[i];
                    if ((span.from == null || span.from <= pos.ch) && (span.to == null || span.to >= pos.ch)) {
                        markers.push(span.marker.parent || span.marker)
                    }
                }
            }
            return markers
        },
        getAllMarks: function () {
            var markers = [];
            this.iter(function (line) {
                var sps = line.markedSpans;
                if (sps) {
                    for (var i = 0; i < sps.length; ++i) {
                        if (sps[i].from != null) {
                            markers.push(sps[i].marker)
                        }
                    }
                }
            });
            return markers
        },
        posFromIndex: function (off) {
            var ch, lineNo = this.first;
            this.iter(function (line) {
                var sz = line.text.length + 1;
                if (sz > off) {
                    ch = off;
                    return true
                }
                off -= sz;
                ++lineNo
            });
            return clipPos(this, Pos(lineNo, ch))
        },
        indexFromPos: function (coords) {
            coords = clipPos(this, coords);
            var index = coords.ch;
            if (coords.line < this.first || coords.ch < 0) {
                return 0
            }
            this.iter(this.first, coords.line, function (line) {
                index += line.text.length + 1
            });
            return index
        },
        copy: function (copyHistory) {
            var doc = new Doc(getLines(this, this.first, this.first + this.size), this.modeOption, this.first);
            doc.scrollTop = this.scrollTop;
            doc.scrollLeft = this.scrollLeft;
            doc.sel = {
                from: this.sel.from,
                to: this.sel.to,
                head: this.sel.head,
                anchor: this.sel.anchor,
                shift: this.sel.shift,
                extend: false,
                goalColumn: this.sel.goalColumn
            };
            if (copyHistory) {
                doc.history.undoDepth = this.history.undoDepth;
                doc.setHistory(this.getHistory())
            }
            return doc
        },
        linkedDoc: function (options) {
            if (!options) {
                options = {}
            }
            var from = this.first,
                to = this.first + this.size;
            if (options.from != null && options.from > from) {
                from = options.from
            }
            if (options.to != null && options.to < to) {
                to = options.to
            }
            var copy = new Doc(getLines(this, from, to), options.mode || this.modeOption, from);
            if (options.sharedHist) {
                copy.history = this.history
            }(this.linked || (this.linked = [])).push({
                doc: copy,
                sharedHist: options.sharedHist
            });
            copy.linked = [{
                doc: this,
                isParent: true,
                sharedHist: options.sharedHist
            }];
            return copy
        },
        unlinkDoc: function (other) {
            if (other instanceof CodeMirror) {
                other = other.doc
            }
            if (this.linked) {
                for (var i = 0; i < this.linked.length; ++i) {
                    var link = this.linked[i];
                    if (link.doc != other) {
                        continue
                    }
                    this.linked.splice(i, 1);
                    other.unlinkDoc(this);
                    break
                }
            }
            if (other.history == this.history) {
                var splitIds = [other.id];
                linkedDocs(other, function (doc) {
                    splitIds.push(doc.id)
                }, true);
                other.history = makeHistory();
                other.history.done = copyHistoryArray(this.history.done, splitIds);
                other.history.undone = copyHistoryArray(this.history.undone, splitIds)
            }
        },
        iterLinkedDocs: function (f) {
            linkedDocs(this, f)
        },
        getMode: function () {
            return this.mode
        },
        getEditor: function () {
            return this.cm
        }
    });
    Doc.prototype.eachLine = Doc.prototype.iter;
    var dontDelegate = "iter insert remove copy getEditor".split(" ");
    for (var prop in Doc.prototype) {
        if (Doc.prototype.hasOwnProperty(prop) && indexOf(dontDelegate, prop) < 0) {
            CodeMirror.prototype[prop] = (function (method) {
                return function () {
                    return method.apply(this.doc, arguments)
                }
            })(Doc.prototype[prop])
        }
    }
    eventMixin(Doc);

    function linkedDocs(doc, f, sharedHistOnly) {
        function propagate(doc, skip, sharedHist) {
            if (doc.linked) {
                for (var i = 0; i < doc.linked.length; ++i) {
                    var rel = doc.linked[i];
                    if (rel.doc == skip) {
                        continue
                    }
                    var shared = sharedHist && rel.sharedHist;
                    if (sharedHistOnly && !shared) {
                        continue
                    }
                    f(rel.doc, shared);
                    propagate(rel.doc, doc, shared)
                }
            }
        }
        propagate(doc, null, true)
    }
    function attachDoc(cm, doc) {
        if (doc.cm) {
            throw new Error("This document is already in use.")
        }
        cm.doc = doc;
        doc.cm = cm;
        estimateLineHeights(cm);
        loadMode(cm);
        if (!cm.options.lineWrapping) {
            computeMaxLength(cm)
        }
        cm.options.mode = doc.modeOption;
        regChange(cm)
    }
    function getLine(chunk, n) {
        n -= chunk.first;
        while (!chunk.lines) {
            for (var i = 0;; ++i) {
                var child = chunk.children[i],
                    sz = child.chunkSize();
                if (n < sz) {
                    chunk = child;
                    break
                }
                n -= sz
            }
        }
        return chunk.lines[n]
    }
    function getBetween(doc, start, end) {
        var out = [],
            n = start.line;
        doc.iter(start.line, end.line + 1, function (line) {
            var text = line.text;
            if (n == end.line) {
                text = text.slice(0, end.ch)
            }
            if (n == start.line) {
                text = text.slice(start.ch)
            }
            out.push(text);
            ++n
        });
        return out
    }
    function getLines(doc, from, to) {
        var out = [];
        doc.iter(from, to, function (line) {
            out.push(line.text)
        });
        return out
    }
    function updateLineHeight(line, height) {
        var diff = height - line.height;
        for (var n = line; n; n = n.parent) {
            n.height += diff
        }
    }
    function lineNo(line) {
        if (line.parent == null) {
            return null
        }
        var cur = line.parent,
            no = indexOf(cur.lines, line);
        for (var chunk = cur.parent; chunk; cur = chunk, chunk = chunk.parent) {
            for (var i = 0;; ++i) {
                if (chunk.children[i] == cur) {
                    break
                }
                no += chunk.children[i].chunkSize()
            }
        }
        return no + cur.first
    }
    function lineAtHeight(chunk, h) {
        var n = chunk.first;
        outer: do {
            for (var i = 0, e = chunk.children.length; i < e; ++i) {
                var child = chunk.children[i],
                    ch = child.height;
                if (h < ch) {
                    chunk = child;
                    continue outer
                }
                h -= ch;
                n += child.chunkSize()
            }
            return n
        } while (!chunk.lines);
        for (var i = 0, e = chunk.lines.length; i < e; ++i) {
            var line = chunk.lines[i],
                lh = line.height;
            if (h < lh) {
                break
            }
            h -= lh
        }
        return n + i
    }
    function heightAtLine(cm, lineObj) {
        lineObj = visualLine(cm.doc, lineObj);
        var h = 0,
            chunk = lineObj.parent;
        for (var i = 0; i < chunk.lines.length; ++i) {
            var line = chunk.lines[i];
            if (line == lineObj) {
                break
            } else {
                h += line.height
            }
        }
        for (var p = chunk.parent; p; chunk = p, p = chunk.parent) {
            for (var i = 0; i < p.children.length; ++i) {
                var cur = p.children[i];
                if (cur == chunk) {
                    break
                } else {
                    h += cur.height
                }
            }
        }
        return h
    }
    function getOrder(line) {
        var order = line.order;
        if (order == null) {
            order = line.order = bidiOrdering(line.text)
        }
        return order
    }
    function makeHistory(startGen) {
        return {
            done: [],
            undone: [],
            undoDepth: Infinity,
            lastTime: 0,
            lastOp: null,
            lastOrigin: null,
            generation: startGen || 1,
            maxGeneration: startGen || 1
        }
    }
    function attachLocalSpans(doc, change, from, to) {
        var existing = change["spans_" + doc.id],
            n = 0;
        doc.iter(Math.max(doc.first, from), Math.min(doc.first + doc.size, to), function (line) {
            if (line.markedSpans) {
                (existing || (existing = change["spans_" + doc.id] = {}))[n] = line.markedSpans
            }++n
        })
    }
    function historyChangeFromChange(doc, change) {
        var from = {
            line: change.from.line,
            ch: change.from.ch
        };
        var histChange = {
            from: from,
            to: changeEnd(change),
            text: getBetween(doc, change.from, change.to)
        };
        attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1);
        linkedDocs(doc, function (doc) {
            attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1)
        }, true);
        return histChange
    }
    function addToHistory(doc, change, selAfter, opId) {
        var hist = doc.history;
        hist.undone.length = 0;
        var time = +new Date,
            cur = lst(hist.done);
        if (cur && (hist.lastOp == opId || hist.lastOrigin == change.origin && change.origin && ((change.origin.charAt(0) == "+" && doc.cm && hist.lastTime > time - doc.cm.options.historyEventDelay) || change.origin.charAt(0) == "*"))) {
            var last = lst(cur.changes);
            if (posEq(change.from, change.to) && posEq(change.from, last.to)) {
                last.to = changeEnd(change)
            } else {
                cur.changes.push(historyChangeFromChange(doc, change))
            }
            cur.anchorAfter = selAfter.anchor;
            cur.headAfter = selAfter.head
        } else {
            cur = {
                changes: [historyChangeFromChange(doc, change)],
                generation: hist.generation,
                anchorBefore: doc.sel.anchor,
                headBefore: doc.sel.head,
                anchorAfter: selAfter.anchor,
                headAfter: selAfter.head
            };
            hist.done.push(cur);
            hist.generation = ++hist.maxGeneration;
            while (hist.done.length > hist.undoDepth) {
                hist.done.shift()
            }
        }
        hist.lastTime = time;
        hist.lastOp = opId;
        hist.lastOrigin = change.origin
    }
    function removeClearedSpans(spans) {
        if (!spans) {
            return null
        }
        for (var i = 0, out; i < spans.length; ++i) {
            if (spans[i].marker.explicitlyCleared) {
                if (!out) {
                    out = spans.slice(0, i)
                }
            } else {
                if (out) {
                    out.push(spans[i])
                }
            }
        }
        return !out ? spans : out.length ? out : null
    }
    function getOldSpans(doc, change) {
        var found = change["spans_" + doc.id];
        if (!found) {
            return null
        }
        for (var i = 0, nw = []; i < change.text.length; ++i) {
            nw.push(removeClearedSpans(found[i]))
        }
        return nw
    }
    function copyHistoryArray(events, newGroup) {
        for (var i = 0, copy = []; i < events.length; ++i) {
            var event = events[i],
                changes = event.changes,
                newChanges = [];
            copy.push({
                changes: newChanges,
                anchorBefore: event.anchorBefore,
                headBefore: event.headBefore,
                anchorAfter: event.anchorAfter,
                headAfter: event.headAfter
            });
            for (var j = 0; j < changes.length; ++j) {
                var change = changes[j],
                    m;
                newChanges.push({
                    from: change.from,
                    to: change.to,
                    text: change.text
                });
                if (newGroup) {
                    for (var prop in change) {
                        if (m = prop.match(/^spans_(\d+)$/)) {
                            if (indexOf(newGroup, Number(m[1])) > -1) {
                                lst(newChanges)[prop] = change[prop];
                                delete change[prop]
                            }
                        }
                    }
                }
            }
        }
        return copy
    }
    function rebaseHistSel(pos, from, to, diff) {
        if (to < pos.line) {
            pos.line += diff
        } else {
            if (from < pos.line) {
                pos.line = from;
                pos.ch = 0
            }
        }
    }
    function rebaseHistArray(array, from, to, diff) {
        for (var i = 0; i < array.length; ++i) {
            var sub = array[i],
                ok = true;
            for (var j = 0; j < sub.changes.length; ++j) {
                var cur = sub.changes[j];
                if (!sub.copied) {
                    cur.from = copyPos(cur.from);
                    cur.to = copyPos(cur.to)
                }
                if (to < cur.from.line) {
                    cur.from.line += diff;
                    cur.to.line += diff
                } else {
                    if (from <= cur.to.line) {
                        ok = false;
                        break
                    }
                }
            }
            if (!sub.copied) {
                sub.anchorBefore = copyPos(sub.anchorBefore);
                sub.headBefore = copyPos(sub.headBefore);
                sub.anchorAfter = copyPos(sub.anchorAfter);
                sub.readAfter = copyPos(sub.headAfter);
                sub.copied = true
            }
            if (!ok) {
                array.splice(0, i + 1);
                i = 0
            } else {
                rebaseHistSel(sub.anchorBefore);
                rebaseHistSel(sub.headBefore);
                rebaseHistSel(sub.anchorAfter);
                rebaseHistSel(sub.headAfter)
            }
        }
    }
    function rebaseHist(hist, change) {
        var from = change.from.line,
            to = change.to.line,
            diff = change.text.length - (to - from) - 1;
        rebaseHistArray(hist.done, from, to, diff);
        rebaseHistArray(hist.undone, from, to, diff)
    }
    function stopMethod() {
        e_stop(this)
    }
    function addStop(event) {
        if (!event.stop) {
            event.stop = stopMethod
        }
        return event
    }
    function e_preventDefault(e) {
        if (e.preventDefault) {
            e.preventDefault()
        } else {
            e.returnValue = false
        }
    }
    function e_stopPropagation(e) {
        if (e.stopPropagation) {
            e.stopPropagation()
        } else {
            e.cancelBubble = true
        }
    }
    function e_defaultPrevented(e) {
        return e.defaultPrevented != null ? e.defaultPrevented : e.returnValue == false
    }
    function e_stop(e) {
        e_preventDefault(e);
        e_stopPropagation(e)
    }
    CodeMirror.e_stop = e_stop;
    CodeMirror.e_preventDefault = e_preventDefault;
    CodeMirror.e_stopPropagation = e_stopPropagation;

    function e_target(e) {
        return e.target || e.srcElement
    }
    function e_button(e) {
        var b = e.which;
        if (b == null) {
            if (e.button & 1) {
                b = 1
            } else {
                if (e.button & 2) {
                    b = 3
                } else {
                    if (e.button & 4) {
                        b = 2
                    }
                }
            }
        }
        if (mac && e.ctrlKey && b == 1) {
            b = 3
        }
        return b
    }
    function on(emitter, type, f) {
        if (emitter.addEventListener) {
            emitter.addEventListener(type, f, false)
        } else {
            if (emitter.attachEvent) {
                emitter.attachEvent("on" + type, f)
            } else {
                var map = emitter._handlers || (emitter._handlers = {});
                var arr = map[type] || (map[type] = []);
                arr.push(f)
            }
        }
    }
    function off(emitter, type, f) {
        if (emitter.removeEventListener) {
            emitter.removeEventListener(type, f, false)
        } else {
            if (emitter.detachEvent) {
                emitter.detachEvent("on" + type, f)
            } else {
                var arr = emitter._handlers && emitter._handlers[type];
                if (!arr) {
                    return
                }
                for (var i = 0; i < arr.length; ++i) {
                    if (arr[i] == f) {
                        arr.splice(i, 1);
                        break
                    }
                }
            }
        }
    }
    function signal(emitter, type) {
        var arr = emitter._handlers && emitter._handlers[type];
        if (!arr) {
            return
        }
        var args = Array.prototype.slice.call(arguments, 2);
        for (var i = 0; i < arr.length; ++i) {
            arr[i].apply(null, args)
        }
    }
    var delayedCallbacks, delayedCallbackDepth = 0;

    function signalLater(emitter, type) {
        var arr = emitter._handlers && emitter._handlers[type];
        if (!arr) {
            return
        }
        var args = Array.prototype.slice.call(arguments, 2);
        if (!delayedCallbacks) {
            ++delayedCallbackDepth;
            delayedCallbacks = [];
            setTimeout(fireDelayed, 0)
        }
        function bnd(f) {
            return function () {
                f.apply(null, args)
            }
        }
        for (var i = 0; i < arr.length; ++i) {
            delayedCallbacks.push(bnd(arr[i]))
        }
    }
    function signalDOMEvent(cm, e, override) {
        signal(cm, override || e.type, cm, e);
        return e_defaultPrevented(e) || e.codemirrorIgnore
    }
    function fireDelayed() {
        --delayedCallbackDepth;
        var delayed = delayedCallbacks;
        delayedCallbacks = null;
        for (var i = 0; i < delayed.length; ++i) {
            delayed[i]()
        }
    }
    function hasHandler(emitter, type) {
        var arr = emitter._handlers && emitter._handlers[type];
        return arr && arr.length > 0
    }
    CodeMirror.on = on;
    CodeMirror.off = off;
    CodeMirror.signal = signal;

    function eventMixin(ctor) {
        ctor.prototype.on = function (type, f) {
            on(this, type, f)
        };
        ctor.prototype.off = function (type, f) {
            off(this, type, f)
        }
    }
    var scrollerCutOff = 30;
    var Pass = CodeMirror.Pass = {
        toString: function () {
            return "CodeMirror.Pass"
        }
    };

    function Delayed() {
        this.id = null
    }
    Delayed.prototype = {
        set: function (ms, f) {
            clearTimeout(this.id);
            this.id = setTimeout(f, ms)
        }
    };

    function countColumn(string, end, tabSize, startIndex, startValue) {
        if (end == null) {
            end = string.search(/[^\s\u00a0]/);
            if (end == -1) {
                end = string.length
            }
        }
        for (var i = startIndex || 0, n = startValue || 0; i < end; ++i) {
            if (string.charAt(i) == "\t") {
                n += tabSize - (n % tabSize)
            } else {
                ++n
            }
        }
        return n
    }
    CodeMirror.countColumn = countColumn;
    var spaceStrs = [""];

    function spaceStr(n) {
        while (spaceStrs.length <= n) {
            spaceStrs.push(lst(spaceStrs) + " ")
        }
        return spaceStrs[n]
    }
    function lst(arr) {
        return arr[arr.length - 1]
    }
    function selectInput(node) {
        if (ios) {
            node.selectionStart = 0;
            node.selectionEnd = node.value.length
        } else {
            try {
                node.select()
            } catch (_e) {}
        }
    }
    function indexOf(collection, elt) {
        if (collection.indexOf) {
            return collection.indexOf(elt)
        }
        for (var i = 0, e = collection.length; i < e; ++i) {
            if (collection[i] == elt) {
                return i
            }
        }
        return -1
    }
    function createObj(base, props) {
        function Obj() {}
        Obj.prototype = base;
        var inst = new Obj();
        if (props) {
            copyObj(props, inst)
        }
        return inst
    }
    function copyObj(obj, target) {
        if (!target) {
            target = {}
        }
        for (var prop in obj) {
            if (obj.hasOwnProperty(prop)) {
                target[prop] = obj[prop]
            }
        }
        return target
    }
    function emptyArray(size) {
        for (var a = [], i = 0; i < size; ++i) {
            a.push(undefined)
        }
        return a
    }
    function bind(f) {
        var args = Array.prototype.slice.call(arguments, 1);
        return function () {
            return f.apply(null, args)
        }
    }
    var nonASCIISingleCaseWordChar = /[\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;

    function isWordChar(ch) {
        return /\w/.test(ch) || ch > "\x80" && (ch.toUpperCase() != ch.toLowerCase() || nonASCIISingleCaseWordChar.test(ch))
    }
    function isEmpty(obj) {
        for (var n in obj) {
            if (obj.hasOwnProperty(n) && obj[n]) {
                return false
            }
        }
        return true
    }
    var isExtendingChar = /[\u0300-\u036F\u0483-\u0487\u0488-\u0489\u0591-\u05BD\u05BF\u05C1-\u05C2\u05C4-\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7-\u06E8\u06EA-\u06ED\uA66F\uA670-\uA672\uA674-\uA67D\uA69F\udc00-\udfff]/;

    function elt(tag, content, className, style) {
        var e = document.createElement(tag);
        if (className) {
            e.className = className
        }
        if (style) {
            e.style.cssText = style
        }
        if (typeof content == "string") {
            setTextContent(e, content)
        } else {
            if (content) {
                for (var i = 0; i < content.length; ++i) {
                    e.appendChild(content[i])
                }
            }
        }
        return e
    }
    function removeChildren(e) {
        for (var count = e.childNodes.length; count > 0; --count) {
            e.removeChild(e.firstChild)
        }
        return e
    }
    function removeChildrenAndAdd(parent, e) {
        return removeChildren(parent).appendChild(e)
    }
    function setTextContent(e, str) {
        if (ie_lt9) {
            e.innerHTML = "";
            e.appendChild(document.createTextNode(str))
        } else {
            e.textContent = str
        }
    }
    function getRect(node) {
        return node.getBoundingClientRect()
    }
    CodeMirror.replaceGetRect = function (f) {
        getRect = f
    };
    var dragAndDrop = function () {
            if (ie_lt9) {
                return false
            }
            var div = elt("div");
            return "draggable" in div || "dragDrop" in div
        }();

    function spanAffectsWrapping() {
        return false
    }
    if (gecko) {
        spanAffectsWrapping = function (str, i) {
            return str.charCodeAt(i - 1) == 36 && str.charCodeAt(i) == 39
        }
    } else {
        if (safari && !/Version\/([6-9]|\d\d)\b/.test(navigator.userAgent)) {
            spanAffectsWrapping = function (str, i) {
                return /\-[^ \-?]|\?[^ !\'\"\),.\-\/:;\?\]\}]/.test(str.slice(i - 1, i + 1))
            }
        } else {
            if (webkit && /Chrome\/(?:29|[3-9]\d|\d\d\d)\./.test(navigator.userAgent)) {
                spanAffectsWrapping = function (str, i) {
                    var code = str.charCodeAt(i - 1);
                    return code >= 8208 && code <= 8212
                }
            } else {
                if (webkit) {
                    spanAffectsWrapping = function (str, i) {
                        if (i > 1 && str.charCodeAt(i - 1) == 45) {
                            if (/\w/.test(str.charAt(i - 2)) && /[^\-?\.]/.test(str.charAt(i))) {
                                return true
                            }
                            if (i > 2 && /[\d\.,]/.test(str.charAt(i - 2)) && /[\d\.,]/.test(str.charAt(i))) {
                                return false
                            }
                        }
                        return /[~!#%&*)=+}\]\\|\"\.>,:;][({[<]|-[^\-?\.\u2010-\u201f\u2026]|\?[\w~`@#$%\^&*(_=+{[|><]|…[\w~`@#$%\^&*(_=+{[><]/.test(str.slice(i - 1, i + 1))
                    }
                }
            }
        }
    }
    var knownScrollbarWidth;

    function scrollbarWidth(measure) {
        if (knownScrollbarWidth != null) {
            return knownScrollbarWidth
        }
        var test = elt("div", null, null, "width: 50px; height: 50px; overflow-x: scroll");
        removeChildrenAndAdd(measure, test);
        if (test.offsetWidth) {
            knownScrollbarWidth = test.offsetHeight - test.clientHeight
        }
        return knownScrollbarWidth || 0
    }
    var zwspSupported;

    function zeroWidthElement(measure) {
        if (zwspSupported == null) {
            var test = elt("span", "\u200b");
            removeChildrenAndAdd(measure, elt("span", [test, document.createTextNode("x")]));
            if (measure.firstChild.offsetHeight != 0) {
                zwspSupported = test.offsetWidth <= 1 && test.offsetHeight > 2 && !ie_lt8
            }
        }
        if (zwspSupported) {
            return elt("span", "\u200b")
        } else {
            return elt("span", "\u00a0", null, "display: inline-block; width: 1px; margin-right: -1px")
        }
    }
    var splitLines = "\n\nb".split(/\n/).length != 3 ?
    function (string) {
        var pos = 0,
            result = [],
            l = string.length;
        while (pos <= l) {
            var nl = string.indexOf("\n", pos);
            if (nl == -1) {
                nl = string.length
            }
            var line = string.slice(pos, string.charAt(nl - 1) == "\r" ? nl - 1 : nl);
            var rt = line.indexOf("\r");
            if (rt != -1) {
                result.push(line.slice(0, rt));
                pos += rt + 1
            } else {
                result.push(line);
                pos = nl + 1
            }
        }
        return result
    } : function (string) {
        return string.split(/\r\n?|\n/)
    };
    CodeMirror.splitLines = splitLines;
    var hasSelection = window.getSelection ?
    function (te) {
        try {
            return te.selectionStart != te.selectionEnd
        } catch (e) {
            return false
        }
    } : function (te) {
        try {
            var range = te.ownerDocument.selection.createRange()
        } catch (e) {}
        if (!range || range.parentElement() != te) {
            return false
        }
        return range.compareEndPoints("StartToEnd", range) != 0
    };
    var hasCopyEvent = (function () {
        var e = elt("div");
        if ("oncopy" in e) {
            return true
        }
        e.setAttribute("oncopy", "return;");
        return typeof e.oncopy == "function"
    })();
    var keyNames = {
        3: "Enter",
        8: "Backspace",
        9: "Tab",
        13: "Enter",
        16: "Shift",
        17: "Ctrl",
        18: "Alt",
        19: "Pause",
        20: "CapsLock",
        27: "Esc",
        32: "Space",
        33: "PageUp",
        34: "PageDown",
        35: "End",
        36: "Home",
        37: "Left",
        38: "Up",
        39: "Right",
        40: "Down",
        44: "PrintScrn",
        45: "Insert",
        46: "Delete",
        59: ";",
        91: "Mod",
        92: "Mod",
        93: "Mod",
        109: "-",
        107: "=",
        127: "Delete",
        186: ";",
        187: "=",
        188: ",",
        189: "-",
        190: ".",
        191: "/",
        192: "`",
        219: "[",
        220: "\\",
        221: "]",
        222: "'",
        63276: "PageUp",
        63277: "PageDown",
        63275: "End",
        63273: "Home",
        63234: "Left",
        63232: "Up",
        63235: "Right",
        63233: "Down",
        63302: "Insert",
        63272: "Delete"
    };
    CodeMirror.keyNames = keyNames;
    (function () {
        for (var i = 0; i < 10; i++) {
            keyNames[i + 48] = String(i)
        }
        for (var i = 65; i <= 90; i++) {
            keyNames[i] = String.fromCharCode(i)
        }
        for (var i = 1; i <= 12; i++) {
            keyNames[i + 111] = keyNames[i + 63235] = "F" + i
        }
    })();

    function iterateBidiSections(order, from, to, f) {
        if (!order) {
            return f(from, to, "ltr")
        }
        var found = false;
        for (var i = 0; i < order.length; ++i) {
            var part = order[i];
            if (part.from < to && part.to > from || from == to && part.to == from) {
                f(Math.max(part.from, from), Math.min(part.to, to), part.level == 1 ? "rtl" : "ltr");
                found = true
            }
        }
        if (!found) {
            f(from, to, "ltr")
        }
    }
    function bidiLeft(part) {
        return part.level % 2 ? part.to : part.from
    }
    function bidiRight(part) {
        return part.level % 2 ? part.from : part.to
    }
    function lineLeft(line) {
        var order = getOrder(line);
        return order ? bidiLeft(order[0]) : 0
    }
    function lineRight(line) {
        var order = getOrder(line);
        if (!order) {
            return line.text.length
        }
        return bidiRight(lst(order))
    }
    function lineStart(cm, lineN) {
        var line = getLine(cm.doc, lineN);
        var visual = visualLine(cm.doc, line);
        if (visual != line) {
            lineN = lineNo(visual)
        }
        var order = getOrder(visual);
        var ch = !order ? 0 : order[0].level % 2 ? lineRight(visual) : lineLeft(visual);
        return Pos(lineN, ch)
    }
    function lineEnd(cm, lineN) {
        var merged, line;
        while (merged = collapsedSpanAtEnd(line = getLine(cm.doc, lineN))) {
            lineN = merged.find().to.line
        }
        var order = getOrder(line);
        var ch = !order ? line.text.length : order[0].level % 2 ? lineLeft(line) : lineRight(line);
        return Pos(lineN, ch)
    }
    function compareBidiLevel(order, a, b) {
        var linedir = order[0].level;
        if (a == linedir) {
            return true
        }
        if (b == linedir) {
            return false
        }
        return a < b
    }
    var bidiOther;

    function getBidiPartAt(order, pos) {
        for (var i = 0, found; i < order.length; ++i) {
            var cur = order[i];
            if (cur.from < pos && cur.to > pos) {
                bidiOther = null;
                return i
            }
            if (cur.from == pos || cur.to == pos) {
                if (found == null) {
                    found = i
                } else {
                    if (compareBidiLevel(order, cur.level, order[found].level)) {
                        bidiOther = found;
                        return i
                    } else {
                        bidiOther = i;
                        return found
                    }
                }
            }
        }
        bidiOther = null;
        return found
    }
    function moveInLine(line, pos, dir, byUnit) {
        if (!byUnit) {
            return pos + dir
        }
        do {
            pos += dir
        } while (pos > 0 && isExtendingChar.test(line.text.charAt(pos)));
        return pos
    }
    function moveVisually(line, start, dir, byUnit) {
        var bidi = getOrder(line);
        if (!bidi) {
            return moveLogically(line, start, dir, byUnit)
        }
        var pos = getBidiPartAt(bidi, start),
            part = bidi[pos];
        var target = moveInLine(line, start, part.level % 2 ? -dir : dir, byUnit);
        for (;;) {
            if (target > part.from && target < part.to) {
                return target
            }
            if (target == part.from || target == part.to) {
                if (getBidiPartAt(bidi, target) == pos) {
                    return target
                }
                part = bidi[pos += dir];
                return (dir > 0) == part.level % 2 ? part.to : part.from
            } else {
                part = bidi[pos += dir];
                if (!part) {
                    return null
                }
                if ((dir > 0) == part.level % 2) {
                    target = moveInLine(line, part.to, -1, byUnit)
                } else {
                    target = moveInLine(line, part.from, 1, byUnit)
                }
            }
        }
    }
    function moveLogically(line, start, dir, byUnit) {
        var target = start + dir;
        if (byUnit) {
            while (target > 0 && isExtendingChar.test(line.text.charAt(target))) {
                target += dir
            }
        }
        return target < 0 || target > line.text.length ? null : target
    }
    var bidiOrdering = (function () {
        var lowTypes = "bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLL";
        var arabicTypes = "rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmmrrrrrrrrrrrrrrrrrr";

        function charType(code) {
            if (code <= 255) {
                return lowTypes.charAt(code)
            } else {
                if (1424 <= code && code <= 1524) {
                    return "R"
                } else {
                    if (1536 <= code && code <= 1791) {
                        return arabicTypes.charAt(code - 1536)
                    } else {
                        if (1792 <= code && code <= 2220) {
                            return "r"
                        } else {
                            return "L"
                        }
                    }
                }
            }
        }
        var bidiRE = /[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;
        var isNeutral = /[stwN]/,
            isStrong = /[LRr]/,
            countsAsLeft = /[Lb1n]/,
            countsAsNum = /[1n]/;
        var outerType = "L";
        return function (str) {
            if (!bidiRE.test(str)) {
                return false
            }
            var len = str.length,
                types = [];
            for (var i = 0, type; i < len; ++i) {
                types.push(type = charType(str.charCodeAt(i)))
            }
            for (var i = 0, prev = outerType; i < len; ++i) {
                var type = types[i];
                if (type == "m") {
                    types[i] = prev
                } else {
                    prev = type
                }
            }
            for (var i = 0, cur = outerType; i < len; ++i) {
                var type = types[i];
                if (type == "1" && cur == "r") {
                    types[i] = "n"
                } else {
                    if (isStrong.test(type)) {
                        cur = type;
                        if (type == "r") {
                            types[i] = "R"
                        }
                    }
                }
            }
            for (var i = 1, prev = types[0]; i < len - 1; ++i) {
                var type = types[i];
                if (type == "+" && prev == "1" && types[i + 1] == "1") {
                    types[i] = "1"
                } else {
                    if (type == "," && prev == types[i + 1] && (prev == "1" || prev == "n")) {
                        types[i] = prev
                    }
                }
                prev = type
            }
            for (var i = 0; i < len; ++i) {
                var type = types[i];
                if (type == ",") {
                    types[i] = "N"
                } else {
                    if (type == "%") {
                        for (var end = i + 1; end < len && types[end] == "%"; ++end) {}
                        var replace = (i && types[i - 1] == "!") || (end < len - 1 && types[end] == "1") ? "1" : "N";
                        for (var j = i; j < end; ++j) {
                            types[j] = replace
                        }
                        i = end - 1
                    }
                }
            }
            for (var i = 0, cur = outerType; i < len; ++i) {
                var type = types[i];
                if (cur == "L" && type == "1") {
                    types[i] = "L"
                } else {
                    if (isStrong.test(type)) {
                        cur = type
                    }
                }
            }
            for (var i = 0; i < len; ++i) {
                if (isNeutral.test(types[i])) {
                    for (var end = i + 1; end < len && isNeutral.test(types[end]); ++end) {}
                    var before = (i ? types[i - 1] : outerType) == "L";
                    var after = (end < len - 1 ? types[end] : outerType) == "L";
                    var replace = before || after ? "L" : "R";
                    for (var j = i; j < end; ++j) {
                        types[j] = replace
                    }
                    i = end - 1
                }
            }
            var order = [],
                m;
            for (var i = 0; i < len;) {
                if (countsAsLeft.test(types[i])) {
                    var start = i;
                    for (++i; i < len && countsAsLeft.test(types[i]); ++i) {}
                    order.push({
                        from: start,
                        to: i,
                        level: 0
                    })
                } else {
                    var pos = i,
                        at = order.length;
                    for (++i; i < len && types[i] != "L"; ++i) {}
                    for (var j = pos; j < i;) {
                        if (countsAsNum.test(types[j])) {
                            if (pos < j) {
                                order.splice(at, 0, {
                                    from: pos,
                                    to: j,
                                    level: 1
                                })
                            }
                            var nstart = j;
                            for (++j; j < i && countsAsNum.test(types[j]); ++j) {}
                            order.splice(at, 0, {
                                from: nstart,
                                to: j,
                                level: 2
                            });
                            pos = j
                        } else {
                            ++j
                        }
                    }
                    if (pos < i) {
                        order.splice(at, 0, {
                            from: pos,
                            to: i,
                            level: 1
                        })
                    }
                }
            }
            if (order[0].level == 1 && (m = str.match(/^\s+/))) {
                order[0].from = m[0].length;
                order.unshift({
                    from: 0,
                    to: m[0].length,
                    level: 0
                })
            }
            if (lst(order).level == 1 && (m = str.match(/\s+$/))) {
                lst(order).to -= m[0].length;
                order.push({
                    from: len - m[0].length,
                    to: len,
                    level: 0
                })
            }
            if (order[0].level != lst(order).level) {
                order.push({
                    from: len,
                    to: len,
                    level: order[0].level
                })
            }
            return order
        }
    })();
    CodeMirror.version = "3.18.0";
    return CodeMirror
})();
(function () {
    if (!CodeMirror.modeURL) {
        CodeMirror.modeURL = "../mode/%N/%N.js"
    }
    var loading = {};

    function splitCallback(cont, n) {
        var countDown = n;
        return function () {
            if (--countDown == 0) {
                cont()
            }
        }
    }
    function ensureDeps(mode, cont) {
        var deps = CodeMirror.modes[mode].dependencies;
        if (!deps) {
            return cont()
        }
        var missing = [];
        for (var i = 0; i < deps.length; ++i) {
            if (!CodeMirror.modes.hasOwnProperty(deps[i])) {
                missing.push(deps[i])
            }
        }
        if (!missing.length) {
            return cont()
        }
        var split = splitCallback(cont, missing.length);
        for (var i = 0; i < missing.length; ++i) {
            CodeMirror.requireMode(missing[i], split)
        }
    }
    CodeMirror.requireMode = function (mode, cont) {
        if (typeof mode != "string") {
            mode = mode.name
        }
        if (CodeMirror.modes.hasOwnProperty(mode)) {
            return ensureDeps(mode, cont)
        }
        if (loading.hasOwnProperty(mode)) {
            return loading[mode].push(cont)
        }
        var script = document.createElement("script");
        script.src = CodeMirror.modeURL.replace(/%N/g, mode);
        var others = document.getElementsByTagName("script")[0];
        others.parentNode.insertBefore(script, others);
        var list = loading[mode] = [cont];
        var count = 0,
            poll = setInterval(function () {
                if (++count > 100) {
                    return clearInterval(poll)
                }
                if (CodeMirror.modes.hasOwnProperty(mode)) {
                    clearInterval(poll);
                    loading[mode] = null;
                    ensureDeps(mode, function () {
                        for (var i = 0; i < list.length; ++i) {
                            list[i]()
                        }
                    })
                }
            }, 200)
    };
    CodeMirror.autoLoadMode = function (instance, mode) {
        if (!CodeMirror.modes.hasOwnProperty(mode)) {
            CodeMirror.requireMode(mode, function () {
                instance.setOption("mode", instance.getOption("mode"))
            })
        }
    }
}());